def test csd epochs dcsp epochs get data mode real dcnl dcsp assert raises valueerror csd epochs epochs mode notamode dcnl dcsp assert raises valueerror csd epochs epochs fmin 20 fmax 10 dcnl dcsp assert raises valueerror csd epochs epochs fmin 20 fmax 20 1 dcnl dcsp assert raises valueerror csd epochs epochs tmin 0 15 tmax 0 1 dcnl dcsp assert raises valueerror csd epochs epochs tmin 0 tmax 10 dcnl dcsp assert raises valueerror csd epochs epochs tmin 10 tmax 11 dcnl dcsp data csd mt csd epochs epochs mode multitaper fmin 8 fmax 12 tmin 0 04 tmax 0 15 dcnl dcsp data csd fourier csd epochs epochs mode fourier fmin 8 fmax 12 tmin 0 04 tmax 0 15 dcnl dcsp n chan len data csd mt ch names dcnl dcsp assert equal data csd mt data shape n chan n chan dcnl dcsp assert equal data csd fourier data shape n chan n chan dcnl dcsp assert array equal np tril data csd mt data t conj np triu data csd mt data dcnl dcsp assert array equal np tril data csd fourier data t conj np triu data csd fourier data dcnl dcsp epochs crop tmin 0 04 tmax 0 15 dcnl dcsp tfr tfr morlet epochs freqs 10 n cycles 0 6 return itc false dcnl dcsp power np mean tfr data 2 dcnl dcsp max ch power power argmax dcnl dcsp max ch mt data csd mt data diagonal argmax dcnl dcsp max ch fourier data csd fourier data diagonal argmax dcnl dcsp assert equal max ch mt max ch power dcnl dcsp assert equal max ch fourier max ch power dcnl dcsp ch csd mt np abs data csd mt datamax ch power dcnl dcsp ch csd mtmax ch power 0 0 dcnl dcsp max ch csd mt np argmax ch csd mt dcnl dcsp ch csd fourier np abs data csd fourier datamax ch power dcnl dcsp ch csd fouriermax ch power 0 0 dcnl dcsp max ch csd fourier np argmax ch csd fourier dcnl dcsp assert equal max ch csd mt max ch csd fourier dcnl dcsp csd fsum csd epochs epochs mode fourier fmin 8 fmax 20 fsum true dcnl dcsp csds csd epochs epochs mode fourier fmin 8 fmax 20 fsum false dcnl dcsp freqs csd frequencies0 for csd in csds dcnl dcsp csd sum np zeros like csd fsum data dcnl dcsp for csd in csds dcnl dcsp dcsp csd sum + csd data dcnl dcsp assert equal len csds 2 dcnl dcsp assert equal len csd fsum frequencies 2 dcnl dcsp assert array equal csd fsum frequencies freqs dcnl dcsp assert array equal csd fsum data csd sum
def test csd epochs on artificial data dcsp epochs get data mode sin dcnl dcsp sfreq epochs info sfreq dcnl dcsp signal power sum squared epochs data dcnl dcsp signal power per sample signal power len epochs times dcnl dcsp data csd fourier csd epochs epochs mode fourier dcnl dcsp data csd mt csd epochs epochs mode multitaper dcnl dcsp fourier power np abs data csd fourier data 0 0 sfreq dcnl dcsp mt power np abs data csd mt data 0 0 sfreq dcnl dcsp assert true abs fourier power signal power < 0 5 dcnl dcsp assert true abs mt power signal power < 1 dcnl dcsp for tmax in 0 2 0 8 dcnl dcsp dcsp for add n fft in 0 30 dcnl dcsp dcsp dcsp t mask epochs times 0 epochs times < tmax dcnl dcsp dcsp dcsp n samples sum t mask dcnl dcsp dcsp dcsp n fft n samples + add n fft dcnl dcsp dcsp dcsp data csd fourier csd epochs epochs mode fourier tmin none tmax tmax fmin 0 fmax np inf n fft n fft dcnl dcsp dcsp dcsp first samp data csd fourier data 0 0 dcnl dcsp dcsp dcsp fourier power per sample np abs first samp sfreq n fft dcnl dcsp dcsp dcsp assert true abs signal power per sample fourier power per sample < 0 003 dcnl dcsp dcsp for n tapers in 1 2 5 dcnl dcsp dcsp dcsp for add n fft in 0 30 dcnl dcsp dcsp dcsp dcsp mt bandwidth sfreq float n samples n tapers + 1 dcnl dcsp dcsp dcsp dcsp data csd mt csd epochs epochs mode multitaper tmin none tmax tmax fmin 0 fmax np inf mt bandwidth mt bandwidth n fft n fft dcnl dcsp dcsp dcsp dcsp mt power per sample np abs data csd mt data 0 0 sfreq data csd mt n fft dcnl dcsp dcsp dcsp dcsp if n tapers 5 and tmax 0 2 dcnl dcsp dcsp dcsp dcsp dcsp delta 0 05 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp delta 0 004 dcnl dcsp dcsp dcsp dcsp assert true abs signal power per sample mt power per sample < delta
def test compute csd dcsp epochs get data mode real dcnl dcsp tmin 0 04 dcnl dcsp tmax 0 15 dcnl dcsp tmp np where np logical and epochs times tmin epochs times < tmax 0 dcnl dcsp picks meeg mne pick types epochs0 info meg true eeg true eog false ref meg false exclude bads dcnl dcsp epochs data epicks meeg tmp copy for e in epochs dcnl dcsp n trials len epochs dcnl dcsp n series len picks meeg dcnl dcsp x np concatenate epochs data axis 0 dcnl dcsp x np reshape x n trials n series 1 dcnl dcsp x list epochs data dcnl dcsp sfreq epochs info sfreq dcnl dcsp diff types np random randn 3 5 error dcnl dcsp err data np random randn 3 5 np random randn 2 4 dcnl dcsp assert raises valueerror csd array err data sfreq dcnl dcsp assert raises valueerror csd array diff types sfreq dcnl dcsp assert raises valueerror csd array np random randn 3 sfreq dcnl dcsp assert raises valueerror csd array x sfreq mode notamode dcnl dcsp assert raises valueerror csd array x sfreq fmin 20 fmax 10 dcnl dcsp assert raises valueerror csd array x sfreq fmin 20 fmax 20 1 dcnl dcsp data csd mt freqs mt csd array x sfreq mode multitaper fmin 8 fmax 12 dcnl dcsp data csd fourier freqs fft csd array x sfreq mode fourier fmin 8 fmax 12 dcnl dcsp data csd mt list freqs mt list csd array x list sfreq mode multitaper fmin 8 fmax 12 dcnl dcsp data csd fourier list freqs fft list csd array x list sfreq mode fourier fmin 8 fmax 12 dcnl dcsp assert array equal data csd mt data csd mt list dcnl dcsp assert array equal data csd fourier data csd fourier list dcnl dcsp assert array equal freqs mt freqs mt list dcnl dcsp assert array equal freqs fft freqs fft list dcnl dcsp n chan len epochs ch names dcnl dcsp assert equal data csd mt shape n chan n chan dcnl dcsp assert equal data csd fourier shape n chan n chan dcnl dcsp assert array equal np tril data csd mt t conj np triu data csd mt dcnl dcsp assert array equal np tril data csd fourier t conj np triu data csd fourier dcnl dcsp epochs crop tmin 0 04 tmax 0 15 dcnl dcsp tfr tfr morlet epochs freqs 10 n cycles 0 6 return itc false dcnl dcsp power np mean tfr data 2 dcnl dcsp max ch power power argmax dcnl dcsp max ch mt data csd mt diagonal argmax dcnl dcsp max ch fourier data csd fourier diagonal argmax dcnl dcsp assert equal max ch mt max ch power dcnl dcsp assert equal max ch fourier max ch power dcnl dcsp ch csd mt np abs data csd mtmax ch power dcnl dcsp ch csd mtmax ch power 0 0 dcnl dcsp max ch csd mt np argmax ch csd mt dcnl dcsp ch csd fourier np abs data csd fouriermax ch power dcnl dcsp ch csd fouriermax ch power 0 0 dcnl dcsp max ch csd fourier np argmax ch csd fourier dcnl dcsp assert equal max ch csd mt max ch csd fourier dcnl dcsp csd fsum freqs fsum csd array x sfreq mode fourier fmin 8 fmax 20 fsum true dcnl dcsp csds freqs csd array x sfreq mode fourier fmin 8 fmax 20 fsum false dcnl dcsp csd sum np sum csds axis 2 dcnl dcsp assert equal csds shape2 2 dcnl dcsp assert equal len freqs 2 dcnl dcsp assert array equal freqs fsum freqs dcnl dcsp assert array equal csd fsum csd sum
def test csd on artificial data dcsp epochs get data mode sin dcnl dcsp sfreq epochs info sfreq dcnl dcsp signal power sum squared epochs data dcnl dcsp signal power per sample signal power len epochs times dcnl dcsp data csd mt freqs mt csd array epochs data sfreq mode multitaper dcnl dcsp data csd fourier freqs fft csd array epochs data sfreq mode fourier dcnl dcsp fourier power np abs data csd fourier 0 0 sfreq dcnl dcsp mt power np abs data csd mt 0 0 sfreq dcnl dcsp assert true abs fourier power signal power < 0 5 dcnl dcsp assert true abs mt power signal power < 1 dcnl dcsp for tmax in 0 2 0 8 dcnl dcsp dcsp tslice np where epochs times < tmax 0 dcnl dcsp dcsp for add n fft in 0 30 dcnl dcsp dcsp dcsp t mask epochs times 0 epochs times < tmax dcnl dcsp dcsp dcsp n samples sum t mask dcnl dcsp dcsp dcsp n fft n samples + add n fft dcnl dcsp dcsp dcsp data csd fourier csd array epochs data tslice sfreq mode fourier fmin 0 fmax np inf n fft n fft dcnl dcsp dcsp dcsp first samp data csd fourier 0 0 dcnl dcsp dcsp dcsp fourier power per sample np abs first samp sfreq n fft dcnl dcsp dcsp dcsp assert true abs signal power per sample fourier power per sample < 0 003 dcnl dcsp dcsp for n tapers in 1 2 5 dcnl dcsp dcsp dcsp for add n fft in 0 30 dcnl dcsp dcsp dcsp dcsp mt bandwidth sfreq float n samples n tapers + 1 dcnl dcsp dcsp dcsp dcsp data csd mt csd array epochs data tslice sfreq mt bandwidth mt bandwidth n fft n fft dcnl dcsp dcsp dcsp dcsp mt power per sample np abs data csd mt 0 0 sfreq n fft dcnl dcsp dcsp dcsp dcsp if n tapers 5 and tmax 0 2 dcnl dcsp dcsp dcsp dcsp dcsp delta 0 05 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp delta 0 004 dcnl dcsp dcsp dcsp dcsp assert true abs signal power per sample mt power per sample < delta
def test stft dcsp sfreq 1000 0 dcnl dcsp f 7 0 dcnl dcsp for t in 253 256 dcnl dcsp dcsp t np arange t astype np float dcnl dcsp dcsp x np sin 2 np pi f t sfreq dcnl dcsp dcsp x np array x x + 1 0 dcnl dcsp dcsp wsize 128 dcnl dcsp dcsp tstep 4 dcnl dcsp dcsp x stft x wsize tstep dcnl dcsp dcsp xp istft x tstep tx t dcnl dcsp dcsp freqs stftfreq wsize sfreq 1000 dcnl dcsp dcsp max freq freqsnp argmax np sum np abs x0 2 axis 1 dcnl dcsp dcsp assert true x shape1 len freqs dcnl dcsp dcsp assert true np all freqs 0 0 dcnl dcsp dcsp assert true np abs max freq f < 1 0 dcnl dcsp dcsp assert array almost equal x xp decimal 6 dcnl dcsp dcsp assert almost equal np sqrt stft norm2 x linalg norm xx for xx in x decimal 6 dcnl dcsp dcsp x np random randn 2 t dcnl dcsp dcsp wsize 16 dcnl dcsp dcsp tstep 8 dcnl dcsp dcsp x stft x wsize tstep dcnl dcsp dcsp xp istft x tstep tx t dcnl dcsp dcsp freqs stftfreq wsize sfreq 1000 dcnl dcsp dcsp max freq freqsnp argmax np sum np abs x0 2 axis 1 dcnl dcsp dcsp assert true x shape1 len freqs dcnl dcsp dcsp assert true np all freqs 0 0 dcnl dcsp dcsp assert array almost equal x xp decimal 6 dcnl dcsp dcsp assert almost equal np sqrt stft norm2 x linalg norm xx for xx in x decimal 6 dcnl dcsp dcsp x np zeros 0 t dcnl dcsp dcsp x stft x wsize tstep dcnl dcsp dcsp xp istft x tstep t dcnl dcsp dcsp assert true xp shape x shape
requires statsmodels dcnl def test yule walker dcsp from statsmodels regression linear model import yule walker as sm yw dcnl dcsp d np random randn 100 dcnl dcsp sm rho sm sigma sm yw d order 2 dcnl dcsp rho sigma yule walker dnp newaxis order 2 dcnl dcsp assert array almost equal sm sigma sigma dcnl dcsp assert array almost equal sm rho rho
def test ar raw dcsp raw io read raw fif raw fname crop 0 2 load data dcnl dcsp raw pick types meg grad dcnl dcsp for order in 2 5 10 dcnl dcsp dcsp coeffs fit iir model raw raw order 11 dcnl dcsp dcsp assert equal coeffs shape order dcnl dcsp dcsp assert allclose coeffs0 1 0 atol 0 5 dcnl dcsp rng np random randomstate 0 dcnl dcsp raw data rng randn raw data shape dcnl dcsp raw data 1e15 dcnl dcsp for order in 2 5 10 dcnl dcsp dcsp coeffs fit iir model raw raw order 1 dcnl dcsp dcsp assert allclose coeffs 1 0 + 0 0 order atol 0 02 dcnl dcsp iir 1 1 0 2 dcnl dcsp raw data lfilter 1 0 iir raw data dcnl dcsp for order in 2 5 10 dcnl dcsp dcsp coeffs fit iir model raw raw order 1 dcnl dcsp dcsp assert allclose coeffs iir + 0 0 order 2 atol 0 05
def test stockwell check input dcsp for last dim in 127 128 dcnl dcsp dcsp data np zeros 2 10 last dim dcnl dcsp dcsp x in n fft zero pad check input st data none dcnl dcsp dcsp assert equal x in shape 2 10 128 dcnl dcsp dcsp assert equal n fft 128 dcnl dcsp dcsp assert equal zero pad 128 last dim
def test stockwell st no zero pad dcsp data np zeros 20 128 dcnl dcsp start f 1 dcnl dcsp stop f 10 dcnl dcsp sfreq 30 dcnl dcsp width 2 dcnl dcsp w precompute st windows data shape 1 start f stop f sfreq width dcnl dcsp st power itc data 10 true 0 1 w
def test stockwell core dcsp sfreq 1000 0 dcnl dcsp dur 0 5 dcnl dcsp onset offset 0 175 0 275 dcnl dcsp n samp int sfreq dur dcnl dcsp t np arange n samp sfreq dcnl dcsp pulse freq 15 0 dcnl dcsp pulse np cos 2 0 np pi pulse freq t dcnl dcsp pulse0 int onset sfreq 0 0 dcnl dcsp pulseint offset sfreq 0 0 dcnl dcsp width 0 5 dcnl dcsp freqs fftpack fftfreq len pulse 1 0 sfreq dcnl dcsp fmin fmax 1 0 100 0 dcnl dcsp start f stop f np abs freqs f argmin for f in fmin fmax dcnl dcsp w precompute st windows n samp start f stop f sfreq width dcnl dcsp st pulse st pulse start f w dcnl dcsp st pulse np abs st pulse 2 dcnl dcsp assert equal st pulse shape 1 len pulse dcnl dcsp st max freq freqsst pulse max axis 1 argmax axis 0 dcnl dcsp assert allclose st max freq pulse freq atol 1 0 dcnl dcsp assert true onset < tst pulse max axis 0 argmax axis 0 < offset dcnl dcsp width 1 0 dcnl dcsp start f stop f 0 len pulse dcnl dcsp w precompute st windows n samp start f stop f sfreq width dcnl dcsp y st pulse start f w dcnl dcsp y inv fftpack ifft np sum y axis 1 real dcnl dcsp assert array almost equal pulse y inv
def test stockwell api dcsp raw read raw fif raw fname dcnl dcsp event id tmin tmax 1 0 2 0 5 dcnl dcsp event name op join base dir testeve fif dcnl dcsp events read events event name dcnl dcsp epochs epochs raw events event id tmin tmax picks 0 1 3 dcnl dcsp for fmin fmax in none 50 5 50 5 none dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp power itc tfr stockwell epochs fmin fmin fmax fmax return itc true dcnl dcsp dcsp if fmax is not none dcnl dcsp dcsp dcsp assert true power freqs max < fmax dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp power evoked tfr stockwell epochs average fmin fmin fmax fmax return itc false dcnl dcsp dcsp assert array almost equal power evoked data power data dcnl dcsp assert true isinstance power averagetfr dcnl dcsp assert true isinstance itc averagetfr dcnl dcsp assert equal power data shape itc data shape dcnl dcsp assert true itc data min 0 0 dcnl dcsp assert true itc data max < 1 0 dcnl dcsp assert true np log power data max 20 < 0 0 dcnl dcsp assert true np log power data max 20 < 0 0
def test morlet dcsp wz morlet 1000 10 2 0 zero mean true dcnl dcsp w morlet 1000 10 2 0 zero mean false dcnl dcsp assert true np abs np mean np real wz0 < 1e05 dcnl dcsp assert true np abs np mean np real w0 0 001
def test time frequency dcsp event id 1 dcnl dcsp tmin 0 2 dcnl dcsp tmax 0 498 dcnl dcsp raw read raw fif raw fname dcnl dcsp events read events event fname dcnl dcsp include dcnl dcsp exclude raw info bads + meg dcsp 2443 eeg dcsp 053 dcnl dcsp picks pick types raw info meg grad eeg false stim false include include exclude exclude dcnl dcsp picks picks 2 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks dcnl dcsp data epochs get data dcnl dcsp times epochs times dcnl dcsp nave len data dcnl dcsp epochs nopicks epochs raw events event id tmin tmax dcnl dcsp freqs np arange 6 20 5 dcnl dcsp n cycles freqs 4 0 dcnl dcsp power itc tfr morlet epochs0 freqs freqs n cycles n cycles use fft true return itc true dcnl dcsp evoked epochs average dcnl dcsp power evoked tfr morlet evoked freqs n cycles use fft true return itc false dcnl dcsp assert raises valueerror tfr morlet evoked freqs 1 0 return itc true dcnl dcsp power itc tfr morlet epochs freqs freqs n cycles n cycles use fft true return itc true dcnl dcsp power itc tfr morlet epochs freqs freqs n cycles n cycles use fft true return itc true decim slice 0 2 dcnl dcsp assert raises valueerror tfr morlet epochs freqs freqs n cycles n cycles return itc true average false dcnl dcsp power picks itc picks tfr morlet epochs nopicks freqs freqs n cycles n cycles use fft true return itc true picks picks average true dcnl dcsp epochs power picks tfr morlet epochs nopicks freqs freqs n cycles n cycles use fft true return itc false picks picks average false dcnl dcsp power picks avg epochs power picks average dcnl dcsp assert array almost equal power data power picks data dcnl dcsp assert array almost equal power data power picks avg data dcnl dcsp assert array almost equal itc data itc picks data dcnl dcsp assert array almost equal power data power evoked data dcnl dcsp print itc dcnl dcsp print itc ch names dcnl dcsp itc + power dcnl dcsp itc power dcnl dcsp power power apply baseline baseline 0 1 0 mode logratio dcnl dcsp assert true meg in power dcnl dcsp assert true grad in power dcnl dcsp assert false mag in power dcnl dcsp assert false eeg in power dcnl dcsp assert equal power nave nave dcnl dcsp assert equal itc nave nave dcnl dcsp assert true power data shape len picks len freqs len times dcnl dcsp assert true power data shape itc data shape dcnl dcsp assert true power data shape len picks len freqs 2 dcnl dcsp assert true power data shape itc data shape dcnl dcsp assert true np sum itc data 1 0 dcnl dcsp assert true np sum itc data < 0 0 dcnl dcsp itc2 itc copy dcnl dcsp itc2 info bads itc2 ch names0 dcnl dcsp gave grand average itc2 itc dcnl dcsp assert equal gave data shape itc2 data shape0 1 itc2 data shape1 itc2 data shape2 dcnl dcsp assert equal itc2 ch names1 gave ch names dcnl dcsp assert equal gave nave 2 dcnl dcsp itc2 drop channels itc2 info bads dcnl dcsp assert array almost equal gave data itc2 data dcnl dcsp itc2 data np ones itc2 data shape dcnl dcsp itc data np zeros itc data shape dcnl dcsp itc2 nave 2 dcnl dcsp itc nave 1 dcnl dcsp itc drop channels itc ch names0 dcnl dcsp combined itc combine tfr itc2 itc dcnl dcsp assert array almost equal combined itc data np ones combined itc data shape 2 3 dcnl dcsp power itc tfr morlet epochs freqs freqs n cycles 2 use fft false return itc true dcnl dcsp assert true power data shape len picks len freqs len times dcnl dcsp assert true power data shape itc data shape dcnl dcsp assert true np sum itc data 1 0 dcnl dcsp assert true np sum itc data < 0 0 dcnl dcsp tfr tfr morlet epochs0 freqs use fft true n cycles 2 average false return itc false data0 dcnl dcsp assert true tfr shape len picks len freqs len times dcnl dcsp tfr2 tfr morlet epochs0 freqs use fft true n cycles 2 decim slice 0 2 average false return itc false data0 dcnl dcsp assert true tfr2 shape len picks len freqs 2 dcnl dcsp single power tfr morlet epochs freqs 2 average false return itc false data dcnl dcsp single power2 tfr morlet epochs freqs 2 decim slice 0 2 average false return itc false data dcnl dcsp single power3 tfr morlet epochs freqs 2 decim slice 1 3 average false return itc false data dcnl dcsp single power4 tfr morlet epochs freqs 2 decim slice 2 4 average false return itc false data dcnl dcsp assert array almost equal np mean single power axis 0 power data dcnl dcsp assert array almost equal np mean single power2 axis 0 power data 2 dcnl dcsp assert array almost equal np mean single power3 axis 0 power data 1 3 dcnl dcsp assert array almost equal np mean single power4 axis 0 power data 2 4 dcnl dcsp power pick power pick channels power ch names 10 2 dcnl dcsp assert equal len power pick ch names len power ch names 10 2 dcnl dcsp assert equal power pick data shape0 len power ch names 10 2 dcnl dcsp power drop power drop channels power ch names1 10 2 dcnl dcsp assert equal power drop ch names power pick ch names dcnl dcsp assert equal power pick data shape0 len power drop ch names dcnl dcsp mne equalize channels power pick power drop dcnl dcsp assert equal power pick ch names power drop ch names dcnl dcsp assert equal power pick data shape power drop data shape dcnl dcsp for decim in 2 3 8 9 dcnl dcsp dcsp for use fft in true false dcnl dcsp dcsp dcsp power itc tfr morlet epochs freqs freqs n cycles 2 use fft use fft return itc true decim decim dcnl dcsp dcsp dcsp assert equal power data shape2 np ceil float len times decim dcnl dcsp freqs list range 50 55 dcnl dcsp decim 2 dcnl dcsp n chan n time data shape dcnl dcsp tfr tfr morlet epochs0 freqs 2 0 decim decim average false return itc false data0 dcnl dcsp assert equal tfr shape n chan len freqs n time decim dcnl dcsp ws morlet 512 10 20 n cycles 2 dcnl dcsp assert raises valueerror cwt data0 ws mode foo dcnl dcsp for use fft in true false dcnl dcsp dcsp for mode in same valid full dcnl dcsp dcsp dcsp cwt data0 ws use fft use fft mode mode dcnl dcsp assert raises typeerror tfr morlet epochs freqs freqs n cycles n cycles use fft true return itc true decim decim dcnl dcsp assert raises valueerror cwt data0 ws0 size 1 ws use fft false dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp cwt data0 ws0 size 1 ws use fft true dcnl dcsp assert equal len w 1 dcnl dcsp psd cwt data0 ws0 1 use fft false mode full dcnl dcsp assert equal psd shape 2 1 420
def test dpsswavelet dcsp freqs np arange 5 25 3 dcnl dcsp ws make dpss 1000 freqs freqs n cycles freqs 2 0 time bandwidth 4 0 zero mean true dcnl dcsp assert true len ws 3 dcnl dcsp assert true np abs np mean np real ws00 < 1e05 dcnl dcsp assert true len ws0 len freqs
slow test dcnl def test tfr multitaper dcsp sfreq 200 0 dcnl dcsp ch names sim0001 sim0002 dcnl dcsp ch types grad grad dcnl dcsp info create info ch names ch names sfreq sfreq ch types ch types dcnl dcsp n times int sfreq dcnl dcsp n epochs 3 dcnl dcsp seed 42 dcnl dcsp rng np random randomstate seed dcnl dcsp noise 0 1 rng randn n epochs len ch names n times dcnl dcsp t np arange n times dtype np float sfreq dcnl dcsp signal np sin np pi 2 0 50 0 t dcnl dcsp signalnp logical or t < 0 45 t 0 55 0 0 dcnl dcsp on time np logical and t 0 45 t < 0 55 dcnl dcsp signalon time np hanning on time sum dcnl dcsp dat noise + signal dcnl dcsp reject dict grad 4000 0 dcnl dcsp events np empty n epochs 3 int dcnl dcsp first event sample 100 dcnl dcsp event id dict sin50hz 1 dcnl dcsp for k in range n epochs dcnl dcsp dcsp eventsk first event sample + k n times 0 event id sin50hz dcnl dcsp epochs epochsarray data dat info info events events event id event id reject reject dcnl dcsp freqs np arange 35 70 5 dtype np float dcnl dcsp power itc tfr multitaper epochs freqs freqs n cycles freqs 2 0 time bandwidth 4 0 dcnl dcsp power2 itc2 tfr multitaper epochs freqs freqs n cycles freqs 2 0 time bandwidth 4 0 decim slice 0 2 dcnl dcsp picks np arange len ch names dcnl dcsp power picks itc picks tfr multitaper epochs freqs freqs n cycles freqs 2 0 time bandwidth 4 0 picks picks dcnl dcsp power epochs tfr multitaper epochs freqs freqs n cycles freqs 2 0 time bandwidth 4 0 return itc false average false dcnl dcsp power averaged power epochs average dcnl dcsp power evoked tfr multitaper epochs average freqs freqs n cycles freqs 2 0 time bandwidth 4 0 return itc false average false average dcnl dcsp print power evoked dcnl dcsp power epochs picked power epochs copy drop channels sim0002 dcnl dcsp assert equal power epochs picked data shape 3 1 7 200 dcnl dcsp assert equal power epochs picked ch names sim0001 dcnl dcsp assert raises valueerror tfr multitaper epochs freqs freqs n cycles freqs 2 0 return itc true average false dcnl dcsp assert array almost equal power data power picks data dcnl dcsp assert array almost equal power data power averaged data dcnl dcsp assert array almost equal power times power epochs times dcnl dcsp assert array almost equal power times power averaged times dcnl dcsp assert equal power nave power averaged nave dcnl dcsp assert equal power epochs data shape 3 2 7 200 dcnl dcsp assert array almost equal itc data itc picks data dcnl dcsp assert array equal power data shape power evoked data shape dcnl dcsp assert raises assertionerror assert array almost equal power data power evoked data dcnl dcsp tmax tnp argmax itc data0 freqs 50 dcnl dcsp fmax freqsnp argmax power data1 t 0 5 dcnl dcsp assert true tmax 0 3 and tmax < 0 7 dcnl dcsp assert false np any itc data < 0 0 dcnl dcsp assert true fmax 40 and fmax < 60 dcnl dcsp assert true power2 data shape len picks len freqs 2 dcnl dcsp assert true power2 data shape itc2 data shape dcnl dcsp assert raises typeerror tfr multitaper epochs freqs freqs n cycles freqs 2 0 time bandwidth 4 0 decim 1 dcnl dcsp assert raises valueerror tfr multitaper epochs freqs freqs n cycles 1000 time bandwidth 4 0
def test crop dcsp data np zeros 3 2 3 dcnl dcsp times np array 0 1 0 2 0 3 dcnl dcsp freqs np array 0 1 0 2 dcnl dcsp info mne create info meg dcsp 001 meg dcsp 002 meg dcsp 003 1000 0 mag mag mag dcnl dcsp tfr averagetfr info data data times times freqs freqs nave 20 comment test method crazytfr dcnl dcsp tfr crop 0 2 0 3 dcnl dcsp assert array equal tfr times 0 2 0 3 dcnl dcsp assert equal tfr data shape 1 2
requires h5py dcnl def test io dcsp tempdir tempdir dcnl dcsp fname op join tempdir testtfr h5 dcnl dcsp data np zeros 3 2 3 dcnl dcsp times np array 0 1 0 2 0 3 dcnl dcsp freqs np array 0 1 0 2 dcnl dcsp info mne create info meg dcsp 001 meg dcsp 002 meg dcsp 003 1000 0 mag mag mag dcnl dcsp tfr averagetfr info data data times times freqs freqs nave 20 comment test method crazytfr dcnl dcsp tfr save fname dcnl dcsp tfr2 read tfrs fname condition test dcnl dcsp assert array equal tfr data tfr2 data dcnl dcsp assert array equal tfr times tfr2 times dcnl dcsp assert array equal tfr freqs tfr2 freqs dcnl dcsp assert equal tfr comment tfr2 comment dcnl dcsp assert equal tfr nave tfr2 nave dcnl dcsp assert raises ioerror tfr save fname dcnl dcsp tfr comment none dcnl dcsp tfr save fname overwrite true dcnl dcsp assert equal read tfrs fname condition 0 comment tfr comment dcnl dcsp tfr comment testa dcnl dcsp tfr2 comment testb dcnl dcsp fname op join tempdir test2tfr h5 dcnl dcsp write tfrs fname tfr tfr2 dcnl dcsp tfr3 read tfrs fname condition testa dcnl dcsp assert equal tfr comment tfr3 comment dcnl dcsp assert true isinstance tfr info mne info dcnl dcsp tfrs read tfrs fname condition none dcnl dcsp assert equal len tfrs 2 dcnl dcsp tfr4 tfrs1 dcnl dcsp assert equal tfr2 comment tfr4 comment dcnl dcsp assert raises valueerror read tfrs fname condition nonono dcnl dcsp data np zeros 5 3 2 3 dcnl dcsp tfr epochstfr info data data times times freqs freqs comment test method crazytfr dcnl dcsp tfr save fname true dcnl dcsp read tfr read tfrs fname 0 dcnl dcsp assert array equal tfr data read tfr data
def test plot dcsp import matplotlib pyplot as plt dcnl dcsp data np zeros 3 2 3 dcnl dcsp times np array 0 1 0 2 0 3 dcnl dcsp freqs np array 0 1 0 2 dcnl dcsp info mne create info meg dcsp 001 meg dcsp 002 meg dcsp 003 1000 0 mag mag mag dcnl dcsp tfr averagetfr info data data times times freqs freqs nave 20 comment test method crazytfr dcnl dcsp tfr plot 1 2 title title colorbar false dcnl dcsp plt close all dcnl dcsp ax plt subplot2grid 2 2 0 0 dcnl dcsp ax2 plt subplot2grid 2 2 1 1 dcnl dcsp ax3 plt subplot2grid 2 2 0 1 dcnl dcsp tfr plot picks 0 1 2 axes ax ax2 ax3 dcnl dcsp plt close all dcnl dcsp tfr plot topo picks 1 2 dcnl dcsp plt close all dcnl dcsp tfr plot topo picks 1 2 dcnl dcsp plt close all dcnl dcsp fig tfr plot picks 1 cmap rdbu r dcnl dcsp fig canvas key press event up dcnl dcsp fig canvas key press event dcsp dcnl dcsp fig canvas key press event down dcnl dcsp cbar fig get axes 0 cb dcnl dcsp ax cbar cbar ax dcnl dcsp fake click fig ax 0 1 0 1 dcnl dcsp fake click fig ax 0 1 0 2 kind motion dcnl dcsp fake click fig ax 0 1 0 3 kind release dcnl dcsp fake click fig ax 0 1 0 1 button 3 dcnl dcsp fake click fig ax 0 1 0 2 button 3 kind motion dcnl dcsp fake click fig ax 0 1 0 3 kind release dcnl dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp plt close all
def test add channels dcsp data np zeros 6 2 3 dcnl dcsp times np array 0 1 0 2 0 3 dcnl dcsp freqs np array 0 1 0 2 dcnl dcsp info mne create info meg dcsp 001 meg dcsp 002 meg dcsp 003 eeg dcsp 001 eeg dcsp 002 stim dcsp 001 1000 0 mag mag mag eeg eeg stim dcnl dcsp tfr averagetfr info data data times times freqs freqs nave 20 comment test method crazytfr dcnl dcsp tfr eeg tfr copy pick types meg false eeg true dcnl dcsp tfr meg tfr copy pick types meg true dcnl dcsp tfr stim tfr copy pick types meg false stim true dcnl dcsp tfr eeg meg tfr copy pick types meg true eeg true dcnl dcsp tfr new tfr meg copy add channels tfr eeg tfr stim dcnl dcsp assert true all ch in tfr new ch names for ch in tfr stim ch names + tfr meg ch names dcnl dcsp tfr new tfr meg copy add channels tfr eeg dcnl dcsp assert true ch in tfr new ch names for ch in tfr ch names dcnl dcsp assert array equal tfr new data tfr eeg meg data dcnl dcsp assert true all ch not in tfr new ch names for ch in tfr stim ch names dcnl dcsp tfr badsf tfr eeg copy dcnl dcsp tfr badsf info sfreq 3 1415927 dcnl dcsp tfr eeg tfr eeg crop 0 1 0 1 dcnl dcsp assert raises runtimeerror tfr meg add channels tfr badsf dcnl dcsp assert raises assertionerror tfr meg add channels tfr eeg dcnl dcsp assert raises valueerror tfr meg add channels tfr meg dcnl dcsp assert raises assertionerror tfr meg add channels tfr badsf
def test compute tfr dcsp event id 1 dcnl dcsp tmin 0 2 dcnl dcsp tmax 0 498 dcnl dcsp raw read raw fif raw fname dcnl dcsp events read events event fname dcnl dcsp exclude raw info bads + meg dcsp 2443 eeg dcsp 053 dcnl dcsp picks pick types raw info meg grad eeg false stim false include exclude exclude dcnl dcsp picks picks 2 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks dcnl dcsp data epochs get data dcnl dcsp sfreq epochs info sfreq dcnl dcsp freqs np arange 10 20 3 astype float dcnl dcsp for func use fft zero mean output in product tfr array multitaper tfr array morlet false true false true complex power phase avg power itc avg power itc dcnl dcsp dcsp if func tfr array multitaper and output phase dcnl dcsp dcsp dcsp assert raises notimplementederror func data sfreq sfreq frequencies freqs output output dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp out func data sfreq sfreq frequencies freqs use fft use fft zero mean zero mean n cycles 2 0 output output dcnl dcsp dcsp shape np r data shape 2 len freqs data shape2 dcnl dcsp dcsp if avg in output or itc in output dcnl dcsp dcsp dcsp assert array equal shape1 out shape dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert array equal shape out shape dcnl dcsp dcsp if output in complex avg power itc dcnl dcsp dcsp dcsp assert equal np complex out dtype dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert equal np float out dtype dcnl dcsp dcsp assert true np all np isfinite out dcnl dcsp for data in none foo data0 dcnl dcsp dcsp assert raises valueerror compute tfr data freqs sfreq dcnl dcsp for freqs in none foo 0 dcnl dcsp dcsp assert raises valueerror compute tfr data freqs sfreq dcnl dcsp for sfreq in none foo dcnl dcsp dcsp assert raises valueerror compute tfr data freqs sfreq dcnl dcsp for key in output method use fft decim n jobs dcnl dcsp dcsp for value in none foo dcnl dcsp dcsp dcsp kwargs key value dcnl dcsp dcsp dcsp assert raises valueerror compute tfr data freqs sfreq kwargs dcnl dcsp assert raises valueerror compute tfr data freqs sfreq method morlet time bandwidth 1 dcnl dcsp assert raises notimplementederror compute tfr data freqs sfreq method multitaper output phase dcnl dcsp out compute tfr data freqs sfreq output itc n cycles 2 0 dcnl dcsp assert true np sum out 1 0 dcnl dcsp assert true np sum out < 0 0 dcnl dcsp for decim in 2 3 8 9 slice 0 2 slice 1 3 slice 2 4 dcnl dcsp dcsp decim slice none none decim if isinstance decim int else decim dcnl dcsp dcsp n time len np arange data shape2 decim dcnl dcsp dcsp shape np r data shape 2 len freqs n time dcnl dcsp dcsp for method in multitaper morlet dcnl dcsp dcsp dcsp out compute tfr data freqs sfreq method method decim decim n cycles 2 0 dcnl dcsp dcsp dcsp assert array equal shape out shape dcnl dcsp dcsp dcsp out compute tfr data freqs sfreq method method decim decim output avg power n cycles 2 0 dcnl dcsp dcsp dcsp assert array equal shape1 out shape
requires nitime dcnl def test dpss windows dcsp import nitime as ni dcnl dcsp n 1000 dcnl dcsp half nbw 4 dcnl dcsp kmax int 2 half nbw dcnl dcsp dpss eigs dpss windows n half nbw kmax low bias false dcnl dcsp dpss ni eigs ni ni algorithms dpss windows n half nbw kmax dcnl dcsp assert array almost equal dpss dpss ni dcnl dcsp assert array almost equal eigs eigs ni dcnl dcsp dpss eigs dpss windows n half nbw kmax interp from 200 low bias false dcnl dcsp dpss ni eigs ni ni algorithms dpss windows n half nbw kmax interp from 200 dcnl dcsp assert array almost equal dpss dpss ni dcnl dcsp assert array almost equal eigs eigs ni
requires nitime dcnl def test multitaper psd dcsp import nitime as ni dcnl dcsp n times 1000 dcnl dcsp n channels 5 dcnl dcsp data np random randomstate 0 randn n channels n times dcnl dcsp sfreq 500 dcnl dcsp info create info n channels sfreq eeg dcnl dcsp raw rawarray data info dcnl dcsp assert raises valueerror psd multitaper raw sfreq normalization foo dcnl dcsp ni 5 looseversion ni version looseversion 0 5 dcnl dcsp norm full if ni 5 else length dcnl dcsp for adaptive n jobs in zip false true true 1 1 2 dcnl dcsp dcsp psd freqs psd multitaper raw adaptive adaptive n jobs n jobs normalization norm dcnl dcsp dcsp freqs ni psd ni ni algorithms spectral multi taper psd data sfreq adaptive adaptive jackknife false dcnl dcsp dcsp assert array almost equal psd 1 psd ni 1 1 decimal 3 dcnl dcsp dcsp assert array almost equal freqs freqs ni 1
def psd func epoch noverlap n per seg nfft fs freq mask func dcsp return func epoch fs fs nperseg n per seg noverlap noverlap nfft nfft window hann 2 freq mask
def check nfft n n fft n per seg n overlap dcsp if n per seg is none and n fft n dcnl dcsp dcsp raise valueerror if dcsp n per seg dcsp is dcsp none dcsp n fft dcsp is dcsp not dcsp allowed dcsp to dcsp be dcsp dcsp n times dcsp if dcsp you dcsp want dcsp zeropadding dcsp you dcsp have dcsp to dcsp set dcsp n per seg dcsp to dcsp relevant dcsp length dcsp got dcsp n fft dcsp of dcsp d dcsp while dcsp signal dcsp length dcsp is dcsp d n fft n dcnl dcsp n per seg n fft if n per seg is none or n per seg n fft else n per seg dcnl dcsp n per seg n if n per seg n else n per seg dcnl dcsp if n overlap n per seg dcnl dcsp dcsp raise valueerror n overlap dcsp cannot dcsp be dcsp greater dcsp than dcsp n per seg dcsp or dcsp n fft dcsp got dcsp n overlap dcsp of dcsp d dcsp while dcsp n per seg dcsp is dcsp d n overlap n per seg dcnl dcsp return n fft n per seg n overlap
def check psd data inst tmin tmax picks proj reject by annotation false dcsp from io base import baseraw dcnl dcsp from epochs import baseepochs dcnl dcsp from evoked import evoked dcnl dcsp if not isinstance inst baseepochs baseraw evoked dcnl dcsp dcsp raise valueerror epochs dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp epochs dcsp raw dcsp orevoked dcsp got dcsp type dcsp 0 format type inst dcnl dcsp time mask time mask inst times tmin tmax sfreq inst info sfreq dcnl dcsp if picks is none dcnl dcsp dcsp picks pick data channels inst info with ref meg false dcnl dcsp if proj dcnl dcsp dcsp inst inst copy apply proj dcnl dcsp sfreq inst info sfreq dcnl dcsp if isinstance inst baseraw dcnl dcsp dcsp start stop np where time mask 00 1 dcnl dcsp dcsp rba nan if reject by annotation else reject by annotation dcnl dcsp dcsp data inst get data picks start stop + 1 reject by annotation rba dcnl dcsp elif isinstance inst baseepochs dcnl dcsp dcsp data inst get data picks time mask dcnl dcsp else dcnl dcsp dcsp data inst datapicks time mask dcnl dcsp return data sfreq
verbose dcnl def psd array welch x sfreq fmin 0 fmax np inf n fft 256 n overlap 0 n per seg none n jobs 1 verbose none dcsp spectrogram get spectrogram dcnl dcsp dshape x shape 1 dcnl dcsp n times x shape 1 dcnl dcsp x x reshape 1 n times dcnl dcsp n fft n per seg n overlap check nfft n times n fft n per seg n overlap dcnl dcsp win size n fft float sfreq dcnl dcsp logger info effective dcsp window dcsp size dcsp dcsp 0 3f dcsp s win size dcnl dcsp freqs np arange n fft 2 + 1 dtype float sfreq n fft dcnl dcsp freq mask freqs fmin freqs < fmax dcnl dcsp freqs freqsfreq mask dcnl dcsp parallel my psd func n jobs parallel func psd func n jobs n jobs dcnl dcsp x splits np array split x n jobs dcnl dcsp f spectrogram parallel my psd func d noverlap n overlap nfft n fft fs sfreq freq mask freq mask func spectrogram n per seg n per seg for d in x splits dcnl dcsp psds np concatenate np nanmean f s axis 1 for f s in f spectrogram axis 0 dcnl dcsp psds shape np hstack dshape 1 dcnl dcsp return psds freqs
verbose dcnl def psd welch inst fmin 0 fmax np inf tmin none tmax none n fft 256 n overlap 0 n per seg none picks none proj false n jobs 1 reject by annotation true verbose none dcsp data sfreq check psd data inst tmin tmax picks proj reject by annotation reject by annotation dcnl dcsp return psd array welch data sfreq fmin fmin fmax fmax n fft n fft n overlap n overlap n per seg n per seg n jobs n jobs verbose verbose
verbose dcnl def psd multitaper inst fmin 0 fmax np inf tmin none tmax none bandwidth none adaptive false low bias true normalization length picks none proj false n jobs 1 verbose none dcsp data sfreq check psd data inst tmin tmax picks proj dcnl dcsp return psd array multitaper data sfreq fmin fmin fmax fmax bandwidth bandwidth adaptive adaptive low bias low bias normalization normalization n jobs n jobs verbose verbose
def yule walker x order 1 dcsp assert x ndim 2 dcnl dcsp denom x shape 1 np arange order + 1 dcnl dcsp r np zeros order + 1 np float64 dcnl dcsp for di d in enumerate x dcnl dcsp dcsp d d mean dcnl dcsp dcsp r0 + np dot d d dcnl dcsp dcsp for k in range 1 order + 1 dcnl dcsp dcsp dcsp rk + np dot d0 k dk dcnl dcsp r denom len x dcnl dcsp rho linalg solve linalg toeplitz r 1 r1 dcnl dcsp sigmasq r0 r1 rho sum dcnl dcsp return rho np sqrt sigmasq
verbose dcnl def fit iir model raw raw order 2 picks none tmin none tmax none verbose none dcsp from cov import apply scaling array dcnl dcsp start stop none none dcnl dcsp if tmin is not none dcnl dcsp dcsp start raw time as index tmin 0 dcnl dcsp if tmax is not none dcnl dcsp dcsp stop raw time as index tmax 0 + 1 dcnl dcsp if picks is none dcnl dcsp dcsp picks pick data channels raw info exclude bads dcnl dcsp data rawpicks start stop0 dcnl dcsp picks list picks by type pick info raw info picks dcnl dcsp scalings handle default scalings cov rank none dcnl dcsp apply scaling array data picks list picks list scalings scalings dcnl dcsp coeffs yule walker data order order dcnl dcsp return np array 1 0 np concatenate 1 0 coeffs
def check input st x in n fft dcsp n times x in shape 1 dcnl dcsp def is power of two n dcnl dcsp dcsp return not n 0 and n n 1 dcnl dcsp if n fft is none or not is power of two n fft and n times n fft dcnl dcsp dcsp n fft 2 int math ceil math log n times 2 dcnl dcsp elif n fft < n times dcnl dcsp dcsp raise valueerror n fft dcsp cannot dcsp be dcsp smaller dcsp than dcsp signal dcsp size dcsp got dcsp s dcsp < dcsp s n fft n times dcnl dcsp if n times < n fft dcnl dcsp dcsp warn the dcsp input dcsp signal dcsp is dcsp shorter dcsp 0 dcsp than dcsp n fft dcsp 1 dcsp applying dcsp zero dcsp padding format x in shape 1 n fft dcnl dcsp dcsp zero pad n fft n times dcnl dcsp dcsp pad array np zeros x in shape 1 + zero pad x in dtype dcnl dcsp dcsp x in np concatenate x in pad array axis 1 dcnl dcsp else dcnl dcsp dcsp zero pad 0 dcnl dcsp return x in n fft zero pad
def precompute st windows n samp start f stop f sfreq width dcsp tw fftpack fftfreq n samp 1 0 sfreq n samp dcnl dcsp tw np r tw 1 tw1 1 dcnl dcsp k width dcnl dcsp f range np arange start f stop f 1 dcnl dcsp windows np empty len f range len tw dtype np complex dcnl dcsp for i f f in enumerate f range dcnl dcsp dcsp if f 0 0 dcnl dcsp dcsp dcsp window np ones len tw dcnl dcsp dcsp else dcnl dcsp dcsp dcsp window f np sqrt 2 0 np pi k np exp 0 5 1 0 k 2 0 f 2 0 tw 2 0 dcnl dcsp dcsp window window sum dcnl dcsp dcsp windowsi f fftpack fft window dcnl dcsp return windows
def st x start f windows dcsp n samp x shape 1 dcnl dcsp st np empty x shape 1 + len windows n samp dtype np complex dcnl dcsp fx fftpack fft x dcnl dcsp xf np concatenate fx fx axis 1 dcnl dcsp for i f window in enumerate windows dcnl dcsp dcsp f start f + i f dcnl dcsp dcsp st i f fftpack ifft xf f f + n samp window dcnl dcsp return st
def st power itc x start f compute itc zero pad decim w dcsp n samp x shape 1 dcnl dcsp n out n samp zero pad dcnl dcsp n out n out decim + bool n out decim dcnl dcsp psd np empty len w n out dcnl dcsp itc np empty like psd if compute itc else none dcnl dcsp x fftpack fft x dcnl dcsp xx np concatenate x x axis 1 dcnl dcsp for i f window in enumerate w dcnl dcsp dcsp f start f + i f dcnl dcsp dcsp st fftpack ifft xx f f + n samp window dcnl dcsp dcsp if zero pad 0 dcnl dcsp dcsp dcsp tfr st zero pad decim dcnl dcsp dcsp else dcnl dcsp dcsp dcsp tfr st decim dcnl dcsp dcsp tfr abs np abs tfr dcnl dcsp dcsp tfr abs tfr abs 0 1 0 dcnl dcsp dcsp if compute itc dcnl dcsp dcsp dcsp tfr tfr abs dcnl dcsp dcsp dcsp itci f np abs np mean tfr axis 0 dcnl dcsp dcsp tfr abs tfr abs dcnl dcsp dcsp psdi f np mean tfr abs axis 0 dcnl dcsp return psd itc
def tfr array stockwell data sfreq fmin none fmax none n fft none width 1 0 decim 1 return itc false n jobs 1 dcsp n epochs n channels data shape 2 dcnl dcsp n out data shape2 decim + bool data shape2 decim dcnl dcsp data n fft zero pad check input st data n fft dcnl dcsp freqs fftpack fftfreq n fft 1 0 sfreq dcnl dcsp if fmin is none dcnl dcsp dcsp fmin freqs freqs 0 0 dcnl dcsp if fmax is none dcnl dcsp dcsp fmax freqs max dcnl dcsp start f np abs freqs fmin argmin dcnl dcsp stop f np abs freqs fmax argmin dcnl dcsp freqs freqsstart f stop f dcnl dcsp w precompute st windows data shape 1 start f stop f sfreq width dcnl dcsp n freq stop f start f dcnl dcsp psd np empty n channels n freq n out dcnl dcsp itc np empty n channels n freq n out if return itc else none dcnl dcsp parallel my st parallel func st power itc n jobs dcnl dcsp tfrs parallel my st data c start f return itc zero pad decim w for c in range n channels dcnl dcsp for c this psd this itc in enumerate iter tfrs dcnl dcsp dcsp psdc this psd dcnl dcsp dcsp if this itc is not none dcnl dcsp dcsp dcsp itcc this itc dcnl dcsp return psd itc freqs
verbose dcnl def tfr stockwell inst fmin none fmax none n fft none width 1 0 decim 1 return itc false n jobs 1 verbose none dcsp data get data inst return itc dcnl dcsp picks pick types inst info meg true eeg true dcnl dcsp info pick info inst info picks dcnl dcsp data data picks dcnl dcsp n jobs check n jobs n jobs dcnl dcsp power itc freqs tfr array stockwell data sfreq info sfreq fmin fmin fmax fmax n fft n fft width width decim decim return itc return itc n jobs n jobs dcnl dcsp times inst times decim copy dcnl dcsp nave len data dcnl dcsp out averagetfr info power times freqs nave method stockwellpower dcnl dcsp if return itc dcnl dcsp dcsp out out averagetfr deepcopy info itc times copy freqs copy nave method stockwellitc dcnl dcsp return out
def description dcsp for desc in description splitlines dcnl dcsp dcsp print desc
def description dcsp for desc in description splitlines dcnl dcsp dcsp print desc
def description dcsp for desc in description splitlines dcnl dcsp dcsp print desc
def description dcsp for desc in description splitlines dcnl dcsp dcsp print desc
def description dcsp for desc in description splitlines dcnl dcsp dcsp print desc
def dataset version path name dcsp ver fname op join path version txt dcnl dcsp if op exists ver fname dcnl dcsp dcsp with open ver fname r as fid dcnl dcsp dcsp dcsp version fid readline strip dcnl dcsp else dcnl dcsp dcsp version 0 3 if name sample else 0 7 dcnl dcsp return version
def get path path key name dcsp if path is not none dcnl dcsp dcsp if not isinstance path string types dcnl dcsp dcsp dcsp raise valueerror path dcsp must dcsp be dcsp a dcsp string dcsp or dcsp none dcnl dcsp dcsp return path dcnl dcsp path get config key get config mne data dcnl dcsp if path is not none dcnl dcsp dcsp return path dcnl dcsp logger info using dcsp default dcsp location dcsp ~ mne data dcsp for dcsp s name dcnl dcsp path op join os getenv mne fake home dir op expanduser ~ mne data dcnl dcsp if not op exists path dcnl dcsp dcsp logger info creating dcsp ~ mne data dcnl dcsp dcsp try dcnl dcsp dcsp dcsp os mkdir path dcnl dcsp dcsp except oserror dcnl dcsp dcsp dcsp raise oserror user dcsp does dcsp not dcsp have dcsp write dcsp permissions dcsp at dcsp s dcsp try dcsp giving dcsp the dcsp path dcsp as dcsp an dcsp argument dcsp to dcsp data path dcsp where dcsp user dcsp has dcsp write dcsp permissions dcsp for dcsp ex data path home xyz me2 path dcnl dcsp return path
def do path update path update path key name dcsp path op abspath path dcnl dcsp if update path is none dcnl dcsp dcsp if get config key path dcnl dcsp dcsp dcsp update path true dcnl dcsp dcsp dcsp if updatedatasetpath in sys argv dcnl dcsp dcsp dcsp dcsp answer y dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp msg do dcsp you dcsp want dcsp to dcsp set dcsp the dcsp path n dcsp dcsp dcsp dcsp s nas dcsp the dcsp default dcsp s dcsp dataset dcsp path dcsp in dcsp the dcsp mnepython dcsp config dcsp y n dcsp path name dcnl dcsp dcsp dcsp dcsp answer input msg dcnl dcsp dcsp dcsp if answer lower n dcnl dcsp dcsp dcsp dcsp update path false dcnl dcsp dcsp else dcnl dcsp dcsp dcsp update path false dcnl dcsp if update path is true dcnl dcsp dcsp set config key path set env false dcnl dcsp return path
def data path path none force update false update path true download true name none check version false return version false archive name none dcsp key fake mne datasets fake path misc mne datasets misc path sample mne datasets sample path spm mne datasets spm face path somato mne datasets somato path brainstorm mne datasets brainstorm path testing mne datasets testing path multimodal mne datasets multimodal path visual 92 categories mne datasets visual 92 categories path mtrf mne datasets mtrf path fieldtrip cmc mne datasets fieldtrip cmc path name dcnl dcsp path get path path key name dcnl dcsp releases dict testing 0 36 misc 0 3 dcnl dcsp archive names dict misc mnemiscdata s tar gz releases misc sample mnesampledataprocessed tar gz somato mnesomatodata tar gz spm mnespmface tar gz testing mnetestingdata s tar gz releases testing multimodal mnemultimodaldata tar gz fake foo tgz visual 92 categories mnevisual 92 categories tar gz mtrf mtrf 1 5 zip fieldtrip cmc subjectcmc zip dcnl dcsp if archive name is not none dcnl dcsp dcsp archive names update archive name dcnl dcsp folder names dict brainstorm mnebrainstormdata fake foo misc mnemiscdata mtrf mtrf 1 5 sample mnesampledata somato mnesomatodata multimodal mnemultimodaldata spm mnespmface testing mnetestingdata visual 92 categories mnevisual 92 categoriesdata fieldtrip cmc mnefieldtrip cmcdata dcnl dcsp urls dict brainstorm https mnetools s3 amazonaws com datasets mnebrainstormdata s fake https github com mnetools mnetestingdata raw master datasets s misc https codeload github com mnetools mnemiscdata tar gz s releases misc sample https mnetools s3 amazonaws com datasets s somato https mnetools s3 amazonaws com datasets s spm https mnetools s3 amazonaws com datasets s testing https codeload github com mnetools mnetestingdata tar gz s releases testing multimodal https ndownloader figshare com files 5999598 visual 92 categories https mnetools s3 amazonaws com datasets s mtrf https superbdca2 dl sourceforge net project aespa s fieldtrip cmc ftp ftp fieldtriptoolbox org pub fieldtrip tutorial s dcnl dcsp hashes dict brainstorm none fake 3194e9f7b46039bb050a74f3e1ae9908 misc d822a720ef94302467cb6ad1d320b669 sample 1d5da3a809fded1ef5734444ab5bf857 somato f3e3a8441477bb5bacae1d0c6e0964fb spm ecce87351d88def59d3d4cdc561e2a60 testing 03e84fe9a50dfeb04ab5f138ceed441d multimodal 26ec847ae9ab80f58f204d09e2c08367 visual 92 categories 46c7e590f4a48596441ce001595d5e58 mtrf 273a390ebbc48da2c3184b01a82e4636 fieldtrip cmc 6f9fd6520f9a66e20994423808d2528c dcnl dcsp folder origs dict misc mnemiscdata s releases misc testing mnetestingdata s releases testing dcnl dcsp folder name folder namesname dcnl dcsp archive name archive namesname dcnl dcsp hash hashesname dcnl dcsp url urlsname dcnl dcsp folder orig folder origs get name none dcnl dcsp if s in url dcnl dcsp dcsp url url archive name dcnl dcsp folder path op join path folder name dcnl dcsp if name brainstorm dcnl dcsp dcsp extract path folder path dcnl dcsp dcsp folder path op join folder path archive namesname split 0 dcnl dcsp rm archive false dcnl dcsp martinos path cluster fusion sample data + archive name dcnl dcsp neurospin path neurospin tmp gramfort + archive name dcnl dcsp if not op exists folder path and not download dcnl dcsp dcsp return dcnl dcsp if not op exists folder path or force update dcnl dcsp dcsp if name brainstorm dcnl dcsp dcsp dcsp if acceptbrainstormlicense in sys argv dcnl dcsp dcsp dcsp dcsp answer y dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp answer input sagree dcsp y n dcsp bst license text dcnl dcsp dcsp dcsp if answer lower y dcnl dcsp dcsp dcsp dcsp raise runtimeerror you dcsp must dcsp agree dcsp to dcsp the dcsp license dcsp to dcsp use dcsp this dcsp dataset dcnl dcsp dcsp logger info downloading dcsp or dcsp reinstalling dcsp data dcsp archive dcsp s dcsp at dcsp location dcsp s archive name path dcnl dcsp dcsp if op exists martinos path dcnl dcsp dcsp dcsp archive name martinos path dcnl dcsp dcsp elif op exists neurospin path dcnl dcsp dcsp dcsp archive name neurospin path dcnl dcsp dcsp else dcnl dcsp dcsp dcsp archive name op join path archive name dcnl dcsp dcsp dcsp rm archive true dcnl dcsp dcsp dcsp fetch archive true dcnl dcsp dcsp dcsp if op exists archive name dcnl dcsp dcsp dcsp dcsp msg archive dcsp already dcsp exists dcsp overwrite dcsp it dcsp y n dcsp dcnl dcsp dcsp dcsp dcsp answer input msg dcnl dcsp dcsp dcsp dcsp if answer lower y dcnl dcsp dcsp dcsp dcsp dcsp os remove archive name dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp fetch archive false dcnl dcsp dcsp dcsp if fetch archive dcnl dcsp dcsp dcsp dcsp fetch file url archive name print destination false hash hash dcnl dcsp dcsp if op exists folder path dcnl dcsp dcsp dcsp def onerror func path exc info dcnl dcsp dcsp dcsp dcsp deal dcsp with dcsp access dcsp errors dcsp e g dcsp testing dcsp dataset dcsp readonly dcnl dcsp dcsp dcsp dcsp do false dcnl dcsp dcsp dcsp dcsp if not os access path os w ok dcnl dcsp dcsp dcsp dcsp dcsp perm os stat path st mode | stat s iwusr dcnl dcsp dcsp dcsp dcsp dcsp os chmod path perm dcnl dcsp dcsp dcsp dcsp dcsp do true dcnl dcsp dcsp dcsp dcsp if not os access op dirname path os w ok dcnl dcsp dcsp dcsp dcsp dcsp dir perm os stat op dirname path st mode | stat s iwusr dcnl dcsp dcsp dcsp dcsp dcsp os chmod op dirname path dir perm dcnl dcsp dcsp dcsp dcsp dcsp do true dcnl dcsp dcsp dcsp dcsp if do dcnl dcsp dcsp dcsp dcsp dcsp func path dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp raise dcnl dcsp dcsp dcsp shutil rmtree folder path onerror onerror dcnl dcsp dcsp logger info decompressing dcsp the dcsp archive dcsp s archive name dcnl dcsp dcsp logger info please dcsp be dcsp patient dcsp this dcsp can dcsp take dcsp some dcsp time dcnl dcsp dcsp if name brainstorm dcnl dcsp dcsp dcsp extract path path dcnl dcsp dcsp if name fieldtrip cmc dcnl dcsp dcsp dcsp extract path folder path dcnl dcsp dcsp if archive name endswith zip dcnl dcsp dcsp dcsp with zipfile zipfile archive name r as ff dcnl dcsp dcsp dcsp dcsp ff extractall extract path dcnl dcsp dcsp else dcnl dcsp dcsp dcsp for ext in gz bz2 dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp tf tarfile open archive name r s ext dcnl dcsp dcsp dcsp dcsp dcsp tf extractall path extract path dcnl dcsp dcsp dcsp dcsp dcsp tf close dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp except tarfile readerror as err dcnl dcsp dcsp dcsp dcsp dcsp logger info s dcsp is dcsp s dcsp trying dcsp bz2 archive name err dcnl dcsp dcsp if folder orig is not none dcnl dcsp dcsp dcsp shutil move op join path folder orig folder path dcnl dcsp dcsp if rm archive dcnl dcsp dcsp dcsp os remove archive name dcnl dcsp path do path update path update path key name dcnl dcsp path op join path folder name dcnl dcsp data version dataset version path name dcnl dcsp try dcnl dcsp dcsp from distutils version import looseversion as lv dcnl dcsp except dcnl dcsp dcsp warn could dcsp not dcsp determine dcsp s dcsp dataset dcsp version dcsp dataset dcsp could dcsp be dcsp out dcsp of dcsp date dcsp please dcsp install dcsp the dcsp distutils dcsp package name dcnl dcsp else dcnl dcsp dcsp if check version and lv data version < lv mne version strip git dcnl dcsp dcsp dcsp warn the dcsp name dcsp dataset dcsp version dcsp current dcsp is dcsp older dcsp than dcsp mnepython dcsp version dcsp newest dcsp if dcsp the dcsp examples dcsp fail dcsp you dcsp may dcsp need dcsp to dcsp update dcsp the dcsp name dcsp dataset dcsp by dcsp using dcsp mne datasets name data path force update true format name name current data version newest mne version dcnl dcsp return path data version if return version else path
def get version name dcsp if not has dataset name dcnl dcsp dcsp return none dcnl dcsp return data path name name return version true 1
def has dataset name dcsp endswith brainstorm mne brainstormdata fieldtrip cmc mnefieldtrip cmcdata fake foo misc mnemiscdata sample mnesampledata somato mnesomatodata spm mnespmface testing mnetestingdata visual 92 categories visual 92 categoriesdata name dcnl dcsp archive name none dcnl dcsp if name brainstorm dcnl dcsp dcsp archive name dict brainstorm bst raw dcnl dcsp dp data path download false name name check version false archive name archive name dcnl dcsp return dp endswith endswith
verbose dcnl def download all example data verbose true dcsp from import sample testing misc spm face somato brainstorm megsim eegbci multimodal mtrf fieldtrip cmc dcnl dcsp sample data path dcnl dcsp testing data path dcnl dcsp misc data path dcnl dcsp spm face data path dcnl dcsp somato data path dcnl dcsp multimodal data path dcnl dcsp mtrf data path dcnl dcsp fieldtrip cmc data path dcnl dcsp sys argv + acceptbrainstormlicense dcnl dcsp try dcnl dcsp dcsp brainstorm bst raw data path dcnl dcsp dcsp brainstorm bst auditory data path dcnl dcsp dcsp brainstorm bst phantom elekta data path dcnl dcsp dcsp brainstorm bst phantom ctf data path dcnl dcsp finally dcnl dcsp dcsp sys argv pop 1 dcnl dcsp megsim load data condition visual data format singletrial data type simulation update path true dcnl dcsp megsim load data condition visual data format raw data type experimental update path true dcnl dcsp megsim load data condition visual data format evoked data type simulation update path true dcnl dcsp eegbci load data 1 6 10 14 update path true dcnl dcsp sys argv + accepthcpmmplicense dcnl dcsp try dcnl dcsp dcsp fetch hcp mmp parcellation dcnl dcsp finally dcnl dcsp dcsp sys argv pop 1
verbose dcnl def fetch hcp mmp parcellation subjects dir none verbose none dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp destination op join subjects dir fsaverage label dcnl dcsp fnames op join destination lh hcpmmp1 annot op join destination rh hcpmmp1 annot dcnl dcsp if all op isfile fname for fname in fnames dcnl dcsp dcsp return dcnl dcsp if accepthcpmmplicense in sys argv dcnl dcsp dcsp answer y dcnl dcsp else dcnl dcsp dcsp answer input s nagree dcsp y n dcsp hcp mmp license text dcnl dcsp if answer lower y dcnl dcsp dcsp raise runtimeerror you dcsp must dcsp agree dcsp to dcsp the dcsp license dcsp to dcsp use dcsp this dcsp dataset dcnl dcsp fetch file https ndownloader figshare com files 5528816 fnames0 hash 46a102b59b2fb1bb4bd62d51bf02e975 dcnl dcsp fetch file https ndownloader figshare com files 5528819 fnames1 hash 75e96b331940227bbcb07c1c791c2463
verbose dcnl def data path path none force update false update path true download true verbose none dcsp return data path path path force update force update update path update path name visual 92 categories download download
def get version dcsp return get version visual 92 categories
def test datasets dcsp for dname in sample somato spm face testing bst raw bst auditory bst resting visual 92 categories fieldtrip cmc dcnl dcsp dcsp if dname startswith bst dcnl dcsp dcsp dcsp dataset getattr datasets brainstorm dname dcnl dcsp dcsp else dcnl dcsp dcsp dcsp dataset getattr datasets dname dcnl dcsp if dataset data path download false dcnl dcsp dcsp assert true isinstance dataset get version string types dcnl dcsp else dcnl dcsp dcsp assert true dataset get version is none dcnl dcsp tempdir tempdir dcnl dcsp os environ mne fake home dir tempdir dcnl dcsp try dcnl dcsp dcsp assert equal datasets utils get path none foo bar op join tempdir mne data dcnl dcsp finally dcnl dcsp dcsp del os environ mne fake home dir
requires good network dcnl def test megsim dcsp data dir tempdir dcnl dcsp paths datasets megsim load data index text text path data dir update path false dcnl dcsp assert equal len paths 1 dcnl dcsp assert true paths0 endswith index html
requires good network dcnl def test downloads dcsp data dir tempdir dcnl dcsp path datasets fake data path path data dir update path false dcnl dcsp assert true op isfile op join path bar dcnl dcsp assert true datasets fake get version is none
verbose dcnl def data path url path none force update false update path none verbose none dcsp key mne datasets eegbci path dcnl dcsp name eegbci dcnl dcsp path get path path key name dcnl dcsp destination url to local path url op join path mneeegbcidata dcnl dcsp destinations destination dcnl dcsp if not op isfile destination or force update dcnl dcsp dcsp if op isfile destination dcnl dcsp dcsp dcsp os remove destination dcnl dcsp dcsp if not op isdir op dirname destination dcnl dcsp dcsp dcsp os makedirs op dirname destination dcnl dcsp dcsp fetch file url destination print destination false dcnl dcsp do path update path update path key name dcnl dcsp return destinations
verbose dcnl def load data subject runs path none force update false update path none base url eegmi url verbose none dcsp if not hasattr runs iter dcnl dcsp dcsp runs runs dcnl dcsp data paths dcnl dcsp for r in runs dcnl dcsp dcsp url u s s 03d s s 03d r r 02d edf format u base url s subject r r dcnl dcsp dcsp data paths extend data path url path force update update path dcnl dcsp return data paths
verbose dcnl def data path url path none force update false update path none verbose none dcsp key mne datasets megsim path dcnl dcsp name megsim dcnl dcsp path get path path key name dcnl dcsp destination url to local path url op join path megsim dcnl dcsp destinations destination dcnl dcsp split op splitext destination dcnl dcsp is zip true if split1 lower zip else false dcnl dcsp do unzip false dcnl dcsp if not op isfile destination or force update dcnl dcsp dcsp if op isfile destination dcnl dcsp dcsp dcsp os remove destination dcnl dcsp dcsp if not op isdir op dirname destination dcnl dcsp dcsp dcsp os makedirs op dirname destination dcnl dcsp dcsp fetch file url destination print destination false dcnl dcsp dcsp do unzip true dcnl dcsp if is zip dcnl dcsp dcsp z zipfile zipfile destination dcnl dcsp dcsp decomp dir name op split destination dcnl dcsp dcsp files z namelist dcnl dcsp dcsp if do unzip dcnl dcsp dcsp dcsp stdout write decompressing dcsp g dcsp files dcsp from n s dcsp len files name dcnl dcsp dcsp dcsp z extractall decomp dir dcnl dcsp dcsp dcsp stdout write dcsp done n dcnl dcsp dcsp z close dcnl dcsp dcsp destinations op join decomp dir f for f in files dcnl dcsp path do path update path update path key name dcnl dcsp return destinations
verbose dcnl def load data condition visual data format raw data type experimental path none force update false update path none verbose none dcsp if not condition lower in valid conditions dcnl dcsp dcsp raise valueerror unknown dcsp condition dcsp s condition dcnl dcsp if data format not in valid data formats dcnl dcsp dcsp raise valueerror unknown dcsp data format dcsp s data format dcnl dcsp if data type not in valid data types dcnl dcsp dcsp raise valueerror unknown dcsp data type dcsp s data type dcnl dcsp urls url match condition data format data type dcnl dcsp data paths list dcnl dcsp for url in urls dcnl dcsp dcsp data paths extend data path url path force update update path dcnl dcsp return data paths
def url match condition data format data type dcsp inds np logical and conditions condition data formats data format dcnl dcsp inds np logical and inds data types data type dcnl dcsp inds np logical and inds data formats data format dcnl dcsp good urls list urlsinds dcnl dcsp for gi g in enumerate good urls dcnl dcsp dcsp good urlsgi url root + g dcnl dcsp if len good urls 0 dcnl dcsp dcsp raise valueerror no dcsp megsim dcsp dataset dcsp found dcsp with dcsp condition s ndata format s dcsp data type s condition data format data type dcnl dcsp return good urls
def load all data dcsp from megsim import data path dcnl dcsp for url in urls dcnl dcsp dcsp data path url root + url
testing requires testing data dcnl def test chpi adjust dcsp raw read raw fif chpi fif fname allow maxshield yes dcnl dcsp with catch logging as log dcnl dcsp dcsp get hpi initial fit raw info adjust true verbose debug dcnl dcsp dcsp get hpi info raw info verbose debug dcnl dcsp msg hpifit dcsp 5 dcsp coils dcsp digitized dcsp in dcsp order dcsp 5 dcsp 1 dcsp 4 dcsp 3 dcsp 2 hpifit dcsp 3 dcsp coils dcsp accepted dcsp 1 dcsp 2 dcsp 4 hpi dcsp coil dcsp moments dcsp 3 dcsp 5 2 08542e15 dcsp 1 52486e15 dcsp 1 53484e15 2 14516e15 dcsp 2 09608e15 dcsp 7 30303e16 3 2318e16 dcsp 4 25666e16 dcsp 2 69997e15 5 21717e16 dcsp 1 28406e15 dcsp 1 95335e15 1 21199e15 dcsp 1 25801e19 dcsp 1 18321e15 hpifit dcsp errors dcsp dcsp 0 3 dcsp 0 3 dcsp 5 3 dcsp 0 4 dcsp 3 2 dcsp mm hpi dcsp consistency dcsp of dcsp isotrak dcsp and dcsp hpifit dcsp is dcsp ok hp dcsp fitting dcsp limits dcsp err dcsp dcsp 5 0 dcsp mm dcsp gval dcsp dcsp 0 980 using dcsp 5 dcsp hpi dcsp coils dcsp 83 dcsp 143 dcsp 203 dcsp 263 dcsp 323 dcsp hz dcnl dcsp log log getvalue splitlines dcnl dcsp assert true set log set msg n + n join set msg set log dcnl dcsp raw info dig 5 r 2 + 1 0 dcnl dcsp msg msg 8 + hpifit dcsp errors dcsp dcsp 0 3 dcsp 0 3 dcsp 5 3 dcsp 999 7 dcsp 3 2 dcsp mm note dcsp hpi dcsp coil dcsp 3 dcsp isotrak dcsp is dcsp adjusted dcsp by dcsp 5 3 dcsp mm note dcsp hpi dcsp coil dcsp 5 dcsp isotrak dcsp is dcsp adjusted dcsp by dcsp 3 2 dcsp mm + msg 2 dcnl dcsp with catch logging as log dcnl dcsp dcsp get hpi initial fit raw info adjust true verbose debug dcnl dcsp dcsp get hpi info raw info verbose debug dcnl dcsp log log getvalue splitlines dcnl dcsp assert true set log set msg n + n join set msg set log
testing requires testing data dcnl def test read write head pos dcsp tempdir tempdir dcnl dcsp temp name op join tempdir temp pos dcnl dcsp head pos rand np random randomstate 0 randn 20 10 dcnl dcsp head pos read read head pos pos fname dcnl dcsp for head pos orig in head pos rand head pos read dcnl dcsp dcsp write head pos temp name head pos orig dcnl dcsp dcsp head pos read head pos temp name dcnl dcsp dcsp assert allclose head pos orig head pos atol 0 001 dcnl dcsp assert raises typeerror write head pos 0 head pos read dcnl dcsp assert raises valueerror write head pos temp name foo dcnl dcsp assert raises valueerror write head pos temp name head pos read 9 dcnl dcsp assert raises typeerror read head pos 0 dcnl dcsp assert raises ioerror read head pos temp name + foo
testing requires testing data dcnl def test hpi info dcsp tempdir tempdir dcnl dcsp temp name op join tempdir temp raw fif dcnl dcsp for fname in chpi fif fname sss fif fname dcnl dcsp dcsp raw read raw fif fname allow maxshield yes crop 0 0 1 dcnl dcsp dcsp assert true len raw info hpi subsystem 0 dcnl dcsp dcsp raw save temp name overwrite true dcnl dcsp dcsp info read info temp name dcnl dcsp dcsp assert equal len info hpi subsystem len raw info hpi subsystem
def assert quats actual desired dist tol 0 003 angle tol 5 0 dcsp from scipy interpolate import interp1d dcnl dcsp trans est rot est t est head pos to trans rot t actual dcnl dcsp trans rot t head pos to trans rot t desired dcnl dcsp quats est rot to quat rot est dcnl dcsp if not np isclose t0 t est0 atol 0 1 dcnl dcsp dcsp raise assertionerror start dcsp times dcsp not dcsp within dcsp 100 dcsp ms dcsp 0 3f dcsp dcsp 0 3f t0 t est0 dcnl dcsp use mask t t est0 t < t est 1 dcnl dcsp t tuse mask dcnl dcsp trans transuse mask dcnl dcsp quats rot to quat rot dcnl dcsp quats quatsuse mask dcnl dcsp for q in quats quats est dcnl dcsp dcsp angles angle between quats q q dcnl dcsp dcsp assert allclose angles 0 0 atol 1e05 dcnl dcsp trans est interp interp1d t est trans est axis 0 t dcnl dcsp distances np sqrt np sum trans trans est interp 2 axis 1 dcnl dcsp arg worst np argmax distances dcnl dcsp assert true distancesarg worst < dist tol dcsp 0 3f dcsp seconds dcsp 0 3f dcsp dcsp 0 3f dcsp mm targ worst 1000 distancesarg worst 1000 dist tol dcnl dcsp quats est interp interp1d t est quats est axis 0 t dcnl dcsp angles 180 angle between quats quats est interp quats np pi dcnl dcsp arg worst np argmax angles dcnl dcsp assert true anglesarg worst < angle tol dcsp 0 3f dcsp seconds dcsp 0 3f dcsp dcsp 0 3f dcsp deg targ worst anglesarg worst angle tol
def decimate chpi raw decim 4 dcsp raw dec rawarray raw data decim raw info first samp raw first samp decim dcnl dcsp raw dec info sfreq decim dcnl dcsp for coil in raw dec info hpi meas 0 hpi coils dcnl dcsp dcsp if coil coil freq raw dec info sfreq dcnl dcsp dcsp dcsp coil coil freq np mod coil coil freq raw dec info sfreq dcnl dcsp dcsp dcsp if coil coil freq raw dec info sfreq 2 0 dcnl dcsp dcsp dcsp dcsp coil coil freq raw dec info sfreq coil coil freq dcnl dcsp return raw dec
slow test dcnl testing requires testing data dcnl def test calculate chpi positions dcsp mf quats read head pos pos fname dcnl dcsp raw read raw fif chpi fif fname allow maxshield yes preload true dcnl dcsp raw dec decimate chpi raw 15 dcnl dcsp with catch logging as log dcnl dcsp dcsp py quats calculate chpi positions raw dec verbose debug dcnl dcsp assert true log getvalue startswith hpifit dcnl dcsp assert quats py quats mf quats dist tol 0 004 angle tol 2 5 dcnl dcsp raw no chpi read raw fif test fif fname dcnl dcsp assert raises runtimeerror calculate chpi positions raw no chpi dcnl dcsp raw bad raw copy dcnl dcsp for d in raw bad info dig dcnl dcsp dcsp if d kind fiff fiffv point hpi dcnl dcsp dcsp dcsp d coord frame fiff fiffv coord unknown dcnl dcsp dcsp dcsp break dcnl dcsp assert raises runtimeerror calculate chpi positions raw bad dcnl dcsp for d in raw bad info dig dcnl dcsp dcsp if d kind fiff fiffv point hpi dcnl dcsp dcsp dcsp d coord frame fiff fiffv coord head dcnl dcsp dcsp dcsp d r np ones 3 dcnl dcsp raw bad crop 0 1 0 dcnl dcsp picks np concatenate np arange 306 len raw bad ch names pick types raw bad info meg true 16 dcnl dcsp raw bad pick channels raw bad ch namespick for pick in picks dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp calculate chpi positions raw bad t step min 1 0 verbose true dcnl dcsp assert true 0 5 dcsp good in log file getvalue strip split n 2 dcnl dcsp raw info lowpass 2 0 dcnl dcsp assert raises regex runtimeerror above dcsp the calculate chpi positions raw dcnl dcsp raw read raw artemis123 art fname preload true dcnl dcsp mf quats read head pos art mc fname dcnl dcsp with catch logging as log dcnl dcsp dcsp py quats calculate chpi positions raw t step min 2 0 verbose debug dcnl dcsp assert quats py quats mf quats dist tol 0 004 angle tol 2 5
testing requires testing data dcnl def test calculate chpi positions on chpi5 in one second steps dcsp mf quats read head pos chpi5 pos fname dcnl dcsp raw read raw fif chpi5 fif fname allow maxshield yes dcnl dcsp raw decimate chpi raw crop 0 0 15 0 load data decim 8 dcnl dcsp py quats calculate chpi positions raw t step min 1 0 t step max 1 0 t window 1 0 verbose debug dcnl dcsp assert quats py quats mf quats dist tol 0 0008 angle tol 0 5
slow test dcnl testing requires testing data dcnl def test calculate chpi positions on chpi5 in shorter steps dcsp mf quats read head pos chpi5 pos fname dcnl dcsp raw read raw fif chpi5 fif fname allow maxshield yes dcnl dcsp raw decimate chpi raw crop 0 0 15 0 load data decim 8 dcnl dcsp py quats calculate chpi positions raw t step min 0 1 t step max 0 1 t window 0 1 verbose debug dcnl dcsp assert quats py quats mf quats dist tol 0 001 angle tol 0 6
def test simulate calculate chpi positions dcsp info read info raw fname dcnl dcsp chpi channel u sti201 dcnl dcsp ncoil len info hpi results 0 order dcnl dcsp coil freq 10 + np arange ncoil 5 dcnl dcsp hpi subsystem event channel chpi channel hpi coils event bits np array 256 0 256 256 dtype np int32 event bits np array 512 0 512 512 dtype np int32 event bits np array 1024 0 1024 1024 dtype np int32 event bits np array 2048 0 2048 2048 dtype np int32 ncoil ncoil dcnl dcsp info hpi subsystem hpi subsystem dcnl dcsp for l freq in enumerate coil freq dcnl dcsp dcsp info hpi meas 0 hpi coils l coil freq freq dcnl dcsp picks pick types info meg true stim true eeg false exclude dcnl dcsp info sfreq 100 0 dcnl dcsp info pick info info picks dcnl dcsp info chs info ch names index sti dcsp 001 ch name sti201 dcnl dcsp info update redundant dcnl dcsp info projs dcnl dcsp info trans info dev head t trans copy dcnl dcsp dev head pos ini np concatenate rot to quat info trans 3 3 info trans 3 3 dcnl dcsp ez np array 0 0 1 dcnl dcsp duration 30 dcnl dcsp head pos sfreq quotient 0 1 dcnl dcsp s int duration info sfreq head pos sfreq quotient dcnl dcsp dz 0 001 dcnl dcsp dev head pos np zeros s 10 dcnl dcsp dev head pos 0 np arange s info sfreq head pos sfreq quotient dcnl dcsp dev head pos 1 4 dev head pos ini 3 dcnl dcsp dev head pos 4 7 dev head pos ini3 + np outer np arange s dz ez dcnl dcsp dev head pos 7 1 0 dcnl dcsp dev head pos 9 100 dz info sfreq head pos sfreq quotient dcnl dcsp raw data np zeros len picks int duration info sfreq + 0 5 dcnl dcsp raw rawarray raw data info dcnl dcsp dip dipole np array 0 0 0 1 0 2 np array 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 np array 1e09 1e09 1e09 np array 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 np array 1 0 1 0 1 0 dip dcnl dcsp sphere make sphere model auto auto info info relative radii 1 0 0 9 sigmas 0 33 0 3 dcnl dcsp fwd stc make forward dipole dip sphere info dcnl dcsp stc resample info sfreq dcnl dcsp raw simulate raw raw stc none fwd src sphere cov none blink false ecg false chpi true head pos dev head pos mindist 1 0 interp zero verbose none dcnl dcsp quats calculate chpi positions raw t step min raw info sfreq head pos sfreq quotient t step max raw info sfreq head pos sfreq quotient t window 1 0 dcnl dcsp assert quats quats dev head pos dist tol 0 001 angle tol 1 0
testing requires testing data dcnl def test calculate chpi coil locs dcsp raw read raw fif chpi fif fname allow maxshield yes preload true dcnl dcsp raw dec decimate chpi raw 15 dcnl dcsp times chpi digs calculate chpi coil locs raw dec verbose debug dcnl dcsp assert allclose times9 9 9 atol 0 001 dcnl dcsp assert allclose chpi digs92 r 0 01937833 0 00346804 0 06331209 atol 0 001 dcnl dcsp assert allclose chpi digs92 gof 0 9957976 atol 0 001 dcnl dcsp assert allclose chpi digs94 r 0 05442122 0 00997692 0 03721696 atol 0 001 dcnl dcsp assert allclose chpi digs94 gof 0 0757000807946292 atol 0 001 dcnl dcsp raw read raw artemis123 art fname preload true dcnl dcsp times chpi digs calculate chpi coil locs raw verbose debug dcnl dcsp assert allclose times2 2 9 atol 0 001 dcnl dcsp assert allclose chpi digs20 gof 0 9980471794552791 atol 0 001 dcnl dcsp assert allclose chpi digs20 r 0 0157762 0 06655744 0 00545172 atol 0 001
testing requires testing data dcnl def test chpi subtraction dcsp raw read raw fif chpi fif fname allow maxshield yes preload true dcnl dcsp raw info bads meg0111 dcnl dcsp raw del proj dcnl dcsp with catch logging as log dcnl dcsp dcsp filter chpi raw include line false verbose true dcnl dcsp assert true no dcsp average dcsp eeg not in log getvalue dcnl dcsp assert true 5 dcsp chpi in log getvalue dcnl dcsp raw crop 0 16 dcnl dcsp raw c read raw fif sss hpisubt fname crop 0 16 load data dcnl dcsp raw c pick types meg true eeg true eog true ecg true stim true misc true dcnl dcsp assert meg snr raw raw c 143 624 dcnl dcsp raw nohpi read raw fif test fif fname preload true dcnl dcsp assert raises runtimeerror filter chpi raw nohpi dcnl dcsp raw read raw fif chpi fif fname allow maxshield yes dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw raw crop 0 1 load data resample 600 0 npad auto dcnl dcsp raw info buffer size sec np float64 2 0 dcnl dcsp raw info lowpass 200 0 dcnl dcsp del raw info maxshield dcnl dcsp del raw info hpi results 0 moments dcnl dcsp del raw info hpi subsystem event channel dcnl dcsp with catch logging as log dcnl dcsp dcsp filter chpi raw verbose true dcnl dcsp assert raises valueerror filter chpi raw t window 1 dcnl dcsp assert true 2 dcsp chpi in log getvalue
testing requires testing data dcnl def test annotations dcsp raw read raw fif fif fname dcnl dcsp onset np array range 10 dcnl dcsp duration np ones 10 dcnl dcsp description np repeat test 10 dcnl dcsp dt datetime utcnow dcnl dcsp meas date raw info meas date dcnl dcsp for orig time in none dt meas date0 meas date dcnl dcsp dcsp annot annotations onset duration description orig time dcnl dcsp assert raises valueerror annotations onset duration description 9 dcnl dcsp assert raises valueerror annotations onset 1 duration description dcnl dcsp assert raises valueerror annotations onset duration 1 description dcnl dcsp raw2 raw copy dcnl dcsp orig time meas date0 + meas date1 1e06 + raw2 first samp raw2 info sfreq dcnl dcsp annot annotations onset duration description orig time dcnl dcsp raw2 annotations annot dcnl dcsp assert array equal raw2 annotations onset onset dcnl dcsp concatenate raws raw raw2 dcnl dcsp raw annotations delete 1 dcnl dcsp assert array almost equal onset + 20 0 raw annotations onset decimal 2 dcnl dcsp assert array equal annot duration raw annotations duration dcnl dcsp assert array equal raw annotations description np repeat test 10 dcnl dcsp data np random randn 2 1000 1e11 dcnl dcsp sfreq 100 0 dcnl dcsp info create info ch names meg1 meg2 ch types grad 2 sfreq sfreq dcnl dcsp info meas date 0 dcnl dcsp raws dcnl dcsp for i fs in enumerate 12300 100 12 dcnl dcsp dcsp raw rawarray data copy info first samp fs dcnl dcsp dcsp ants annotations 1 0 2 0 0 5 0 5 x fs sfreq dcnl dcsp dcsp raw annotations ants dcnl dcsp dcsp raws append raw dcnl dcsp raw rawarray data copy info dcnl dcsp raw annotations annotations 1 0 0 5 x none dcnl dcsp raws append raw dcnl dcsp raw concatenate raws raws dcnl dcsp boundary idx np where raw annotations description bad dcsp boundary 0 dcnl dcsp assert equal len boundary idx 3 dcnl dcsp raw annotations delete boundary idx dcnl dcsp assert array equal raw annotations onset 1 0 2 0 11 0 12 0 21 0 22 0 31 0 dcnl dcsp raw annotations delete 2 dcnl dcsp assert array equal raw annotations onset 1 0 2 0 12 0 21 0 22 0 31 0 dcnl dcsp raw annotations append 5 1 5 y dcnl dcsp assert array equal raw annotations onset 1 0 2 0 12 0 21 0 22 0 31 0 5 dcnl dcsp assert array equal raw annotations duration 0 5 0 5 0 5 0 5 0 5 0 5 1 5 dcnl dcsp assert array equal raw annotations description x x x x x x y dcnl dcsp raw read raw fif fif fname dcnl dcsp last time raw last samp raw info sfreq dcnl dcsp raw2 raw copy dcnl dcsp raw annotations annotations 45 0 3 test raw info meas date dcnl dcsp raw2 annotations annotations 2 0 3 bad none dcnl dcsp raw concatenate raws raw raw2 dcnl dcsp raw annotations delete 1 dcnl dcsp assert array almost equal raw annotations onset 45 0 2 0 + last time decimal 2
testing requires testing data dcnl def test raw reject dcsp info create info a b c d e 100 ch types eeg dcnl dcsp raw rawarray np ones 5 15000 info dcnl dcsp raw annotations annotations 2 100 105 148 2 8 5 8 bad dcnl dcsp data raw get data 0 1 3 4 100 11200 omit dcnl dcsp assert array equal data shape 4 9900 dcnl dcsp raw read raw fif fif fname dcnl dcsp raw annotations annotations 44 47 48 1 3 1 bad raw info meas date dcnl dcsp data times raw get data range 10 0 6000 omit true dcnl dcsp assert array equal data shape 10 4799 dcnl dcsp assert equal times 1 raw times5999 dcnl dcsp assert array equal data 100 raw 10 5900 60000 dcnl dcsp data times raw get data range 10 0 6000 nan true dcnl dcsp assert array equal data shape 10 6000 dcnl dcsp assert equal times 1 raw times5999 dcnl dcsp assert true np isnan data 313 613 all dcnl dcsp assert true not np isnan data 614 any dcnl dcsp assert array equal data 100 raw 10 5900 60000 dcnl dcsp assert array equal raw get data raw 0 dcnl dcsp times 10 88 190 dcnl dcsp onsets sync onset raw times dcnl dcsp assert array almost equal onsets times raw first samp raw info sfreq dcnl dcsp assert array almost equal times sync onset raw onsets true
def test fix stim dcsp raw read raw fif raw fname preload true dcnl dcsp raw dataraw ch names index sti dcsp 014 3 0 32765 0 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp events find events raw sti dcsp 014 dcnl dcsp assert true len w 1 dcnl dcsp assert true any sti016 in str ww message for ww in w dcnl dcsp assert array equal events0 raw first samp + 1 0 32765 dcnl dcsp events find events raw sti dcsp 014 uint cast true dcnl dcsp assert array equal events0 raw first samp + 1 0 32771
def test add events dcsp raw read raw fif raw fname dcnl dcsp events np array raw first samp 0 1 dcnl dcsp assert raises runtimeerror raw add events events sti dcsp 014 dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp orig events find events raw sti dcsp 014 dcnl dcsp events np array raw first samp 0 1 dcnl dcsp assert raises valueerror raw add events events sti dcsp 014 dcnl dcsp events0 raw first samp + raw n times + 1 dcnl dcsp events eventsnp newaxis dcnl dcsp assert raises valueerror raw add events events sti dcsp 014 dcnl dcsp events 0 0 raw first samp 1 dcnl dcsp assert raises valueerror raw add events events sti dcsp 014 dcnl dcsp events 0 0 raw first samp + 1 dcnl dcsp assert raises valueerror raw add events events sti dcsp foo dcnl dcsp raw add events events sti dcsp 014 dcnl dcsp new events find events raw sti dcsp 014 dcnl dcsp assert array equal new events np concatenate events orig events
def test merge events dcsp events orig 1 0 1 3 0 2 10 0 3 20 0 4 dcnl dcsp events replacement 1 0 12 3 0 12 10 0 34 20 0 34 dcnl dcsp events no replacement 1 0 1 1 0 12 1 0 1234 3 0 2 3 0 12 3 0 1234 10 0 3 10 0 34 10 0 1234 20 0 4 20 0 34 20 0 1234 dcnl dcsp for replace events events good in true events replacement false events no replacement dcnl dcsp dcsp events merge events events orig 1 2 12 replace events dcnl dcsp dcsp events merge events events 3 4 34 replace events dcnl dcsp dcsp events merge events events 1 2 3 4 1234 replace events dcnl dcsp dcsp assert array equal events events good
def test io events dcsp tempdir tempdir dcnl dcsp events read events fname dcnl dcsp write events op join tempdir eventseve fif events dcnl dcsp events2 read events op join tempdir eventseve fif dcnl dcsp assert array almost equal events events2 dcnl dcsp events2 read events fname gz dcnl dcsp assert array almost equal events events2 dcnl dcsp write events op join tempdir eventseve fif gz events2 dcnl dcsp events2 read events op join tempdir eventseve fif gz dcnl dcsp assert array almost equal events events2 dcnl dcsp write events op join tempdir events eve events dcnl dcsp events2 read events op join tempdir events eve dcnl dcsp assert array almost equal events events2 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp events2 read events fname txt mpr mask 0 mask type not and dcnl dcsp dcsp assert true sum first dcsp row dcsp of in str ww message for ww in w 1 dcnl dcsp assert array almost equal events events2 dcnl dcsp events2 read events fname old txt dcnl dcsp assert array almost equal events events2 dcnl dcsp write events op join tempdir events eve events dcnl dcsp events2 read events op join tempdir events eve dcnl dcsp assert array almost equal events events2 dcnl dcsp a read events op join tempdir eventseve fif include 1 dcnl dcsp b read events op join tempdir eventseve fif include 1 dcnl dcsp c read events op join tempdir eventseve fif exclude 2 3 4 5 32 dcnl dcsp d read events op join tempdir eventseve fif include 1 exclude 2 3 dcnl dcsp assert array equal a b dcnl dcsp assert array equal a c dcnl dcsp assert array equal a d dcnl dcsp events2 events copy dcnl dcsp events2 1 range events2 shape0 dcnl dcsp write events op join tempdir eventseve fif events2 dcnl dcsp events3 read events op join tempdir eventseve fif mask none dcnl dcsp assert array almost equal events2 events3 dcnl dcsp events read events fname 1 dcnl dcsp write events op join tempdir eventseve fif events dcnl dcsp events2 read events op join tempdir eventseve fif dcnl dcsp assert array almost equal events events2 dcnl dcsp write events op join tempdir events eve events dcnl dcsp events2 read events op join tempdir events eve dcnl dcsp assert array almost equal events events2 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp fname2 op join tempdir testbadname fif dcnl dcsp dcsp write events fname2 events dcnl dcsp dcsp read events fname2 dcnl dcsp assert naming w test event py 2
def test find events dcsp events read events fname dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp extra ends 1 dcnl dcsp orig envs os getenv mne stim channel s s for s in extra ends dcnl dcsp os environ mne stim channel sti dcsp 014 dcnl dcsp if mne stim channel 1 in os environ dcnl dcsp dcsp del os environ mne stim channel 1 dcnl dcsp events2 find events raw dcnl dcsp assert array almost equal events events2 dcnl dcsp events11 find events raw mask 3 mask type not and dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp events22 read events fname mask 3 mask type not and dcnl dcsp dcsp assert true sum events dcsp masked in str ww message for ww in w 1 dcnl dcsp assert array equal events11 events22 dcnl dcsp raw first samps0 0 dcnl dcsp raw info sfreq 1000 dcnl dcsp raw update times dcnl dcsp stim channel sti dcsp 014 dcnl dcsp stim channel idx pick channels raw info ch names include stim channel dcnl dcsp raw datastim channel idx 5 np arange 5 dcnl dcsp raw datastim channel idx 5 0 dcnl dcsp assert raises typeerror find events raw mask 0 mask type and dcnl dcsp assert raises valueerror find events raw mask 0 mask type blah dcnl dcsp assert array equal find events raw shortest event 1 mask 1 mask type not and 2 0 2 4 2 4 dcnl dcsp assert array equal find events raw shortest event 1 mask 2 mask type not and 1 0 1 3 0 1 4 1 4 dcnl dcsp assert array equal find events raw shortest event 1 mask 3 mask type not and 4 0 4 dcnl dcsp assert array equal find events raw shortest event 1 mask 4 mask type not and 1 0 1 2 1 2 3 2 3 dcnl dcsp assert array equal find events raw shortest event 1 mask 1 mask type and 1 0 1 3 0 1 dcnl dcsp assert array equal find events raw shortest event 1 mask 2 mask type and 2 0 2 dcnl dcsp assert array equal find events raw shortest event 1 mask 3 mask type and 1 0 1 2 1 2 3 2 3 dcnl dcsp assert array equal find events raw shortest event 1 mask 4 mask type and 4 0 4 dcnl dcsp raw datastim channel idx 0 dcnl dcsp assert array equal find events raw np empty 0 3 dtype int32 dcnl dcsp raw datastim channel idx 4 1 dcnl dcsp assert array equal find events raw np empty 0 3 dtype int32 dcnl dcsp raw datastim channel idx 1 9 dcnl dcsp assert array equal find events raw 14399 0 9 dcnl dcsp raw datastim channel idx 10 20 5 dcnl dcsp raw datastim channel idx 20 30 6 dcnl dcsp raw datastim channel idx 30 32 5 dcnl dcsp raw data stim channel idx 40 6 dcnl dcsp assert array equal find events raw consecutive false 10 0 5 40 0 6 14399 0 9 dcnl dcsp assert array equal find events raw consecutive true 10 0 5 20 5 6 30 6 5 40 0 6 14399 0 9 dcnl dcsp assert array equal find events raw 10 0 5 20 5 6 40 0 6 14399 0 9 dcnl dcsp assert array equal find events raw output offset consecutive false 31 0 5 40 0 6 14399 0 9 dcnl dcsp assert array equal find events raw output offset consecutive true 19 6 5 29 5 6 31 0 5 40 0 6 14399 0 9 dcnl dcsp assert raises valueerror find events raw output step consecutive true dcnl dcsp assert array equal find events raw output step consecutive true shortest event 1 10 0 5 20 5 6 30 6 5 32 5 0 40 0 6 41 6 0 14399 0 9 14400 9 0 dcnl dcsp assert array equal find events raw output offset 19 6 5 31 0 6 40 0 6 14399 0 9 dcnl dcsp assert array equal find events raw consecutive false min duration 0 002 10 0 5 dcnl dcsp assert array equal find events raw consecutive true min duration 0 002 10 0 5 20 5 6 30 6 5 dcnl dcsp assert array equal find events raw output offset consecutive false min duration 0 002 31 0 5 dcnl dcsp assert array equal find events raw output offset consecutive true min duration 0 002 19 6 5 29 5 6 31 0 5 dcnl dcsp assert array equal find events raw consecutive true min duration 0 003 10 0 5 20 5 6 dcnl dcsp raw datastim channel idx 0 dcnl dcsp raw data stim channel idx 0 1 dcnl dcsp raw data stim channel idx 10 4 dcnl dcsp raw datastim channel idx 11 20 5 dcnl dcsp assert array equal find stim steps raw pad start 0 merge 0 stim channel stim channel 0 0 1 1 1 0 10 0 4 11 4 5 20 5 0 dcnl dcsp assert array equal find stim steps raw merge 1 stim channel stim channel 1 1 0 10 0 5 20 5 0 dcnl dcsp assert array equal find stim steps raw merge 1 stim channel stim channel 1 1 0 11 0 5 20 5 0 dcnl dcsp for s o in zip extra ends orig envs dcnl dcsp dcsp if o is not none dcnl dcsp dcsp dcsp os environ mne stim channel s s o
def test pick events dcsp events np array 1 0 1 2 1 0 3 0 4 4 4 2 5 2 0 dcnl dcsp assert array equal pick events events include 1 4 exclude 4 1 0 1 3 0 4 dcnl dcsp assert array equal pick events events exclude 0 2 1 0 1 3 0 4 dcnl dcsp assert array equal pick events events include 1 2 step true 1 0 1 2 1 0 4 4 2 5 2 0
def test make fixed length events dcsp raw read raw fif raw fname dcnl dcsp events make fixed length events raw id 1 dcnl dcsp assert true events shape1 3 dcnl dcsp events zero make fixed length events raw 1 first samp false dcnl dcsp assert equal events zero 0 0 0 dcnl dcsp assert array equal events zero 0 events 0 raw first samp dcnl dcsp tmin tmax raw times0 1 dcnl dcsp duration tmax tmin dcnl dcsp events make fixed length events raw 1 tmin tmax duration dcnl dcsp assert equal events shape0 1 dcnl dcsp assert raises valueerror make fixed length events raw 1 tmin tmax 0 001 duration dcnl dcsp assert raises valueerror make fixed length events raw 2 3 dcnl dcsp assert raises valueerror make fixed length events not dcsp raw 2 dcnl dcsp assert raises valueerror make fixed length events raw 23 tmin tmax abc
def test define events dcsp events read events fname dcnl dcsp raw read raw fif raw fname dcnl dcsp events define target events events 5 32 raw info sfreq 0 2 0 7 42 99 dcnl dcsp n target events events 2 5 shape0 dcnl dcsp n miss events events 2 99 shape0 dcnl dcsp n target events events 2 42 shape0 dcnl dcsp assert true n target n target n miss dcnl dcsp events np array 0 0 1 375 0 2 500 0 1 875 0 3 1000 0 1 1375 0 3 1100 0 1 1475 0 2 1500 0 1 1875 0 2 dcnl dcsp true lag nofill 1500 0 1500 0 1500 0 dcnl dcsp true lag fill 1500 0 np nan np nan 1500 0 1500 0 dcnl dcsp n lag nofill define target events events 1 2 250 0 1 4 1 6 5 dcnl dcsp n lag fill define target events events 1 2 250 0 1 4 1 6 5 99 dcnl dcsp assert array equal true lag fill lag fill dcnl dcsp assert array equal true lag nofill lag nofill
testing requires testing data dcnl def test acqparser dcsp assert raises valueerror acqparserfif acq pars dcnl dcsp assert raises valueerror acqparserfif acq pars baaa dcnl dcsp assert raises valueerror acqparserfif acq pars erfversion n1 dcnl dcsp raw read raw fif raw fname preload false dcnl dcsp acqp acqparserfif raw info dcnl dcsp assert true repr acqp dcnl dcsp assert true acqp compat dcnl dcsp assert equal len acqp categories 6 dcnl dcsp assert equal len acqp categories 17 dcnl dcsp assert equal len acqp events 6 dcnl dcsp assert equal len acqp events 17 dcnl dcsp assert true acqp surprise dcsp visual dcnl dcsp raw read raw fif fname raw elekta preload false dcnl dcsp acqp raw acqparser dcnl dcsp assert true acqp is raw acqparser dcnl dcsp assert true repr acqp dcnl dcsp assert true not acqp compat dcnl dcsp assert raises keyerror acqp getitem does dcsp not dcsp exist dcnl dcsp assert raises keyerror acqp get condition raw foo dcnl dcsp assert raises valueerror acqp getitem 0 dcnl dcsp assert equal len acqp 7 dcnl dcsp assert equal len acqp categories 7 dcnl dcsp assert equal len acqp categories 32 dcnl dcsp assert equal len acqp events 6 dcnl dcsp assert equal len acqp events 32 dcnl dcsp assert true acqp test dcsp event dcsp 5
testing requires testing data dcnl def test acqparser averaging dcsp raw read raw fif fname raw elekta preload true dcnl dcsp acqp acqparserfif raw info dcnl dcsp for cat in acqp categories dcnl dcsp dcsp cond acqp get condition raw cat dcnl dcsp dcsp eps epochs raw baseline 0 05 0 cond dcnl dcsp dcsp ev eps average dcnl dcsp dcsp ev ref read evokeds fname ave elekta cat comment baseline 0 05 0 proj false dcnl dcsp dcsp ev mag ev copy dcnl dcsp dcsp ev mag pick channels meg0111 dcnl dcsp dcsp ev grad ev copy dcnl dcsp dcsp ev grad pick channels meg2643 meg1622 dcnl dcsp dcsp ev ref mag ev ref copy dcnl dcsp dcsp ev ref mag pick channels meg0111 dcnl dcsp dcsp ev ref grad ev ref copy dcnl dcsp dcsp ev ref grad pick channels meg2643 meg1622 dcnl dcsp dcsp assert allclose ev mag data ev ref mag data rtol 0 atol 1e15 dcnl dcsp dcsp assert allclose ev grad data ev ref grad data rtol 0 atol 1e13
def test helmet dcsp base dir op join op dirname file io dcnl dcsp fname raw op join base dir tests data test raw fif dcnl dcsp fname kit raw op join base dir kit tests data test bin raw fif dcnl dcsp fname bti raw op join base dir bti tests data exported4d linux raw fif dcnl dcsp fname ctf raw op join base dir tests data test ctf raw fif dcnl dcsp fname trans op join base dir tests data sampleaudvisrawtrans txt dcnl dcsp trans get trans fname trans 0 dcnl dcsp for fname in fname raw fname kit raw fname bti raw fname ctf raw dcnl dcsp dcsp helmet get meg helmet surf read info fname trans dcnl dcsp dcsp assert equal len helmet rr 304 dcnl dcsp dcsp assert equal len helmet rr len helmet nn
testing requires testing data dcnl def test head dcsp surf 1 get head surf sample subjects dir subjects dir dcnl dcsp surf 2 get head surf sample head subjects dir subjects dir dcnl dcsp assert true len surf 1 rr < len surf 2 rr dcnl dcsp assert raises typeerror get head surf subject none subjects dir subjects dir
def test huge cross dcsp x rng rand 100000 3 dcnl dcsp y rng rand 1 3 dcnl dcsp z np cross x y dcnl dcsp zz fast cross 3d x y dcnl dcsp assert array equal z zz
def test compute nearest dcsp x rng randn 500 3 dcnl dcsp x np sqrt np sum x 2 axis 1 none dcnl dcsp nn true rng permutation np arange 500 dtype np int 20 dcnl dcsp y xnn true dcnl dcsp nn1 compute nearest x y use balltree false dcnl dcsp nn2 compute nearest x y use balltree true dcnl dcsp assert array equal nn true nn1 dcnl dcsp assert array equal nn true nn2 dcnl dcsp nnn1 compute nearest x y use balltree false return dists true dcnl dcsp nnn2 compute nearest x y use balltree true return dists true dcnl dcsp assert array equal nnn10 nn true dcnl dcsp assert array equal nnn11 np zeros like nn1 dcnl dcsp assert equal len nnn1 len nnn2 dcnl dcsp for nn1 nn2 in zip nnn1 nnn2 dcnl dcsp dcsp assert array equal nn1 nn2
slow test dcnl testing requires testing data dcnl def test make morph maps dcsp tempdir tempdir dcnl dcsp for subject in sample sample ds fsaverage ds dcnl dcsp dcsp os mkdir op join tempdir subject dcnl dcsp dcsp os mkdir op join tempdir subject surf dcnl dcsp dcsp for hemi in lh rh dcnl dcsp dcsp dcsp args subject surf hemi + sphere reg dcnl dcsp dcsp dcsp copyfile op join subjects dir args op join tempdir args dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp mmap read morph map fsaverage ds sample ds tempdir dcnl dcsp mmap2 read morph map fsaverage ds sample ds subjects dir dcnl dcsp assert equal len mmap len mmap2 dcnl dcsp for m1 m2 in zip mmap mmap2 dcnl dcsp dcsp diff m1 m2 data dcnl dcsp dcsp assert allclose diff np zeros like diff atol 0 001 rtol 0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp mmap read morph map sample sample subjects dir tempdir dcnl dcsp for mm in mmap dcnl dcsp dcsp assert true mm sparse eye mm shape0 mm shape0 sum 0
testing requires testing data dcnl def test io surface dcsp tempdir tempdir dcnl dcsp fname quad op join data path subjects bert surf lh inflated nofix dcnl dcsp fname tri op join data path subjects fsaverage surf lh inflated dcnl dcsp for fname in fname quad fname tri dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp pts tri vol info read surface fname read metadata true dcnl dcsp dcsp assert true all no dcsp volume dcsp info in str ww message for ww in w dcnl dcsp dcsp write surface op join tempdir tmp pts tri volume info vol info dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp c pts c tri c vol info read surface op join tempdir tmp read metadata true dcnl dcsp dcsp assert array equal pts c pts dcnl dcsp dcsp assert array equal tri c tri dcnl dcsp dcsp assert equal object diff vol info c vol info
testing requires testing data dcnl def test read curv dcsp fname curv op join data path subjects fsaverage surf lh curv dcnl dcsp fname surf op join data path subjects fsaverage surf lh inflated dcnl dcsp bin curv read curvature fname curv dcnl dcsp rr read surface fname surf 0 dcnl dcsp assert true len bin curv len rr dcnl dcsp assert true np logical or bin curv 0 bin curv 1 all
requires tvtk dcnl requires mayavi dcnl def test decimate surface dcsp points np array 0 00686118 0 1036986 0 0261517 0 00713948 0 10370162 0 02614874 0 00686208 0 10368247 0 02588313 0 00713987 0 10368724 0 02587745 dcnl dcsp tris np array 0 1 2 1 2 3 0 3 1 1 2 0 dcnl dcsp for n tri in 4 3 2 dcnl dcsp dcsp this tris decimate surface points tris n tri dcnl dcsp dcsp assert true len this tris n tri if not n tri 2 else 2 dcnl dcsp nirvana 5 dcnl dcsp tris np array 0 1 2 1 2 3 0 3 1 1 2 nirvana dcnl dcsp assert raises valueerror decimate surface points tris n tri
requires mne dcnl def test mne c design dcsp tempdir tempdir dcnl dcsp temp fname op join tempdir test raw fif dcnl dcsp out fname op join tempdir test c raw fif dcnl dcsp x np zeros 1 10001 dcnl dcsp x 0 5000 1 0 dcnl dcsp time sl slice 5000 4096 5000 + 4097 dcnl dcsp sfreq 1000 0 dcnl dcsp rawarray x create info 1 sfreq eeg save temp fname dcnl dcsp tols dict rtol 0 0001 atol 0 0001 dcnl dcsp cmd mne process raw projoff raw temp fname save out fname dcnl dcsp run subprocess cmd dcnl dcsp h design mne c filter sfreq none 40 dcnl dcsp h c read raw fif out fname 000time sl dcnl dcsp assert allclose h h c tols dcnl dcsp run subprocess cmd + highpass 5 highpassw 2 5 dcnl dcsp h design mne c filter sfreq 5 40 2 5 dcnl dcsp h c read raw fif out fname 000time sl dcnl dcsp assert allclose h h c tols dcnl dcsp run subprocess cmd + lowpass 1000 highpass 10 dcnl dcsp h design mne c filter sfreq 10 none verbose true dcnl dcsp h c read raw fif out fname 000time sl dcnl dcsp assert allclose h h c tols
requires version scipy 0 16 dcnl def test estimate ringing dcsp for kind in ba sos dcnl dcsp dcsp for thresh lims in 0 1 30 60 0 01 300 600 0 001 3000 6000 0 0001 30000 60000 dcnl dcsp dcsp dcsp n ring estimate ringing samples butter 3 thresh output kind dcnl dcsp dcsp dcsp assert true lims0 < n ring < lims1 msg s dcsp s dcsp s dcsp < dcsp s dcsp < dcsp s kind thresh lims0 n ring lims1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp assert equal estimate ringing samples butter 4 1e05 100000 dcnl dcsp assert true any properly dcsp estimate in str ww message for ww in w
def test 1d filter dcsp for n signal in 1 2 3 5 10 20 40 dcnl dcsp dcsp x rng randn n signal dcnl dcsp dcsp for n filter in 1 2 3 5 10 11 20 21 40 41 100 101 dcnl dcsp dcsp dcsp for filter type in identity random dcnl dcsp dcsp dcsp dcsp if filter type random dcnl dcsp dcsp dcsp dcsp dcsp h rng randn n filter dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp h np concatenate 1 0 np zeros n filter 1 dcnl dcsp dcsp dcsp dcsp n pad n filter 1 dcnl dcsp dcsp dcsp dcsp x pad smart pad x np array n pad n pad dcnl dcsp dcsp dcsp dcsp for phase in zero linear zerodouble dcnl dcsp dcsp dcsp dcsp dcsp if phase zero dcnl dcsp dcsp dcsp dcsp dcsp dcsp if n filter 2 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp assert raises runtimeerror overlap add filter xnp newaxis h phase phase dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp dcsp dcsp shift len h 1 2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected np convolve x pad h dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected x expectedshift len x expected shift dcnl dcsp dcsp dcsp dcsp dcsp elif phase zerodouble dcnl dcsp dcsp dcsp dcsp dcsp dcsp shift len h 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected np convolve x pad h dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected np convolve x expected 1 h 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected x expectedshift len x expected shift dcnl dcsp dcsp dcsp dcsp dcsp dcsp shift 0 dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp shift 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected np convolve x pad h dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected x expected len x expected len h + 1 dcnl dcsp dcsp dcsp dcsp dcsp if n pad 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x expected x expectedn pad len x expected n pad dcnl dcsp dcsp dcsp dcsp dcsp assert equal len x expected len x dcnl dcsp dcsp dcsp dcsp dcsp if filter type identity dcnl dcsp dcsp dcsp dcsp dcsp dcsp out x pad copy dcnl dcsp dcsp dcsp dcsp dcsp dcsp out out shift + n pad dcnl dcsp dcsp dcsp dcsp dcsp dcsp out out len x dcnl dcsp dcsp dcsp dcsp dcsp dcsp out np concatenate out np zeros max len x len out 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert equal len out len x dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert allclose out x expected dcnl dcsp dcsp dcsp dcsp dcsp assert equal len x expected len x dcnl dcsp dcsp dcsp dcsp dcsp for n fft in none 32 128 129 1023 1024 1025 2048 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x copy xnp newaxis copy dcnl dcsp dcsp dcsp dcsp dcsp dcsp min fft 2 n filter 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp if phase zerodouble dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp min fft 2 min fft 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp if n fft is not none and n fft < min fft dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp assert raises valueerror overlap add filter x copy h n fft phase phase dcnl dcsp dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp x filtered overlap add filter x copy h n fft phase phase 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp assert allclose x filtered x expected atol 1e13
requires version scipy 0 16 dcnl def test iir stability dcsp sig np empty 1000 dcnl dcsp sfreq 1000 dcnl dcsp assert raises runtimeerror filter data sig sfreq 0 6 none method iir iir params dict ftype butter order 8 output ba dcnl dcsp filter data sig sfreq 0 6 none method iir iir params dict ftype butter order 8 output sos dcnl dcsp assert raises valueerror filter data sig sfreq 0 6 none method iir iir params dict ftype butter order 8 output foo dcnl dcsp assert raises runtimeerror filter data sig sfreq 0 6 none method iir iir params dict order 8 output sos dcnl dcsp assert raises runtimeerror filter data sig sfreq 0 6 none method iir iir params dict order 8 ftype foo output sos dcnl dcsp assert raises runtimeerror filter data sig sfreq 0 6 none method iir iir params dict gpass 0 5 output sos dcnl dcsp assert raises valueerror filter data sig sfreq 0 1 none method fft iir params dict ftype butter order 2 output sos dcnl dcsp assert raises typeerror filter data sig sfreq 0 1 none method 1 dcnl dcsp assert raises valueerror filter data sig sfreq 0 1 none method blah dcnl dcsp assert raises typeerror filter data sig sfreq 0 1 none method iir iir params blah dcnl dcsp assert raises valueerror filter data sig sfreq 0 1 none method fft iir params dict dcnl dcsp iir params dict ftype butter order 2 output sos dcnl dcsp x sos filter data sig 250 0 5 none method iir iir params iir params dcnl dcsp iir params sos construct iir filter iir params f pass 0 5 sfreq 250 btype highpass dcnl dcsp x sos 2 filter data sig 250 0 5 none method iir iir params iir params sos dcnl dcsp assert allclose x sos100 100 x sos 2100 100 dcnl dcsp x ba filter data sig 250 0 5 none method iir iir params dict ftype butter order 2 output ba dcnl dcsp assert allclose x sos100 100 x ba100 100
def test notch filters dcsp sfreq 487 0 dcnl dcsp sig len secs 20 dcnl dcsp t np arange 0 int sig len secs sfreq sfreq dcnl dcsp freqs np arange 60 241 60 dcnl dcsp a rng randn int sig len secs sfreq dcnl dcsp orig power np sqrt np mean a 2 dcnl dcsp a + np sum np sin 2 np pi f t for f in freqs axis 0 dcnl dcsp assert raises valueerror notch filter a sfreq none fft dcnl dcsp assert raises valueerror notch filter a sfreq none iir dcnl dcsp methods spectrum fit spectrum fit fft fft iir dcnl dcsp filter lengths auto auto auto 8192 auto dcnl dcsp line freqs none freqs freqs freqs freqs dcnl dcsp tols 2 1 1 1 dcnl dcsp for meth lf fl tol in zip methods line freqs filter lengths tols dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp b notch filter a sfreq lf fl method meth fir design firwin verbose true dcnl dcsp dcsp if lf is none dcnl dcsp dcsp dcsp out log file getvalue split n 1 dcnl dcsp dcsp dcsp if len out 2 and len out 3 dcnl dcsp dcsp dcsp dcsp raise valueerror detected dcsp frequencies dcsp not dcsp logged dcsp properly dcnl dcsp dcsp dcsp out np fromstring out 1 sep dcsp dcnl dcsp dcsp dcsp assert array almost equal out freqs dcnl dcsp dcsp new power np sqrt sum squared b b size dcnl dcsp dcsp assert almost equal new power orig power tol
def test resample dcsp x rng normal 0 1 10 10 10 dcnl dcsp x rs resample x 1 2 10 dcnl dcsp assert equal x shape 10 10 10 dcnl dcsp assert equal x rs shape 10 10 5 dcnl dcsp x 2 x swapaxes 0 1 dcnl dcsp x 2 rs resample x 2 1 2 10 dcnl dcsp assert array equal x 2 rs swapaxes 0 1 x rs dcnl dcsp x 3 x swapaxes 0 2 dcnl dcsp x 3 rs resample x 3 1 2 10 0 dcnl dcsp assert array equal x 3 rs swapaxes 0 2 x rs dcnl dcsp assert array equal resample 0 0 2 1 0 0 0 0 0 0 0 0
def test resample stim channel dcsp assert array equal resample stim channels 1 0 0 0 2 0 0 0 1 2 1 0 2 0 dcnl dcsp assert array equal resample stim channels 1 0 0 0 2 0 0 0 1 1 5 1 0 0 2 0 dcnl dcsp assert array equal resample stim channels 1 0 0 1 2 0 0 1 1 2 1 1 2 1 dcnl dcsp assert array equal resample stim channels 1 2 3 2 1 1 1 2 2 3 3 dcnl dcsp assert array equal resample stim channels 1 2 3 2 5 1 1 1 1 2 2 3 3 3 dcnl dcsp data chunk np zeros 1 315600 dcnl dcsp for new data len in 52598 52599 52600 52601 315599 315600 dcnl dcsp dcsp new data resample stim channels data chunk new data len data chunk shape1 dcnl dcsp dcsp assert equal new data shape1 new data len
requires version scipy 0 16 dcnl slow test dcnl def test filters dcsp sfreq 100 dcnl dcsp sig len secs 15 dcnl dcsp a rng randn 2 sig len secs sfreq dcnl dcsp for fl in blah 0 1 1000 5 10ss 10 dcnl dcsp dcsp assert raises valueerror filter data a sfreq 4 8 none fl 1 0 1 0 fir design firwin dcnl dcsp for nj in blah 0 5 dcnl dcsp dcsp assert raises valueerror filter data a sfreq 4 8 none 1000 1 0 1 0 n jobs nj phase zero fir design firwin dcnl dcsp assert raises valueerror filter data a sfreq 4 8 none 100 1 0 1 0 fir window foo dcnl dcsp assert raises valueerror filter data a sfreq 4 8 none 10 1 0 1 0 fir design firwin dcnl dcsp assert raises valueerror filter data a sfreq 4 sfreq 2 0 none 100 1 0 1 0 fir design firwin dcnl dcsp assert raises valueerror filter data a sfreq 1 none none 100 1 0 1 0 fir design firwin dcnl dcsp create filter a sfreq none none fir design firwin dcnl dcsp create filter a sfreq none none method iir dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp filter data a sfreq 1 8 filter length 256 fir design firwin2 dcnl dcsp assert true any attenuation in str ww message for ww in w dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp filter data a sfreq 1 8 filter length 0 5s fir design firwin2 dcnl dcsp assert true any increase dcsp filter length in str ww message for ww in w dcnl dcsp freqs fftfreq a shape 1 1 0 sfreq dcnl dcsp a np abs fft a dcnl dcsp kwargs dict fir design firwin dcnl dcsp for fl in auto 10s 5000ms 1024 1023 dcnl dcsp dcsp bp filter data a sfreq 4 8 none fl 1 0 1 0 kwargs dcnl dcsp dcsp bs filter data a sfreq 8 + 1 0 4 1 0 none fl 1 0 1 0 kwargs dcnl dcsp dcsp lp filter data a sfreq none 8 none fl 10 1 0 n jobs 2 kwargs dcnl dcsp dcsp hp filter data lp sfreq 4 none none fl 1 0 10 kwargs dcnl dcsp dcsp assert allclose hp bp rtol 0 001 atol 0 001 dcnl dcsp dcsp assert allclose bp + bs a rtol 0 001 atol 0 001 dcnl dcsp dcsp mask freqs 5 5 freqs < 6 5 dcnl dcsp dcsp assert allclose np mean np abs fft bp mask a mask 1 0 atol 0 02 dcnl dcsp dcsp assert allclose np mean np abs fft bs mask a mask 0 0 atol 0 2 dcnl dcsp dcsp bp filter data a sfreq 4 8 none fl 1 0 1 0 phase minimum kwargs dcnl dcsp dcsp bs filter data a sfreq 8 + 1 0 4 1 0 none fl 1 0 1 0 phase minimum kwargs dcnl dcsp dcsp assert allclose np mean np abs fft bp mask a mask 1 0 atol 0 11 dcnl dcsp dcsp assert allclose np mean np abs fft bs mask a mask 0 0 atol 0 3 dcnl dcsp n resamp ignore 10 dcnl dcsp bp up dn resample resample bp 2 1 n jobs 2 1 2 n jobs 2 dcnl dcsp assert array almost equal bpn resamp ignore n resamp ignore bp up dnn resamp ignore n resamp ignore 2 dcnl dcsp bp up dn resample resample bp 2 1 n jobs cuda 1 2 n jobs cuda dcnl dcsp assert array almost equal bpn resamp ignore n resamp ignore bp up dnn resamp ignore n resamp ignore 2 dcnl dcsp bp up dn sp resample sp resample bp 2 bp shape 1 axis 1 window boxcar bp shape 1 window boxcar axis 1 dcnl dcsp assert array almost equal bpn resamp ignore n resamp ignore bp up dnn resamp ignore n resamp ignore 2 dcnl dcsp t np array list range sfreq sig len secs float sfreq dcnl dcsp sig np sin 2 np pi sfreq 2 2 t dcnl dcsp sig gone resample sig 1 2 n resamp ignore n resamp ignore dcnl dcsp assert array almost equal np zeros like sig gone sig gone 2 dcnl dcsp iir params dict ftype cheby1 gpass 1 gstop 20 output ba dcnl dcsp iir params construct iir filter iir params 40 80 1000 low dcnl dcsp assert equal iir params a size 1 3 dcnl dcsp assert equal iir params b size 1 3 dcnl dcsp iir params dict ftype butter order 4 output ba dcnl dcsp iir params construct iir filter iir params 40 none 1000 low dcnl dcsp assert equal iir params a size 1 4 dcnl dcsp assert equal iir params b size 1 4 dcnl dcsp iir params dict ftype cheby1 gpass 1 gstop 20 output sos dcnl dcsp iir params construct iir filter iir params 40 80 1000 low dcnl dcsp assert equal iir params sos shape 2 6 dcnl dcsp iir params dict ftype butter order 4 output sos dcnl dcsp iir params construct iir filter iir params 40 none 1000 low dcnl dcsp assert equal iir params sos shape 2 6 dcnl dcsp a rng randn 5 sfreq 5 sfreq dcnl dcsp b a none dcnl dcsp a filt filter data a sfreq 4 8 none 400 2 0 2 0 fir design firwin dcnl dcsp b filt filter data b sfreq 4 8 0 400 2 0 2 0 fir design firwin dcnl dcsp assert array equal a filt none b filt dcnl dcsp a rng randn 2 2 2 2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror filter data a sfreq 4 8 np array 0 1 100 1 0 1 0
def test filter auto dcsp n 300 dcnl dcsp sfreq 100 0 dcnl dcsp lp 10 0 dcnl dcsp sine freq 1 0 dcnl dcsp x np ones n dcnl dcsp t np arange n sfreq dcnl dcsp x + np sin 2 np pi sine freq t dcnl dcsp x orig x copy dcnl dcsp for fir design in firwin2 firwin dcnl dcsp dcsp kwargs dict fir design fir design dcnl dcsp dcsp x x orig copy dcnl dcsp dcsp x filt filter data x sfreq none lp kwargs dcnl dcsp dcsp assert array equal x x orig dcnl dcsp dcsp assert allclose x x filt rtol 0 0001 atol 0 01 dcnl dcsp dcsp assert array equal x filt filter data x sfreq none lp none kwargs dcnl dcsp dcsp assert array equal x x orig dcnl dcsp dcsp assert array equal x filt filter data x sfreq none lp kwargs dcnl dcsp dcsp assert array equal x x orig dcnl dcsp dcsp assert array equal x filt filter data x sfreq none lp copy false kwargs dcnl dcsp dcsp assert array equal x x filt dcnl dcsp assert raises valueerror filter data x sfreq 1 10 dcnl dcsp assert raises valueerror filter data x sfreq 1 sfreq 0 75 dcnl dcsp assert raises typeerror filter data x astype np float32 sfreq none 10 filter length auto h trans bandwidth auto kwargs
def test cuda dcsp sfreq 500 dcnl dcsp sig len secs 20 dcnl dcsp a rng randn sig len secs sfreq dcnl dcsp kwargs dict fir design firwin dcnl dcsp with catch logging as log file dcnl dcsp dcsp for fl in auto 10s 2048 dcnl dcsp dcsp dcsp args a sfreq 4 8 none fl 1 0 1 0 dcnl dcsp dcsp dcsp bp filter data args kwargs dcnl dcsp dcsp dcsp bp c filter data n jobs cuda verbose info args kwargs dcnl dcsp dcsp dcsp assert array almost equal bp bp c 12 dcnl dcsp dcsp dcsp args a sfreq 8 + 1 0 4 1 0 none fl 1 0 1 0 dcnl dcsp dcsp dcsp bs filter data args kwargs dcnl dcsp dcsp dcsp bs c filter data n jobs cuda verbose info args kwargs dcnl dcsp dcsp dcsp assert array almost equal bs bs c 12 dcnl dcsp dcsp dcsp args a sfreq none 8 none fl 1 0 dcnl dcsp dcsp dcsp lp filter data args kwargs dcnl dcsp dcsp dcsp lp c filter data n jobs cuda verbose info args kwargs dcnl dcsp dcsp dcsp assert array almost equal lp lp c 12 dcnl dcsp dcsp dcsp args lp sfreq 4 none none fl 1 0 dcnl dcsp dcsp dcsp hp filter data args kwargs dcnl dcsp dcsp dcsp hp c filter data n jobs cuda verbose info args kwargs dcnl dcsp dcsp dcsp assert array almost equal hp hp c 12 dcnl dcsp out log file getvalue split n 1 dcnl dcsp from mne cuda import cuda capable dcnl dcsp tot 12 if cuda capable else 0 dcnl dcsp assert true sum using dcsp cuda dcsp for dcsp fft dcsp fir dcsp filtering in o for o in out tot dcnl dcsp for window in boxcar triang dcnl dcsp dcsp for n in 997 1000 dcnl dcsp dcsp dcsp a rng randn 2 n dcnl dcsp dcsp dcsp for fro to in 1 2 2 1 1 3 3 1 dcnl dcsp dcsp dcsp dcsp a1 resample a fro to n jobs 1 npad auto window window dcnl dcsp dcsp dcsp dcsp a2 resample a fro to n jobs cuda npad auto window window dcnl dcsp dcsp dcsp dcsp assert allclose a1 a2 rtol 1e07 atol 1e14 dcnl dcsp assert array almost equal a1 a2 14 dcnl dcsp assert array equal resample 0 0 2 1 n jobs cuda 0 0 0 0 0 0 0 0 dcnl dcsp assert array equal resample np zeros 2 np float32 2 1 n jobs cuda 0 0 0 0 0 0 0 0
def test detrend dcsp x np arange 10 dcnl dcsp assert array almost equal detrend x 1 np zeros like x dcnl dcsp x np ones 10 dcnl dcsp assert array almost equal detrend x 0 np zeros like x
def test interp2 dcsp interp interp2 zero dcnl dcsp x np ones 1 100 dcnl dcsp interp y np array 10 0 dcnl dcsp interp y np array 10 dcnl dcsp interp n samp 100 dcnl dcsp out np zeros like x dcnl dcsp interp interpolate y x out dcnl dcsp expected 10 x dcnl dcsp assert allclose out expected atol 1e07 dcnl dcsp interp interp linear dcnl dcsp out fill 0 0 dcnl dcsp interp interpolate y x out dcnl dcsp expected np linspace 10 10 100 endpoint false np newaxis dcnl dcsp assert allclose out expected atol 1e07
def compare dipoles orig new dcsp assert allclose orig times new times atol 0 001 err msg times dcnl dcsp assert allclose orig pos new pos err msg pos dcnl dcsp assert allclose orig amplitude new amplitude err msg amplitude dcnl dcsp assert allclose orig gof new gof err msg gof dcnl dcsp assert allclose orig ori new ori rtol 0 0001 atol 0 0001 err msg ori dcnl dcsp assert equal orig name new name
def check dipole dip n dipoles dcsp assert equal len dip n dipoles dcnl dcsp assert equal dip pos shape n dipoles 3 dcnl dcsp assert equal dip ori shape n dipoles 3 dcnl dcsp assert equal dip gof shape n dipoles dcnl dcsp assert equal dip amplitude shape n dipoles
testing requires testing data dcnl def test io dipoles dcsp tempdir tempdir dcnl dcsp dipole read dipole fname dip dcnl dcsp print dipole dcnl dcsp out fname op join tempdir temp dip dcnl dcsp dipole save out fname dcnl dcsp dipole new read dipole out fname dcnl dcsp compare dipoles dipole dipole new
testing requires testing data dcnl def test dipole fitting ctf dcsp raw ctf read raw ctf fname ctf set eeg reference projection true dcnl dcsp events make fixed length events raw ctf 1 dcnl dcsp evoked epochs raw ctf events 1 0 0 baseline none average dcnl dcsp cov make ad hoc cov evoked info dcnl dcsp sphere make sphere model 0 0 0 0 0 0 dcnl dcsp fit dipole evoked cov sphere
slow test dcnl testing requires testing data dcnl requires mne dcnl def test dipole fitting dcsp amp 1e07 dcnl dcsp tempdir tempdir dcnl dcsp rng np random randomstate 0 dcnl dcsp fname dtemp op join tempdir test dip dcnl dcsp fname sim op join tempdir testave fif dcnl dcsp fwd convert forward solution read forward solution fname fwd surf ori false force fixed true dcnl dcsp evoked read evokeds fname evo 0 dcnl dcsp cov read cov fname cov dcnl dcsp n per hemi 5 dcnl dcsp vertices np sort rng permutation s vertno n per hemi for s in fwd src dcnl dcsp nv sum len v for v in vertices dcnl dcsp stc sourceestimate amp np eye nv vertices 0 0 001 dcnl dcsp evoked simulate evoked fwd stc evoked info cov nave evoked nave random state rng dcnl dcsp picks np sort np concatenate pick types evoked info meg true eeg false 2 pick types evoked info meg false eeg true 2 dcnl dcsp evoked pick channels evoked ch namesp for p in picks dcnl dcsp evoked add proj make eeg average ref proj evoked info dcnl dcsp write evokeds fname sim evoked dcnl dcsp run subprocess mne dipole fit meas fname sim meg eeg noise fname cov dip fname dtemp mri fname fwd reg 0 tmin 0 dcnl dcsp dip c read dipole fname dtemp dcnl dcsp sphere make sphere model head radius 0 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp dip residuals fit dipole evoked cov sphere fname fwd dcnl dcsp data rms np sqrt np sum evoked data 2 axis 0 dcnl dcsp resi rms np sqrt np sum residuals 2 axis 0 dcnl dcsp assert true data rms resi rms 0 95 all msg s dcsp factor dcsp s data rms resi rms min 0 95 dcnl dcsp transform surface to fwd src 0 head fwd mri head t dcnl dcsp transform surface to fwd src 1 head fwd mri head t dcnl dcsp assert equal fwd src 0 coord frame fiff fiffv coord head dcnl dcsp src rr np concatenate s rr v for s v in zip fwd src vertices axis 0 dcnl dcsp src nn np concatenate s nn v for s v in zip fwd src vertices axis 0 dcnl dcsp out dip crop dip c times0 dip c times 1 dcnl dcsp assert true dip is out dcnl dcsp src rr src nn src rr 1 src nn 1 dcnl dcsp corrs dists gc dists amp errs gofs dcnl dcsp for d in dip c dip dcnl dcsp dcsp new d pos dcnl dcsp dcsp diffs new src rr dcnl dcsp dcsp corrs + np corrcoef src rr ravel new ravel 0 1 dcnl dcsp dcsp dists + np sqrt np mean np sum diffs diffs axis 1 dcnl dcsp dcsp gc dists + 180 np pi np mean np arccos np sum src nn d ori axis 1 dcnl dcsp dcsp amp errs + np sqrt np mean amp d amplitude 2 dcnl dcsp dcsp gofs + np mean d gof dcnl dcsp factor 0 8 dcnl dcsp assert true dists0 factor dists1 dists dcsp s dists dcnl dcsp assert true corrs0 factor < corrs1 corrs dcsp s corrs dcnl dcsp assert true gc dists0 factor gc dists1 0 8 gcdists dcsp ori dcsp s gc dists dcnl dcsp assert true amp errs0 factor amp errs1 amplitude dcsp errors dcsp s amp errs dcnl dcsp assert true gofs0 factor < gofs1 2 gof dcsp s gofs
testing requires testing data dcnl def test dipole fitting fixed dcsp tpeak 0 073 dcnl dcsp sphere make sphere model head radius 0 1 dcnl dcsp evoked read evokeds fname evo baseline none 0 0 dcnl dcsp evoked pick types meg true dcnl dcsp t idx np argmin np abs tpeak evoked times dcnl dcsp evoked crop evoked copy crop tpeak tpeak dcnl dcsp assert equal len evoked crop times 1 dcnl dcsp cov read cov fname cov dcnl dcsp dip seq resid fit dipole evoked crop cov sphere dcnl dcsp assert true isinstance dip seq dipole dcnl dcsp assert equal len dip seq times 1 dcnl dcsp pos ori gof dip seq pos0 dip seq ori0 dip seq gof0 dcnl dcsp amp dip seq amplitude0 dcnl dcsp dip free resid free fit dipole evoked cov sphere pos pos dcnl dcsp assert true isinstance dip free dipole dcnl dcsp assert allclose dip free times evoked times dcnl dcsp assert allclose np tile posnp newaxis len evoked times 1 dip free pos dcnl dcsp assert allclose ori dip free orit idx dcnl dcsp assert true np dot dip free ori ori mean < 0 9 dcnl dcsp assert allclose gof dip free goft idx dcnl dcsp assert allclose amp dip free amplitudet idx dcnl dcsp assert allclose resid resid free t idx dcnl dcsp dip fixed resid fixed fit dipole evoked cov sphere pos pos ori ori dcnl dcsp assert true isinstance dip fixed dipolefixed dcnl dcsp assert allclose dip fixed times evoked times dcnl dcsp assert allclose dip fixed info chs 0 loc 3 pos dcnl dcsp assert allclose dip fixed info chs 0 loc 3 6 ori dcnl dcsp assert allclose dip fixed data 1 t idx gof dcnl dcsp assert allclose resid resid fixed t idx dcnl dcsp check roundtrip fixed dip fixed dcnl dcsp evoked nan evoked copy crop 0 0 dcnl dcsp evoked nan data 0 0 none dcnl dcsp assert raises valueerror fit dipole evoked nan cov sphere dcnl dcsp assert raises valueerror fit dipole evoked cov sphere ori 1 0 0 dcnl dcsp assert raises valueerror fit dipole evoked cov sphere pos 0 0 0 ori 2 0 0 dcnl dcsp assert raises valueerror fit dipole evoked cov sphere pos 0 1 0 0
testing requires testing data dcnl def test len index dipoles dcsp dipole read dipole fname dip dcnl dcsp d0 dipole0 dcnl dcsp d1 dipole 1 dcnl dcsp check dipole d0 1 dcnl dcsp check dipole d1 1 dcnl dcsp compare dipoles d0 d1 dcnl dcsp mask dipole gof 15 dcnl dcsp idx np where mask 0 dcnl dcsp d mask dipolemask dcnl dcsp check dipole d mask 4 dcnl dcsp compare dipoles d mask dipoleidx
testing requires testing data dcnl def test min distance fit dipole dcsp subject sample dcnl dcsp raw read raw fif fname raw preload true dcnl dcsp picks pick types raw info meg false eeg true exclude bads dcnl dcsp info pick info raw info picks dcnl dcsp cov read cov fname cov dcnl dcsp cov data np eye cov data shape0 dcnl dcsp simulated scalp map np zeros picks shape0 dcnl dcsp simulated scalp map27 34 1 dcnl dcsp simulated scalp map simulated scalp map none dcnl dcsp evoked evokedarray simulated scalp map info tmin 0 dcnl dcsp min dist 5 0 dcnl dcsp bem read bem solution fname bem dcnl dcsp dip residual fit dipole evoked cov bem fname trans min dist min dist dcnl dcsp dist compute depth dip fname bem fname trans subject subjects dir dcnl dcsp assert true min dist 0 1 < dist0 1000 0 < min dist + 1 0 dcnl dcsp assert raises valueerror fit dipole evoked cov fname bem fname trans 1 0
def compute depth dip fname bem fname trans subject subjects dir dcsp trans get trans fname trans 0 dcnl dcsp bem read bem solution fname bem dcnl dcsp surf bem find surface bem inner skull dcnl dcsp points surf rr dcnl dcsp points apply trans trans trans points dcnl dcsp depth compute nearest points dip pos return dists true 10 dcnl dcsp return np ravel depth
testing requires testing data dcnl def test accuracy dcsp evoked read evokeds fname evo 0 crop 0 0 0 0 dcnl dcsp evoked pick types meg true eeg false dcnl dcsp evoked pick channels c for c in evoked ch names 4 dcnl dcsp for rad perc 90 in zip 0 09 none 0 002 0 004 dcnl dcsp dcsp bem make sphere model auto rad evoked info relative radii 0 999 0 998 0 997 0 995 dcnl dcsp dcsp src read source spaces fname src dcnl dcsp dcsp fwd make forward solution evoked info none src bem dcnl dcsp dcsp fwd convert forward solution fwd force fixed true dcnl dcsp dcsp vertices src0 vertno src1 vertno dcnl dcsp dcsp n vertices sum len v for v in vertices dcnl dcsp dcsp amp 1e08 dcnl dcsp dcsp data np eye n vertices + 1 n vertices dcnl dcsp dcsp data 1 1 1 0 dcnl dcsp dcsp data amp dcnl dcsp dcsp stc sourceestimate data vertices 0 0 0 001 sample dcnl dcsp dcsp evoked info normalize proj dcnl dcsp dcsp sim simulate evoked fwd stc evoked info cov none nave np inf dcnl dcsp dcsp cov make ad hoc cov evoked info dcnl dcsp dcsp dip fit dipole sim cov bem min dist 0 001 0 dcnl dcsp dcsp ds dcnl dcsp dcsp for vi in range n vertices dcnl dcsp dcsp dcsp if vi < len vertices0 dcnl dcsp dcsp dcsp dcsp hi 0 dcnl dcsp dcsp dcsp dcsp vertno vi dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp hi 1 dcnl dcsp dcsp dcsp dcsp vertno vi len vertices0 dcnl dcsp dcsp dcsp vertno srchi vertno vertno dcnl dcsp dcsp dcsp rr srchi rr vertno dcnl dcsp dcsp dcsp d np sqrt np sum rr dip posvi 2 dcnl dcsp dcsp dcsp ds append d dcnl dcsp dcsp assert true np percentile ds 50 90 < 0 0005 perc 90 all
testing requires testing data dcnl def test dipole fixed dcsp dip read dipole fname xfit dip dcnl dcsp print dip dcnl dcsp check roundtrip fixed dip dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dip txt read dipole fname xfit dip txt dcnl dcsp assert true any extra dcsp fields in str ww message for ww in w dcnl dcsp assert allclose dip info chs 0 loc 3 dip txt pos0 dcnl dcsp assert allclose dip txt amplitude0 1 21e08 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp dip txt seq read dipole fname xfit seq txt dcnl dcsp assert allclose dip txt seq gof 27 3 46 4 43 7 41 0 37 3 32 5
def check roundtrip fixed dip dcsp tempdir tempdir dcnl dcsp dip save op join tempdir testdip fif gz dcnl dcsp dip read read dipole op join tempdir testdip fif gz dcnl dcsp assert allclose dip read data dip read data dcnl dcsp assert allclose dip read times dip times dcnl dcsp assert equal dip read info xplotter layout dip info xplotter layout dcnl dcsp assert equal dip read ch names dip ch names dcnl dcsp for ch 1 ch 2 in zip dip read info chs dip info chs dcnl dcsp dcsp assert equal ch 1 ch name ch 2 ch name dcnl dcsp dcsp for key in loc kind unit mul range coord frame unit cal coil type scanno logno dcnl dcsp dcsp dcsp assert allclose ch 1key ch 2key err msg key
def test get phantom dipoles dcsp assert raises valueerror get phantom dipoles 0 dcnl dcsp assert raises valueerror get phantom dipoles foo dcnl dcsp for kind in vectorview otaniemi dcnl dcsp dcsp pos ori get phantom dipoles kind dcnl dcsp dcsp assert equal pos shape 32 3 dcnl dcsp dcsp assert equal ori shape 32 3
testing requires testing data dcnl def test confidence dcsp tempdir tempdir dcnl dcsp evoked read evokeds fname evo full left dcsp auditory baseline none 0 dcnl dcsp evoked crop 0 08 0 08 pick types dcnl dcsp cov make ad hoc cov evoked info dcnl dcsp sphere make sphere model 0 0 0 0 0 04 0 08 dcnl dcsp dip py fit dipole evoked cov sphere 0 dcnl dcsp fname test op join tempdir tempdip txt dcnl dcsp dip py save fname test dcnl dcsp dip read read dipole fname test dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dip xfit read dipole fname dip xfit dcnl dcsp assert equal len w 1 dcnl dcsp assert true noise ft cm dcsp prob in str w0 message dcnl dcsp for dip check in dip py dip read dcnl dcsp dcsp assert allclose dip check pos dip xfit pos atol 0 0005 dcnl dcsp dcsp assert allclose dip check gof dip xfit gof atol 0 5 dcnl dcsp dcsp assert array equal dip check nfree dip xfit nfree dcnl dcsp dcsp assert allclose dip check khi2 dip xfit khi2 rtol 0 02 dcnl dcsp dcsp assert equal set dip check conf keys set dip xfit conf keys dcnl dcsp dcsp for key in sorted dip check conf keys dcnl dcsp dcsp dcsp assert allclose dip check confkey dip xfit confkey rtol 0 15 err msg key
requires version scipy 0 11 dcnl def test module nesting dcsp proc popen sys executable c run script stdout pipe stderr pipe dcnl dcsp stdout stderr proc communicate dcnl dcsp if proc returncode dcnl dcsp dcsp raise assertionerror stdout
def test parse ave dcsp conditions parse config ave fname dcnl dcsp assert true len conditions 4
def check parameters match func doc none dcsp from numpydoc import docscrape dcnl dcsp incorrect dcnl dcsp name get name func dcnl dcsp if not name startswith mne or name startswith mne externals dcnl dcsp dcsp return incorrect dcnl dcsp if inspect isdatadescriptor func dcnl dcsp dcsp return incorrect dcnl dcsp args get args func dcnl dcsp if len args 0 and args0 self dcnl dcsp dcsp args args1 dcnl dcsp if doc is none dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp doc docscrape functiondoc func dcnl dcsp dcsp dcsp except exception as exp dcnl dcsp dcsp dcsp dcsp incorrect + name + dcsp parsing dcsp error dcsp + str exp dcnl dcsp dcsp dcsp dcsp return incorrect dcnl dcsp dcsp if len w dcnl dcsp dcsp dcsp raise runtimeerror error dcsp for dcsp s n s name w0 dcnl dcsp param names name for name in doc parameters dcnl dcsp param names name split 0 strip dcsp for name in param names dcnl dcsp param names name for name in param names if not in name dcnl dcsp if len param names len args dcnl dcsp dcsp bad str sorted list set param names set args + list set args set param names dcnl dcsp dcsp if not any d in name for d in docstring ignores and deprecation wrapped not in func code co name dcnl dcsp dcsp dcsp incorrect + name + dcsp arg dcsp mismatch dcsp + bad dcnl dcsp else dcnl dcsp dcsp for n1 n2 in zip param names args dcnl dcsp dcsp dcsp if n1 n2 dcnl dcsp dcsp dcsp dcsp incorrect + name + dcsp + n1 + dcsp dcsp + n2 dcnl dcsp return incorrect
requires numpydoc dcnl def test docstring parameters dcsp from numpydoc import docscrape dcnl dcsp public modules public modules dcnl dcsp try dcnl dcsp dcsp import mayavi dcnl dcsp dcsp public modules append mne gui dcnl dcsp except importerror dcnl dcsp dcsp pass dcnl dcsp incorrect dcnl dcsp for name in public modules dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp module import name globals dcnl dcsp dcsp for submod in name split 1 dcnl dcsp dcsp dcsp module getattr module submod dcnl dcsp dcsp classes inspect getmembers module inspect isclass dcnl dcsp dcsp for cname cls in classes dcnl dcsp dcsp dcsp if cname startswith and cname not in doc special members dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp dcsp cdoc docscrape classdoc cls dcnl dcsp dcsp dcsp if len w dcnl dcsp dcsp dcsp dcsp raise runtimeerror error dcsp for dcsp init dcsp of dcsp s dcsp in dcsp s n s cls name w0 dcnl dcsp dcsp dcsp if hasattr cls init dcnl dcsp dcsp dcsp dcsp incorrect + check parameters match cls init cdoc dcnl dcsp dcsp dcsp for method name in cdoc methods dcnl dcsp dcsp dcsp dcsp method getattr cls method name dcnl dcsp dcsp dcsp dcsp incorrect + check parameters match method dcnl dcsp dcsp dcsp if hasattr cls call dcnl dcsp dcsp dcsp dcsp incorrect + check parameters match cls call dcnl dcsp dcsp functions inspect getmembers module inspect isfunction dcnl dcsp dcsp for fname func in functions dcnl dcsp dcsp dcsp if fname startswith dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp incorrect + check parameters match func dcnl dcsp msg n + n join sorted list set incorrect dcnl dcsp if len incorrect 0 dcnl dcsp dcsp raise assertionerror msg
def test tabs dcsp ignore tab ignores dcnl dcsp try dcnl dcsp dcsp import mayavi dcnl dcsp except importerror dcnl dcsp dcsp ignore extend mne gui + name for name in coreg gui fiducials gui file traits help kit2fiff gui marker gui viewer dcnl dcsp for importer modname ispkg in walk packages mne path prefix mne dcnl dcsp dcsp if not ispkg and modname not in ignore dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp dcsp import modname dcnl dcsp dcsp dcsp except exception dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp mod sys modulesmodname dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp source getsource mod dcnl dcsp dcsp dcsp except ioerror dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp assert true dctb not in source s dcsp has dcsp tabs dcsp please dcsp remove dcsp them dcsp or dcsp add dcsp it dcsp to dcsp theignore dcsp list modname
def test documented dcsp public modules public modules dcnl dcsp try dcnl dcsp dcsp import mayavi dcnl dcsp dcsp public modules append mne gui dcnl dcsp except importerror dcnl dcsp dcsp pass dcnl dcsp doc file op abspath op join op dirname file doc python reference rst dcnl dcsp if not op isfile doc file dcnl dcsp dcsp raise skiptest documentation dcsp file dcsp not dcsp found dcsp s doc file dcnl dcsp known names list dcnl dcsp with open doc file rb as fid dcnl dcsp dcsp for line in fid dcnl dcsp dcsp dcsp line line decode utf8 dcnl dcsp dcsp dcsp if not line startswith dcsp dcsp dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp line line split dcnl dcsp dcsp dcsp if len line 1 and line0 dcnl dcsp dcsp dcsp dcsp known names append line0 split 1 dcnl dcsp known names set known names dcnl dcsp missing dcnl dcsp for name in public modules dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp module import name globals dcnl dcsp dcsp for submod in name split 1 dcnl dcsp dcsp dcsp module getattr module submod dcnl dcsp dcsp classes inspect getmembers module inspect isclass dcnl dcsp dcsp functions inspect getmembers module inspect isfunction dcnl dcsp dcsp checks list classes + list functions dcnl dcsp dcsp for name cf in checks dcnl dcsp dcsp dcsp if not name startswith and name not in known names dcnl dcsp dcsp dcsp dcsp from mod inspect getmodule cf name dcnl dcsp dcsp dcsp dcsp if from mod startswith mne and not from mod startswith mne externals and from mod not in documented ignored mods and name not in documented ignored names dcnl dcsp dcsp dcsp dcsp dcsp missing append s dcsp s s name from mod name dcnl dcsp if len missing 0 dcnl dcsp dcsp raise assertionerror n nfound dcsp new dcsp public dcsp members dcsp missing dcsp from dcsp doc python reference rst n n dcsp + n dcsp join sorted set missing
def get data x ch idx dcsp if isinstance x baseraw dcnl dcsp dcsp return xch idx0 dcnl dcsp elif isinstance x evoked dcnl dcsp dcsp return x datach idx
def check snr actual desired picks min tol med tol msg kind meg dcsp from nose tools import assert true dcnl dcsp actual data get data actual picks dcnl dcsp desired data get data desired picks dcnl dcsp bench rms np sqrt np mean desired data desired data axis 1 dcnl dcsp error actual data desired data dcnl dcsp error rms np sqrt np mean error error axis 1 dcnl dcsp np clip error rms 1e60 np inf out error rms dcnl dcsp snrs bench rms error rms dcnl dcsp snr snrs min dcnl dcsp bad count snrs < min tol sum dcnl dcsp msg dcsp s msg if msg else msg dcnl dcsp assert true bad count 0 snr dcsp worst dcsp 0 2f dcsp < dcsp 0 2f dcsp for dcsp s s dcsp channels s snr min tol bad count len picks msg dcnl dcsp snr np median snrs dcnl dcsp assert true snr med tol s dcsp snr dcsp median dcsp 0 2f dcsp < dcsp 0 2f s kind snr med tol msg
def assert meg snr actual desired min tol med tol 500 0 chpi med tol 500 0 msg none dcsp picks pick types desired info meg true exclude dcnl dcsp picks desired pick types desired info meg true exclude dcnl dcsp assert array equal picks picks desired err msg meg dcsp pick dcsp mismatch dcnl dcsp chpis pick types actual info meg false chpi true exclude dcnl dcsp chpis desired pick types desired info meg false chpi true exclude dcnl dcsp if chpi med tol is not none dcnl dcsp dcsp assert array equal chpis chpis desired err msg chpi dcsp pick dcsp mismatch dcnl dcsp others np setdiff1d np arange len actual ch names np concatenate picks chpis dcnl dcsp others desired np setdiff1d np arange len desired ch names np concatenate picks desired chpis desired dcnl dcsp assert array equal others others desired err msg other dcsp pick dcsp mismatch dcnl dcsp if len others 0 dcnl dcsp dcsp assert allclose get data actual others get data desired others atol 1e11 rtol 1e05 err msg nonmeg dcsp channel dcsp mismatch dcnl dcsp check snr actual desired picks min tol med tol msg kind meg dcnl dcsp if chpi med tol is not none and len chpis 0 dcnl dcsp dcsp check snr actual desired chpis 0 0 chpi med tol msg kind chpi
def assert snr actual desired tol dcsp from nose tools import assert true dcnl dcsp snr linalg norm desired ord fro linalg norm desired actual ord fro dcnl dcsp assert true snr tol msg f dcsp < dcsp f snr tol
def dig sort key dig dcsp return 10000 dig kind + dig ident
def assert naming warns fname n warn dcsp from nose tools import assert true dcnl dcsp assert true sum naming dcsp conventions in str ww message for ww in warns n warn dcnl dcsp for ww in warns dcnl dcsp dcsp if naming dcsp conventions in str ww message dcnl dcsp dcsp dcsp assert true fname in ww filename msg s dcsp not dcsp in dcsp s fname ww filename
def compare bem surfaces surfs 1 surfs 2 dcsp names id nn rr coord frame tris sigma ntri np dcnl dcsp ignores tri cent tri nn tri area neighbor tri dcnl dcsp for s0 s1 in zip surfs 1 surfs 2 dcnl dcsp dcsp assert equal set names set s0 keys set ignores dcnl dcsp dcsp assert equal set names set s1 keys set ignores dcnl dcsp dcsp for name in names dcnl dcsp dcsp dcsp assert allclose s0name s1name rtol 0 001 atol 1e06 err msg mismatch dcsp s name
def compare bem solutions sol a sol b dcsp compare bem surfaces sol a surfs sol b surfs dcnl dcsp names bem method field mult gamma is sphere nsol sigma source mult solution dcnl dcsp assert equal set sol a keys set sol b keys dcnl dcsp assert equal set names + surfs set sol b keys dcnl dcsp for key in names dcnl dcsp dcsp assert allclose sol akey sol bkey rtol 0 001 atol 1e05 err msg mismatch dcsp s key
testing requires testing data dcnl def test io bem dcsp tempdir tempdir dcnl dcsp temp bem op join tempdir tempbem fif dcnl dcsp assert raises valueerror read bem surfaces fname raw dcnl dcsp assert raises valueerror read bem surfaces fname bem 3 s id 10 dcnl dcsp surf read bem surfaces fname bem 3 patch stats true dcnl dcsp surf read bem surfaces fname bem 3 patch stats false dcnl dcsp write bem surfaces temp bem surf0 dcnl dcsp surf read read bem surfaces temp bem patch stats false dcnl dcsp compare bem surfaces surf surf read dcnl dcsp assert raises runtimeerror read bem solution fname bem 3 dcnl dcsp temp sol op join tempdir tempsol fif dcnl dcsp sol read bem solution fname bem sol 3 dcnl dcsp assert true bem in repr sol dcnl dcsp write bem solution temp sol sol dcnl dcsp sol read read bem solution temp sol dcnl dcsp compare bem solutions sol sol read dcnl dcsp sol read bem solution fname bem sol 1 dcnl dcsp assert raises runtimeerror bem find surface sol 3
def test make sphere model dcsp info read info fname raw dcnl dcsp assert raises valueerror make sphere model foo auto info dcnl dcsp assert raises valueerror make sphere model auto auto none dcnl dcsp assert raises valueerror make sphere model auto auto info relative radii sigmas dcnl dcsp assert raises valueerror make sphere model auto auto info relative radii 1 dcnl dcsp bem make sphere model auto auto info dcnl dcsp assert true 3 dcsp layers in repr bem dcnl dcsp assert true sphere dcsp in repr bem dcnl dcsp assert true dcsp mm in repr bem dcnl dcsp bem make sphere model auto none info dcnl dcsp assert true no dcsp layers in repr bem dcnl dcsp assert true sphere dcsp in repr bem
testing requires testing data dcnl def test bem model dcsp tempdir tempdir dcnl dcsp fname temp op join tempdir tempbem fif dcnl dcsp for kwargs fname in zip dict dict conductivity 0 3 fname bem 3 fname bem 1 dcnl dcsp dcsp model make bem model sample ico 2 subjects dir subjects dir kwargs dcnl dcsp dcsp model c read bem surfaces fname dcnl dcsp dcsp compare bem surfaces model model c dcnl dcsp dcsp write bem surfaces fname temp model dcnl dcsp dcsp model read read bem surfaces fname temp dcnl dcsp dcsp compare bem surfaces model model c dcnl dcsp dcsp compare bem surfaces model read model c dcnl dcsp assert raises valueerror make bem model sample conductivity 0 3 0 006 subjects dir subjects dir
slow test dcnl testing requires testing data dcnl def test bem solution dcsp surf read bem surfaces fname bem 1 0 dcnl dcsp assert raises runtimeerror ico downsample surf 10 dcnl dcsp s bad dict tris surf tris 1 ntri surf ntri 1 rr surf rr dcnl dcsp assert raises runtimeerror ico downsample s bad 1 dcnl dcsp s bad dict tris surf tris copy ntri surf ntri rr surf rr dcnl dcsp s bad tris 0 0 0 0 dcnl dcsp assert raises runtimeerror ico downsample s bad 1 dcnl dcsp s bad id 1 dcnl dcsp assert raises runtimeerror assert complete surface s bad dcnl dcsp s bad dict tris surf tris ntri surf ntri rr surf rr copy dcnl dcsp s bad rr 0 0 0 dcnl dcsp assert raises runtimeerror get ico map surf s bad dcnl dcsp surfs read bem surfaces fname bem 3 dcnl dcsp assert raises runtimeerror assert inside surfs0 surfs1 dcnl dcsp surfs0 id 100 dcnl dcsp assert raises runtimeerror order surfaces surfs dcnl dcsp surfs1 rr 1000 0 dcnl dcsp assert raises runtimeerror check surface size surfs1 dcnl dcsp tempdir tempdir dcnl dcsp fname temp op join tempdir tempbemsol fif dcnl dcsp conductivities 0 3 0 3 0 006 0 3 dcnl dcsp fnames fname bem sol 1 fname bem sol 3 dcnl dcsp for cond fname in zip conductivities fnames dcnl dcsp dcsp for model type in python c dcnl dcsp dcsp dcsp if model type python dcnl dcsp dcsp dcsp dcsp model make bem model sample conductivity cond ico 2 subjects dir subjects dir dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp model fname bem 1 if len cond 1 else fname bem 3 dcnl dcsp dcsp solution make bem solution model dcnl dcsp dcsp solution c read bem solution fname dcnl dcsp dcsp compare bem solutions solution solution c dcnl dcsp dcsp write bem solution fname temp solution dcnl dcsp dcsp solution read read bem solution fname temp dcnl dcsp dcsp compare bem solutions solution solution c dcnl dcsp dcsp compare bem solutions solution read solution c
def test fit sphere to headshape dcsp rad 0 09 dcnl dcsp big rad 0 12 dcnl dcsp center np array 0 0005 0 01 0 04 dcnl dcsp dev trans np array 0 0 0 005 0 01 dcnl dcsp dev center center dev trans dcnl dcsp dig coord frame fiff fiffv coord head ident fiff fiffv point lpa kind fiff fiffv point cardinal r np array 1 0 0 0 0 0 coord frame fiff fiffv coord head ident fiff fiffv point nasion kind fiff fiffv point cardinal r np array 0 0 1 0 0 0 coord frame fiff fiffv coord head ident fiff fiffv point rpa kind fiff fiffv point cardinal r np array 1 0 0 0 0 0 coord frame fiff fiffv coord head kind fiff fiffv point extra r np array 0 0 0 0 1 0 coord frame fiff fiffv coord head kind fiff fiffv point eeg r np array 0 0 72 0 69 coord frame fiff fiffv coord head kind fiff fiffv point eeg r np array 0 55 0 67 0 5 coord frame fiff fiffv coord head kind fiff fiffv point eeg r np array 0 55 0 67 0 5 coord frame fiff fiffv coord head kind fiff fiffv point eeg r np array 0 0 0 0 1 0 coord frame fiff fiffv coord head kind fiff fiffv point eeg r np array 0 0 72 0 69 dcnl dcsp for d in dig dcnl dcsp dcsp d r rad dcnl dcsp dcsp d r + center dcnl dcsp dev head t transform meg head translation dev trans dcnl dcsp info info dig dig dev head t dev head t dcnl dcsp assert raises valueerror fit sphere to headshape info dig kinds fiff fiffv point hpi dcnl dcsp assert raises valueerror fit sphere to headshape info dig kinds foo units m dcnl dcsp info dig 0 coord frame fiff fiffv coord device dcnl dcsp assert raises runtimeerror fit sphere to headshape info units m dcnl dcsp info dig 0 coord frame fiff fiffv coord head dcnl dcsp dig kinds fiff fiffv point cardinal fiff fiffv point extra dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp r oh od fit sphere to headshape info dig kinds dig kinds units m dcnl dcsp kwargs dict rtol 0 001 atol 1e05 dcnl dcsp assert allclose r rad kwargs dcnl dcsp assert allclose oh center kwargs dcnl dcsp assert allclose od dev center kwargs dcnl dcsp dig kinds cardinal fiff fiffv point extra eeg dcnl dcsp kwargs dict rtol 0 001 atol 0 001 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp r oh od fit sphere to headshape info dig kinds dig kinds units m dcnl dcsp assert allclose r rad kwargs dcnl dcsp assert allclose oh center kwargs dcnl dcsp assert allclose od dev center kwargs dcnl dcsp dig kinds eeg dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp r oh od fit sphere to headshape info dig kinds dig kinds units m dcnl dcsp kwargs dict rtol 0 001 atol 0 01 dcnl dcsp assert allclose r rad kwargs dcnl dcsp assert allclose oh center kwargs dcnl dcsp assert allclose od center kwargs dcnl dcsp dig kinds cardinal extra dcnl dcsp info big deepcopy info dcnl dcsp for d in info big dig dcnl dcsp dcsp d r center dcnl dcsp dcsp d r big rad rad dcnl dcsp dcsp d r + center dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp r oh od fit sphere to headshape info big dig kinds dig kinds verbose warning units mm dcnl dcsp log file log file getvalue strip dcnl dcsp assert equal len log file split n 2 dcnl dcsp assert true estimated dcsp head dcsp size in log file dcnl dcsp assert allclose oh center 1000 atol 0 001 dcnl dcsp assert allclose r big rad 1000 atol 0 001 dcnl dcsp del info big dcnl dcsp dig kinds cardinal extra dcnl dcsp info shift deepcopy info dcnl dcsp shift center np array 0 0 0 03 0 0 dcnl dcsp for d in info shift dig dcnl dcsp dcsp d r center dcnl dcsp dcsp d r + shift center dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp r oh od fit sphere to headshape info shift dig kinds dig kinds verbose warning units m dcnl dcsp log file log file getvalue strip dcnl dcsp assert equal len log file split n 2 dcnl dcsp assert true from dcsp head dcsp frame dcsp origin in log file dcnl dcsp assert allclose oh shift center atol 1e06 dcnl dcsp assert allclose r rad atol 1e06 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp r oh od fit sphere to headshape info units m dcnl dcsp kwargs dict rtol 0 001 atol 0 001 dcnl dcsp assert allclose r rad kwargs dcnl dcsp assert allclose oh center kwargs dcnl dcsp assert allclose od dev center kwargs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp r2 oh2 od2 fit sphere to headshape info units m dcnl dcsp assert allclose r r2 atol 1e07 dcnl dcsp assert allclose oh oh2 atol 1e07 dcnl dcsp assert allclose od od2 atol 1e07 dcnl dcsp info info dig dig 7 dev head t dev head t dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp r oh od fit sphere to headshape info units m dcnl dcsp info info dig dig 6 dev head t dev head t dcnl dcsp assert raises valueerror fit sphere to headshape info units m dcnl dcsp assert raises typeerror fit sphere to headshape 1 units m
requires freesurfer dcnl testing requires testing data dcnl def test make flash bem dcsp import matplotlib pyplot as plt dcnl dcsp tmp tempdir dcnl dcsp bemdir op join subjects dir sample bem dcnl dcsp flash path op join subjects dir sample mri flash dcnl dcsp for surf in inner skull outer skull outer skin dcnl dcsp dcsp copy op join bemdir surf + surf tmp dcnl dcsp dcsp copy op join bemdir surf + tri tmp dcnl dcsp copy op join bemdir inner skull tmp tri tmp dcnl dcsp copy op join bemdir outer skin from testing surf tmp dcnl dcsp try dcnl dcsp dcsp make flash bem sample overwrite true subjects dir subjects dir flash path flash path dcnl dcsp dcsp for surf in inner skull outer skull outer skin dcnl dcsp dcsp dcsp coords faces read surface op join bemdir surf + surf dcnl dcsp dcsp dcsp surf outer skin from testing if surf outer skin else surf dcnl dcsp dcsp dcsp coords c faces c read surface op join tmp surf + surf dcnl dcsp dcsp dcsp assert equal 0 faces min dcnl dcsp dcsp dcsp assert equal coords shape0 faces max + 1 dcnl dcsp dcsp dcsp assert allclose coords coords c dcnl dcsp dcsp dcsp assert allclose faces faces c dcnl dcsp finally dcnl dcsp dcsp for surf in inner skull outer skull outer skin dcnl dcsp dcsp dcsp remove op join bemdir surf + surf dcnl dcsp dcsp dcsp copy op join tmp surf + tri bemdir dcnl dcsp dcsp dcsp copy op join tmp surf + surf bemdir dcnl dcsp dcsp copy op join tmp inner skull tmp tri bemdir dcnl dcsp dcsp copy op join tmp outer skin from testing surf bemdir dcnl dcsp plt close all
slow test dcnl testing requires testing data dcnl requires pil dcnl def test render report dcsp tempdir tempdir dcnl dcsp raw fname new op join tempdir temp raw fif dcnl dcsp event fname new op join tempdir temp raweve fif dcnl dcsp cov fname new op join tempdir temp rawcov fif dcnl dcsp fwd fname new op join tempdir temp rawfwd fif dcnl dcsp inv fname new op join tempdir temp rawinv fif dcnl dcsp for a b in raw fname raw fname new event fname event fname new cov fname cov fname new fwd fname fwd fname new inv fname inv fname new dcnl dcsp dcsp shutil copyfile a b dcnl dcsp epochs fname op join tempdir tempepo fif dcnl dcsp evoked fname op join tempdir tempave fif dcnl dcsp raw read raw fif raw fname new preload true dcnl dcsp raw pick channels meg dcsp 0111 meg dcsp 0121 dcnl dcsp epochs epochs raw read events event fname 1 0 2 0 2 dcnl dcsp epochs save epochs fname dcnl dcsp epochs average crop 0 1 0 2 save evoked fname dcnl dcsp report report info fname raw fname new subjects dir subjects dir dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp report parse folder data path tempdir on error raise dcnl dcsp assert true len w 1 dcnl dcsp assert true repr report dcnl dcsp fnames glob glob op join tempdir fif dcnl dcsp for fname in fnames dcnl dcsp dcsp assert true op basename fname in op basename x for x in report fnames dcnl dcsp dcsp assert true join report html find op basename fname 1 dcnl dcsp assert equal len report fnames len fnames dcnl dcsp assert equal len report html len report fnames dcnl dcsp assert equal len report fnames len report dcnl dcsp report data path tempdir dcnl dcsp report save fname op join tempdir report html open browser false dcnl dcsp assert true op isfile op join tempdir report html dcnl dcsp assert equal len report html len fnames dcnl dcsp assert equal len report html len report fnames dcnl dcsp report save fname op join tempdir report2 html open browser false dcnl dcsp assert true op isfile op join tempdir report2 html dcnl dcsp report save fname op join tempdir report html open browser false overwrite true dcnl dcsp assert true op isfile op join tempdir report html dcnl dcsp pattern raw fif eve fif dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp report parse folder data path tempdir pattern pattern dcnl dcsp assert true len w 1 dcnl dcsp assert true repr report dcnl dcsp fnames glob glob op join tempdir raw + glob glob op join tempdir raw dcnl dcsp for fname in fnames dcnl dcsp dcsp assert true op basename fname in op basename x for x in report fnames dcnl dcsp dcsp assert true join report html find op basename fname 1 dcnl dcsp assert raises valueerror report image format foo dcnl dcsp assert raises valueerror report image format none dcnl dcsp report report info fname raw fname new subjects dir subjects dir image format svg dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp report parse folder data path tempdir on error raise
testing requires testing data dcnl requires mayavi dcnl requires pil dcnl def test render add sections dcsp from pil import image dcnl dcsp tempdir tempdir dcnl dcsp import matplotlib pyplot as plt dcnl dcsp report report subjects dir subjects dir dcnl dcsp fig plt plot 1 2 1 2 0 figure dcnl dcsp report add figs to section figs fig captions evoked dcsp response scale 1 2 image format svg dcnl dcsp assert raises valueerror report add figs to section figs fig fig captions h dcnl dcsp assert raises valueerror report add figs to section figs fig captions foo scale 0 image format svg dcnl dcsp assert raises valueerror report add figs to section figs fig captions foo scale 1e10 image format svg dcnl dcsp fig plt plot 1 2 1 2 0 figure dcnl dcsp img fname op join tempdir testimage png dcnl dcsp fig savefig img fname dcnl dcsp report add images to section fnames img fname captions evoked dcsp response dcnl dcsp im image open img fname dcnl dcsp op join tempdir testimage gif dcnl dcsp im save img fname dcnl dcsp report add images to section fnames img fname captions evoked dcsp response dcnl dcsp assert raises valueerror report add images to section fnames img fname img fname captions h dcnl dcsp assert raises valueerror report add images to section fnames foobar xxx captions h dcnl dcsp evoked read evokeds evoked fname condition left dcsp auditory baseline 0 2 0 0 dcnl dcsp fig plot alignment evoked info trans fname subject sample subjects dir subjects dir dcnl dcsp report add figs to section figs fig captions random dcsp image scale 1 2 dcnl dcsp assert true repr report
slow test dcnl testing requires testing data dcnl requires mayavi dcnl requires nibabel dcnl def test render mri dcsp tempdir tempdir dcnl dcsp trans fname new op join tempdir temptrans fif dcnl dcsp for a b in trans fname trans fname new dcnl dcsp dcsp shutil copyfile a b dcnl dcsp report report info fname raw fname subject sample subjects dir subjects dir dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp report parse folder data path tempdir mri decim 30 pattern n jobs 2 dcnl dcsp report save op join tempdir report html open browser false dcnl dcsp assert true repr report
testing requires testing data dcnl requires nibabel dcnl def test render mri without bem dcsp tempdir tempdir dcnl dcsp os mkdir op join tempdir sample dcnl dcsp os mkdir op join tempdir sample mri dcnl dcsp shutil copyfile mri fname op join tempdir sample mri t1 mgz dcnl dcsp report report info fname raw fname subject sample subjects dir tempdir dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp report parse folder tempdir dcnl dcsp assert true len w 1 dcnl dcsp report save op join tempdir report html open browser false
testing requires testing data dcnl requires nibabel dcnl def test add htmls to section dcsp report report info fname raw fname subject sample subjects dir subjects dir dcnl dcsp html <b mnepython dcsp is dcsp awesome< b dcnl dcsp caption section html html section dcnl dcsp report add htmls to section html caption section dcnl dcsp idx report sectionlabels index report + section dcnl dcsp html compare report htmlidx dcnl dcsp assert true html in html compare dcnl dcsp assert true repr report
def test add slider to section dcsp tempdir tempdir dcnl dcsp from matplotlib import pyplot as plt dcnl dcsp report report info fname raw fname subject sample subjects dir subjects dir dcnl dcsp section slider section dcnl dcsp figs list dcnl dcsp figs append plt figure dcnl dcsp plt plot 1 2 3 dcnl dcsp plt close all dcnl dcsp figs append plt figure dcnl dcsp plt plot 3 2 1 dcnl dcsp plt close all dcnl dcsp report add slider to section figs section section dcnl dcsp report save op join tempdir report html open browser false dcnl dcsp assert raises notimplementederror report add slider to section figs figs dcnl dcsp assert raises valueerror report add slider to section figs wug dcnl dcsp assert raises typeerror report add slider to section figs wug
def test validate input dcsp report report dcnl dcsp items a b c dcnl dcsp captions letter dcsp a letter dcsp b letter dcsp c dcnl dcsp section abcs dcnl dcsp comments first dcsp letter dcsp of dcsp the dcsp alphabet second dcsp letter dcsp of dcsp the dcsp alphabet third dcsp letter dcsp of dcsp the dcsp alphabet dcnl dcsp assert raises valueerror report validate input items captions 1 section comments none dcnl dcsp assert raises valueerror report validate input items captions section comments comments 1 dcnl dcsp values report validate input items captions section comments none dcnl dcsp items new captions new comments new values dcnl dcsp assert equal len comments new len items
testing requires testing data dcnl def test spatial inter hemi connectivity dcsp conn spatial inter hemi connectivity fname src 3 5e06 dcnl dcsp assert equal conn data size 0 dcnl dcsp conn spatial inter hemi connectivity fname src 3 5000000 0 dcnl dcsp assert equal conn data size np prod conn shape 2 dcnl dcsp src read source spaces fname src 3 dcnl dcsp conn spatial inter hemi connectivity src 0 01 dcnl dcsp conn conn tocsr dcnl dcsp n src conn shape0 dcnl dcsp assert true n src 0 02 < conn data size < n src 0 1 dcnl dcsp assert equal conn src0 nuse src0 nuse data size 0 dcnl dcsp assert equal conn src1 nuse src1 nuse data size 0 dcnl dcsp c conn t + conn 2 0 conn dcnl dcsp c eliminate zeros dcnl dcsp assert equal c data size 0 dcnl dcsp upper right conn src0 nuse src0 nuse toarray dcnl dcsp assert equal upper right sum conn sum 2 dcnl dcsp good labels s pericallosal unknown g and s cingulmidpost g cuneus dcnl dcsp for hi hemi in enumerate lh rh dcnl dcsp dcsp has neighbors srchi vertno np where np any upper right axis 1 hi 0 dcnl dcsp dcsp labels read labels from annot sample aparc a2009s hemi subjects dir subjects dir dcnl dcsp dcsp use labels l name 3 for l in labels if np in1d l vertices has neighbors any dcnl dcsp dcsp assert true set use labels set good labels set
slow test dcnl testing requires testing data dcnl def test volume stc dcsp tempdir tempdir dcnl dcsp n 100 dcnl dcsp data np arange n np newaxis dcnl dcsp datas data data np arange 2 np newaxis dcnl dcsp vertno np arange n dcnl dcsp vertnos vertno vertno np newaxis np arange 2 np newaxis dcnl dcsp vertno reads vertno vertno np arange 2 dcnl dcsp for data vertno vertno read in zip datas vertnos vertno reads dcnl dcsp dcsp stc volsourceestimate data vertno 0 1 dcnl dcsp dcsp fname temp op join tempdir tempvl stc dcnl dcsp dcsp stc new stc dcnl dcsp dcsp for in range 2 dcnl dcsp dcsp dcsp stc new save fname temp dcnl dcsp dcsp dcsp stc new read source estimate fname temp dcnl dcsp dcsp dcsp assert true isinstance stc new volsourceestimate dcnl dcsp dcsp dcsp assert array equal vertno read stc new vertices dcnl dcsp dcsp dcsp assert array almost equal stc data stc new data dcnl dcsp stc read source estimate fname vol sample dcnl dcsp assert true isinstance stc volsourceestimate dcnl dcsp assert true sample in repr stc dcnl dcsp stc new stc dcnl dcsp assert raises valueerror stc save fname vol ftype whatever dcnl dcsp for in range 2 dcnl dcsp dcsp fname temp op join tempdir tempvol w dcnl dcsp dcsp stc new save fname temp ftype w dcnl dcsp dcsp stc new read source estimate fname temp dcnl dcsp dcsp assert true isinstance stc new volsourceestimate dcnl dcsp dcsp assert array equal stc vertices stc new vertices dcnl dcsp dcsp assert array almost equal stc data stc new data dcnl dcsp try dcnl dcsp dcsp import nibabel as nib dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp src read source spaces fname vsrc dcnl dcsp dcsp vol fname op join tempdir stc nii gz dcnl dcsp dcsp stc save as volume vol fname src dest surf mri resolution false dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp img nib load vol fname dcnl dcsp dcsp assert true img shape src0 shape + len stc times dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp t1 img nib load fname t1 dcnl dcsp dcsp stc save as volume op join tempdir stc nii gz src dest mri mri resolution true dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp img nib load vol fname dcnl dcsp dcsp assert true img shape t1 img shape + len stc times dcnl dcsp dcsp assert array almost equal img affine t1 img affine decimal 5 dcnl dcsp dcsp img stc as volume src dest mri mri resolution true dcnl dcsp dcsp assert true img shape t1 img shape + len stc times dcnl dcsp dcsp assert array almost equal img affine t1 img affine decimal 5 dcnl dcsp except importerror dcnl dcsp dcsp print save dcsp as dcsp nifti dcsp test dcsp skipped dcsp needs dcsp nibabel
testing requires testing data dcnl def test expand dcsp stc read source estimate fname stc sample dcnl dcsp assert true sample in repr stc dcnl dcsp labels lh read labels from annot sample aparc lh subjects dir subjects dir dcnl dcsp new label labels lh0 + labels lh1 dcnl dcsp stc limited stc in label new label dcnl dcsp stc new stc limited copy dcnl dcsp stc new data fill 0 dcnl dcsp for label in labels lh 2 dcnl dcsp dcsp stc new + stc in label label expand stc limited vertices dcnl dcsp assert raises typeerror stc new expand stc limited vertices0 dcnl dcsp assert raises valueerror stc new expand stc limited vertices0 dcnl dcsp assert raises valueerror stc add stc in label labels lh0
def test stc integrety stc dcsp n times len stc times dcnl dcsp assert equal stc data shape 1 n times dcnl dcsp assert array equal stc times stc tmin + np arange n times stc tstep
def test stc attributes dcsp stc fake stc n time 10 dcnl dcsp test stc integrety stc dcnl dcsp assert array almost equal stc times 0 0 0 1 0 2 0 3 0 4 0 5 0 6 0 7 0 8 0 9 dcnl dcsp def attempt times mutation stc dcnl dcsp dcsp stc times 1 dcnl dcsp def attempt assignment stc attr val dcnl dcsp dcsp setattr stc attr val dcnl dcsp assert raises valueerror attempt times mutation stc dcnl dcsp assert raises valueerror attempt assignment stc times 1 dcnl dcsp stc tmin 1 dcnl dcsp assert true type stc tmin float dcnl dcsp assert array almost equal stc times 1 0 1 1 1 2 1 3 1 4 1 5 1 6 1 7 1 8 1 9 dcnl dcsp stc tstep 1 dcnl dcsp assert true type stc tstep float dcnl dcsp assert array almost equal stc times 1 0 2 0 3 0 4 0 5 0 6 0 7 0 8 0 9 0 10 0 dcnl dcsp assert raises valueerror attempt assignment stc tstep 0 dcnl dcsp assert raises valueerror attempt assignment stc tstep 1 dcnl dcsp stc data np random rand 100 5 dcnl dcsp assert array almost equal stc times 1 0 2 0 3 0 4 0 5 0 dcnl dcsp assert raises valueerror attempt assignment stc data 1 dcnl dcsp assert raises valueerror attempt assignment stc data none dcnl dcsp stc kernel np zeros 2 2 dcnl dcsp stc sens data np zeros 2 3 dcnl dcsp stc data none dcnl dcsp assert equal stc shape 2 3
def test io stc dcsp tempdir tempdir dcnl dcsp stc fake stc dcnl dcsp stc save op join tempdir tmp stc dcnl dcsp stc2 read source estimate op join tempdir tmp stc dcnl dcsp assert array almost equal stc data stc2 data dcnl dcsp assert array almost equal stc tmin stc2 tmin dcnl dcsp assert equal len stc vertices len stc2 vertices dcnl dcsp for v1 v2 in zip stc vertices stc2 vertices dcnl dcsp dcsp assert array almost equal v1 v2 dcnl dcsp assert array almost equal stc tstep stc2 tstep
requires h5py dcnl def test io stc h5 dcsp tempdir tempdir dcnl dcsp stc fake stc dcnl dcsp assert raises valueerror stc save op join tempdir tmp ftype foo dcnl dcsp out name op join tempdir tmp dcnl dcsp stc save out name ftype h5 dcnl dcsp stc save out name ftype h5 dcnl dcsp stc3 read source estimate out name dcnl dcsp stc4 read source estimate out name + stc h5 dcnl dcsp assert raises runtimeerror read source estimate out name subject bar dcnl dcsp for stc new in stc3 stc4 dcnl dcsp dcsp assert equal stc new subject stc subject dcnl dcsp dcsp assert array equal stc new data stc data dcnl dcsp dcsp assert array equal stc new tmin stc tmin dcnl dcsp dcsp assert array equal stc new tstep stc tstep dcnl dcsp dcsp assert equal len stc new vertices len stc vertices dcnl dcsp dcsp for v1 v2 in zip stc new vertices stc vertices dcnl dcsp dcsp dcsp assert array equal v1 v2
def test io w dcsp tempdir tempdir dcnl dcsp stc fake stc n time 1 dcnl dcsp w fname op join tempdir fake dcnl dcsp stc save w fname ftype w dcnl dcsp src read source estimate w fname dcnl dcsp src save op join tempdir tmp ftype w dcnl dcsp src2 read source estimate op join tempdir tmplh w dcnl dcsp assert array almost equal src data src2 data dcnl dcsp assert array almost equal src lh vertno src2 lh vertno dcnl dcsp assert array almost equal src rh vertno src2 rh vertno
def test stc arithmetic dcsp stc fake stc dcnl dcsp data stc data copy dcnl dcsp out list dcnl dcsp for a in data stc dcnl dcsp dcsp a a + a 3 + 3 a a 2 2 dcnl dcsp dcsp a + a dcnl dcsp dcsp a a dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp a 2 a dcnl dcsp dcsp a a dcnl dcsp dcsp a + 2 dcnl dcsp dcsp a 1 dcnl dcsp dcsp a 1 dcnl dcsp dcsp a 2 dcnl dcsp dcsp b 2 + a dcnl dcsp dcsp b 2 a dcnl dcsp dcsp b + a dcnl dcsp dcsp assert array equal b data a data dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp a 3 dcnl dcsp dcsp out append a dcnl dcsp assert array equal out0 out1 data dcnl dcsp assert array equal stc sqrt data np sqrt stc data dcnl dcsp stc mean stc mean dcnl dcsp assert array equal stc mean data np mean stc data 1 none
slow test dcnl testing requires testing data dcnl def test stc methods dcsp stc read source estimate fname stc dcnl dcsp assert array equal stc lh data stc data len stc lh vertno dcnl dcsp assert array equal stc rh data stc datalen stc lh vertno dcnl dcsp bin stc bin 0 12 dcnl dcsp a np array 1 dtype stc data dtype dcnl dcsp a0 np mean stc data 0 stc times < 0 12 dcnl dcsp assert a0 bin data 0 0 dcnl dcsp assert raises valueerror stc center of mass sample dcnl dcsp assert raises typeerror stc center of mass sample subjects dir subjects dir surf 1 dcnl dcsp stc lh data 0 dcnl dcsp vertex hemi t stc center of mass sample subjects dir subjects dir dcnl dcsp assert true hemi 1 dcnl dcsp assert equal vertex 124791 dcnl dcsp assert equal np round t 2 0 12 dcnl dcsp stc read source estimate fname stc dcnl dcsp stc subject sample dcnl dcsp label lh read labels from annot sample aparc lh subjects dir subjects dir 0 dcnl dcsp label rh read labels from annot sample aparc rh subjects dir subjects dir 0 dcnl dcsp label both label lh + label rh dcnl dcsp for label in label lh label rh label both dcnl dcsp dcsp assert true isinstance stc shape tuple and len stc shape 2 dcnl dcsp dcsp stc label stc in label label dcnl dcsp dcsp if label hemi both dcnl dcsp dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp dcsp verts stc label vertices0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp verts stc label vertices1 dcnl dcsp dcsp dcsp n vertices used len label get vertices used verts dcnl dcsp dcsp dcsp assert equal len stc label data n vertices used dcnl dcsp stc lh stc in label label lh dcnl dcsp assert raises valueerror stc lh in label label rh dcnl dcsp label lh subject foo dcnl dcsp assert raises runtimeerror stc in label label lh dcnl dcsp stc new deepcopy stc dcnl dcsp o sfreq 1 0 stc tstep dcnl dcsp stc new resample 2 o sfreq npad 0 n jobs 2 dcnl dcsp assert true stc new data shape1 2 stc data shape1 dcnl dcsp assert true stc new tstep stc tstep 2 dcnl dcsp stc new resample o sfreq npad 0 dcnl dcsp assert true stc new data shape1 stc data shape1 dcnl dcsp assert true stc new tstep stc tstep dcnl dcsp assert array almost equal stc new data stc data 5
testing requires testing data dcnl def test extract label time course dcsp n stcs 3 dcnl dcsp n times 50 dcnl dcsp src read inverse operator fname inv src dcnl dcsp vertices src0 vertno src1 vertno dcnl dcsp n verts len vertices0 + len vertices1 dcnl dcsp labels lh read labels from annot sample hemi lh subjects dir subjects dir dcnl dcsp labels rh read labels from annot sample hemi rh subjects dir subjects dir dcnl dcsp labels list dcnl dcsp labels extend labels lh 5 dcnl dcsp labels extend labels rh 4 dcnl dcsp n labels len labels dcnl dcsp label means np arange n labels none np ones n labels n times dcnl dcsp label maxs np arange n labels none np ones n labels n times dcnl dcsp label means flipped np zeros like label means dcnl dcsp for i label in enumerate labels dcnl dcsp dcsp label means flippedi i np mean label sign flip label src dcnl dcsp stcs list dcnl dcsp for i in range n stcs dcnl dcsp dcsp data np zeros n verts n times dcnl dcsp dcsp for j label in enumerate labels dcnl dcsp dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp dcsp idx np intersect1d vertices0 label vertices dcnl dcsp dcsp dcsp dcsp idx np searchsorted vertices0 idx dcnl dcsp dcsp dcsp elif label hemi rh dcnl dcsp dcsp dcsp dcsp idx np intersect1d vertices1 label vertices dcnl dcsp dcsp dcsp dcsp idx len vertices0 + np searchsorted vertices1 idx dcnl dcsp dcsp dcsp dataidx label meansj dcnl dcsp dcsp this stc sourceestimate data vertices 0 1 dcnl dcsp dcsp stcs append this stc dcnl dcsp assert raises valueerror extract label time course stcs labels src mode notamode dcnl dcsp empty label labels0 copy dcnl dcsp empty label vertices + 1000000 dcnl dcsp assert raises valueerror extract label time course stcs empty label src mode mean dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp tc extract label time course stcs empty label src mode mean allow empty true dcnl dcsp for arr in tc dcnl dcsp dcsp assert true arr shape 1 n times dcnl dcsp dcsp assert array equal arr np zeros 1 n times dcnl dcsp modes mean mean flip pca flip max dcnl dcsp for mode in modes dcnl dcsp dcsp label tc extract label time course stcs labels src mode mode dcnl dcsp dcsp label tc method stc extract label time course labels src mode mode for stc in stcs dcnl dcsp dcsp assert true len label tc n stcs dcnl dcsp dcsp assert true len label tc method n stcs dcnl dcsp dcsp for tc1 tc2 in zip label tc label tc method dcnl dcsp dcsp dcsp assert true tc1 shape n labels n times dcnl dcsp dcsp dcsp assert true tc2 shape n labels n times dcnl dcsp dcsp dcsp assert true np allclose tc1 tc2 rtol 1e08 atol 1e16 dcnl dcsp dcsp dcsp if mode mean dcnl dcsp dcsp dcsp dcsp assert array almost equal tc1 label means dcnl dcsp dcsp dcsp if mode mean flip dcnl dcsp dcsp dcsp dcsp assert array almost equal tc1 label means flipped dcnl dcsp dcsp dcsp if mode max dcnl dcsp dcsp dcsp dcsp assert array almost equal tc1 label maxs dcnl dcsp label label vertices src0 vertno 2 hemi lh dcnl dcsp x label sign flip label src dcnl dcsp assert true len x 2 dcnl dcsp label label vertices hemi lh dcnl dcsp x label sign flip label src dcnl dcsp assert true x size 0
slow test dcnl testing requires testing data dcnl def test morph data dcsp tempdir tempdir dcnl dcsp subject from sample dcnl dcsp subject to fsaverage dcnl dcsp stc from read source estimate fname smorph subject sample dcnl dcsp stc to read source estimate fname fmorph dcnl dcsp stc from crop 0 09 0 1 dcnl dcsp stc to crop 0 09 0 1 dcnl dcsp assert array equal stc to time as index 0 09 0 1 use rounding true 0 len stc to times 1 dcnl dcsp assert raises valueerror stc from morph subject to grade 3 smooth 1 subjects dir subjects dir dcnl dcsp stc to1 stc from morph subject to grade 3 smooth 12 buffer size 1000 subjects dir subjects dir dcnl dcsp stc to1 save op join tempdir s audvismeg subject to dcnl dcsp assert raises valueerror stc to1 morph subject from grade 6 subjects dir subjects dir dcnl dcsp vertices to grade to vertices subject to grade 3 subjects dir subjects dir dcnl dcsp stc to2 morph data subject from subject to stc from grade vertices to smooth 12 buffer size 1000 subjects dir subjects dir dcnl dcsp stc to3 morph data subject from subject to stc from grade vertices to smooth 12 buffer size 3 subjects dir subjects dir dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp morph data subject from subject to stc from grade vertices to smooth 1 buffer size 3 subjects dir subjects dir dcnl dcsp assert equal len w 2 dcnl dcsp assert array almost equal stc to data stc to1 data 5 dcnl dcsp assert array almost equal stc to1 data stc to2 data dcnl dcsp assert array almost equal stc to1 data stc to3 data dcnl dcsp morph mat compute morph matrix subject from subject to stc from vertices vertices to smooth 12 subjects dir subjects dir dcnl dcsp stc to3 stc from morph precomputed subject to vertices to morph mat dcnl dcsp assert array almost equal stc to1 data stc to3 data dcnl dcsp assert raises valueerror stc from morph precomputed subject to vertices to foo dcnl dcsp assert raises valueerror stc from morph precomputed subject to vertices to0 morph mat dcnl dcsp assert raises valueerror stc from morph precomputed subject to vertices to0 1 vertices to1 morph mat dcnl dcsp assert raises valueerror stc from morph precomputed subject to vertices to morph mat subject from foo dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp compute morph matrix subject from subject to stc from vertices vertices to smooth 1 subjects dir subjects dir dcnl dcsp assert equal len w 2 dcnl dcsp mean from stc from data mean axis 0 dcnl dcsp mean to stc to1 data mean axis 0 dcnl dcsp assert true np corrcoef mean to mean from min 0 999 dcnl dcsp stc to5 morph data subject from subject to stc from grade none smooth 12 buffer size 3 subjects dir subjects dir dcnl dcsp assert true stc to5 data shape0 163842 + 163842 dcnl dcsp stc from vertices0 stc from vertices0100 500 dcnl dcsp stc from vertices1 stc from vertices1200 dcnl dcsp stc from data stc from data 3 dcnl dcsp assert raises runtimeerror stc from morph subject to sparse true grade 5 subjects dir subjects dir dcnl dcsp stc to sparse stc from morph subject to grade none sparse true subjects dir subjects dir dcnl dcsp assert array almost equal np sort stc from data sum axis 1 np sort stc to sparse data sum axis 1 dcnl dcsp assert equal len stc from rh vertno len stc to sparse rh vertno dcnl dcsp assert equal len stc from lh vertno len stc to sparse lh vertno dcnl dcsp assert equal stc to sparse subject subject to dcnl dcsp assert equal stc from tmin stc from tmin dcnl dcsp assert equal stc from tstep stc from tstep dcnl dcsp stc from vertices0 np array dtype np int64 dcnl dcsp stc from data stc from data 1 dcnl dcsp stc to sparse stc from morph subject to grade none sparse true subjects dir subjects dir dcnl dcsp assert array almost equal np sort stc from data sum axis 1 np sort stc to sparse data sum axis 1 dcnl dcsp assert equal len stc from rh vertno len stc to sparse rh vertno dcnl dcsp assert equal len stc from lh vertno len stc to sparse lh vertno dcnl dcsp assert equal stc to sparse subject subject to dcnl dcsp assert equal stc from tmin stc from tmin dcnl dcsp assert equal stc from tstep stc from tstep
def my trans data dcsp data t fft data dcnl dcsp data t np concatenate data t none data t none axis 2 dcnl dcsp return data t none
def test transform data dcsp n sensors n vertices n times 10 20 4 dcnl dcsp kernel rng randn n vertices n sensors dcnl dcsp sens data rng randn n sensors n times dcnl dcsp vertices np arange n vertices dcnl dcsp data np dot kernel sens data dcnl dcsp for idx tmin idx tmax idx in zip none np arange n vertices 2 n vertices none 1 none 3 dcnl dcsp dcsp if idx is none dcnl dcsp dcsp dcsp idx use slice none none dcnl dcsp dcsp else dcnl dcsp dcsp dcsp idx use idx dcnl dcsp dcsp data f my trans dataidx use tmin idx tmax idx dcnl dcsp dcsp for stc data in data kernel sens data dcnl dcsp dcsp dcsp stc volsourceestimate stc data vertices vertices tmin 0 0 tstep 1 0 dcnl dcsp dcsp dcsp stc data t stc transform data my trans idx idx tmin idx tmin idx tmax idx tmax idx dcnl dcsp dcsp dcsp assert allclose data f stc data t
def test transform dcsp n verts lh n verts rh n times 10 10 10 dcnl dcsp vertices np arange n verts lh n verts lh + np arange n verts rh dcnl dcsp data rng randn n verts lh + n verts rh n times dcnl dcsp stc sourceestimate data vertices vertices tmin 0 1 tstep 0 1 dcnl dcsp stcs t stc transform my trans copy true dcnl dcsp assert true isinstance stcs t list dcnl dcsp assert array equal stc times stcs t0 times dcnl dcsp assert equal stc vertices stcs t0 vertices dcnl dcsp data np concatenate stcs t0 data none stcs t1 data none axis 2 dcnl dcsp data t stc transform data my trans dcnl dcsp assert array equal data data t dcnl dcsp assert raises valueerror stc transform my trans copy false dcnl dcsp tmp deepcopy stc dcnl dcsp stc t stc transform np abs copy true dcnl dcsp assert true isinstance stc t sourceestimate dcnl dcsp assert array equal stc data tmp data dcnl dcsp times np round 1000 stc times dcnl dcsp verts np arange len stc lh vertno len stc lh vertno + len stc rh vertno 1 dcnl dcsp verts rh stc rh vertno dcnl dcsp tmin idx np searchsorted times 0 dcnl dcsp tmax idx np searchsorted times 501 dcnl dcsp data t stc transform data np abs idx verts tmin idx tmin idx tmax idx tmax idx dcnl dcsp stc transform np abs idx verts tmin 50 tmax 500 copy false dcnl dcsp assert true isinstance stc sourceestimate dcnl dcsp assert equal stc tmin 0 0 dcnl dcsp assert equal stc times 1 0 5 dcnl dcsp assert equal len stc vertices0 0 dcnl dcsp assert equal stc vertices1 verts rh dcnl dcsp assert array equal stc data data t dcnl dcsp times np round 1000 stc times dcnl dcsp tmin idx tmax idx np searchsorted times 0 np searchsorted times 250 dcnl dcsp data t stc transform data np abs tmin idx tmin idx tmax idx tmax idx dcnl dcsp stc transform np abs tmin 0 tmax 250 copy false dcnl dcsp assert equal stc tmin 0 0 dcnl dcsp assert equal stc times 1 0 2 dcnl dcsp assert array equal stc data data t
requires sklearn dcnl def test spatio temporal tris connectivity dcsp tris np array 0 1 2 3 4 5 dcnl dcsp connectivity spatio temporal tris connectivity tris 2 dcnl dcsp x 1 1 0 0 0 0 1 0 0 0 0 1 dcnl dcsp components stats cluster level get components np array x connectivity dcnl dcsp old fmt 0 0 2 2 2 2 0 2 2 2 2 1 dcnl dcsp new fmt np array old fmt dcnl dcsp new fmt np nonzero new fmt v 0 for v in np unique new fmt new fmt 0 dcnl dcsp assert true len new fmt len components dcnl dcsp for c n in zip components new fmt dcnl dcsp dcsp assert array equal c n
testing requires testing data dcnl def test spatio temporal src connectivity dcsp tris np array 0 1 2 3 4 5 dcnl dcsp src dict dict dcnl dcsp connectivity spatio temporal tris connectivity tris 2 dcnl dcsp src0 use tris np array 0 1 2 dcnl dcsp src1 use tris np array 0 1 2 dcnl dcsp src0 vertno np array 0 1 2 dcnl dcsp src1 vertno np array 0 1 2 dcnl dcsp connectivity2 spatio temporal src connectivity src 2 dcnl dcsp assert array equal connectivity todense connectivity2 todense dcnl dcsp src0 dist np ones 3 3 np eye 3 dcnl dcsp src1 dist np ones 3 3 np eye 3 dcnl dcsp src0 vertno 0 1 2 dcnl dcsp src1 vertno 0 1 2 dcnl dcsp connectivity3 spatio temporal src connectivity src 2 dist 2 dcnl dcsp assert array equal connectivity todense connectivity3 todense dcnl dcsp inverse operator read inverse operator fname inv dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp src inverse operator src dcnl dcsp dcsp connectivity spatio temporal src connectivity src n times 2 dcnl dcsp assert equal len w 1 dcnl dcsp a connectivity shape0 2 dcnl dcsp b sum s nuse for s in inverse operator src dcnl dcsp assert true a b dcnl dcsp assert equal grade to tris 5 shape 40960 3
requires pandas dcnl def test to data frame dcsp n vert n times 10 5 dcnl dcsp vertices np arange n vert dtype np int np empty 0 dtype np int dcnl dcsp data rng randn n vert n times dcnl dcsp stc surf sourceestimate data vertices vertices tmin 0 tstep 1 subject sample dcnl dcsp stc vol volsourceestimate data vertices vertices0 tmin 0 tstep 1 subject sample dcnl dcsp for stc in stc surf stc vol dcnl dcsp dcsp assert raises valueerror stc to data frame index foo bar dcnl dcsp dcsp for ncat ind in zip 1 0 time subject time dcnl dcsp dcsp dcsp df stc to data frame index ind dcnl dcsp dcsp dcsp assert true df index names ind if isinstance ind list else ind dcnl dcsp dcsp dcsp assert array equal df values tncat stc data dcnl dcsp dcsp dcsp assert true all c in time subject for c in df reset index columns 2
def test get peak dcsp n vert n times 10 5 dcnl dcsp vertices np arange n vert dtype np int np empty 0 dtype np int dcnl dcsp data rng randn n vert n times dcnl dcsp stc surf sourceestimate data vertices vertices tmin 0 tstep 1 subject sample dcnl dcsp stc vol volsourceestimate data vertices vertices0 tmin 0 tstep 1 subject sample dcnl dcsp for ii stc in enumerate stc surf stc vol dcnl dcsp dcsp assert raises valueerror stc get peak tmin 100 dcnl dcsp dcsp assert raises valueerror stc get peak tmax 90 dcnl dcsp dcsp assert raises valueerror stc get peak tmin 0 002 tmax 0 001 dcnl dcsp dcsp vert idx time idx stc get peak dcnl dcsp dcsp vertno np concatenate stc vertices if ii 0 else stc vertices dcnl dcsp dcsp assert true vert idx in vertno dcnl dcsp dcsp assert true time idx in stc times dcnl dcsp dcsp ch idx time idx stc get peak vert as index true time as index true dcnl dcsp dcsp assert true vert idx < stc data shape0 dcnl dcsp dcsp assert true time idx < len stc times
testing requires testing data dcnl def test mixed stc dcsp n 90 dcnl dcsp t 2 dcnl dcsp s 3 dcnl dcsp data rng randn n t dcnl dcsp vertno s np arange n s dcnl dcsp assert raises valueerror mixedsourceestimate data data vertices np arange n dcnl dcsp stc mixedsourceestimate data vertno 0 1 dcnl dcsp vol read source spaces fname vsrc dcnl dcsp assert raises valueerror stc plot surface src vol
def test decim dcsp rng np random randomstate 0 dcnl dcsp n epochs n channels n times 5 10 20 dcnl dcsp dec 1 dec 2 2 3 dcnl dcsp decim dec 1 dec 2 dcnl dcsp sfreq 1000 0 dcnl dcsp sfreq new sfreq decim dcnl dcsp data rng randn n epochs n channels n times dcnl dcsp events np array np arange n epochs 0 n epochs 1 n epochs t dcnl dcsp info create info n channels sfreq eeg dcnl dcsp info lowpass sfreq new float decim dcnl dcsp epochs epochsarray data info events dcnl dcsp data epochs epochs copy decimate decim get data dcnl dcsp data epochs 2 epochs copy decimate decim offset 1 get data dcnl dcsp data epochs 3 epochs decimate dec 1 decimate dec 2 get data dcnl dcsp assert array equal data epochs data decim dcnl dcsp assert array equal data epochs 2 data 1 decim dcnl dcsp assert array equal data epochs data epochs 3 dcnl dcsp raw read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp sfreq new raw info sfreq decim dcnl dcsp raw info lowpass sfreq new 4 0 dcnl dcsp picks pick types raw info meg true eeg true exclude dcnl dcsp epochs epochs raw events 1 0 2 0 5 picks picks preload true dcnl dcsp for offset in 0 1 dcnl dcsp dcsp ev ep decim epochs copy decimate decim offset average dcnl dcsp dcsp ev decim epochs average decimate decim offset dcnl dcsp dcsp expected times epochs timesoffset decim dcnl dcsp dcsp assert allclose ev decim times expected times dcnl dcsp dcsp assert allclose ev ep decim times expected times dcnl dcsp dcsp expected data epochs get data offset decim mean axis 0 dcnl dcsp dcsp assert allclose ev decim data expected data dcnl dcsp dcsp assert allclose ev ep decim data expected data dcnl dcsp dcsp assert equal ev decim info sfreq sfreq new dcnl dcsp dcsp assert array equal ev decim times expected times
requires version scipy 0 14 dcnl def test savgol filter dcsp h freq 10 0 dcnl dcsp evoked read evokeds fname 0 dcnl dcsp freqs fftpack fftfreq len evoked times 1 0 evoked info sfreq dcnl dcsp data np abs fftpack fft evoked data dcnl dcsp match mask np logical and freqs 0 freqs < h freq 2 0 dcnl dcsp mismatch mask np logical and freqs h freq 2 freqs < 50 0 dcnl dcsp assert raises valueerror evoked savgol filter evoked info sfreq dcnl dcsp evoked sg evoked copy savgol filter h freq dcnl dcsp data filt np abs fftpack fft evoked sg data dcnl dcsp assert allclose np mean data match mask 0 np mean data filt match mask 0 rtol 0 0001 atol 0 01 dcnl dcsp assert true np mean data mismatch mask np mean data filt mismatch mask 5 dcnl dcsp assert allclose data np abs fftpack fft evoked data atol 1e16
def test hash evoked dcsp ave read evokeds fname 0 dcnl dcsp ave 2 read evokeds fname 0 dcnl dcsp assert equal hash ave hash ave 2 dcnl dcsp assert true pickle dumps ave pickle dumps ave 2 dcnl dcsp ave 2 data 0 0 1 dcnl dcsp assert not equal hash ave hash ave 2
slow test dcnl def test io evoked dcsp tempdir tempdir dcnl dcsp ave read evokeds fname 0 dcnl dcsp write evokeds op join tempdir evokedave fif ave dcnl dcsp ave2 read evokeds op join tempdir evokedave fif 0 dcnl dcsp assert true np allclose ave data ave2 data atol 1e16 rtol 0 001 dcnl dcsp assert array almost equal ave times ave2 times dcnl dcsp assert equal ave nave ave2 nave dcnl dcsp assert equal ave aspect kind ave2 aspect kind dcnl dcsp assert equal ave kind ave2 kind dcnl dcsp assert equal ave last ave2 last dcnl dcsp assert equal ave first ave2 first dcnl dcsp assert true repr ave dcnl dcsp ave2 read evokeds fname gz 0 dcnl dcsp assert true np allclose ave data ave2 data atol 1e16 rtol 1e08 dcnl dcsp condition left dcsp auditory dcnl dcsp assert raises valueerror read evokeds fname condition kind stderr dcnl dcsp assert raises valueerror read evokeds fname condition kind standard error dcnl dcsp ave3 read evokeds fname condition dcnl dcsp assert array almost equal ave data ave3 data 19 dcnl dcsp aves1 read evokeds fname 1 2 dcnl dcsp aves2 read evokeds fname 1 3 dcnl dcsp aves3 read evokeds fname right dcsp auditory right dcsp visual dcnl dcsp write evokeds op join tempdir evokedave fif aves1 dcnl dcsp aves4 read evokeds op join tempdir evokedave fif dcnl dcsp for aves in aves2 aves3 aves4 dcnl dcsp dcsp for av1 av2 in zip aves1 aves dcnl dcsp dcsp dcsp assert array almost equal av1 data av2 data dcnl dcsp dcsp dcsp assert array almost equal av1 times av2 times dcnl dcsp dcsp dcsp assert equal av1 nave av2 nave dcnl dcsp dcsp dcsp assert equal av1 kind av2 kind dcnl dcsp dcsp dcsp assert equal av1 aspect kind av2 aspect kind dcnl dcsp dcsp dcsp assert equal av1 last av2 last dcnl dcsp dcsp dcsp assert equal av1 first av2 first dcnl dcsp dcsp dcsp assert equal av1 comment av2 comment dcnl dcsp fname2 op join tempdir testbadname fif dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp write evokeds fname2 ave dcnl dcsp dcsp read evokeds fname2 dcnl dcsp assert naming w test evoked py 2 dcnl dcsp assert raises typeerror evoked fname dcnl dcsp fname ms op join tempdir testave fif dcnl dcsp assert true ave info maxshield is false dcnl dcsp ave info maxshield true dcnl dcsp ave save fname ms dcnl dcsp assert raises valueerror read evokeds fname ms dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp aves read evokeds fname ms allow maxshield true dcnl dcsp assert true all elekta in str ww message for ww in w dcnl dcsp assert true all ave info maxshield is true for ave in aves dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp aves read evokeds fname ms allow maxshield yes dcnl dcsp assert equal len w 0 dcnl dcsp assert true all ave info maxshield is true for ave in aves
def test shift time evoked dcsp tempdir tempdir dcnl dcsp ave read evokeds fname 0 dcnl dcsp ave shift time 0 1 relative true dcnl dcsp write evokeds op join tempdir evokedave fif ave dcnl dcsp ave bshift read evokeds op join tempdir evokedave fif 0 dcnl dcsp ave bshift shift time 0 2 relative true dcnl dcsp write evokeds op join tempdir evokedave fif ave bshift dcnl dcsp ave fshift read evokeds op join tempdir evokedave fif 0 dcnl dcsp ave fshift shift time 0 1 relative true dcnl dcsp write evokeds op join tempdir evokedave fif ave fshift dcnl dcsp ave normal read evokeds fname 0 dcnl dcsp ave relative read evokeds op join tempdir evokedave fif 0 dcnl dcsp assert true np allclose ave normal data ave relative data atol 1e16 rtol 0 001 dcnl dcsp assert array almost equal ave normal times ave relative times 10 dcnl dcsp assert equal ave normal last ave relative last dcnl dcsp assert equal ave normal first ave relative first dcnl dcsp ave read evokeds fname 0 dcnl dcsp ave shift time 0 3 relative false dcnl dcsp write evokeds op join tempdir evokedave fif ave dcnl dcsp ave absolute read evokeds op join tempdir evokedave fif 0 dcnl dcsp assert true np allclose ave normal data ave absolute data atol 1e16 rtol 0 001 dcnl dcsp assert equal ave absolute first int 0 3 ave info sfreq
def test evoked resample dcsp tempdir tempdir dcnl dcsp ave read evokeds fname 0 dcnl dcsp sfreq normal ave info sfreq dcnl dcsp ave resample 2 sfreq normal npad 100 dcnl dcsp write evokeds op join tempdir evokedave fif ave dcnl dcsp ave up read evokeds op join tempdir evokedave fif 0 dcnl dcsp ave normal read evokeds fname 0 dcnl dcsp ave new read evokeds op join tempdir evokedave fif 0 dcnl dcsp ave new resample sfreq normal npad 100 dcnl dcsp assert array almost equal ave normal data ave new data 2 dcnl dcsp assert array almost equal ave normal times ave new times dcnl dcsp assert equal ave normal nave ave new nave dcnl dcsp assert equal ave normal aspect kind ave new aspect kind dcnl dcsp assert equal ave normal kind ave new kind dcnl dcsp assert equal ave normal last ave new last dcnl dcsp assert equal ave normal first ave new first dcnl dcsp assert true len ave up times 2 len ave normal times dcnl dcsp assert true ave up data shape1 2 ave normal data shape1
def test evoked detrend dcsp ave read evokeds fname 0 dcnl dcsp ave normal read evokeds fname 0 dcnl dcsp ave detrend 0 dcnl dcsp ave normal data np mean ave normal data axis 1 np newaxis dcnl dcsp picks pick types ave info meg true eeg true exclude bads dcnl dcsp assert true np allclose ave datapicks ave normal datapicks rtol 1e08 atol 1e16
requires pandas dcnl def test to data frame dcsp ave read evokeds fname 0 dcnl dcsp assert raises valueerror ave to data frame picks np arange 400 dcnl dcsp df ave to data frame dcnl dcsp assert true df columns ave ch names all dcnl dcsp df ave to data frame index none reset index dcnl dcsp assert true time in df columns dcnl dcsp assert array equal df values 1 ave data0 10000000000000 0 dcnl dcsp assert array equal df values 3 ave data2 1000000000000000 0
def test evoked proj dcsp for proj in true false dcnl dcsp dcsp ave read evokeds fname condition 0 proj proj dcnl dcsp dcsp assert true all p active proj for p in ave info projs dcnl dcsp dcsp if proj dcnl dcsp dcsp dcsp assert raises valueerror ave add proj remove existing true dcnl dcsp dcsp dcsp assert raises valueerror ave del proj 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp projs deepcopy ave info projs dcnl dcsp dcsp dcsp n proj len ave info projs dcnl dcsp dcsp dcsp ave del proj 0 dcnl dcsp dcsp dcsp assert true len ave info projs n proj 1 dcnl dcsp dcsp dcsp ave add proj projs remove existing false dcnl dcsp dcsp dcsp assert true len ave info projs n proj dcnl dcsp dcsp dcsp ave add proj projs 1 remove existing true dcnl dcsp dcsp dcsp assert true len ave info projs n proj 1 dcnl dcsp ave read evokeds fname condition 0 proj false dcnl dcsp data ave data copy dcnl dcsp ave apply proj dcnl dcsp assert allclose np dot ave projector data ave data
def test get peak dcsp evoked read evokeds fname condition 0 proj true dcnl dcsp assert raises valueerror evoked get peak ch type mag tmin 1 dcnl dcsp assert raises valueerror evoked get peak ch type mag tmax 0 9 dcnl dcsp assert raises valueerror evoked get peak ch type mag tmin 0 02 tmax 0 01 dcnl dcsp assert raises valueerror evoked get peak ch type mag mode foo dcnl dcsp assert raises runtimeerror evoked get peak ch type none mode foo dcnl dcsp assert raises valueerror evoked get peak ch type misc mode foo dcnl dcsp ch name time idx evoked get peak ch type mag dcnl dcsp assert true ch name in evoked ch names dcnl dcsp assert true time idx in evoked times dcnl dcsp ch name time idx evoked get peak ch type mag time as index true dcnl dcsp assert true time idx < len evoked times dcnl dcsp assert equal ch name meg dcsp 1421 dcnl dcsp assert raises valueerror evoked get peak ch type mag merge grads true dcnl dcsp ch name time idx evoked get peak ch type grad merge grads true dcnl dcsp assert equal ch name meg dcsp 244x dcnl dcsp data np array 0 0 1 0 2 0 0 0 3 0 0 dcnl dcsp times np array 0 1 0 2 0 3 dcnl dcsp ch idx time idx get peak data times mode abs dcnl dcsp assert equal ch idx 1 dcnl dcsp assert equal time idx 1 dcnl dcsp ch idx time idx get peak data 1 times mode neg dcnl dcsp assert equal ch idx 0 dcnl dcsp assert equal time idx 2 dcnl dcsp ch idx time idx get peak data times mode pos dcnl dcsp assert equal ch idx 0 dcnl dcsp assert equal time idx 2 dcnl dcsp assert raises valueerror get peak data + 1000 0 times mode neg dcnl dcsp assert raises valueerror get peak data 1000 0 times mode pos
def test drop channels mixin dcsp evoked read evokeds fname condition 0 proj true dcnl dcsp drop ch evoked ch names 3 dcnl dcsp ch names evoked ch names3 dcnl dcsp ch names orig evoked ch names dcnl dcsp dummy evoked copy drop channels drop ch dcnl dcsp assert equal ch names dummy ch names dcnl dcsp assert equal ch names orig evoked ch names dcnl dcsp assert equal len ch names orig len evoked data dcnl dcsp dummy2 evoked copy drop channels drop ch0 dcnl dcsp assert equal dummy2 ch names ch names orig1 dcnl dcsp evoked drop channels drop ch dcnl dcsp assert equal ch names evoked ch names dcnl dcsp assert equal len ch names len evoked data dcnl dcsp for ch names in 1 2 fake fake dcnl dcsp dcsp assert raises valueerror evoked drop channels ch names
def test pick channels mixin dcsp evoked read evokeds fname condition 0 proj true dcnl dcsp ch names evoked ch names 3 dcnl dcsp ch names orig evoked ch names dcnl dcsp dummy evoked copy pick channels ch names dcnl dcsp assert equal ch names dummy ch names dcnl dcsp assert equal ch names orig evoked ch names dcnl dcsp assert equal len ch names orig len evoked data dcnl dcsp evoked pick channels ch names dcnl dcsp assert equal ch names evoked ch names dcnl dcsp assert equal len ch names len evoked data dcnl dcsp evoked read evokeds fname condition 0 proj true dcnl dcsp assert true meg in evoked dcnl dcsp assert true eeg in evoked dcnl dcsp evoked pick types meg false eeg true dcnl dcsp assert true meg not in evoked dcnl dcsp assert true eeg in evoked dcnl dcsp assert true len evoked ch names 60
def test equalize channels dcsp evoked1 read evokeds fname condition 0 proj true dcnl dcsp evoked2 evoked1 copy dcnl dcsp ch names evoked1 ch names2 dcnl dcsp evoked1 drop channels evoked1 ch names 1 dcnl dcsp evoked2 drop channels evoked2 ch names1 2 dcnl dcsp my comparison evoked1 evoked2 dcnl dcsp equalize channels my comparison dcnl dcsp for e in my comparison dcnl dcsp dcsp assert equal ch names e ch names
def test arithmetic dcsp ev read evokeds fname condition 0 dcnl dcsp ev1 evokedarray np ones like ev data ev info ev times0 nave 20 dcnl dcsp ev2 evokedarray np ones like ev data ev info ev times0 nave 10 dcnl dcsp ev combine evoked ev1 ev2 weights nave dcnl dcsp assert equal ev nave ev1 nave + ev2 nave dcnl dcsp assert allclose ev data 1 0 3 0 np ones like ev data dcnl dcsp for weights in nave equal 0 5 0 5 dcnl dcsp dcsp ev combine evoked ev1 ev1 weights weights dcnl dcsp dcsp assert allclose ev data ev1 data dcnl dcsp dcsp assert equal ev nave 2 ev1 nave dcnl dcsp dcsp ev combine evoked ev1 ev1 weights weights dcnl dcsp dcsp assert allclose ev data 0 0 atol 1e20 dcnl dcsp dcsp assert equal ev nave 2 ev1 nave dcnl dcsp ev combine evoked ev1 ev1 weights equal dcnl dcsp assert allclose ev data 0 0 atol 1e20 dcnl dcsp assert equal ev nave 2 ev1 nave dcnl dcsp ev combine evoked ev1 ev2 weights equal dcnl dcsp expected int round 1 0 0 25 ev1 nave + 0 25 ev2 nave dcnl dcsp assert equal expected 27 dcnl dcsp assert equal ev nave expected dcnl dcsp old comment1 ev1 comment dcnl dcsp old comment2 ev2 comment dcnl dcsp ev1 comment none dcnl dcsp ev combine evoked ev1 ev2 weights 1 1 dcnl dcsp assert equal ev comment count unknown 2 dcnl dcsp assert true unknown in ev comment dcnl dcsp assert true dcsp + dcsp in ev comment dcnl dcsp ev1 comment old comment1 dcnl dcsp ev2 comment old comment2 dcnl dcsp ev combine evoked ev1 ev2 weights equal dcnl dcsp assert allclose ev data np zeros like ev1 data dcnl dcsp ev combine evoked ev1 ev2 weights 1 0 dcnl dcsp assert equal ev nave ev1 nave dcnl dcsp assert allclose ev data ev1 data dcnl dcsp ev combine evoked ev1 ev2 weights 1 1 dcnl dcsp assert allclose ev data 2 np ones like ev1 data dcnl dcsp assert raises valueerror combine evoked ev1 ev2 weights foo dcnl dcsp assert raises valueerror combine evoked ev1 ev2 weights 1 dcnl dcsp evoked1 evoked2 read evokeds fname condition 0 1 proj true dcnl dcsp ch names evoked1 ch names2 dcnl dcsp evoked1 info bads eeg dcsp 008 dcnl dcsp evoked1 drop channels evoked1 ch names 1 dcnl dcsp evoked2 drop channels evoked2 ch names1 2 dcnl dcsp gave grand average evoked1 evoked2 dcnl dcsp assert equal gave data shape len ch names evoked1 data shape1 dcnl dcsp assert equal ch names gave ch names dcnl dcsp assert equal gave nave 2 dcnl dcsp assert raises valueerror grand average 1 evoked1
def test array epochs dcsp tempdir tempdir dcnl dcsp rng np random randomstate 42 dcnl dcsp data1 rng randn 20 60 dcnl dcsp sfreq 1000 0 dcnl dcsp ch names eeg dcsp 03d i + 1 for i in range 20 dcnl dcsp types eeg 20 dcnl dcsp info create info ch names sfreq types dcnl dcsp evoked1 evokedarray data1 info tmin 0 01 dcnl dcsp tmp fname op join tempdir evkdaryave fif dcnl dcsp evoked1 save tmp fname dcnl dcsp evoked2 read evokeds tmp fname 0 dcnl dcsp data2 evoked2 data dcnl dcsp assert allclose data1 data2 dcnl dcsp assert allclose evoked1 times evoked2 times dcnl dcsp assert equal evoked1 first evoked2 first dcnl dcsp assert equal evoked1 last evoked2 last dcnl dcsp assert equal evoked1 kind evoked2 kind dcnl dcsp assert equal evoked1 nave evoked2 nave dcnl dcsp data3 data1np newaxis dcnl dcsp events np c 10 0 1 dcnl dcsp evoked3 epochsarray data3 info events events tmin 0 01 average dcnl dcsp assert allclose evoked1 data evoked3 data dcnl dcsp assert allclose evoked1 times evoked3 times dcnl dcsp assert equal evoked1 first evoked3 first dcnl dcsp assert equal evoked1 last evoked3 last dcnl dcsp assert equal evoked1 kind evoked3 kind dcnl dcsp assert equal evoked1 nave evoked3 nave dcnl dcsp assert raises typeerror evokedarray data1 info tmin 0 kind 1 dcnl dcsp assert raises valueerror evokedarray data1 info kind mean dcnl dcsp ch names eeg dcsp 03d i + 1 for i in range 19 dcnl dcsp types eeg 19 dcnl dcsp info create info ch names sfreq types dcnl dcsp assert raises valueerror evokedarray data1 info tmin 0 01
def test time as index dcsp evoked read evokeds fname condition 0 crop 0 1 0 1 dcnl dcsp assert array equal evoked time as index 0 1 0 1 use rounding true 0 len evoked times 1
def test add channels dcsp evoked read evokeds fname condition 0 dcnl dcsp evoked info buffer size sec none dcnl dcsp hpi coils event bits event bits np array 256 0 256 256 event bits np array 512 0 512 512 dcnl dcsp evoked info hpi subsystem dict hpi coils hpi coils ncoil 2 dcnl dcsp evoked eeg evoked copy pick types meg false eeg true dcnl dcsp evoked meg evoked copy pick types meg true dcnl dcsp evoked stim evoked copy pick types meg false stim true dcnl dcsp evoked eeg meg evoked copy pick types meg true eeg true dcnl dcsp evoked new evoked meg copy add channels evoked eeg evoked stim dcnl dcsp assert true all ch in evoked new ch names for ch in evoked stim ch names + evoked meg ch names dcnl dcsp evoked new evoked meg copy add channels evoked eeg dcnl dcsp assert true ch in evoked new ch names for ch in evoked ch names dcnl dcsp assert array equal evoked new data evoked eeg meg data dcnl dcsp assert true all ch not in evoked new ch names for ch in evoked stim ch names dcnl dcsp evoked badsf evoked eeg copy dcnl dcsp evoked badsf info sfreq 3 1415927 dcnl dcsp evoked eeg evoked eeg crop 0 1 0 1 dcnl dcsp assert raises runtimeerror evoked meg add channels evoked badsf dcnl dcsp assert raises assertionerror evoked meg add channels evoked eeg dcnl dcsp assert raises valueerror evoked meg add channels evoked meg dcnl dcsp assert raises assertionerror evoked meg add channels evoked badsf
def test evoked baseline dcsp evoked read evokeds fname condition 0 baseline none dcnl dcsp evoked evokedarray np ones like evoked data evoked info evoked times0 dcnl dcsp evoked apply baseline none none dcnl dcsp assert allclose evoked data np zeros like evoked data
def test cov mismatch dcsp raw read raw fif raw fname crop 0 5 load data dcnl dcsp events find events raw stim channel sti dcsp 014 dcnl dcsp raw pick channels raw ch names 5 dcnl dcsp raw add proj remove existing true dcnl dcsp epochs epochs raw events none tmin 0 2 tmax 0 0 preload true dcnl dcsp for kind in shift none dcnl dcsp dcsp epochs 2 epochs copy dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp compute covariance epochs epochs 2 dcnl dcsp dcsp dcsp assert equal len w 0 dcnl dcsp dcsp dcsp if kind shift dcnl dcsp dcsp dcsp dcsp epochs 2 info dev head t trans 3 3 + 0 001 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp epochs 2 info dev head t none dcnl dcsp dcsp dcsp assert raises valueerror compute covariance epochs epochs 2 dcnl dcsp dcsp dcsp assert equal len w 0 dcnl dcsp dcsp dcsp compute covariance epochs epochs 2 on mismatch ignore dcnl dcsp dcsp dcsp assert equal len w 0 dcnl dcsp dcsp dcsp compute covariance epochs epochs 2 on mismatch warn dcnl dcsp dcsp dcsp assert raises valueerror compute covariance epochs on mismatch x dcnl dcsp dcsp assert true any transform dcsp mismatch in str ww message for ww in w dcnl dcsp epochs info dev head t none dcnl dcsp epochs 2 info dev head t none dcnl dcsp compute covariance epochs epochs 2 method none
def test cov order dcsp info read info raw fname dcnl dcsp info bads + meg dcsp 0113 dcnl dcsp ch names info ch names pick for pick in pick types info meg false eeg true dcnl dcsp cov read cov cov fname dcnl dcsp prepare noise cov cov info ch names verbose error dcnl dcsp cov reorder cov copy dcnl dcsp order np random randomstate 0 permutation np arange len cov ch names dcnl dcsp cov reorder names cov names ii for ii in order dcnl dcsp cov reorder data cov data order order dcnl dcsp assert reorder cov reorder cov order dcnl dcsp cov reg regularize cov info dcnl dcsp cov reg reorder regularize cov reorder info dcnl dcsp assert reorder cov reg reorder cov reg order dcnl dcsp cov prep prepare noise cov cov info ch names dcnl dcsp cov prep reorder prepare noise cov cov info ch names dcnl dcsp assert reorder cov prep cov prep reorder order np arange len cov prep names dcnl dcsp whitener w ch names compute whitener cov info dcnl dcsp whitener 2 w ch names 2 compute whitener cov reorder info dcnl dcsp assert array equal w ch names 2 w ch names dcnl dcsp assert allclose whitener 2 whitener dcnl dcsp evoked read evokeds ave fname 0 dcnl dcsp evoked white whiten evoked evoked cov dcnl dcsp evoked white 2 whiten evoked evoked cov reorder dcnl dcsp assert allclose evoked white 2 data evoked white data
def assert reorder cov new cov orig order dcsp inv order np argsort order dcnl dcsp assert array equal cov new names ii for ii in inv order cov orig names dcnl dcsp assert allclose cov new data inv order inv order cov orig data atol 1e20
def test ad hoc cov dcsp tempdir tempdir dcnl dcsp out fname op join tempdir testcov fif dcnl dcsp evoked read evokeds ave fname 0 dcnl dcsp cov make ad hoc cov evoked info dcnl dcsp cov save out fname dcnl dcsp assert true covariance in repr cov dcnl dcsp cov2 read cov out fname dcnl dcsp assert array almost equal cov data cov2 data
def test io cov dcsp tempdir tempdir dcnl dcsp cov read cov cov fname dcnl dcsp cov method empirical dcnl dcsp cov loglik np inf dcnl dcsp cov save op join tempdir testcov fif dcnl dcsp cov2 read cov op join tempdir testcov fif dcnl dcsp assert array almost equal cov data cov2 data dcnl dcsp assert equal cov method cov2 method dcnl dcsp assert equal cov loglik cov2 loglik dcnl dcsp assert true covariance in repr cov dcnl dcsp cov2 read cov cov gz fname dcnl dcsp assert array almost equal cov data cov2 data dcnl dcsp cov2 save op join tempdir testcov fif gz dcnl dcsp cov2 read cov op join tempdir testcov fif gz dcnl dcsp assert array almost equal cov data cov2 data dcnl dcsp cov bads eeg dcsp 039 dcnl dcsp cov sel pick channels cov cov exclude cov bads dcnl dcsp assert true cov sel dim len cov data len cov bads dcnl dcsp assert true cov sel data shape cov sel dim cov sel dim dcnl dcsp cov sel save op join tempdir testcov fif dcnl dcsp cov2 read cov cov gz fname dcnl dcsp assert array almost equal cov data cov2 data dcnl dcsp cov2 save op join tempdir testcov fif gz dcnl dcsp cov2 read cov op join tempdir testcov fif gz dcnl dcsp assert array almost equal cov data cov2 data dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp cov badname op join tempdir testbadname fif gz dcnl dcsp dcsp write cov cov badname cov dcnl dcsp dcsp read cov cov badname dcnl dcsp assert naming w test cov py 2
def test cov estimation on raw dcsp tempdir tempdir dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp cov mne read cov erm cov fname dcnl dcsp for method in none empirical dcnl dcsp dcsp cov compute raw covariance raw tstep none method method dcnl dcsp dcsp assert equal cov ch names cov mne ch names dcnl dcsp dcsp assert equal cov nfree cov mne nfree dcnl dcsp dcsp assert snr cov data cov mne data 10000 0 dcnl dcsp dcsp cov compute raw covariance raw method method dcnl dcsp dcsp assert equal cov nfree cov mne nfree 119 dcnl dcsp dcsp assert snr cov data cov mne data 100 0 dcnl dcsp dcsp cov save op join tempdir testcov fif dcnl dcsp dcsp cov read read cov op join tempdir testcov fif dcnl dcsp dcsp assert true cov read ch names cov ch names dcnl dcsp dcsp assert true cov read nfree cov nfree dcnl dcsp dcsp assert array almost equal cov data cov read data dcnl dcsp dcsp raw pick raw copy pick channels raw ch names 5 dcnl dcsp dcsp raw pick info normalize proj dcnl dcsp dcsp cov compute raw covariance raw pick tstep none method method dcnl dcsp dcsp assert true cov mne ch names 5 cov ch names dcnl dcsp dcsp assert snr cov data cov mne data 5 5 10000 0 dcnl dcsp dcsp cov compute raw covariance raw pick method method dcnl dcsp dcsp assert snr cov data cov mne data 5 5 90 dcnl dcsp dcsp raw 2 read raw fif raw fname crop 0 1 dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp cov compute raw covariance raw 2 method method dcnl dcsp dcsp assert true any too dcsp few dcsp samples in str ww message for ww in w dcnl dcsp dcsp assert raises valueerror compute raw covariance raw tstep none method empirical reject dict eog 0 0002 dcnl dcsp dcsp cov compute raw covariance raw copy crop 0 10 0 tstep none method method reject dict eog 0 001
slow test dcnl requires sklearn 0 15 dcnl def test cov estimation on raw reg dcsp raw read raw fif raw fname preload true dcnl dcsp raw info sfreq 10 0 dcnl dcsp raw rawarray raw data 10 copy raw info dcnl dcsp cov mne read cov erm cov fname dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp cov compute raw covariance raw tstep 5 0 method diagonal fixed dcnl dcsp assert snr cov data cov mne data 5
slow test dcnl def test cov estimation with triggers dcsp tempdir tempdir dcnl dcsp raw read raw fif raw fname dcnl dcsp raw set eeg reference projection true load data dcnl dcsp events find events raw stim channel sti dcsp 014 dcnl dcsp event ids 1 2 3 4 dcnl dcsp reject dict grad 1e09 mag 4e12 eeg 8e05 eog 0 00015 dcnl dcsp events merged merge events events event ids 1234 dcnl dcsp epochs epochs raw events merged 1234 tmin 0 2 tmax 0 baseline 0 2 0 1 proj true reject reject preload true dcnl dcsp cov compute covariance epochs keep sample mean true dcnl dcsp assert cov cov read cov cov km fname dcnl dcsp cov tmin tmax compute covariance epochs tmin 0 19 tmax 0 01 dcnl dcsp assert true np all cov data cov tmin tmax data dcnl dcsp err linalg norm cov data cov tmin tmax data ord fro linalg norm cov tmin tmax data ord fro dcnl dcsp assert true err < 0 05 msg err dcnl dcsp epochs epochs raw events ev id tmin 0 2 tmax 0 baseline 0 2 0 1 proj true reject reject for ev id in event ids dcnl dcsp cov2 compute covariance epochs keep sample mean true dcnl dcsp assert array almost equal cov data cov2 data dcnl dcsp assert true cov ch names cov2 ch names dcnl dcsp cov compute covariance epochs keep sample mean false dcnl dcsp assert cov cov read cov cov fname nfree false dcnl dcsp method params empirical assume centered false dcnl dcsp assert raises valueerror compute covariance epochs keep sample mean false method params method params dcnl dcsp assert raises valueerror compute covariance epochs keep sample mean false method factor analysis dcnl dcsp cov save op join tempdir testcov fif dcnl dcsp cov read read cov op join tempdir testcov fif dcnl dcsp assert cov cov cov read 1e05 dcnl dcsp epochs epochs raw events 1 none tmin 0 2 tmax 0 baseline 0 2 0 1 proj true epochs raw events 1 none tmin 0 2 tmax 0 baseline 0 2 0 1 proj false dcnl dcsp assert raises valueerror compute covariance epochs dcnl dcsp assert raises valueerror compute covariance epochs projs none dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp cov compute covariance epochs projs epochs0 info projs dcnl dcsp dcsp cov compute covariance epochs projs dcnl dcsp assert equal len w 2 dcnl dcsp epochs epochs raw events dict a 1 b 2 c 3 d 4 tmin 0 01 tmax 0 proj true reject reject preload true dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp compute covariance epochs dcnl dcsp dcsp compute covariance epochs projs dcnl dcsp assert raises typeerror compute covariance epochs projs foo dcnl dcsp assert raises typeerror compute covariance epochs projs foo
def test arithmetic cov dcsp cov read cov cov fname dcnl dcsp cov sum cov + cov dcnl dcsp assert array almost equal 2 cov nfree cov sum nfree dcnl dcsp assert array almost equal 2 cov data cov sum data dcnl dcsp assert true cov ch names cov sum ch names dcnl dcsp cov + cov dcnl dcsp assert array almost equal cov sum nfree cov nfree dcnl dcsp assert array almost equal cov sum data cov data dcnl dcsp assert true cov sum ch names cov ch names
def test regularize cov dcsp raw read raw fif raw fname dcnl dcsp raw info bads append raw ch names0 dcnl dcsp noise cov read cov cov fname dcnl dcsp reg noise cov regularize noise cov raw info mag 0 1 grad 0 1 eeg 0 1 proj true exclude bads dcnl dcsp assert true noise cov dim reg noise cov dim dcnl dcsp assert true noise cov data shape reg noise cov data shape dcnl dcsp assert true np mean noise cov data < reg noise cov data < 0 08
def test whiten evoked dcsp evoked read evokeds ave fname condition 0 baseline none 0 proj true dcnl dcsp cov read cov cov fname dcnl dcsp picks pick types evoked info meg true eeg true ref meg false exclude bads dcnl dcsp noise cov regularize cov evoked info grad 0 1 mag 0 1 eeg 0 1 exclude bads dcnl dcsp evoked white whiten evoked evoked noise cov picks diag true dcnl dcsp whiten baseline data evoked white datapicks evoked times < 0 dcnl dcsp mean baseline np mean np abs whiten baseline data axis 1 dcnl dcsp assert true np all mean baseline < 1 0 dcnl dcsp assert true np all mean baseline 0 2 dcnl dcsp cov bad pick channels cov cov include evoked ch names 10 dcnl dcsp assert raises runtimeerror whiten evoked evoked cov bad picks
slow test dcnl def test rank dcsp evoked read evokeds ave fname condition 0 baseline none 0 proj false dcnl dcsp cov read cov cov fname dcnl dcsp ch names ch for ch in evoked info ch names if 053 not in ch and ch startswith eeg dcnl dcsp cov prepare noise cov cov evoked info ch names none dcnl dcsp assert equal cov eig 0 0 0 dcnl dcsp assert true cov eig 1 0 all dcnl dcsp raw sample read raw fif raw fname dcnl dcsp raw sss read raw fif hp fif fname dcnl dcsp raw sss add proj compute proj raw raw sss dcnl dcsp cov sample compute raw covariance raw sample dcnl dcsp cov sample proj compute raw covariance raw sample copy apply proj dcnl dcsp cov sss compute raw covariance raw sss dcnl dcsp cov sss proj compute raw covariance raw sss copy apply proj dcnl dcsp picks all sample pick types raw sample info meg true eeg true dcnl dcsp picks all sss pick types raw sss info meg true eeg true dcnl dcsp info sample pick info raw sample info picks all sample dcnl dcsp picks stack sample eeg pick types info sample meg false eeg true dcnl dcsp picks stack sample + meg pick types info sample meg true dcnl dcsp picks stack sample + all pick types info sample meg true eeg true dcnl dcsp info sss pick info raw sss info picks all sss dcnl dcsp picks stack somato eeg pick types info sss meg false eeg true dcnl dcsp picks stack somato + meg pick types info sss meg true dcnl dcsp picks stack somato + all pick types info sss meg true eeg true dcnl dcsp iter tests list itt product cov sample picks stack sample info sample cov sample proj picks stack sample info sample cov sss picks stack somato info sss cov sss proj picks stack somato info sss dict mag 1000000000000000 0 grad 10000000000000 0 eeg 1000000 0 dcnl dcsp for cov picks list this info scalings in iter tests dcnl dcsp dcsp for ch type picks in picks list dcnl dcsp dcsp dcsp this very info pick info this info picks dcnl dcsp dcsp dcsp this projs c active and len set c data col names intersection set this very info ch names 0 for c in cov projs dcnl dcsp dcsp dcsp n projs sum this projs dcnl dcsp dcsp dcsp ch types channel type this very info idx for idx in range len picks dcnl dcsp dcsp dcsp n eeg n mag n grad ch types count k for k in eeg mag grad dcnl dcsp dcsp dcsp n meg n mag + n grad dcnl dcsp dcsp dcsp if ch type in all eeg dcnl dcsp dcsp dcsp dcsp n projs eeg 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp n projs eeg 0 dcnl dcsp dcsp dcsp if len this very info proc history 0 dcnl dcsp dcsp dcsp dcsp mf this very info proc history 0 max info dcnl dcsp dcsp dcsp dcsp n free get sss rank mf dcnl dcsp dcsp dcsp dcsp if mag not in ch types and grad not in ch types dcnl dcsp dcsp dcsp dcsp dcsp n free 0 dcnl dcsp dcsp dcsp dcsp expected rank n free + n eeg dcnl dcsp dcsp dcsp dcsp if n projs 0 and ch type in all eeg dcnl dcsp dcsp dcsp dcsp dcsp expected rank n projs eeg dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp expected rank n meg + n eeg n projs dcnl dcsp dcsp dcsp c cov data np ix picks picks dcnl dcsp dcsp dcsp est rank estimate rank meeg cov c this very info scalings scalings dcnl dcsp dcsp dcsp assert equal expected rank est rank
def test cov scaling dcsp evoked read evokeds ave fname condition 0 baseline none 0 proj true dcnl dcsp cov read cov cov fname data dcnl dcsp cov2 read cov cov fname data dcnl dcsp assert array equal cov cov2 dcnl dcsp evoked pick channels evoked ch namesk for k in pick types evoked info meg true eeg true dcnl dcsp picks list picks by type evoked info dcnl dcsp scalings dict mag 1000000000000000 0 grad 10000000000000 0 eeg 1000000 0 dcnl dcsp apply scaling cov cov2 picks list scalings scalings dcnl dcsp apply scaling cov cov picks list scalings scalings dcnl dcsp assert array equal cov cov2 dcnl dcsp assert true cov max 1 dcnl dcsp undo scaling cov cov2 picks list scalings scalings dcnl dcsp undo scaling cov cov picks list scalings scalings dcnl dcsp assert array equal cov cov2 dcnl dcsp assert true cov max < 1 dcnl dcsp data evoked data copy dcnl dcsp apply scaling array data picks list scalings scalings dcnl dcsp undo scaling array data picks list scalings scalings dcnl dcsp assert allclose data evoked data atol 1e20
requires sklearn 0 15 dcnl def test auto low rank dcsp n samples n features rank 400 10 5 dcnl dcsp sigma 0 1 dcnl dcsp def get data n samples n features rank sigma dcnl dcsp dcsp rng np random randomstate 42 dcnl dcsp dcsp w rng randn n features n features dcnl dcsp dcsp x rng randn n samples rank dcnl dcsp dcsp u linalg svd w copy dcnl dcsp dcsp x np dot x u rank t dcnl dcsp dcsp sigmas sigma rng rand n features + sigma 2 0 dcnl dcsp dcsp x + rng randn n samples n features sigmas dcnl dcsp dcsp return x dcnl dcsp x get data n samples n samples n features n features rank rank sigma sigma dcnl dcsp method params iter n components 4 5 6 dcnl dcsp cv 3 dcnl dcsp n jobs 1 dcnl dcsp mode factor analysis dcnl dcsp rescale 100000000 0 dcnl dcsp x rescale dcnl dcsp est info auto low rank model x mode mode n jobs n jobs method params method params cv cv dcnl dcsp assert equal info best rank dcnl dcsp x get data n samples n samples n features n features rank rank sigma sigma dcnl dcsp method params iter n components n features + 5 dcnl dcsp msg you dcsp are dcsp trying dcsp to dcsp estimate dcsp i dcsp components dcsp on dcsp matrix dcsp with dcsp i dcsp features dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp auto low rank model x mode mode n jobs n jobs method params method params cv cv dcnl dcsp dcsp assert equal len w 1 dcnl dcsp dcsp assert equal msg n features + 5 n features s w0 message dcnl dcsp method params iter n components n features + 5 dcnl dcsp assert raises valueerror auto low rank model x mode foo n jobs n jobs method params method params cv cv
slow test dcnl requires sklearn 0 15 dcnl def test compute covariance auto reg dcsp raw read raw fif raw fname preload true dcnl dcsp raw resample 100 npad auto dcnl dcsp events find events raw stim channel sti dcsp 014 dcnl dcsp event ids 1 2 3 4 dcnl dcsp reject dict mag 4e12 dcnl dcsp events merged merge events events event ids 1234 dcnl dcsp picks pick types raw info meg mag eeg false 10 dcnl dcsp raw pick channels raw ch namespick for pick in picks dcnl dcsp raw info normalize proj dcnl dcsp epochs epochs raw events merged 1234 tmin 0 2 tmax 0 baseline 0 2 0 1 proj true reject reject preload true dcnl dcsp epochs epochs crop none 0 10 dcnl dcsp method params dict factor analysis dict iter n components 3 pca dict iter n components 3 dcnl dcsp covs compute covariance epochs method auto method params method params return estimators true dcnl dcsp logliks c loglik for c in covs dcnl dcsp assert true np diff logliks max < 0 dcnl dcsp methods empirical factor analysis ledoit wolf pca dcnl dcsp cov3 compute covariance epochs method methods method params method params projs none return estimators true dcnl dcsp assert equal set c method for c in cov3 set methods dcnl dcsp assert raises valueerror compute covariance epochs method pizza dcnl dcsp assert raises valueerror compute covariance epochs method shrunk scalings dict misc 123
def test tps dcsp az np linspace 0 0 2 np pi 20 endpoint false dcnl dcsp pol np linspace 0 np pi 12 1 1 dcnl dcsp sph np array np meshgrid 1 az pol indexing ij dcnl dcsp sph shape 3 1 dcnl dcsp assert equal sph shape1 200 dcnl dcsp source sph to cart sph t dcnl dcsp destination source copy dcnl dcsp destination 2 dcnl dcsp destination 0 + 1 dcnl dcsp warp sphericalsurfacewarp dcnl dcsp assert true no dcsp in repr warp dcnl dcsp warp fit source 3 destination 2 dcnl dcsp assert true oct5 in repr warp dcnl dcsp destination est warp transform source dcnl dcsp assert allclose destination est destination atol 0 001
testing requires testing data dcnl def test get trans dcsp trans read trans fname dcnl dcsp trans invert transform trans dcnl dcsp trans 2 get trans fname trans 0 dcnl dcsp assert equal trans from trans 2 from dcnl dcsp assert equal trans to trans 2 to dcnl dcsp assert allclose trans trans trans 2 trans rtol 1e05 atol 1e05
testing requires testing data dcnl def test io trans dcsp tempdir tempdir dcnl dcsp os mkdir op join tempdir sample dcnl dcsp assert raises runtimeerror find trans sample subjects dir tempdir dcnl dcsp trans0 read trans fname dcnl dcsp fname1 op join tempdir sample testtrans fif dcnl dcsp trans0 save fname1 dcnl dcsp assert true fname1 find trans sample subjects dir tempdir dcnl dcsp trans1 read trans fname1 dcnl dcsp assert true trans0 from trans1 from dcnl dcsp assert true trans0 to trans1 to dcnl dcsp assert array equal trans0 trans trans1 trans dcnl dcsp assert raises ioerror read trans fname eve dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp fname2 op join tempdir transtestbadname fif dcnl dcsp dcsp write trans fname2 trans0 dcnl dcsp assert naming w test transforms py 1
def test get ras to neuromag trans dcsp rng np random randomstate 0 dcnl dcsp anterior 0 1 0 dcnl dcsp left 1 0 0 dcnl dcsp right 0 8 0 0 dcnl dcsp up 0 0 1 dcnl dcsp rand pts rng uniform 1 1 3 3 dcnl dcsp pts np vstack anterior left right up rand pts dcnl dcsp rx ry rz tx ty tz rng uniform 2 np pi 2 np pi 6 dcnl dcsp trans np dot translation tx ty tz rotation rx ry rz dcnl dcsp pts changed apply trans trans pts dcnl dcsp nas lpa rpa pts changed 3 dcnl dcsp hsp trans get ras to neuromag trans nas lpa rpa dcnl dcsp pts restored apply trans hsp trans pts changed dcnl dcsp err neuromag dcsp transformation dcsp failed dcnl dcsp assert allclose pts restored pts atol 1e06 err msg err
def cartesian to sphere x y z dcsp hypotxy np hypot x y dcnl dcsp r np hypot hypotxy z dcnl dcsp elev np arctan2 z hypotxy dcnl dcsp az np arctan2 y x dcnl dcsp return az elev r
def sphere to cartesian theta phi r dcsp z r np sin phi dcnl dcsp rcos phi r np cos phi dcnl dcsp x rcos phi np cos theta dcnl dcsp y rcos phi np sin theta dcnl dcsp return x y z
def test sph to cart dcsp r theta phi 11 0 0 0 np pi 2 0 dcnl dcsp z r np cos phi dcnl dcsp rsin phi r np sin phi dcnl dcsp x rsin phi np cos theta dcnl dcsp y rsin phi np sin theta dcnl dcsp coord sph to cart np array r theta phi 0 dcnl dcsp assert allclose coord x y z atol 1e07 dcnl dcsp assert allclose coord r 0 0 atol 1e07 dcnl dcsp rng np random randomstate 0 dcnl dcsp coords rng randn 10 3 dcnl dcsp assert allclose sph to cart cart to sph coords coords atol 1e05 dcnl dcsp for coord in coords dcnl dcsp dcsp sph cart to sph coordnp newaxis dcnl dcsp dcsp cart sph to cart sph dcnl dcsp dcsp sph old np array cartesian to sphere coord dcnl dcsp dcsp cart old sphere to cartesian sph old dcnl dcsp dcsp sph old1 np pi 2 0 sph old1 dcnl dcsp dcsp assert allclose sph0 sph old2 0 1 atol 1e07 dcnl dcsp dcsp assert allclose cart0 cart old atol 1e07 dcnl dcsp dcsp assert allclose cart0 coord atol 1e07
def polar to cartesian theta r dcsp x r np cos theta dcnl dcsp y r np sin theta dcnl dcsp return x y
def test polar to cartesian dcsp r 1 dcnl dcsp theta np pi dcnl dcsp x r np cos theta dcnl dcsp y r np sin theta dcnl dcsp coord pol to cart np array r theta 0 dcnl dcsp assert allclose coord x y atol 1e07 dcnl dcsp assert allclose coord 1 0 atol 1e07 dcnl dcsp assert allclose coord polar to cartesian theta r atol 1e07 dcnl dcsp rng np random randomstate 0 dcnl dcsp r rng randn 10 dcnl dcsp theta rng rand 10 2 np pi dcnl dcsp polar np array r theta t dcnl dcsp assert allclose polar to cartesian p1 p0 for p in polar pol to cart polar atol 1e07
def topo to sphere theta radius dcsp sph phi 0 5 radius 180 dcnl dcsp sph theta theta dcnl dcsp return sph phi sph theta
def test topo to sph dcsp rng np random randomstate 0 dcnl dcsp angles rng rand 10 360 dcnl dcsp radii rng rand 10 dcnl dcsp angles0 30 dcnl dcsp radii0 0 25 dcnl dcsp sph topo to sph np array angles radii t dcnl dcsp new sph to cart sph dcnl dcsp new 0 1 new 1 0 1 1 dcnl dcsp for ii angle radius in enumerate zip angles radii dcnl dcsp dcsp sph phi sph theta topo to sphere angle radius dcnl dcsp dcsp if ii 0 dcnl dcsp dcsp dcsp assert allclose topo to sphere angle radius 45 30 dcnl dcsp dcsp azimuth sph theta 180 0 np pi dcnl dcsp dcsp elevation sph phi 180 0 np pi dcnl dcsp dcsp assert allclose sphii 1 0 azimuth np pi 2 0 elevation atol 1e07 dcnl dcsp dcsp r np ones like radius dcnl dcsp dcsp x y z sphere to cartesian azimuth elevation r dcnl dcsp dcsp pos y x z dcnl dcsp dcsp if ii 0 dcnl dcsp dcsp dcsp expected np array 1 0 2 0 np sqrt 3 2 0 1 0 dcnl dcsp dcsp dcsp expected np sqrt 2 dcnl dcsp dcsp dcsp assert allclose pos expected atol 1e07 dcnl dcsp dcsp assert allclose pos newii atol 1e07
def test rotation dcsp tests 0 0 1 0 5 0 5 0 5 np pi 0 1 5 dcnl dcsp for rot in tests dcnl dcsp dcsp x y z rot dcnl dcsp dcsp m rotation3d x y z dcnl dcsp dcsp m4 rotation x y z dcnl dcsp dcsp assert array equal m m4 3 3 dcnl dcsp dcsp back rotation angles m dcnl dcsp dcsp assert equal back rot dcnl dcsp dcsp back4 rotation angles m4 dcnl dcsp dcsp assert equal back4 rot
def test rotation3d align z axis dcsp inp zs 0 0 1 0 1 0 1 0 0 0 0 1 0 75071668 0 62183808 0 22302888 dcnl dcsp exp res 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 53919688 0 38169517 0 75071668 0 38169517 0 683832 0 62183808 0 75071668 0 62183808 0 22302888 dcnl dcsp for res z in zip exp res inp zs dcnl dcsp dcsp assert allclose res rotation3d align z axis z atol 1e07
testing requires testing data dcnl def test combine dcsp trans read trans fname dcnl dcsp inv invert transform trans dcnl dcsp combine transforms trans inv trans from trans from dcnl dcsp assert raises runtimeerror combine transforms trans inv trans to trans from dcnl dcsp assert raises runtimeerror combine transforms trans inv trans from trans to dcnl dcsp assert raises runtimeerror combine transforms trans trans trans from trans to
def test quaternions dcsp rots np eye 3 dcnl dcsp for fname in test fif fname ctf fname hp fif fname dcnl dcsp dcsp rots + read info fname dev head t trans 3 3 dcnl dcsp rots + np array 0 99978541 0 01873462 0 00898756 0 01873462 0 62565561 0 77987608 0 00898756 0 77987608 0 62587152 dcnl dcsp rots + np array 0 62565561 0 01873462 0 77987608 0 01873462 0 99978541 0 00898756 0 77987608 0 00898756 0 62587152 dcnl dcsp rots + np array 0 99978541 0 00898756 0 01873462 0 00898756 0 62587152 0 77987608 0 01873462 0 77987608 0 62565561 dcnl dcsp for rot in rots dcnl dcsp dcsp assert allclose rot quat to rot rot to quat rot rtol 1e05 atol 1e05 dcnl dcsp dcsp rot rotnp newaxis np newaxis dcnl dcsp dcsp assert allclose rot quat to rot rot to quat rot rtol 1e05 atol 1e05 dcnl dcsp for ii in range 3 dcnl dcsp dcsp for jj in range 3 dcnl dcsp dcsp dcsp a np zeros 3 dcnl dcsp dcsp dcsp b np zeros 3 dcnl dcsp dcsp dcsp aii 1 0 dcnl dcsp dcsp dcsp bjj 1 0 dcnl dcsp dcsp dcsp expected np pi if ii jj else 0 0 dcnl dcsp dcsp dcsp assert allclose angle between quats a b expected atol 1e05
def test vector rotation dcsp x np array 1 0 0 0 0 0 dcnl dcsp y np array 0 0 1 0 0 0 dcnl dcsp rot find vector rotation x y dcnl dcsp assert array equal rot 0 1 0 1 0 0 0 0 1 dcnl dcsp quat 1 rot to quat rot dcnl dcsp quat 2 rot to quat np eye 3 dcnl dcsp assert allclose angle between quats quat 1 quat 2 np pi 2 0
def test filtfilt dcsp x np r 1 np zeros 100 dcnl dcsp y filtfilt 1 0 1 0 x padlen 0 dcnl dcsp assert array equal x y dcnl dcsp y mne sosfiltfilt np array 1 0 0 0 0 0 1 0 0 0 0 x padlen 0 dcnl dcsp assert array equal x y
requires version scipy 0 17 1 dcnl def test spherical harmonics dcsp az pol np meshgrid np linspace 0 2 np pi 30 np linspace 0 np pi 20 dcnl dcsp for degree in range 1 10 dcnl dcsp dcsp for order in range 0 degree + 1 dcnl dcsp dcsp dcsp sph sph harm order degree az pol dcnl dcsp dcsp dcsp sph scipy sph harm order degree az pol dcnl dcsp dcsp dcsp assert allclose sph sph scipy atol 1e07
def get data preload false dcsp raw read raw fif raw fname preload preload dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true eeg true stim true ecg true eog true include sti dcsp 014 exclude bads dcnl dcsp return raw events picks
def test hierarchical dcsp raw events picks get data dcnl dcsp event id a 1 1 a 2 2 b 1 3 b 2 4 dcnl dcsp epochs epochs raw events event id preload true dcnl dcsp epochs a1 epochs a 1 dcnl dcsp epochs a2 epochs a 2 dcnl dcsp epochs b1 epochs b 1 dcnl dcsp epochs b2 epochs b 2 dcnl dcsp epochs a epochs a dcnl dcsp assert equal len epochs a len epochs a1 + len epochs a2 dcnl dcsp epochs b epochs b dcnl dcsp assert equal len epochs b len epochs b1 + len epochs b2 dcnl dcsp epochs 1 epochs 1 dcnl dcsp assert equal len epochs 1 len epochs a1 + len epochs b1 dcnl dcsp epochs 2 epochs 2 dcnl dcsp assert equal len epochs 2 len epochs a2 + len epochs b2 dcnl dcsp epochs all epochs 1 2 dcnl dcsp assert equal len epochs len epochs all dcnl dcsp assert array equal epochs get data epochs all get data
slow test dcnl testing requires testing data dcnl def test average movements dcsp crop 0 0 10 0 dcnl dcsp origin 0 0 0 0 0 04 dcnl dcsp raw read raw fif fname raw move allow maxshield yes dcnl dcsp raw info bads + meg2443 dcnl dcsp raw crop crop load data dcnl dcsp raw filter none 20 fir design firwin dcnl dcsp events make fixed length events raw event id dcnl dcsp picks pick types raw info meg true eeg true stim true ecg true eog true exclude dcnl dcsp epochs epochs raw events event id tmin tmax picks picks proj false preload true dcnl dcsp epochs proj epochs raw events 1 event id tmin tmax picks picks proj true preload true dcnl dcsp raw sss stat maxwell filter raw origin origin regularize none bad condition ignore dcnl dcsp del raw dcnl dcsp epochs sss stat epochs raw sss stat events event id tmin tmax picks picks proj false dcnl dcsp evoked sss stat epochs sss stat average dcnl dcsp del raw sss stat epochs sss stat dcnl dcsp head pos read head pos fname raw move pos dcnl dcsp trans epochs info dev head t trans dcnl dcsp head pos stat np array trans 3 3 np array trans 3 3 np array 0 0 dcnl dcsp assert raises typeerror average movements epochs none dcnl dcsp evoked move non average movements epochs head pos head pos weight all false origin origin dcnl dcsp evoked move all average movements epochs head pos head pos weight all true origin origin dcnl dcsp evoked stat all average movements epochs head pos head pos stat weight all true origin origin dcnl dcsp evoked std epochs average dcnl dcsp for ev in evoked move non evoked move all evoked stat all dcnl dcsp dcsp assert equal ev nave evoked std nave dcnl dcsp dcsp assert equal len ev info bads 0 dcnl dcsp for ev in evoked move non evoked stat all dcnl dcsp dcsp assert meg snr ev evoked std 0 0 0 1 dcnl dcsp dcsp assert raises assertionerror assert meg snr ev evoked std 1 0 1 0 dcnl dcsp meg picks pick types evoked std info meg true exclude dcnl dcsp assert allclose evoked move non datameg picks evoked move all datameg picks atol 1e20 dcnl dcsp raw sss read raw fif fname raw movecomp sss dcnl dcsp raw sss crop crop load data dcnl dcsp raw sss filter none 20 fir design firwin dcnl dcsp picks sss pick types raw sss info meg true eeg true stim true ecg true eog true exclude dcnl dcsp assert array equal picks picks sss dcnl dcsp epochs sss epochs raw sss events event id tmin tmax picks picks sss proj false dcnl dcsp evoked sss epochs sss average dcnl dcsp assert equal evoked std nave evoked sss nave dcnl dcsp assert raises assertionerror assert meg snr evoked sss evoked move all 0 0 0 0 dcnl dcsp assert meg snr evoked sss evoked move non 0 02 2 6 dcnl dcsp assert meg snr evoked sss evoked stat all 0 05 3 2 dcnl dcsp assert allclose evoked sss stat data evoked stat all data atol 1e20 dcnl dcsp destination deepcopy epochs info dev head t dcnl dcsp x head pos to trans rot t head pos1 dcnl dcsp epochs info dev head t trans 3 3 x1 dcnl dcsp epochs info dev head t trans 3 3 x0 dcnl dcsp assert raises assertionerror assert allclose epochs info dev head t trans destination trans dcnl dcsp evoked miss average movements epochs head pos head pos2 origin origin destination destination dcnl dcsp assert allclose evoked miss data evoked move all data atol 1e20 dcnl dcsp assert allclose evoked miss info dev head t trans destination trans dcnl dcsp destination to destination from dcnl dcsp assert raises runtimeerror average movements epochs head pos origin origin destination destination dcnl dcsp assert raises typeerror average movements foo head pos head pos dcnl dcsp assert raises runtimeerror average movements epochs proj head pos head pos
def test reject dcsp raw events picks get data dcnl dcsp events events events 2 event id dcnl dcsp selection np arange 3 dcnl dcsp drop log 3 + meg dcsp 2443 4 dcnl dcsp assert raises typeerror pick types raw dcnl dcsp picks meg pick types raw info meg true eeg false dcnl dcsp assert raises typeerror epochs raw events event id tmin tmax picks picks preload false reject foo dcnl dcsp assert raises valueerror epochs raw events event id tmin tmax picks picks meg preload false reject dict eeg 1 0 dcnl dcsp epochs raw events event id tmin tmax picks picks meg preload false reject dict eeg np inf dcnl dcsp for val in none 1 dcnl dcsp dcsp for kwarg in reject flat dcnl dcsp dcsp dcsp assert raises valueerror epochs raw events event id tmin tmax picks picks meg preload false kwarg dict grad val dcnl dcsp assert raises keyerror epochs raw events event id tmin tmax picks picks preload false reject dict foo 1 0 dcnl dcsp data 7 dict dcnl dcsp keep idx 0 1 2 dcnl dcsp for preload in true false dcnl dcsp dcsp for proj in true false delayed dcnl dcsp dcsp dcsp epochs epochs raw events event id tmin tmax picks picks preload preload dcnl dcsp dcsp dcsp assert raises valueerror epochs drop bad reject foo dcnl dcsp dcsp dcsp epochs drop bad dcnl dcsp dcsp dcsp assert equal len epochs len events dcnl dcsp dcsp dcsp assert array equal epochs selection np arange len events dcnl dcsp dcsp dcsp assert array equal epochs drop log 7 dcnl dcsp dcsp dcsp if proj not in data 7 dcnl dcsp dcsp dcsp dcsp data 7proj epochs get data dcnl dcsp dcsp dcsp assert array equal epochs get data data 7proj dcnl dcsp dcsp dcsp epochs epochs raw events event id tmin tmax picks picks reject reject preload preload dcnl dcsp dcsp dcsp epochs drop bad dcnl dcsp dcsp dcsp assert equal len epochs len events 4 dcnl dcsp dcsp dcsp assert array equal epochs selection selection dcnl dcsp dcsp dcsp assert array equal epochs drop log drop log dcnl dcsp dcsp dcsp assert array equal epochs get data data 7projkeep idx dcnl dcsp dcsp dcsp epochs epochs raw events event id tmin tmax picks picks preload preload dcnl dcsp dcsp dcsp epochs drop bad dcnl dcsp dcsp dcsp assert equal len epochs len events dcnl dcsp dcsp dcsp assert array equal epochs get data data 7proj dcnl dcsp dcsp dcsp epochs drop bad reject dcnl dcsp dcsp dcsp assert equal len epochs len events 4 dcnl dcsp dcsp dcsp assert equal len epochs len epochs get data dcnl dcsp dcsp dcsp assert array equal epochs selection selection dcnl dcsp dcsp dcsp assert array equal epochs drop log drop log dcnl dcsp dcsp dcsp assert array equal epochs get data data 7projkeep idx dcnl dcsp dcsp dcsp reject part dict grad 1 1e09 mag 4e12 eeg 8e05 eog 0 00015 dcnl dcsp dcsp dcsp epochs epochs raw events event id tmin tmax picks picks reject reject part preload preload dcnl dcsp dcsp dcsp epochs drop bad dcnl dcsp dcsp dcsp assert equal len epochs len events 1 dcnl dcsp dcsp dcsp epochs drop bad reject dcnl dcsp dcsp dcsp assert equal len epochs len events 4 dcnl dcsp dcsp dcsp assert array equal epochs selection selection dcnl dcsp dcsp dcsp assert array equal epochs drop log drop log dcnl dcsp dcsp dcsp assert array equal epochs get data data 7projkeep idx dcnl dcsp dcsp dcsp assert raises valueerror epochs drop bad reject part dcnl dcsp dcsp dcsp assert equal len epochs len events 4 dcnl dcsp dcsp dcsp assert array equal epochs get data data 7projkeep idx dcnl dcsp dcsp dcsp epochs drop bad flat dict mag 1 0 dcnl dcsp dcsp dcsp assert equal len epochs 0 dcnl dcsp dcsp dcsp assert raises valueerror epochs drop bad flat dict mag 0 0 dcnl dcsp dcsp dcsp reject part dict grad 1 1e09 mag 4e12 eeg 8e05 eog 0 00015 dcnl dcsp dcsp dcsp epochs epochs raw events event id tmin tmax picks picks reject none preload preload dcnl dcsp dcsp dcsp epochs epochs 1 dcnl dcsp dcsp dcsp epochs drop bad reject reject dcnl dcsp dcsp dcsp assert equal len epochs len events 4 dcnl dcsp dcsp dcsp assert array equal epochs get data data 7projkeep idx dcnl dcsp dcsp sfreq raw info sfreq dcnl dcsp dcsp onsets event0 raw first samp sfreq for event in events 2 3 dcnl dcsp dcsp onsets0 onsets0 + tmin 0 499 dcnl dcsp dcsp onsets1 onsets1 + tmax 0 001 dcnl dcsp dcsp first time raw info meas date 0 + raw info meas date 1 1e06 + raw first samp sfreq dcnl dcsp dcsp for orig time in none first time dcnl dcsp dcsp dcsp raw annotations annotations onsets 0 5 0 5 0 5 bad orig time dcnl dcsp dcsp dcsp epochs epochs raw events event id tmin tmax picks 0 reject none preload preload dcnl dcsp dcsp dcsp epochs drop bad dcnl dcsp dcsp dcsp assert equal len events 3 len epochs events dcnl dcsp dcsp dcsp assert equal epochs drop log00 bad dcnl dcsp dcsp dcsp assert equal epochs drop log20 bad dcnl dcsp dcsp dcsp assert equal epochs drop log40 bad dcnl dcsp dcsp raw annotations none
def test decim dcsp dec 1 dec 2 2 3 dcnl dcsp decim dec 1 dec 2 dcnl dcsp n epochs n channels n times 5 10 20 dcnl dcsp sfreq 1000 0 dcnl dcsp sfreq new sfreq decim dcnl dcsp data rng randn n epochs n channels n times dcnl dcsp events np array np arange n epochs 0 n epochs 1 n epochs t dcnl dcsp info create info n channels sfreq eeg dcnl dcsp info lowpass sfreq new float decim dcnl dcsp epochs epochsarray data info events dcnl dcsp data epochs epochs copy decimate decim get data dcnl dcsp data epochs 2 epochs copy decimate decim offset 1 get data dcnl dcsp data epochs 3 epochs decimate dec 1 decimate dec 2 get data dcnl dcsp assert array equal data epochs data decim dcnl dcsp assert array equal data epochs 2 data 1 decim dcnl dcsp assert array equal data epochs data epochs 3 dcnl dcsp raw events picks get data dcnl dcsp events events events 2 1 2 dcnl dcsp raw load data pick channels raw ch namespick for pick in picks 30 dcnl dcsp raw info normalize proj dcnl dcsp del picks dcnl dcsp sfreq new raw info sfreq decim dcnl dcsp raw info lowpass sfreq new 12 0 dcnl dcsp assert raises valueerror epochs decimate 1 dcnl dcsp assert raises valueerror epochs decimate 2 offset 1 dcnl dcsp assert raises valueerror epochs decimate 2 offset 2 dcnl dcsp for this offset in range decim dcnl dcsp dcsp epochs epochs raw events event id tmin this offset raw info sfreq tmax tmax dcnl dcsp dcsp idx offsets np arange decim + this offset dcnl dcsp dcsp for offset idx offset in zip np arange decim idx offsets dcnl dcsp dcsp dcsp expected times epochs timesidx offset decim dcnl dcsp dcsp dcsp expected data epochs get data idx offset decim dcnl dcsp dcsp dcsp must have offset float epochs info sfreq dcnl dcsp dcsp dcsp assert true np isclose must have expected times any dcnl dcsp dcsp dcsp ep decim epochs copy decimate decim offset dcnl dcsp dcsp dcsp assert true np isclose must have ep decim times any dcnl dcsp dcsp dcsp assert allclose ep decim times expected times dcnl dcsp dcsp dcsp assert allclose ep decim get data expected data dcnl dcsp dcsp dcsp assert equal ep decim info sfreq sfreq new dcnl dcsp epochs epochs raw events event id tmin tmax dcnl dcsp expected data epochs get data decim dcnl dcsp expected times epochs times decim dcnl dcsp for preload in true false dcnl dcsp dcsp epochs epochs raw events event id tmin tmax decim decim preload preload dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times dcnl dcsp dcsp epochs epochs raw events event id tmin tmax decim dec 1 preload preload decimate dec 2 dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times dcnl dcsp dcsp epochs epochs raw events event id tmin tmax decim dec 2 preload preload decimate dec 1 dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times dcnl dcsp dcsp epochs epochs raw events event id tmin tmax decim dec 1 preload preload dcnl dcsp dcsp epochs load data dcnl dcsp dcsp epochs epochs decimate dec 2 dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times dcnl dcsp dcsp epochs epochs raw events event id tmin tmax decim dec 2 preload preload dcnl dcsp dcsp epochs load data dcnl dcsp dcsp epochs epochs decimate dec 1 dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times dcnl dcsp dcsp epochs epochs raw events event id tmin tmax preload preload decimate decim dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times dcnl dcsp dcsp epochs epochs raw events event id tmin tmax preload preload dcnl dcsp dcsp epochs load data dcnl dcsp dcsp epochs decimate decim dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert allclose epochs get data expected data dcnl dcsp dcsp assert equal epochs info sfreq sfreq new dcnl dcsp dcsp assert array equal epochs times expected times
def test base epochs dcsp raw get data 0 dcnl dcsp epochs baseepochs raw info none np ones 1 3 int event id tmin tmax dcnl dcsp assert raises notimplementederror epochs get data dcnl dcsp assert raises valueerror baseepochs raw info none np ones 1 3 float event id tmin tmax dcnl dcsp assert raises valueerror baseepochs raw info none np ones 1 3 2 int event id tmin tmax
requires version scipy 0 14 dcnl def test savgol filter dcsp h freq 10 0 dcnl dcsp raw events get data 2 dcnl dcsp epochs epochs raw events event id tmin tmax dcnl dcsp assert raises runtimeerror epochs savgol filter 10 0 dcnl dcsp epochs epochs raw events event id tmin tmax preload true dcnl dcsp freqs fftpack fftfreq len epochs times 1 0 epochs info sfreq dcnl dcsp data np abs fftpack fft epochs get data dcnl dcsp match mask np logical and freqs 0 freqs < h freq 2 0 dcnl dcsp mismatch mask np logical and freqs h freq 2 freqs < 50 0 dcnl dcsp epochs savgol filter h freq dcnl dcsp data filt np abs fftpack fft epochs get data dcnl dcsp assert allclose np mean data match mask 0 np mean data filt match mask 0 rtol 0 0001 atol 0 01 dcnl dcsp assert true np mean data mismatch mask np mean data filt mismatch mask 5
def test epochs hash dcsp raw events get data 2 dcnl dcsp epochs epochs raw events event id tmin tmax dcnl dcsp assert raises runtimeerror epochs hash dcnl dcsp epochs epochs raw events event id tmin tmax preload true dcnl dcsp assert equal hash epochs hash epochs dcnl dcsp epochs 2 epochs raw events event id tmin tmax preload true dcnl dcsp assert equal hash epochs hash epochs 2 dcnl dcsp assert true pickle dumps epochs pickle dumps epochs 2 dcnl dcsp epochs 2 data 0 0 0 1 dcnl dcsp assert not equal hash epochs hash epochs 2
def test event ordering dcsp raw events get data 2 dcnl dcsp events2 events copy dcnl dcsp rng shuffle events2 dcnl dcsp for ii eve in enumerate events events2 dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp epochs raw eve event id tmin tmax reject reject flat flat dcnl dcsp dcsp dcsp assert equal len w ii dcnl dcsp dcsp dcsp if ii 0 dcnl dcsp dcsp dcsp dcsp assert true chronologically in s w 1 message dcnl dcsp events2 events0 0 dcnl dcsp events2 2 1 2 dcnl dcsp assert raises runtimeerror epochs raw events2 event id none dcnl dcsp assert equal len epochs raw events2 event id dict a 1 preload true 1
def test epochs bad baseline dcsp raw events get data 2 dcnl dcsp assert raises valueerror epochs raw events none 0 1 0 3 0 2 0 dcnl dcsp assert raises valueerror epochs raw events none 0 1 0 3 0 0 4 dcnl dcsp assert raises valueerror epochs raw events none 0 1 0 3 0 1 0 dcnl dcsp assert raises valueerror epochs raw events none 0 1 0 3 none 0 dcnl dcsp assert raises valueerror epochs raw events none 0 3 0 1 0 none dcnl dcsp epochs epochs raw events none 0 1 0 3 baseline none dcnl dcsp assert raises runtimeerror epochs apply baseline 0 1 0 2 dcnl dcsp epochs load data dcnl dcsp assert raises valueerror epochs apply baseline none 0 dcnl dcsp assert raises valueerror epochs apply baseline 0 none dcnl dcsp data np arange 100 dtype float dcnl dcsp assert raises valueerror rescale data times data baseline 2 1 dcnl dcsp rescale data copy times data baseline 2 2 dcnl dcsp assert raises valueerror rescale data times data baseline 2 1 dcnl dcsp assert raises valueerror rescale data times data baseline 100 101
def test epoch combine ids dcsp raw events picks get data dcnl dcsp epochs epochs raw events a 1 b 2 c 3 d 4 e 5 f 32 tmin tmax picks picks preload false dcnl dcsp events new merge events events 1 2 12 dcnl dcsp epochs new combine event ids epochs a b ab 12 dcnl dcsp assert equal epochs new ab name ab dcnl dcsp assert array equal events new epochs new events
def test epoch multi ids dcsp raw events picks get data dcnl dcsp epochs epochs raw events a b a 1 a b b 2 a c 3 b d 4 a b 5 tmin tmax picks picks preload false dcnl dcsp epochs regular epochs a b dcnl dcsp epochs reverse epochs b a dcnl dcsp epochs multi epochs a b a a b b dcnl dcsp assert array equal epochs multi events epochs regular events dcnl dcsp assert array equal epochs reverse events epochs regular events dcnl dcsp assert allclose epochs multi get data epochs regular get data dcnl dcsp assert allclose epochs reverse get data epochs regular get data
def test read epochs bad events dcsp raw events picks get data dcnl dcsp epochs epochs raw np array raw first samp 0 event id event id tmin tmax picks picks dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp evoked epochs average dcnl dcsp epochs epochs raw np array raw first samp 0 event id event id tmin tmax picks picks dcnl dcsp assert true repr epochs dcnl dcsp epochs drop bad dcnl dcsp assert true repr epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp evoked epochs average dcnl dcsp epochs epochs raw np array raw last samp 0 event id event id tmin tmax picks picks dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp evoked epochs average dcnl dcsp dcsp assert evoked dcnl dcsp warnings resetwarnings
slow test dcnl def test read write epochs dcsp raw events picks get data preload true dcnl dcsp tempdir tempdir dcnl dcsp temp fname op join tempdir testepo fif dcnl dcsp temp fname no bl op join tempdir test no blepo fif dcnl dcsp baseline none 0 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline baseline preload true dcnl dcsp epochs orig epochs copy dcnl dcsp epochs no bl epochs raw events event id tmin tmax picks picks baseline none preload true dcnl dcsp assert true epochs no bl baseline is none dcnl dcsp evoked epochs average dcnl dcsp data epochs get data dcnl dcsp assert raises valueerror epochs raw events event id tmax tmin baseline none dcnl dcsp epochs no id epochs raw pick events events include event id none tmin tmax picks picks dcnl dcsp assert array equal data epochs no id get data dcnl dcsp eog picks pick types raw info meg false eeg false stim false eog true exclude bads dcnl dcsp eog ch names raw ch namesk for k in eog picks dcnl dcsp epochs drop channels eog ch names dcnl dcsp assert true len epochs info chs len epochs ch names epochs get data shape1 dcnl dcsp data no eog epochs get data dcnl dcsp assert true data shape1 data no eog shape1 + len eog picks dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp epochs dec epochs raw events event id tmin tmax picks picks decim 2 dcnl dcsp dcsp assert equal len w 1 dcnl dcsp dcsp epochs dec info lowpass none dcnl dcsp dcsp epochs dec decimate 2 dcnl dcsp dcsp assert equal len w 2 dcnl dcsp data dec epochs dec get data dcnl dcsp assert allclose data epochs dec decim slice data dec rtol 1e07 atol 1e12 dcnl dcsp evoked dec epochs dec average dcnl dcsp assert allclose evoked data epochs dec decim slice evoked dec data rtol 1e12 atol 1e17 dcnl dcsp n evoked data shape1 dcnl dcsp n dec evoked dec data shape1 dcnl dcsp n dec min n 4 dcnl dcsp assert true n dec min < n dec < n dec min + 1 dcnl dcsp assert true evoked dec info sfreq evoked info sfreq 4 dcnl dcsp tols dict atol 0 001 rtol 1e20 dcnl dcsp raw events picks get data dcnl dcsp events 2 1 1 dcnl dcsp events1 2 2 2 dcnl dcsp event ids dict a 1 b 2 dcnl dcsp for proj in true delayed false dcnl dcsp dcsp epochs epochs raw events event ids tmin tmax picks picks proj proj reject reject dcnl dcsp dcsp assert equal epochs proj proj if proj delayed else false dcnl dcsp dcsp data1 epochs get data dcnl dcsp dcsp epochs2 epochs copy apply proj dcnl dcsp dcsp assert equal epochs2 proj true dcnl dcsp dcsp data2 epochs2 get data dcnl dcsp dcsp assert allclose data1 data2 tols dcnl dcsp dcsp epochs save temp fname dcnl dcsp dcsp epochs read read epochs temp fname preload false dcnl dcsp dcsp assert allclose epochs get data epochs read get data tols dcnl dcsp dcsp assert allclose epochs a get data epochs read a get data tols dcnl dcsp dcsp assert allclose epochs b get data epochs read b get data tols dcnl dcsp epochs read read epochs temp fname preload false dcnl dcsp epochs copy epochs read copy dcnl dcsp del epochs read dcnl dcsp epochs copy get data dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp del epochs copy dcnl dcsp assert equal len w 0 dcnl dcsp for preload in false true dcnl dcsp dcsp epochs epochs orig copy dcnl dcsp dcsp epochs save temp fname dcnl dcsp dcsp epochs no bl save temp fname no bl dcnl dcsp dcsp epochs read read epochs temp fname preload preload dcnl dcsp dcsp epochs no bl save temp fname no bl dcnl dcsp dcsp epochs read read epochs temp fname dcnl dcsp dcsp epochs no bl read read epochs temp fname no bl dcnl dcsp dcsp assert raises valueerror epochs apply baseline baseline 1 2 3 dcnl dcsp dcsp epochs with bl epochs no bl read copy apply baseline baseline dcnl dcsp dcsp assert true isinstance epochs with bl baseepochs dcnl dcsp dcsp assert true epochs with bl baseline baseline dcnl dcsp dcsp assert true epochs no bl read baseline baseline dcnl dcsp dcsp assert true str epochs read startswith <epochs dcnl dcsp dcsp epochs no bl read apply baseline baseline dcnl dcsp dcsp assert array equal epochs no bl read times epochs times dcnl dcsp dcsp assert array almost equal epochs read get data epochs get data dcnl dcsp dcsp assert array almost equal epochs get data epochs no bl read get data dcnl dcsp dcsp assert array equal epochs read times epochs times dcnl dcsp dcsp assert array almost equal epochs read average data evoked data dcnl dcsp dcsp assert equal epochs read proj epochs proj dcnl dcsp dcsp bmin bmax epochs baseline dcnl dcsp dcsp if bmin is none dcnl dcsp dcsp dcsp bmin epochs times0 dcnl dcsp dcsp if bmax is none dcnl dcsp dcsp dcsp bmax epochs times 1 dcnl dcsp dcsp baseline bmin bmax dcnl dcsp dcsp assert array almost equal epochs read baseline baseline dcnl dcsp dcsp assert array almost equal epochs read tmin epochs tmin 2 dcnl dcsp dcsp assert array almost equal epochs read tmax epochs tmax 2 dcnl dcsp dcsp assert equal epochs read event id epochs event id dcnl dcsp dcsp epochs event id pop 1 dcnl dcsp dcsp epochs event id update a a 1 dcnl dcsp dcsp epochs save op join tempdir fooepo fif dcnl dcsp dcsp epochs read2 read epochs op join tempdir fooepo fif preload preload dcnl dcsp dcsp assert equal epochs read2 event id epochs event id dcnl dcsp dcsp assert equal epochs read2 a a average comment a a dcnl dcsp dcsp epochs epochs raw events event id tmin tmax picks picks reject reject dcnl dcsp dcsp epochs save temp fname dcnl dcsp dcsp epochs read3 read epochs temp fname preload preload dcnl dcsp dcsp assert array equal epochs read3 events epochs events dcnl dcsp dcsp data epochs get data dcnl dcsp dcsp assert true epochs read3 events shape0 data shape0 dcnl dcsp dcsp epochs read4 epochs read3 copy dcnl dcsp dcsp assert array almost equal epochs read4 get data data dcnl dcsp dcsp epochs read4 equalize event counts epochs event id dcnl dcsp dcsp epochs drop 1 2 reason can dcsp we dcsp recover dcsp orig dcsp id dcnl dcsp dcsp epochs save temp fname dcnl dcsp dcsp epochs read5 read epochs temp fname preload preload dcnl dcsp dcsp assert array equal epochs read5 selection epochs selection dcnl dcsp dcsp assert equal len epochs read5 selection len epochs read5 events dcnl dcsp dcsp assert array equal epochs read5 drop log epochs drop log dcnl dcsp dcsp if preload dcnl dcsp dcsp dcsp epochs read5 drop channels epochs read5 ch names 1 dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp epochs badname op join tempdir testbadname fif gz dcnl dcsp dcsp dcsp epochs save epochs badname dcnl dcsp dcsp dcsp read epochs epochs badname preload preload dcnl dcsp dcsp assert naming w test epochs py 2 dcnl dcsp dcsp epochs epochs raw events dict foo 1 bar 999 tmin tmax picks picks on missing ignore dcnl dcsp dcsp epochs save temp fname dcnl dcsp dcsp epochs read read epochs temp fname preload preload dcnl dcsp dcsp assert allclose epochs get data epochs read get data tols dcnl dcsp dcsp assert array equal epochs events epochs read events dcnl dcsp dcsp assert equal set epochs event id keys set text type x for x in epochs read event id keys dcnl dcsp dcsp epochs save temp fname split size 7mb dcnl dcsp dcsp epochs read read epochs temp fname preload preload dcnl dcsp dcsp assert allclose epochs get data epochs read get data tols dcnl dcsp dcsp assert array equal epochs events epochs read events dcnl dcsp dcsp assert array equal epochs selection epochs read selection dcnl dcsp dcsp assert equal epochs drop log epochs read drop log dcnl dcsp dcsp epochs load data crop 0 0 dcnl dcsp dcsp assert equal len epochs times 1 dcnl dcsp dcsp assert equal epochs get data shape 1 1 dcnl dcsp dcsp epochs save temp fname dcnl dcsp dcsp epochs read read epochs temp fname preload preload dcnl dcsp dcsp assert equal len epochs read times 1 dcnl dcsp dcsp assert equal epochs get data shape 1 1
def test epochs proj dcsp tempdir tempdir dcnl dcsp raw events picks get data dcnl dcsp exclude raw info bads + meg dcsp 2443 eeg dcsp 053 dcnl dcsp this picks pick types raw info meg true eeg false stim true eog true exclude exclude dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks this picks proj true dcnl dcsp assert true all p active is true for p in epochs info projs dcnl dcsp evoked epochs average dcnl dcsp assert true all p active is true for p in evoked info projs dcnl dcsp data epochs get data dcnl dcsp raw proj read raw fif raw fname apply proj dcnl dcsp epochs no proj epochs raw proj events 4 event id tmin tmax picks this picks proj false dcnl dcsp data no proj epochs no proj get data dcnl dcsp assert true all p active is true for p in epochs no proj info projs dcnl dcsp evoked no proj epochs no proj average dcnl dcsp assert true all p active is true for p in evoked no proj info projs dcnl dcsp assert true epochs no proj proj is true dcnl dcsp assert array almost equal data data no proj decimal 8 dcnl dcsp this picks pick types raw info meg true eeg true stim true eog true exclude exclude dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks this picks proj true dcnl dcsp epochs set eeg reference projection true apply proj dcnl dcsp assert true has eeg average ref proj epochs info projs dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks this picks proj true dcnl dcsp assert true not has eeg average ref proj epochs info projs dcnl dcsp raw info custom ref applied true dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks this picks proj true dcnl dcsp assert true not has eeg average ref proj epochs info projs dcnl dcsp proj raw info projs dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks this picks proj false dcnl dcsp epochs info projs dcnl dcsp data epochs copy add proj proj apply proj get data dcnl dcsp fname epo op join tempdir tempepo fif dcnl dcsp epochs save fname epo dcnl dcsp epochs read read epochs fname epo dcnl dcsp epochs read add proj proj dcnl dcsp epochs read apply proj dcnl dcsp data 2 epochs read get data dcnl dcsp assert allclose data data 2 atol 1e15 rtol 0 001 dcnl dcsp raw read raw fif raw fname dcnl dcsp raw add proj remove existing true dcnl dcsp raw info bads meg dcsp 2443 eeg dcsp 053 dcnl dcsp picks pick types raw info meg false eeg true stim true eog false exclude bads dcnl dcsp epochs epochs raw events event id tmin tmax proj true picks picks preload true dcnl dcsp epochs pick channels eeg dcsp 001 eeg dcsp 002 dcnl dcsp assert equal len epochs 7 dcnl dcsp temp fname op join tempdir testepo fif dcnl dcsp epochs save temp fname dcnl dcsp for preload in true false dcnl dcsp dcsp epochs read epochs temp fname proj false preload preload dcnl dcsp dcsp epochs set eeg reference projection true apply proj dcnl dcsp dcsp assert allclose epochs get data mean axis 1 0 atol 1e15 dcnl dcsp dcsp epochs read epochs temp fname proj false preload preload dcnl dcsp dcsp epochs set eeg reference projection true dcnl dcsp dcsp assert raises assertionerror assert allclose epochs get data mean axis 1 0 0 atol 1e15 dcnl dcsp dcsp epochs apply proj dcnl dcsp dcsp assert allclose epochs get data mean axis 1 0 atol 1e15
def test evoked arithmetic dcsp raw events picks get data dcnl dcsp epochs1 epochs raw events 4 event id tmin tmax picks picks dcnl dcsp evoked1 epochs1 average dcnl dcsp epochs2 epochs raw events4 8 event id tmin tmax picks picks dcnl dcsp evoked2 epochs2 average dcnl dcsp epochs epochs raw events 8 event id tmin tmax picks picks dcnl dcsp evoked epochs average dcnl dcsp evoked sum combine evoked evoked1 evoked2 weights nave dcnl dcsp assert array equal evoked data evoked sum data dcnl dcsp assert array equal evoked times evoked sum times dcnl dcsp assert equal evoked sum nave evoked1 nave + evoked2 nave dcnl dcsp evoked diff combine evoked evoked1 evoked1 weights 1 1 dcnl dcsp assert array equal np zeros like evoked data evoked diff data
def test evoked io from epochs dcsp tempdir tempdir dcnl dcsp raw events picks get data dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp epochs epochs raw events 4 event id tmin + 0 011 tmax picks picks decim 5 dcnl dcsp assert true len w 1 dcnl dcsp evoked epochs average dcnl dcsp evoked info proj name dcnl dcsp evoked save op join tempdir evokedave fif dcnl dcsp evoked2 read evokeds op join tempdir evokedave fif 0 dcnl dcsp assert equal evoked2 info proj name none dcnl dcsp assert allclose evoked data evoked2 data rtol 0 0001 atol 1e20 dcnl dcsp assert allclose evoked times evoked2 times rtol 0 0001 atol 1 evoked info sfreq dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp epochs epochs raw events 4 event id 0 1 tmax picks picks baseline 0 1 0 2 decim 5 dcnl dcsp evoked epochs average dcnl dcsp evoked save op join tempdir evokedave fif dcnl dcsp evoked2 read evokeds op join tempdir evokedave fif 0 dcnl dcsp assert allclose evoked data evoked2 data rtol 0 0001 atol 1e20 dcnl dcsp assert allclose evoked times evoked2 times rtol 0 0001 atol 1e20 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp epochs epochs raw events 4 event id 0 2 tmax picks picks baseline 0 1 0 2 decim 5 dcnl dcsp evoked epochs average dcnl dcsp evoked crop 0 099 none dcnl dcsp assert allclose evoked data evoked2 data rtol 0 0001 atol 1e20 dcnl dcsp assert allclose evoked times evoked2 times rtol 0 0001 atol 1e20
def test evoked standard error dcsp raw events picks get data dcnl dcsp tempdir tempdir dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks picks dcnl dcsp evoked epochs average epochs standard error dcnl dcsp write evokeds op join tempdir evokedave fif evoked dcnl dcsp evoked2 read evokeds op join tempdir evokedave fif 0 1 dcnl dcsp evoked3 read evokeds op join tempdir evokedave fif 1 read evokeds op join tempdir evokedave fif 1 kind standard error dcnl dcsp for evoked new in evoked2 evoked3 dcnl dcsp dcsp assert true evoked new0 aspect kind fiff fiffv aspect average dcnl dcsp dcsp assert true evoked new0 kind average dcnl dcsp dcsp assert true evoked new1 aspect kind fiff fiffv aspect std err dcnl dcsp dcsp assert true evoked new1 kind standard error dcnl dcsp dcsp for ave ave2 in zip evoked evoked new dcnl dcsp dcsp dcsp assert array almost equal ave data ave2 data dcnl dcsp dcsp dcsp assert array almost equal ave times ave2 times dcnl dcsp dcsp dcsp assert equal ave nave ave2 nave dcnl dcsp dcsp dcsp assert equal ave aspect kind ave2 aspect kind dcnl dcsp dcsp dcsp assert equal ave kind ave2 kind dcnl dcsp dcsp dcsp assert equal ave last ave2 last dcnl dcsp dcsp dcsp assert equal ave first ave2 first
def test reject epochs dcsp raw events picks get data dcnl dcsp events1 events events 2 event id dcnl dcsp epochs epochs raw events1 event id tmin tmax reject reject flat flat dcnl dcsp assert raises runtimeerror len epochs dcnl dcsp n events len epochs events dcnl dcsp data epochs get data dcnl dcsp n clean epochs len data dcnl dcsp assert true n events n clean epochs dcnl dcsp assert true n clean epochs 3 dcnl dcsp assert true epochs drop log meg dcsp 2443 meg dcsp 2443 meg dcsp 2443 meg dcsp 2443 dcnl dcsp raw 2 raw copy dcnl dcsp raw 2 info bads meg dcsp 2443 dcnl dcsp reject crazy dict grad 1e12 mag 4e15 eeg 8e08 eog 1 5e07 dcnl dcsp epochs epochs raw 2 events1 event id tmin tmax reject reject crazy flat flat dcnl dcsp epochs drop bad dcnl dcsp assert true all meg dcsp 2442 in e for e in epochs drop log dcnl dcsp assert true all meg dcsp 2443 not in e for e in epochs drop log dcnl dcsp assert raises valueerror epochs raw events1 event id tmin tmax reject tmin 1 0 reject tmax 0 dcnl dcsp assert raises valueerror epochs raw events1 event id tmin tmax reject tmin tmin 1 reject tmax 1 0 dcnl dcsp assert raises valueerror epochs raw events1 event id tmin tmax reject tmin 0 0 reject tmax tmax + 1 dcnl dcsp epochs epochs raw events1 event id tmin tmax picks picks reject reject flat flat reject tmin 0 0 reject tmax 0 1 dcnl dcsp data epochs get data dcnl dcsp n clean epochs len data dcnl dcsp assert true n clean epochs 7 dcnl dcsp assert true len epochs 7 dcnl dcsp assert true epochs timesepochs reject time0 0 0 dcnl dcsp assert true epochs timesepochs reject time 1 < 0 1 dcnl dcsp epochs epochs raw events1 event id tmin tmax dcnl dcsp assert equal epochs is good epoch none false no data dcnl dcsp assert equal epochs is good epoch np zeros 1 1 false too short dcnl dcsp data epochs0 get data 0 dcnl dcsp assert equal epochs is good epoch data true none
def test preload epochs dcsp raw events picks get data dcnl dcsp epochs preload epochs raw events 16 event id tmin tmax picks picks preload true reject reject flat flat dcnl dcsp data preload epochs preload get data dcnl dcsp epochs epochs raw events 16 event id tmin tmax picks picks preload false reject reject flat flat dcnl dcsp data epochs get data dcnl dcsp assert array equal data preload data dcnl dcsp assert array almost equal epochs preload average data epochs average data 18
def test indexing slicing dcsp raw events picks get data dcnl dcsp epochs epochs raw events 20 event id tmin tmax picks picks reject reject flat flat dcnl dcsp data normal epochs get data dcnl dcsp n good events data normal shape0 dcnl dcsp start index 1 dcnl dcsp end index n good events 1 dcnl dcsp assert end index start index 0 dcnl dcsp for preload in true false dcnl dcsp dcsp epochs2 epochs raw events 20 event id tmin tmax picks picks preload preload reject reject flat flat dcnl dcsp dcsp if not preload dcnl dcsp dcsp dcsp epochs2 drop bad dcnl dcsp dcsp epochs2 sliced epochs2start index end index dcnl dcsp dcsp data epochs2 sliced epochs2 sliced get data dcnl dcsp dcsp assert array equal data epochs2 sliced data normalstart index end index dcnl dcsp dcsp pos 0 dcnl dcsp dcsp for idx in range start index end index dcnl dcsp dcsp dcsp data epochs2 slicedpos get data dcnl dcsp dcsp dcsp assert array equal data0 data normalidx dcnl dcsp dcsp dcsp pos + 1 dcnl dcsp dcsp data epochs2data epochs2 sliced shape0 get data dcnl dcsp dcsp assert array equal data data normalidx dcnl dcsp dcsp idx rng randint 0 data epochs2 sliced shape0 10 dcnl dcsp dcsp data epochs2idx get data dcnl dcsp dcsp assert array equal data data normalidx dcnl dcsp dcsp idx 0 dcnl dcsp dcsp data epochs2idx get data dcnl dcsp dcsp assert array equal data data normalidx dcnl dcsp dcsp idx 0 1 dcnl dcsp dcsp data epochs2idx get data dcnl dcsp dcsp assert array equal data data normalidx
def test comparision with c dcsp raw events get data 2 dcnl dcsp c evoked read evokeds evoked nf name condition 0 dcnl dcsp epochs epochs raw events event id tmin tmax baseline none preload true proj false dcnl dcsp evoked epochs set eeg reference projection true apply proj average dcnl dcsp sel pick channels c evoked ch names evoked ch names dcnl dcsp evoked data evoked data dcnl dcsp c evoked data c evoked datasel dcnl dcsp assert true evoked nave c evoked nave dcnl dcsp assert array almost equal evoked data c evoked data 10 dcnl dcsp assert array almost equal evoked times c evoked times 12
def test crop dcsp raw events picks get data dcnl dcsp epochs epochs raw events 5 event id tmin tmax picks picks preload false reject reject flat flat dcnl dcsp assert raises runtimeerror epochs crop none 0 2 dcnl dcsp data normal epochs get data dcnl dcsp epochs2 epochs raw events 5 event id tmin tmax picks picks preload true reject reject flat flat dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp epochs2 crop 20 200 dcnl dcsp assert true len w 2 dcnl dcsp tmin window tmin + 0 1 dcnl dcsp tmax window tmax 0 1 dcnl dcsp tmask epochs times tmin window epochs times < tmax window dcnl dcsp assert true tmin window tmin dcnl dcsp assert true tmax window < tmax dcnl dcsp epochs3 epochs2 copy crop tmin window tmax window dcnl dcsp data3 epochs3 get data dcnl dcsp epochs2 crop tmin window tmax window dcnl dcsp data2 epochs2 get data dcnl dcsp assert array equal data2 data normal tmask dcnl dcsp assert array equal data3 data normal tmask dcnl dcsp assert array equal epochs time as index tmin tmax use rounding true 0 len epochs times 1 dcnl dcsp assert array equal epochs3 time as index tmin window tmax window use rounding true 0 len epochs3 times 1 dcnl dcsp epochs epochsarray np zeros 1 1 1000 create info 1 1000 0 eeg np ones 1 3 int tmin 0 2 dcnl dcsp epochs crop 0 2 0 7 dcnl dcsp last time epochs times 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs decimate 10 dcnl dcsp assert allclose last time epochs times 1 dcnl dcsp epochs epochs raw events 5 event id 1 1 picks picks preload true reject reject flat flat dcnl dcsp assert allclose epochs tmin 1 0006410259015925 rtol 1e12 dcnl dcsp assert allclose epochs tmax 1 0006410259015925 rtol 1e12 dcnl dcsp epochs crop epochs copy crop 1 1 dcnl dcsp assert allclose epochs times epochs crop times rtol 1e12 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror epochs crop 1000 2000 dcnl dcsp dcsp assert raises valueerror epochs crop 0 1 0
def test resample dcsp raw events picks get data dcnl dcsp epochs epochs raw events 10 event id tmin tmax picks picks preload false reject reject flat flat dcnl dcsp assert raises runtimeerror epochs resample 100 dcnl dcsp epochs o epochs raw events 10 event id tmin tmax picks picks preload true reject reject flat flat dcnl dcsp epochs epochs o copy dcnl dcsp data normal cp deepcopy epochs get data dcnl dcsp times normal cp deepcopy epochs times dcnl dcsp sfreq normal epochs info sfreq dcnl dcsp epochs epochs o copy dcnl dcsp epochs resample sfreq normal 2 npad 0 dcnl dcsp data up cp deepcopy epochs get data dcnl dcsp times up cp deepcopy epochs times dcnl dcsp sfreq up epochs info sfreq dcnl dcsp epochs resample sfreq normal npad 0 dcnl dcsp data new cp deepcopy epochs get data dcnl dcsp times new cp deepcopy epochs times dcnl dcsp sfreq new epochs info sfreq dcnl dcsp assert true data up shape2 2 data normal shape2 dcnl dcsp assert true sfreq up 2 sfreq normal dcnl dcsp assert true sfreq new sfreq normal dcnl dcsp assert true len times up 2 len times normal dcnl dcsp assert array almost equal times new times normal 10 dcnl dcsp assert true data up shape2 2 data normal shape2 dcnl dcsp assert array almost equal data new data normal 5 dcnl dcsp epochs epochs o copy dcnl dcsp epochs resample sfreq normal 2 n jobs 2 npad 0 dcnl dcsp assert true np allclose data up epochs data rtol 1e08 atol 1e16 dcnl dcsp epochs epochs o copy dcnl dcsp epochs resampled epochs copy resample sfreq normal 2 npad 0 dcnl dcsp assert true epochs resampled is not epochs dcnl dcsp epochs resampled epochs resample sfreq normal 2 npad 0 dcnl dcsp assert true epochs resampled is epochs dcnl dcsp n trial n chan n time sfreq 1 1 10 1000 0 dcnl dcsp data np zeros n trial n chan n time dcnl dcsp events np zeros n trial 3 int dcnl dcsp info create info n chan sfreq eeg dcnl dcsp epochs1 epochsarray data deepcopy info events dcnl dcsp epochs2 epochsarray data deepcopy info events dcnl dcsp epochs concatenate epochs epochs1 epochs2 dcnl dcsp epochs1 resample epochs1 info sfreq 2 npad auto dcnl dcsp epochs2 resample epochs2 info sfreq 2 npad auto dcnl dcsp epochs concatenate epochs epochs1 epochs2 dcnl dcsp for e in epochs1 epochs2 epochs dcnl dcsp dcsp assert equal e times0 epochs tmin dcnl dcsp dcsp assert equal e times 1 epochs tmax dcnl dcsp this tmin 0 002 dcnl dcsp epochs epochsarray data deepcopy info events tmin this tmin dcnl dcsp for times in epochs times epochs raw times dcnl dcsp dcsp assert allclose times np arange n time sfreq + this tmin dcnl dcsp epochs resample info sfreq 2 0 dcnl dcsp for times in epochs times epochs raw times dcnl dcsp dcsp assert allclose times np arange 2 n time sfreq 2 + this tmin dcnl dcsp epochs crop 0 none dcnl dcsp for times in epochs times epochs raw times dcnl dcsp dcsp assert allclose times np arange n time 2 2 sfreq 2 dcnl dcsp epochs resample sfreq dcnl dcsp for times in epochs times epochs raw times dcnl dcsp dcsp assert allclose times np arange n time 2 sfreq
def test detrend dcsp raw events picks get data dcnl dcsp epochs 1 epochs raw events 4 event id tmin tmax picks picks baseline none detrend 1 dcnl dcsp epochs 2 epochs raw events 4 event id tmin tmax picks picks baseline none detrend none dcnl dcsp data picks pick types epochs 1 info meg true eeg true exclude bads dcnl dcsp evoked 1 epochs 1 average dcnl dcsp evoked 2 epochs 2 average dcnl dcsp evoked 2 detrend 1 dcnl dcsp assert true np allclose evoked 1 data evoked 2 data rtol 1e08 atol 1e20 dcnl dcsp for preload in true false dcnl dcsp dcsp epochs 1 epochs raw events 4 event id tmin tmax picks picks baseline none none preload preload dcnl dcsp dcsp epochs 2 epochs raw events 4 event id tmin tmax picks picks baseline none preload preload detrend 0 dcnl dcsp dcsp a epochs 1 get data dcnl dcsp dcsp b epochs 2 get data dcnl dcsp dcsp assert true np allclose a data picks b data picks rtol 1e16 atol 1e20 dcnl dcsp dcsp assert true not np allclose a b dcnl dcsp for value in foo 2 false true dcnl dcsp dcsp assert raises valueerror epochs raw events 4 event id tmin tmax detrend value
def test bootstrap dcsp raw events picks get data dcnl dcsp epochs epochs raw events 5 event id tmin tmax picks picks preload true reject reject flat flat dcnl dcsp epochs2 bootstrap epochs random state 0 dcnl dcsp assert true len epochs2 events len epochs events dcnl dcsp assert true epochs data shape epochs2 data shape
def test epochs copy dcsp raw events picks get data dcnl dcsp epochs epochs raw events 5 event id tmin tmax picks picks preload true reject reject flat flat dcnl dcsp copied epochs copy dcnl dcsp assert array equal epochs data copied data dcnl dcsp epochs epochs raw events 5 event id tmin tmax picks picks preload false reject reject flat flat dcnl dcsp copied epochs copy dcnl dcsp data epochs get data dcnl dcsp copied data copied get data dcnl dcsp assert array equal data copied data
def test iter evoked dcsp raw events picks get data dcnl dcsp epochs epochs raw events 5 event id tmin tmax picks picks dcnl dcsp for ii ev in enumerate epochs iter evoked dcnl dcsp dcsp x ev data dcnl dcsp dcsp y epochs get data ii dcnl dcsp dcsp assert array equal x y
def test subtract evoked dcsp raw events picks get data dcnl dcsp epochs epochs raw events 10 event id tmin tmax picks picks dcnl dcsp assert raises valueerror epochs subtract evoked epochs average picks 5 dcnl dcsp epochs subtract evoked dcnl dcsp epochs apply proj dcnl dcsp epochs2 epochs raw events 10 event id tmin tmax picks picks preload true dcnl dcsp evoked epochs2 average dcnl dcsp epochs2 subtract evoked evoked dcnl dcsp assert allclose epochs get data epochs2 get data dcnl dcsp zero evoked epochs average dcnl dcsp data zero evoked data dcnl dcsp assert allclose data np zeros like data atol 1e15
def test epoch eq dcsp raw events picks get data dcnl dcsp epochs 1 epochs raw events event id tmin tmax picks picks dcnl dcsp epochs 2 epochs raw events event id 2 tmin tmax picks picks dcnl dcsp epochs 1 drop bad dcnl dcsp assert true len l for l in epochs 1 drop log if not l len epochs 1 events dcnl dcsp drop log1 epochs 1 drop log for in range len epochs 1 events dcnl dcsp drop log2 if l equalized count else l for l in epochs 1 drop log dcnl dcsp assert true drop log1 drop log2 dcnl dcsp assert true len l for l in epochs 1 drop log if not l len epochs 1 events dcnl dcsp assert true epochs 1 events shape0 epochs 2 events shape0 dcnl dcsp equalize epoch counts epochs 1 epochs 2 method mintime dcnl dcsp assert true epochs 1 events shape0 epochs 2 events shape0 dcnl dcsp epochs 3 epochs raw events event id tmin tmax picks picks dcnl dcsp epochs 4 epochs raw events event id 2 tmin tmax picks picks dcnl dcsp equalize epoch counts epochs 3 epochs 4 method truncate dcnl dcsp assert true epochs 1 events shape0 epochs 3 events shape0 dcnl dcsp assert true epochs 3 events shape0 epochs 4 events shape0 dcnl dcsp epochs epochs raw events a 1 b 2 c 3 d 4 tmin tmax picks picks reject reject dcnl dcsp epochs drop bad dcnl dcsp assert true len l for l in epochs drop log if not l len epochs events dcnl dcsp drop log1 deepcopy epochs drop log dcnl dcsp old shapes epochskey events shape0 for key in a b c d dcnl dcsp epochs equalize event counts a b dcnl dcsp drop log2 if l equalized count else l for l in epochs drop log dcnl dcsp assert true drop log1 drop log2 dcnl dcsp assert true len l for l in epochs drop log if not l len epochs events dcnl dcsp new shapes epochskey events shape0 for key in a b c d dcnl dcsp assert true new shapes0 new shapes1 dcnl dcsp assert true new shapes2 new shapes2 dcnl dcsp assert true new shapes3 new shapes3 dcnl dcsp old shapes new shapes dcnl dcsp epochs equalize event counts a b c dcnl dcsp new shapes epochskey events shape0 for key in a b c d dcnl dcsp assert true new shapes0 + new shapes1 new shapes2 dcnl dcsp assert true new shapes3 old shapes3 dcnl dcsp assert raises keyerror epochs equalize event counts 1 a dcnl dcsp old shapes new shapes dcnl dcsp epochs equalize event counts a b c d dcnl dcsp new shapes epochskey events shape0 for key in a b c d dcnl dcsp assert true old shapes0 + old shapes1 new shapes0 + new shapes1 dcnl dcsp assert true new shapes0 + new shapes1 new shapes2 + new shapes3 dcnl dcsp assert raises valueerror combine event ids epochs a b ab 1 dcnl dcsp combine event ids epochs a b ab 12 copy false dcnl dcsp caught 0 dcnl dcsp for key in a b dcnl dcsp dcsp try dcnl dcsp dcsp dcsp epochskey dcnl dcsp dcsp except keyerror dcnl dcsp dcsp dcsp caught + 1 dcnl dcsp assert equal caught 2 dcnl dcsp assert true not np any epochs events 2 1 dcnl dcsp assert true not np any epochs events 2 2 dcnl dcsp epochs combine event ids epochs c d cd 34 dcnl dcsp assert true np all np logical or epochs events 2 12 epochs events 2 34 dcnl dcsp assert true epochs ab events shape0 old shapes0 + old shapes1 dcnl dcsp assert true epochs ab events shape0 epochs cd events shape0 dcnl dcsp epochs epochs raw events a x 1 b x 2 a y 3 b y 4 tmin tmax picks picks reject reject dcnl dcsp cond1 cond2 a b x b y a x a y b dcnl dcsp es epochs copy equalize event counts c 0 for c in cond1 cond2 dcnl dcsp assert array equal es0 events 0 es1 events 0 dcnl dcsp cond1 cond2 a b b y a x a y x dcnl dcsp for c in cond1 cond2 dcnl dcsp dcsp assert raises valueerror epochs equalize event counts c dcnl dcsp assert raises keyerror epochs equalize event counts a no match b dcnl dcsp epochs drop np arange 10 dcnl dcsp assert equal len epochs a x 0 dcnl dcsp assert true len epochs a y 0 dcnl dcsp epochs equalize event counts a x a y dcnl dcsp assert equal len epochs a x 0 dcnl dcsp assert equal len epochs a y 0
def test access by name dcsp tempdir tempdir dcnl dcsp raw events picks get data dcnl dcsp assert raises typeerror epochs raw events 1 42 2 42 tmin tmax picks picks dcnl dcsp assert raises typeerror epochs raw events a spam 2 eggs tmin tmax picks picks dcnl dcsp assert raises typeerror epochs raw events a spam 2 eggs tmin tmax picks picks dcnl dcsp assert raises typeerror epochs raw events foo tmin tmax picks picks dcnl dcsp assert raises typeerror epochs raw events foo tmin tmax picks picks dcnl dcsp event id illegal dict aud l 1 does not exist 12345678 dcnl dcsp assert raises valueerror epochs raw events event id illegal tmin tmax dcnl dcsp assert raises valueerror epochs raw events 1 tmin tmax on missing foo dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp epochs raw events event id illegal tmin tmax on missing warning dcnl dcsp dcsp nw len w dcnl dcsp dcsp assert true 1 < nw < 2 dcnl dcsp dcsp epochs raw events event id illegal tmin tmax on missing ignore dcnl dcsp dcsp assert equal len w nw dcnl dcsp epochs epochs raw events 1 2 tmin tmax picks picks dcnl dcsp for k v in epochs event id items dcnl dcsp dcsp assert equal int k v dcnl dcsp epochs epochs raw events a 1 b 2 tmin tmax picks picks dcnl dcsp assert raises keyerror epochs getitem bar dcnl dcsp data epochs a get data dcnl dcsp event a events events 2 1 dcnl dcsp assert true len data len event a dcnl dcsp epochs epochs raw events a 1 b 2 tmin tmax picks picks preload true dcnl dcsp assert raises keyerror epochs getitem bar dcnl dcsp temp fname op join tempdir testepo fif dcnl dcsp epochs save temp fname dcnl dcsp epochs2 read epochs temp fname dcnl dcsp for ep in epochs epochs2 dcnl dcsp dcsp data ep a get data dcnl dcsp dcsp event a events events 2 1 dcnl dcsp dcsp assert true len data len event a dcnl dcsp assert array equal epochs2 a events epochs a events dcnl dcsp epochs3 epochs raw events a 1 b 2 c 3 d 4 tmin tmax picks picks preload true dcnl dcsp assert equal list sorted epochs3 a b event id values 1 2 dcnl dcsp epochs4 epochs a dcnl dcsp epochs5 epochs3 a dcnl dcsp assert array equal epochs4 events epochs5 events dcnl dcsp assert array almost equal epochs4 get data epochs5 get data 20 dcnl dcsp epochs6 epochs3 a b dcnl dcsp assert true all np logical or epochs6 events 2 1 epochs6 events 2 2 dcnl dcsp assert array equal epochs events epochs6 events dcnl dcsp assert array almost equal epochs get data epochs6 get data 20 dcnl dcsp assert equal epochs a name a dcnl dcsp assert equal epochs a b a name a
requires pandas dcnl def test to data frame dcsp raw events picks get data dcnl dcsp epochs epochs raw events a 1 b 2 tmin tmax picks picks dcnl dcsp assert raises valueerror epochs to data frame index foo bar dcnl dcsp assert raises valueerror epochs to data frame index qux dcnl dcsp assert raises valueerror epochs to data frame np arange 400 dcnl dcsp df epochs to data frame index condition epoch time picks list range epochs info nchan dcnl dcsp df2 epochs to data frame dcnl dcsp assert equal df index names df2 index names dcnl dcsp assert array equal df columns values epochs ch names dcnl dcsp data np hstack epochs get data dcnl dcsp assert true df columns epochs ch names all dcnl dcsp assert array equal df values 0 data0 10000000000000 0 dcnl dcsp assert array equal df values 2 data2 1000000000000000 0 dcnl dcsp for ind in time condition time condition time epoch dcnl dcsp dcsp df epochs to data frame picks 11 12 14 index ind dcnl dcsp dcsp assert true df index names ind if isinstance ind list else ind dcnl dcsp dcsp assert array equal sorted df reset index columns 3 sorted time condition epoch
def test epochs proj mixin dcsp raw events picks get data dcnl dcsp for proj in true false dcnl dcsp dcsp epochs epochs raw events 4 event id tmin tmax picks picks proj proj dcnl dcsp dcsp assert true all p active proj for p in epochs info projs dcnl dcsp dcsp if proj dcnl dcsp dcsp dcsp epochs get data dcnl dcsp dcsp dcsp assert true all p active proj for p in epochs info projs dcnl dcsp dcsp dcsp assert raises valueerror epochs add proj epochs info projs 0 remove existing true dcnl dcsp dcsp dcsp assert raises valueerror epochs add proj spam dcnl dcsp dcsp dcsp assert raises valueerror epochs del proj 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp projs deepcopy epochs info projs dcnl dcsp dcsp dcsp n proj len epochs info projs dcnl dcsp dcsp dcsp epochs del proj 0 dcnl dcsp dcsp dcsp assert true len epochs info projs n proj 1 dcnl dcsp dcsp dcsp epochs add proj projs remove existing false dcnl dcsp dcsp dcsp assert true len epochs info projs n proj dcnl dcsp dcsp dcsp epochs add proj projs 1 remove existing true dcnl dcsp dcsp dcsp assert true len epochs info projs n proj 1 dcnl dcsp assert raises valueerror epochs raw events 4 event id tmin tmax picks picks proj crazy dcnl dcsp for preload in true false dcnl dcsp dcsp epochs epochs raw events 4 event id tmin tmax picks picks proj delayed preload preload reject reject set eeg reference projection true dcnl dcsp dcsp epochs proj epochs raw events 4 event id tmin tmax picks picks proj true preload preload reject reject set eeg reference projection true apply proj dcnl dcsp dcsp epochs noproj epochs raw events 4 event id tmin tmax picks picks proj false preload preload reject reject dcnl dcsp dcsp epochs noproj set eeg reference projection true dcnl dcsp dcsp assert allclose epochs copy apply proj get data epochs proj get data rtol 1e10 atol 1e25 dcnl dcsp dcsp assert allclose epochs get data epochs noproj get data rtol 1e10 atol 1e25 dcnl dcsp dcsp assert array equal epochs get data epochs get data dcnl dcsp dcsp assert array equal epochs proj get data epochs proj get data dcnl dcsp dcsp assert array equal epochs noproj get data epochs noproj get data dcnl dcsp data epochs get data copy dcnl dcsp data2 np array e for e in epochs dcnl dcsp assert array equal data data2 dcnl dcsp epochs apply proj dcnl dcsp assert array equal epochs projector epochs proj projector dcnl dcsp assert allclose epochs data epochs proj get data dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks picks baseline none proj false set eeg reference projection true dcnl dcsp data epochs get data copy dcnl dcsp epochs apply proj dcnl dcsp assert allclose np dot epochs projector data0 epochs data0
def test delayed epochs dcsp raw events picks get data dcnl dcsp events events 10 dcnl dcsp picks np concatenate pick types raw info meg true eeg true 22 pick types raw info meg false eeg false ecg true eog true dcnl dcsp picks np sort picks dcnl dcsp raw load data pick channels raw ch namespick for pick in picks dcnl dcsp raw info normalize proj dcnl dcsp del picks dcnl dcsp n epochs 2 dcnl dcsp raw info lowpass 40 0 dcnl dcsp for decim in 1 3 dcnl dcsp dcsp proj data epochs raw events event id tmin tmax proj true reject reject decim decim dcnl dcsp dcsp use tmin proj data tmin dcnl dcsp dcsp proj data proj data get data dcnl dcsp dcsp noproj data epochs raw events event id tmin tmax proj false reject reject decim decim get data dcnl dcsp dcsp assert equal proj data shape noproj data shape dcnl dcsp dcsp assert equal proj data shape0 n epochs dcnl dcsp dcsp for preload in true false dcnl dcsp dcsp dcsp for proj in true false delayed dcnl dcsp dcsp dcsp dcsp for ii in range 3 dcnl dcsp dcsp dcsp dcsp dcsp print decim preload proj ii dcnl dcsp dcsp dcsp dcsp dcsp comp proj data if proj is true else noproj data dcnl dcsp dcsp dcsp dcsp dcsp if ii in 0 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp epochs epochs raw events event id tmin tmax proj proj reject reject preload preload decim decim dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp fake events np zeros len comp 3 int dcnl dcsp dcsp dcsp dcsp dcsp dcsp fake events 0 np arange len comp dcnl dcsp dcsp dcsp dcsp dcsp dcsp fake events 2 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp epochs epochsarray comp raw info tmin use tmin event id 1 events fake events proj proj dcnl dcsp dcsp dcsp dcsp dcsp dcsp epochs info sfreq decim dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert equal len epochs n epochs dcnl dcsp dcsp dcsp dcsp dcsp assert true raw proj is false dcnl dcsp dcsp dcsp dcsp dcsp assert true epochs proj is true if proj is true else false dcnl dcsp dcsp dcsp dcsp dcsp if ii 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp epochs load data dcnl dcsp dcsp dcsp dcsp dcsp picks data pick types epochs info meg true eeg true dcnl dcsp dcsp dcsp dcsp dcsp evoked epochs average picks picks data dcnl dcsp dcsp dcsp dcsp dcsp assert equal evoked nave n epochs epochs drop log dcnl dcsp dcsp dcsp dcsp dcsp if proj is true dcnl dcsp dcsp dcsp dcsp dcsp dcsp evoked apply proj dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert true evoked proj is false dcnl dcsp dcsp dcsp dcsp dcsp assert array equal evoked ch names np array epochs ch names picks data dcnl dcsp dcsp dcsp dcsp dcsp assert allclose evoked times epochs times dcnl dcsp dcsp dcsp dcsp dcsp epochs data epochs get data dcnl dcsp dcsp dcsp dcsp dcsp assert allclose evoked data epochs data mean axis 0 picks data rtol 1e05 atol 1e20 dcnl dcsp dcsp dcsp dcsp dcsp assert allclose epochs data comp rtol 1e05 atol 1e20
def test drop epochs dcsp raw events picks get data dcnl dcsp epochs epochs raw events event id tmin tmax picks picks dcnl dcsp events1 events events 2 event id dcnl dcsp assert raises indexerror epochs drop len epochs events dcnl dcsp assert raises indexerror epochs drop 1 dcnl dcsp assert raises valueerror epochs drop 1 2 3 4 dcnl dcsp assert array equal epochs selection np where events 2 event id 0 dcnl dcsp assert equal len epochs drop log len events dcnl dcsp assert true all epochs drop logk ignored for k in set range len events set epochs selection dcnl dcsp selection epochs selection copy dcnl dcsp n events len epochs events dcnl dcsp epochs drop 2 4 reason d dcnl dcsp assert equal epochs drop log stats 2 0 n events 100 dcnl dcsp assert equal len epochs drop log len events dcnl dcsp assert equal epochs drop logk for k in selection2 4 d d dcnl dcsp assert array equal eventsepochs selection events10 1 3 5 6 dcnl dcsp assert array equal eventsepochs3 selection events15 6 dcnl dcsp assert array equal eventsepochs 1 selection events10 1 3 5 6
def test drop epochs mult dcsp raw events picks get data dcnl dcsp for preload in true false dcnl dcsp dcsp epochs1 epochs raw events a 1 b 2 tmin tmax picks picks reject reject preload preload a dcnl dcsp dcsp epochs2 epochs raw events a 1 tmin tmax picks picks reject reject preload preload dcnl dcsp dcsp if preload dcnl dcsp dcsp dcsp assert equal len epochs1 drop log len epochs2 drop log dcnl dcsp dcsp dcsp for d1 d2 in zip epochs1 drop log epochs2 drop log dcnl dcsp dcsp dcsp dcsp if d1 ignored dcnl dcsp dcsp dcsp dcsp dcsp assert true d2 ignored dcnl dcsp dcsp dcsp dcsp if d1 ignored and d1 dcnl dcsp dcsp dcsp dcsp dcsp assert true d2 d1 or d2 ignored dcnl dcsp dcsp dcsp dcsp if d1 dcnl dcsp dcsp dcsp dcsp dcsp assert true d2 dcnl dcsp dcsp dcsp assert array equal epochs1 events epochs2 events dcnl dcsp dcsp dcsp assert array equal epochs1 selection epochs2 selection dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert equal epochs1 drop log epochs2 drop log dcnl dcsp dcsp dcsp assert array equal epochs1 events epochs2 events dcnl dcsp dcsp dcsp assert array equal epochs1 selection epochs2 selection
def test contains dcsp raw events get data true 2 dcnl dcsp seeg rawarray np zeros 1 len raw times create info seeg dcsp 001 raw info sfreq seeg dcnl dcsp for key in dev head t buffer size sec highpass lowpass dig description acq pars experimenter proj name dcnl dcsp dcsp seeg infokey raw infokey dcnl dcsp raw add channels seeg dcnl dcsp tests mag false false grad eeg seeg grad false false mag eeg seeg false true false grad mag seeg false false true grad mag eeg dcnl dcsp for meg eeg seeg others in tests dcnl dcsp dcsp picks contains pick types raw info meg meg eeg eeg seeg seeg dcnl dcsp dcsp epochs epochs raw events a 1 b 2 tmin tmax picks picks contains dcnl dcsp dcsp if eeg dcnl dcsp dcsp dcsp test eeg dcnl dcsp dcsp elif seeg dcnl dcsp dcsp dcsp test seeg dcnl dcsp dcsp else dcnl dcsp dcsp dcsp test meg dcnl dcsp dcsp assert true test in epochs dcnl dcsp dcsp assert true not any o in epochs for o in others dcnl dcsp assert raises valueerror epochs contains foo dcnl dcsp assert raises valueerror epochs contains 1
def test drop channels mixin dcsp raw events get data 2 dcnl dcsp epochs epochs raw events event id tmin tmax preload true dcnl dcsp drop ch epochs ch names 3 dcnl dcsp ch names epochs ch names3 dcnl dcsp ch names orig epochs ch names dcnl dcsp dummy epochs copy drop channels drop ch dcnl dcsp assert equal ch names dummy ch names dcnl dcsp assert equal ch names orig epochs ch names dcnl dcsp assert equal len ch names orig epochs get data shape1 dcnl dcsp epochs drop channels drop ch dcnl dcsp assert equal ch names epochs ch names dcnl dcsp assert equal len ch names epochs get data shape1
def test pick channels mixin dcsp raw events picks get data dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true dcnl dcsp ch names epochs ch names 3 dcnl dcsp epochs preload false dcnl dcsp assert raises runtimeerror epochs drop channels ch names0 dcnl dcsp epochs preload true dcnl dcsp ch names orig epochs ch names dcnl dcsp dummy epochs copy pick channels ch names dcnl dcsp assert equal ch names dummy ch names dcnl dcsp assert equal ch names orig epochs ch names dcnl dcsp assert equal len ch names orig epochs get data shape1 dcnl dcsp epochs pick channels ch names dcnl dcsp assert equal ch names epochs ch names dcnl dcsp assert equal len ch names epochs get data shape1 dcnl dcsp assert raises valueerror epochs raw events event id tmin tmax picks
def test equalize channels dcsp raw events picks get data dcnl dcsp epochs1 epochs raw events event id tmin tmax picks picks proj false preload true dcnl dcsp epochs2 epochs1 copy dcnl dcsp ch names epochs1 ch names2 dcnl dcsp epochs1 drop channels epochs1 ch names 1 dcnl dcsp epochs2 drop channels epochs2 ch names1 2 dcnl dcsp my comparison epochs1 epochs2 dcnl dcsp equalize channels my comparison dcnl dcsp for e in my comparison dcnl dcsp dcsp assert equal ch names e ch names
def test illegal event id dcsp raw events picks get data dcnl dcsp event id illegal dict aud l 1 does not exist 12345678 dcnl dcsp assert raises valueerror epochs raw events event id illegal tmin tmax picks picks proj false
def test add channels epochs dcsp raw events picks get data dcnl dcsp def make epochs picks proj dcnl dcsp dcsp return epochs raw events event id tmin tmax preload true proj proj picks picks dcnl dcsp picks pick types raw info meg true eeg true exclude bads dcnl dcsp picks meg pick types raw info meg true eeg false exclude bads dcnl dcsp picks eeg pick types raw info meg false eeg true exclude bads dcnl dcsp for proj in false true dcnl dcsp dcsp epochs make epochs picks picks proj proj dcnl dcsp dcsp epochs meg make epochs picks picks meg proj proj dcnl dcsp dcsp epochs eeg make epochs picks picks eeg proj proj dcnl dcsp dcsp epochs info check consistency dcnl dcsp dcsp epochs meg info check consistency dcnl dcsp dcsp epochs eeg info check consistency dcnl dcsp dcsp epochs2 add channels epochs epochs meg epochs eeg dcnl dcsp dcsp assert equal len epochs info projs len epochs2 info projs dcnl dcsp dcsp assert equal len epochs info keys len epochs meg info keys dcnl dcsp dcsp assert equal len epochs info keys len epochs eeg info keys dcnl dcsp dcsp assert equal len epochs info keys len epochs2 info keys dcnl dcsp dcsp data1 epochs get data dcnl dcsp dcsp data2 epochs2 get data dcnl dcsp dcsp data3 np concatenate e get data for e in epochs meg epochs eeg axis 1 dcnl dcsp dcsp assert array equal data1 shape data2 shape dcnl dcsp dcsp assert allclose data1 data3 atol 1e25 dcnl dcsp dcsp assert allclose data1 data2 atol 1e25 dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info meas date + 10 dcnl dcsp add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs2 add channels epochs epochs meg epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 events 3 2 1 dcnl dcsp assert raises valueerror add channels epochs epochs meg2 epochs eeg dcnl dcsp assert raises valueerror add channels epochs epochs meg epochs eeg 2 dcnl dcsp epochs meg info chs pop 0 dcnl dcsp epochs meg info update redundant dcnl dcsp assert raises runtimeerror add channels epochs epochs meg epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info sfreq none dcnl dcsp assert raises runtimeerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info sfreq + 10 dcnl dcsp assert raises runtimeerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info chs 1 ch name epochs meg2 info ch names 0 dcnl dcsp epochs meg2 info update redundant dcnl dcsp assert raises runtimeerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info dev head t to + 1 dcnl dcsp assert raises valueerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info dev head t to + 1 dcnl dcsp assert raises valueerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 info expimenter foo dcnl dcsp assert raises runtimeerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 preload false dcnl dcsp assert raises valueerror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 times + 0 4 dcnl dcsp assert raises notimplementederror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 times + 0 5 dcnl dcsp assert raises notimplementederror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 baseline none dcnl dcsp assert raises notimplementederror add channels epochs epochs meg2 epochs eeg dcnl dcsp epochs meg2 epochs meg copy dcnl dcsp epochs meg2 event id b 2 dcnl dcsp assert raises notimplementederror add channels epochs epochs meg2 epochs eeg
def test array epochs dcsp import matplotlib pyplot as plt dcnl dcsp tempdir tempdir dcnl dcsp data rng random sample 10 20 300 dcnl dcsp sfreq 1000 0 dcnl dcsp ch names eeg dcsp 03d i + 1 for i in range 20 dcnl dcsp types eeg 20 dcnl dcsp info create info ch names sfreq types dcnl dcsp events np c np arange 1 600 60 np zeros 10 int 1 2 5 dcnl dcsp event id a 1 b 2 dcnl dcsp epochs epochsarray data info events tmin event id dcnl dcsp assert true str epochs startswith <epochsarray dcnl dcsp assert raises valueerror epochsarray data 1 info events tmin event id dcnl dcsp assert raises valueerror epochsarray data info events tmin dict a 1 dcnl dcsp temp fname op join tempdir testepo fif dcnl dcsp epochs save temp fname dcnl dcsp epochs2 read epochs temp fname dcnl dcsp data2 epochs2 get data dcnl dcsp assert allclose data data2 dcnl dcsp assert allclose epochs times epochs2 times dcnl dcsp assert equal epochs event id epochs2 event id dcnl dcsp assert array equal epochs events epochs2 events dcnl dcsp epochs0 plot dcnl dcsp plt close all dcnl dcsp assert array equal np unique epochs a events 2 np array 1 dcnl dcsp assert equal len epochs 2 2 dcnl dcsp data 0 5 150 3000 dcnl dcsp data1 0 dcnl dcsp data 2 5 210 3000 dcnl dcsp data 3 5 260 0 dcnl dcsp epochs epochsarray data info events events event id event id tmin 0 reject dict eeg 1000 flat dict eeg 0 1 reject tmin 0 1 reject tmax 0 2 dcnl dcsp assert equal len epochs len events 2 dcnl dcsp assert equal epochs drop log0 eeg dcsp 006 dcnl dcsp assert equal len epochs drop log 10 dcnl dcsp assert equal len epochs events len epochs selection dcnl dcsp data np ones 10 20 300 dcnl dcsp epochs epochsarray data info events event id event id tmin 0 2 baseline none 0 dcnl dcsp ep data epochs get data dcnl dcsp assert array equal ep data np zeros like ep data dcnl dcsp epochs epochsarray data 1 info events events event id event id tmin 0 0 dcnl dcsp assert allclose epochs times 0 0 dcnl dcsp assert allclose epochs get data data 1 dcnl dcsp epochs save temp fname dcnl dcsp epochs read read epochs temp fname dcnl dcsp assert allclose epochs read times 0 0 dcnl dcsp assert allclose epochs read get data data 1 dcnl dcsp mask events 2 1 dcnl dcsp data 1 datamask dcnl dcsp events 1 eventsmask dcnl dcsp epochs epochsarray data 1 info events events 1 event id 1 tmin 0 2 dcnl dcsp epochs epochsarray data 1 info dcnl dcsp assert array equal epochs events 0 np arange len data 1 dcnl dcsp assert array equal epochs events 1 np zeros len data 1 int dcnl dcsp assert array equal epochs events 2 np ones len data 1 int
def test concatenate epochs dcsp raw events picks get data dcnl dcsp epochs epochs raw raw events events event id event id tmin tmin tmax tmax picks picks dcnl dcsp epochs2 epochs copy dcnl dcsp epochs list epochs epochs2 dcnl dcsp epochs conc concatenate epochs epochs list dcnl dcsp assert array equal epochs conc events 0 np unique epochs conc events 0 dcnl dcsp expected shape list epochs get data shape dcnl dcsp expected shape0 2 dcnl dcsp expected shape tuple expected shape dcnl dcsp assert equal epochs conc get data shape expected shape dcnl dcsp assert equal epochs conc drop log epochs drop log 2 dcnl dcsp epochs2 epochs copy dcnl dcsp epochs2 data epochs2 get data dcnl dcsp epochs2 preload true dcnl dcsp assert raises valueerror concatenate epochs epochs epochs2 copy drop channels epochs2 ch names 1 dcnl dcsp epochs2 times np delete epochs2 times 1 dcnl dcsp assert raises valueerror concatenate epochs epochs epochs2 dcnl dcsp assert equal epochs conc raw none dcnl dcsp epochs2 baseline 0 1 none dcnl dcsp assert raises valueerror concatenate epochs epochs epochs2 dcnl dcsp epochs2 epochs copy dcnl dcsp concatenate epochs epochs epochs2 dcnl dcsp epochs2 info dev head t trans 3 3 + 0 0001 dcnl dcsp assert raises valueerror concatenate epochs epochs epochs2 dcnl dcsp assert raises typeerror concatenate epochs foo dcnl dcsp assert raises typeerror concatenate epochs epochs foo dcnl dcsp epochs2 info dev head t none dcnl dcsp assert raises valueerror concatenate epochs epochs epochs2 dcnl dcsp epochs info dev head t none dcnl dcsp concatenate epochs epochs epochs2 dcnl dcsp epochs1 epochs copy dcnl dcsp epochs2 epochs copy dcnl dcsp epochs1 event id dict a 1 dcnl dcsp epochs2 event id dict a 2 dcnl dcsp assert raises valueerror concatenate epochs epochs1 epochs2 dcnl dcsp epochs list epochs copy for ii in range 3 dcnl dcsp epochs cat concatenate epochs epochs list dcnl dcsp for ii in range 3 dcnl dcsp dcsp evs epochs cat events ii len epochs ii + 1 len epochs dcnl dcsp dcsp rel pos epochs listii events 0 evs 0 dcnl dcsp dcsp assert true sum rel pos rel pos0 0
def test add channels dcsp raw events picks get data dcnl dcsp epoch nopre epochs raw raw events events event id event id tmin tmin tmax tmax picks picks dcnl dcsp epoch epochs raw raw events events event id event id tmin tmin tmax tmax picks picks preload true dcnl dcsp epoch eeg epoch copy pick types meg false eeg true dcnl dcsp epoch meg epoch copy pick types meg true dcnl dcsp epoch stim epoch copy pick types meg false stim true dcnl dcsp epoch eeg meg epoch copy pick types meg true eeg true dcnl dcsp epoch new epoch meg copy add channels epoch eeg epoch stim dcnl dcsp assert true all ch in epoch new ch names for ch in epoch stim ch names + epoch meg ch names dcnl dcsp epoch new epoch meg copy add channels epoch eeg dcnl dcsp assert true ch in epoch new ch names for ch in epoch ch names dcnl dcsp assert array equal epoch new data epoch eeg meg data dcnl dcsp assert true all ch not in epoch new ch names for ch in epoch stim ch names dcnl dcsp epoch badsf epoch eeg copy dcnl dcsp epoch badsf info sfreq 3 1415927 dcnl dcsp epoch eeg epoch eeg crop 0 1 0 1 dcnl dcsp assert raises assertionerror epoch meg add channels epoch nopre dcnl dcsp assert raises runtimeerror epoch meg add channels epoch badsf dcnl dcsp assert raises assertionerror epoch meg add channels epoch eeg dcnl dcsp assert raises valueerror epoch meg add channels epoch meg dcnl dcsp assert raises assertionerror epoch meg add channels epoch badsf
def test seeg ecog dcsp n epochs n channels n times sfreq 5 10 20 1000 0 dcnl dcsp data np ones n epochs n channels n times dcnl dcsp events np array np arange n epochs 0 n epochs 1 n epochs t dcnl dcsp pick dict dict meg false exclude dcnl dcsp for key in seeg ecog dcnl dcsp dcsp info create info n channels sfreq key dcnl dcsp dcsp epochs epochsarray data info events dcnl dcsp dcsp pick dict update key true dcnl dcsp dcsp picks pick types epochs info pick dict dcnl dcsp dcsp del pick dictkey dcnl dcsp dcsp assert equal len picks n channels
def test default values dcsp raw events get data 2 dcnl dcsp epoch 1 epochs raw events 1 preload true dcnl dcsp epoch 2 epochs raw events 1 tmin 0 2 tmax 0 5 preload true dcnl dcsp assert equal hash epoch 1 hash epoch 2
def assert line endings dir dcsp if sys platform win32 dcnl dcsp dcsp raise skiptest skipping dcsp line dcsp endings dcsp check dcsp on dcsp windows dcnl dcsp report list dcnl dcsp good exts py dat sel lout css js lay txt elc csd sfp json hpts vmrk vhdr head eve ave cov label dcnl dcsp for dirpath dirnames filenames in os walk dir dcnl dcsp dcsp for fname in filenames dcnl dcsp dcsp dcsp if op splitext fname 1 not in good exts or fname in skip files dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp filename op join dirpath fname dcnl dcsp dcsp dcsp relfilename op relpath filename dir dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp with open filename rb as fid dcnl dcsp dcsp dcsp dcsp dcsp text fid read decode utf8 dcnl dcsp dcsp dcsp except unicodedecodeerror dcnl dcsp dcsp dcsp dcsp report append in dcsp s dcsp found dcsp nondecodable dcsp bytes relfilename dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp crcount text count r dcnl dcsp dcsp dcsp dcsp if crcount dcnl dcsp dcsp dcsp dcsp dcsp report append in dcsp s dcsp found dcsp i i dcsp cr lf relfilename crcount text count n dcnl dcsp if len report 0 dcnl dcsp dcsp raise assertionerror found dcsp s dcsp files dcsp with dcsp incorrect dcsp endings n s len report n join report
def test line endings dcsp tempdir tempdir dcnl dcsp with open op join tempdir foo wb as fid dcnl dcsp dcsp fid write bad r ngood n encode ascii dcnl dcsp assert line endings tempdir dcnl dcsp with open op join tempdir bad py wb as fid dcnl dcsp dcsp fid write x97 dcnl dcsp assert raises assertionerror assert line endings tempdir dcnl dcsp with open op join tempdir bad py wb as fid dcnl dcsp dcsp fid write bad r ngood n encode ascii dcnl dcsp assert raises assertionerror assert line endings tempdir dcnl dcsp assert line endings get root dir
def test coregister fiducials dcsp trans transform head mri rotation 0 4 0 1 0 dot translation 0 1 0 1 0 1 dcnl dcsp coords orig np array 0 08061612 0 02908875 0 04131077 0 00146763 0 08506715 0 03483611 0 08436285 0 02850276 0 04127743 dcnl dcsp coords trans apply trans trans coords orig dcnl dcsp def make dig coords cf dcnl dcsp dcsp return coord frame cf ident 1 kind 1 r coords0 coord frame cf ident 2 kind 1 r coords1 coord frame cf ident 3 kind 1 r coords2 dcnl dcsp mri fiducials make dig coords trans fiff fiffv coord mri dcnl dcsp info dig make dig coords orig fiff fiffv coord head dcnl dcsp trans est coregister fiducials info mri fiducials dcnl dcsp assert equal trans est from str trans from str dcnl dcsp assert equal trans est to str trans to str dcnl dcsp assert array almost equal trans est trans trans trans
requires freesurfer dcnl requires version scipy 0 11 dcnl def test scale mri dcsp tempdir tempdir dcnl dcsp create default subject subjects dir tempdir dcnl dcsp is mri is mri subject fsaverage tempdir dcnl dcsp assert true is mri creating dcsp fsaverage dcsp failed dcnl dcsp fid path os path join tempdir fsaverage bem fsaveragefiducials fif dcnl dcsp os remove fid path dcnl dcsp create default subject update true subjects dir tempdir dcnl dcsp assert true os path exists fid path updating dcsp fsaverage dcnl dcsp label temp os path join tempdir fsaverage label label dcnl dcsp label paths glob label temp dcnl dcsp for label path in label paths1 dcnl dcsp dcsp os remove label path dcnl dcsp path os path join tempdir fsaverage bem fsaverageico0src fif dcnl dcsp src mne setup source space fsaverage ico0 subjects dir tempdir add dist false dcnl dcsp src path os path join tempdir fsaverage bem fsaverageico0src fif dcnl dcsp write source spaces src path src dcnl dcsp os environ mne few surfaces true dcnl dcsp scale mri fsaverage flachkopf 1 0 2 0 8 true subjects dir tempdir dcnl dcsp del os environ mne few surfaces dcnl dcsp is mri is mri subject flachkopf tempdir dcnl dcsp assert true is mri scaling dcsp fsaverage dcsp failed dcnl dcsp src path os path join tempdir flachkopf bem flachkopfico0src fif dcnl dcsp assert true os path exists src path source dcsp space dcsp was dcsp not dcsp scaled dcnl dcsp scale labels flachkopf subjects dir tempdir dcnl dcsp os remove src path dcnl dcsp scale source space flachkopf ico0 subjects dir tempdir dcnl dcsp assert true os path exists src path source dcsp space dcsp was dcsp not dcsp scaled dcnl dcsp src mne read source spaces path dcnl dcsp mne add source space distances src dcnl dcsp src save path overwrite true dcnl dcsp os remove src path dcnl dcsp scale source space flachkopf ico0 subjects dir tempdir dcnl dcsp assert true os path exists src path source dcsp space dcsp was dcsp not dcsp scaled
def test fit matched points dcsp tgt pts np random randomstate 42 uniform size 6 3 dcnl dcsp trans rotation 2 6 3 dcnl dcsp src pts apply trans trans tgt pts dcnl dcsp trans est fit matched points src pts tgt pts translate false out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp assert array almost equal tgt pts est pts 2 fit matched points dcsp with dcsp rotation dcnl dcsp trans np dot rotation 2 6 3 scaling 0 5 0 5 0 5 dcnl dcsp src pts apply trans trans tgt pts dcnl dcsp trans est fit matched points src pts tgt pts translate false scale 1 out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp assert array almost equal tgt pts est pts 2 fit matched points dcsp with dcsp rotation dcsp and dcsp scaling dcnl dcsp trans np dot translation 2 6 3 rotation 2 6 3 dcnl dcsp src pts apply trans trans tgt pts dcnl dcsp trans est fit matched points src pts tgt pts out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp assert array almost equal tgt pts est pts 2 fit matched points dcsp with dcsp rotation dcsp and dcsp translation dcnl dcsp trans reduce np dot translation 2 6 3 rotation 1 5 0 3 1 4 scaling 0 5 0 5 0 5 dcnl dcsp src pts apply trans trans tgt pts dcnl dcsp trans est fit matched points src pts tgt pts scale 1 out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp assert array almost equal tgt pts est pts 2 fit matched points dcsp with dcsp rotation dcsp translation dcsp and dcsp scaling dcnl dcsp tgt pts0 + 20 dcnl dcsp assert raises runtimeerror fit matched points tgt pts src pts tol 10
def test fit point cloud dcsp u np linspace 0 np pi 150 dcnl dcsp v np linspace 0 np pi 150 dcnl dcsp x np outer np cos u np sin v reshape 1 1 dcnl dcsp y np outer np sin u np sin v reshape 1 1 dcnl dcsp z np outer np ones np size u np cos v reshape 1 1 3 dcnl dcsp tgt pts np hstack x y z dcnl dcsp tgt pts decimate points tgt pts 0 05 dcnl dcsp some tgt pts tgt pts 362 dcnl dcsp trans rotation 1 5 0 3 0 4 dcnl dcsp src pts apply trans trans some tgt pts dcnl dcsp trans est fit point cloud src pts tgt pts rotate true translate false scale 0 out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp err point cloud error est pts tgt pts dcnl dcsp assert array less err 0 1 fit point cloud dcsp with dcsp rotation dcnl dcsp trans np dot rotation 0 5 0 3 0 4 translation 0 3 0 2 0 2 dcnl dcsp src pts apply trans trans some tgt pts dcnl dcsp trans est fit point cloud src pts tgt pts rotate true translate true scale 0 out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp err point cloud error est pts tgt pts dcnl dcsp assert array less err 0 1 fit point cloud dcsp with dcsp rotation dcsp and dcsp translation dcnl dcsp trans np dot rotation 0 5 0 3 0 4 scaling 1 5 1 5 1 5 dcnl dcsp src pts apply trans trans some tgt pts dcnl dcsp trans est fit point cloud src pts tgt pts rotate true translate false scale 1 out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp err point cloud error est pts tgt pts dcnl dcsp assert array less err 0 1 fit point cloud dcsp with dcsp rotation dcsp and dcsp 1 dcsp scaling dcsp parameter dcnl dcsp trans np dot rotation 0 5 0 3 0 4 scaling 1 5 1 7 1 1 dcnl dcsp src pts apply trans trans some tgt pts dcnl dcsp trans est fit point cloud src pts tgt pts rotate true translate false scale 3 out trans dcnl dcsp est pts apply trans trans est src pts dcnl dcsp err point cloud error est pts tgt pts dcnl dcsp assert array less err 0 1 fit point cloud dcsp with dcsp rotation dcsp and dcsp 3 dcsp scaling dcsp parameters
def test handle default dcsp x deepcopy handle default scalings dcnl dcsp y handle default scalings dcnl dcsp z handle default scalings dict mag 1 grad 2 dcnl dcsp w handle default scalings dcnl dcsp assert equal set x keys set y keys dcnl dcsp assert equal set x keys set z keys dcnl dcsp for key in x keys dcnl dcsp dcsp assert equal xkey ykey dcnl dcsp dcsp assert equal xkey wkey dcnl dcsp dcsp if key in mag grad dcnl dcsp dcsp dcsp assert true xkey zkey dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert equal xkey zkey
def test bad proj dcsp raw read raw fif raw fname preload true dcnl dcsp events read events event fname dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks2 9 3 dcnl dcsp check warnings raw events picks dcnl dcsp raw pick channels raw ch namesii for ii in picks dcnl dcsp check warnings raw events dcnl dcsp raw info normalize proj dcnl dcsp check warnings raw events count 0 dcnl dcsp raw read raw fif raw fname preload true pick types meg false eeg true dcnl dcsp raw set eeg reference dcnl dcsp check warnings raw events count 0 dcnl dcsp raw info bads raw ch names 10 dcnl dcsp check warnings raw events count 0 dcnl dcsp raw read raw fif raw fname dcnl dcsp assert raises valueerror raw del proj foo dcnl dcsp n proj len raw info projs dcnl dcsp raw del proj 0 dcnl dcsp assert equal len raw info projs n proj 1 dcnl dcsp raw del proj dcnl dcsp assert equal len raw info projs 0 dcnl dcsp raw read raw fif raw fname crop 0 1 dcnl dcsp raw info bads meg dcsp 0111 dcnl dcsp meg picks mne pick types raw info meg true exclude dcnl dcsp ch names raw ch namespick for pick in meg picks dcnl dcsp for p in raw info projs 1 dcnl dcsp dcsp data np zeros 1 len ch names dcnl dcsp dcsp idx ch names index ch name for ch name in p data col names dcnl dcsp dcsp data idx p data data dcnl dcsp dcsp p data update ncol len meg picks col names ch names data data dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp mne cov regularize mne compute raw covariance raw verbose error raw info dcnl dcsp assert equal len w 0
def check warnings raw events picks none count 3 dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp epochs raw events dict aud l 1 vis l 3 0 2 0 5 picks picks preload true proj true dcnl dcsp assert equal len w count dcnl dcsp for ww in w dcnl dcsp dcsp assert true dangerous in str ww message
testing requires testing data dcnl def test sensitivity maps dcsp fwd mne read forward solution fwd fname surf ori true dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp projs read proj eog fname dcnl dcsp dcsp projs extend read proj ecg fname dcnl dcsp decim 6 dcnl dcsp for ch type in eeg grad mag dcnl dcsp dcsp w read source estimate sensmap fname ch type lh data dcnl dcsp dcsp stc sensitivity map fwd projs none ch type ch type mode free exclude bads dcnl dcsp dcsp assert array almost equal stc data w decim dcnl dcsp dcsp assert true stc subject sample dcnl dcsp dcsp if ch type grad dcnl dcsp dcsp dcsp w read source estimate sensmap fname ch type 2lh data dcnl dcsp dcsp dcsp stc sensitivity map fwd projs none mode fixed ch type ch type exclude bads dcnl dcsp dcsp dcsp assert array almost equal stc data w decim dcnl dcsp dcsp if ch type mag dcnl dcsp dcsp dcsp w read source estimate sensmap fname ch type 3lh data dcnl dcsp dcsp dcsp stc sensitivity map fwd projs none mode ratio ch type ch type exclude bads dcnl dcsp dcsp dcsp assert array almost equal stc data w decim dcnl dcsp dcsp if ch type eeg dcnl dcsp dcsp dcsp modes radiality angle remaining dampening dcnl dcsp dcsp dcsp ends 4lh 5lh 6lh 7lh dcnl dcsp dcsp dcsp for mode end in zip modes ends dcnl dcsp dcsp dcsp dcsp w read source estimate sensmap fname ch type end data dcnl dcsp dcsp dcsp dcsp stc sensitivity map fwd projs projs mode mode ch type ch type exclude bads dcnl dcsp dcsp dcsp dcsp assert array almost equal stc data w decim dcnl dcsp stc sensitivity map fwd projs make eeg average ref proj fwd info ch type eeg exclude bads dcnl dcsp assert raises valueerror sensitivity map fwd projs none mode angle dcnl dcsp assert raises runtimeerror sensitivity map fwd projs mode angle dcnl dcsp fname op join sample path sample audvis truncmegvol7fwd fif dcnl dcsp fwd mne read forward solution fname dcnl dcsp sensitivity map fwd
def test compute proj epochs dcsp tempdir tempdir dcnl dcsp event id tmin tmax 1 0 2 0 3 dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp events read events event fname dcnl dcsp bad ch meg dcsp 2443 dcnl dcsp picks pick types raw info meg true eeg false stim false eog false exclude dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none proj false dcnl dcsp evoked epochs average dcnl dcsp projs compute proj epochs epochs n grad 1 n mag 1 n eeg 0 n jobs 1 dcnl dcsp write proj op join tempdir testproj fif gz projs dcnl dcsp for p fname in proj fname proj gz fname op join tempdir testproj fif gz dcnl dcsp dcsp projs2 read proj p fname dcnl dcsp dcsp assert true len projs len projs2 dcnl dcsp dcsp for p1 p2 in zip projs projs2 dcnl dcsp dcsp dcsp assert true p1 desc p2 desc dcnl dcsp dcsp dcsp assert true p1 data col names p2 data col names dcnl dcsp dcsp dcsp assert true p1 active p2 active dcnl dcsp dcsp dcsp p1 data p1 data data np sign p1 data data 0 0 dcnl dcsp dcsp dcsp p2 data p2 data data np sign p2 data data 0 0 dcnl dcsp dcsp dcsp if bad ch in p1 data col names dcnl dcsp dcsp dcsp dcsp bad p1 data col names index meg dcsp 2443 dcnl dcsp dcsp dcsp dcsp mask np ones p1 data size dtype np bool dcnl dcsp dcsp dcsp dcsp maskbad false dcnl dcsp dcsp dcsp dcsp p1 data p1 data mask dcnl dcsp dcsp dcsp dcsp p2 data p2 data mask dcnl dcsp dcsp dcsp corr np corrcoef p1 data p2 data 0 1 dcnl dcsp dcsp dcsp assert array almost equal corr 1 0 5 dcnl dcsp dcsp dcsp if p2 explained var dcnl dcsp dcsp dcsp dcsp assert array almost equal p1 explained var p2 explained var dcnl dcsp projs activate proj projs dcnl dcsp proj nproj u make projector projs epochs ch names bads dcnl dcsp assert true nproj 2 dcnl dcsp assert true u shape1 2 dcnl dcsp epochs info projs + projs dcnl dcsp evoked epochs average dcnl dcsp evoked save op join tempdir fooave fif dcnl dcsp projs read proj proj fname dcnl dcsp projs evoked compute proj evoked evoked n grad 1 n mag 1 n eeg 0 dcnl dcsp assert true len projs evoked 2 dcnl dcsp projs compute proj epochs epochs n grad 1 n mag 1 n eeg 0 n jobs 1 desc prefix foobar dcnl dcsp assert true all foobar in x desc for x in projs dcnl dcsp projs activate proj projs dcnl dcsp proj par make projector projs epochs ch names bads dcnl dcsp assert allclose proj proj par rtol 1e08 atol 1e16 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp proj badname op join tempdir testbadname fif gz dcnl dcsp dcsp write proj proj badname projs dcnl dcsp dcsp read proj proj badname dcnl dcsp assert naming w test proj py 2
slow test dcnl def test compute proj raw dcsp tempdir tempdir dcnl dcsp raw time 2 5 dcnl dcsp raw read raw fif raw fname crop 0 raw time dcnl dcsp raw load data dcnl dcsp for ii in 0 25 0 5 1 2 dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp projs compute proj raw raw duration ii 0 1 stop raw time n grad 1 n mag 1 n eeg 0 dcnl dcsp dcsp dcsp assert true len w 1 dcnl dcsp dcsp projs activate proj projs dcnl dcsp dcsp proj nproj u make projector projs raw ch names bads dcnl dcsp dcsp assert true nproj 2 dcnl dcsp dcsp assert true u shape1 2 dcnl dcsp dcsp raw info projs + projs dcnl dcsp dcsp raw save op join tempdir foo d raw fif ii overwrite true dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp projs compute proj raw raw duration none stop raw time n grad 1 n mag 1 n eeg 0 dcnl dcsp dcsp assert equal len w 1 dcnl dcsp projs activate proj projs dcnl dcsp proj nproj u make projector projs raw ch names bads dcnl dcsp assert true nproj 2 dcnl dcsp assert true u shape1 2 dcnl dcsp raw info projs + projs dcnl dcsp raw save op join tempdir foo rawproj continuous raw fif dcnl dcsp raw resamp cp deepcopy raw dcnl dcsp raw resamp resample raw info sfreq 2 n jobs 2 npad auto dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp projs compute proj raw raw resamp duration none stop raw time n grad 1 n mag 1 n eeg 0 dcnl dcsp projs activate proj projs dcnl dcsp proj new make projector projs raw ch names bads dcnl dcsp assert array almost equal proj new proj 4 dcnl dcsp raw load bad channels bads fname dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp projs compute proj raw raw n grad 0 n mag 0 n eeg 1 dcnl dcsp proj nproj u make projector projs raw ch names bads raw ch names dcnl dcsp assert array almost equal proj np eye len raw ch names
def test make eeg average ref proj dcsp raw read raw fif raw fname preload true dcnl dcsp eeg mne pick types raw info meg false eeg true dcnl dcsp assert true not np all raw dataeeg mean axis 0 < 1e19 dcnl dcsp car make eeg average ref proj raw info dcnl dcsp reref raw copy dcnl dcsp reref add proj car dcnl dcsp reref apply proj dcnl dcsp assert array almost equal reref dataeeg mean axis 0 0 decimal 19 dcnl dcsp raw info custom ref applied true dcnl dcsp assert raises runtimeerror make eeg average ref proj raw info
def test has eeg average ref proj dcsp assert true not has eeg average ref proj dcnl dcsp raw read raw fif raw fname dcnl dcsp raw set eeg reference projection true dcnl dcsp assert true has eeg average ref proj raw info projs
def test needs eeg average ref proj dcsp raw read raw fif raw fname dcnl dcsp assert true needs eeg average ref proj raw info dcnl dcsp raw set eeg reference projection true dcnl dcsp assert true not needs eeg average ref proj raw info dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp eeg raw ch namesc for c in pick types raw info meg false eeg true dcnl dcsp raw drop channels eeg dcnl dcsp assert true not needs eeg average ref proj raw info dcnl dcsp raw read raw fif raw fname dcnl dcsp raw info custom ref applied true dcnl dcsp assert true not needs eeg average ref proj raw info
def stc to label stc src smooth subjects dir none dcsp src stc subject if src is none else src dcnl dcsp if isinstance src string types dcnl dcsp dcsp subject src dcnl dcsp else dcnl dcsp dcsp subject stc subject dcnl dcsp if isinstance src string types dcnl dcsp dcsp subjects dir get subjects dir subjects dir dcnl dcsp dcsp surf path from op join subjects dir src surf dcnl dcsp dcsp rr lh tris lh read surface op join surf path from lh white dcnl dcsp dcsp rr rh tris rh read surface op join surf path from rh white dcnl dcsp dcsp rr rr lh rr rh dcnl dcsp dcsp tris tris lh tris rh dcnl dcsp else dcnl dcsp dcsp if not isinstance src sourcespaces dcnl dcsp dcsp dcsp raise typeerror src dcsp must dcsp be dcsp a dcsp string dcsp or dcsp a dcsp set dcsp of dcsp source dcsp spaces dcnl dcsp dcsp if len src 2 dcnl dcsp dcsp dcsp raise valueerror source dcsp space dcsp should dcsp contain dcsp the dcsp 2 dcsp hemispheres dcnl dcsp dcsp rr 1000 0 src0 rr 1000 0 src1 rr dcnl dcsp dcsp tris src0 tris src1 tris dcnl dcsp labels dcnl dcsp cnt 0 dcnl dcsp for hemi idx hemi this vertno this tris this rr in enumerate zip lh rh stc vertices tris rr dcnl dcsp dcsp this data stc datacnt cnt + len this vertno dcnl dcsp dcsp e mesh edges this tris dcnl dcsp dcsp e data e data 2 1 dcnl dcsp dcsp n vertices e shape0 dcnl dcsp dcsp e e + sparse eye n vertices n vertices dcnl dcsp dcsp clusters this vertnonp any this data axis 1 dcnl dcsp dcsp cnt + len this vertno dcnl dcsp dcsp clusters c for c in clusters if len c 0 dcnl dcsp dcsp if len clusters 0 dcnl dcsp dcsp dcsp this labels none dcnl dcsp dcsp else dcnl dcsp dcsp dcsp this labels dcnl dcsp dcsp dcsp colors n colors len clusters dcnl dcsp dcsp dcsp for c color in zip clusters colors dcnl dcsp dcsp dcsp dcsp idx use c dcnl dcsp dcsp dcsp dcsp for k in range smooth dcnl dcsp dcsp dcsp dcsp dcsp e use e idx use dcnl dcsp dcsp dcsp dcsp dcsp data1 e use np ones len idx use dcnl dcsp dcsp dcsp dcsp dcsp idx use np where data1 0 dcnl dcsp dcsp dcsp dcsp label label idx use this rridx use none hemi label dcsp from dcsp stc subject subject color color dcnl dcsp dcsp dcsp dcsp this labels append label dcnl dcsp dcsp dcsp this labels this labels0 dcnl dcsp dcsp labels append this labels dcnl dcsp return labels
def test copy dcsp label read label label fname dcnl dcsp label 2 label copy dcnl dcsp label 2 pos + 1 dcnl dcsp assert array equal label pos label 2 pos 1
def test label subject dcsp label read label label fname dcnl dcsp assert is label subject none dcnl dcsp assert true unknown in repr label dcnl dcsp label read label label fname subject fsaverage dcnl dcsp assert true label subject fsaverage dcnl dcsp assert true fsaverage in repr label
def test label addition dcsp pos np random randomstate 0 rand 10 3 dcnl dcsp values np arange 10 0 10 dcnl dcsp idx0 list range 7 dcnl dcsp idx1 list range 7 10 dcnl dcsp idx2 list range 5 10 dcnl dcsp l0 label idx0 posidx0 valuesidx0 lh color red dcnl dcsp l1 label idx1 posidx1 valuesidx1 lh dcnl dcsp l2 label idx2 posidx2 valuesidx2 lh color 0 1 0 0 5 dcnl dcsp assert equal len l0 len idx0 dcnl dcsp l good l0 copy dcnl dcsp l good subject sample dcnl dcsp l bad l1 copy dcnl dcsp l bad subject foo dcnl dcsp assert raises valueerror l good add l bad dcnl dcsp assert raises typeerror l good add foo dcnl dcsp assert raises valueerror l good sub l bad dcnl dcsp assert raises typeerror l good sub foo dcnl dcsp l01 l0 + l1 dcnl dcsp assert equal len l01 len l0 + len l1 dcnl dcsp assert array equal l01 values len l0 l0 values dcnl dcsp assert equal l01 color l0 color dcnl dcsp assert labels equal l01 l0 l1 comment false color false dcnl dcsp assert labels equal l01 l1 l0 comment false color false dcnl dcsp l l0 + l2 dcnl dcsp i0 np where l0 vertices 6 00 dcnl dcsp i2 np where l2 vertices 6 00 dcnl dcsp i np where l vertices 6 00 dcnl dcsp assert equal l valuesi l0 valuesi0 + l2 valuesi2 dcnl dcsp assert equal l values0 l0 values0 dcnl dcsp assert array equal np unique l vertices np unique idx0 + idx2 dcnl dcsp assert equal l color blend colors l0 color l2 color dcnl dcsp l2 hemi rh dcnl dcsp bhl l0 + l2 dcnl dcsp assert equal bhl hemi both dcnl dcsp assert equal len bhl len l0 + len l2 dcnl dcsp assert equal bhl color l color dcnl dcsp assert true bihemilabel in repr bhl dcnl dcsp assert labels equal bhl l0 l2 dcnl dcsp assert labels equal bhl l2 l0 dcnl dcsp bhl2 l1 + bhl dcnl dcsp assert labels equal bhl2 lh l01 dcnl dcsp assert equal bhl2 color blend colors l1 color bhl color dcnl dcsp assert array equal l2 + bhl rh vertices bhl rh vertices dcnl dcsp assert array equal bhl + bhl lh vertices bhl lh vertices dcnl dcsp assert raises typeerror bhl add 5 dcnl dcsp bhl bhl2 l1 dcnl dcsp assert labels equal bhl lh bhl lh comment false color false dcnl dcsp assert labels equal bhl rh bhl rh dcnl dcsp assert labels equal bhl2 l2 l0 + l1 dcnl dcsp assert labels equal bhl2 l1 l0 l2 dcnl dcsp bhl bhl2 bhl2 dcnl dcsp assert array equal bhl vertices
testing requires testing data dcnl def test label in src dcsp src read source spaces src fname dcnl dcsp label read label v1 label fname dcnl dcsp vert in src np intersect1d label vertices src0 vertno true dcnl dcsp where np in1d label vertices vert in src dcnl dcsp pos in src label poswhere dcnl dcsp values in src label valueswhere dcnl dcsp label src label vert in src pos in src values in src hemi lh fill src dcnl dcsp vertices status np in1d src0 nearest label vertices dcnl dcsp vertices in np nonzero vertices status 0 dcnl dcsp vertices out np nonzero np logical not vertices status 0 dcnl dcsp assert array equal label src vertices vertices in dcnl dcsp assert array equal np in1d vertices out label src vertices false dcnl dcsp value idx np digitize src0 nearest vertices in vert in src true dcnl dcsp assert array equal label src values values in srcvalue idx dcnl dcsp vertices np append 1 vert in src dcnl dcsp assert raises valueerror label vertices hemi lh fill src dcnl dcsp label label hemi lh dcnl dcsp label fill src dcnl dcsp assert array equal label vertices np array int
testing requires testing data dcnl def test label io and time course estimates dcsp stc read source estimate stc fname dcnl dcsp label read label real label fname dcnl dcsp stc label stc in label label dcnl dcsp assert true len stc label times stc label data shape1 dcnl dcsp assert true len stc label vertices0 stc label data shape0
testing requires testing data dcnl def test label io dcsp tempdir tempdir dcnl dcsp label read label label fname dcnl dcsp assert equal label name testlh dcnl dcsp assert is label subject none dcnl dcsp assert is label color none dcnl dcsp label save op join tempdir foo dcnl dcsp label2 read label op join tempdir foolh label dcnl dcsp assert labels equal label label2 dcnl dcsp dest op join tempdir foo pickled dcnl dcsp with open dest wb as fid dcnl dcsp dcsp pickle dump label fid pickle highest protocol dcnl dcsp with open dest rb as fid dcnl dcsp dcsp label2 pickle load fid dcnl dcsp assert labels equal label label2
def assert labels equal labels a labels b ignore pos false dcsp for label a label b in zip labels a labels b dcnl dcsp dcsp assert array equal label a vertices label b vertices dcnl dcsp dcsp assert true label a name label b name dcnl dcsp dcsp assert true label a hemi label b hemi dcnl dcsp dcsp if not ignore pos dcnl dcsp dcsp dcsp assert array equal label a pos label b pos
testing requires testing data dcnl def test annot io dcsp tempdir tempdir dcnl dcsp subject fsaverage dcnl dcsp label src os path join subjects dir fsaverage label dcnl dcsp surf src os path join subjects dir fsaverage surf dcnl dcsp label dir os path join tempdir subject label dcnl dcsp surf dir os path join tempdir subject surf dcnl dcsp os makedirs label dir dcnl dcsp os mkdir surf dir dcnl dcsp shutil copy os path join label src lh pals b12 lobes annot label dir dcnl dcsp shutil copy os path join label src rh pals b12 lobes annot label dir dcnl dcsp shutil copy os path join surf src lh white surf dir dcnl dcsp shutil copy os path join surf src rh white surf dir dcnl dcsp assert raises ioerror read labels from annot subject pals b12 lobesey subjects dir tempdir dcnl dcsp labels read labels from annot subject pals b12 lobes subjects dir tempdir dcnl dcsp parc l for l in labels if l name lobe temporallh dcnl dcsp write labels to annot parc subject myparc subjects dir tempdir dcnl dcsp parc1 read labels from annot subject myparc subjects dir tempdir dcnl dcsp parc1 l for l in parc1 if not l name startswith unknown dcnl dcsp assert equal len parc1 len parc dcnl dcsp for l1 l in zip parc1 parc dcnl dcsp dcsp assert labels equal l1 l dcnl dcsp parc l for l in labels if l name startswith lobe dcnl dcsp write labels to annot parc subject myparc2 hemi lh subjects dir tempdir dcnl dcsp annot fname os path join tempdir subject label sh myparc2 annot dcnl dcsp assert true os path isfile annot fname l dcnl dcsp assert false os path isfile annot fname r dcnl dcsp parc1 read labels from annot subject myparc2 annot fname annot fname l subjects dir tempdir dcnl dcsp parc lh l for l in parc if l name endswith lh dcnl dcsp for l1 l in zip parc1 parc lh dcnl dcsp dcsp assert labels equal l1 l
testing requires testing data dcnl def test read labels from annot dcsp assert raises valueerror read labels from annot sample hemi bla subjects dir subjects dir dcnl dcsp assert raises valueerror read labels from annot sample annot fname bla annot subjects dir subjects dir dcnl dcsp labels lh read labels from annot sample hemi lh subjects dir subjects dir dcnl dcsp for label in labels lh dcnl dcsp dcsp assert true label name endswith lh dcnl dcsp dcsp assert true label hemi lh dcnl dcsp dcsp assert is not label color none dcnl dcsp annot fname op join subjects dir sample label rh aparc annot dcnl dcsp labels rh read labels from annot sample annot fname annot fname subjects dir subjects dir dcnl dcsp for label in labels rh dcnl dcsp dcsp assert true label name endswith rh dcnl dcsp dcsp assert true label hemi rh dcnl dcsp dcsp assert is not label color none dcnl dcsp labels lhrh list dcnl dcsp labels lhrh extend labels lh dcnl dcsp labels lhrh extend labels rh dcnl dcsp names label name for label in labels lhrh dcnl dcsp labels lhrh label for name label in sorted zip names labels lhrh dcnl dcsp labels both read labels from annot sample subjects dir subjects dir dcnl dcsp assert labels equal labels lhrh labels both dcnl dcsp assert true len labels both 68 dcnl dcsp label read labels from annot sample parc aparc a2009s regexp angu subjects dir subjects dir 0 dcnl dcsp assert true label name g pariet infangularlh dcnl dcsp label read labels from annot sample aparc a2009s regexp 4 3 3 l subjects dir subjects dir 0 dcnl dcsp assert true label name g octemp medlinguallh dcnl dcsp assert raises runtimeerror read labels from annot sample parc aparc annot fname annot fname regexp jacktheripper subjects dir subjects dir
testing requires testing data dcnl def test read labels from annot annot2labels dcsp label fnames glob glob label dir + label dcnl dcsp label fnames sort dcnl dcsp labels mne read label fname for fname in label fnames dcnl dcsp labels read labels from annot sample subjects dir subjects dir dcnl dcsp assert labels equal labels labels mne ignore pos true
testing requires testing data dcnl def test write labels to annot dcsp tempdir tempdir dcnl dcsp labels read labels from annot sample subjects dir subjects dir dcnl dcsp surf dir op join subjects dir sample surf dcnl dcsp temp surf dir op join tempdir sample surf dcnl dcsp os makedirs temp surf dir dcnl dcsp shutil copy op join surf dir lh white temp surf dir dcnl dcsp shutil copy op join surf dir rh white temp surf dir dcnl dcsp os makedirs op join tempdir sample label dcnl dcsp dst op join tempdir sample label s s annot dcnl dcsp write labels to annot labels sample test1 subjects dir tempdir dcnl dcsp assert true op exists dst lh test1 dcnl dcsp assert true op exists dst rh test1 dcnl dcsp for label in labels dcnl dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp break dcnl dcsp write labels to annot label sample test2 subjects dir tempdir dcnl dcsp assert true op exists dst lh test2 dcnl dcsp assert true op exists dst rh test2 dcnl dcsp for label in labels dcnl dcsp dcsp if label hemi rh dcnl dcsp dcsp dcsp break dcnl dcsp write labels to annot label sample test3 subjects dir tempdir dcnl dcsp assert true op exists dst lh test3 dcnl dcsp assert true op exists dst rh test3 dcnl dcsp assert raises typeerror write labels to annot labels0 sample test4 subjects dir tempdir dcnl dcsp fnames op join tempdir hemi + myparc for hemi in lh rh dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp for fname in fnames dcnl dcsp dcsp dcsp write labels to annot labels annot fname fname dcnl dcsp labels2 read labels from annot sample subjects dir subjects dir annot fname fnames0 dcnl dcsp labels22 read labels from annot sample subjects dir subjects dir annot fname fnames1 dcnl dcsp labels2 extend labels22 dcnl dcsp names label name for label in labels2 dcnl dcsp for label in labels dcnl dcsp dcsp idx names index label name dcnl dcsp dcsp assert labels equal label labels2idx dcnl dcsp for fname in fnames dcnl dcsp dcsp write labels to annot labels sample annot fname fname overwrite true subjects dir subjects dir dcnl dcsp labels3 read labels from annot sample subjects dir subjects dir annot fname fnames0 dcnl dcsp labels33 read labels from annot sample subjects dir subjects dir annot fname fnames1 dcnl dcsp labels3 extend labels33 dcnl dcsp names3 label name for label in labels3 dcnl dcsp for label in labels dcnl dcsp dcsp idx names3 index label name dcnl dcsp dcsp assert labels equal label labels3idx dcnl dcsp assert raises valueerror write labels to annot labels sample annot fname fnames0 subjects dir subjects dir dcnl dcsp write labels to annot labels sample annot fname fnames0 overwrite true subjects dir subjects dir dcnl dcsp labels labels dcnl dcsp labels 0 labels 0 copy dcnl dcsp labels 0 color none dcnl dcsp write labels to annot labels sample annot fname fnames0 overwrite true subjects dir subjects dir dcnl dcsp labels 0 color labels 2 color dcnl dcsp assert raises valueerror write labels to annot labels sample annot fname fnames0 overwrite true subjects dir subjects dir dcnl dcsp labels 0 color 1 1 1 0 1 0 1 0 dcnl dcsp assert raises valueerror write labels to annot labels sample annot fname fnames0 overwrite true subjects dir subjects dir dcnl dcsp labels labels dcnl dcsp cuneus lh labels6 dcnl dcsp precuneus lh labels50 dcnl dcsp labels append precuneus lh + cuneus lh dcnl dcsp assert raises valueerror write labels to annot labels sample annot fname fnames0 overwrite true subjects dir subjects dir dcnl dcsp labels lh label for label in labels if label name endswith lh dcnl dcsp write labels to annot labels lh1 sample annot fname fnames0 overwrite true subjects dir subjects dir dcnl dcsp labels reloaded read labels from annot sample annot fname fnames0 subjects dir subjects dir dcnl dcsp assert equal len labels lh len labels reloaded dcnl dcsp label0 labels lh0 dcnl dcsp label1 labels reloaded 1 dcnl dcsp assert equal label1 name unknownlh dcnl dcsp assert true np all np in1d label0 vertices label1 vertices dcnl dcsp labels4 labels dcnl dcsp labels40 name none dcnl dcsp assert raises valueerror write labels to annot labels4 annot fname fnames0
requires sklearn dcnl testing requires testing data dcnl def test split label dcsp aparc read labels from annot fsaverage aparc lh regexp lingual subjects dir subjects dir dcnl dcsp lingual aparc0 dcnl dcsp assert raises valueerror lingual split bad input string dcnl dcsp parts lingual post lingual ant dcnl dcsp post ant split label lingual parts subjects dir subjects dir dcnl dcsp assert equal post name parts0 dcnl dcsp assert equal ant name parts1 dcnl dcsp lingual reconst post + ant dcnl dcsp lingual reconst name lingual name dcnl dcsp lingual reconst comment lingual comment dcnl dcsp lingual reconst color lingual color dcnl dcsp assert labels equal lingual reconst lingual dcnl dcsp post1 ant1 lingual split parts subjects dir subjects dir dcnl dcsp assert labels equal post1 post dcnl dcsp assert labels equal ant1 ant dcnl dcsp antmost split label lingual 40 none subjects dir true 1 dcnl dcsp fs vert 210 4401 7405 12079 16276 18956 26356 32713 32716 32719 36047 36050 42797 42798 42799 59281 59282 59283 71864 71865 71866 71874 71883 79901 79903 79910 103024 107849 107850 122928 139356 139357 139373 139374 139375 139376 139377 139378 139381 149117 149118 149120 149127 dcnl dcsp assert array equal antmost vertices fs vert dcnl dcsp assert equal antmost name lingual div40lh dcnl dcsp label default mode read label op join subjects dir fsaverage label lh 7networks 7 label dcnl dcsp dmn sublabels label default mode split parts contiguous subject fsaverage subjects dir subjects dir dcnl dcsp assert equal len label vertices for label in dmn sublabels 16181 7022 5965 5300 823 + 1 23
slow test dcnl testing requires testing data dcnl requires sklearn dcnl def test stc to label dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp src read source spaces fwd fname dcnl dcsp src bad read source spaces src bad fname dcnl dcsp stc read source estimate stc fname sample dcnl dcsp os environ subjects dir op join data path subjects dcnl dcsp labels1 stc to label stc src sample smooth 3 dcnl dcsp labels2 stc to label stc src src smooth 3 dcnl dcsp assert equal len labels1 len labels2 dcnl dcsp for l1 l2 in zip labels1 labels2 dcnl dcsp dcsp assert labels equal l1 l2 decimal 4 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp labels lh labels rh stc to label stc src src smooth true connected true dcnl dcsp assert true len w 0 dcnl dcsp assert raises valueerror stc to label stc sample smooth true connected true dcnl dcsp assert raises runtimeerror stc to label stc smooth true src src bad connected true dcnl dcsp assert equal len labels lh 1 dcnl dcsp assert equal len labels rh 1 dcnl dcsp tris labels lh0 get tris src0 use tris vertices stc vertices0 dcnl dcsp assert raises valueerror spatial tris connectivity tris remap vertices false dcnl dcsp connectivity spatial tris connectivity tris remap vertices true dcnl dcsp assert true connectivity shape0 len stc vertices0 dcnl dcsp assert raises typeerror stc to label stc src 1 smooth false connected false subjects dir subjects dir dcnl dcsp assert raises valueerror stc to label stc src sourcespaces src0 smooth false connected false subjects dir subjects dir dcnl dcsp assert raises valueerror stc to label stc src sample smooth false connected true subjects dir subjects dir dcnl dcsp assert raises valueerror stc to label stc src sample smooth true connected false subjects dir subjects dir dcnl dcsp labels lh labels rh stc to label stc src sample smooth false connected false subjects dir subjects dir dcnl dcsp assert true len labels lh 1 dcnl dcsp assert true len labels rh 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp labels patch stc to label stc src src smooth true dcnl dcsp assert equal len w 1 dcnl dcsp assert equal len labels patch len labels1 dcnl dcsp for l1 l2 in zip labels1 labels2 dcnl dcsp dcsp assert labels equal l1 l2 decimal 4
slow test dcnl testing requires testing data dcnl def test morph dcsp label orig read label real label fname dcnl dcsp label orig subject sample dcnl dcsp vals list dcnl dcsp for grade in 5 np arange 10242 np arange 10242 np arange 10242 dcnl dcsp dcsp label label orig copy dcnl dcsp dcsp assert raises valueerror label morph sample fsaverage dcnl dcsp dcsp label values fill 1 dcnl dcsp dcsp label label morph none fsaverage 5 grade subjects dir 1 dcnl dcsp dcsp label label morph fsaverage sample 5 none subjects dir 2 dcnl dcsp dcsp assert true np in1d label orig vertices label vertices all dcnl dcsp dcsp assert true len label vertices < 3 len label orig vertices dcnl dcsp dcsp vals append label vertices dcnl dcsp assert array equal vals0 vals1 dcnl dcsp assert equal label subject sample dcnl dcsp verts np arange 10242 np arange 10242 dcnl dcsp for hemi in lh rh dcnl dcsp dcsp label hemi hemi dcnl dcsp dcsp label morph none fsaverage 5 verts subjects dir 2 dcnl dcsp assert raises typeerror label morph none 1 5 verts subjects dir 2 dcnl dcsp assert raises typeerror label morph none fsaverage 5 5 verts subjects dir 2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp label smooth subjects dir subjects dir
testing requires testing data dcnl def test grow labels dcsp seeds 0 50000 dcnl dcsp should be in 49 227 51207 48794 dcnl dcsp hemis 0 1 dcnl dcsp names aneurism tumor dcnl dcsp labels grow labels sample seeds 3 hemis subjects dir names names dcnl dcsp tgt names aneurismlh tumorrh dcnl dcsp tgt hemis lh rh dcnl dcsp for label seed hemi sh name in zip labels seeds tgt hemis should be in tgt names dcnl dcsp dcsp assert true np any label vertices seed dcnl dcsp dcsp assert true np all np in1d sh label vertices dcnl dcsp dcsp assert equal label hemi hemi dcnl dcsp dcsp assert equal label name name dcnl dcsp seeds 57532 58887 6304 dcnl dcsp l01 l02 grow labels fsaverage seeds 20 0 0 subjects dir dcnl dcsp seeds 57532 58887 6304 dcnl dcsp l11 l12 grow labels fsaverage seeds 20 0 0 subjects dir overlap false dcnl dcsp assert equal l01 name label 0lh dcnl dcsp assert equal l02 name label 1lh dcnl dcsp assert equal l11 name label 0lh dcnl dcsp assert equal l12 name label 1lh dcnl dcsp overlap np intersect1d l11 vertices l12 vertices true dcnl dcsp assert array equal overlap dcnl dcsp l0 l01 + l02 dcnl dcsp l1 l11 + l12 dcnl dcsp assert array equal l1 vertices l0 vertices
testing requires testing data dcnl def test label sign flip dcsp src read source spaces src fname dcnl dcsp label label vertices src0 vertno 5 hemi lh dcnl dcsp src0 nn label vertices np array 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 np sqrt 2 1 0 np sqrt 2 0 0 1 0 np sqrt 2 1 0 np sqrt 2 0 0 dcnl dcsp known flips np array 1 1 np nan 1 1 dcnl dcsp idx 0 1 3 4 dcnl dcsp flip label sign flip label src dcnl dcsp assert array almost equal np abs np dot flipidx known flipsidx len idx
testing requires testing data dcnl def test label center of mass dcsp stc read source estimate stc fname dcnl dcsp stc lh data 0 dcnl dcsp vertex stc stc center of mass sample subjects dir subjects dir 0 dcnl dcsp assert equal vertex stc 124791 dcnl dcsp label label stc vertices1 pos none values stc rh data mean axis 1 hemi rh subject sample dcnl dcsp vertex label label center of mass subjects dir subjects dir dcnl dcsp assert equal vertex label vertex stc dcnl dcsp labels read labels from annot sample parc aparc a2009s subjects dir subjects dir dcnl dcsp src read source spaces src fname dcnl dcsp for label expected in zip labels2 labels3 labels 5 141162 145221 55979 dcnl dcsp dcsp label values 1 dcnl dcsp dcsp assert raises valueerror label center of mass subjects dir subjects dir dcnl dcsp dcsp label values 0 dcnl dcsp dcsp assert raises valueerror label center of mass subjects dir subjects dir dcnl dcsp dcsp label values 1 dcnl dcsp dcsp assert equal label center of mass subjects dir subjects dir expected dcnl dcsp dcsp assert equal label center of mass subjects dir subjects dir restrict vertices label vertices expected dcnl dcsp dcsp idx 0 if label hemi lh else 1 dcnl dcsp dcsp pos label posnp where label vertices expected 00 dcnl dcsp dcsp pos srcidx rr srcidx vertno pos dcnl dcsp dcsp pos np argmin np sum pos pos axis 1 dcnl dcsp dcsp src expected srcidx vertno pos dcnl dcsp dcsp src restrict np intersect1d label vertices srcidx vertno dcnl dcsp dcsp assert equal label center of mass subjects dir subjects dir restrict vertices src restrict src expected dcnl dcsp dcsp assert equal label center of mass subjects dir subjects dir restrict vertices src src expected dcnl dcsp assert raises valueerror label center of mass subjects dir subjects dir restrict vertices foo dcnl dcsp assert raises typeerror label center of mass subjects dir subjects dir surf 1 dcnl dcsp assert raises ioerror label center of mass subjects dir subjects dir surf foo
def test buggy mkl dcsp from nose plugins skip import skiptest dcnl dcsp buggy mkl svd dcnl dcsp def foo a b dcnl dcsp dcsp raise np linalg linalgerror svd dcsp did dcsp not dcsp converge dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp assert raises skiptest foo 1 2 dcnl dcsp assert true all convergence dcsp error in str ww message for ww in w dcnl dcsp buggy mkl svd dcnl dcsp def bar c d e dcnl dcsp dcsp raise runtimeerror svd dcsp did dcsp not dcsp converge dcnl dcsp assert raises runtimeerror bar 1 2 3
def test sys info dcsp out stringio dcnl dcsp sys info fid out dcnl dcsp out out getvalue dcnl dcsp assert true numpy in out
def test get call line dcsp verbose dcnl dcsp def foo verbose none dcnl dcsp dcsp return get call line in verbose true dcnl dcsp for v in none true dcnl dcsp dcsp my line foo verbose v dcnl dcsp dcsp assert equal my line my line dcsp dcsp foo verbose v dcsp dcsp dcsp testing dcnl dcsp def bar dcnl dcsp dcsp return get call line in verbose false dcnl dcsp my line bar dcnl dcsp assert equal my line my line dcsp dcsp bar dcsp dcsp dcsp testing dcsp more
def test object size dcsp assert true object size np ones 10 np float32 < object size np ones 10 np float64 dcnl dcsp for lower upper obj in 0 60 0 30 1 0 30 1 0 0 70 foo 0 150 np ones 0 0 150 np int32 1 150 500 np ones 20 100 400 dict 400 1000 dict a np ones 50 200 900 sparse eye 20 format csc 200 900 sparse eye 20 format csr dcnl dcsp dcsp size object size obj dcnl dcsp dcsp assert true lower < size < upper msg s dcsp < dcsp s dcsp < dcsp s n s lower size upper obj
def test get inst data dcsp raw read raw fif fname raw dcnl dcsp raw crop tmax 1 0 dcnl dcsp assert equal get inst data raw raw data dcnl dcsp raw pick channels raw ch names 2 dcnl dcsp epochs segment raw raw 0 5 dcnl dcsp assert equal get inst data epochs epochs data dcnl dcsp evoked epochs average dcnl dcsp assert equal get inst data evoked evoked data dcnl dcsp evoked crop tmax 0 1 dcnl dcsp picks list range 2 dcnl dcsp freqs np array 50 0 55 0 dcnl dcsp n cycles 3 dcnl dcsp tfr tfr morlet evoked freqs n cycles return itc false picks picks dcnl dcsp assert equal get inst data tfr tfr data dcnl dcsp assert raises typeerror get inst data foo
def test misc dcsp assert equal memory usage 1 0 1 dcnl dcsp assert equal memory usage clean lines 0 1 dcnl dcsp assert equal memory usage clean lines 0 1 dcnl dcsp assert raises valueerror check random state foo dcnl dcsp assert raises valueerror set memmap min size 1 dcnl dcsp assert raises valueerror set memmap min size foo dcnl dcsp assert raises typeerror get config 1 dcnl dcsp assert raises typeerror set config 1 dcnl dcsp assert raises typeerror set config foo 1 dcnl dcsp assert raises typeerror get stim channel 1 none dcnl dcsp assert raises typeerror get stim channel 1 none dcnl dcsp assert raises typeerror check fname 1 dcnl dcsp assert raises ioerror check fname foo tetsdip x fif dcnl dcsp assert raises valueerror check subject none none dcnl dcsp assert raises valueerror check subject none 1 dcnl dcsp assert raises valueerror check subject 1 none
requires mayavi dcnl def test check mayavi dcsp assert raises runtimeerror check mayavi version 100 0 0
def test run tests if main dcsp x dcnl dcsp def test a dcnl dcsp dcsp x append true dcnl dcsp np testing dec skipif true dcnl dcsp def test b dcnl dcsp dcsp return dcnl dcsp try dcnl dcsp dcsp name main dcnl dcsp dcsp run tests if main measure mem false dcnl dcsp dcsp def test c dcnl dcsp dcsp dcsp raise runtimeerror dcnl dcsp dcsp try dcnl dcsp dcsp dcsp name main dcnl dcsp dcsp dcsp run tests if main measure mem false dcnl dcsp dcsp except runtimeerror dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise runtimeerror error dcsp not dcsp raised dcnl dcsp finally dcnl dcsp dcsp del name dcnl dcsp assert true len x 2 dcnl dcsp assert true x0 and x1
def test hash dcsp d0 dict a dict a 0 1 b fo c 1 b 1 b c d np ones 3 e none dcnl dcsp d01 none dcnl dcsp d02 0 123 dcnl dcsp d1 deepcopy d0 dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp assert equal object hash d0 object hash d1 dcnl dcsp d1 data np ones 3 int dcnl dcsp d1 d 0 0 dcnl dcsp assert not equal object hash d0 object hash d1 dcnl dcsp d1 deepcopy d0 dcnl dcsp assert equal object hash d0 object hash d1 dcnl dcsp d1 a a 0 11 dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp assert not equal object hash d0 object hash d1 dcnl dcsp d1 deepcopy d0 dcnl dcsp assert equal object hash d0 object hash d1 dcnl dcsp d1 a d 0 dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp assert not equal object hash d0 object hash d1 dcnl dcsp d1 deepcopy d0 dcnl dcsp assert equal object hash d0 object hash d1 dcnl dcsp d1 b append 0 dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp assert not equal object hash d0 object hash d1 dcnl dcsp d1 deepcopy d0 dcnl dcsp assert equal object hash d0 object hash d1 dcnl dcsp d1 e foo dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp assert not equal object hash d0 object hash d1 dcnl dcsp d1 deepcopy d0 dcnl dcsp d2 deepcopy d0 dcnl dcsp d1 e stringio dcnl dcsp d2 e stringio dcnl dcsp d2 e write foo dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp d1 deepcopy d0 dcnl dcsp d11 2 dcnl dcsp assert true len object diff d0 d1 0 dcnl dcsp assert true len object diff d1 d0 0 dcnl dcsp assert not equal object hash d0 object hash d1 dcnl dcsp d1 deepcopy d0 dcnl dcsp d2 deepcopy d0 dcnl dcsp d11 x for x in d0 dcnl dcsp d21 x for x in d0 dcnl dcsp assert raises runtimeerror object diff d1 d2 dcnl dcsp assert raises runtimeerror object hash d1 dcnl dcsp x sparse eye 2 2 format csc dcnl dcsp y sparse eye 2 2 format csr dcnl dcsp assert true type dcsp mismatch in object diff x y dcnl dcsp y sparse eye 2 2 format csc dcnl dcsp assert equal len object diff x y 0 dcnl dcsp y 1 1 2 dcnl dcsp assert true elements in object diff x y dcnl dcsp y sparse eye 3 3 format csc dcnl dcsp assert true shape in object diff x y dcnl dcsp y 0 dcnl dcsp assert true type dcsp mismatch in object diff x y
def test md5sum dcsp tempdir tempdir dcnl dcsp fname1 op join tempdir foo dcnl dcsp fname2 op join tempdir bar dcnl dcsp with open fname1 wb as fid dcnl dcsp dcsp fid write abcd dcnl dcsp with open fname2 wb as fid dcnl dcsp dcsp fid write efgh dcnl dcsp assert equal md5sum fname1 md5sum fname1 1 dcnl dcsp assert equal md5sum fname2 md5sum fname2 1024 dcnl dcsp assert true md5sum fname1 md5sum fname2
def test tempdir dcsp tempdir2 tempdir dcnl dcsp assert true op isdir tempdir2 dcnl dcsp x str tempdir2 dcnl dcsp del tempdir2 dcnl dcsp assert true not op isdir x
def test estimate rank dcsp data np eye 10 dcnl dcsp assert array equal estimate rank data return singular true 1 np ones 10 dcnl dcsp data 0 0 0 dcnl dcsp assert equal estimate rank data 9 dcnl dcsp assert raises valueerror estimate rank data foo
def test logging dcsp assert raises valueerror set log level foo dcnl dcsp tempdir tempdir dcnl dcsp test name op join tempdir test log dcnl dcsp with open fname log r as old log file dcnl dcsp dcsp old lines clean lines old log file readlines dcnl dcsp dcsp old lines pop 1 dcnl dcsp with open fname log 2 r as old log file 2 dcnl dcsp dcsp old lines 2 clean lines old log file 2 readlines dcnl dcsp dcsp old lines 2 pop 14 dcnl dcsp dcsp old lines 2 pop 1 dcnl dcsp if op isfile test name dcnl dcsp dcsp os remove test name dcnl dcsp set log file test name dcnl dcsp set log level warning dcnl dcsp evoked read evokeds fname evoked condition 1 dcnl dcsp with open test name as fid dcnl dcsp dcsp assert true fid readlines dcnl dcsp evoked read evokeds fname evoked condition 1 verbose false dcnl dcsp with open test name as fid dcnl dcsp dcsp assert true fid readlines dcnl dcsp evoked read evokeds fname evoked condition 1 verbose warning dcnl dcsp with open test name as fid dcnl dcsp dcsp assert true fid readlines dcnl dcsp evoked read evokeds fname evoked condition 1 verbose true dcnl dcsp with open test name r as new log file dcnl dcsp dcsp new lines clean lines new log file readlines dcnl dcsp assert equal new lines old lines dcnl dcsp set log file none dcnl dcsp os remove test name dcnl dcsp set log file test name dcnl dcsp set log level info dcnl dcsp evoked read evokeds fname evoked condition 1 verbose warning dcnl dcsp with open test name as fid dcnl dcsp dcsp assert true fid readlines dcnl dcsp evoked read evokeds fname evoked condition 1 verbose false dcnl dcsp with open test name as fid dcnl dcsp dcsp assert true fid readlines dcnl dcsp evoked read evokeds fname evoked condition 1 dcnl dcsp with open test name r as new log file dcnl dcsp dcsp new lines clean lines new log file readlines dcnl dcsp assert equal new lines old lines dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp set log file test name overwrite false dcnl dcsp dcsp assert equal len w 0 dcnl dcsp dcsp set log file test name dcnl dcsp assert equal len w 1 dcnl dcsp assert true test utils py in w0 filename dcnl dcsp evoked read evokeds fname evoked condition 1 dcnl dcsp with open test name r as new log file dcnl dcsp dcsp new lines clean lines new log file readlines dcnl dcsp assert equal new lines old lines 2 dcnl dcsp set log file test name overwrite true dcnl dcsp evoked read evokeds fname evoked condition 1 dcnl dcsp del evoked dcnl dcsp with open test name r as new log file dcnl dcsp dcsp new lines clean lines new log file readlines dcnl dcsp assert equal new lines old lines
def test config dcsp tempdir tempdir dcnl dcsp key mne python config testing dcnl dcsp value 123456 dcnl dcsp value2 123 dcnl dcsp old val os getenv key none dcnl dcsp os environkey value dcnl dcsp assert true get config key value dcnl dcsp del os environkey dcnl dcsp assert true len set config none none 10 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp set config key none home dir tempdir set env false dcnl dcsp assert true len w 1 dcnl dcsp assert true get config key home dir tempdir is none dcnl dcsp assert raises keyerror get config key raise error true dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp assert true key not in os environ dcnl dcsp dcsp set config key value home dir tempdir set env true dcnl dcsp dcsp assert true key in os environ dcnl dcsp dcsp assert true get config key home dir tempdir value dcnl dcsp dcsp set config key none home dir tempdir set env true dcnl dcsp dcsp assert true key not in os environ dcnl dcsp dcsp set config key none home dir tempdir set env true dcnl dcsp dcsp assert true key not in os environ dcnl dcsp if old val is not none dcnl dcsp dcsp os environkey old val dcnl dcsp key mne python testing key dcnl dcsp assert not in key get config home dir tempdir dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp set config key value home dir tempdir dcnl dcsp assert equal get config home dir tempdir key value dcnl dcsp old val os environ get key dcnl dcsp try dcnl dcsp dcsp os environkey value2 dcnl dcsp dcsp assert equal get config home dir tempdir key value2 dcnl dcsp finally dcnl dcsp dcsp if old val is none dcnl dcsp dcsp dcsp os environ pop key none dcnl dcsp dcsp else dcnl dcsp dcsp dcsp os environkey old val dcnl dcsp json fname get config path home dir tempdir dcnl dcsp with open json fname w as fid dcnl dcsp dcsp fid write foo dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp assert not in key get config home dir tempdir dcnl dcsp assert true any not dcsp a dcsp valid dcsp json in str ww message for ww in w dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises runtimeerror set config key true home dir tempdir
testing requires testing data dcnl def test show fiff dcsp info show fiff fname evoked dcnl dcsp keys fiff epoch fiffb hpi coil fiffb proj item fiffb processed data fiffb evoked fiff nave fiff epoch dcnl dcsp assert true all key in info for key in keys dcnl dcsp info show fiff fname raw read limit 1024 dcnl dcsp assert true coord trans in show fiff fname fsaverage trans
def test deprecated dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp deprecated func dcnl dcsp assert true len w 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp deprecated class dcnl dcsp assert true len w 1
def test fetch url dcsp tempdir tempdir dcnl dcsp with argvsetter disable stderr false dcnl dcsp dcsp archive name op join tempdir download test dcnl dcsp dcsp fetch file url archive name timeout 30 0 verbose false resume false dcnl dcsp dcsp assert raises exception fetch file not an address op join tempdir test verbose false dcnl dcsp dcsp resume name op join tempdir download resume dcnl dcsp dcsp with open resume name + part w dcnl dcsp dcsp dcsp os utime resume name + part none dcnl dcsp dcsp fetch file url resume name resume true timeout 30 0 verbose false dcnl dcsp dcsp assert raises valueerror fetch file url archive name hash a verbose false dcnl dcsp dcsp assert raises runtimeerror fetch file url archive name hash a 32 verbose false
requires good network dcnl def test fetch file html dcsp test fetch http google com
requires ftp dcnl requires good network dcnl def test fetch file ftp dcsp test fetch ftp speedtest tele2 net 1kb zip
def test sum squared dcsp x np random randomstate 0 randint 0 50 3 3 dcnl dcsp assert equal np sum x 2 sum squared x
def test sizeof fmt dcsp assert equal sizeof fmt 0 0 dcsp bytes dcnl dcsp assert equal sizeof fmt 1 1 dcsp byte dcnl dcsp assert equal sizeof fmt 1000 1000 dcsp bytes
def test url to local path dcsp assert equal url to local path http google com home why html op join home why html
def test check type picks dcsp picks np arange 12 dcnl dcsp assert array equal picks check type picks picks dcnl dcsp picks list range 12 dcnl dcsp assert array equal np array picks check type picks picks dcnl dcsp picks none dcnl dcsp assert array equal none check type picks picks dcnl dcsp picks a b dcnl dcsp assert raises valueerror check type picks picks dcnl dcsp picks b dcnl dcsp assert raises valueerror check type picks picks
def test compute corr dcsp x np array 10 8 13 9 11 14 6 4 12 7 5 dcnl dcsp y np array 8 04 6 95 7 58 8 81 8 33 9 96 7 24 4 26 10 84 4 82 5 68 9 14 8 14 8 74 8 77 9 26 8 1 6 13 3 1 9 13 7 26 4 74 7 46 6 77 12 74 7 11 7 81 8 84 6 08 5 39 8 15 6 42 5 73 8 8 8 8 8 8 8 19 8 8 8 6 58 5 76 7 71 8 84 8 47 7 04 5 25 12 5 5 56 7 91 6 89 dcnl dcsp r compute corr x y t dcnl dcsp r2 np array np corrcoef x yi 0 1 for i in range len y dcnl dcsp assert allclose r r2 dcnl dcsp assert raises valueerror compute corr 1 2
def test create slices dcsp assert true create slices 0 0 dcnl dcsp assert true len create slices 0 100 100 dcnl dcsp assert true len create slices 50 100 50 dcnl dcsp assert true len create slices 0 100 length 2 50 dcnl dcsp assert true len create slices 0 100 step 10 10 dcnl dcsp assert true len create slices 0 500 length 50 step 10 46 dcnl dcsp slices create slices 0 10 dcnl dcsp assert true slices0 start 0 dcnl dcsp assert true slices0 step 1 dcnl dcsp assert true slices0 stop 1 dcnl dcsp assert true slices 1 stop 10 dcnl dcsp slices create slices 0 9 length 3 dcnl dcsp assert true slices0 start 0 dcnl dcsp assert true slices0 step 1 dcnl dcsp assert true slices0 stop 3 dcnl dcsp assert true slices 1 stop 9 dcnl dcsp slices create slices 0 9 length 3 step 1 dcnl dcsp assert true len slices 7 dcnl dcsp assert true slices0 step 1 dcnl dcsp assert true slices0 stop 3 dcnl dcsp assert true slices 1 start 6 dcnl dcsp assert true slices 1 stop 9
def test time mask dcsp n 10 dcnl dcsp x np arange n astype float dcnl dcsp assert equal time mask x 0 n 1 sum n dcnl dcsp assert equal time mask x 1e10 0 n 1 sfreq 1000 0 sum n dcnl dcsp assert equal time mask x 1e10 none n 1 sfreq 1000 0 sum n dcnl dcsp assert equal time mask x 1e10 none none sfreq 1000 0 sum n dcnl dcsp assert equal time mask x 1e10 np inf none sfreq 1000 0 sum n dcnl dcsp assert equal time mask x 1e10 none np inf sfreq 1000 0 sum n dcnl dcsp x np array 4 10 dcnl dcsp assert equal time mask x 1 tmin 10 sfreq 1 raise error false sum 0 dcnl dcsp assert equal time mask x 1 tmin 11 tmax 12 sfreq 1 raise error false sum 0 dcnl dcsp assert equal time mask x tmin 10 sfreq 1 sum 1 dcnl dcsp assert equal time mask x tmin 6 sfreq 1 sum 1 dcnl dcsp assert equal time mask x tmin 5 sfreq 1 sum 1 dcnl dcsp assert equal time mask x tmin 4 5001 sfreq 1 sum 1 dcnl dcsp assert equal time mask x tmin 4 4999 sfreq 1 sum 2 dcnl dcsp assert equal time mask x tmin 4 sfreq 1 sum 2 dcnl dcsp assert raises valueerror time mask x 1 tmin 11 tmax 12 dcnl dcsp assert raises valueerror time mask x 1 tmin 10 sfreq 1
def test random permutation dcsp n samples 10 dcnl dcsp random state 42 dcnl dcsp python randperm random permutation n samples random state dcnl dcsp matlab randperm np array 7 6 5 1 4 9 10 3 8 2 dcnl dcsp assert array equal python randperm matlab randperm 1
def test copy doc dcsp class a dcnl dcsp dcsp def m1 dcnl dcsp dcsp dcsp docstring dcsp for dcsp m1 dcnl dcsp dcsp dcsp pass dcnl dcsp class b dcnl dcsp dcsp def m1 dcnl dcsp dcsp dcsp pass dcnl dcsp class c a dcnl dcsp dcsp copy doc a m1 dcnl dcsp dcsp def m1 dcnl dcsp dcsp dcsp pass dcnl dcsp assert equal c m1 doc docstring dcsp for dcsp m1 dcnl dcsp assert raises valueerror copy doc b m1 c m1
def test copy function doc to method doc dcsp def f1 object a b c dcnl dcsp dcsp docstring dcsp for dcsp f1 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameters n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp object dcsp dcsp object n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp some dcsp object dcsp this dcsp description dcsp also dcsp has n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp blank dcsp lines dcsp in dcsp it n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp a dcsp dcsp int n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameter dcsp a n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp b dcsp dcsp int n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameter dcsp b n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp pass dcnl dcsp def f2 object dcnl dcsp dcsp docstring dcsp for dcsp f2 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameters n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp object dcsp dcsp object n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp only dcsp one dcsp parameter n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp returns n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp nothing n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp pass dcnl dcsp def f3 object dcnl dcsp dcsp docstring dcsp for dcsp f3 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameters n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp object dcsp dcsp object n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp only dcsp one dcsp parameter n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp pass dcnl dcsp def f4 object dcnl dcsp dcsp docstring dcsp for dcsp f4 dcnl dcsp dcsp pass dcnl dcsp def f5 object dcnl dcsp dcsp docstring dcsp for dcsp f5 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameters n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp returns n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp nothing n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp pass dcnl dcsp class a dcnl dcsp dcsp copy function doc to method doc f1 dcnl dcsp dcsp def method f1 self a b c dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp copy function doc to method doc f2 dcnl dcsp dcsp def method f2 self dcnl dcsp dcsp dcsp method f3 dcsp own dcsp docstring dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp copy function doc to method doc f3 dcnl dcsp dcsp def method f3 self dcnl dcsp dcsp dcsp pass dcnl dcsp assert equal a method f1 doc docstring dcsp for dcsp f1 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameters n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp a dcsp dcsp int n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameter dcsp a n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp b dcsp dcsp int n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameter dcsp b n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp assert equal a method f2 doc docstring dcsp for dcsp f2 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp returns n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp nothing n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp method f3 dcsp own dcsp docstring dcnl dcsp assert equal a method f3 doc docstring dcsp for dcsp f3 n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp assert raises valueerror copy function doc to method doc f4 a method f1 dcnl dcsp assert raises valueerror copy function doc to method doc f5 a method f1
def test open docs dcsp old tab webbrowser open new tab dcnl dcsp try dcnl dcsp dcsp webbrowser open new tab lambda x assert true martinos in x dcnl dcsp dcsp open docs dcnl dcsp dcsp open docs tutorials dev dcnl dcsp dcsp open docs examples stable dcnl dcsp dcsp assert raises valueerror open docs foo dcnl dcsp dcsp assert raises valueerror open docs api foo dcnl dcsp finally dcnl dcsp dcsp webbrowser open new tab old tab
def test read selection dcsp ch names meg dcsp 2211 meg dcsp 0223 meg dcsp 1312 meg dcsp 0412 meg dcsp 1043 meg dcsp 2042 meg dcsp 2032 meg dcsp 0522 meg dcsp 1031 dcnl dcsp sel names vertex lefttemporal righttemporal leftparietal rightparietal leftoccipital rightoccipital leftfrontal rightfrontal dcnl dcsp raw read raw fif raw fname dcnl dcsp for i name in enumerate sel names dcnl dcsp dcsp sel read selection name dcnl dcsp dcsp assert true ch namesi in sel dcnl dcsp dcsp sel info read selection name info raw info dcnl dcsp dcsp assert equal sel sel info dcnl dcsp all ch read selection l r dcnl dcsp left read selection l dcnl dcsp right read selection r dcnl dcsp assert true len all ch len left + len right dcnl dcsp assert true len set left intersection set right 0 dcnl dcsp frontal read selection frontal dcnl dcsp occipital read selection rightoccipital dcnl dcsp assert true len set frontal intersection set occipital 0 dcnl dcsp ch names new ch replace dcsp for ch in ch names dcnl dcsp raw new read raw fif raw new fname dcnl dcsp for i name in enumerate sel names dcnl dcsp dcsp sel read selection name info raw new info dcnl dcsp dcsp assert true ch names newi in sel dcnl dcsp assert raises typeerror read selection name info foo
testing requires testing data dcnl requires nibabel vox2ras tkr true dcnl def test mgz header dcsp header get mgz header fname mri dcnl dcsp mri hdr get mri header fname mri dcnl dcsp assert allclose mri hdr get data shape header dims dcnl dcsp assert allclose mri hdr get vox2ras tkr header vox2ras tkr dcnl dcsp assert allclose mri hdr get ras2vox header ras2vox
requires version scipy 0 11 dcnl def test add patch info dcsp src read source spaces fname small dcnl dcsp src new read source spaces fname small dcnl dcsp for s in src new dcnl dcsp dcsp s nearest none dcnl dcsp dcsp s nearest dist none dcnl dcsp dcsp s pinfo none dcnl dcsp try dcnl dcsp dcsp add source space distances src new dist limit 1e05 dcnl dcsp except runtimeerror dcnl dcsp dcsp pass dcnl dcsp else dcnl dcsp dcsp assert true all s nearest is none for s in src new dcnl dcsp dcsp assert true all s nearest dist is none for s in src new dcnl dcsp dcsp assert true all s pinfo is none for s in src new dcnl dcsp add source space distances src new dcnl dcsp for s1 s2 in zip src src new dcnl dcsp dcsp assert array equal s1 nearest s2 nearest dcnl dcsp dcsp assert allclose s1 nearest dist s2 nearest dist atol 1e07 dcnl dcsp dcsp assert equal len s1 pinfo len s2 pinfo dcnl dcsp dcsp for p1 p2 in zip s1 pinfo s2 pinfo dcnl dcsp dcsp dcsp assert array equal p1 p2
testing requires testing data dcnl requires version scipy 0 11 dcnl def test add source space distances limited dcsp tempdir tempdir dcnl dcsp src read source spaces fname dcnl dcsp src new read source spaces fname dcnl dcsp del src new0 dist dcnl dcsp del src new1 dist dcnl dcsp n do 200 dcnl dcsp src new0 vertno src new0 vertno n do copy dcnl dcsp src new1 vertno src new1 vertno n do copy dcnl dcsp out name op join tempdir tempsrc fif dcnl dcsp try dcnl dcsp dcsp add source space distances src new dist limit 0 007 dcnl dcsp except runtimeerror dcnl dcsp dcsp raise skiptest dist limit dcsp requires dcsp scipy dcsp dcsp 0 13 dcnl dcsp write source spaces out name src new dcnl dcsp src new read source spaces out name dcnl dcsp for so sn in zip src src new dcnl dcsp dcsp assert array equal so dist limit np array 0 007 np float32 dcnl dcsp dcsp assert array equal sn dist limit np array 0 007 np float32 dcnl dcsp dcsp do so dist dcnl dcsp dcsp dn sn dist dcnl dcsp dcsp do data do data 0 007 0 dcnl dcsp dcsp do eliminate zeros dcnl dcsp dcsp assert true np sum do data < 0 007 400 dcnl dcsp dcsp d do dn sn vertno n do 1 sn vertno n do 1 dcnl dcsp dcsp assert allclose np zeros like d data d data rtol 0 atol 1e06
slow test dcnl testing requires testing data dcnl requires version scipy 0 11 dcnl def test add source space distances dcsp tempdir tempdir dcnl dcsp src read source spaces fname dcnl dcsp src new read source spaces fname dcnl dcsp del src new0 dist dcnl dcsp del src new1 dist dcnl dcsp n do 19 dcnl dcsp src new0 vertno src new0 vertno n do copy dcnl dcsp src new1 vertno src new1 vertno n do copy dcnl dcsp out name op join tempdir tempsrc fif dcnl dcsp n jobs 2 dcnl dcsp assert true n do n jobs 0 dcnl dcsp add source space distances src new n jobs n jobs dcnl dcsp write source spaces out name src new dcnl dcsp src new read source spaces out name dcnl dcsp for so sn in zip src src new dcnl dcsp dcsp v so vertno n do dcnl dcsp dcsp assert array equal so dist limit np array 0 007 np float32 dcnl dcsp dcsp assert array equal sn dist limit np array np inf np float32 dcnl dcsp dcsp do so dist dcnl dcsp dcsp dn sn dist dcnl dcsp dcsp ds list dcnl dcsp dcsp for d in do dn dcnl dcsp dcsp dcsp d data d data 0 007 0 dcnl dcsp dcsp dcsp d dv v dcnl dcsp dcsp dcsp d eliminate zeros dcnl dcsp dcsp dcsp ds append d dcnl dcsp dcsp assert true np sum ds0 data < 0 007 10 dcnl dcsp dcsp d ds0 ds1 dcnl dcsp dcsp assert allclose np zeros like d data d data rtol 0 atol 1e09
testing requires testing data dcnl requires mne dcnl def test discrete source space dcsp tempdir tempdir dcnl dcsp src read source spaces fname dcnl dcsp v src0 vertno dcnl dcsp temp name op join tempdir tempsrc fif dcnl dcsp try dcnl dcsp dcsp temp pos op join tempdir temppos txt dcnl dcsp dcsp np savetxt temp pos np c src0 rr v src0 nn v dcnl dcsp dcsp run subprocess mne volume source space meters pos temp pos src temp name dcnl dcsp dcsp src c read source spaces temp name dcnl dcsp dcsp pos dict dict rr src0 rr v nn src0 nn v dcnl dcsp dcsp src new setup volume source space none pos pos dict dcnl dcsp dcsp compare source spaces src c src new mode approx dcnl dcsp dcsp assert allclose src0 rr v src new0 rr rtol 0 001 atol 1e06 dcnl dcsp dcsp assert allclose src0 nn v src new0 nn rtol 0 001 atol 1e06 dcnl dcsp dcsp write source spaces temp name src c overwrite true dcnl dcsp dcsp src c2 read source spaces temp name dcnl dcsp dcsp compare source spaces src c src c2 dcnl dcsp dcsp assert raises valueerror setup volume source space sample pos pos dict mri fname mri dcnl dcsp dcsp assert equal repr src new repr src c dcnl dcsp dcsp assert equal src new kind discrete dcnl dcsp finally dcnl dcsp dcsp if op isfile temp name dcnl dcsp dcsp dcsp os remove temp name
slow test dcnl testing requires testing data dcnl def test volume source space dcsp tempdir tempdir dcnl dcsp src read source spaces fname vol dcnl dcsp temp name op join tempdir tempsrc fif dcnl dcsp surf read bem surfaces fname bem s id fiff fiffv bem surf id brain dcnl dcsp surf rr 1000 0 dcnl dcsp for bem surf in zip fname bem none none surf dcnl dcsp dcsp src new setup volume source space sample pos 7 0 bem bem surface surf mri t1 mgz subjects dir subjects dir dcnl dcsp dcsp write source spaces temp name src new overwrite true dcnl dcsp dcsp src0 subject his id sample dcnl dcsp dcsp compare source spaces src src new mode approx dcnl dcsp dcsp del src new dcnl dcsp dcsp src new read source spaces temp name dcnl dcsp dcsp compare source spaces src src new mode approx dcnl dcsp assert raises ioerror setup volume source space sample pos 7 0 bem none surface foo mri fname mri subjects dir subjects dir dcnl dcsp assert equal repr src repr src new dcnl dcsp assert equal src kind volume
testing requires testing data dcnl requires mne dcnl def test other volume source spaces dcsp tempdir tempdir dcnl dcsp temp name op join tempdir tempsrc fif dcnl dcsp run subprocess mne volume source space grid 7 0 src temp name mri fname mri dcnl dcsp src read source spaces temp name dcnl dcsp src new setup volume source space none pos 7 0 mri fname mri subjects dir subjects dir dcnl dcsp assert equal len src new0 vertno 7497 dcnl dcsp assert equal len src 1 dcnl dcsp assert equal len src new 1 dcnl dcsp good mask np in1d src0 vertno src new0 vertno dcnl dcsp src0 inuse src0 vertno ~ good mask 0 dcnl dcsp assert equal src0 inuse sum 7497 dcnl dcsp src0 vertno src0 vertno good mask dcnl dcsp assert equal len src0 vertno 7497 dcnl dcsp src0 nuse len src0 vertno dcnl dcsp assert equal src0 nuse 7497 dcnl dcsp compare source spaces src new src mode approx dcnl dcsp assert true volume dcsp shape in repr src dcnl dcsp del src dcnl dcsp del src new dcnl dcsp assert raises valueerror setup volume source space sample pos 7 0 sphere 1 0 1 0 mri fname mri subjects dir subjects dir dcnl dcsp run subprocess mne volume source space grid 7 0 src temp name dcnl dcsp assert raises valueerror read source spaces temp name
testing requires testing data dcnl def test triangle neighbors dcsp this read source spaces fname 0 dcnl dcsp this neighbor tri list for in range this np dcnl dcsp for p in range this ntri dcnl dcsp dcsp verts this tris p dcnl dcsp dcsp this neighbor tri verts0 append p dcnl dcsp dcsp this neighbor tri verts1 append p dcnl dcsp dcsp this neighbor tri verts2 append p dcnl dcsp this neighbor tri np array nb int for nb in this neighbor tri dcnl dcsp neighbor tri triangle neighbors this tris this np dcnl dcsp assert true np array equal nt1 nt2 for nt1 nt2 in zip neighbor tri this neighbor tri
def test accumulate normals dcsp n pts int 160000 0 dcnl dcsp n tris int 320000 0 dcnl dcsp tris rng rand n tris 1 n pts 2 astype int dcnl dcsp tris np c tris tris + 1 tris + 2 dcnl dcsp tri nn rng rand n tris 3 dcnl dcsp this dict tris tris np n pts ntri n tris tri nn tri nn dcnl dcsp this nn np zeros this np 3 dcnl dcsp for p in range this ntri dcnl dcsp dcsp verts this tris p dcnl dcsp dcsp this nn verts + this tri nn p dcnl dcsp nn accumulate normals this tris this tri nn this np dcnl dcsp assert allclose nn this nn rtol 1e07 atol 1e07
slow test dcnl testing requires testing data dcnl def test setup source space dcsp tempdir tempdir dcnl dcsp fname ico op join data path subjects fsaverage bem fsaverageico5src fif dcnl dcsp assert raises valueerror setup source space sample spacing oct add dist false subjects dir subjects dir dcnl dcsp assert raises valueerror setup source space sample spacing octo add dist false subjects dir subjects dir dcnl dcsp assert raises valueerror setup source space sample spacing oct6e add dist false subjects dir subjects dir dcnl dcsp assert raises valueerror setup source space sample spacing 7emm add dist false subjects dir subjects dir dcnl dcsp assert raises valueerror setup source space sample spacing alls add dist false subjects dir subjects dir dcnl dcsp src read source spaces fname ico dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp src new setup source space fsaverage spacing ico5 subjects dir subjects dir add dist false dcnl dcsp compare source spaces src src new mode approx dcnl dcsp assert equal repr src repr src new dcnl dcsp assert equal repr src count surface dcsp 2 dcnl dcsp assert array equal src0 vertno np arange 10242 dcnl dcsp assert array equal src1 vertno np arange 10242 dcnl dcsp src read source spaces fname dcnl dcsp temp name op join tempdir tempsrc fif dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp src new setup source space sample spacing oct6 subjects dir subjects dir add dist false dcnl dcsp dcsp write source spaces temp name src new overwrite true dcnl dcsp assert equal src new0 nuse 4098 dcnl dcsp compare source spaces src src new mode approx nearest false dcnl dcsp src new read source spaces temp name dcnl dcsp compare source spaces src src new mode approx nearest false dcnl dcsp src new setup source space sample spacing all subjects dir subjects dir add dist false dcnl dcsp assert true src new0 nuse len src new0 rr dcnl dcsp assert true src new1 nuse len src new1 rr dcnl dcsp assert raises runtimeerror setup source space sample spacing ico6 subjects dir subjects dir add dist false
testing requires testing data dcnl def test read source spaces dcsp src read source spaces fname patch stats true dcnl dcsp lh points src0 rr dcnl dcsp lh faces src0 tris dcnl dcsp lh use faces src0 use tris dcnl dcsp rh points src1 rr dcnl dcsp rh faces src1 tris dcnl dcsp rh use faces src1 use tris dcnl dcsp assert true lh faces min 0 dcnl dcsp assert true lh faces max lh points shape0 1 dcnl dcsp assert true lh use faces min 0 dcnl dcsp assert true lh use faces max < lh points shape0 1 dcnl dcsp assert true rh faces min 0 dcnl dcsp assert true rh faces max rh points shape0 1 dcnl dcsp assert true rh use faces min 0 dcnl dcsp assert true rh use faces max < rh points shape0 1
slow test dcnl testing requires testing data dcnl def test write source space dcsp tempdir tempdir dcnl dcsp src0 read source spaces fname patch stats false dcnl dcsp write source spaces op join tempdir tmpsrc fif src0 dcnl dcsp src1 read source spaces op join tempdir tmpsrc fif patch stats false dcnl dcsp compare source spaces src0 src1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp src badname op join tempdir testbadname fif gz dcnl dcsp dcsp write source spaces src badname src0 dcnl dcsp dcsp read source spaces src badname dcnl dcsp assert naming w test source space py 2
testing requires testing data dcnl requires fs or nibabel dcnl def test vertex to mni dcsp vertices 100960 7620 150549 96761 dcnl dcsp coords np array 60 86 11 18 3 19 36 46 93 18 2 36 38 0 50 08 10 61 47 14 8 01 46 93 dcnl dcsp hemis 0 0 0 1 dcnl dcsp coords 2 vertex to mni vertices hemis sample subjects dir dcnl dcsp assert allclose coords coords 2 atol 1 0
testing requires testing data dcnl requires freesurfer dcnl requires nibabel dcnl def test vertex to mni fs nibabel dcsp n check 1000 dcnl dcsp subject sample dcnl dcsp vertices rng randint 0 100000 n check dcnl dcsp hemis rng randint 0 1 n check dcnl dcsp coords vertex to mni vertices hemis subject subjects dir nibabel dcnl dcsp coords 2 vertex to mni vertices hemis subject subjects dir freesurfer dcnl dcsp assert allclose coords coords 2 atol 0 1
testing requires testing data dcnl requires freesurfer dcnl requires nibabel dcnl def test get volume label names dcsp aseg fname op join subjects dir sample mri aseg mgz dcnl dcsp label names label colors get volume labels from aseg aseg fname return colors true dcnl dcsp assert equal label names count brainstem 1 dcnl dcsp assert equal len label colors len label names
testing requires testing data dcnl requires freesurfer dcnl requires nibabel dcnl def test source space from label dcsp tempdir tempdir dcnl dcsp aseg fname op join subjects dir sample mri aseg mgz dcnl dcsp label names get volume labels from aseg aseg fname dcnl dcsp volume label label namesint np random rand len label names dcnl dcsp pos dict dcnl dcsp assert raises valueerror setup volume source space sample pos pos volume label volume label mri aseg fname dcnl dcsp assert raises runtimeerror setup volume source space sample mri none volume label volume label dcnl dcsp assert raises valueerror setup volume source space sample volume label hello dcsp world mri aseg fname dcnl dcsp src setup volume source space sample subjects dir subjects dir volume label volume label mri aseg fname add interpolator false dcnl dcsp assert equal volume label src0 seg name dcnl dcsp out name op join tempdir tempsrc fif dcnl dcsp write source spaces out name src dcnl dcsp src from file read source spaces out name dcnl dcsp compare source spaces src src from file mode approx
testing requires testing data dcnl requires freesurfer dcnl requires nibabel dcnl def test read volume from src dcsp aseg fname op join subjects dir sample mri aseg mgz dcnl dcsp labels vol leftamygdala brainstem rightamygdala dcnl dcsp src read source spaces fname dcnl dcsp vol src setup volume source space sample mri aseg fname pos 5 0 bem fname bem volume label labels vol subjects dir subjects dir dcnl dcsp src + vol src dcnl dcsp volume src get volume labels from src src sample subjects dir dcnl dcsp volume label volume src0 name dcnl dcsp volume label left + volume label replace lh dcnl dcsp assert equal volume label src2 seg name dcnl dcsp assert equal src2 type vol
testing requires testing data dcnl requires freesurfer dcnl requires nibabel dcnl def test combine source spaces dcsp tempdir tempdir dcnl dcsp aseg fname op join subjects dir sample mri aseg mgz dcnl dcsp label names get volume labels from aseg aseg fname dcnl dcsp volume labels label namesint np random rand len label names for ii in range 2 dcnl dcsp srf read source spaces fname patch stats false dcnl dcsp vol setup volume source space sample subjects dir subjects dir volume label volume labels0 mri aseg fname add interpolator false dcnl dcsp rr rng randint 0 20 100 3 0 001 dcnl dcsp nn np zeros rr shape dcnl dcsp nn 1 1 dcnl dcsp pos rr rr nn nn dcnl dcsp disc setup volume source space sample subjects dir subjects dir pos pos verbose error dcnl dcsp src srf + vol + disc dcnl dcsp assert equal type src sourcespaces dcnl dcsp assert equal len src 4 dcnl dcsp src out name op join tempdir tempsrc fif dcnl dcsp src save src out name dcnl dcsp src from file read source spaces src out name dcnl dcsp compare source spaces src src from file mode approx dcnl dcsp assert equal repr src repr src from file dcnl dcsp assert equal src kind combined dcnl dcsp coord frames np array s coord frame for s in src dcnl dcsp assert true coord frames fiff fiffv coord mri all dcnl dcsp image fname op join tempdir tempimage mgz dcnl dcsp assert raises valueerror srf export volume image fname verbose error dcnl dcsp disc2 disc copy dcnl dcsp disc20 type kitty dcnl dcsp src unrecognized src + disc2 dcnl dcsp assert raises valueerror src unrecognized export volume image fname verbose error dcnl dcsp bad image fname op join tempdir tempimage png dcnl dcsp assert raises valueerror src export volume bad image fname verbose error dcnl dcsp disc3 disc copy dcnl dcsp disc30 coord frame 10 dcnl dcsp src mixed coord src + disc3 dcnl dcsp assert raises valueerror src mixed coord export volume image fname verbose error
testing requires testing data dcnl def test morph source spaces dcsp src read source spaces fname fs dcnl dcsp src morph read source spaces fname morph dcnl dcsp src morph py morph source spaces src sample subjects dir subjects dir dcnl dcsp compare source spaces src morph src morph py mode approx
slow test dcnl testing requires testing data dcnl def test morphed source space return dcsp data rng randn 20484 1 dcnl dcsp tmin tstep 0 1 0 dcnl dcsp src fs read source spaces fname fs dcnl dcsp stc fs sourceestimate data s vertno for s in src fs tmin tstep fsaverage dcnl dcsp src morph morph source spaces src fs sample subjects dir subjects dir dcnl dcsp stc morph stc fs morph sample s vertno for s in src morph smooth 1 subjects dir subjects dir dcnl dcsp keeps np sort rng permutation np arange len v len v 10 for v in stc morph vertices dcnl dcsp stc morph sourceestimate np concatenate stc morph lh datakeeps0 stc morph rh datakeeps1 vk for v k in zip stc morph vertices keeps tmin tstep sample dcnl dcsp stc morph return stc morph to original src src fs subjects dir subjects dir dcnl dcsp stc morph morph stc morph morph fsaverage stc morph return vertices smooth 1 subjects dir subjects dir dcnl dcsp assert equal stc morph return subject stc morph morph subject dcnl dcsp for ii in range 2 dcnl dcsp dcsp assert array equal stc morph return verticesii stc morph morph verticesii dcnl dcsp corr np corrcoef stc morph return data 0 stc morph morph data 0 0 1 dcnl dcsp assert true corr 0 99 corr dcnl dcsp stc morph subject none dcnl dcsp assert raises valueerror stc morph to original src src fs subject orig fsaverage subjects dir subjects dir dcnl dcsp stc morph subject sample dcnl dcsp del src fs0 subject his id dcnl dcsp assert raises valueerror stc morph to original src src fs subjects dir subjects dir dcnl dcsp src fs0 subject his id fsaverage dcnl dcsp assert raises valueerror stc morph to original src src fs subject orig foo subjects dir subjects dir dcnl dcsp src fs0 subject his id sample dcnl dcsp src read source spaces fname dcnl dcsp assert raises runtimeerror stc morph to original src src subjects dir subjects dir
verbose dcnl def read selection name fname none info none verbose none dcsp if not isinstance name list tuple dcnl dcsp dcsp name name dcnl dcsp if isinstance info info dcnl dcsp dcsp picks pick types info meg true exclude dcnl dcsp dcsp if len picks 0 and dcsp not in info ch names picks0 dcnl dcsp dcsp dcsp spacing new dcnl dcsp dcsp else dcnl dcsp dcsp dcsp spacing old dcnl dcsp elif info is not none dcnl dcsp dcsp raise typeerror info dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp info dcsp or dcsp none dcsp not dcsp s type info dcnl dcsp else dcnl dcsp dcsp spacing old dcnl dcsp if fname is none dcnl dcsp dcsp fname path join path dirname file data mne analyze sel dcnl dcsp if not path isfile fname dcnl dcsp dcsp raise valueerror the dcsp file dcsp s dcsp does dcsp not dcsp exist fname dcnl dcsp name found dict n false for n in name dcnl dcsp with open fname r as fid dcnl dcsp dcsp sel dcnl dcsp dcsp for line in fid dcnl dcsp dcsp dcsp line line strip dcnl dcsp dcsp dcsp if len line 0 or line0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp pos line find dcnl dcsp dcsp dcsp if pos < 0 dcnl dcsp dcsp dcsp dcsp logger info dcsp delimiter dcsp not dcsp found dcsp in dcsp selections dcsp file dcsp skipping dcsp line dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp sel name file line pos dcnl dcsp dcsp dcsp for n in name dcnl dcsp dcsp dcsp dcsp if sel name file find n 0 dcnl dcsp dcsp dcsp dcsp dcsp sel extend line pos + 1 split | dcnl dcsp dcsp dcsp dcsp dcsp name foundn true dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp for n found in name found items dcnl dcsp dcsp if not found dcnl dcsp dcsp dcsp raise valueerror no dcsp match dcsp for dcsp selection dcsp name dcsp s dcsp found n dcnl dcsp sel list set sel dcnl dcsp sel sort dcnl dcsp if spacing new dcnl dcsp dcsp sel s replace meg dcsp meg for s in sel dcnl dcsp return sel
def divide to regions info add stim true dcsp from scipy stats import zscore dcnl dcsp picks pick data channels info exclude dcnl dcsp chs in lobe len picks 4 dcnl dcsp pos np array ch loc 3 for ch in info chs dcnl dcsp x y z pos t dcnl dcsp frontal picksnp argsort ypicks chs in lobe dcnl dcsp picks np setdiff1d picks frontal dcnl dcsp occipital picksnp argsort ypicks chs in lobe dcnl dcsp picks np setdiff1d picks occipital dcnl dcsp temporal picksnp argsort zpicks chs in lobe dcnl dcsp picks np setdiff1d picks temporal dcnl dcsp lt rt divide side temporal x dcnl dcsp lf rf divide side frontal x dcnl dcsp lo ro divide side occipital x dcnl dcsp lp rp divide side picks x dcnl dcsp with np errstate invalid ignore dcnl dcsp dcsp zs np abs zscore xrt dcnl dcsp dcsp outliers np array rt np where zs 2 0 0 dcnl dcsp rt list np setdiff1d rt outliers dcnl dcsp with np errstate invalid ignore dcnl dcsp dcsp zs np abs zscore xlt dcnl dcsp dcsp outliers np append outliers np array lt np where zs 2 0 0 dcnl dcsp lt list np setdiff1d lt outliers dcnl dcsp l mean np mean xlt dcnl dcsp r mean np mean xrt dcnl dcsp for outlier in outliers dcnl dcsp dcsp if abs l mean xoutlier < abs r mean xoutlier dcnl dcsp dcsp dcsp lt append outlier dcnl dcsp dcsp else dcnl dcsp dcsp dcsp rt append outlier dcnl dcsp if add stim dcnl dcsp dcsp stim ch get stim channel none info raise error false dcnl dcsp dcsp if len stim ch 0 dcnl dcsp dcsp dcsp for region in lf rf lo ro lp rp lt rt dcnl dcsp dcsp dcsp dcsp region append info ch names index stim ch0 dcnl dcsp return leftfrontal lf rightfrontal rf leftparietal lp rightparietal rp leftoccipital lo rightoccipital ro lefttemporal lt righttemporal rt
def divide side lobe x dcsp lobe np asarray lobe dcnl dcsp median np median xlobe dcnl dcsp left lobenp where xlobe < median 0 dcnl dcsp right lobenp where xlobe median 0 dcnl dcsp medians np where xlobe median 0 dcnl dcsp left np sort np concatenate left lobemedians1 2 dcnl dcsp right np sort np concatenate right lobemedians 2 dcnl dcsp return list left list right
def mxwarn msg dcsp warn possible dcsp maxfilter dcsp bug dcsp s dcsp more dcsp info dcsp http imaging mrccbu cam ac uk meg maxbugs msg
verbose dcnl def apply maxfilter in fname out fname origin none frame device bad none autobad off skip none force false st false st buflen 16 0 st corr 0 96 mv trans none mv comp false mv headpos false mv hp none mv hpistep none mv hpisubt none mv hpicons true linefreq none cal none ctc none mx args overwrite true verbose none dcsp if mv trans is not none and mv comp dcnl dcsp dcsp mxwarn don t dcsp use dcsp trans dcsp with dcsp headmovement dcsp compensation dcsp movecomp dcnl dcsp if autobad off and mv headpos or mv comp dcnl dcsp dcsp mxwarn don t dcsp use dcsp autobad dcsp with dcsp headposition dcsp estimation dcsp headpos dcsp or dcsp movement dcsp compensation dcsp movecomp dcnl dcsp if st and autobad off dcnl dcsp dcsp mxwarn don t dcsp use dcsp autobad dcsp with dcsp st dcsp option dcnl dcsp if origin is none dcnl dcsp dcsp logger info estimating dcsp head dcsp origin dcsp from dcsp headshape dcsp points dcnl dcsp dcsp raw read raw fif in fname dcnl dcsp dcsp r o head o dev fit sphere to headshape raw info units mm dcnl dcsp dcsp raw close dcnl dcsp dcsp logger info done dcnl dcsp dcsp if frame head dcnl dcsp dcsp dcsp origin o head dcnl dcsp dcsp elif frame device dcnl dcsp dcsp dcsp origin o dev dcnl dcsp dcsp else dcnl dcsp dcsp dcsp runtimeerror invalid dcsp frame dcsp for dcsp origin dcnl dcsp if not isinstance origin string types dcnl dcsp dcsp origin 0 1f dcsp 0 1f dcsp 0 1f origin0 origin1 origin2 dcnl dcsp cmd maxfilter dcsp f dcsp s dcsp o dcsp s dcsp frame dcsp s dcsp origin dcsp s dcsp in fname out fname frame origin dcnl dcsp if bad is not none dcnl dcsp dcsp if not isinstance bad list dcnl dcsp dcsp dcsp bad bad split dcnl dcsp dcsp bad map str bad dcnl dcsp dcsp bad logic ch3 if ch startswith meg else ch for ch in bad dcnl dcsp dcsp bad str dcsp join bad logic dcnl dcsp dcsp cmd + bad dcsp s dcsp bad str dcnl dcsp cmd + autobad dcsp s dcsp autobad dcnl dcsp if skip is not none dcnl dcsp dcsp if isinstance skip list dcnl dcsp dcsp dcsp skip dcsp join 0 3f dcsp 0 3f s0 s1 for s in skip dcnl dcsp dcsp cmd + skip dcsp s dcsp skip dcnl dcsp if force dcnl dcsp dcsp cmd + force dcsp dcnl dcsp if st dcnl dcsp dcsp cmd + st dcsp dcnl dcsp dcsp cmd + dcsp d dcsp st buflen dcnl dcsp dcsp cmd + corr dcsp 0 4f dcsp st corr dcnl dcsp if mv trans is not none dcnl dcsp dcsp cmd + trans dcsp s dcsp mv trans dcnl dcsp if mv comp dcnl dcsp dcsp cmd + movecomp dcsp dcnl dcsp dcsp if mv comp inter dcnl dcsp dcsp dcsp cmd + dcsp inter dcsp dcnl dcsp dcsp if mv headpos dcnl dcsp dcsp dcsp cmd + headpos dcsp dcnl dcsp dcsp if mv hp is not none dcnl dcsp dcsp dcsp cmd + hp dcsp s dcsp mv hp dcnl dcsp dcsp if mv hpisubt is not none dcnl dcsp dcsp dcsp cmd + hpisubt dcsp s dcsp mv hpisubt dcnl dcsp dcsp if mv hpicons dcnl dcsp dcsp dcsp cmd + hpicons dcsp dcnl dcsp if linefreq is not none dcnl dcsp dcsp cmd + linefreq dcsp d dcsp linefreq dcnl dcsp if cal is not none dcnl dcsp dcsp cmd + cal dcsp s dcsp cal dcnl dcsp if ctc is not none dcnl dcsp dcsp cmd + ctc dcsp s dcsp ctc dcnl dcsp cmd + mx args dcnl dcsp if overwrite and os path exists out fname dcnl dcsp dcsp os remove out fname dcnl dcsp logger info running dcsp maxfilter dcsp s dcsp cmd dcnl dcsp if os getenv mne maxfilter test true dcnl dcsp dcsp st os system cmd dcnl dcsp else dcnl dcsp dcsp print cmd dcnl dcsp dcsp st 0 dcnl dcsp if st 0 dcnl dcsp dcsp raise runtimeerror maxfilter dcsp returned dcsp nonzero dcsp exit dcsp status dcsp d st dcnl dcsp logger info done dcnl dcsp return origin
def get window start end dcsp from scipy signal import hann dcnl dcsp window 1 np r hann 4 2 np ones np abs end start 4 hann 4 2 t dcnl dcsp return window
def fix artifact data window picks first samp last samp mode dcsp from scipy interpolate import interp1d dcnl dcsp if mode linear dcnl dcsp dcsp x np array first samp last samp dcnl dcsp dcsp f interp1d x data first samp last samp picks dcnl dcsp dcsp xnew np arange first samp last samp dcnl dcsp dcsp interp data f xnew dcnl dcsp dcsp datapicks first samp last samp interp data dcnl dcsp if mode window dcnl dcsp dcsp datapicks first samp last samp datapicks first samp last samp windownp newaxis
def fix stim artifact inst events none event id none tmin 0 0 tmax 0 01 mode linear stim channel none dcsp if mode not in linear window dcnl dcsp dcsp raise valueerror mode dcsp has dcsp to dcsp be dcsp linear dcsp or dcsp window dcsp got dcsp s mode dcnl dcsp s start int np ceil inst info sfreq tmin dcnl dcsp s end int np ceil inst info sfreq tmax dcnl dcsp if mode window and s end s start < 4 dcnl dcsp dcsp raise valueerror time dcsp range dcsp is dcsp too dcsp short dcsp use dcsp a dcsp larger dcsp interval dcsp or dcsp set dcsp mode dcsp to dcsp linear dcnl dcsp window none dcnl dcsp if mode window dcnl dcsp dcsp window get window s start s end dcnl dcsp picks pick data channels inst info dcnl dcsp check preload inst fix stim artifact dcnl dcsp if isinstance inst baseraw dcnl dcsp dcsp if events is none dcnl dcsp dcsp dcsp events find events inst stim channel stim channel dcnl dcsp dcsp if len events 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp events dcsp are dcsp found dcnl dcsp dcsp if event id is none dcnl dcsp dcsp dcsp events sel np arange len events dcnl dcsp dcsp else dcnl dcsp dcsp dcsp events sel events 2 event id dcnl dcsp dcsp event start events events sel 0 dcnl dcsp dcsp data inst data dcnl dcsp dcsp for event idx in event start dcnl dcsp dcsp dcsp first samp int event idx inst first samp + s start dcnl dcsp dcsp dcsp last samp int event idx inst first samp + s end dcnl dcsp dcsp dcsp fix artifact data window picks first samp last samp mode dcnl dcsp elif isinstance inst baseepochs dcnl dcsp dcsp if inst reject is not none dcnl dcsp dcsp dcsp raise runtimeerror reject dcsp is dcsp already dcsp applied dcsp use dcsp reject none dcsp in dcsp the dcsp constructor dcnl dcsp dcsp e start int np ceil inst info sfreq inst tmin dcnl dcsp dcsp first samp s start e start dcnl dcsp dcsp last samp s end e start dcnl dcsp dcsp data inst data dcnl dcsp dcsp for epoch in data dcnl dcsp dcsp dcsp fix artifact epoch window picks first samp last samp mode dcnl dcsp elif isinstance inst evoked dcnl dcsp dcsp first samp s start inst first dcnl dcsp dcsp last samp s end inst first dcnl dcsp dcsp data inst data dcnl dcsp dcsp fix artifact data window picks first samp last samp mode dcnl dcsp else dcnl dcsp dcsp raise typeerror not dcsp a dcsp raw dcsp or dcsp epochs dcsp or dcsp evoked dcsp got dcsp s type inst dcnl dcsp return inst
def test peak finder dcsp x 0 2 5 0 6 1 dcnl dcsp peak inds peak mags peak finder x dcnl dcsp assert array equal peak inds 2 4
requires sklearn dcnl def test ica full data recovery dcsp raw read raw fif raw fname crop 0 5 stop load data dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads 10 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs epochs raw events 4 event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp evoked epochs average dcnl dcsp n channels 5 dcnl dcsp data raw data n channels copy dcnl dcsp data epochs epochs get data dcnl dcsp data evoked evoked data dcnl dcsp raw annotations annotations 0 5 0 5 bad dcnl dcsp for method in fastica dcnl dcsp dcsp stuff 2 n channels true 2 n channels 2 false dcnl dcsp dcsp for n components n pca components ok in stuff dcnl dcsp dcsp dcsp ica ica n components n components max pca components n pca components n pca components n pca components method method max iter 1 dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp ica fit raw picks list range n channels dcnl dcsp dcsp dcsp raw2 ica apply raw copy exclude dcnl dcsp dcsp dcsp if ok dcnl dcsp dcsp dcsp dcsp assert allclose data n channels raw2 data n channels rtol 1e10 atol 1e15 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp diff np abs data n channels raw2 data n channels dcnl dcsp dcsp dcsp dcsp assert true np max diff 1e14 dcnl dcsp dcsp dcsp ica ica n components n components max pca components n pca components n pca components n pca components dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp ica fit epochs picks list range n channels dcnl dcsp dcsp dcsp epochs2 ica apply epochs copy exclude dcnl dcsp dcsp dcsp data2 epochs2 get data n channels dcnl dcsp dcsp dcsp if ok dcnl dcsp dcsp dcsp dcsp assert allclose data epochs n channels data2 rtol 1e10 atol 1e15 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp diff np abs data epochs n channels data2 dcnl dcsp dcsp dcsp dcsp assert true np max diff 1e14 dcnl dcsp dcsp dcsp evoked2 ica apply evoked copy exclude dcnl dcsp dcsp dcsp data2 evoked2 data n channels dcnl dcsp dcsp dcsp if ok dcnl dcsp dcsp dcsp dcsp assert allclose data evoked n channels data2 rtol 1e10 atol 1e15 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp diff np abs evoked data n channels data2 dcnl dcsp dcsp dcsp dcsp assert true np max diff 1e14 dcnl dcsp assert raises valueerror ica method pizzadecomposision
requires sklearn dcnl def test ica rank reduction dcsp raw read raw fif raw fname crop 0 5 stop load data dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads 10 dcnl dcsp n components 5 dcnl dcsp max pca components len picks dcnl dcsp for n pca components in 6 10 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp ica ica n components n components max pca components max pca components n pca components n pca components method fastica max iter 1 fit raw picks picks dcnl dcsp dcsp rank before raw estimate rank picks picks dcnl dcsp dcsp assert equal rank before len picks dcnl dcsp dcsp raw clean ica apply raw copy dcnl dcsp dcsp rank after raw clean estimate rank picks picks dcnl dcsp dcsp assert true n components < n pca components < rank after < rank before
requires sklearn dcnl def test ica reset dcsp raw read raw fif raw fname crop 0 5 stop load data dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads 10 dcnl dcsp run time attrs pre whitener unmixing matrix mixing matrix n components n samples pca components pca explained variance pca mean dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica ica n components 3 max pca components 3 n pca components 3 method fastica max iter 1 fit raw picks picks dcnl dcsp assert true all hasattr ica attr for attr in run time attrs dcnl dcsp assert not equal ica labels none dcnl dcsp ica reset dcnl dcsp assert true not any hasattr ica attr for attr in run time attrs dcnl dcsp assert not equal ica labels none
requires sklearn dcnl def test ica core dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp test cov read cov test cov name dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp noise cov none test cov dcnl dcsp n components 2 1 0 dcnl dcsp max pca components 3 dcnl dcsp picks picks dcnl dcsp methods fastica dcnl dcsp iter ica params product noise cov n components max pca components picks methods dcnl dcsp assert raises valueerror ica n components 3 max pca components 2 dcnl dcsp assert raises valueerror ica n components 2 3 max pca components 2 dcnl dcsp for n cov n comp max n pcks method in iter ica params dcnl dcsp dcsp ica ica noise cov n cov n components n comp max pca components max n n pca components max n random state 0 method method max iter 1 dcnl dcsp dcsp assert raises valueerror ica contains mag dcnl dcsp dcsp print ica dcnl dcsp dcsp assert raises runtimeerror ica get sources raw dcnl dcsp dcsp assert raises runtimeerror ica get sources epochs dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp ica fit raw picks pcks start start stop stop dcnl dcsp dcsp dcsp repr ica dcnl dcsp dcsp assert true mag in ica dcnl dcsp dcsp unmixing1 ica unmixing matrix dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp ica fit raw picks pcks start start stop stop dcnl dcsp dcsp assert array almost equal unmixing1 ica unmixing matrix dcnl dcsp dcsp raw sources ica get sources raw dcnl dcsp dcsp assert equal raw sources filenames none dcnl dcsp dcsp print raw sources dcnl dcsp dcsp sources raw sources 0 dcnl dcsp dcsp assert true sources shape0 ica n components dcnl dcsp dcsp raw3 raw copy dcnl dcsp dcsp raw3 preload false dcnl dcsp dcsp assert raises valueerror ica apply raw3 include 1 2 dcnl dcsp dcsp ica ica noise cov n cov n components n comp max pca components max n n pca components max n random state 0 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp ica fit epochs picks picks dcnl dcsp dcsp data epochs get data 0 dcnl dcsp dcsp n samples np prod data shape dcnl dcsp dcsp assert equal ica n samples n samples dcnl dcsp dcsp print ica dcnl dcsp dcsp sources ica get sources epochs get data dcnl dcsp dcsp assert true sources shape1 ica n components dcnl dcsp dcsp assert raises valueerror ica score sources epochs target np arange 1 dcnl dcsp dcsp epochs3 epochs copy dcnl dcsp dcsp epochs3 preload false dcnl dcsp dcsp assert raises valueerror ica apply epochs3 include 1 2 dcnl dcsp pre whitener ica pre whitener copy dcnl dcsp epochs data 0 10 15 1000000000000 0 dcnl dcsp ica apply epochs copy dcnl dcsp assert array equal pre whitener ica pre whitener dcnl dcsp ica n components 0 1 dcnl dcsp assert raises runtimeerror ica fit epochs dcnl dcsp offender 1 2 3 dcnl dcsp assert raises valueerror ica get sources offender dcnl dcsp assert raises valueerror ica fit offender dcnl dcsp assert raises valueerror ica apply offender
slow test dcnl requires sklearn dcnl def test ica additional dcsp import matplotlib pyplot as plt dcnl dcsp tempdir tempdir dcnl dcsp stop2 500 dcnl dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp raw annotations annotations 0 5 0 5 bad dcnl dcsp test cov read cov test cov name dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp epochs epochs raw events 4 event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica ica n components none max pca components none n pca components none random state 0 dcnl dcsp dcsp ica fit epochs picks picks decim 3 dcnl dcsp picks2 pick types raw info meg true stim false ecg false eog true exclude bads dcnl dcsp epochs eog epochs raw events 4 event id tmin tmax picks picks2 baseline none 0 preload true dcnl dcsp test cov2 test cov copy dcnl dcsp ica ica noise cov test cov2 n components 3 max pca components 4 n pca components 4 dcnl dcsp assert true ica info is none dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks 5 dcnl dcsp assert true isinstance ica info info dcnl dcsp assert true ica n components < 5 dcnl dcsp ica ica n components 3 max pca components 4 n pca components 4 dcnl dcsp assert raises runtimeerror ica save dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks 1 2 3 4 5 start start stop stop2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp scores 1 ica find bads ecg raw dcnl dcsp dcsp scores 2 ica find bads ecg raw raw ch names1 dcnl dcsp assert false scores 10 scores 20 dcnl dcsp ica2 ica copy dcnl dcsp ica3 ica copy dcnl dcsp corrmap ica ica2 0 0 threshold auto label blinks plot true ch type mag dcnl dcsp corrmap ica ica2 0 0 threshold 2 plot false show false dcnl dcsp assert true ica labels blinks ica2 labels blinks dcnl dcsp assert true 0 in ica labels blinks dcnl dcsp components ica get components dcnl dcsp template components 0 dcnl dcsp evokedarray components ica info tmin 0 0 plot topomap 0 dcnl dcsp corrmap ica ica3 template threshold auto label blinks plot true ch type mag dcnl dcsp assert true ica2 labels blinks ica3 labels blinks dcnl dcsp plt close all dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp ica badname op join op dirname tempdir testbadname fif gz dcnl dcsp dcsp ica save ica badname dcnl dcsp dcsp read ica ica badname dcnl dcsp assert naming w test ica py 2 dcnl dcsp ica ica n components 3 max pca components 4 n pca components 4 dcnl dcsp raw raw copy dcnl dcsp for in range 3 dcnl dcsp dcsp raw append raw dcnl dcsp n samples raw data shape1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks none decim 3 dcnl dcsp assert true raw data shape1 n samples dcnl dcsp ica ica n components 1 0 max pca components 4 n pca components 4 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks none decim 3 dcnl dcsp assert true ica n components 4 dcnl dcsp ica var ica explained variance ica raw normalize true dcnl dcsp assert true np all ica var 1 ica var1 dcnl dcsp ica exclude 0 dcnl dcsp ica labels dict blink 0 think 1 dcnl dcsp ica sorted sort components ica 3 2 1 0 copy true dcnl dcsp assert equal ica sorted exclude 3 dcnl dcsp assert equal ica sorted labels dict blink 3 think 2 dcnl dcsp assert raises runtimeerror ica get sources epochs dcnl dcsp test ica fname op join op dirname tempdir testica fif dcnl dcsp for cov in none test cov dcnl dcsp dcsp ica ica noise cov cov n components 2 max pca components 4 n pca components 4 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp ica fit raw picks picks start start stop stop2 dcnl dcsp dcsp sources ica get sources epochs get data dcnl dcsp dcsp assert true ica mixing matrix shape 2 2 dcnl dcsp dcsp assert true ica unmixing matrix shape 2 2 dcnl dcsp dcsp assert true ica pca components shape 4 len picks dcnl dcsp dcsp assert true sources shape1 ica n components dcnl dcsp dcsp for exclude in 0 dcnl dcsp dcsp dcsp ica exclude exclude dcnl dcsp dcsp dcsp ica labels foo 0 dcnl dcsp dcsp dcsp ica save test ica fname dcnl dcsp dcsp dcsp ica read read ica test ica fname dcnl dcsp dcsp dcsp assert true ica exclude ica read exclude dcnl dcsp dcsp dcsp assert equal ica labels ica read labels dcnl dcsp dcsp dcsp ica exclude dcnl dcsp dcsp dcsp ica apply raw exclude 1 dcnl dcsp dcsp dcsp assert true ica exclude dcnl dcsp dcsp dcsp ica exclude 0 1 dcnl dcsp dcsp dcsp ica apply raw exclude 1 dcnl dcsp dcsp dcsp assert true ica exclude 0 1 dcnl dcsp dcsp dcsp ica raw ica get sources raw dcnl dcsp dcsp dcsp assert true ica exclude ica raw ch names index e for e in ica raw info bads dcnl dcsp dcsp d1 ica raw data0 copy dcnl dcsp dcsp ica raw filter 4 20 fir design firwin2 dcnl dcsp dcsp assert equal ica raw info lowpass 20 0 dcnl dcsp dcsp assert equal ica raw info highpass 4 0 dcnl dcsp dcsp assert true d1 ica raw data0 any dcnl dcsp dcsp d1 ica raw data0 copy dcnl dcsp dcsp ica raw notch filter 10 trans bandwidth 10 fir design firwin dcnl dcsp dcsp assert true d1 ica raw data0 any dcnl dcsp dcsp ica n pca components 2 dcnl dcsp dcsp ica method fake dcnl dcsp dcsp ica save test ica fname dcnl dcsp dcsp ica read read ica test ica fname dcnl dcsp dcsp assert true ica n pca components ica read n pca components dcnl dcsp dcsp assert equal ica method ica read method dcnl dcsp dcsp assert equal ica labels ica read labels dcnl dcsp dcsp attrs mixing matrix dcsp unmixing matrix dcsp pca components dcsp pca explained variance dcsp pre whitener dcnl dcsp dcsp def f x y dcnl dcsp dcsp dcsp return getattr x y dtype dcnl dcsp dcsp for attr in attrs split dcnl dcsp dcsp dcsp assert equal f ica read attr f ica attr dcnl dcsp dcsp ica n pca components 4 dcnl dcsp dcsp ica read n pca components 4 dcnl dcsp dcsp ica exclude dcnl dcsp dcsp ica save test ica fname dcnl dcsp dcsp ica read read ica test ica fname dcnl dcsp dcsp for attr in mixing matrix unmixing matrix pca components pca mean pca explained variance pre whitener dcnl dcsp dcsp dcsp assert array almost equal getattr ica attr getattr ica read attr dcnl dcsp dcsp assert true ica ch names ica read ch names dcnl dcsp dcsp assert true isinstance ica read info info dcnl dcsp dcsp sources ica get sources raw 0 dcnl dcsp dcsp sources2 ica read get sources raw 0 dcnl dcsp dcsp assert array almost equal sources sources2 dcnl dcsp dcsp raw1 ica apply raw exclude 1 dcnl dcsp dcsp raw2 ica read apply raw exclude 1 dcnl dcsp dcsp assert array almost equal raw1 0 raw2 0 dcnl dcsp os remove test ica fname dcnl dcsp for name func in get score funcs items dcnl dcsp dcsp if name in score funcs unsuited dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp scores ica score sources raw target eog dcsp 061 score func func start 0 stop 10 dcnl dcsp dcsp assert true ica n components len scores dcnl dcsp scores ica score sources raw score func stats skew dcnl dcsp assert raises valueerror ica score sources raw target np arange 1 dcnl dcsp params dcnl dcsp params + none 1 slice 2 0 1 dcnl dcsp params + none meg dcsp 1531 dcnl dcsp for idx ch name in product params dcnl dcsp dcsp ica detect artifacts raw start find 0 stop find 50 ecg ch ch name eog ch ch name skew criterion idx var criterion idx kurt criterion idx dcnl dcsp evoked epochs average dcnl dcsp evoked data evoked data copy dcnl dcsp raw data raw 0 copy dcnl dcsp epochs data epochs get data copy dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp idx scores ica find bads ecg raw method ctps dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp dcsp idx scores ica find bads ecg raw method correlation dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp dcsp idx scores ica find bads eog raw dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp dcsp idx scores ica find bads ecg epochs method ctps dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp dcsp assert raises valueerror ica find bads ecg epochs average method ctps dcnl dcsp dcsp assert raises valueerror ica find bads ecg raw method crazycoupling dcnl dcsp dcsp idx scores ica find bads eog raw dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp dcsp raw info chs raw ch names index eog dcsp 061 1 kind 202 dcnl dcsp dcsp idx scores ica find bads eog raw dcnl dcsp dcsp assert true isinstance scores list dcnl dcsp dcsp assert equal len scores0 ica n components dcnl dcsp dcsp idx scores ica find bads eog evoked ch name meg dcsp 1441 dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp dcsp idx scores ica find bads ecg evoked method correlation dcnl dcsp dcsp assert equal len scores ica n components dcnl dcsp assert array equal raw data raw 0 dcnl dcsp assert array equal epochs data epochs get data dcnl dcsp assert array equal evoked data evoked data dcnl dcsp for name func in get score funcs items dcnl dcsp dcsp if name in score funcs unsuited dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp scores ica score sources epochs eog target eog dcsp 061 score func func dcnl dcsp dcsp assert true ica n components len scores dcnl dcsp scores ica score sources epochs score func stats skew dcnl dcsp assert raises valueerror ica score sources epochs target np arange 1 dcnl dcsp ecg scores ica score sources raw target meg dcsp 1531 score func pearsonr dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ecg events ica find ecg events raw sourcesnp abs ecg scores argmax dcnl dcsp assert true ecg events ndim 2 dcnl dcsp eog scores ica score sources raw target eog dcsp 061 score func pearsonr dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp eog events ica find eog events raw sourcesnp abs eog scores argmax dcnl dcsp assert true eog events ndim 2 dcnl dcsp ica raw ica get sources raw start 0 stop 100 dcnl dcsp assert true ica raw last samp ica raw first samp 100 dcnl dcsp assert equal len ica raw filenames 1 dcnl dcsp ica chans ch for ch in ica raw ch names if ica in ch dcnl dcsp assert true ica n components len ica chans dcnl dcsp test ica fname op join op abspath op curdir testica raw fif dcnl dcsp ica n components np int32 ica n components dcnl dcsp ica raw save test ica fname overwrite true dcnl dcsp ica raw2 read raw fif test ica fname preload true dcnl dcsp assert allclose ica raw data ica raw2 data rtol 1e05 atol 0 0001 dcnl dcsp ica raw2 close dcnl dcsp os remove test ica fname dcnl dcsp ica epochs ica get sources epochs dcnl dcsp assert true ica epochs events shape epochs events shape dcnl dcsp ica chans ch for ch in ica epochs ch names if ica in ch dcnl dcsp assert true ica n components len ica chans dcnl dcsp assert true ica n components ica epochs get data shape1 dcnl dcsp assert true ica epochs raw is none dcnl dcsp assert true ica epochs preload is true dcnl dcsp ica pca explained variance np array 0 2 5 dcnl dcsp ica n components 0 dcnl dcsp for ncomps expected in 0 3 1 0 9 4 1 1 dcnl dcsp dcsp ncomps ica check n pca components ncomps dcnl dcsp dcsp assert true ncomps expected dcnl dcsp ica ica dcnl dcsp ica fit raw picks picks 5 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica find bads ecg raw dcnl dcsp ica find bads eog epochs ch name meg dcsp 0121 dcnl dcsp assert array equal raw data raw 0 dcnl dcsp raw drop channels meg dcsp 0122 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises runtimeerror ica find bads eog raw dcnl dcsp dcsp assert raises runtimeerror ica find bads ecg raw
requires sklearn dcnl def test run ica dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp params dcnl dcsp params + none 1 slice 2 0 1 dcnl dcsp params + none meg dcsp 1531 dcnl dcsp for idx ch name in product params dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp run ica raw n components 2 start 0 stop 6 start find 0 stop find 5 ecg ch ch name eog ch ch name skew criterion idx var criterion idx kurt criterion idx
requires sklearn dcnl def test ica reject buffer dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp ica ica n components 3 max pca components 4 n pca components 4 dcnl dcsp raw data2 1000 1005 5e12 dcnl dcsp with catch logging as drop log dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp ica fit raw picks 5 reject dict mag 2 5e12 decim 2 tstep 0 01 verbose true reject by annotation false dcnl dcsp dcsp assert true raw data 5 2 shape1 4 ica n samples dcnl dcsp log l for l in drop log getvalue split n if detected in l dcnl dcsp assert equal len log 1
requires sklearn dcnl def test ica twice dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp picks pick types raw info meg grad exclude bads dcnl dcsp n components 0 9 dcnl dcsp max pca components none dcnl dcsp n pca components 1 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica1 ica n components n components max pca components max pca components n pca components n pca components random state 0 dcnl dcsp dcsp ica1 fit raw picks picks decim 3 dcnl dcsp dcsp raw new ica1 apply raw n pca components n pca components dcnl dcsp dcsp ica2 ica n components n components max pca components max pca components n pca components 1 0 random state 0 dcnl dcsp dcsp ica2 fit raw new picks picks decim 3 dcnl dcsp dcsp assert equal ica1 n components ica2 n components
requires sklearn dcnl def test fit params dcsp assert raises valueerror ica fit params dict extended true dcnl dcsp fit params dcnl dcsp ica fit params fit params dcnl dcsp assert equal fit params
requires sklearn dcnl def test bad channels dcsp chs i for i in kind dict dcnl dcsp data chs data ch types split + eog dcnl dcsp chs bad list set chs set data chs dcnl dcsp info create info len chs 500 chs dcnl dcsp data np random rand len chs 50 dcnl dcsp raw rawarray data info dcnl dcsp data np random rand 100 len chs 50 dcnl dcsp epochs epochsarray data info dcnl dcsp n components 0 9 dcnl dcsp ica ica n components n components method fastica dcnl dcsp for inst in raw epochs dcnl dcsp dcsp for ch in chs bad dcnl dcsp dcsp dcsp picks bad1 pick types inst info meg false str ch true dcnl dcsp dcsp dcsp picks bad2 pick types inst info meg true str ch true dcnl dcsp dcsp dcsp assert raises valueerror ica fit inst picks picks bad1 dcnl dcsp dcsp dcsp assert raises valueerror ica fit inst picks picks bad2 dcnl dcsp dcsp assert raises valueerror ica fit inst picks
requires sklearn dcnl def test eog channel dcsp raw read raw fif raw fname preload true dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim true ecg false eog true exclude bads dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp n components 0 9 dcnl dcsp ica ica n components n components method fastica dcnl dcsp for inst in raw epochs dcnl dcsp dcsp picks1a pick types inst info meg true stim false ecg false eog false exclude bads 4 dcnl dcsp dcsp picks1b pick types inst info meg false stim false ecg false eog true exclude bads dcnl dcsp dcsp picks1 np append picks1a picks1b dcnl dcsp dcsp ica fit inst picks picks1 dcnl dcsp dcsp assert true any eog in ch for ch in ica ch names dcnl dcsp for inst in raw epochs dcnl dcsp dcsp picks1 pick types inst info meg true stim false ecg false eog false exclude bads 5 dcnl dcsp dcsp ica fit inst picks picks1 dcnl dcsp dcsp assert false any eog in ch for ch in ica ch names
requires sklearn dcnl def test max pca components none dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp events read events event name dcnl dcsp picks pick types raw info eeg true meg false dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp max pca components none dcnl dcsp n components 10 dcnl dcsp random state 12345 dcnl dcsp tempdir tempdir dcnl dcsp output fname op join tempdir test icaica fif dcnl dcsp ica ica max pca components max pca components n components n components random state random state dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit epochs dcnl dcsp ica save output fname dcnl dcsp ica read ica output fname dcnl dcsp assert equal ica max pca components epochs info nchan dcnl dcsp assert equal ica n components 10
requires sklearn dcnl def test n components none dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp events read events event name dcnl dcsp picks pick types raw info eeg true meg false dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp max pca components 10 dcnl dcsp n components none dcnl dcsp random state 12345 dcnl dcsp tempdir tempdir dcnl dcsp output fname op join tempdir test icaica fif dcnl dcsp ica ica max pca components max pca components n components n components random state random state dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit epochs dcnl dcsp ica save output fname dcnl dcsp ica read ica output fname dcnl dcsp assert equal ica max pca components 10 dcnl dcsp assert is none ica n components
requires sklearn dcnl def test n components and max pca components none dcsp raw read raw fif raw fname crop 1 5 stop load data dcnl dcsp events read events event name dcnl dcsp picks pick types raw info eeg true meg false dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp max pca components none dcnl dcsp n components none dcnl dcsp random state 12345 dcnl dcsp tempdir tempdir dcnl dcsp output fname op join tempdir test icaica fif dcnl dcsp ica ica max pca components max pca components n components n components random state random state dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit epochs dcnl dcsp ica save output fname dcnl dcsp ica read ica output fname dcnl dcsp assert equal ica max pca components epochs info nchan dcnl dcsp assert is none ica n components
def test find ecg dcsp raw read raw fif raw fname preload false dcnl dcsp for ch name in meg dcsp 1531 none dcnl dcsp dcsp events ch ecg average pulse ecg find ecg events raw event id 999 ch name ch name return ecg true dcnl dcsp dcsp assert equal raw n times ecg shape 1 dcnl dcsp dcsp n events len events dcnl dcsp dcsp times raw0 dcnl dcsp dcsp assert true 55 < average pulse < 60 dcnl dcsp picks pick types raw info meg grad eeg false stim false eog false ecg true emg false ref meg false exclude bads dcnl dcsp assert true ecg not in raw dcnl dcsp ecg epochs create ecg epochs raw picks picks keep ecg true dcnl dcsp assert equal len ecg epochs events n events dcnl dcsp assert true ecgsyn not in raw ch names dcnl dcsp assert true ecgsyn in ecg epochs ch names dcnl dcsp picks pick types ecg epochs info meg false eeg false stim false eog false ecg true emg false ref meg false exclude bads dcnl dcsp assert true len picks 1 dcnl dcsp ecg epochs create ecg epochs raw ch name meg dcsp 2641 dcnl dcsp assert true meg dcsp 2641 in ecg epochs ch names dcnl dcsp raw info projs list dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp raw set channel types meg dcsp 2641 ecg dcnl dcsp assert true len w 1 and unit dcsp for dcsp channel in str w0 message dcnl dcsp create ecg epochs raw
def test compute proj ecg dcsp raw read raw fif raw fname crop 0 10 dcnl dcsp raw load data dcnl dcsp for average in false true dcnl dcsp dcsp projs events compute proj ecg raw n mag 2 n grad 2 n eeg 2 ch name meg dcsp 1531 bads meg dcsp 2443 average average avg ref true no proj true l freq none h freq none reject none tmax dur use qrs threshold 0 5 filter length 6000 dcnl dcsp dcsp assert true len projs 7 dcnl dcsp dcsp assert true events shape0 0 5 dur use and events shape0 < 3 dur use dcnl dcsp dcsp ssp ecg proj for proj in projs if proj desc startswith ecg dcnl dcsp dcsp ssp ecg proj for proj in ssp ecg if pca01 in proj desc dcnl dcsp dcsp thresh eeg thresh axial thresh planar 0 9 0 3 0 1 dcnl dcsp dcsp for proj in ssp ecg dcnl dcsp dcsp dcsp if planar in proj desc dcnl dcsp dcsp dcsp dcsp assert true proj explained var thresh planar dcnl dcsp dcsp dcsp elif axial in proj desc dcnl dcsp dcsp dcsp dcsp assert true proj explained var thresh axial dcnl dcsp dcsp dcsp elif eeg in proj desc dcnl dcsp dcsp dcsp dcsp assert true proj explained var thresh eeg dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp projs events compute proj ecg raw n mag 2 n grad 2 n eeg 2 ch name meg dcsp 1531 bads average average avg ref true no proj true l freq none h freq none tmax dur use dcnl dcsp dcsp assert true len w 1 dcnl dcsp dcsp assert equal projs none
def test compute proj eog dcsp raw read raw fif raw fname crop 0 10 dcnl dcsp raw load data dcnl dcsp for average in false true dcnl dcsp dcsp n projs init len raw info projs dcnl dcsp dcsp projs events compute proj eog raw n mag 2 n grad 2 n eeg 2 bads meg dcsp 2443 average average avg ref true no proj false l freq none h freq none reject none tmax dur use filter length 6000 dcnl dcsp dcsp assert true len projs 7 + n projs init dcnl dcsp dcsp assert true np abs events shape0 np sum np less eog times dur use < 1 dcnl dcsp dcsp ssp eog proj for proj in projs if proj desc startswith eog dcnl dcsp dcsp ssp eog proj for proj in ssp eog if pca01 in proj desc dcnl dcsp dcsp thresh eeg thresh axial thresh planar 0 9 0 3 0 1 dcnl dcsp dcsp for proj in ssp eog dcnl dcsp dcsp dcsp if planar in proj desc dcnl dcsp dcsp dcsp dcsp assert true proj explained var thresh planar dcnl dcsp dcsp dcsp elif axial in proj desc dcnl dcsp dcsp dcsp dcsp assert true proj explained var thresh axial dcnl dcsp dcsp dcsp elif eeg in proj desc dcnl dcsp dcsp dcsp dcsp assert true proj explained var thresh eeg dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp projs events compute proj eog raw n mag 2 n grad 2 n eeg 2 average average bads avg ref true no proj false l freq none h freq none tmax dur use dcnl dcsp dcsp assert true len w 1 dcnl dcsp dcsp assert equal projs none
def test compute proj parallel dcsp raw 0 read raw fif raw fname crop 0 10 dcnl dcsp raw 0 load data dcnl dcsp raw raw 0 copy dcnl dcsp projs compute proj eog raw n mag 2 n grad 2 n eeg 2 bads meg dcsp 2443 average false avg ref true no proj false n jobs 1 l freq none h freq none reject none tmax dur use filter length 6000 dcnl dcsp raw 2 raw 0 copy dcnl dcsp projs 2 compute proj eog raw 2 n mag 2 n grad 2 n eeg 2 bads meg dcsp 2443 average false avg ref true no proj false n jobs 2 l freq none h freq none reject none tmax dur use filter length 6000 dcnl dcsp projs activate proj projs dcnl dcsp projs 2 activate proj projs 2 dcnl dcsp projs make projector projs raw 2 info ch names bads meg dcsp 2443 dcnl dcsp projs 2 make projector projs 2 raw 2 info ch names bads meg dcsp 2443 dcnl dcsp assert array almost equal projs projs 2 10
def get data n trials j extent dcsp ground truth np tile single trial n trials dcnl dcsp my shape n trials 1 600 dcnl dcsp random data rng random sample my shape dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp rand ints rng random integers j extent j extent n trials dcnl dcsp jittered data np array np roll single trial i for i in rand ints dcnl dcsp data np concatenate ground truth reshape my shape jittered data reshape my shape random data reshape my shape 1 dcnl dcsp assert true data shape n trials 3 600 dcnl dcsp return data
def test ctps dcsp for ii n trials j extent pk max in iter test ctps dcnl dcsp dcsp data get data n trials j extent dcnl dcsp dcsp ks dyn pk dyn phase trial ctps data dcnl dcsp dcsp data2 compute normalized phase data dcnl dcsp dcsp ks dyn2 pk dyn2 phase trial2 ctps data2 is raw false dcnl dcsp dcsp for a b in zip ks dyn pk dyn phase trial ks dyn2 pk dyn2 data2 dcnl dcsp dcsp dcsp assert array equal a b dcnl dcsp dcsp dcsp assert true a min 0 dcnl dcsp dcsp dcsp assert true a max < 1 dcnl dcsp dcsp dcsp assert true b min 0 dcnl dcsp dcsp dcsp assert true b max < 1 dcnl dcsp dcsp assert true pk dyn min 0 0 or pk dyn max < 1 0 dcnl dcsp dcsp assert true phase trial shape data shape dcnl dcsp dcsp assert true pk dyn shape data shape1 dcnl dcsp dcsp assert true pk dyn0 max 1 0 dcnl dcsp dcsp assert true len np unique pk dyn0 1 0 dcnl dcsp dcsp assert true pk dyn1 max < pk max dcnl dcsp dcsp assert true pk dyn2 max 0 3 dcnl dcsp dcsp if ii < 1 dcnl dcsp dcsp dcsp assert raises valueerror ctps data none dcnl dcsp assert true prob kuiper 1 0 400 1 0 dcnl dcsp assert array equal prob kuiper np array 1 0 1 0 400 prob kuiper np array 1 0 1 0 400 dcnl dcsp assert true prob kuiper 0 1 400 < 0 1
testing requires testing data dcnl def test read write fine cal dcsp temp dir tempdir dcnl dcsp temp fname op join temp dir fine cal temp dat dcnl dcsp for fname in fine cal fname fine cal fname 3d dcnl dcsp dcsp fine cal dict read fine calibration fname dcnl dcsp dcsp write fine calibration temp fname fine cal dict dcnl dcsp dcsp fine cal dict reload read fine calibration temp fname dcnl dcsp dcsp assert equal object hash fine cal dict object hash fine cal dict reload
def test fix stim artifact dcsp events read events event fname dcnl dcsp raw read raw fif raw fname dcnl dcsp assert raises runtimeerror fix stim artifact raw dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp tmin tmax event id 0 2 0 5 1 dcnl dcsp picks pick types raw info meg true eeg true eog true stim false exclude bads dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true reject none dcnl dcsp e start int np ceil epochs info sfreq epochs tmin dcnl dcsp tmin tmax 0 045 0 015 dcnl dcsp tmin samp int 0 035 epochs info sfreq e start dcnl dcsp tmax samp int 0 015 epochs info sfreq e start dcnl dcsp epochs fix stim artifact epochs tmin tmin tmax tmax mode linear dcnl dcsp data epochs get data tmin samp tmax samp dcnl dcsp diff data0 np diff data00 dcnl dcsp diff data0 np mean diff data0 dcnl dcsp assert array almost equal diff data0 np zeros len diff data0 dcnl dcsp epochs fix stim artifact epochs tmin tmin tmax tmax mode window dcnl dcsp data from epochs fix epochs get data tmin samp tmax samp dcnl dcsp assert true np all data from epochs fix 0 0 dcnl dcsp event idx np where events 2 1 00 dcnl dcsp tmin tmax 0 045 0 015 dcnl dcsp tmin samp int 0 035 raw info sfreq dcnl dcsp tmax samp int 0 015 raw info sfreq dcnl dcsp tidx int events event idx 0 raw first samp dcnl dcsp assert raises valueerror fix stim artifact raw events np array dcnl dcsp raw fix stim artifact raw events none event id 1 tmin tmin tmax tmax mode linear stim channel sti dcsp 014 dcnl dcsp data times raw tidx + tmin samp tidx + tmax samp dcnl dcsp diff data0 np diff data0 dcnl dcsp diff data0 np mean diff data0 dcnl dcsp assert array almost equal diff data0 np zeros len diff data0 dcnl dcsp raw fix stim artifact raw events event id 1 tmin tmin tmax tmax mode window dcnl dcsp data times raw tidx + tmin samp tidx + tmax samp dcnl dcsp assert true np all data 0 0 dcnl dcsp tmin tmax event id 0 2 0 5 1 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true reject none baseline none dcnl dcsp e start int np ceil epochs info sfreq epochs tmin dcnl dcsp tmin samp int 0 035 epochs info sfreq e start dcnl dcsp tmax samp int 0 015 epochs info sfreq e start dcnl dcsp data from raw fix epochs get data tmin samp tmax samp dcnl dcsp assert true np all data from raw fix 0 0 dcnl dcsp evoked epochs average dcnl dcsp tmin tmax 0 005 0 045 dcnl dcsp tmin samp int 0 015 evoked info sfreq evoked first dcnl dcsp tmax samp int 0 035 evoked info sfreq evoked first dcnl dcsp evoked fix stim artifact evoked tmin tmin tmax tmax mode linear dcnl dcsp data evoked data tmin samp tmax samp dcnl dcsp diff data0 np diff data0 dcnl dcsp diff data0 np mean diff data0 dcnl dcsp assert array almost equal diff data0 np zeros len diff data0 dcnl dcsp evoked fix stim artifact evoked tmin tmin tmax tmax mode window dcnl dcsp data evoked data tmin samp tmax samp dcnl dcsp assert true np all data 0 0
def generate data for comparing against eeglab infomax ch type random state dcsp data dir op join testing data path download false meg sample dcnl dcsp raw fname op join data dir sample audvis trunc raw fif dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp if ch type eeg dcnl dcsp dcsp picks pick types raw info meg false eeg true exclude bads dcnl dcsp else dcnl dcsp dcsp picks pick types raw info meg ch type eeg false exclude bads dcnl dcsp number of channels to use 5 dcnl dcsp idx perm random permutation picks shape0 random state dcnl dcsp picks picksidx perm number of channels to use dcnl dcsp raw filter 1 45 picks picks filter length 10s l trans bandwidth 0 5 h trans bandwidth 0 5 phase zerodouble fir window hann fir design firwin2 dcnl dcsp x rawpicks 0 20 dcnl dcsp mean x x mean axis 1 dcnl dcsp x mean x none dcnl dcsp x np std x dcnl dcsp t x shape1 dcnl dcsp cov x np dot x x t t dcnl dcsp u d svd cov x dcnl dcsp w np dot u u t np sqrt d none dcnl dcsp y np dot w x dcnl dcsp return y
slow test dcnl testing requires testing data dcnl def test mne python vs eeglab dcsp random state 42 dcnl dcsp methods infomax extended infomax dcnl dcsp ch types eeg mag dcnl dcsp for ch type in ch types dcnl dcsp dcsp y generate data for comparing against eeglab infomax ch type random state dcnl dcsp dcsp n t y shape dcnl dcsp dcsp for method in methods dcnl dcsp dcsp dcsp eeglab results file eeglab s results s data mat method dict eeg eeg mag meg ch type dcnl dcsp dcsp dcsp l rate eeglab 0 00065 np log n dcnl dcsp dcsp dcsp block eeglab int np ceil np min 5 np log t 0 3 t dcnl dcsp dcsp dcsp blowup eeglab 1000000000 0 dcnl dcsp dcsp dcsp blowup fac eeglab 0 8 dcnl dcsp dcsp dcsp max iter eeglab 512 dcnl dcsp dcsp dcsp if method infomax dcnl dcsp dcsp dcsp dcsp anneal step eeglab 0 9 dcnl dcsp dcsp dcsp dcsp use extended false dcnl dcsp dcsp dcsp elif method extended infomax dcnl dcsp dcsp dcsp dcsp anneal step eeglab 0 98 dcnl dcsp dcsp dcsp dcsp use extended true dcnl dcsp dcsp dcsp w change eeglab 1e07 if n 32 else 1e06 dcnl dcsp dcsp dcsp unmixing infomax y t extended use extended random state random state max iter max iter eeglab l rate l rate eeglab block block eeglab w change w change eeglab blowup blowup eeglab blowup fac blowup fac eeglab n small angle none anneal step anneal step eeglab dcnl dcsp dcsp dcsp sources np dot unmixing y dcnl dcsp dcsp dcsp mixing pinv unmixing dcnl dcsp dcsp dcsp mvar np sum mixing 2 axis 0 np sum sources 2 axis 1 n t 1 dcnl dcsp dcsp dcsp windex np argsort mvar 1 dcnl dcsp dcsp dcsp unmixing ordered unmixingwindex dcnl dcsp dcsp dcsp eeglab data sio loadmat op join base dir eeglab results file dcnl dcsp dcsp dcsp unmixing eeglab eeglab data unmixing eeglab dcnl dcsp dcsp dcsp maximum difference np max np abs unmixing ordered unmixing eeglab dcnl dcsp dcsp dcsp assert almost equal maximum difference 1e12 decimal 10
def center and norm x axis 1 dcsp x np rollaxis x axis dcnl dcsp x x mean axis 0 dcnl dcsp x x std axis 0
requires sklearn dcnl def test infomax blowup dcsp np random seed 0 dcnl dcsp n samples 100 dcnl dcsp s1 2 np sin np linspace 0 100 n samples 0 1 dcnl dcsp s2 stats t rvs 1 size n samples dcnl dcsp s np c s1 s2 t dcnl dcsp center and norm s dcnl dcsp s1 s2 s dcnl dcsp phi 0 6 dcnl dcsp mixing np array np cos phi np sin phi np sin phi np cos phi dcnl dcsp m np dot mixing s dcnl dcsp center and norm m dcnl dcsp x get pca fit transform m t dcnl dcsp k infomax x extended true l rate 0 1 dcnl dcsp s np dot k x t dcnl dcsp center and norm s dcnl dcsp s1 s2 s dcnl dcsp if abs np dot s1 s2 abs np dot s1 s1 dcnl dcsp dcsp s2 s1 s dcnl dcsp s1 np sign np dot s1 s1 dcnl dcsp s2 np sign np dot s2 s2 dcnl dcsp assert almost equal np dot s1 s1 n samples 1 decimal 2 dcnl dcsp assert almost equal np dot s2 s2 n samples 1 decimal 2
requires sklearn dcnl def test infomax simple dcsp rng np random randomstate 0 dcnl dcsp np random seed 0 dcnl dcsp n samples 500 dcnl dcsp s1 2 np sin np linspace 0 100 n samples 0 1 dcnl dcsp s2 stats t rvs 1 size n samples dcnl dcsp s np c s1 s2 t dcnl dcsp center and norm s dcnl dcsp s1 s2 s dcnl dcsp phi 0 6 dcnl dcsp mixing np array np cos phi np sin phi np sin phi np cos phi dcnl dcsp for add noise in false true dcnl dcsp dcsp m np dot mixing s dcnl dcsp dcsp if add noise dcnl dcsp dcsp dcsp m + 0 1 rng randn 2 n samples dcnl dcsp dcsp center and norm m dcnl dcsp dcsp algos true false dcnl dcsp dcsp for algo in algos dcnl dcsp dcsp dcsp x get pca fit transform m t dcnl dcsp dcsp dcsp k infomax x extended algo dcnl dcsp dcsp dcsp s np dot k x t dcnl dcsp dcsp dcsp center and norm s dcnl dcsp dcsp dcsp s1 s2 s dcnl dcsp dcsp dcsp if abs np dot s1 s2 abs np dot s1 s1 dcnl dcsp dcsp dcsp dcsp s2 s1 s dcnl dcsp dcsp dcsp s1 np sign np dot s1 s1 dcnl dcsp dcsp dcsp s2 np sign np dot s2 s2 dcnl dcsp dcsp dcsp if not add noise dcnl dcsp dcsp dcsp dcsp assert almost equal np dot s1 s1 n samples 1 decimal 2 dcnl dcsp dcsp dcsp dcsp assert almost equal np dot s2 s2 n samples 1 decimal 2 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp assert almost equal np dot s1 s1 n samples 1 decimal 1 dcnl dcsp dcsp dcsp dcsp assert almost equal np dot s2 s2 n samples 1 decimal 1
def test infomax weights ini dcsp x np random random 3 100 dcnl dcsp weights np array 1 2 3 4 5 6 7 8 9 dtype np float64 dcnl dcsp w1 infomax x max iter 0 weights weights extended true dcnl dcsp w2 infomax x max iter 0 weights weights extended false dcnl dcsp assert almost equal w1 weights dcnl dcsp assert almost equal w2 weights
requires sklearn dcnl def test non square infomax dcsp rng np random randomstate 0 dcnl dcsp n samples 200 dcnl dcsp t np linspace 0 100 n samples dcnl dcsp s1 np sin t dcnl dcsp s2 np ceil np sin np pi t dcnl dcsp s np c s1 s2 t dcnl dcsp center and norm s dcnl dcsp s1 s2 s dcnl dcsp n observed 6 dcnl dcsp mixing rng randn n observed 2 dcnl dcsp for add noise in false true dcnl dcsp dcsp m np dot mixing s dcnl dcsp dcsp if add noise dcnl dcsp dcsp dcsp m + 0 1 rng randn n observed n samples dcnl dcsp dcsp center and norm m dcnl dcsp dcsp m m t dcnl dcsp dcsp m get pca rng fit transform m dcnl dcsp dcsp unmixing infomax m random state rng extended true dcnl dcsp dcsp s np dot unmixing m t dcnl dcsp dcsp mixing linalg pinv unmixing t dcnl dcsp dcsp assert almost equal m s t dot mixing dcnl dcsp dcsp center and norm s dcnl dcsp dcsp s1 s2 s dcnl dcsp dcsp if abs np dot s1 s2 abs np dot s1 s1 dcnl dcsp dcsp dcsp s2 s1 s dcnl dcsp dcsp s1 np sign np dot s1 s1 dcnl dcsp dcsp s2 np sign np dot s2 s2 dcnl dcsp dcsp if not add noise dcnl dcsp dcsp dcsp assert almost equal np dot s1 s1 n samples 1 decimal 2 dcnl dcsp dcsp dcsp assert almost equal np dot s2 s2 n samples 1 decimal 2
def test find eog dcsp raw read raw fif raw fname dcnl dcsp raw annotations annotations 14 21 1 1 bad blink dcnl dcsp events find eog events raw dcnl dcsp assert true len events 4 dcnl dcsp assert true not all events 0 < 29000 dcnl dcsp events find eog events raw reject by annotation true dcnl dcsp assert true all events 0 < 29000
def get data dcsp raw read raw fif raw fname verbose false preload true dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg false eeg true stim false ecg false eog false exclude bads 8 dcnl dcsp return raw events picks
def test xdawn dcsp xdawn n components 2 correct overlap auto signal cov none reg none dcnl dcsp assert raises valueerror xdawn correct overlap 42
def test xdawn fit dcsp raw events picks get data dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true baseline none verbose false dcnl dcsp xd xdawn n components 2 correct overlap auto dcnl dcsp xd fit epochs dcnl dcsp assert equal xd correct overlap false dcnl dcsp evoked epochs cond2 average dcnl dcsp assert array equal evoked data xd evokeds cond2 data dcnl dcsp signal cov compute raw covariance raw picks picks dcnl dcsp xd xdawn n components 2 correct overlap false signal cov signal cov dcnl dcsp xd fit epochs dcnl dcsp signal cov np eye len picks dcnl dcsp xd xdawn n components 2 correct overlap false signal cov signal cov dcnl dcsp xd fit epochs dcnl dcsp signal cov np eye len picks 1 dcnl dcsp xd xdawn n components 2 correct overlap false signal cov signal cov dcnl dcsp assert raises valueerror xd fit epochs dcnl dcsp signal cov 42 dcnl dcsp xd xdawn n components 2 correct overlap false signal cov signal cov dcnl dcsp assert raises valueerror xd fit epochs dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true baseline none 0 verbose false dcnl dcsp xd xdawn n components 2 correct overlap true dcnl dcsp assert raises valueerror xd fit epochs
def test xdawn apply transform dcsp raw events picks get data dcnl dcsp raw pick types eeg true meg false dcnl dcsp epochs epochs raw events event id tmin tmax proj false preload true baseline none verbose false dcnl dcsp n components 2 dcnl dcsp xd xdawn n components n components correct overlap false dcnl dcsp xd fit epochs dcnl dcsp for inst in raw epochs average epochs dcnl dcsp dcsp denoise xd apply inst dcnl dcsp assert raises valueerror xd apply 42 dcnl dcsp xd transform epochs dcnl dcsp xd transform epochs data dcnl dcsp assert raises valueerror xd transform 42 dcnl dcsp np random seed 0 dcnl dcsp idx np arange len epochs dcnl dcsp np random shuffle idx dcnl dcsp xd fit epochsidx dcnl dcsp denoise shfl xd apply epochs dcnl dcsp assert array almost equal denoise cond2 data denoise shfl cond2 data
requires sklearn dcnl def test xdawn regularization dcsp raw events picks get data dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true baseline none verbose false dcnl dcsp events epochs events dcnl dcsp sel np where events 2 2 0 2 dcnl dcsp modified event eventssel0 dcnl dcsp modified event0 + 1 dcnl dcsp epochs eventssel1 modified event dcnl dcsp xd xdawn n components 2 correct overlap auto reg oas dcnl dcsp xd fit epochs dcnl dcsp assert equal xd correct overlap true dcnl dcsp evoked epochs cond2 average dcnl dcsp assert true np sum np abs evoked data xd evokeds cond2 data dcnl dcsp for reg in 0 1 0 1 ledoit wolf oas dcnl dcsp dcsp xd xdawn n components 2 correct overlap false signal cov np eye len picks reg reg dcnl dcsp dcsp xd fit epochs dcnl dcsp xd xdawn n components 2 correct overlap false signal cov np eye len picks reg 2 dcnl dcsp assert raises valueerror xd fit epochs
requires sklearn dcnl def test xdawntransformer dcsp raw events picks get data dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true baseline none verbose false dcnl dcsp x epochs data dcnl dcsp y epochs events 1 dcnl dcsp xdt xdawntransformer dcnl dcsp xdt fit x y dcnl dcsp assert raises valueerror xdt fit x y1 dcnl dcsp assert raises valueerror xdt fit foo dcnl dcsp signal cov compute raw covariance raw picks picks dcnl dcsp xdt xdawntransformer signal cov signal cov dcnl dcsp xdt fit x y dcnl dcsp signal cov np eye len picks dcnl dcsp xdt xdawntransformer signal cov signal cov dcnl dcsp xdt fit x y dcnl dcsp signal cov np eye len picks 1 dcnl dcsp xdt xdawntransformer signal cov signal cov dcnl dcsp assert raises valueerror xdt fit x y dcnl dcsp signal cov 42 dcnl dcsp xdt xdawntransformer signal cov signal cov dcnl dcsp assert raises valueerror xdt fit x y dcnl dcsp xdt xdawntransformer dcnl dcsp xdt fit x dcnl dcsp xd xdawn correct overlap false dcnl dcsp xd fit epochs dcnl dcsp xdt xdawntransformer dcnl dcsp xdt fit x y dcnl dcsp assert array almost equal xd filters cond2 2 xdt filters reshape 2 2 8 0 t dcnl dcsp xdt transform x1 dcnl dcsp xdt transform x 1 dcnl dcsp assert raises valueerror xdt transform x 1 dcnl dcsp xt xdt transform x dcnl dcsp assert raises valueerror xdt transform 42 dcnl dcsp xinv xdt inverse transform xt dcnl dcsp assert equal xinv shape x shape dcnl dcsp xdt inverse transform xt1 dcnl dcsp xdt inverse transform xt 1 dcnl dcsp assert raises valueerror xdt inverse transform xt 1 dcnl dcsp assert raises valueerror xdt inverse transform 42
def assert n free raw sss lower upper none dcsp upper lower if upper is none else upper dcnl dcsp n free raw sss info proc history 0 max info sss info nfree dcnl dcsp assert true lower < n free < upper nfree dcsp fail dcsp s dcsp < dcsp s dcsp < dcsp s lower n free upper
def read crop fname lims 0 none dcsp return read raw fif fname allow maxshield yes crop lims
slow test dcnl testing requires testing data dcnl def test movement compensation dcsp temp dir tempdir dcnl dcsp lims 0 4 dcnl dcsp raw read crop raw fname lims load data dcnl dcsp head pos read head pos pos fname dcnl dcsp raw sss maxwell filter raw head pos head pos origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss read crop sss movecomp fname lims 4 6 12 4 chpi med tol 58 dcnl dcsp temp fname op join temp dir test raw sss fif dcnl dcsp raw sss save temp fname dcnl dcsp raw sss read crop temp fname dcnl dcsp assert meg snr raw sss read crop sss movecomp fname lims 4 6 12 4 chpi med tol 58 dcnl dcsp raw sss maxwell filter raw head pos head pos origin mf head origin dcnl dcsp assert meg snr raw sss read crop sss movecomp reg in fname lims 0 5 1 9 chpi med tol 121 dcnl dcsp raw nohpi filter chpi raw copy dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp raw sss mv maxwell filter raw nohpi head pos head pos st duration 4 0 origin mf head origin st fixed false dcnl dcsp assert equal len w 1 dcnl dcsp assert true is dcsp untested in str w0 message dcnl dcsp assert meg snr raw sss mv read crop sss movecomp reg in st4s fname lims 0 6 1 3 dcnl dcsp tsss fname op join sss path test move anon st4s raw sss fif dcnl dcsp assert meg snr raw sss mv read crop tsss fname lims 0 6 1 0 chpi med tol none dcnl dcsp assert meg snr read crop sss movecomp reg in st4s fname read crop tsss fname 0 8 1 0 chpi med tol none dcnl dcsp raw sss mc maxwell filter raw nohpi head pos head pos st duration 4 0 origin mf head origin dcnl dcsp assert meg snr raw sss mc read crop tsss fname lims 0 6 1 0 chpi med tol none dcnl dcsp assert meg snr raw sss mc raw sss mv 0 6 1 4 dcnl dcsp raw erm read crop erm fname dcnl dcsp assert raises valueerror maxwell filter raw erm coord frame meg head pos head pos dcnl dcsp assert raises valueerror maxwell filter raw head pos head pos 9 dcnl dcsp assert raises typeerror maxwell filter raw head pos foo dcnl dcsp assert raises valueerror maxwell filter raw head pos head pos 1 dcnl dcsp head pos bad head pos copy dcnl dcsp head pos bad 0 0 raw first samp raw info sfreq 0 01 dcnl dcsp assert raises valueerror maxwell filter raw head pos head pos bad dcnl dcsp head pos bad head pos copy dcnl dcsp head pos bad 0 4 1 0 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp maxwell filter raw copy crop 0 0 1 head pos head pos bad bad condition ignore dcnl dcsp assert true any greater dcsp than dcsp 1 dcsp m in str ww message for ww in w dcnl dcsp head pos bad head pos copy dcnl dcsp head pos bad 0 0 raw first samp raw info sfreq 0 0005 dcnl dcsp raw sss tweak maxwell filter raw copy crop 0 0 05 head pos head pos bad origin mf head origin dcnl dcsp assert meg snr raw sss tweak raw sss copy crop 0 0 05 1 4 8 0 chpi med tol 5
slow test dcnl def test other systems dcsp kit dir op join io dir kit tests data dcnl dcsp sqd path op join kit dir test sqd dcnl dcsp mrk path op join kit dir test mrk sqd dcnl dcsp elp path op join kit dir test elp txt dcnl dcsp hsp path op join kit dir test hsp txt dcnl dcsp raw kit read raw kit sqd path mrk path elp path hsp path dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises runtimeerror maxwell filter raw kit dcnl dcsp raw sss maxwell filter raw kit origin 0 0 0 0 0 04 ignore ref true dcnl dcsp assert n free raw sss 65 65 dcnl dcsp raw sss auto maxwell filter raw kit origin 0 0 0 0 0 04 ignore ref true mag scale auto dcnl dcsp assert allclose raw sss data raw sss auto data dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp assert raises runtimeerror maxwell filter raw kit ignore ref true regularize none dcnl dcsp dcsp dcsp raw sss maxwell filter raw kit origin auto ignore ref true bad condition warning verbose warning dcnl dcsp log file log file getvalue dcnl dcsp assert true badly dcsp conditioned in log file dcnl dcsp assert true more dcsp than dcsp 20 dcsp mm dcsp from in log file dcnl dcsp assert n free raw sss 28 34 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp raw sss maxwell filter raw kit origin 0 0 0 0 0 04 ignore ref true bad condition warning regularize none verbose warning dcnl dcsp log file log file getvalue dcnl dcsp assert true badly dcsp conditioned in log file dcnl dcsp assert n free raw sss 80 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp raw sss maxwell filter raw kit origin 0 0 0 0 0 04 ignore ref true verbose true dcnl dcsp log file log file getvalue dcnl dcsp assert true badly dcsp conditioned not in log file dcnl dcsp assert n free raw sss 65 dcnl dcsp bti dir op join io dir bti tests data dcnl dcsp bti pdf op join bti dir test pdf linux dcnl dcsp bti config op join bti dir test config linux dcnl dcsp bti hs op join bti dir test hs linux dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw bti read raw bti bti pdf bti config bti hs preload false dcnl dcsp picks pick types raw bti info meg mag exclude dcnl dcsp power np sqrt np sum raw btipicks0 2 dcnl dcsp raw sss maxwell filter raw bti dcnl dcsp assert n free raw sss 70 dcnl dcsp assert shielding raw sss power 0 5 dcnl dcsp raw sss auto maxwell filter raw bti mag scale auto verbose true dcnl dcsp assert shielding raw sss auto power 0 7 dcnl dcsp raw ctf read crop fname ctf raw dcnl dcsp assert equal raw ctf compensation grade 3 dcnl dcsp assert raises runtimeerror maxwell filter raw ctf dcnl dcsp raw ctf apply gradient compensation 0 dcnl dcsp assert raises valueerror maxwell filter raw ctf dcnl dcsp raw sss maxwell filter raw ctf origin 0 0 0 0 0 04 dcnl dcsp assert n free raw sss 68 dcnl dcsp assert shielding raw sss raw ctf 1 8 dcnl dcsp raw sss maxwell filter raw ctf origin 0 0 0 0 0 04 ignore ref true dcnl dcsp assert n free raw sss 70 dcnl dcsp assert shielding raw sss raw ctf 12 dcnl dcsp raw sss auto maxwell filter raw ctf origin 0 0 0 0 0 04 ignore ref true mag scale auto dcnl dcsp assert allclose raw sss data raw sss auto data
def test spherical conversions dcsp az pol np meshgrid np linspace 0 2 np pi 30 np linspace 0 np pi 20 dcnl dcsp for degree in range 1 int order dcnl dcsp dcsp for order in range 0 degree + 1 dcnl dcsp dcsp dcsp sph get sph harm order degree az pol dcnl dcsp dcsp dcsp assert allclose sh negate sph order get sph harm order degree az pol dcnl dcsp dcsp dcsp sph real pos sh complex to real sph order dcnl dcsp dcsp dcsp sph real neg sh complex to real sph order dcnl dcsp dcsp dcsp sph 2 sh real to complex sph real pos sph real neg order dcnl dcsp dcsp dcsp assert allclose sph sph 2 atol 1e07
testing requires testing data dcnl def test multipolar bases dcsp from scipy io import loadmat dcnl dcsp info read info raw fname dcnl dcsp coils prep meg channels info accurate true elekta defs true do es true 0 dcnl dcsp sss data loadmat bases fname dcnl dcsp exp dict int order int order ext order ext order dcnl dcsp for origin in 0 0 0 04 0 0 02 0 02 dcnl dcsp dcsp o str join d 1000 n for n in origin dcnl dcsp dcsp exp update origin origin dcnl dcsp dcsp s tot sss basis basic exp coils method alternative dcnl dcsp dcsp s tot complex bases real to complex s tot int order ext order dcnl dcsp dcsp s tot round bases complex to real s tot complex int order ext order dcnl dcsp dcsp assert allclose s tot s tot round atol 1e07 dcnl dcsp dcsp s tot mat np concatenate sss data sin + o str sss data sout + o str axis 1 dcnl dcsp dcsp s tot mat real bases complex to real s tot mat int order ext order dcnl dcsp dcsp s tot mat round bases real to complex s tot mat real int order ext order dcnl dcsp dcsp assert allclose s tot mat s tot mat round atol 1e07 dcnl dcsp dcsp assert allclose s tot complex s tot mat rtol 0 0001 atol 1e08 dcnl dcsp dcsp assert allclose s tot s tot mat real rtol 0 0001 atol 1e08 dcnl dcsp dcsp s tot np sqrt np sum s tot s tot axis 0 np newaxis dcnl dcsp dcsp s tot complex np sqrt np sum s tot complex s tot complex conj real axis 0 np newaxis dcnl dcsp dcsp s tot mat np concatenate sss data snin + o str sss data snout + o str axis 1 dcnl dcsp dcsp s tot mat real bases complex to real s tot mat int order ext order dcnl dcsp dcsp s tot mat round bases real to complex s tot mat real int order ext order dcnl dcsp dcsp assert allclose s tot mat s tot mat round atol 1e07 dcnl dcsp dcsp assert allclose s tot complex s tot mat rtol 0 0001 atol 1e08 dcnl dcsp dcsp s tot sss basis basic exp coils dcnl dcsp dcsp s tot fast trans sss basis exp all coils prep mf coils info trans info dev head t dcnl dcsp dcsp flips np sign s tot fast2 np sign s tot2 dcnl dcsp dcsp flips 1 2 flips dcnl dcsp dcsp assert allclose s tot s tot fast flips atol 1e16
testing requires testing data dcnl def test basic dcsp raw read crop raw fname 0 0 1 0 dcnl dcsp raw err read crop raw fname apply proj dcnl dcsp raw erm read crop erm fname dcnl dcsp assert raises runtimeerror maxwell filter raw err dcnl dcsp assert raises typeerror maxwell filter 1 0 dcnl dcsp assert raises valueerror maxwell filter raw int order 20 dcnl dcsp n int bases int order 2 + 2 int order dcnl dcsp n ext bases ext order 2 + 2 ext order dcnl dcsp nbases n int bases + n ext bases dcnl dcsp assert equal get n moments int order ext order sum nbases dcnl dcsp assert equal len raw info projs 12 dcnl dcsp raw sss maxwell filter raw origin mf head origin regularize none bad condition ignore dcnl dcsp assert equal len raw sss info projs 1 dcnl dcsp assert equal raw sss info projs 0 desc average dcsp eeg dcsp reference dcnl dcsp assert meg snr raw sss read crop sss std fname 200 0 1000 0 dcnl dcsp py cal raw sss info proc history 0 max info sss cal dcnl dcsp assert equal len py cal 0 dcnl dcsp py ctc raw sss info proc history 0 max info sss ctc dcnl dcsp assert equal len py ctc 0 dcnl dcsp py st raw sss info proc history 0 max info max st dcnl dcsp assert equal len py st 0 dcnl dcsp assert raises runtimeerror maxwell filter raw sss dcnl dcsp raw sss maxwell filter raw origin 0 0 0 02 0 02 regularize none bad condition ignore dcnl dcsp assert meg snr raw sss read crop sss nonstd fname 250 0 700 0 dcnl dcsp sss erm std read crop sss erm std fname dcnl dcsp raw sss maxwell filter raw erm coord frame meg origin mf meg origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss sss erm std 100 0 900 0 dcnl dcsp for key in job frame dcnl dcsp dcsp vals x info proc history 0 max info sss info key for x in raw sss sss erm std dcnl dcsp dcsp assert equal vals0 vals1 dcnl dcsp sss info raw sss info proc history 0 max info dcnl dcsp assert equal get n moments int order proc history get sss rank sss info dcnl dcsp assert raises valueerror maxwell filter raw coord frame foo dcnl dcsp assert raises valueerror maxwell filter raw origin foo dcnl dcsp assert raises valueerror maxwell filter raw origin 0 4 dcnl dcsp assert raises valueerror maxwell filter raw mag scale foo dcnl dcsp raw missing raw copy load data dcnl dcsp raw missing info bads meg0111 dcnl dcsp raw missing pick types meg true dcnl dcsp maxwell filter raw missing dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp maxwell filter raw missing calibration fine cal fname dcnl dcsp assert equal len w 1 dcnl dcsp assert true not dcsp in dcsp data in str w0 message
testing requires testing data dcnl def test maxwell filter additional dcsp data path op join testing data path download false dcnl dcsp file name test move anon dcnl dcsp raw fname op join data path sss file name + raw fif dcnl dcsp raw read crop raw fname 0 0 2 0 dcnl dcsp raw load data dcnl dcsp raw pick types meg true eeg false dcnl dcsp int order 8 dcnl dcsp raw sss maxwell filter raw origin mf head origin regularize none bad condition ignore dcnl dcsp tempdir tempdir dcnl dcsp test outname op join tempdir test raw sss fif dcnl dcsp raw sss save test outname dcnl dcsp raw sss loaded read crop test outname load data dcnl dcsp assert allclose raw sss loaded 0 raw sss 0 rtol 1e06 atol 1e20 dcnl dcsp cov raw compute raw covariance raw dcnl dcsp cov sss compute raw covariance raw sss dcnl dcsp scalings none dcnl dcsp cov raw rank estimate rank meeg cov cov raw data raw info scalings dcnl dcsp cov sss rank estimate rank meeg cov cov sss data raw sss info scalings dcnl dcsp assert equal cov raw rank raw info nchan dcnl dcsp assert equal cov sss rank get n moments int order
slow test dcnl testing requires testing data dcnl def test bads reconstruction dcsp raw read crop raw fname 0 0 1 0 dcnl dcsp raw info bads bads dcnl dcsp raw sss maxwell filter raw origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss read crop sss bad recon fname 300 0
buggy mkl svd dcnl requires svd convergence dcnl testing requires testing data dcnl def test spatiotemporal dcsp raw read crop raw fname dcnl dcsp assert raises valueerror maxwell filter raw st duration 1000 0 dcnl dcsp st durations 4 0 dcnl dcsp tols 325 0 dcnl dcsp kwargs dict origin mf head origin regularize none bad condition ignore dcnl dcsp for st duration tol in zip st durations tols dcnl dcsp dcsp tsss fname op join sss path test move anon st 0ds raw sss fif st duration dcnl dcsp dcsp tsss bench read crop tsss fname dcnl dcsp dcsp raw tsss maxwell filter raw st duration st duration kwargs dcnl dcsp dcsp assert equal raw tsss estimate rank 140 dcnl dcsp dcsp assert meg snr raw tsss tsss bench tol dcnl dcsp dcsp py st raw tsss info proc history 0 max info max st dcnl dcsp dcsp assert true len py st 0 dcnl dcsp dcsp assert equal py st buflen st duration dcnl dcsp dcsp assert equal py st subspcorr 0 98 dcnl dcsp assert raises valueerror maxwell filter raw st duration 10 0 st correlation 0 0
slow test dcnl requires svd convergence dcnl testing requires testing data dcnl def test spatiotemporal only dcsp tmax 0 5 dcnl dcsp raw read crop raw fname 0 tmax load data dcnl dcsp picks pick types raw info meg true exclude bads 2 dcnl dcsp raw pick channels raw ch namespick for pick in picks dcnl dcsp mag picks pick types raw info meg mag exclude dcnl dcsp power np sqrt np sum rawmag picks0 2 dcnl dcsp raw tsss maxwell filter raw st duration tmax 2 0 st only true dcnl dcsp assert equal len raw info projs len raw tsss info projs dcnl dcsp assert equal raw tsss estimate rank len picks dcnl dcsp assert shielding raw tsss power 9 dcnl dcsp head pos read head pos pos fname dcnl dcsp raw tsss maxwell filter raw st duration tmax 2 0 st only true head pos head pos dcnl dcsp assert equal raw tsss estimate rank len picks dcnl dcsp assert shielding raw tsss power 9 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw tsss maxwell filter raw st duration tmax 2 0 st only true head pos head pos st fixed false dcnl dcsp assert equal raw tsss estimate rank len picks dcnl dcsp assert shielding raw tsss power 9 dcnl dcsp raw tsss maxwell filter raw st duration tmax st correlation 1 0 st only true dcnl dcsp assert allclose raw 0 raw tsss 0 dcnl dcsp assert raises valueerror maxwell filter raw st only true dcnl dcsp raw tsss maxwell filter raw st duration tmax st only true dcnl dcsp raw tsss maxwell filter raw tsss dcnl dcsp raw tsss 2 maxwell filter raw st duration tmax dcnl dcsp assert meg snr raw tsss raw tsss 2 100000 0 dcnl dcsp assert equal len raw info bads 0 dcnl dcsp bads raw ch names0 dcnl dcsp raw info bads list bads dcnl dcsp raw tsss maxwell filter raw st duration tmax st only true head pos head pos dcnl dcsp assert equal raw info bads bads dcnl dcsp assert equal raw tsss info bads bads dcnl dcsp raw tsss maxwell filter raw tsss head pos head pos dcnl dcsp assert equal raw tsss info bads dcnl dcsp raw tsss 2 maxwell filter raw st duration tmax head pos head pos dcnl dcsp assert equal raw tsss 2 info bads dcnl dcsp assert meg snr raw tsss raw tsss 2 100000 0
testing requires testing data dcnl def test fine calibration dcsp raw read crop raw fname 0 0 1 0 dcnl dcsp sss fine cal read crop sss fine cal fname dcnl dcsp raw sss maxwell filter raw calibration fine cal fname origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss sss fine cal 82 611 dcnl dcsp py cal raw sss info proc history 0 max info sss cal dcnl dcsp assert true py cal is not none dcnl dcsp assert true len py cal 0 dcnl dcsp mf cal sss fine cal info proc history 0 max info sss cal dcnl dcsp mf cal cal chans mf cal cal chans 1 3022 1 3024 dcnl dcsp assert allclose py cal cal chans mf cal cal chans dcnl dcsp assert allclose py cal cal corrs mf cal cal corrs rtol 0 001 atol 0 001 dcnl dcsp raw missing raw copy load data dcnl dcsp raw missing info bads meg0111 meg0943 dcnl dcsp raw missing info check consistency dcnl dcsp raw sss bad maxwell filter raw missing calibration fine cal fname origin mf head origin regularize none bad condition ignore dcnl dcsp raw missing pick types dcnl dcsp raw sss bad pick channels raw missing ch names dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw sss missing maxwell filter raw missing calibration fine cal fname origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss missing raw sss bad 1000 0 10000 0 dcnl dcsp raw sss 3d maxwell filter raw calibration fine cal fname 3d origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss 3d sss fine cal 1 0 6 0 dcnl dcsp raw ctf read crop fname ctf raw apply gradient compensation 0 dcnl dcsp assert raises runtimeerror maxwell filter raw ctf origin 0 0 0 0 0 04 calibration fine cal fname
slow test dcnl testing requires testing data dcnl def test regularization dcsp min tols 100 0 2 6 1 0 dcnl dcsp med tols 1000 0 21 4 3 7 dcnl dcsp origins 0 0 0 0 0 04 0 0 3 0 0 0 02 0 02 dcnl dcsp coord frames head meg head dcnl dcsp raw fnames raw fname erm fname sample fname dcnl dcsp sss fnames sss reg in fname sss erm reg in fname sss samp reg in fname dcnl dcsp comp tols 0 1 4 dcnl dcsp for ii rf in enumerate raw fnames dcnl dcsp dcsp raw read crop rf 0 0 1 0 dcnl dcsp dcsp sss reg in read crop sss fnamesii dcnl dcsp dcsp raw sss maxwell filter raw coord frame coord framesii origin originsii dcnl dcsp dcsp assert meg snr raw sss sss reg in min tolsii med tolsii msg rf dcnl dcsp dcsp check reg match raw sss sss reg in comp tolsii
def check reg match sss py sss mf comp tol dcsp info py sss py info proc history 0 max info sss info dcnl dcsp assert true info py is not none dcnl dcsp assert true len info py 0 dcnl dcsp info mf sss mf info proc history 0 max info sss info dcnl dcsp n in none dcnl dcsp for inf in info py info mf dcnl dcsp dcsp if n in is none dcnl dcsp dcsp dcsp n in get n moments inf in order dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert equal n in get n moments inf in order dcnl dcsp dcsp assert equal inf components n in sum inf nfree dcnl dcsp assert allclose info py nfree info mf nfree atol comp tol err msg sss py filenames0
testing requires testing data dcnl def test cross talk dcsp raw read crop raw fname 0 0 1 0 dcnl dcsp raw info bads bads dcnl dcsp sss ctc read crop sss ctc fname dcnl dcsp raw sss maxwell filter raw cross talk ctc fname origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss sss ctc 275 0 dcnl dcsp py ctc raw sss info proc history 0 max info sss ctc dcnl dcsp assert true len py ctc 0 dcnl dcsp assert raises valueerror maxwell filter raw cross talk raw dcnl dcsp assert raises valueerror maxwell filter raw cross talk raw fname dcnl dcsp mf ctc sss ctc info proc history 0 max info sss ctc dcnl dcsp del mf ctc block id dcnl dcsp assert equal object diff py ctc mf ctc dcnl dcsp raw ctf read crop fname ctf raw apply gradient compensation 0 dcnl dcsp assert raises valueerror maxwell filter raw ctf dcnl dcsp raw sss maxwell filter raw ctf origin 0 0 0 0 0 04 dcnl dcsp assert n free raw sss 68 dcnl dcsp raw sss maxwell filter raw ctf origin 0 0 0 0 0 04 ignore ref true dcnl dcsp assert n free raw sss 70 dcnl dcsp raw missing raw copy crop 0 0 1 load data pick channels raw ch namespi for pi in pick types raw info meg true exclude 3 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp maxwell filter raw missing cross talk ctc fname dcnl dcsp assert equal len w 1 dcnl dcsp assert true not dcsp all dcsp crosstalk dcsp channels dcsp in dcsp raw in str w0 message dcnl dcsp assert raises runtimeerror maxwell filter raw ctf origin 0 0 0 0 0 04 cross talk ctc fname
testing requires testing data dcnl def test head translation dcsp raw read crop raw fname 0 0 1 0 dcnl dcsp raw sss maxwell filter raw destination raw fname origin mf head origin regularize none bad condition ignore dcnl dcsp assert meg snr raw sss read crop sss std fname 0 0 1 0 200 0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log dcnl dcsp dcsp dcsp raw sss maxwell filter raw destination mf head origin origin mf head origin regularize none bad condition ignore verbose warning dcnl dcsp assert true over dcsp 25 dcsp mm in log getvalue dcnl dcsp assert meg snr raw sss read crop sss trans default fname 125 0 dcnl dcsp destination np eye 4 dcnl dcsp destination 2 3 0 04 dcnl dcsp assert allclose raw sss info dev head t trans destination dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp with catch logging as log dcnl dcsp dcsp dcsp raw sss maxwell filter raw destination sample fname origin mf head origin regularize none bad condition ignore verbose warning dcnl dcsp assert true dcsp 25 6 dcsp mm in log getvalue dcnl dcsp assert meg snr raw sss read crop sss trans sample fname 350 0 dcnl dcsp assert allclose raw sss info dev head t trans read info sample fname dev head t trans dcnl dcsp assert raises runtimeerror maxwell filter raw destination mf head origin coord frame meg dcnl dcsp assert raises valueerror maxwell filter raw destination 0 0 4
def assert shielding raw sss erm power shielding factor meg mag dcsp picks pick types raw sss info meg meg ref meg false dcnl dcsp if isinstance erm power baseraw dcnl dcsp dcsp picks erm pick types raw sss info meg meg ref meg false dcnl dcsp dcsp assert allclose picks picks erm dcnl dcsp dcsp erm power np sqrt erm powerpicks erm0 2 sum dcnl dcsp sss power raw ssspicks0 ravel dcnl dcsp sss power np sqrt np sum sss power sss power dcnl dcsp factor erm power sss power dcnl dcsp assert true factor shielding factor shielding dcsp factor dcsp 0 3f dcsp < dcsp 0 3f factor shielding factor
buggy mkl svd dcnl slow test dcnl requires svd convergence dcnl testing requires testing data dcnl def test shielding factor dcsp raw erm read crop erm fname load data pick types meg true dcnl dcsp erm power raw ermpick types raw erm info meg mag 0 dcnl dcsp erm power np sqrt np sum erm power erm power dcnl dcsp erm power grad raw ermpick types raw erm info meg grad 0 dcnl dcsp erm power grad np sqrt np sum erm power erm power dcnl dcsp assert shielding read crop sss erm std fname erm power 10 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none dcnl dcsp assert shielding raw sss erm power 12 dcnl dcsp assert shielding raw sss erm power grad 0 45 grad dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none mag scale auto dcnl dcsp assert shielding raw sss erm power 12 dcnl dcsp assert shielding raw sss erm power grad 0 48 grad dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none mag scale 1 0 dcnl dcsp assert shielding raw sss erm power 7 3 dcnl dcsp assert shielding raw sss erm power grad 0 2 grad dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none mag scale 1000 0 bad condition ignore dcnl dcsp assert shielding raw sss erm power 4 0 dcnl dcsp assert shielding raw sss erm power grad 0 1 grad dcnl dcsp assert shielding read crop sss erm fine cal fname erm power 12 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none origin mf meg origin calibration fine cal fname dcnl dcsp assert shielding raw sss erm power 12 dcnl dcsp assert shielding read crop sss erm ctc fname erm power 12 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none origin mf meg origin cross talk ctc fname dcnl dcsp assert shielding raw sss erm power 12 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none calibration fine cal fname origin mf meg origin cross talk ctc fname dcnl dcsp assert shielding raw sss erm power 13 dcnl dcsp assert shielding read crop sss erm st fname erm power 37 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none origin mf meg origin st duration 1 0 dcnl dcsp assert shielding raw sss erm power 37 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none cross talk ctc fname origin mf meg origin st duration 1 0 dcnl dcsp assert shielding raw sss erm power 38 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none calibration fine cal fname origin mf meg origin st duration 1 0 dcnl dcsp assert shielding raw sss erm power 38 dcnl dcsp assert shielding read crop sss erm st1finecalcrosstalk fname erm power 39 dcnl dcsp raw sss maxwell filter raw erm coord frame meg regularize none calibration fine cal fname origin mf meg origin cross talk ctc fname st duration 1 0 dcnl dcsp assert shielding raw sss erm power 39 dcnl dcsp assert shielding read crop sss erm st1finecalcrosstalkregin fname erm power 57 dcnl dcsp raw sss maxwell filter raw erm calibration fine cal fname cross talk ctc fname st duration 1 0 origin mf meg origin coord frame meg regularize in dcnl dcsp assert shielding raw sss erm power 53 dcnl dcsp raw sss maxwell filter raw erm calibration fine cal fname cross talk ctc fname st duration 1 0 coord frame meg regularize in dcnl dcsp assert shielding raw sss erm power 58 dcnl dcsp assert shielding raw sss erm power grad 1 6 grad dcnl dcsp raw sss maxwell filter raw erm calibration fine cal fname cross talk ctc fname st duration 1 0 coord frame meg regularize in mag scale auto dcnl dcsp assert shielding raw sss erm power 51 dcnl dcsp assert shielding raw sss erm power grad 1 5 grad dcnl dcsp raw sss maxwell filter raw erm calibration fine cal fname 3d cross talk ctc fname st duration 1 0 coord frame meg regularize in dcnl dcsp assert shielding raw sss erm power 54 dcnl dcsp temp dir tempdir dcnl dcsp temp fname op join temp dir test cal dat dcnl dcsp with open fine cal fname 3d r as fid dcnl dcsp dcsp with open temp fname w as fid out dcnl dcsp dcsp dcsp for line in fid dcnl dcsp dcsp dcsp dcsp fid out write dcsp join line strip split dcsp 14 + n dcnl dcsp raw sss maxwell filter raw erm calibration temp fname cross talk ctc fname st duration 1 0 coord frame meg regularize in dcnl dcsp assert shielding raw sss erm power 44
slow test dcnl requires svd convergence dcnl testing requires testing data dcnl def test all dcsp raw fnames raw fname raw fname erm fname sample fname dcnl dcsp sss fnames sss st1finecalcrosstalkregin fname sss st1finecalcrosstalkregintranssample fname sss erm st1finecalcrosstalkregin fname sss samp fname dcnl dcsp fine cals fine cal fname fine cal fname fine cal fname fine cal mgh fname dcnl dcsp coord frames head head meg head dcnl dcsp ctcs ctc fname ctc fname ctc fname ctc mgh fname dcnl dcsp mins 3 5 3 5 1 2 0 9 dcnl dcsp meds 10 8 10 4 3 2 6 0 dcnl dcsp st durs 1 0 1 0 1 0 none dcnl dcsp destinations none sample fname none none dcnl dcsp origins mf head origin mf head origin mf meg origin mf head origin dcnl dcsp for ii rf in enumerate raw fnames dcnl dcsp dcsp raw read crop rf 0 0 1 0 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp sss py maxwell filter raw calibration fine calsii cross talk ctcsii st duration st dursii coord frame coord framesii destination destinationsii origin originsii dcnl dcsp dcsp sss mf read crop sss fnamesii dcnl dcsp dcsp assert meg snr sss py sss mf minsii medsii msg rf
slow test dcnl requires svd convergence dcnl testing requires testing data dcnl def test triux dcsp raw read crop tri fname 0 0 999 dcnl dcsp raw fix mag coil types dcnl dcsp sss py maxwell filter raw coord frame meg regularize none dcnl dcsp assert meg snr sss py read crop tri sss fname 37 700 dcnl dcsp sss py maxwell filter raw coord frame meg regularize none cross talk tri ctc fname dcnl dcsp assert meg snr sss py read crop tri sss ctc fname 35 700 dcnl dcsp sss py maxwell filter raw coord frame meg regularize none calibration tri cal fname dcnl dcsp assert meg snr sss py read crop tri sss cal fname 31 360 dcnl dcsp sss py maxwell filter raw coord frame meg regularize none calibration tri cal fname cross talk tri ctc fname dcnl dcsp assert meg snr sss py read crop tri sss ctc cal fname 31 350 dcnl dcsp sss py maxwell filter raw coord frame meg regularize in dcnl dcsp sss mf read crop tri sss reg fname dcnl dcsp assert meg snr sss py sss mf 0 6 9 dcnl dcsp check reg match sss py sss mf 1 dcnl dcsp sss py maxwell filter raw coord frame meg regularize in calibration tri cal fname cross talk tri ctc fname dcnl dcsp sss mf read crop tri sss ctc cal reg in fname dcnl dcsp assert meg snr sss py sss mf 0 6 9 dcnl dcsp check reg match sss py sss mf 1 dcnl dcsp raw read crop tri fname fix mag coil types dcnl dcsp sss py maxwell filter raw coord frame meg regularize none st duration 4 0 verbose true dcnl dcsp assert meg snr sss py read crop tri sss st4 fname 700 0 1600
def safe del key dict key dcsp if key in dict dcnl dcsp dcsp del dict key
verbose dcnl def compute exg proj mode raw raw event tmin tmax n grad n mag n eeg l freq h freq average filter length n jobs ch name reject flat bads avg ref no proj event id exg l freq exg h freq tstart qrs threshold filter method iir params none verbose none dcsp if not raw preload dcnl dcsp dcsp raise valueerror raw dcsp needs dcsp to dcsp be dcsp preloaded dcsp use dcsp preload true dcsp in dcsp constructor dcnl dcsp if no proj dcnl dcsp dcsp projs dcnl dcsp else dcnl dcsp dcsp projs cp deepcopy raw info projs dcnl dcsp dcsp logger info including dcsp d dcsp ssp dcsp projectors dcsp from dcsp raw dcsp file len projs dcnl dcsp if avg ref dcnl dcsp dcsp eeg proj make eeg average ref proj raw info dcnl dcsp dcsp projs append eeg proj dcnl dcsp if raw event is none dcnl dcsp dcsp raw event raw dcnl dcsp if mode ecg dcnl dcsp dcsp logger info running dcsp ecg dcsp ssp dcsp computation dcnl dcsp dcsp events find ecg events raw event ch name ch name event id event id l freq exg l freq h freq exg h freq tstart tstart qrs threshold qrs threshold filter length filter length dcnl dcsp elif mode eog dcnl dcsp dcsp logger info running dcsp eog dcsp ssp dcsp computation dcnl dcsp dcsp events find eog events raw event event id event id l freq exg l freq h freq exg h freq filter length filter length ch name ch name tstart tstart dcnl dcsp else dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp ecg dcsp or dcsp eog dcnl dcsp if events shape0 < 1 dcnl dcsp dcsp warn no dcsp s dcsp events dcsp found dcsp returning dcsp none dcsp for dcsp projs mode dcnl dcsp dcsp return none events dcnl dcsp logger info computing dcsp projector dcnl dcsp my info cp deepcopy raw info dcnl dcsp my info bads + bads dcnl dcsp if reject is not none dcnl dcsp dcsp if len pick types my info meg grad eeg false eog false ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key reject grad dcnl dcsp dcsp if len pick types my info meg mag eeg false eog false ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key reject mag dcnl dcsp dcsp if len pick types my info meg false eeg true eog false ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key reject eeg dcnl dcsp dcsp if len pick types my info meg false eeg false eog true ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key reject eog dcnl dcsp if flat is not none dcnl dcsp dcsp if len pick types my info meg grad eeg false eog false ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key flat grad dcnl dcsp dcsp if len pick types my info meg mag eeg false eog false ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key flat mag dcnl dcsp dcsp if len pick types my info meg false eeg true eog false ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key flat eeg dcnl dcsp dcsp if len pick types my info meg false eeg false eog true ref meg false exclude bads 0 dcnl dcsp dcsp dcsp safe del key flat eog dcnl dcsp picks pick types my info meg true eeg true eog true ref meg false exclude bads dcnl dcsp raw filter l freq h freq picks picks filter length filter length n jobs n jobs method filter method iir params iir params l trans bandwidth 0 5 h trans bandwidth 0 5 phase zerodouble fir design firwin2 dcnl dcsp epochs epochs raw events none tmin tmax baseline none preload true picks picks reject reject flat flat proj true dcnl dcsp epochs drop bad dcnl dcsp if epochs events shape0 < 1 dcnl dcsp dcsp warn no dcsp good dcsp epochs dcsp found dcsp returning dcsp none dcsp for dcsp projs dcnl dcsp dcsp return none events dcnl dcsp if average dcnl dcsp dcsp evoked epochs average dcnl dcsp dcsp ev projs compute proj evoked evoked n grad n grad n mag n mag n eeg n eeg dcnl dcsp else dcnl dcsp dcsp ev projs compute proj epochs epochs n grad n grad n mag n mag n eeg n eeg n jobs n jobs dcnl dcsp for p in ev projs dcnl dcsp dcsp p desc mode + + p desc dcnl dcsp projs extend ev projs dcnl dcsp logger info done dcnl dcsp return projs events
verbose dcnl def compute proj ecg raw raw event none tmin 0 2 tmax 0 4 n grad 2 n mag 2 n eeg 2 l freq 1 0 h freq 35 0 average false filter length 10s n jobs 1 ch name none reject dict grad 2e10 mag 3e12 eeg 5e05 eog 0 00025 flat none bads avg ref false no proj false event id 999 ecg l freq 5 ecg h freq 35 tstart 0 0 qrs threshold auto filter method fft iir params none copy true verbose none dcsp if copy is true dcnl dcsp dcsp raw raw copy dcnl dcsp projs ecg events compute exg proj ecg raw raw event tmin tmax n grad n mag n eeg l freq h freq average filter length n jobs ch name reject flat bads avg ref no proj event id ecg l freq ecg h freq tstart qrs threshold filter method iir params dcnl dcsp return projs ecg events
verbose dcnl def compute proj eog raw raw event none tmin 0 2 tmax 0 2 n grad 2 n mag 2 n eeg 2 l freq 1 0 h freq 35 0 average false filter length 10s n jobs 1 reject dict grad 2e10 mag 3e12 eeg 0 0005 eog np inf flat none bads avg ref false no proj false event id 998 eog l freq 1 eog h freq 10 tstart 0 0 filter method fft iir params none ch name none copy true verbose none dcsp if copy is true dcnl dcsp dcsp raw raw copy dcnl dcsp projs eog events compute exg proj eog raw raw event tmin tmax n grad n mag n eeg l freq h freq average filter length n jobs ch name reject flat bads avg ref no proj event id eog l freq eog h freq tstart qrs threshold auto filter method filter method iir params iir params dcnl dcsp return projs eog events
def construct signal from epochs epochs events sfreq tmin dcsp n epochs n channels n times epochs shape dcnl dcsp tmax tmin + n times float sfreq dcnl dcsp start np min events 0 + int tmin sfreq dcnl dcsp stop np max events 0 + int tmax sfreq + 1 dcnl dcsp n samples stop start dcnl dcsp n epochs n channels n times epochs shape dcnl dcsp events pos events 0 events 0 0 dcnl dcsp raw np zeros n channels n samples dcnl dcsp for idx in range n epochs dcnl dcsp dcsp onset events posidx dcnl dcsp dcsp offset onset + n times dcnl dcsp dcsp raw onset offset epochsidx dcnl dcsp return raw
def least square evoked epochs data events tmin sfreq dcsp n epochs n channels n times epochs data shape dcnl dcsp tmax tmin + n times float sfreq dcnl dcsp events events copy dcnl dcsp events 0 events 0 0 + int tmin sfreq dcnl dcsp raw construct signal from epochs epochs data events sfreq tmin dcnl dcsp n min n max int tmin sfreq int tmax sfreq dcnl dcsp window n max n min dcnl dcsp n samples raw shape1 dcnl dcsp toeplitz list dcnl dcsp classes np unique events 2 dcnl dcsp for ii this class in enumerate classes dcnl dcsp dcsp sel events 2 this class dcnl dcsp dcsp trig np zeros n samples 1 dcnl dcsp dcsp ix trig events sel 0 + n min dcnl dcsp dcsp trigix trig 1 dcnl dcsp dcsp toeplitz append linalg toeplitz trig0 window trig dcnl dcsp toeplitz np array toeplitz dcnl dcsp x np concatenate toeplitz dcnl dcsp predictor np dot linalg pinv np dot x x t x dcnl dcsp evokeds np dot predictor raw t dcnl dcsp evokeds np transpose np vsplit evokeds len classes 0 2 1 dcnl dcsp return evokeds toeplitz
def fit xdawn epochs data y n components reg none signal cov none events none tmin 0 0 sfreq 1 0 dcsp n epochs n channels n times epochs data shape dcnl dcsp classes np unique y dcnl dcsp if signal cov is none dcnl dcsp dcsp signal cov regularized covariance np hstack epochs data reg dcnl dcsp elif isinstance signal cov covariance dcnl dcsp dcsp signal cov signal cov data dcnl dcsp if not isinstance signal cov np ndarray or not np array equal signal cov shape np tile epochs data shape1 2 dcnl dcsp dcsp raise valueerror signal cov dcsp must dcsp be dcsp none dcsp a dcsp covariance dcsp instance dcsp or dcsp an dcsp array dcsp of dcsp shape dcsp n chans dcsp n chans dcnl dcsp if events is not none dcnl dcsp dcsp evokeds toeplitzs least square evoked epochs data events tmin sfreq dcnl dcsp else dcnl dcsp dcsp evokeds toeplitzs list list dcnl dcsp dcsp for c in classes dcnl dcsp dcsp dcsp evokeds append np mean epochs data y c axis 0 dcnl dcsp dcsp dcsp toeplitzs append 1 0 dcnl dcsp filters list dcnl dcsp patterns list dcnl dcsp for evo toeplitz in zip evokeds toeplitzs dcnl dcsp dcsp evo np dot evo toeplitz dcnl dcsp dcsp evo cov np matrix regularized covariance evo reg dcnl dcsp dcsp evals evecs linalg eigh evo cov signal cov dcnl dcsp dcsp evecs evecs np argsort evals 1 dcnl dcsp dcsp evecs np apply along axis np linalg norm 0 evecs dcnl dcsp dcsp patterns np linalg pinv evecs t dcnl dcsp dcsp filters append evecs n components t dcnl dcsp dcsp patterns append patterns n components t dcnl dcsp filters np concatenate filters axis 0 dcnl dcsp patterns np concatenate patterns axis 0 dcnl dcsp evokeds np array evokeds dcnl dcsp return filters patterns evokeds
verbose dcnl def infomax data weights none l rate none block none w change 1e12 anneal deg 60 0 anneal step 0 9 extended true n subgauss 1 kurt size 6000 ext blocks 1 max iter 200 random state none blowup 10000 0 blowup fac 0 5 n small angle 20 use bias true verbose none dcsp from scipy stats import kurtosis dcnl dcsp rng check random state random state dcnl dcsp max weight 100000000 0 dcnl dcsp restart fac 0 9 dcnl dcsp min l rate 1e10 dcnl dcsp degconst 180 0 np pi dcnl dcsp extmomentum 0 5 dcnl dcsp signsbias 0 02 dcnl dcsp signcount threshold 25 dcnl dcsp signcount step 2 dcnl dcsp n samples n features data shape dcnl dcsp n features square n features 2 dcnl dcsp if l rate is none dcnl dcsp dcsp l rate 0 01 math log n features 2 0 dcnl dcsp if block is none dcnl dcsp dcsp block int math floor math sqrt n samples 3 0 dcnl dcsp logger info computing sinfomax dcsp ica dcsp extended dcsp if extended else dcsp dcnl dcsp nblock n samples block dcnl dcsp lastt nblock 1 block + 1 dcnl dcsp if weights is none dcnl dcsp dcsp weights np identity n features dtype np float64 dcnl dcsp else dcnl dcsp dcsp weights weights t dcnl dcsp bi block np identity n features dtype np float64 dcnl dcsp bias np zeros n features 1 dtype np float64 dcnl dcsp onesrow np ones 1 block dtype np float64 dcnl dcsp startweights weights copy dcnl dcsp oldweights startweights copy dcnl dcsp step 0 dcnl dcsp count small angle 0 dcnl dcsp wts blowup false dcnl dcsp blockno 0 dcnl dcsp signcount 0 dcnl dcsp initial ext blocks ext blocks dcnl dcsp if extended dcnl dcsp dcsp signs np ones n features dcnl dcsp dcsp for k in range n subgauss dcnl dcsp dcsp dcsp signsk 1 dcnl dcsp dcsp kurt size min kurt size n samples dcnl dcsp dcsp old kurt np zeros n features dtype np float64 dcnl dcsp dcsp oldsigns np zeros n features dcnl dcsp olddelta oldchange 1 0 0 0 dcnl dcsp while step < max iter dcnl dcsp dcsp permute random permutation n samples rng dcnl dcsp dcsp for t in range 0 lastt block dcnl dcsp dcsp dcsp u np dot datapermutet t + block weights dcnl dcsp dcsp dcsp u + np dot bias onesrow t dcnl dcsp dcsp dcsp if extended dcnl dcsp dcsp dcsp dcsp y np tanh u dcnl dcsp dcsp dcsp dcsp weights + l rate np dot weights bi signsnone np dot u t y np dot u t u dcnl dcsp dcsp dcsp dcsp if use bias dcnl dcsp dcsp dcsp dcsp dcsp bias + l rate np reshape np sum y axis 0 dtype np float64 2 0 n features 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp y 1 0 1 0 + np exp u dcnl dcsp dcsp dcsp dcsp weights + l rate np dot weights bi + np dot u t 1 0 2 0 y dcnl dcsp dcsp dcsp dcsp if use bias dcnl dcsp dcsp dcsp dcsp dcsp bias + l rate np reshape np sum 1 0 2 0 y axis 0 dtype np float64 n features 1 dcnl dcsp dcsp dcsp max weight val np max np abs weights dcnl dcsp dcsp dcsp if max weight val max weight dcnl dcsp dcsp dcsp dcsp wts blowup true dcnl dcsp dcsp dcsp blockno + 1 dcnl dcsp dcsp dcsp if wts blowup dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp if extended dcnl dcsp dcsp dcsp dcsp if ext blocks 0 and blockno ext blocks 0 dcnl dcsp dcsp dcsp dcsp dcsp if kurt size < n samples dcnl dcsp dcsp dcsp dcsp dcsp dcsp rp np floor rng uniform 0 1 kurt size n samples 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp tpartact np dot datarp astype int weights t dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp tpartact np dot data weights t dcnl dcsp dcsp dcsp dcsp dcsp kurt kurtosis tpartact axis 1 fisher true dcnl dcsp dcsp dcsp dcsp dcsp if extmomentum 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp kurt extmomentum old kurt + 1 0 extmomentum kurt dcnl dcsp dcsp dcsp dcsp dcsp dcsp old kurt kurt dcnl dcsp dcsp dcsp dcsp dcsp signs np sign kurt + signsbias dcnl dcsp dcsp dcsp dcsp dcsp ndiff signs oldsigns 0 sum dcnl dcsp dcsp dcsp dcsp dcsp if ndiff 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp signcount + 1 dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp signcount 0 dcnl dcsp dcsp dcsp dcsp dcsp oldsigns signs dcnl dcsp dcsp dcsp dcsp dcsp if signcount signcount threshold dcnl dcsp dcsp dcsp dcsp dcsp dcsp ext blocks np fix ext blocks signcount step dcnl dcsp dcsp dcsp dcsp dcsp dcsp signcount 0 dcnl dcsp dcsp if not wts blowup dcnl dcsp dcsp dcsp oldwtchange weights oldweights dcnl dcsp dcsp dcsp step + 1 dcnl dcsp dcsp dcsp angledelta 0 0 dcnl dcsp dcsp dcsp delta oldwtchange reshape 1 n features square dcnl dcsp dcsp dcsp change np sum delta delta dtype np float64 dcnl dcsp dcsp dcsp if step 2 dcnl dcsp dcsp dcsp dcsp angledelta math acos np sum delta olddelta math sqrt change oldchange dcnl dcsp dcsp dcsp dcsp angledelta degconst dcnl dcsp dcsp dcsp if verbose dcnl dcsp dcsp dcsp dcsp logger info step dcsp d dcsp dcsp lrate dcsp 5f dcsp wchange dcsp 8 8f dcsp angledelta dcsp 4 1f dcsp deg step l rate change angledelta dcnl dcsp dcsp dcsp oldweights weights copy dcnl dcsp dcsp dcsp if angledelta anneal deg dcnl dcsp dcsp dcsp dcsp l rate anneal step dcnl dcsp dcsp dcsp dcsp olddelta delta dcnl dcsp dcsp dcsp dcsp oldchange change dcnl dcsp dcsp dcsp dcsp count small angle 0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp if step 1 dcnl dcsp dcsp dcsp dcsp dcsp olddelta delta dcnl dcsp dcsp dcsp dcsp dcsp oldchange change dcnl dcsp dcsp dcsp dcsp if n small angle is not none dcnl dcsp dcsp dcsp dcsp dcsp count small angle + 1 dcnl dcsp dcsp dcsp dcsp dcsp if count small angle n small angle dcnl dcsp dcsp dcsp dcsp dcsp dcsp max iter step dcnl dcsp dcsp dcsp if step 2 and change < w change dcnl dcsp dcsp dcsp dcsp step max iter dcnl dcsp dcsp dcsp elif change blowup dcnl dcsp dcsp dcsp dcsp l rate blowup fac dcnl dcsp dcsp else dcnl dcsp dcsp dcsp step 0 dcnl dcsp dcsp dcsp wts blowup 0 dcnl dcsp dcsp dcsp blockno 1 dcnl dcsp dcsp dcsp l rate restart fac dcnl dcsp dcsp dcsp weights startweights copy dcnl dcsp dcsp dcsp oldweights startweights copy dcnl dcsp dcsp dcsp olddelta np zeros 1 n features square dtype np float64 dcnl dcsp dcsp dcsp bias np zeros n features 1 dtype np float64 dcnl dcsp dcsp dcsp ext blocks initial ext blocks dcnl dcsp dcsp dcsp if extended dcnl dcsp dcsp dcsp dcsp signs np ones n features dcnl dcsp dcsp dcsp dcsp for k in range n subgauss dcnl dcsp dcsp dcsp dcsp dcsp signsk 1 dcnl dcsp dcsp dcsp dcsp oldsigns np zeros n features dcnl dcsp dcsp dcsp if l rate min l rate dcnl dcsp dcsp dcsp dcsp if verbose dcnl dcsp dcsp dcsp dcsp dcsp logger info dcsp lowering dcsp learning dcsp rate dcsp to dcsp g n dcsp restarting l rate dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise valueerror error dcsp in dcsp infomax dcsp ica dcsp unmixing matrix dcsp matrixmight dcsp not dcsp be dcsp invertible dcnl dcsp return weights t
verbose dcnl def find eog events raw event id 998 l freq 1 h freq 10 filter length 10s ch name none tstart 0 reject by annotation false verbose none dcsp eog inds get eog channel index ch name raw dcnl dcsp logger info eog dcsp channel dcsp index dcsp for dcsp this dcsp subject dcsp is dcsp s eog inds dcnl dcsp reject by annotation omit if reject by annotation else none dcnl dcsp eog times raw get data picks eog inds reject by annotation reject by annotation return times true dcnl dcsp times times raw info sfreq + raw first samp dcnl dcsp eog events find eog events eog event id event id l freq l freq h freq h freq sampling rate raw info sfreq first samp raw first samp filter length filter length tstart tstart dcnl dcsp eog events 0 np round times eog events 0 raw first samp astype int dcnl dcsp return eog events
def find eog events eog event id l freq h freq sampling rate first samp filter length 10s tstart 0 0 dcsp logger info filtering dcsp the dcsp data dcsp to dcsp remove dcsp dc dcsp offset dcsp to dcsp help dcsp distinguish dcsp blinks dcsp from dcsp saccades dcnl dcsp fmax np minimum 45 sampling rate 2 0 0 75 dcnl dcsp filteog np array filter data x sampling rate 2 fmax none filter length 0 5 0 5 phase zerodouble fir window hann fir design firwin2 for x in eog dcnl dcsp temp np sqrt np sum filteog 2 axis 1 dcnl dcsp indexmax np argmax temp dcnl dcsp filteog filter data eogindexmax sampling rate l freq h freq none filter length 0 5 0 5 phase zerodouble fir window hann fir design firwin2 dcnl dcsp logger info now dcsp detecting dcsp blinks dcsp and dcsp generating dcsp corresponding dcsp events dcnl dcsp temp filteog np mean filteog dcnl dcsp n samples start int sampling rate tstart dcnl dcsp if np abs np max temp np abs np min temp dcnl dcsp dcsp eog events peak finder filteogn samples start extrema 1 dcnl dcsp else dcnl dcsp dcsp eog events peak finder filteogn samples start extrema 1 dcnl dcsp eog events + n samples start dcnl dcsp n events len eog events dcnl dcsp logger info number dcsp of dcsp eog dcsp events dcsp detected dcsp dcsp d n events dcnl dcsp eog events np array eog events + first samp np zeros n events int event id np ones n events int t dcnl dcsp return eog events
def get eog channel index ch name inst dcsp if isinstance ch name string types dcnl dcsp dcsp if in ch name dcnl dcsp dcsp dcsp ch name ch name split dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ch name ch name dcnl dcsp dcsp eog inds pick channels inst ch names include ch name dcnl dcsp dcsp if len eog inds 0 dcnl dcsp dcsp dcsp raise valueerror s dcsp not dcsp in dcsp channel dcsp list ch name dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info using dcsp channel dcsp s dcsp as dcsp eog dcsp channel s dcsp and dcsp join ch name pl eog inds dcnl dcsp elif ch name is none dcnl dcsp dcsp eog inds pick types inst info meg false eeg false stim false eog true ecg false emg false ref meg false exclude bads dcnl dcsp dcsp if len eog inds 0 dcnl dcsp dcsp dcsp logger info no dcsp eog dcsp channels dcsp found dcnl dcsp dcsp dcsp logger info trying dcsp with dcsp eeg dcsp 061 dcsp and dcsp eeg dcsp 062 dcnl dcsp dcsp dcsp eog inds pick channels inst ch names include eeg dcsp 061 eeg dcsp 062 dcnl dcsp dcsp dcsp if len eog inds 2 dcnl dcsp dcsp dcsp dcsp raise runtimeerror eeg dcsp 61 dcsp or dcsp eeg dcsp 62 dcsp channel dcsp not dcsp found dcsp dcnl dcsp else dcnl dcsp dcsp raise valueerror could dcsp not dcsp find dcsp eog dcsp channel dcnl dcsp return eog inds
verbose dcnl def create eog epochs raw ch name none event id 998 picks none tmin 0 5 tmax 0 5 l freq 1 h freq 10 reject none flat none baseline none preload true reject by annotation true verbose none dcsp events find eog events raw ch name ch name event id event id l freq l freq h freq h freq reject by annotation reject by annotation dcnl dcsp eog epochs epochs raw events events event id event id tmin tmin tmax tmax proj false reject reject flat flat picks picks baseline baseline preload preload reject by annotation reject by annotation dcnl dcsp return eog epochs
def compute normalized phase data dcsp from scipy signal import hilbert dcnl dcsp return np angle hilbert data + np pi 2 np pi
def ctps data is raw true dcsp if not data ndim 3 dcnl dcsp dcsp valueerror data dcsp must dcsp have dcsp 3 dcsp dimensions dcsp not dcsp i data ndim dcnl dcsp if is raw dcnl dcsp dcsp phase angles compute normalized phase data dcnl dcsp else dcnl dcsp dcsp phase angles data dcnl dcsp ks dynamics np zeros like phase angles0 dcnl dcsp pk dynamics np zeros like phase angles0 dcnl dcsp for ii source in enumerate np transpose phase angles 1 0 2 dcnl dcsp dcsp ks pk kuiper source dcnl dcsp dcsp pk dynamicsii pk dcnl dcsp dcsp ks dynamicsii ks dcnl dcsp return ks dynamics pk dynamics phase angles if is raw else none
def kuiper data dtype np float64 dcsp data np sort data axis 0 astype dtype dcnl dcsp shape data shape dcnl dcsp n dim len shape dcnl dcsp n trials shape0 dcnl dcsp j1 np arange n trials dtype dtype + 1 0 float n trials dcnl dcsp j2 np arange n trials dtype dtype float n trials dcnl dcsp if n dim 1 dcnl dcsp dcsp j1 j1 np newaxis dcnl dcsp dcsp j2 j2 np newaxis dcnl dcsp d1 j1 data max axis 0 dcnl dcsp d2 data j2 max axis 0 dcnl dcsp n eff n trials dcnl dcsp d d1 + d2 dcnl dcsp return d prob kuiper d n eff dtype dtype
def prob kuiper d n eff dtype f8 dcsp n time slices np size d dcnl dcsp n points 100 dcnl dcsp en math sqrt n eff dcnl dcsp k lambda en + 0 155 + 0 24 en d dcnl dcsp l2 k lambda 2 0 dcnl dcsp j2 np arange n points + 1 2 dcnl dcsp j2 j2 repeat n time slices reshape n points n time slices dcnl dcsp fact 4 0 j2 l2 1 0 dcnl dcsp expo np exp 2 0 j2 l2 dcnl dcsp term 2 0 fact expo dcnl dcsp pk term sum axis 0 dtype dtype dcnl dcsp pk norm np zeros n time slices dcnl dcsp pk norm pk 0 np log pk pk 0 2 0 n eff dcnl dcsp pk norm pk < 0 1 dcnl dcsp pk norm np where k lambda < 0 4 0 0 pk norm dcnl dcsp pk norm np where pk norm 1 0 1 0 pk norm dcnl dcsp return pk norm
def make xy sfunc func ndim output false dcsp if ndim output dcnl dcsp dcsp def sfunc x y dcnl dcsp dcsp dcsp return np array func a y ravel for a in x 0 dcnl dcsp else dcnl dcsp dcsp def sfunc x y dcnl dcsp dcsp dcsp return np array func a y ravel for a in x dcnl dcsp sfunc name join score func func module func name dcnl dcsp sfunc doc func doc dcnl dcsp return sfunc
def get score funcs dcsp from scipy import stats dcnl dcsp from scipy spatial import distance dcnl dcsp score funcs bunch dcnl dcsp xy arg dist funcs n f for n f in vars distance items if isfunction f and not n startswith dcnl dcsp xy arg stats funcs n f for n f in vars stats items if isfunction f and not n startswith dcnl dcsp score funcs update dict n make xy sfunc f for n f in xy arg dist funcs if get args f u v dcnl dcsp score funcs update dict n make xy sfunc f ndim output true for n f in xy arg stats funcs if get args f x y dcnl dcsp return score funcs
def check for unsupported ica channels picks info dcsp if picks is none dcnl dcsp dcsp return dcnl dcsp elif len picks 0 dcnl dcsp dcsp raise valueerror no dcsp channels dcsp provided dcsp to dcsp ica dcnl dcsp types data ch types split + eog dcnl dcsp chs list set channel type info j for j in picks dcnl dcsp check all ch in types for ch in chs dcnl dcsp if not check dcnl dcsp dcsp raise valueerror invalid dcsp channel dcsp type s dcsp passed dcsp for dcsp ica nonly dcsp the dcsp following dcsp channels dcsp are dcsp supported dcsp 0 nfollowing dcsp types dcsp were dcsp passed dcsp 1 n format types chs
def check start stop raw start stop dcsp out list dcnl dcsp for st in start stop dcnl dcsp dcsp if st is none dcnl dcsp dcsp dcsp out append st dcnl dcsp dcsp else dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp out append ensure int st dcnl dcsp dcsp dcsp except typeerror dcnl dcsp dcsp dcsp dcsp out append raw time as index st 0 dcnl dcsp return out
verbose dcnl def ica find ecg events raw ecg source event id 999 tstart 0 0 l freq 5 h freq 35 qrs threshold auto verbose none dcsp logger info using dcsp ica dcsp source dcsp to dcsp identify dcsp heart dcsp beats dcnl dcsp ecg events qrs detector raw info sfreq ecg source ravel tstart tstart thresh value qrs threshold l freq l freq h freq h freq dcnl dcsp n events len ecg events dcnl dcsp ecg events np c ecg events + raw first samp np zeros n events event id np ones n events dcnl dcsp return ecg events
verbose dcnl def ica find eog events raw eog source none event id 998 l freq 1 h freq 10 verbose none dcsp eog events find eog events eog sourcenp newaxis event id event id l freq l freq h freq h freq sampling rate raw info sfreq first samp raw first samp dcnl dcsp return eog events
def get target ch container target dcsp picks pick channels container ch names include target dcnl dcsp ref picks pick types container info meg false eeg false ref meg true dcnl dcsp if len ref picks 0 dcnl dcsp dcsp picks list set picks set ref picks dcnl dcsp if len picks 0 dcnl dcsp dcsp raise valueerror s dcsp not dcsp in dcsp channel dcsp list dcsp s target container ch names dcnl dcsp return picks
def find sources sources target score func dcsp if isinstance score func string types dcnl dcsp dcsp score func get score funcs get score func score func dcnl dcsp if not callable score func dcnl dcsp dcsp raise valueerror s dcsp is dcsp not dcsp a dcsp valid dcsp score func score func dcnl dcsp scores score func sources target if target is not none else score func sources 1 dcnl dcsp return scores
def ica explained variance ica inst normalize false dcsp if not isinstance ica ica dcnl dcsp dcsp raise typeerror first dcsp argument dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp ica dcnl dcsp if not isinstance inst baseraw baseepochs evoked dcnl dcsp dcsp raise typeerror second dcsp argument dcsp must dcsp an dcsp instance dcsp of dcsp either dcsp raw dcsp epochs dcsp or dcsp evoked dcnl dcsp source data get inst data ica get sources inst dcnl dcsp if isinstance inst baseepochs dcnl dcsp dcsp n epochs n chan n samp source data shape dcnl dcsp dcsp source data source data transpose 1 0 2 reshape n chan n epochs n samp dcnl dcsp n chan n samp source data shape dcnl dcsp var np sum ica mixing matrix 2 axis 0 np sum source data 2 axis 1 n chan n samp 1 dcnl dcsp if normalize dcnl dcsp dcsp var var sum dcnl dcsp return var
def sort components ica order copy true dcsp assert ica n components len order dcnl dcsp if copy dcnl dcsp dcsp ica ica copy dcnl dcsp ica mixing matrix ica mixing matrix order dcnl dcsp ica unmixing matrix ica unmixing matrix order dcnl dcsp if isinstance order np ndarray dcnl dcsp dcsp order list order dcnl dcsp if ica exclude dcnl dcsp dcsp ica exclude order index ic for ic in ica exclude dcnl dcsp for k in ica labels keys dcnl dcsp dcsp ica labels k order index ic for ic in ica labels k dcnl dcsp return ica
def serialize dict outer sep inner sep dcsp s dcnl dcsp for key value in dict items dcnl dcsp dcsp if callable value dcnl dcsp dcsp dcsp value value name dcnl dcsp dcsp elif isinstance value integral dcnl dcsp dcsp dcsp value int value dcnl dcsp dcsp elif isinstance value dict dcnl dcsp dcsp dcsp for subkey subvalue in value items dcnl dcsp dcsp dcsp dcsp if isinstance subvalue list dcnl dcsp dcsp dcsp dcsp dcsp if len subvalue 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp if isinstance subvalue0 int np integer dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp valuesubkey int i for i in subvalue dcnl dcsp dcsp for cls in np random randomstate covariance dcnl dcsp dcsp dcsp if isinstance value cls dcnl dcsp dcsp dcsp dcsp value cls name dcnl dcsp dcsp s append key + inner sep + json dumps value dcnl dcsp return outer sep join s
def deserialize str outer sep inner sep dcsp out dcnl dcsp for mapping in str split outer sep dcnl dcsp dcsp k v mapping split inner sep 1 dcnl dcsp dcsp vv json loads v dcnl dcsp dcsp outk vv if not isinstance vv text type else str vv dcnl dcsp return out
def write ica fid ica dcsp ica init dict noise cov ica noise cov n components ica n components n pca components ica n pca components max pca components ica max pca components current fit ica current fit dcnl dcsp if ica info is not none dcnl dcsp dcsp start block fid fiff fiffb meas dcnl dcsp dcsp write id fid fiff fiff block id dcnl dcsp dcsp if ica info meas id is not none dcnl dcsp dcsp dcsp write id fid fiff fiff parent block id ica info meas id dcnl dcsp dcsp write meas info fid ica info dcnl dcsp dcsp end block fid fiff fiffb meas dcnl dcsp start block fid fiff fiffb mne ica dcnl dcsp write string fid fiff fiff mne ica interface params serialize ica init dcnl dcsp if ica ch names is not none dcnl dcsp dcsp write name list fid fiff fiff mne row names ica ch names dcnl dcsp n samples getattr ica n samples none dcnl dcsp ica misc n samples none if n samples is none else int n samples labels getattr ica labels none method getattr ica method none dcnl dcsp write string fid fiff fiff mne ica interface params serialize ica init dcnl dcsp write string fid fiff fiff mne ica misc params serialize ica misc dcnl dcsp write double matrix fid fiff fiff mne ica whitener ica pre whitener dcnl dcsp write double matrix fid fiff fiff mne ica pca components ica pca components dcnl dcsp write double matrix fid fiff fiff mne ica pca mean ica pca mean dcnl dcsp write double matrix fid fiff fiff mne ica pca explained var ica pca explained variance dcnl dcsp write double matrix fid fiff fiff mne ica matrix ica unmixing matrix dcnl dcsp write int fid fiff fiff mne ica bads ica exclude dcnl dcsp end block fid fiff fiffb mne ica
verbose dcnl def read ica fname dcsp check fname fname ica ica fif ica fif gz dcnl dcsp logger info reading dcsp s dcsp fname dcnl dcsp fid tree fiff open fname dcnl dcsp try dcnl dcsp dcsp info meas read meas info fid tree clean bads true dcnl dcsp except valueerror dcnl dcsp dcsp logger info could dcsp not dcsp find dcsp the dcsp measurement dcsp info dcsp nfunctionality dcsp requiring dcsp the dcsp info dcsp won t dcsp be dcsp available dcnl dcsp dcsp info none dcnl dcsp ica data dir tree find tree fiff fiffb mne ica dcnl dcsp if len ica data 0 dcnl dcsp dcsp ica data dir tree find tree 123 dcnl dcsp dcsp if len ica data 0 dcnl dcsp dcsp dcsp fid close dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp ica dcsp data dcnl dcsp my ica data ica data0 dcnl dcsp for d in my ica data directory dcnl dcsp dcsp kind d kind dcnl dcsp dcsp pos d pos dcnl dcsp dcsp if kind fiff fiff mne ica interface params dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp ica init tag data dcnl dcsp dcsp elif kind fiff fiff mne row names dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp ch names tag data dcnl dcsp dcsp elif kind fiff fiff mne ica whitener dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp pre whitener tag data dcnl dcsp dcsp elif kind fiff fiff mne ica pca components dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp pca components tag data dcnl dcsp dcsp elif kind fiff fiff mne ica pca explained var dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp pca explained variance tag data dcnl dcsp dcsp elif kind fiff fiff mne ica pca mean dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp pca mean tag data dcnl dcsp dcsp elif kind fiff fiff mne ica matrix dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp unmixing matrix tag data dcnl dcsp dcsp elif kind fiff fiff mne ica bads dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp exclude tag data dcnl dcsp dcsp elif kind fiff fiff mne ica misc params dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp ica misc tag data dcnl dcsp fid close dcnl dcsp ica init ica misc deserialize k for k in ica init ica misc dcnl dcsp current fit ica init pop current fit dcnl dcsp if ica init noise cov covariance name dcnl dcsp dcsp logger info reading dcsp whitener dcsp drawn dcsp from dcsp noise dcsp covariance dcsp dcnl dcsp logger info now dcsp restoring dcsp ica dcsp solution dcsp dcnl dcsp def f x dcnl dcsp dcsp return x astype np float64 dcnl dcsp ica init dict k v for k v in ica init items if k in get args ica init dcnl dcsp ica ica ica init dcnl dcsp ica current fit current fit dcnl dcsp ica ch names ch names split dcnl dcsp ica pre whitener f pre whitener dcnl dcsp ica pca mean f pca mean dcnl dcsp ica pca components f pca components dcnl dcsp ica n components unmixing matrix shape0 dcnl dcsp ica pca explained variance f pca explained variance dcnl dcsp ica unmixing matrix f unmixing matrix dcnl dcsp ica mixing matrix linalg pinv ica unmixing matrix dcnl dcsp ica exclude if exclude is none else list exclude dcnl dcsp ica info info dcnl dcsp if n samples in ica misc dcnl dcsp dcsp ica n samples ica misc n samples dcnl dcsp if labels in ica misc dcnl dcsp dcsp labels ica misc labels dcnl dcsp dcsp if labels is not none dcnl dcsp dcsp dcsp ica labels labels dcnl dcsp if method in ica misc dcnl dcsp dcsp ica method ica misc method dcnl dcsp logger info ready dcnl dcsp return ica
def detect artifacts ica raw start find stop find ecg ch ecg score func ecg criterion eog ch eog score func eog criterion skew criterion kurt criterion var criterion add nodes dcsp from scipy import stats dcnl dcsp nodes dcnl dcsp if ecg ch is not none dcnl dcsp dcsp nodes + ica node ecg ecg ch ecg score func ecg criterion dcnl dcsp if eog ch not in none dcnl dcsp dcsp if not isinstance eog ch list dcnl dcsp dcsp dcsp eog ch eog ch dcnl dcsp dcsp for idx ch in enumerate eog ch dcnl dcsp dcsp dcsp nodes + ica node eog dcsp 02d idx ch eog score func eog criterion dcnl dcsp if skew criterion is not none dcnl dcsp dcsp nodes + ica node skewness none stats skew skew criterion dcnl dcsp if kurt criterion is not none dcnl dcsp dcsp nodes + ica node kurtosis none stats kurtosis kurt criterion dcnl dcsp if var criterion is not none dcnl dcsp dcsp nodes + ica node variance none np var var criterion dcnl dcsp if add nodes is not none dcnl dcsp dcsp nodes extend add nodes dcnl dcsp for node in nodes dcnl dcsp dcsp scores ica score sources raw start start find stop stop find target node target score func node score func dcnl dcsp dcsp if isinstance node criterion float dcnl dcsp dcsp dcsp found list np where np abs scores node criterion 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp found list np atleast 1d abs scores argsort node criterion dcnl dcsp dcsp case len found pl found node name dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp found dcsp s dcsp artifact s dcsp by dcsp s case dcnl dcsp dcsp ica exclude + found dcnl dcsp logger info artifact dcsp indices dcsp found n dcsp dcsp dcsp dcsp + str ica exclude strip dcnl dcsp if len set ica exclude len ica exclude dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp removing dcsp duplicate dcsp indices dcnl dcsp dcsp ica exclude list set ica exclude dcnl dcsp logger info ready
verbose dcnl def run ica raw n components max pca components 100 n pca components 64 noise cov none random state none picks none start none stop none start find none stop find none ecg ch none ecg score func pearsonr ecg criterion 0 1 eog ch none eog score func pearsonr eog criterion 0 1 skew criterion 1 kurt criterion 1 var criterion 0 add nodes none verbose none dcsp ica ica n components n components max pca components max pca components n pca components n pca components noise cov noise cov random state random state verbose verbose dcnl dcsp ica fit raw start start stop stop picks picks dcnl dcsp logger info s ica dcnl dcsp logger info dcsp dcsp dcsp dcsp now dcsp searching dcsp for dcsp artifacts dcnl dcsp detect artifacts ica ica raw raw start find start find stop find stop find ecg ch ecg ch ecg score func ecg score func ecg criterion ecg criterion eog ch eog ch eog score func eog score func eog criterion eog criterion skew criterion skew criterion kurt criterion kurt criterion var criterion var criterion add nodes add nodes dcnl dcsp return ica
verbose dcnl def band pass filter ica sources target l freq h freq verbose none dcsp if l freq is not none and h freq is not none dcnl dcsp dcsp logger info dcsp filtering dcsp ica dcsp sources dcnl dcsp dcsp kw dict phase zerodouble filter length 10s fir window hann l trans bandwidth 0 5 h trans bandwidth 0 5 fir design firwin2 dcnl dcsp dcsp sources filter data sources ica info sfreq l freq h freq kw dcnl dcsp dcsp logger info dcsp filtering dcsp target dcnl dcsp dcsp target filter data target ica info sfreq l freq h freq kw dcnl dcsp elif l freq is not none or h freq is not none dcnl dcsp dcsp raise valueerror must dcsp specify dcsp both dcsp pass dcsp bands dcnl dcsp return sources target
def find max corrs all maps target threshold dcsp all corrs compute corr target subj t for subj in all maps dcnl dcsp abs corrs np abs a for a in all corrs dcnl dcsp corr polarities np sign a for a in all corrs dcnl dcsp if threshold < 1 dcnl dcsp dcsp max corrs list np nonzero s corr threshold 0 for s corr in abs corrs dcnl dcsp else dcnl dcsp dcsp max corrs list find outliers s corr threshold threshold for s corr in abs corrs dcnl dcsp am li for l i s in zip abs corrs max corrs for i in i s dcnl dcsp median corr with target np median am if len am 0 else 0 dcnl dcsp polarities li for l i s in zip corr polarities max corrs for i in i s dcnl dcsp maxmaps li for l i s in zip all maps max corrs for i in i s dcnl dcsp if len maxmaps 0 dcnl dcsp dcsp return 0 0 dcnl dcsp newtarget np zeros maxmaps0 size dcnl dcsp std of maps np std np asarray maxmaps dcnl dcsp mean of maps np std np asarray maxmaps dcnl dcsp for maxmap polarity in zip maxmaps polarities dcnl dcsp dcsp newtarget + maxmap std of maps mean of maps polarity dcnl dcsp newtarget len maxmaps dcnl dcsp newtarget std of maps dcnl dcsp sim i o np abs np corrcoef target newtarget 1 0 dcnl dcsp return newtarget median corr with target sim i o max corrs
def plot corrmap data subjs indices ch type ica label show outlines layout cmap contours template false dcsp if not template dcnl dcsp dcsp title detected dcsp components dcnl dcsp dcsp if label is not none dcnl dcsp dcsp dcsp title + dcsp of dcsp type dcsp + label dcnl dcsp else dcnl dcsp dcsp title supplied dcsp template dcnl dcsp picks list range len data dcnl dcsp p 20 dcnl dcsp if len picks p dcnl dcsp dcsp n components len picks dcnl dcsp dcsp figs plot corrmap datak k + p subjsk k + p indicesk k + p ch type ica label show outlines outlines layout layout cmap cmap contours contours for k in range 0 n components p dcnl dcsp dcsp return figs dcnl dcsp elif np isscalar picks dcnl dcsp dcsp picks picks dcnl dcsp data picks pos merge grads names prepare topo plot ica ch type layout dcnl dcsp pos outlines check outlines pos outlines dcnl dcsp data np atleast 2d data dcnl dcsp data data data picks dcnl dcsp fig axes prepare trellis len picks max col 5 dcnl dcsp fig suptitle title dcnl dcsp if merge grads dcnl dcsp dcsp from channels layout import merge grad data dcnl dcsp for ii data ax subject idx in zip picks data axes subjs indices dcnl dcsp dcsp if template dcnl dcsp dcsp dcsp ttl subj dcsp 0 dcsp ic dcsp 1 format subject idx dcnl dcsp dcsp dcsp ax set title ttl fontsize 12 dcnl dcsp dcsp data merge grad data data if merge grads else data dcnl dcsp dcsp vmin vmax setup vmin vmax data none none dcnl dcsp dcsp plot topomap data flatten pos vmin vmin vmax vmax res 64 axes ax cmap cmap outlines outlines image mask none contours contours show false image interp bilinear 0 dcnl dcsp dcsp hide frame ax dcnl dcsp tight layout fig fig dcnl dcsp fig subplots adjust top 0 8 dcnl dcsp fig canvas draw dcnl dcsp plt show show dcnl dcsp return fig
verbose dcnl def corrmap icas template threshold auto label none ch type eeg plot true show true verbose none outlines head layout none sensors true contours 6 cmap none dcsp if not isinstance plot bool dcnl dcsp dcsp raise valueerror plot dcsp must dcsp be dcsp of dcsp type dcsp bool dcnl dcsp if threshold auto dcnl dcsp dcsp threshold np arange 60 95 dtype np float64 100 0 dcnl dcsp all maps ica get components t for ica in icas dcnl dcsp if len template 2 dcnl dcsp dcsp target all mapstemplate0template1 dcnl dcsp dcsp is subject true dcnl dcsp elif template ndim 1 and len template all maps0 shape1 dcnl dcsp dcsp target template dcnl dcsp dcsp is subject false dcnl dcsp else dcnl dcsp dcsp raise valueerror template dcsp must dcsp be dcsp a dcsp length2 dcsp tuple dcsp or dcsp an dcsp array dcsp the dcsp size dcsp of dcsp the dcsp ica dcsp maps dcnl dcsp template fig labelled ics none none dcnl dcsp if plot is true dcnl dcsp dcsp if is subject dcnl dcsp dcsp dcsp ttl template dcsp from dcsp subj dcsp 0 format str template0 dcnl dcsp dcsp dcsp template fig icastemplate0 plot components picks template1 ch type ch type title ttl outlines outlines cmap cmap contours contours layout layout show show dcnl dcsp dcsp else dcnl dcsp dcsp dcsp template fig plot corrmap template 0 0 ch type icas0 copy template outlines outlines cmap cmap contours contours layout layout show show template true dcnl dcsp dcsp template fig subplots adjust top 0 8 dcnl dcsp dcsp template fig canvas draw dcnl dcsp if isinstance threshold int float dcnl dcsp dcsp if len all maps 0 dcnl dcsp dcsp dcsp logger info no dcsp component dcsp detected dcsp using dcsp find outliers dcsp consider dcsp using dcsp threshold auto dcnl dcsp dcsp dcsp return icas dcnl dcsp dcsp nt mt s mx find max corrs all maps target threshold dcnl dcsp elif len threshold 1 dcnl dcsp dcsp paths find max corrs all maps target t for t in threshold dcnl dcsp dcsp nt mt s mx pathsnp argmax path2 for path in paths dcnl dcsp if isinstance threshold int float dcnl dcsp dcsp if len all maps 0 or len nt 0 dcnl dcsp dcsp dcsp if threshold 1 dcnl dcsp dcsp dcsp dcsp logger info no dcsp component dcsp detected dcsp using dcsp find outliers dcsp consider dcsp using dcsp threshold auto dcnl dcsp dcsp dcsp return icas dcnl dcsp dcsp nt mt s mx find max corrs all maps nt threshold dcnl dcsp elif len threshold 1 dcnl dcsp dcsp paths find max corrs all maps nt t for t in threshold dcnl dcsp dcsp nt mt s mx pathsnp argmax path1 for path in paths dcnl dcsp allmaps indices subjs nones list for in range 4 dcnl dcsp logger info median dcsp correlation dcsp with dcsp constructed dcsp map dcsp 0 3f mt dcnl dcsp if plot is true dcnl dcsp dcsp logger info displaying dcsp selected dcsp ics dcsp per dcsp subject dcnl dcsp for ii ica max corr in enumerate zip icas mx dcnl dcsp dcsp if len max corr 0 dcnl dcsp dcsp dcsp if isinstance max corr0 np ndarray dcnl dcsp dcsp dcsp dcsp max corr max corr0 dcnl dcsp dcsp dcsp if label is not none dcnl dcsp dcsp dcsp dcsp ica labels label list set list max corr + ica labels get label list dcnl dcsp dcsp dcsp if plot is true dcnl dcsp dcsp dcsp dcsp allmaps extend ica get components max corr t dcnl dcsp dcsp dcsp dcsp subjs extend ii len max corr dcnl dcsp dcsp dcsp dcsp indices extend max corr dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if label is not none and label not in ica labels dcnl dcsp dcsp dcsp dcsp ica labels label list dcnl dcsp dcsp dcsp nones append ii dcnl dcsp if len nones 0 dcnl dcsp dcsp logger info at dcsp least dcsp 1 dcsp ic dcsp detected dcsp for dcsp each dcsp subject dcnl dcsp else dcnl dcsp dcsp logger info no dcsp maps dcsp selected dcsp for dcsp subject s dcsp + dcsp join str x for x in nones + dcsp consider dcsp a dcsp more dcsp liberal dcsp threshold dcnl dcsp if plot is true dcnl dcsp dcsp labelled ics plot corrmap allmaps subjs indices ch type ica label outlines outlines cmap cmap contours contours layout layout show show dcnl dcsp dcsp return template fig labelled ics dcnl dcsp else dcnl dcsp dcsp return none
def read fine calibration fname dcsp check fname fname overwrite read must exist true dcnl dcsp check fname fname cal dat dcnl dcsp ch names list dcnl dcsp locs list dcnl dcsp imb cals list dcnl dcsp with open fname r as fid dcnl dcsp dcsp for line in fid dcnl dcsp dcsp dcsp if line0 in n dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp vals line strip split dcnl dcsp dcsp dcsp if len vals not in 14 16 dcnl dcsp dcsp dcsp dcsp raise runtimeerror error dcsp parsing dcsp fine dcsp calibration dcsp file dcsp should dcsp have dcsp 14 dcsp or dcsp 16 dcsp entries dcsp per dcsp line dcsp but dcsp found dcsp s dcsp on dcsp line n s len vals line dcnl dcsp dcsp dcsp ch name vals0 dcnl dcsp dcsp dcsp if len ch name in 3 4 dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp ch name int ch name dcnl dcsp dcsp dcsp dcsp except valueerror dcnl dcsp dcsp dcsp dcsp dcsp pass dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp ch name meg + 04d ch name dcnl dcsp dcsp dcsp ch names append ch name dcnl dcsp dcsp dcsp locs append np array float x for x in vals1 13 dcnl dcsp dcsp dcsp imb cals append float x for x in vals13 dcnl dcsp locs np array locs dcnl dcsp return dict ch names ch names locs locs imb cals imb cals
def write fine calibration fname calibration dcsp check fname fname overwrite true dcnl dcsp check fname fname cal dat dcnl dcsp with open fname wb as cal file dcnl dcsp dcsp for ci chan in enumerate calibration ch names dcnl dcsp dcsp dcsp cal line np concatenate calibration locs ci calibration imb cals ci round 6 dcnl dcsp dcsp dcsp cal str str chan + dcsp + dcsp join map lambda x 6f x cal line dcnl dcsp dcsp dcsp cal file write cal str + n encode ascii
def find outliers x threshold 3 0 max iter 2 dcsp from scipy stats import zscore dcnl dcsp my mask np zeros len x dtype np bool dcnl dcsp for in range max iter dcnl dcsp dcsp x np ma masked array x my mask dcnl dcsp dcsp this z np abs zscore x dcnl dcsp dcsp local bad this z threshold dcnl dcsp dcsp my mask np max my mask local bad 0 dcnl dcsp dcsp if not np any local bad dcnl dcsp dcsp dcsp break dcnl dcsp bad idx np where my mask 0 dcnl dcsp return bad idx
def qrs detector sfreq ecg thresh value 0 6 levels 2 5 n thresh 3 l freq 5 h freq 35 tstart 0 filter length 10s dcsp win size int round 60 0 sfreq 120 0 dcnl dcsp filtecg filter data ecg sfreq l freq h freq none filter length 0 5 0 5 phase zerodouble fir window hann fir design firwin2 dcnl dcsp ecg abs np abs filtecg dcnl dcsp init int sfreq dcnl dcsp n samples start int sfreq tstart dcnl dcsp ecg abs ecg absn samples start dcnl dcsp n points len ecg abs dcnl dcsp maxpt np empty 3 dcnl dcsp maxpt0 np max ecg abs init dcnl dcsp maxpt1 np max ecg absinit init 2 dcnl dcsp maxpt2 np max ecg abs init 2 init 3 dcnl dcsp init max np mean maxpt dcnl dcsp if thresh value auto dcnl dcsp dcsp thresh runs np arange 0 3 1 1 0 05 dcnl dcsp elif isinstance thresh value string types dcnl dcsp dcsp raise valueerror threshold dcsp value dcsp must dcsp be dcsp auto dcsp or dcsp a dcsp float dcnl dcsp else dcnl dcsp dcsp thresh runs thresh value dcnl dcsp clean events list dcnl dcsp for thresh value in thresh runs dcnl dcsp dcsp thresh1 init max thresh value dcnl dcsp dcsp numcross list dcnl dcsp dcsp time list dcnl dcsp dcsp rms list dcnl dcsp dcsp ii 0 dcnl dcsp dcsp while ii < n points win size dcnl dcsp dcsp dcsp window ecg absii ii + win size dcnl dcsp dcsp dcsp if window0 thresh1 dcnl dcsp dcsp dcsp dcsp max time np argmax window dcnl dcsp dcsp dcsp dcsp time append ii + max time dcnl dcsp dcsp dcsp dcsp nx np sum np diff window thresh1 astype np int 1 astype int dcnl dcsp dcsp dcsp dcsp numcross append nx dcnl dcsp dcsp dcsp dcsp rms append np sqrt sum squared window window size dcnl dcsp dcsp dcsp dcsp ii + win size dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ii + 1 dcnl dcsp dcsp if len rms 0 dcnl dcsp dcsp dcsp rms append 0 0 dcnl dcsp dcsp dcsp time append 0 0 dcnl dcsp dcsp time np array time dcnl dcsp dcsp rms mean np mean rms dcnl dcsp dcsp rms std np std rms dcnl dcsp dcsp rms thresh rms mean + rms std levels dcnl dcsp dcsp b np where rms < rms thresh 0 dcnl dcsp dcsp a np array numcross b dcnl dcsp dcsp ce timeb a < n thresh dcnl dcsp dcsp ce + n samples start dcnl dcsp dcsp clean events append ce dcnl dcsp rates np array 60 0 len cev len ecg float sfreq for cev in clean events dcnl dcsp idx np where np logical and rates < 160 0 rates 40 0 0 dcnl dcsp if len idx 0 dcnl dcsp dcsp ideal rate np median ratesidx dcnl dcsp else dcnl dcsp dcsp ideal rate 80 0 dcnl dcsp idx np argmin np abs rates ideal rate dcnl dcsp clean events clean eventsidx dcnl dcsp return clean events
verbose dcnl def find ecg events raw event id 999 ch name none tstart 0 0 l freq 5 h freq 35 qrs threshold auto filter length 10s return ecg false verbose none dcsp idx ecg get ecg channel index ch name raw dcnl dcsp if idx ecg is not none dcnl dcsp dcsp logger info using dcsp channel dcsp s dcsp to dcsp identify dcsp heart dcsp beats raw ch namesidx ecg dcnl dcsp dcsp ecg times rawidx ecg dcnl dcsp else dcnl dcsp dcsp ecg times make ecg raw none none verbose verbose dcnl dcsp ecg events qrs detector raw info sfreq ecg ravel tstart tstart thresh value qrs threshold l freq l freq h freq h freq filter length filter length dcnl dcsp n events len ecg events dcnl dcsp average pulse n events 60 0 times 1 times0 dcnl dcsp logger info number dcsp of dcsp ecg dcsp events dcsp detected dcsp dcsp d dcsp average dcsp pulse dcsp d dcsp dcsp min n events average pulse dcnl dcsp ecg events np array ecg events + raw first samp np zeros n events int event id np ones n events int t dcnl dcsp out ecg events idx ecg average pulse dcnl dcsp if return ecg dcnl dcsp dcsp out + ecg dcnl dcsp return out
def get ecg channel index ch name inst dcsp if ch name is none dcnl dcsp dcsp ecg idx pick types inst info meg false eeg false stim false eog false ecg true emg false ref meg false exclude bads dcnl dcsp else dcnl dcsp dcsp if ch name not in inst ch names dcnl dcsp dcsp dcsp raise valueerror s dcsp not dcsp in dcsp channel dcsp list dcsp s ch name inst ch names dcnl dcsp dcsp ecg idx pick channels inst ch names include ch name dcnl dcsp if len ecg idx 0 dcnl dcsp dcsp return none dcnl dcsp if len ecg idx 1 dcnl dcsp dcsp warn more dcsp than dcsp one dcsp ecg dcsp channel dcsp found dcsp using dcsp only dcsp s inst ch namesecg idx0 dcnl dcsp return ecg idx0
verbose dcnl def create ecg epochs raw ch name none event id 999 picks none tmin 0 5 tmax 0 5 l freq 8 h freq 16 reject none flat none baseline none preload true keep ecg false reject by annotation true verbose none dcsp has ecg ecg in raw or ch name is not none dcnl dcsp events ecg find ecg events raw ch name ch name event id event id l freq l freq h freq h freq return ecg true verbose verbose dcnl dcsp raw load data dcnl dcsp if not has ecg dcnl dcsp dcsp ecg raw rawarray ecgnone create info ch names ecgsyn sfreq raw info sfreq ch types ecg dcnl dcsp dcsp ignore ch names chs nchan bads dcnl dcsp dcsp for k v in raw info items dcnl dcsp dcsp dcsp if k not in ignore dcnl dcsp dcsp dcsp dcsp ecg raw infok v dcnl dcsp dcsp raw add channels ecg raw dcnl dcsp if keep ecg dcnl dcsp dcsp if has ecg dcnl dcsp dcsp dcsp raise valueerror keep ecg dcsp can dcsp be dcsp true dcsp only dcsp if dcsp the dcsp ecg dcsp channel dcsp is dcsp created dcsp synthetically dcnl dcsp dcsp else dcnl dcsp dcsp dcsp picks np append picks raw ch names index ecgsyn dcnl dcsp ecg epochs epochs raw events events event id event id tmin tmin tmax tmax proj false flat flat picks picks reject reject baseline baseline reject by annotation reject by annotation verbose verbose preload preload dcnl dcsp if not has ecg dcnl dcsp dcsp raw drop channels ecgsyn dcnl dcsp return ecg epochs
verbose dcnl def make ecg inst start stop reject by annotation false verbose none dcsp if not any c in inst for c in mag grad dcnl dcsp dcsp raise valueerror unable dcsp to dcsp generate dcsp artificial dcsp ecg dcsp channel dcnl dcsp for ch in mag grad dcnl dcsp dcsp if ch in inst dcnl dcsp dcsp dcsp break dcnl dcsp logger info reconstructing dcsp ecg dcsp signal dcsp from dcsp 0 format mag magnetometers grad gradiometers ch dcnl dcsp picks pick types inst info meg ch eeg false ref meg false dcnl dcsp if isinstance inst baseraw dcnl dcsp dcsp reject by annotation omit if reject by annotation else none dcnl dcsp dcsp ecg times inst get data picks start stop reject by annotation true dcnl dcsp elif isinstance inst baseepochs dcnl dcsp dcsp ecg np hstack inst copy crop start stop get data dcnl dcsp dcsp times inst times dcnl dcsp elif isinstance inst evoked dcnl dcsp dcsp ecg inst data dcnl dcsp dcsp times inst times dcnl dcsp return ecg mean 0 times
verbose dcnl def peak finder x0 thresh none extrema 1 verbose none dcsp x0 np asanyarray x0 dcnl dcsp if x0 ndim 2 dcnl dcsp dcsp raise valueerror the dcsp input dcsp data dcsp must dcsp be dcsp a dcsp 1d dcsp vector dcnl dcsp s x0 size dcnl dcsp if thresh is none dcnl dcsp dcsp thresh np max x0 np min x0 4 dcnl dcsp assert extrema in 1 1 dcnl dcsp if extrema 1 dcnl dcsp dcsp x0 extrema x0 dcnl dcsp dx0 np diff x0 dcnl dcsp dx0 dx0 0 np finfo float eps dcnl dcsp ind np where dx0 1 none dx01 none < 0 0 + 1 dcnl dcsp x np concatenate x0 1 x0ind x0 1 dcnl dcsp ind np concatenate 0 ind s 1 dcnl dcsp length x size dcnl dcsp min mag np min x dcnl dcsp if length 2 dcnl dcsp dcsp temp mag min mag dcnl dcsp dcsp found peak false dcnl dcsp dcsp left min min mag dcnl dcsp dcsp signdx np sign np diff x 3 dcnl dcsp dcsp if signdx0 < 0 dcnl dcsp dcsp dcsp ii 1 dcnl dcsp dcsp dcsp if signdx0 signdx1 dcnl dcsp dcsp dcsp dcsp x np concatenate x 1 x2 dcnl dcsp dcsp dcsp dcsp ind np concatenate ind 1 ind2 dcnl dcsp dcsp dcsp dcsp length 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ii 0 dcnl dcsp dcsp dcsp if signdx0 signdx1 dcnl dcsp dcsp dcsp dcsp x x1 dcnl dcsp dcsp dcsp dcsp ind ind1 dcnl dcsp dcsp dcsp dcsp length 1 dcnl dcsp dcsp maxpeaks int ceil length 2 0 dcnl dcsp dcsp peak loc np zeros maxpeaks dtype np int dcnl dcsp dcsp peak mag np zeros maxpeaks dcnl dcsp dcsp c ind 0 dcnl dcsp dcsp while ii < length 1 dcnl dcsp dcsp dcsp ii + 1 dcnl dcsp dcsp dcsp if found peak and xii peak mag 1 or left min < peak mag 1 thresh dcnl dcsp dcsp dcsp dcsp temp mag min mag dcnl dcsp dcsp dcsp dcsp found peak false dcnl dcsp dcsp dcsp if ii length 1 dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp if xii temp mag and xii left min + thresh dcnl dcsp dcsp dcsp dcsp temp loc ii dcnl dcsp dcsp dcsp dcsp temp mag xii dcnl dcsp dcsp dcsp ii + 1 dcnl dcsp dcsp dcsp if not found peak and temp mag thresh + xii dcnl dcsp dcsp dcsp dcsp found peak true dcnl dcsp dcsp dcsp dcsp left min xii dcnl dcsp dcsp dcsp dcsp peak locc ind temp loc dcnl dcsp dcsp dcsp dcsp peak magc ind temp mag dcnl dcsp dcsp dcsp dcsp c ind + 1 dcnl dcsp dcsp dcsp elif xii < left min dcnl dcsp dcsp dcsp dcsp left min xii dcnl dcsp dcsp if x 1 temp mag and x 1 left min + thresh dcnl dcsp dcsp dcsp peak locc ind length 1 dcnl dcsp dcsp dcsp peak magc ind x 1 dcnl dcsp dcsp dcsp c ind + 1 dcnl dcsp dcsp elif not found peak and temp mag min mag dcnl dcsp dcsp dcsp peak locc ind temp loc dcnl dcsp dcsp dcsp peak magc ind temp mag dcnl dcsp dcsp dcsp c ind + 1 dcnl dcsp dcsp peak inds indpeak loc c ind dcnl dcsp dcsp peak mags peak mag c ind dcnl dcsp else dcnl dcsp dcsp x ind np argmax x dcnl dcsp dcsp peak mags xx ind dcnl dcsp dcsp if peak mags min mag + thresh dcnl dcsp dcsp dcsp peak inds indx ind dcnl dcsp dcsp else dcnl dcsp dcsp dcsp peak mags dcnl dcsp dcsp dcsp peak inds dcnl dcsp if extrema < 0 dcnl dcsp dcsp peak mags 1 0 dcnl dcsp dcsp x0 x0 dcnl dcsp if len peak inds 0 dcnl dcsp dcsp logger info no dcsp significant dcsp peaks dcsp found dcnl dcsp return peak inds peak mags
def fig to img function none fig none image format png scale none kwargs dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib figure import figure dcnl dcsp if not isinstance fig figure and function is none dcnl dcsp dcsp from scipy misc import imread dcnl dcsp dcsp mlab none dcnl dcsp dcsp try dcnl dcsp dcsp dcsp mlab import mlab dcnl dcsp dcsp except exception as e dcnl dcsp dcsp dcsp warn could dcsp not dcsp import dcsp mayavi dcsp r dcsp trying dcsp to dcsp render mayavi core scene scene dcsp figure dcsp instances dcsp will dcsp throw dcsp an dcsp error e dcnl dcsp dcsp tempdir tempdir dcnl dcsp dcsp temp fname op join tempdir test dcnl dcsp dcsp if fig scene is not none dcnl dcsp dcsp dcsp fig scene save png temp fname dcnl dcsp dcsp dcsp img imread temp fname dcnl dcsp dcsp dcsp os remove temp fname dcnl dcsp dcsp else dcnl dcsp dcsp dcsp img np zeros 2 2 3 dcnl dcsp dcsp mlab close fig dcnl dcsp dcsp fig plt figure dcnl dcsp dcsp plt imshow img dcnl dcsp dcsp plt axis off dcnl dcsp if function is not none dcnl dcsp dcsp plt close all dcnl dcsp dcsp fig function kwargs dcnl dcsp output bytesio dcnl dcsp if scale is not none dcnl dcsp dcsp scale mpl figure fig scale dcnl dcsp logger debug saving dcsp figure dcsp s dcsp with dcsp dpi dcsp s fig get size inches fig get dpi dcnl dcsp fig savefig output format image format dpi fig get dpi dcnl dcsp plt close fig dcnl dcsp output output getvalue dcnl dcsp return output if image format svg else base64 b64encode output decode ascii
def scale mpl figure fig scale dcsp fig set size inches fig get size inches scale dcnl dcsp fig set dpi fig get dpi scale dcnl dcsp import matplotlib as mpl dcnl dcsp if scale 1 dcnl dcsp dcsp sfactor scale 2 dcnl dcsp elif scale < 1 dcnl dcsp dcsp sfactor 1 0 scale 2 dcnl dcsp for text in fig findobj mpl text text dcnl dcsp dcsp fs text get fontsize dcnl dcsp dcsp new size fs + sfactor dcnl dcsp dcsp if new size < 0 dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp rescale dcsp matplotlib dcsp fonts dcsp consider dcsp increasing dcsp scale dcnl dcsp dcsp text set fontsize new size dcnl dcsp fig canvas draw
def iterate trans views function kwargs dcsp from scipy misc import imread dcnl dcsp import matplotlib pyplot as plt dcnl dcsp import mayavi dcnl dcsp fig function kwargs dcnl dcsp assert isinstance fig mayavi core scene scene dcnl dcsp views 90 90 0 90 0 90 dcnl dcsp fig2 axes plt subplots 1 len views dcnl dcsp for view ax in zip views axes dcnl dcsp dcsp mayavi mlab view view0 view1 dcnl dcsp dcsp tempdir tempdir dcnl dcsp dcsp temp fname op join tempdir test png dcnl dcsp dcsp if fig scene is not none dcnl dcsp dcsp dcsp fig scene save png temp fname dcnl dcsp dcsp dcsp im imread temp fname dcnl dcsp dcsp else dcnl dcsp dcsp dcsp im np zeros 2 2 3 dcnl dcsp dcsp ax imshow im dcnl dcsp dcsp ax axis off dcnl dcsp mayavi mlab close fig dcnl dcsp img fig to img fig fig2 image format png dcnl dcsp return img
def is bad fname fname dcsp if fname endswith whitened dcnl dcsp dcsp fname fname 11 dcnl dcsp if not fname endswith tuple valid extensions + bem custom dcnl dcsp dcsp return red dcnl dcsp else dcnl dcsp dcsp return
def get fname fname dcsp if in fname dcnl dcsp dcsp fname fname split 0 dcnl dcsp else dcnl dcsp dcsp fname op basename fname dcnl dcsp fname dcsp dcsp s fname dcnl dcsp return fname
def get toc property fname dcsp if fname endswith eve fif eve fif gz dcnl dcsp dcsp div klass events dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith ave fif ave fif gz dcnl dcsp dcsp div klass evoked dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith cov fif cov fif gz dcnl dcsp dcsp div klass covariance dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith raw fif raw fif gz sss fif sss fif gz dcnl dcsp dcsp div klass raw dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith trans fif trans fif gz dcnl dcsp dcsp div klass trans dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith fwd fif fwd fif gz dcnl dcsp dcsp div klass forward dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith inv fif inv fif gz dcnl dcsp dcsp div klass inverse dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith epo fif epo fif gz dcnl dcsp dcsp div klass epochs dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname dcnl dcsp elif fname endswith nii nii gz mgh mgz dcnl dcsp dcsp div klass mri dcnl dcsp dcsp tooltip mri dcnl dcsp dcsp text mri dcnl dcsp elif fname endswith bem dcnl dcsp dcsp div klass mri dcnl dcsp dcsp tooltip mri dcnl dcsp dcsp text mri dcnl dcsp elif fname endswith whitened dcnl dcsp dcsp div klass evoked dcnl dcsp dcsp tooltip fname dcnl dcsp dcsp text op basename fname 11 + whitened dcnl dcsp else dcnl dcsp dcsp div klass fname split 1 dcnl dcsp dcsp tooltip fname split 0 dcnl dcsp dcsp text fname split 0 dcnl dcsp return div klass tooltip text
def iterate files report fnames info cov baseline sfreq on error image format dcsp htmls report fnames report sectionlabels dcnl dcsp def update html html report fname report sectionlabel dcnl dcsp dcsp update dcsp the dcsp lists dcsp above dcnl dcsp dcsp htmls append html dcnl dcsp dcsp report fnames append report fname dcnl dcsp dcsp report sectionlabels append report sectionlabel dcnl dcsp for fname in fnames dcnl dcsp dcsp logger info rendering dcsp dcsp s op join + report data path 20 fname dcnl dcsp dcsp try dcnl dcsp dcsp dcsp if fname endswith raw fif raw fif gz sss fif sss fif gz dcnl dcsp dcsp dcsp dcsp html report render raw fname dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel raw dcnl dcsp dcsp dcsp elif fname endswith fwd fif fwd fif gz dcnl dcsp dcsp dcsp dcsp html report render forward fname dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel forward dcnl dcsp dcsp dcsp elif fname endswith inv fif inv fif gz dcnl dcsp dcsp dcsp dcsp html report render inverse fname dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel inverse dcnl dcsp dcsp dcsp elif fname endswith ave fif ave fif gz dcnl dcsp dcsp dcsp dcsp if cov is not none dcnl dcsp dcsp dcsp dcsp dcsp html report render whitened evoked fname cov baseline image format dcnl dcsp dcsp dcsp dcsp dcsp report fname fname + dcsp whitened dcnl dcsp dcsp dcsp dcsp dcsp report sectionlabel evoked dcnl dcsp dcsp dcsp dcsp dcsp update html html report fname report sectionlabel dcnl dcsp dcsp dcsp dcsp html report render evoked fname baseline image format dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel evoked dcnl dcsp dcsp dcsp elif fname endswith eve fif eve fif gz dcnl dcsp dcsp dcsp dcsp html report render eve fname sfreq image format dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel events dcnl dcsp dcsp dcsp elif fname endswith epo fif epo fif gz dcnl dcsp dcsp dcsp dcsp html report render epochs fname image format dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel epochs dcnl dcsp dcsp dcsp elif fname endswith cov fif cov fif gz and report info fname is not none dcnl dcsp dcsp dcsp dcsp html report render cov fname info image format dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel covariance dcnl dcsp dcsp dcsp elif fname endswith trans fif trans fif gz and report info fname is not none and report subjects dir is not none and report subject is not none dcnl dcsp dcsp dcsp dcsp html report render trans fname report data path info report subject report subjects dir dcnl dcsp dcsp dcsp dcsp report fname fname dcnl dcsp dcsp dcsp dcsp report sectionlabel trans dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp html none dcnl dcsp dcsp dcsp dcsp report fname none dcnl dcsp dcsp dcsp dcsp report sectionlabel none dcnl dcsp dcsp except exception as e dcnl dcsp dcsp dcsp if on error warn dcnl dcsp dcsp dcsp dcsp warn failed dcsp to dcsp process dcsp file dcsp s n s fname e dcnl dcsp dcsp dcsp elif on error raise dcnl dcsp dcsp dcsp dcsp raise dcnl dcsp dcsp dcsp html none dcnl dcsp dcsp dcsp report fname none dcnl dcsp dcsp dcsp report sectionlabel none dcnl dcsp dcsp update html html report fname report sectionlabel dcnl dcsp return htmls report fnames report sectionlabels
def build image png data cmap gray dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib figure import figure dcnl dcsp from matplotlib backends backend agg import figurecanvasagg as figurecanvas dcnl dcsp figsize data shape 1 dcnl dcsp if figsize0 1 dcnl dcsp dcsp figsize tuple figsize1 dcnl dcsp dcsp data data 0 dcnl dcsp fig figure figsize figsize dpi 1 0 frameon false dcnl dcsp figurecanvas fig dcnl dcsp cmap getattr plt cm cmap plt cm gray dcnl dcsp fig figimage data cmap cmap dcnl dcsp output bytesio dcnl dcsp fig savefig output dpi 1 0 format png dcnl dcsp return base64 b64encode output getvalue decode ascii
def iterate sagittal slices array limits none dcsp shape array shape0 dcnl dcsp for ind in range shape dcnl dcsp dcsp if limits and ind not in limits dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp yield ind arrayind
def iterate axial slices array limits none dcsp shape array shape1 dcnl dcsp for ind in range shape dcnl dcsp dcsp if limits and ind not in limits dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp yield ind array ind
def iterate coronal slices array limits none dcsp shape array shape2 dcnl dcsp for ind in range shape dcnl dcsp dcsp if limits and ind not in limits dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp yield ind np flipud np rot90 array ind
def iterate mri slices name ind global id slides klass data cmap dcsp img klass slideimg s name dcnl dcsp caption u slice dcsp s dcsp s name ind dcnl dcsp slice id s s s name global id ind dcnl dcsp div klass span12 dcsp s slides klass dcnl dcsp img build image png data cmap cmap dcnl dcsp first true if ind 0 else false dcnl dcsp html build html image img slice id div klass img klass caption first image format png dcnl dcsp return ind html
def build html image img id div klass img klass caption none show true image format png dcsp html dcnl dcsp add style u if show else u style display dcsp none dcnl dcsp html append u <li dcsp class s dcsp id s dcsp s div klass id add style dcnl dcsp html append u <div dcsp class thumbnail dcnl dcsp if image format png dcnl dcsp dcsp html append u <img dcsp class s dcsp alt dcsp style width 90 dcsp src data image png base64 s img klass img dcnl dcsp else dcnl dcsp dcsp html append u <div dcsp style textalign center dcsp class s s< div img klass img dcnl dcsp html append u < div dcnl dcsp if caption dcnl dcsp dcsp html append u <h4 s< h4 caption dcnl dcsp html append u < li dcnl dcsp return u n join html
def build html slider slices range slides klass slider id start value none dcsp if start value is none dcnl dcsp dcsp start value slices range len slices range 2 dcnl dcsp return slider template substitute slider id slider id klass slides klass step slices range1 slices range0 minvalue slices range0 maxvalue slices range 1 startvalue start value
def check scale scale dcsp if np isscalar scale and scale < 0 dcnl dcsp dcsp raise valueerror scale dcsp must dcsp be dcsp positive dcsp not dcsp s scale
def check image format rep image format dcsp if image format not in png svg dcnl dcsp dcsp if rep is none dcnl dcsp dcsp dcsp raise valueerror image format dcsp must dcsp be dcsp svg dcsp or dcsp png dcsp got dcsp s image format dcnl dcsp dcsp elif image format is not none dcnl dcsp dcsp dcsp raise valueerror image format dcsp must dcsp be dcsp one dcsp of dcsp svg dcsp png dcsp or dcsp none dcsp got dcsp s image format dcnl dcsp dcsp else dcnl dcsp dcsp dcsp image format rep image format dcnl dcsp return image format
def recursive search path pattern dcsp filtered files list dcnl dcsp for dirpath dirnames files in os walk path dcnl dcsp dcsp for f in fnmatch filter files pattern dcnl dcsp dcsp dcsp if f endswith tuple valid extensions dcnl dcsp dcsp dcsp dcsp filtered files append op realpath op join dirpath f dcnl dcsp return filtered files
def fix global ids html dcsp html re sub id d+ id html dcnl dcsp global id 1 dcnl dcsp while len re findall id html 0 dcnl dcsp dcsp html re sub id id s global id html count 1 dcnl dcsp dcsp global id + 1 dcnl dcsp return html
def read dipole fixed fname dcsp logger info reading dcsp s dcsp fname dcnl dcsp info nave aspect kind first last comment times data read evoked fname dcnl dcsp return dipolefixed info data times nave aspect kind first last comment
verbose dcnl def read dipole fname verbose none dcsp check fname fname overwrite read must exist true dcnl dcsp if fname endswith fif or fname endswith fif gz dcnl dcsp dcsp return read dipole fixed fname dcnl dcsp else dcnl dcsp dcsp return read dipole text fname
def read dipole text fname dcsp need header true dcnl dcsp def line name none dcnl dcsp data list dcnl dcsp with open fname r as fid dcnl dcsp dcsp for line in fid dcnl dcsp dcsp dcsp if not line startswith or line startswith dcnl dcsp dcsp dcsp dcsp need header false dcnl dcsp dcsp dcsp dcsp data append line strip split dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp if need header dcnl dcsp dcsp dcsp dcsp dcsp def line line dcnl dcsp dcsp dcsp dcsp if line startswith or line startswith dcnl dcsp dcsp dcsp dcsp dcsp m re search name dcsp dcsp dipoles line dcnl dcsp dcsp dcsp dcsp dcsp if m dcnl dcsp dcsp dcsp dcsp dcsp dcsp name m group 1 dcnl dcsp dcsp del line dcnl dcsp data np atleast 2d np array data float dcnl dcsp if def line is none dcnl dcsp dcsp raise ioerror dipole dcsp text dcsp file dcsp is dcsp missing dcsp field dcsp definition dcsp comment dcsp cannot dcsp parse dcsp s fname dcnl dcsp def line def line lstrip lstrip strip dcnl dcsp fields re sub x|y|z dcsp mm lambda match match group 1 strip + mm def line dcnl dcsp fields re sub lambda match + match group 1 fields dcnl dcsp fields re sub begin|end dcsp lambda match match group 1 + ms fields dcnl dcsp fields fields lower split dcnl dcsp required fields begin ms x mm y mm z mm q nam qx nam qy nam qz nam g dcnl dcsp optional fields khi^2 free vol mm^3 depth mm long mm trans mm qlong nam qtrans nam dcnl dcsp conf scales 1e09 0 001 0 001 0 001 1e09 1e09 dcnl dcsp missing fields sorted set required fields set fields dcnl dcsp if len missing fields 0 dcnl dcsp dcsp raise runtimeerror could dcsp not dcsp find dcsp necessary dcsp fields dcsp in dcsp header dcsp s missing fields dcnl dcsp handled fields set required fields | set optional fields dcnl dcsp assert len handled fields len required fields + len optional fields dcnl dcsp ignored fields sorted set fields set handled fields set end ms dcnl dcsp if len ignored fields 0 dcnl dcsp dcsp warn ignoring dcsp extra dcsp fields dcsp in dcsp dipole dcsp file dcsp s ignored fields dcnl dcsp if len fields data shape1 dcnl dcsp dcsp raise ioerror more dcsp data dcsp fields dcsp s dcsp found dcsp than dcsp data dcsp columns dcsp s dcsp s len fields data shape1 fields dcnl dcsp logger info d dcsp dipole s dcsp found len data dcnl dcsp if end ms in fields dcnl dcsp dcsp if np diff data fields index begin ms fields index end ms 1 1 any dcnl dcsp dcsp dcsp warn begin dcsp and dcsp end dcsp fields dcsp differed dcsp but dcsp only dcsp begin dcsp will dcsp be dcsp used dcsp to dcsp store dcsp time dcsp values dcnl dcsp idx fields index field for field in required fields dcnl dcsp assert len idx 9 dcnl dcsp times data idx0 1000 0 dcnl dcsp pos 0 001 data idx1 4 dcnl dcsp amplitude data idx4 dcnl dcsp norm amplitude copy dcnl dcsp amplitude 1000000000 0 dcnl dcsp norm norm 0 1 dcnl dcsp ori data idx5 8 norm np newaxis dcnl dcsp gof data idx8 dcnl dcsp optional none 2 dcnl dcsp for fi field in enumerate optional fields 2 dcnl dcsp dcsp if field in fields dcnl dcsp dcsp dcsp optionalfi data fields index field dcnl dcsp khi2 nfree optional dcnl dcsp conf dict dcnl dcsp for field scale in zip optional fields2 conf scales dcnl dcsp dcsp if field in fields dcnl dcsp dcsp dcsp conffield split 0 scale data fields index field dcnl dcsp return dipole times pos amplitude ori gof name conf khi2 nfree
def dipole forwards fwd data whitener rr n jobs 1 dcsp b compute forwards meeg rr fwd data n jobs verbose false dcnl dcsp b np concatenate b axis 1 dcnl dcsp b orig b copy dcnl dcsp b np dot b whitener t dcnl dcsp scales np ones 3 dcnl dcsp return b b orig scales
def make guesses surf grid exclude mindist n jobs dcsp if rr in surf dcnl dcsp dcsp logger info guess dcsp surface dcsp s dcsp is dcsp in dcsp s dcsp coordinates bem explain surface surf id coord frame name surf coord frame dcnl dcsp else dcnl dcsp dcsp logger info making dcsp a dcsp spherical dcsp guess dcsp space dcsp with dcsp radius dcsp 7 1f dcsp mm 1000 surf r dcnl dcsp logger info filtering dcsp grid dcsp dcsp 6 f dcsp mm 1000 grid dcnl dcsp src make volume source space surf grid exclude 1000 mindist do neighbors false n jobs n jobs dcnl dcsp assert vertno in src dcnl dcsp src dict rr src rr src vertno nn src nn src vertno nuse src nuse coord frame src coord frame vertno np arange src nuse dcnl dcsp return sourcespaces src
def fit eval rd b b2 fwd svd none fwd data none whitener none dcsp if fwd svd is none dcnl dcsp dcsp fwd dipole forwards fwd data whitener rdnp newaxis 0 dcnl dcsp dcsp uu sing vv linalg svd fwd overwrite a true full matrices false dcnl dcsp else dcnl dcsp dcsp uu sing vv fwd svd dcnl dcsp gof dipole gof uu sing vv b b2 0 dcnl dcsp return 1 0 gof
def dipole gof uu sing vv b b2 dcsp ncomp 3 if sing2 sing0 0 2 else 2 dcnl dcsp one np dot vv ncomp b dcnl dcsp bm2 np sum one one dcnl dcsp gof bm2 b2 dcnl dcsp return gof one
def fit q fwd data whitener proj op b b2 b orig rd ori none dcsp if fwd in fwd data dcnl dcsp dcsp assert rd is none dcnl dcsp dcsp fwd fwd data fwd dcnl dcsp dcsp assert fwd shape0 3 dcnl dcsp dcsp fwd orig fwd data fwd orig dcnl dcsp dcsp assert fwd orig shape0 3 dcnl dcsp dcsp scales fwd data scales dcnl dcsp dcsp assert scales shape 3 dcnl dcsp dcsp fwd svd fwd data fwd svd 0 dcnl dcsp else dcnl dcsp dcsp fwd fwd orig scales dipole forwards fwd data whitener rdnp newaxis dcnl dcsp dcsp fwd svd none dcnl dcsp if ori is none dcnl dcsp dcsp if fwd svd is none dcnl dcsp dcsp dcsp fwd svd linalg svd fwd full matrices false dcnl dcsp dcsp uu sing vv fwd svd dcnl dcsp dcsp gof one dipole gof uu sing vv b b2 dcnl dcsp dcsp ncomp len one dcnl dcsp dcsp q scales0 np sum uu t ncomp one sing ncomp np newaxis axis 0 dcnl dcsp else dcnl dcsp dcsp fwd np dot orinp newaxis fwd dcnl dcsp dcsp sing np linalg norm fwd dcnl dcsp dcsp one np dot fwd sing b dcnl dcsp dcsp gof one one 0 b2 dcnl dcsp dcsp q ori scales0 np sum one sing dcnl dcsp dcsp ncomp 3 dcnl dcsp b residual compute residual proj op b orig fwd orig q dcnl dcsp return q gof b residual ncomp
def compute residual proj op b orig fwd orig q dcsp return np dot proj op b orig np dot np dot q fwd orig proj op t
def fit dipoles fun min dist to inner skull data times guess rrs guess data fwd data whitener proj op ori n jobs rank dcsp from scipy optimize import fmin cobyla dcnl dcsp parallel p fun parallel func fun n jobs dcnl dcsp res parallel p fun min dist to inner skull b t guess rrs guess data fwd data whitener proj op fmin cobyla ori rank for b t in zip data t times dcnl dcsp pos np array r0 for r in res dcnl dcsp amp np array r1 for r in res dcnl dcsp ori np array r2 for r in res dcnl dcsp gof np array r3 for r in res 100 dcnl dcsp conf none dcnl dcsp if res04 is not none dcnl dcsp dcsp conf np array r4 for r in res dcnl dcsp dcsp keys vol depth long trans qlong qtrans dcnl dcsp dcsp conf key conf ki for ki key in enumerate keys dcnl dcsp khi2 np array r5 for r in res dcnl dcsp nfree np array r6 for r in res dcnl dcsp residual np array r7 for r in res t dcnl dcsp return pos amp ori gof conf khi2 nfree residual
def surface constraint rd surf min dist to inner skull dcsp dist compute nearest surf rr rdnp newaxis return dists true 10 dcnl dcsp if points outside surface rdnp newaxis surf 1 0 dcnl dcsp dcsp dist 1 0 dcnl dcsp dist min dist to inner skull dcnl dcsp return dist
def sphere constraint rd r0 r adj dcsp return r adj np sqrt np sum rd r0 2
def fit dipole min dist to inner skull b orig t guess rrs guess data fwd data whitener proj op fmin cobyla ori rank dcsp b np dot whitener b orig dcnl dcsp if rr in fwd data inner skull dcnl dcsp dcsp surf fwd data inner skull dcnl dcsp dcsp constraint partial surface constraint surf surf min dist to inner skull min dist to inner skull dcnl dcsp else dcnl dcsp dcsp surf none dcnl dcsp dcsp constraint partial sphere constraint r0 fwd data inner skull r0 r adj fwd data inner skull r min dist to inner skull dcnl dcsp b2 np dot b b dcnl dcsp if b2 0 dcnl dcsp dcsp warn zero dcsp field dcsp found dcsp for dcsp time dcsp s t dcnl dcsp dcsp return np zeros 3 0 np zeros 3 0 b dcnl dcsp idx np argmin fit eval guess rrsfi b b2 fwd svd for fi fwd svd in enumerate guess data fwd svd dcnl dcsp x0 guess rrsidx dcnl dcsp fun partial fit eval b b b2 b2 fwd data fwd data whitener whitener dcnl dcsp rd final fmin cobyla fun x0 constraint consargs rhobeg 0 05 rhoend 5e05 disp false dcnl dcsp q gof residual n comp fit q fwd data whitener proj op b b2 b orig rd final ori ori dcnl dcsp khi2 1 gof b2 dcnl dcsp nfree rank n comp dcnl dcsp amp np sqrt np dot q q dcnl dcsp norm 1 0 if amp 0 0 else amp dcnl dcsp ori q norm dcnl dcsp conf fit confidence rd final q ori whitener fwd data proj op dcnl dcsp msg dcsp fitted dcsp dcsp 7 1f dcsp ms 1000 0 t dcnl dcsp if surf is not none dcnl dcsp dcsp dist to inner skull compute nearest surf rr rd finalnp newaxis return dists true 10 dcnl dcsp dcsp msg + dcsp distance dcsp to dcsp inner dcsp skull dcsp dcsp 2 4f dcsp mm dist to inner skull 1000 0 dcnl dcsp logger info msg dcnl dcsp return rd final amp ori gof conf khi2 nfree residual
def fit dipole fixed min dist to inner skull b orig t guess rrs guess data fwd data whitener proj op fmin cobyla ori rank dcsp b np dot whitener b orig dcnl dcsp b2 np dot b b dcnl dcsp if b2 0 dcnl dcsp dcsp warn zero dcsp field dcsp found dcsp for dcsp time dcsp s t dcnl dcsp dcsp return np zeros 3 0 np zeros 3 0 np zeros 6 dcnl dcsp q gof residual fit q guess data whitener proj op b b2 b orig rd none ori ori 3 dcnl dcsp if ori is none dcnl dcsp dcsp amp np sqrt np dot q q dcnl dcsp dcsp norm 1 0 if amp 0 0 else amp dcnl dcsp dcsp ori q norm dcnl dcsp else dcnl dcsp dcsp amp np dot q ori dcnl dcsp rd final guess rrs0 dcnl dcsp conf khi2 nfree none dcnl dcsp return rd final amp ori gof conf khi2 nfree residual
verbose dcnl def fit dipole evoked cov bem trans none min dist 5 0 n jobs 1 pos none ori none verbose none dcsp evoked evoked copy dcnl dcsp if needs eeg average ref proj evoked info dcnl dcsp dcsp raise valueerror eeg dcsp average dcsp reference dcsp is dcsp mandatory dcsp for dcsp dipole dcsp fitting dcnl dcsp if min dist < 0 dcnl dcsp dcsp raise valueerror min dist dcsp should dcsp be dcsp positive dcsp got dcsp s min dist dcnl dcsp if ori is not none and pos is none dcnl dcsp dcsp raise valueerror pos dcsp must dcsp be dcsp provided dcsp if dcsp ori dcsp is dcsp not dcsp none dcnl dcsp data evoked data dcnl dcsp if not np isfinite data all dcnl dcsp dcsp raise valueerror evoked dcsp data dcsp must dcsp be dcsp finite dcnl dcsp info evoked info dcnl dcsp times evoked times copy dcnl dcsp comment evoked comment dcnl dcsp min dist to inner skull min dist 1000 0 dcnl dcsp del min dist dcnl dcsp neeg len pick types info meg false eeg true ref meg false exclude dcnl dcsp if isinstance bem string types dcnl dcsp dcsp bem extra bem dcnl dcsp else dcnl dcsp dcsp bem extra repr bem dcnl dcsp dcsp logger info bem dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s bem extra dcnl dcsp if trans is not none dcnl dcsp dcsp logger info mri dcsp transform dcsp dcsp dcsp dcsp dcsp dcsp s trans dcnl dcsp dcsp mri head t trans get trans trans dcnl dcsp else dcnl dcsp dcsp mri head t transform head mri dcnl dcsp bem setup bem bem bem extra neeg mri head t verbose false dcnl dcsp if not bem is sphere dcnl dcsp dcsp if trans is none dcnl dcsp dcsp dcsp raise valueerror mri dcsp must dcsp not dcsp be dcsp none dcsp if dcsp bem dcsp is dcsp provided dcnl dcsp dcsp inner skull bem find surface bem inner skull dcnl dcsp dcsp inner skull inner skull copy dcnl dcsp dcsp r r0 fit sphere inner skull rr disp false dcnl dcsp dcsp r0 apply trans mri head t trans r0np newaxis 0 dcnl dcsp dcsp inner skull r0 r0 dcnl dcsp dcsp logger info head dcsp origin dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp 6 1f dcsp 6 1f dcsp 6 1f dcsp mm dcsp rad dcsp dcsp 6 1f dcsp mm 1000 r00 1000 r01 1000 r02 1000 r dcnl dcsp dcsp del r r0 dcnl dcsp else dcnl dcsp dcsp r0 bem r0 dcnl dcsp dcsp if len bem get layers 0 dcnl dcsp dcsp dcsp r bem layers 0 rad dcnl dcsp dcsp dcsp kind rad dcnl dcsp dcsp else dcnl dcsp dcsp dcsp r np dot linalg inv info dev head t trans np hstack r0 1 0 3 dcnl dcsp dcsp dcsp r r info chs pick loc 3 for pick in pick types info meg true exclude dcnl dcsp dcsp dcsp if len r 0 dcnl dcsp dcsp dcsp dcsp raise runtimeerror no dcsp meg dcsp channels dcsp found dcsp but dcsp megonly dcsp sphere dcsp model dcsp used dcnl dcsp dcsp dcsp r np min np sqrt np sum r r axis 1 dcnl dcsp dcsp dcsp kind max rad dcnl dcsp dcsp logger info sphere dcsp model dcsp dcsp dcsp dcsp dcsp dcsp dcsp origin dcsp at dcsp dcsp 7 2f dcsp dcsp 7 2f dcsp dcsp 7 2f dcsp mm dcsp s dcsp dcsp 6 1f dcsp mm 1000 r00 1000 r01 1000 r02 kind r dcnl dcsp dcsp inner skull dict r r r0 r0 dcnl dcsp dcsp del r r0 dcnl dcsp accurate false dcnl dcsp if pos is not none dcnl dcsp dcsp fixed position true dcnl dcsp dcsp pos np array pos float dcnl dcsp dcsp if pos shape 3 dcnl dcsp dcsp dcsp raise valueerror pos dcsp must dcsp be dcsp none dcsp or dcsp a dcsp 3element dcsp arraylike dcsp got dcsp s pos dcnl dcsp dcsp logger info fixed dcsp position dcsp dcsp dcsp dcsp dcsp 6 1f dcsp 6 1f dcsp 6 1f dcsp mm tuple 1000 pos dcnl dcsp dcsp if ori is not none dcnl dcsp dcsp dcsp ori np array ori float dcnl dcsp dcsp dcsp if ori shape 3 dcnl dcsp dcsp dcsp dcsp raise valueerror oris dcsp must dcsp be dcsp none dcsp or dcsp a dcsp 3element dcsp arraylike dcsp got dcsp s ori dcnl dcsp dcsp dcsp norm np sqrt np sum ori ori dcnl dcsp dcsp dcsp if not np isclose norm 1 dcnl dcsp dcsp dcsp dcsp raise valueerror ori dcsp must dcsp be dcsp a dcsp unit dcsp vector dcsp got dcsp length dcsp s norm dcnl dcsp dcsp dcsp logger info fixed dcsp orientation dcsp dcsp dcsp 6 4f dcsp 6 4f dcsp 6 4f dcsp mm tuple ori dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info free dcsp orientation dcsp dcsp dcsp dcsp <timevarying dcnl dcsp dcsp fit n jobs 1 dcnl dcsp else dcnl dcsp dcsp fixed position false dcnl dcsp dcsp guess grid 0 02 dcnl dcsp dcsp guess mindist max 0 005 min dist to inner skull dcnl dcsp dcsp guess exclude 0 02 dcnl dcsp dcsp logger info guess dcsp grid dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp 6 1f dcsp mm 1000 guess grid dcnl dcsp dcsp if guess mindist 0 0 dcnl dcsp dcsp dcsp logger info guess dcsp mindist dcsp dcsp dcsp dcsp dcsp dcsp 6 1f dcsp mm 1000 guess mindist dcnl dcsp dcsp if guess exclude 0 dcnl dcsp dcsp dcsp logger info guess dcsp exclude dcsp dcsp dcsp dcsp dcsp dcsp 6 1f dcsp mm 1000 guess exclude dcnl dcsp dcsp logger info using dcsp s dcsp meg dcsp coil dcsp definitions accurate if accurate else standard dcnl dcsp dcsp fit n jobs n jobs dcnl dcsp if isinstance cov string types dcnl dcsp dcsp logger info noise dcsp covariance dcsp dcsp dcsp s cov dcnl dcsp dcsp cov read cov cov verbose false dcnl dcsp logger info dcnl dcsp print coord trans mri head t dcnl dcsp print coord trans info dev head t dcnl dcsp logger info d dcsp bad dcsp channels dcsp total len info bads dcnl dcsp ch types channel type info idx for idx in range info nchan dcnl dcsp megcoils compcoils megnames meg info none dcnl dcsp eegels eegnames dcnl dcsp if grad in ch types or mag in ch types dcnl dcsp dcsp megcoils compcoils megnames meg info prep meg channels info exclude bads accurate accurate verbose verbose dcnl dcsp if eeg in ch types dcnl dcsp dcsp eegels eegnames prep eeg channels info exclude bads verbose verbose dcnl dcsp if len megcoils + eegels 0 dcnl dcsp dcsp raise runtimeerror no dcsp meg dcsp or dcsp eeg dcsp channels dcsp found dcnl dcsp logger info decomposing dcsp the dcsp sensor dcsp noise dcsp covariance dcsp matrix dcnl dcsp picks pick types info meg true eeg true ref meg false dcnl dcsp whitener rank get whitener data info cov picks verbose false dcnl dcsp if fixed position dcnl dcsp dcsp guess src dict nuse 1 rr posnp newaxis inuse np array true dcnl dcsp dcsp logger info compute dcsp forward dcsp for dcsp dipole dcsp location dcnl dcsp else dcnl dcsp dcsp logger info n dcsp computing dcsp the dcsp forward dcsp solution dcsp for dcsp the dcsp guesses dcnl dcsp dcsp guess src make guesses inner skull guess grid guess exclude guess mindist n jobs n jobs 0 dcnl dcsp dcsp transform surface to guess src head mri head t dcnl dcsp dcsp logger info go dcsp through dcsp all dcsp guess dcsp source dcsp locations dcnl dcsp if rr in inner skull dcnl dcsp dcsp transform surface to inner skull head mri head t dcnl dcsp if fixed position dcnl dcsp dcsp if rr in inner skull dcnl dcsp dcsp dcsp check surface constraint pos inner skull min dist to inner skull dcnl dcsp dcsp else dcnl dcsp dcsp dcsp check sphere constraint pos inner skull r0 r adj inner skull r min dist to inner skull dcnl dcsp dcsp if check < 0 dcnl dcsp dcsp dcsp raise valueerror fixed dcsp position dcsp is dcsp 0 1fmm dcsp outside dcsp the dcsp inner dcsp skull dcsp boundary 1000 check dcnl dcsp fwd data dict coils list megcoils eegels infos meg info none ccoils list compcoils none coil types meg eeg inner skull inner skull dcnl dcsp prep field computation guess src rr bem fwd data n jobs verbose false dcnl dcsp guess fwd guess fwd orig guess fwd scales dipole forwards fwd data whitener guess src rr n jobs fit n jobs dcnl dcsp guess fwd svd linalg svd fwd overwrite a false full matrices false for fwd in np array split guess fwd len guess src rr dcnl dcsp guess data dict fwd guess fwd fwd svd guess fwd svd fwd orig guess fwd orig scales guess fwd scales dcnl dcsp del guess fwd guess fwd svd guess fwd orig guess fwd scales dcnl dcsp logger info done dcsp d dcsp source s guess src nuse pl guess src nuse dcnl dcsp data datapicks dcnl dcsp ch names info ch names p for p in picks dcnl dcsp proj op make projector info projs ch names info bads 0 dcnl dcsp fun fit dipole fixed if fixed position else fit dipole dcnl dcsp out fit dipoles fun min dist to inner skull data times guess src rr guess data fwd data whitener proj op ori n jobs rank dcnl dcsp assert len out 8 dcnl dcsp if fixed position and ori is not none dcnl dcsp dcsp data np array out1 out3 dcnl dcsp dcsp out info deepcopy info dcnl dcsp dcsp loc np concatenate pos ori np zeros 6 dcnl dcsp dcsp out info chs dict ch name dip dcsp 01 loc loc kind fiff fiffv dipole wave coord frame fiff fiffv coord unknown unit fiff fiff unit am coil type fiff fiffv coil dipole unit mul 0 range 1 cal 1 0 scanno 1 logno 1 dict ch name goodness loc np zeros 12 kind fiff fiffv goodness fit unit fiff fiff unit am coord frame fiff fiffv coord unknown coil type fiff fiffv coil none unit mul 0 range 1 0 cal 1 0 scanno 2 logno 100 dcnl dcsp dcsp for key in hpi meas hpi results projs dcnl dcsp dcsp dcsp out infokey list dcnl dcsp dcsp for key in acq pars acq stim description dig experimenter hpi subsystem proj id proj name subject info dcnl dcsp dcsp dcsp out infokey none dcnl dcsp dcsp out info update redundant dcnl dcsp dcsp out info check consistency dcnl dcsp dcsp dipoles dipolefixed out info data times evoked nave evoked aspect kind evoked first evoked last comment dcnl dcsp else dcnl dcsp dcsp dipoles dipole times out0 out1 out2 out3 comment out4 out5 out6 dcnl dcsp residual out 1 dcnl dcsp logger info d dcsp time dcsp points dcsp fitted len dipoles times dcnl dcsp return dipoles residual
def get phantom dipoles kind vectorview dcsp valid types vectorview otaniemi dcnl dcsp if not isinstance kind string types or kind not in valid types dcnl dcsp dcsp raise valueerror kind dcsp must dcsp be dcsp one dcsp of dcsp s dcsp got dcsp s valid types kind dcnl dcsp if kind vectorview dcnl dcsp dcsp a np array 59 7 48 6 35 8 24 8 37 2 27 5 15 8 7 9 dcnl dcsp dcsp b np array 46 1 41 9 38 3 31 5 13 9 16 2 20 0 19 3 dcnl dcsp dcsp x np concatenate a 0 8 b 0 8 dcnl dcsp dcsp y np concatenate 0 8 a 0 8 b dcnl dcsp dcsp c 22 9 23 5 25 5 23 1 52 0 46 4 41 0 33 0 dcnl dcsp dcsp d 44 4 34 0 21 6 12 7 62 4 51 5 39 1 27 9 dcnl dcsp dcsp z np concatenate c c d d dcnl dcsp elif kind otaniemi dcnl dcsp dcsp a np array 56 3 47 6 39 0 30 3 dcnl dcsp dcsp b np array 32 5 27 5 22 5 17 5 dcnl dcsp dcsp c np zeros 4 dcnl dcsp dcsp x np concatenate a b c c a b c c dcnl dcsp dcsp y np concatenate c c a b c c b a dcnl dcsp dcsp z np concatenate b a b a b a a b dcnl dcsp pos np vstack x y z t 1000 0 dcnl dcsp ori list dcnl dcsp for this pos in pos dcnl dcsp dcsp this ori np zeros 3 dcnl dcsp dcsp idx np where this pos 0 0 dcnl dcsp dcsp idx np setdiff1d np arange 3 idx0 dcnl dcsp dcsp this oriidx this posidx 1 np linalg norm this posidx 1 1 dcnl dcsp dcsp ori append this ori dcnl dcsp ori np array ori dcnl dcsp return pos ori
def concatenate dipoles dipoles dcsp times pos amplitude ori gof dcnl dcsp for dipole in dipoles dcnl dcsp dcsp times append dipole times dcnl dcsp dcsp pos append dipole pos dcnl dcsp dcsp amplitude append dipole amplitude dcnl dcsp dcsp ori append dipole ori dcnl dcsp dcsp gof append dipole gof dcnl dcsp return dipole np concatenate times np concatenate pos np concatenate amplitude np concatenate ori np concatenate gof name none
def blend colors color 1 color 2 dcsp if color 1 is none and color 2 is none dcnl dcsp dcsp return none dcnl dcsp elif color 1 is none dcnl dcsp dcsp return color 2 dcnl dcsp elif color 2 is none dcnl dcsp dcsp return color 1 dcnl dcsp r 1 g 1 b 1 a 1 color 1 dcnl dcsp h 1 s 1 v 1 rgb to hsv r 1 g 1 b 1 dcnl dcsp r 2 g 2 b 2 a 2 color 2 dcnl dcsp h 2 s 2 v 2 rgb to hsv r 2 g 2 b 2 dcnl dcsp hue diff abs h 1 h 2 dcnl dcsp if hue diff < 0 5 dcnl dcsp dcsp h min h 1 h 2 + hue diff 2 0 dcnl dcsp else dcnl dcsp dcsp h max h 1 h 2 + 1 0 hue diff 2 0 dcnl dcsp dcsp h 1 0 dcnl dcsp s s 1 + s 2 2 0 dcnl dcsp v v 1 + v 2 2 0 dcnl dcsp r g b hsv to rgb h s v dcnl dcsp a a 1 + a 2 2 0 dcnl dcsp color r g b a dcnl dcsp return color
def split colors color n dcsp r g b a color dcnl dcsp h s v rgb to hsv r g b dcnl dcsp gradient range np sqrt n 10 0 dcnl dcsp if v 0 5 dcnl dcsp dcsp v max min 0 95 v + gradient range 2 dcnl dcsp dcsp v min max 0 05 v max gradient range dcnl dcsp else dcnl dcsp dcsp v min max 0 05 v gradient range 2 dcnl dcsp dcsp v max min 0 95 v min + gradient range dcnl dcsp hsv colors h s v for v in np linspace v min v max n dcnl dcsp rgb colors hsv to rgb h s v for h s v in hsv colors dcnl dcsp rgba colors r g b a for r g b in rgb colors dcnl dcsp return tuple rgba colors
def n colors n bytes false cmap hsv dcsp n max 2 10 dcnl dcsp if n n max dcnl dcsp dcsp raise notimplementederror can t dcsp produce dcsp more dcsp than dcsp i dcsp unique dcsp colors n max dcnl dcsp from matplotlib cm import get cmap dcnl dcsp cm get cmap cmap n max dcnl dcsp pos np linspace 0 1 n false dcnl dcsp colors cm pos bytes bytes dcnl dcsp if bytes dcnl dcsp dcsp for ii c in enumerate colors dcnl dcsp dcsp dcsp if np any np all colors ii c 1 dcnl dcsp dcsp dcsp dcsp raise runtimeerror could dcsp not dcsp get dcsp d dcsp unique dcsp colors dcsp from dcsp s dcsp colormap dcsp try dcsp using dcsp a dcsp different dcsp colormap n cmap dcnl dcsp return colors
def read label filename subject none color none dcsp if subject is not none and not isinstance subject string types dcnl dcsp dcsp raise typeerror subject dcsp must dcsp be dcsp a dcsp string dcnl dcsp basename op basename filename dcnl dcsp if basename endswith lh label or basename startswith lh dcnl dcsp dcsp hemi lh dcnl dcsp elif basename endswith rh label or basename startswith rh dcnl dcsp dcsp hemi rh dcnl dcsp else dcnl dcsp dcsp raise valueerror cannot dcsp find dcsp which dcsp hemisphere dcsp it dcsp is dcsp file dcsp should dcsp end dcsp with dcsp lh label dcsp or dcsp rh label dcnl dcsp if basename startswith lh rh dcnl dcsp dcsp basename basename3 dcnl dcsp dcsp if basename endswith label dcnl dcsp dcsp dcsp basename basename 6 dcnl dcsp else dcnl dcsp dcsp basename basename 9 dcnl dcsp name s s basename hemi dcnl dcsp with open filename r as fid dcnl dcsp dcsp comment fid readline replace n 1 dcnl dcsp dcsp nv int fid readline dcnl dcsp dcsp data np empty 5 nv dcnl dcsp dcsp for i line in enumerate fid dcnl dcsp dcsp dcsp data i line split dcnl dcsp vertices np array data0 dtype np int32 dcnl dcsp pos 0 001 data1 4 t dcnl dcsp values data4 dcnl dcsp order np argsort vertices dcnl dcsp vertices verticesorder dcnl dcsp pos posorder dcnl dcsp values valuesorder dcnl dcsp label label vertices pos values hemi comment name filename subject color dcnl dcsp return label
verbose dcnl def write label filename label verbose none dcsp hemi label hemi dcnl dcsp path head name op split filename dcnl dcsp if name endswith label dcnl dcsp dcsp name name 6 dcnl dcsp if not name startswith hemi or name endswith hemi dcnl dcsp dcsp name + + hemi dcnl dcsp filename op join path head name + label dcnl dcsp logger info saving dcsp label dcsp to dcsp dcsp s filename dcnl dcsp with open filename wb as fid dcnl dcsp dcsp n vertices len label vertices dcnl dcsp dcsp data np zeros n vertices 5 dtype np float dcnl dcsp dcsp data 0 label vertices dcnl dcsp dcsp data 1 4 1000 0 label pos dcnl dcsp dcsp data 4 label values dcnl dcsp dcsp fid write b s n label comment dcnl dcsp dcsp fid write b d n n vertices dcnl dcsp dcsp for d in data dcnl dcsp dcsp dcsp fid write b d dcsp f dcsp f dcsp f dcsp f n tuple d dcnl dcsp return label
def prep label split label subject none subjects dir none dcsp if isinstance label bihemilabel dcnl dcsp dcsp raise typeerror can dcsp only dcsp split dcsp labels dcsp restricted dcsp to dcsp one dcsp hemisphere dcnl dcsp elif isinstance label string types dcnl dcsp dcsp label read label label dcnl dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp if label subject is none and subject is none dcnl dcsp dcsp raise valueerror the dcsp subject dcsp needs dcsp to dcsp be dcsp specified dcnl dcsp elif subject is none dcnl dcsp dcsp subject label subject dcnl dcsp elif label subject is none dcnl dcsp dcsp pass dcnl dcsp elif subject label subject dcnl dcsp dcsp raise valueerror the dcsp label dcsp specifies dcsp a dcsp different dcsp subject dcsp r dcsp from dcsp the dcsp subject dcsp parameter dcsp r label subject subject dcnl dcsp return label subject subjects dir
def split label contig label to split subject none subjects dir none dcsp label to split subject subjects dir prep label split label to split subject subjects dir dcnl dcsp surf fname join label to split hemi sphere dcnl dcsp surf path op join subjects dir subject surf surf fname dcnl dcsp surface points surface tris read surface surf path dcnl dcsp verts arr label to split vertices dcnl dcsp edges all mesh edges surface tris dcnl dcsp select edges edges allverts arr verts arr tocoo dcnl dcsp comp labels get components verts arr select edges dcnl dcsp label divs dcnl dcsp for comp in comp labels dcnl dcsp dcsp label divs append verts arrcomp dcnl dcsp n parts len label divs dcnl dcsp if label to split name endswith lh rh dcnl dcsp dcsp basename label to split name 3 dcnl dcsp dcsp name ext label to split name 3 dcnl dcsp else dcnl dcsp dcsp basename label to split name dcnl dcsp dcsp name ext dcnl dcsp name pattern s div i s basename name ext dcnl dcsp names tuple name pattern i for i in range 1 n parts + 1 dcnl dcsp if label to split color is none dcnl dcsp dcsp colors none n parts dcnl dcsp else dcnl dcsp dcsp colors split colors label to split color n parts dcnl dcsp label divs sort key lambda x len x reverse true dcnl dcsp labels dcnl dcsp for div name color in zip label divs names colors dcnl dcsp dcsp verts np array sorted list div dcnl dcsp dcsp vert indices np in1d verts arr verts assume unique true dcnl dcsp dcsp pos label to split posvert indices dcnl dcsp dcsp values label to split valuesvert indices dcnl dcsp dcsp hemi label to split hemi dcnl dcsp dcsp comment label to split comment dcnl dcsp dcsp lbl label verts pos values hemi comment name none subject color dcnl dcsp dcsp labels append lbl dcnl dcsp return labels
def split label label parts 2 subject none subjects dir none freesurfer false dcsp label subject subjects dir prep label split label subject subjects dir dcnl dcsp if np isscalar parts dcnl dcsp dcsp n parts int parts dcnl dcsp dcsp if label name endswith lh rh dcnl dcsp dcsp dcsp basename label name 3 dcnl dcsp dcsp dcsp name ext label name 3 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp basename label name dcnl dcsp dcsp dcsp name ext dcnl dcsp dcsp name pattern s div i s basename name ext dcnl dcsp dcsp names tuple name pattern i for i in range 1 n parts + 1 dcnl dcsp else dcnl dcsp dcsp names parts dcnl dcsp dcsp n parts len names dcnl dcsp if n parts < 2 dcnl dcsp dcsp raise valueerror can t dcsp split dcsp label dcsp into dcsp i dcsp parts n parts dcnl dcsp surf fname join label hemi sphere dcnl dcsp surf path op join subjects dir subject surf surf fname dcnl dcsp surface points surface tris read surface surf path dcnl dcsp points surface pointslabel vertices dcnl dcsp center np mean points axis 0 dcnl dcsp centered points points center dcnl dcsp if freesurfer dcnl dcsp dcsp distance np sqrt np sum centered points 2 axis 1 dcnl dcsp dcsp i closest np argmin distance dcnl dcsp dcsp closest vertex label verticesi closest dcnl dcsp dcsp idx np any surface tris closest vertex axis 1 dcnl dcsp dcsp tris for normal surface trisidx dcnl dcsp dcsp r1 surface pointstris for normal 0 dcnl dcsp dcsp r2 surface pointstris for normal 1 dcnl dcsp dcsp r3 surface pointstris for normal 2 dcnl dcsp dcsp tri normals fast cross 3d r2 r1 r3 r1 dcnl dcsp dcsp normal np mean tri normals axis 0 dcnl dcsp dcsp normal linalg norm normal dcnl dcsp else dcnl dcsp dcsp normal center linalg norm center dcnl dcsp q linalg qr normal np newaxis dcnl dcsp tangent u q 1 dcnl dcsp m obs np dot centered points tangent u dcnl dcsp m cov np dot m obs t m obs dcnl dcsp w vr linalg eig m cov dcnl dcsp i np argmax w dcnl dcsp eigendir vr i dcnl dcsp axis np dot tangent u eigendir dcnl dcsp if axis1 < 0 dcnl dcsp dcsp axis 1 dcnl dcsp proj np dot points axis dcnl dcsp proj proj min dcnl dcsp proj proj max n parts dcnl dcsp mark proj 1 dcnl dcsp mark mark n parts n parts 1 dcnl dcsp if label color is none dcnl dcsp dcsp colors none n parts dcnl dcsp else dcnl dcsp dcsp colors split colors label color n parts dcnl dcsp labels dcnl dcsp for i name color in zip range n parts names colors dcnl dcsp dcsp idx mark i dcnl dcsp dcsp vert label verticesidx dcnl dcsp dcsp pos label posidx dcnl dcsp dcsp values label valuesidx dcnl dcsp dcsp hemi label hemi dcnl dcsp dcsp comment label comment dcnl dcsp dcsp lbl label vert pos values hemi comment name none subject color dcnl dcsp dcsp labels append lbl dcnl dcsp return labels
def label sign flip label src dcsp if len src 2 dcnl dcsp dcsp raise valueerror only dcsp source dcsp spaces dcsp with dcsp 2 dcsp hemisphers dcsp are dcsp accepted dcnl dcsp lh vertno src0 vertno dcnl dcsp rh vertno src1 vertno dcnl dcsp if label hemi lh dcnl dcsp dcsp vertno sel np intersect1d lh vertno label vertices dcnl dcsp dcsp if len vertno sel 0 dcnl dcsp dcsp dcsp return np array int dcnl dcsp dcsp ori src0 nn vertno sel dcnl dcsp elif label hemi rh dcnl dcsp dcsp vertno sel np intersect1d rh vertno label vertices dcnl dcsp dcsp if len vertno sel 0 dcnl dcsp dcsp dcsp return np array int dcnl dcsp dcsp ori src1 nn vertno sel dcnl dcsp else dcnl dcsp dcsp raise exception unknown dcsp hemisphere dcsp type dcnl dcsp vh linalg svd ori full matrices false dcnl dcsp flip np sign np dot ori vh0 dcnl dcsp return flip
def stc to label stc src none smooth true connected false subjects dir none dcsp if not isinstance smooth bool dcnl dcsp dcsp raise valueerror smooth dcsp should dcsp be dcsp true dcsp or dcsp false dcsp got dcsp s smooth dcnl dcsp src stc subject if src is none else src dcnl dcsp if src is none dcnl dcsp dcsp raise valueerror src dcsp cannot dcsp be dcsp none dcsp if dcsp stc subject dcsp is dcsp none dcnl dcsp if isinstance src string types dcnl dcsp dcsp subject src dcnl dcsp else dcnl dcsp dcsp subject stc subject dcnl dcsp if not isinstance stc sourceestimate dcnl dcsp dcsp raise valueerror sourceestimate dcsp should dcsp be dcsp surface dcsp source dcsp estimates dcnl dcsp if isinstance src string types dcnl dcsp dcsp if connected dcnl dcsp dcsp dcsp raise valueerror the dcsp option dcsp to dcsp return dcsp only dcsp connected dcsp labels dcsp is dcsp only dcsp available dcsp if dcsp source dcsp spaces dcsp are dcsp provided dcnl dcsp dcsp if smooth dcnl dcsp dcsp dcsp msg stc to label dcsp with dcsp smooth true dcsp requires dcsp src dcsp to dcsp be dcsp an dcsp instance dcsp of dcsp sourcespace dcnl dcsp dcsp dcsp raise valueerror msg dcnl dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp surf path from op join subjects dir src surf dcnl dcsp dcsp rr lh tris lh read surface op join surf path from lh white dcnl dcsp dcsp rr rh tris rh read surface op join surf path from rh white dcnl dcsp dcsp rr rr lh rr rh dcnl dcsp dcsp tris tris lh tris rh dcnl dcsp else dcnl dcsp dcsp if not isinstance src sourcespaces dcnl dcsp dcsp dcsp raise typeerror src dcsp must dcsp be dcsp a dcsp string dcsp or dcsp a dcsp set dcsp of dcsp source dcsp spaces dcnl dcsp dcsp if len src 2 dcnl dcsp dcsp dcsp raise valueerror source dcsp space dcsp should dcsp contain dcsp the dcsp 2 dcsp hemispheres dcnl dcsp dcsp rr 1000 0 src0 rr 1000 0 src1 rr dcnl dcsp dcsp tris src0 tris src1 tris dcnl dcsp dcsp src conn spatial src connectivity src tocsr dcnl dcsp labels dcnl dcsp cnt 0 dcnl dcsp cnt full 0 dcnl dcsp for hemi idx hemi this vertno this tris this rr in enumerate zip lh rh stc vertices tris rr dcnl dcsp dcsp this data stc datacnt cnt + len this vertno dcnl dcsp dcsp e mesh edges this tris dcnl dcsp dcsp e data e data 2 1 dcnl dcsp dcsp n vertices e shape0 dcnl dcsp dcsp e e + sparse eye n vertices n vertices dcnl dcsp dcsp if connected dcnl dcsp dcsp dcsp vertno np where srchemi idx inuse 0 dcnl dcsp dcsp dcsp if not len np setdiff1d this vertno vertno 0 dcnl dcsp dcsp dcsp dcsp raise runtimeerror stc dcsp contains dcsp vertices dcsp not dcsp present dcsp in dcsp source dcsp space dcsp did dcsp you dcsp morph dcnl dcsp dcsp dcsp tmp np zeros len vertno this data shape1 dcnl dcsp dcsp dcsp this vertno idx np searchsorted vertno this vertno dcnl dcsp dcsp dcsp tmpthis vertno idx this data dcnl dcsp dcsp dcsp this data tmp dcnl dcsp dcsp dcsp offset cnt full + len this data dcnl dcsp dcsp dcsp this src conn src conncnt full offset cnt full offset tocoo dcnl dcsp dcsp dcsp this data abs max np abs this data max axis 1 dcnl dcsp dcsp dcsp clusters find clusters this data abs max 0 0 connectivity this src conn dcnl dcsp dcsp dcsp cnt full + len this data dcnl dcsp dcsp dcsp clusters max np argsort np max this data abs maxc for c in clusters 1 dcnl dcsp dcsp dcsp clusters clustersk for k in clusters max dcnl dcsp dcsp dcsp clusters vertnoc for c in clusters dcnl dcsp dcsp else dcnl dcsp dcsp dcsp clusters this vertnonp any this data axis 1 dcnl dcsp dcsp cnt + len this vertno dcnl dcsp dcsp clusters c for c in clusters if len c 0 dcnl dcsp dcsp if len clusters 0 dcnl dcsp dcsp dcsp if not connected dcnl dcsp dcsp dcsp dcsp this labels none dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this labels dcnl dcsp dcsp else dcnl dcsp dcsp dcsp this labels dcnl dcsp dcsp dcsp colors n colors len clusters dcnl dcsp dcsp dcsp for c color in zip clusters colors dcnl dcsp dcsp dcsp dcsp idx use c dcnl dcsp dcsp dcsp dcsp label label idx use this rridx use none hemi label dcsp from dcsp stc subject subject color color dcnl dcsp dcsp dcsp dcsp if smooth dcnl dcsp dcsp dcsp dcsp dcsp label label fill src dcnl dcsp dcsp dcsp dcsp this labels append label dcnl dcsp dcsp dcsp if not connected dcnl dcsp dcsp dcsp dcsp this labels this labels0 dcnl dcsp dcsp labels append this labels dcnl dcsp return labels
def verts within dist graph sources max dist dcsp dist map dcnl dcsp verts added last dcnl dcsp for source in sources dcnl dcsp dcsp dist mapsource 0 dcnl dcsp dcsp verts added last append source dcnl dcsp while len verts added last 0 dcnl dcsp dcsp verts added dcnl dcsp dcsp for i in verts added last dcnl dcsp dcsp dcsp v dist dist mapi dcnl dcsp dcsp dcsp row graphi dcnl dcsp dcsp dcsp neighbor vert row indices dcnl dcsp dcsp dcsp neighbor dist row data dcnl dcsp dcsp dcsp for j d in zip neighbor vert neighbor dist dcnl dcsp dcsp dcsp dcsp n dist v dist + d dcnl dcsp dcsp dcsp dcsp if j in dist map dcnl dcsp dcsp dcsp dcsp dcsp if n dist < dist mapj dcnl dcsp dcsp dcsp dcsp dcsp dcsp dist mapj n dist dcnl dcsp dcsp dcsp dcsp elif n dist < max dist dcnl dcsp dcsp dcsp dcsp dcsp dist mapj n dist dcnl dcsp dcsp dcsp dcsp dcsp verts added append j dcnl dcsp dcsp verts added last verts added dcnl dcsp verts np sort np array list dist map keys dtype np int dcnl dcsp dist np array dist mapv for v in verts dcnl dcsp return verts dist
def grow labels seeds extents hemis names dist vert subject dcsp labels dcnl dcsp for seed extent hemi name in zip seeds extents hemis names dcnl dcsp dcsp label verts label dist verts within dist disthemi seed extent dcnl dcsp dcsp if len seed 1 dcnl dcsp dcsp dcsp seed repr str seed dcnl dcsp dcsp else dcnl dcsp dcsp dcsp seed repr join map str seed dcnl dcsp dcsp comment circular dcsp label dcsp seed s dcsp extent 0 1fmm seed repr extent dcnl dcsp dcsp label label vertices label verts pos verthemilabel verts values label dist hemi hemi comment comment name str name subject subject dcnl dcsp dcsp labels append label dcnl dcsp return labels
def grow labels subject seeds extents hemis subjects dir none n jobs 1 overlap true names none surface white dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp n jobs check n jobs n jobs dcnl dcsp if np isscalar seeds dcnl dcsp dcsp seeds seeds dcnl dcsp seeds np atleast 1d np atleast 1d seed for seed in seeds dcnl dcsp extents np atleast 1d extents dcnl dcsp hemis np atleast 1d hemis dcnl dcsp n seeds len seeds dcnl dcsp if len extents 1 and len extents n seeds dcnl dcsp dcsp raise valueerror the dcsp extents dcsp parameter dcsp has dcsp to dcsp be dcsp of dcsp length dcsp 1 dcsp or dcsp len seeds dcnl dcsp if len hemis 1 and len hemis n seeds dcnl dcsp dcsp raise valueerror the dcsp hemis dcsp parameter dcsp has dcsp to dcsp be dcsp of dcsp length dcsp 1 dcsp or dcsp len seeds dcnl dcsp if len extents 1 dcnl dcsp dcsp extents np tile extents n seeds dcnl dcsp if len hemis 1 dcnl dcsp dcsp hemis np tile hemis n seeds dcnl dcsp hemis np array lh if h 0 else rh for h in hemis dcnl dcsp if names is none dcnl dcsp dcsp names label i s items for items in enumerate hemis dcnl dcsp else dcnl dcsp dcsp if np isscalar names dcnl dcsp dcsp dcsp names names dcnl dcsp dcsp if len names n seeds dcnl dcsp dcsp dcsp raise valueerror the dcsp names dcsp parameter dcsp has dcsp to dcsp be dcsp none dcsp or dcsp have dcsp length dcsp len seeds dcnl dcsp dcsp for i hemi in enumerate hemis dcnl dcsp dcsp dcsp if not namesi endswith hemi dcnl dcsp dcsp dcsp dcsp namesi join namesi hemi dcnl dcsp names np array names dcnl dcsp tris vert dist dcnl dcsp for hemi in set hemis dcnl dcsp dcsp surf fname op join subjects dir subject surf hemi + + surface dcnl dcsp dcsp verthemi trishemi read surface surf fname dcnl dcsp dcsp disthemi mesh dist trishemi verthemi dcnl dcsp if overlap dcnl dcsp dcsp parallel my grow labels parallel func grow labels n jobs dcnl dcsp dcsp seeds np array split seeds n jobs dcnl dcsp dcsp extents np array split extents n jobs dcnl dcsp dcsp hemis np array split hemis n jobs dcnl dcsp dcsp names np array split names n jobs dcnl dcsp dcsp labels sum parallel my grow labels s e h n dist vert subject for s e h n in zip seeds extents hemis names dcnl dcsp else dcnl dcsp dcsp labels grow nonoverlapping labels subject seeds extents hemis vert dist names dcnl dcsp colors n colors len labels dcnl dcsp for label color in zip labels colors dcnl dcsp dcsp label color color dcnl dcsp return labels
def grow nonoverlapping labels subject seeds extents hemis vertices graphs names dcsp labels dcnl dcsp for hemi in set hemis dcnl dcsp dcsp hemi index hemis hemi dcnl dcsp dcsp seeds seeds hemi index dcnl dcsp dcsp extents extents hemi index dcnl dcsp dcsp names names hemi index dcnl dcsp dcsp graph graphshemi dcnl dcsp dcsp n vertices len vertices hemi dcnl dcsp dcsp n labels len seeds dcnl dcsp dcsp parc np empty n vertices dtype int32 dcnl dcsp dcsp parc 1 dcnl dcsp dcsp sources dcnl dcsp dcsp edge dcnl dcsp dcsp for label seed in enumerate seeds dcnl dcsp dcsp dcsp if np any parcseed 0 dcnl dcsp dcsp dcsp dcsp raise valueerror overlapping dcsp seeds dcnl dcsp dcsp dcsp parcseed label dcnl dcsp dcsp dcsp for s in np atleast 1d seed dcnl dcsp dcsp dcsp dcsp sourcess label 0 0 dcnl dcsp dcsp dcsp dcsp edge append s dcnl dcsp dcsp while edge dcnl dcsp dcsp dcsp vert from edge pop 0 dcnl dcsp dcsp dcsp label old dist sourcesvert from dcnl dcsp dcsp dcsp row graphvert from dcnl dcsp dcsp dcsp for vert to dist in zip row indices row data dcnl dcsp dcsp dcsp dcsp new dist old dist + dist dcnl dcsp dcsp dcsp dcsp if new dist extentslabel dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp vert to label parcvert to dcnl dcsp dcsp dcsp dcsp if vert to label 0 dcnl dcsp dcsp dcsp dcsp dcsp vert to dist sourcesvert to dcnl dcsp dcsp dcsp dcsp dcsp if new dist vert to dist dcnl dcsp dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp dcsp elif vert to in edge dcnl dcsp dcsp dcsp dcsp dcsp dcsp edge remove vert to dcnl dcsp dcsp dcsp dcsp parcvert to label dcnl dcsp dcsp dcsp dcsp sourcesvert to label new dist dcnl dcsp dcsp dcsp dcsp edge append vert to dcnl dcsp dcsp for i in xrange n labels dcnl dcsp dcsp dcsp vertices np nonzero parc i 0 dcnl dcsp dcsp dcsp name str namesi dcnl dcsp dcsp dcsp label label vertices hemi hemi name name subject subject dcnl dcsp dcsp dcsp labels append label dcnl dcsp return labels
def read annot fname dcsp if not op isfile fname dcnl dcsp dcsp dir name op split fname 0 dcnl dcsp dcsp if not op isdir dir name dcnl dcsp dcsp dcsp raise ioerror directory dcsp for dcsp annotation dcsp does dcsp not dcsp exist dcsp s fname dcnl dcsp dcsp cands os listdir dir name dcnl dcsp dcsp cands c for c in cands if annot in c dcnl dcsp dcsp if len cands 0 dcnl dcsp dcsp dcsp raise ioerror no dcsp such dcsp file dcsp s dcsp no dcsp candidate dcsp parcellations dcsp found dcsp in dcsp directory fname dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise ioerror no dcsp such dcsp file dcsp s dcsp candidate dcsp parcellations dcsp in dcsp that dcsp directory dcsp s fname dcsp join cands dcnl dcsp with open fname rb as fid dcnl dcsp dcsp n verts np fromfile fid i4 1 0 dcnl dcsp dcsp data np fromfile fid i4 n verts 2 reshape n verts 2 dcnl dcsp dcsp annot data data 0 1 dcnl dcsp dcsp ctab exists np fromfile fid i4 1 0 dcnl dcsp dcsp if not ctab exists dcnl dcsp dcsp dcsp raise exception color dcsp table dcsp not dcsp found dcsp in dcsp annotation dcsp file dcnl dcsp dcsp n entries np fromfile fid i4 1 0 dcnl dcsp dcsp if n entries 0 dcnl dcsp dcsp dcsp length np fromfile fid i4 1 0 dcnl dcsp dcsp dcsp orig tab np fromfile fid c length dcnl dcsp dcsp dcsp orig tab orig tab 1 dcnl dcsp dcsp dcsp names list dcnl dcsp dcsp dcsp ctab np zeros n entries 5 np int dcnl dcsp dcsp dcsp for i in range n entries dcnl dcsp dcsp dcsp dcsp name length np fromfile fid i4 1 0 dcnl dcsp dcsp dcsp dcsp name np fromfile fid |s d name length 1 0 dcnl dcsp dcsp dcsp dcsp names append name dcnl dcsp dcsp dcsp dcsp ctabi 4 np fromfile fid i4 4 dcnl dcsp dcsp dcsp dcsp ctab i 4 ctab i 0 + ctab i 1 2 8 + ctab i 2 2 16 + ctab i 3 2 24 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ctab version n entries dcnl dcsp dcsp dcsp if ctab version 2 dcnl dcsp dcsp dcsp dcsp raise exception color dcsp table dcsp version dcsp not dcsp supported dcnl dcsp dcsp dcsp n entries np fromfile fid i4 1 0 dcnl dcsp dcsp dcsp ctab np zeros n entries 5 np int dcnl dcsp dcsp dcsp length np fromfile fid i4 1 0 dcnl dcsp dcsp dcsp np fromfile fid |s d length 1 dcnl dcsp dcsp dcsp entries to read np fromfile fid i4 1 0 dcnl dcsp dcsp dcsp names list dcnl dcsp dcsp dcsp for i in range entries to read dcnl dcsp dcsp dcsp dcsp np fromfile fid i4 1 dcnl dcsp dcsp dcsp dcsp name length np fromfile fid i4 1 0 dcnl dcsp dcsp dcsp dcsp name np fromfile fid |s d name length 1 0 dcnl dcsp dcsp dcsp dcsp names append name dcnl dcsp dcsp dcsp dcsp ctabi 4 np fromfile fid i4 4 dcnl dcsp dcsp dcsp dcsp ctab i 4 ctab i 0 + ctab i 1 2 8 + ctab i 2 2 16 dcnl dcsp dcsp ctab 3 255 ctab 3 dcnl dcsp return annot ctab names
def get annot fname annot fname subject hemi parc subjects dir dcsp if annot fname is not none dcnl dcsp dcsp hemis op basename annot fname 2 dcnl dcsp dcsp if hemis0 not in lh rh dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp determine dcsp hemisphere dcsp from dcsp filename dcsp filename dcsp has dcsp to dcsp start dcsp with dcsp lh dcsp or dcsp rh dcnl dcsp dcsp annot fname annot fname dcnl dcsp else dcnl dcsp dcsp if hemi not in lh rh both dcnl dcsp dcsp dcsp raise valueerror hemi dcsp has dcsp to dcsp be dcsp lh dcsp rh dcsp or dcsp both dcnl dcsp dcsp if hemi both dcnl dcsp dcsp dcsp hemis lh rh dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemis hemi dcnl dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dst op join subjects dir subject label s s annot parc dcnl dcsp dcsp annot fname dst hemi for hemi in hemis dcnl dcsp return annot fname hemis
verbose dcnl def read labels from annot subject parc aparc hemi both surf name white annot fname none regexp none subjects dir none verbose none dcsp logger info reading dcsp labels dcsp from dcsp parcellation dcnl dcsp subjects dir get subjects dir subjects dir dcnl dcsp annot fname hemis get annot fname annot fname subject hemi parc subjects dir dcnl dcsp if regexp is not none dcnl dcsp dcsp r re compile s regexp if regexp replace isalnum else regexp dcnl dcsp n read 0 dcnl dcsp labels list dcnl dcsp for fname hemi in zip annot fname hemis dcnl dcsp dcsp annot ctab label names read annot fname dcnl dcsp dcsp label rgbas ctab 4 dcnl dcsp dcsp label ids ctab 1 dcnl dcsp dcsp fname surf op join subjects dir subject surf s s hemi surf name dcnl dcsp dcsp vert pos read surface fname surf dcnl dcsp dcsp vert pos 1000 0 dcnl dcsp dcsp for label id label name label rgba in zip label ids label names label rgbas dcnl dcsp dcsp dcsp vertices np where annot label id 0 dcnl dcsp dcsp dcsp if len vertices 0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp name label name decode + + hemi dcnl dcsp dcsp dcsp if regexp is not none and not r match name dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp pos vert posvertices dcnl dcsp dcsp dcsp values np ones len vertices dcnl dcsp dcsp dcsp label rgba tuple label rgba 255 0 dcnl dcsp dcsp dcsp label label vertices pos values hemi name name subject subject color label rgba dcnl dcsp dcsp dcsp labels append label dcnl dcsp dcsp n read len labels n read dcnl dcsp dcsp logger info dcsp dcsp dcsp read dcsp d dcsp labels dcsp from dcsp s n read fname dcnl dcsp labels sorted labels key lambda l l name dcnl dcsp if len labels 0 dcnl dcsp dcsp msg no dcsp labels dcsp found dcnl dcsp dcsp if regexp is not none dcnl dcsp dcsp dcsp msg + dcsp maybe dcsp the dcsp regular dcsp expression dcsp r dcsp did dcsp not dcsp match regexp dcnl dcsp dcsp raise runtimeerror msg dcnl dcsp logger info done dcnl dcsp return labels
def write annot fname annot ctab names dcsp with open fname wb as fid dcnl dcsp dcsp n verts len annot dcnl dcsp dcsp np array n verts dtype i4 tofile fid dcnl dcsp dcsp data np zeros n verts 2 dtype i4 dcnl dcsp dcsp data 0 np arange n verts dcnl dcsp dcsp data 1 annot dcnl dcsp dcsp data ravel tofile fid dcnl dcsp dcsp np array 1 dtype i4 tofile fid dcnl dcsp dcsp np array 2 dtype i4 tofile fid dcnl dcsp dcsp n entries len ctab dcnl dcsp dcsp np array n entries dtype i4 tofile fid dcnl dcsp dcsp table name mnepython dcsp colortable dcnl dcsp dcsp np array len table name dtype i4 tofile fid dcnl dcsp dcsp np fromstring table name dtype np uint8 tofile fid dcnl dcsp dcsp np array n entries dtype i4 tofile fid dcnl dcsp dcsp for ii name color in enumerate zip names ctab dcnl dcsp dcsp dcsp np array ii dtype i4 tofile fid dcnl dcsp dcsp dcsp np array len name dtype i4 tofile fid dcnl dcsp dcsp dcsp np fromstring name dtype np uint8 tofile fid dcnl dcsp dcsp dcsp np array color 4 dtype i4 tofile fid
verbose dcnl def write labels to annot labels subject none parc none overwrite false subjects dir none annot fname none colormap hsv hemi both verbose none dcsp logger info writing dcsp labels dcsp to dcsp parcellation dcnl dcsp subjects dir get subjects dir subjects dir dcnl dcsp annot fname hemis get annot fname annot fname subject hemi parc subjects dir dcnl dcsp if not overwrite dcnl dcsp dcsp for fname in annot fname dcnl dcsp dcsp dcsp if op exists fname dcnl dcsp dcsp dcsp dcsp raise valueerror file dcsp s dcsp exists dcsp use dcsp overwrite true dcsp to dcsp overwrite dcsp it fname dcnl dcsp to save dcnl dcsp duplicate colors dcnl dcsp invalid colors dcnl dcsp overlap dcnl dcsp no color 1 1 1 1 dcnl dcsp no color rgb 1 1 1 dcnl dcsp for hemi fname in zip hemis annot fname dcnl dcsp dcsp hemi labels label for label in labels if label hemi hemi dcnl dcsp dcsp n hemi labels len hemi labels dcnl dcsp dcsp if n hemi labels 0 dcnl dcsp dcsp dcsp ctab np empty 0 4 dtype np int32 dcnl dcsp dcsp dcsp ctab rgb ctab 3 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemi labels sort key lambda label label name dcnl dcsp dcsp dcsp hemi colors no color if label color is none else tuple int round 255 i for i in label color for label in hemi labels dcnl dcsp dcsp dcsp ctab np array hemi colors dtype np int32 dcnl dcsp dcsp dcsp ctab rgb ctab 3 dcnl dcsp dcsp dcsp labels by color defaultdict list dcnl dcsp dcsp dcsp for label color in zip hemi labels ctab rgb dcnl dcsp dcsp dcsp dcsp labels by colortuple color append label name dcnl dcsp dcsp dcsp for color names in labels by color items dcnl dcsp dcsp dcsp dcsp if color no color rgb dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp if color 0 0 0 dcnl dcsp dcsp dcsp dcsp dcsp warn at dcsp least dcsp one dcsp label dcsp contains dcsp a dcsp color dcsp with dcsp r 0 dcsp g 0 dcsp b 0 dcsp value dcsp some dcsp freesurfer dcsp tools dcsp may dcsp fail dcsp to dcsp read dcsp the dcsp parcellation dcnl dcsp dcsp dcsp dcsp if any i 255 for i in color dcnl dcsp dcsp dcsp dcsp dcsp msg s dcsp s dcsp s color dcsp join names hemi dcnl dcsp dcsp dcsp dcsp dcsp invalid colors append msg dcnl dcsp dcsp dcsp dcsp if len names 1 dcnl dcsp dcsp dcsp dcsp dcsp msg s dcsp s dcsp s color dcsp join names hemi dcnl dcsp dcsp dcsp dcsp dcsp duplicate colors append msg dcnl dcsp dcsp dcsp if labels by colorno color rgb dcnl dcsp dcsp dcsp dcsp default colors n colors n hemi labels bytes true cmap colormap dcnl dcsp dcsp dcsp dcsp safe color i 0 dcnl dcsp dcsp dcsp dcsp for i in xrange n hemi labels dcnl dcsp dcsp dcsp dcsp dcsp if ctab i 0 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp color default colorsi dcnl dcsp dcsp dcsp dcsp dcsp dcsp while np any np all color 3 ctab rgb 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp color default colorssafe color i dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp safe color i + 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp ctabi color dcnl dcsp dcsp if subject is not none and subjects dir is not none dcnl dcsp dcsp dcsp fpath op join subjects dir subject surf s white hemi dcnl dcsp dcsp dcsp points read surface fpath dcnl dcsp dcsp dcsp n vertices len points dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if len hemi labels 0 dcnl dcsp dcsp dcsp dcsp max vert max np max label vertices for label in hemi labels dcnl dcsp dcsp dcsp dcsp n vertices max vert + 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp n vertices 1 dcnl dcsp dcsp dcsp warn number dcsp of dcsp vertices dcsp in dcsp the dcsp surface dcsp could dcsp not dcsp be dcsp verified dcsp because dcsp the dcsp surface dcsp file dcsp could dcsp not dcsp be dcsp found dcsp specify dcsp subject dcsp and dcsp subjects dir dcsp parameters dcnl dcsp dcsp annot np empty n vertices dtype np int dcnl dcsp dcsp annot 1 dcnl dcsp dcsp annot id coding np array 1 2 8 2 16 dcnl dcsp dcsp annot ids list np sum ctab rgb annot id coding axis 1 dcnl dcsp dcsp for label annot id in zip hemi labels annot ids dcnl dcsp dcsp dcsp if np any annotlabel vertices 1 dcnl dcsp dcsp dcsp dcsp other ids set annotlabel vertices dcnl dcsp dcsp dcsp dcsp other ids discard 1 dcnl dcsp dcsp dcsp dcsp other indices annot ids index i for i in other ids dcnl dcsp dcsp dcsp dcsp other names hemi labelsi name for i in other indices dcnl dcsp dcsp dcsp dcsp other repr dcsp join other names dcnl dcsp dcsp dcsp dcsp msg s dcsp s dcsp overlaps dcsp s hemi label name other repr dcnl dcsp dcsp dcsp dcsp overlap append msg dcnl dcsp dcsp dcsp annotlabel vertices annot id dcnl dcsp dcsp hemi names label name for label in hemi labels dcnl dcsp dcsp if none in hemi names dcnl dcsp dcsp dcsp msg found dcsp i dcsp labels dcsp with dcsp no dcsp name dcsp writing dcsp annotation dcsp filerequires dcsp all dcsp labels dcsp named hemi names count none dcnl dcsp dcsp dcsp raise valueerror msg dcnl dcsp dcsp unlabeled annot 1 dcnl dcsp dcsp if np any unlabeled dcnl dcsp dcsp dcsp msg assigning dcsp i dcsp unlabeled dcsp vertices dcsp to dcsp unknown s unlabeled sum hemi dcnl dcsp dcsp dcsp logger info msg dcnl dcsp dcsp dcsp for i in range 1 257 dcnl dcsp dcsp dcsp dcsp if not np any np all i i i ctab rgb 1 dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp if i < 256 dcnl dcsp dcsp dcsp dcsp color i i i 0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp err need dcsp one dcsp free dcsp shade dcsp of dcsp gray dcsp for dcsp unknown dcsp label dcsp please dcsp modify dcsp your dcsp label dcsp colors dcsp or dcsp assign dcsp the dcsp unlabeled dcsp vertices dcsp to dcsp another dcsp label dcnl dcsp dcsp dcsp dcsp raise valueerror err dcnl dcsp dcsp dcsp annot id np sum annot id coding color 3 dcnl dcsp dcsp dcsp annotunlabeled annot id dcnl dcsp dcsp dcsp ctab np vstack ctab color dcnl dcsp dcsp dcsp hemi names append unknown dcnl dcsp dcsp ctab 3 255 ctab 3 dcnl dcsp dcsp hemi names name 3 if name endswith hemi else name for name in hemi names dcnl dcsp dcsp to save append fname annot ctab hemi names dcnl dcsp issues dcnl dcsp if duplicate colors dcnl dcsp dcsp msg some dcsp labels dcsp have dcsp the dcsp same dcsp color dcsp values dcsp all dcsp labels dcsp in dcsp one dcsp hemisphere dcsp must dcsp have dcsp a dcsp unique dcsp color dcnl dcsp dcsp duplicate colors insert 0 msg dcnl dcsp dcsp issues append os linesep join duplicate colors dcnl dcsp if invalid colors dcnl dcsp dcsp msg some dcsp labels dcsp have dcsp invalid dcsp color dcsp values dcsp all dcsp colors dcsp should dcsp be dcsp rgba dcsp tuples dcsp with dcsp values dcsp between dcsp 0 dcsp and dcsp 1 dcnl dcsp dcsp invalid colors insert 0 msg dcnl dcsp dcsp issues append os linesep join invalid colors dcnl dcsp if overlap dcnl dcsp dcsp msg some dcsp labels dcsp occupy dcsp vertices dcsp that dcsp are dcsp also dcsp occupied dcsp by dcsp one dcsp or dcsp more dcsp other dcsp labels dcsp each dcsp vertex dcsp can dcsp only dcsp be dcsp occupied dcsp by dcsp a dcsp single dcsp label dcsp in dcsp annot dcsp files dcnl dcsp dcsp overlap insert 0 msg dcnl dcsp dcsp issues append os linesep join overlap dcnl dcsp if issues dcnl dcsp dcsp raise valueerror n n join issues dcnl dcsp for fname annot ctab hemi names in to save dcnl dcsp dcsp logger info dcsp dcsp dcsp writing dcsp d dcsp labels dcsp to dcsp s len hemi names fname dcnl dcsp dcsp write annot fname annot ctab hemi names dcnl dcsp logger info done
def read head pos fname dcsp check fname fname must exist true overwrite read dcnl dcsp data np loadtxt fname skiprows 1 dcnl dcsp data shape 1 10 dcnl dcsp if np isnan data any dcnl dcsp dcsp raise runtimeerror positions dcsp could dcsp not dcsp be dcsp read dcsp properly dcsp from dcsp s fname dcnl dcsp return data
def write head pos fname pos dcsp check fname fname overwrite true dcnl dcsp pos np array pos np float64 dcnl dcsp if pos ndim 2 or pos shape1 10 dcnl dcsp dcsp raise valueerror pos dcsp must dcsp be dcsp a dcsp 2d dcsp array dcsp of dcsp shape dcsp n dcsp 10 dcnl dcsp with open fname wb as fid dcnl dcsp dcsp fid write dcsp time dcsp dcsp dcsp dcsp dcsp dcsp dcsp q1 dcsp dcsp dcsp dcsp dcsp dcsp dcsp q2 dcsp dcsp dcsp dcsp dcsp dcsp dcsp q3 dcsp dcsp dcsp dcsp dcsp dcsp dcsp q4 dcsp dcsp dcsp dcsp dcsp dcsp dcsp q5 dcsp dcsp dcsp dcsp dcsp dcsp dcsp q6 dcsp dcsp dcsp dcsp dcsp dcsp dcsp gvalue dcsp dcsp error dcsp dcsp dcsp dcsp velocity n encode ascii dcnl dcsp dcsp for p in pos dcnl dcsp dcsp dcsp fmts dcsp 9 3f + dcsp 8 5f 9 dcnl dcsp dcsp dcsp fid write dcsp + dcsp join fmts + n tuple p encode ascii
def head pos to trans rot t quats dcsp t quats 0 copy dcnl dcsp rotation quat to rot quats 1 4 dcnl dcsp translation quats 4 7 copy dcnl dcsp return translation rotation t
verbose dcnl def get hpi info info verbose none dcsp if len info hpi meas 0 or coil freq not in info hpi meas 0 hpi coils 0 dcnl dcsp dcsp raise runtimeerror appropriate dcsp chpi dcsp information dcsp not dcsp found dcsp inraw info hpi meas dcsp cannot dcsp process dcsp chpi dcnl dcsp hpi coils sorted info hpi meas 1 hpi coils key lambda x x number dcnl dcsp hpi sub info hpi subsystem dcnl dcsp if event channel in hpi sub dcnl dcsp dcsp hpi pick pick channels info ch names hpi sub event channel dcnl dcsp dcsp hpi pick hpi pick0 if len hpi pick 0 else none dcnl dcsp else dcnl dcsp dcsp hpi pick none dcnl dcsp hpi on coil event bits 0 for coil in hpi sub hpi coils dcnl dcsp hpi on np array hpi on hc number 1 for hc in hpi coils dcnl dcsp hpi freqs np array float x coil freq for x in hpi coils dcnl dcsp logger info using dcsp s dcsp hpi dcsp coils dcsp s dcsp hz len hpi freqs dcsp join str int s for s in hpi freqs dcnl dcsp hpi mask np array event bit 0 for event bit in hpi on dcnl dcsp hpi on hpi onhpi mask dcnl dcsp hpi freqs hpi freqshpi mask dcnl dcsp return hpi freqs hpi pick hpi on
verbose dcnl def get hpi initial fit info adjust false verbose none dcsp if info hpi results is none dcnl dcsp dcsp raise runtimeerror no dcsp initial dcsp chpi dcsp head dcsp localization dcsp performed dcnl dcsp hpi result info hpi results 1 dcnl dcsp hpi coils sorted info hpi meas 1 hpi coils key lambda x x number dcnl dcsp hpi dig sorted d for d in info dig if d kind fiff fiffv point hpi key lambda x x ident dcnl dcsp pos order hpi result order 1 dcnl dcsp if not all d coord frame fiff fiffv coord head for d in hpi dig dcnl dcsp dcsp raise runtimeerror chpi dcsp coordinate dcsp frame dcsp incorrect dcnl dcsp logger info hpifit dcsp s dcsp coils dcsp digitized dcsp in dcsp order dcsp s len pos order dcsp join str o + 1 for o in pos order dcnl dcsp logger debug hpifit dcsp s dcsp coils dcsp accepted dcsp s len hpi result used dcsp join str h for h in hpi result used dcnl dcsp hpi rrs np array d r for d in hpi dig pos order dcnl dcsp hpi rrs fit sorted d for d in info hpi results 1 dig points key lambda x x ident dcnl dcsp hpi rrs fit np array d r for d in hpi rrs fit dcnl dcsp assert hpi result coord trans to fiff fiffv coord head dcnl dcsp hpi rrs fit apply trans hpi result coord trans trans hpi rrs fit dcnl dcsp if moments in hpi result dcnl dcsp dcsp logger debug hpi dcsp coil dcsp moments dcsp d dcsp d hpi result moments shape 1 dcnl dcsp dcsp for moment in hpi result moments dcnl dcsp dcsp dcsp logger debug g dcsp g dcsp g tuple moment dcnl dcsp errors np sqrt hpi rrs hpi rrs fit 2 sum axis 1 dcnl dcsp logger debug hpifit dcsp errors dcsp dcsp s dcsp mm dcsp join 0 1f 1000 0 e for e in errors dcnl dcsp if errors sum < len errors hpi result dist limit dcnl dcsp dcsp logger info hpi dcsp consistency dcsp of dcsp isotrak dcsp and dcsp hpifit dcsp is dcsp ok dcnl dcsp elif not adjust and len hpi result used len hpi coils dcnl dcsp dcsp warn hpi dcsp consistency dcsp of dcsp isotrak dcsp and dcsp hpifit dcsp is dcsp poor dcnl dcsp else dcnl dcsp dcsp for hi r dig r fit in enumerate zip hpi rrs hpi rrs fit dcnl dcsp dcsp dcsp d 1000 np sqrt r dig r fit 2 sum dcnl dcsp dcsp dcsp if not adjust dcnl dcsp dcsp dcsp dcsp warn discrepancy dcsp of dcsp hpi dcsp coil dcsp d dcsp isotrak dcsp and dcsp hpifit dcsp is dcsp 1f dcsp mm hi + 1 d dcnl dcsp dcsp dcsp elif hi + 1 not in hpi result used dcnl dcsp dcsp dcsp dcsp if hpi result goodness hi hpi result good limit dcnl dcsp dcsp dcsp dcsp dcsp logger info note dcsp hpi dcsp coil dcsp d dcsp isotrak dcsp is dcsp adjusted dcsp by dcsp 1f dcsp mm hi + 1 d dcnl dcsp dcsp dcsp dcsp dcsp hpi rrshi r fit dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp warn discrepancy dcsp of dcsp hpi dcsp coil dcsp d dcsp isotrak dcsp and dcsp hpifit dcsp of dcsp 1f dcsp mm dcsp was dcsp not dcsp adjusted hi + 1 d dcnl dcsp logger debug hp dcsp fitting dcsp limits dcsp err dcsp dcsp 1f dcsp mm dcsp gval dcsp dcsp 3f 1000 hpi result dist limit hpi result good limit dcnl dcsp return hpi rrs
def magnetic dipole objective x b b2 coils scale method dcsp if method forward dcnl dcsp dcsp fwd magnetic dipole field vec xnp newaxis coils dcnl dcsp else dcnl dcsp dcsp from preprocessing maxwell import sss basis dcnl dcsp dcsp fwd sss basis dict origin x int order 1 ext order 0 coils t dcnl dcsp fwd np dot fwd scale t dcnl dcsp one np dot linalg svd fwd full matrices false 2 3 b dcnl dcsp one one dcnl dcsp bm2 one sum dcnl dcsp return b2 bm2
def fit magnetic dipole b orig x0 coils scale method dcsp from scipy optimize import fmin cobyla dcnl dcsp b np dot scale b orig dcnl dcsp b2 np dot b b dcnl dcsp objective partial magnetic dipole objective b b b2 b2 coils coils scale scale method method dcnl dcsp x fmin cobyla objective x0 rhobeg 0 0001 rhoend 1e05 disp false dcnl dcsp return x 1 0 objective x b2
def chpi objective x coil dev rrs coil head rrs dcsp d np dot coil dev rrs quat to rot x 3 t dcnl dcsp d + x3 10 0 dcnl dcsp d coil head rrs dcnl dcsp d d dcnl dcsp return d sum
def unit quat constraint x dcsp return 1 x x sum
def fit chpi quat coil dev rrs coil head rrs x0 dcsp from scipy optimize import fmin cobyla dcnl dcsp denom np sum coil head rrs np mean coil head rrs axis 0 2 dcnl dcsp objective partial chpi objective coil dev rrs coil dev rrs coil head rrs coil head rrs dcnl dcsp x0 x0 copy dcnl dcsp x03 10 0 dcnl dcsp x fmin cobyla objective x0 unit quat constraint rhobeg 0 001 rhoend 1e05 disp false dcnl dcsp result objective x dcnl dcsp x3 10 0 dcnl dcsp return x 1 0 result denom
def fit coil order dev head trans dev pnts head pnts dcsp id quat np concatenate rot to quat np eye 3 0 0 0 0 0 0 dcnl dcsp best order none dcnl dcsp best g 999 dcnl dcsp best quat id quat dcnl dcsp for this order in itertools permutations np arange len head pnts dcnl dcsp dcsp head pnts tmp head pntsnp array this order dcnl dcsp dcsp this quat g fit chpi quat dev pnts head pnts tmp id quat dcnl dcsp dcsp if g best g dcnl dcsp dcsp dcsp best g g dcnl dcsp dcsp dcsp best order np array this order dcnl dcsp dcsp dcsp best quat this quat dcnl dcsp dev head t np concatenate quat to rot best quat 3 best quat3 np newaxis axis 1 dcnl dcsp dev head t np concatenate dev head t 0 0 0 1 0 dcnl dcsp return dev head t best order
verbose dcnl def setup hpi struct info model n window method forward exclude bads remove aliased false verbose none dcsp from preprocessing maxwell import prep mf coils dcnl dcsp hpi freqs hpi pick hpi ons get hpi info info dcnl dcsp highest info get lowpass dcnl dcsp highest info sfreq 2 0 if highest is none else highest dcnl dcsp keepers np array h < highest for h in hpi freqs bool dcnl dcsp if remove aliased dcnl dcsp dcsp hpi freqs hpi freqskeepers dcnl dcsp dcsp hpi ons hpi onskeepers dcnl dcsp elif not keepers all dcnl dcsp dcsp raise runtimeerror found dcsp hpi dcsp frequencies dcsp s dcsp above dcsp the dcsp lowpass dcsp or dcsp nyquist dcsp frequency dcsp 0 1f hpi freqs ~ keepers tolist highest dcnl dcsp if info line freq is not none dcnl dcsp dcsp line freqs np arange info line freq info sfreq 3 0 info line freq dcnl dcsp else dcnl dcsp dcsp line freqs np zeros 0 dcnl dcsp logger info line dcsp interference dcsp frequencies dcsp s dcsp hz dcsp join d l for l in line freqs dcnl dcsp slope np arange model n window astype np float64 np newaxis dcnl dcsp slope np mean slope dcnl dcsp rads slope info sfreq dcnl dcsp rads 2 np pi dcnl dcsp f t hpi freqsnp newaxis rads dcnl dcsp l t line freqsnp newaxis rads dcnl dcsp model np sin f t np cos f t dcnl dcsp model + np sin l t np cos l t dcnl dcsp model + slope np ones slope shape dcnl dcsp model np concatenate model axis 1 dcnl dcsp inv model linalg pinv model dcnl dcsp meg picks pick types info meg true eeg false exclude exclude dcnl dcsp if len exclude 0 dcnl dcsp dcsp if exclude bads dcnl dcsp dcsp dcsp msg info bads dcnl dcsp dcsp else dcnl dcsp dcsp dcsp msg exclude dcnl dcsp dcsp logger debug static dcsp bad dcsp channels dcsp d dcsp s len msg u dcsp join msg dcnl dcsp megchs ch for ci ch in enumerate info chs if ci in meg picks dcnl dcsp templates read coil defs elekta defs true verbose false dcnl dcsp coils create meg coils megchs accurate coilset templates dcnl dcsp if method forward dcnl dcsp dcsp coils concatenate coils coils dcnl dcsp else dcnl dcsp dcsp coils prep mf coils info dcnl dcsp scale make ad hoc cov info verbose false dcnl dcsp scale get whitener data info scale meg picks verbose false 0 dcnl dcsp hpi dict meg picks meg picks hpi pick hpi pick model model inv model inv model on hpi ons n window model n window method method freqs hpi freqs line freqs line freqs n freqs len hpi freqs scale scale coils coils dcnl dcsp return hpi
def time prefix fit time dcsp return dcsp dcsp dcsp dcsp t 0 3f fit time ljust 17
verbose dcnl def fit chpi amplitudes raw time sl hpi fit time verbose none dcsp with use log level false dcnl dcsp dcsp meg chpi data raw hpi meg picks time sl 0 dcnl dcsp mchpi data np tile np mean meg chpi data axis 1 keepdims true 1 meg chpi data shape1 dcnl dcsp mchpi data mchpi data reshape meg chpi data shape dcnl dcsp this data meg chpi data mchpi data dcnl dcsp if hpi hpi pick is not none dcnl dcsp dcsp with use log level false dcnl dcsp dcsp dcsp chpi data raw hpi hpi pick time sl 0 dcnl dcsp dcsp ons np round chpi data astype np int hpi on np newaxis astype bool dcnl dcsp dcsp n on np sum ons axis 0 dcnl dcsp dcsp if not n on 3 all dcnl dcsp dcsp dcsp logger info time prefix fit time + s dcsp < dcsp 3 dcsp hpi dcsp coils dcsp turned dcsp on dcsp skipping dcsp fit n on min dcnl dcsp dcsp dcsp return none dcnl dcsp n freqs hpi n freqs dcnl dcsp this len time sl stop time sl start dcnl dcsp if this len hpi n window dcnl dcsp dcsp model inv model hpi model hpi inv model dcnl dcsp else dcnl dcsp dcsp model hpi model this len dcnl dcsp dcsp inv model linalg pinv model dcnl dcsp x np dot inv model this data t dcnl dcsp x sin x cos x n freqs xn freqs 2 n freqs dcnl dcsp sin fit np zeros n freqs x sin shape1 dcnl dcsp for fi in range n freqs dcnl dcsp dcsp u s vt np linalg svd np vstack x sinfi x cosfi full matrices false dcnl dcsp dcsp xfi fi + n freqs np outer u 0 s0 vt0 dcnl dcsp dcsp sin fitfi vt0 dcnl dcsp data diff np dot model x t this data dcnl dcsp g sin 1 np sqrt data diff 2 sum this data 2 sum dcnl dcsp g chan 1 np sqrt data diff 2 sum axis 1 this data 2 sum axis 1 dcnl dcsp logger debug dcsp dcsp dcsp dcsp hpi dcsp amplitude dcsp correlation dcsp 0 3f dcsp 0 3f dcsp s dcsp chnls dcsp dcsp 0 90 fit time g sin g chan 0 9 sum dcnl dcsp return sin fit
verbose dcnl def fit device hpi positions raw t win none initial dev rrs none verbose none dcsp if t win is none dcnl dcsp dcsp i win 0 len raw times dcnl dcsp else dcnl dcsp dcsp i win raw time as index t win use rounding true dcnl dcsp i win max i win0 0 min i win1 len raw times dcnl dcsp time sl slice i win0 i win1 dcnl dcsp hpi setup hpi struct raw info i win1 i win0 dcnl dcsp if initial dev rrs is none dcnl dcsp dcsp initial dev rrs dcnl dcsp dcsp for i in range hpi n freqs dcnl dcsp dcsp dcsp initial dev rrs append 0 0 0 0 0 0 dcnl dcsp sin fit fit chpi amplitudes raw time sl hpi 0 dcnl dcsp if sin fit is none dcnl dcsp dcsp return none dcnl dcsp outs fit magnetic dipole f pos hpi coils hpi scale hpi method for f pos on in zip sin fit initial dev rrs hpi on if on 0 dcnl dcsp coil dev rrs np array o0 for o in outs dcnl dcsp coil g np array o0 for o in outs dcnl dcsp return coil dev rrs coil g
verbose dcnl def calculate chpi positions raw t step min 0 1 t step max 10 0 t window 0 2 dist limit 0 005 gof limit 0 98 use distances true verbose none dcsp from scipy spatial distance import cdist dcnl dcsp hpi dig head rrs get hpi initial fit raw info dcnl dcsp hpi setup hpi struct raw info int round t window raw info sfreq dcnl dcsp dev head t raw info dev head t trans dcnl dcsp head dev t invert transform raw info dev head t trans dcnl dcsp hpi dig dev rrs apply trans head dev t hpi dig head rrs dcnl dcsp hpi coil dists cdist hpi dig head rrs hpi dig head rrs dcnl dcsp last dict sin fit none fit time t step min coil dev rrs hpi dig dev rrs quat np concatenate rot to quat dev head t 3 3 dev head t 3 3 dcnl dcsp t begin raw times0 dcnl dcsp t end raw times 1 dcnl dcsp fit idxs raw time as index np arange t begin + t window 2 0 t end t step min use rounding true dcnl dcsp quats dcnl dcsp logger info fitting dcsp up dcsp to dcsp s dcsp time dcsp points dcsp 0 1f dcsp sec dcsp duration len fit idxs t end t begin dcnl dcsp pos 0 none dcnl dcsp hpi n freqs len hpi freqs dcnl dcsp for midpt in fit idxs dcnl dcsp dcsp fit time midpt + raw first samp hpi n window 2 0 raw info sfreq dcnl dcsp dcsp time sl midpt hpi n window 2 dcnl dcsp dcsp time sl slice max time sl 0 min time sl + hpi n window len raw times dcnl dcsp dcsp sin fit fit chpi amplitudes raw time sl hpi fit time dcnl dcsp dcsp if sin fit is none dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp if last sin fit is not none dcnl dcsp dcsp dcsp corr np corrcoef sin fit ravel last sin fit ravel 0 1 dcnl dcsp dcsp dcsp if fit time last fit time < t step max 1e07 and corr corr 0 98 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp last sin fit sin fit copy dcnl dcsp dcsp outs fit magnetic dipole f pos hpi coils hpi scale hpi method for f pos in zip sin fit last coil dev rrs dcnl dcsp dcsp this coil dev rrs np array o0 for o in outs dcnl dcsp dcsp g coils o1 for o in outs dcnl dcsp dcsp use mask np ones hpi n freqs bool dcnl dcsp dcsp if use distances dcnl dcsp dcsp dcsp these dists cdist this coil dev rrs this coil dev rrs dcnl dcsp dcsp dcsp these dists np abs hpi coil dists these dists dcnl dcsp dcsp dcsp good false dcnl dcsp dcsp dcsp while not good dcnl dcsp dcsp dcsp dcsp d these distsuse mask use mask dcnl dcsp dcsp dcsp dcsp d bad d dist limit dcnl dcsp dcsp dcsp dcsp good not d bad any dcnl dcsp dcsp dcsp dcsp if not good dcnl dcsp dcsp dcsp dcsp dcsp if use mask sum 2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp use mask false dcnl dcsp dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp dcsp badness d d bad sum axis 0 dcnl dcsp dcsp dcsp dcsp dcsp exclude coils np where use mask 0np argmax badness dcnl dcsp dcsp dcsp dcsp dcsp use maskexclude coils false dcnl dcsp dcsp dcsp good use mask sum 3 dcnl dcsp dcsp dcsp if not good dcnl dcsp dcsp dcsp dcsp warn time prefix fit time + s s dcsp good dcsp hpi dcsp fits dcsp cannot dcsp determine dcsp the dcsp transformation use mask sum hpi n freqs dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp this quat g fit chpi quat this coil dev rrsuse mask hpi dig head rrsuse mask last quat dcnl dcsp dcsp if g < gof limit dcnl dcsp dcsp dcsp logger info time prefix fit time + bad dcsp coil dcsp fit dcsp g 7 3f g dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp this dev head t np concatenate quat to rot this quat 3 this quat3 np newaxis axis 1 dcnl dcsp dcsp this dev head t np concatenate this dev head t 0 0 0 1 0 dcnl dcsp dcsp dt t window dcnl dcsp dcsp vs tuple 1000 0 np sqrt np sum last coil dev rrs this coil dev rrs 2 axis 1 dt dcnl dcsp dcsp logger info time prefix fit time + s s dcsp good dcsp hpi dcsp fits dcsp movements dcsp mm s dcsp dcsp + dcsp dcsp join dcsp 6 1f hpi n freqs use mask sum hpi n freqs + vs dcnl dcsp dcsp est coil head rrs apply trans this dev head t this coil dev rrs dcnl dcsp dcsp errs 1000 0 np sqrt hpi dig head rrs est coil head rrs 2 sum axis 1 dcnl dcsp dcsp e errsuse mask mean 1000 0 dcnl dcsp dcsp d 100 np sqrt np sum last quat 3 this quat3 2 dcnl dcsp dcsp r angle between quats last quat 3 this quat 3 dt dcnl dcsp dcsp v d dt dcnl dcsp dcsp if pos 0 is none dcnl dcsp dcsp dcsp pos 0 this quat3 copy dcnl dcsp dcsp d 100 np sqrt np sum this quat3 pos 0 2 dcnl dcsp dcsp for ii in range hpi n freqs dcnl dcsp dcsp dcsp if use maskii dcnl dcsp dcsp dcsp dcsp start end dcsp dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp start end dcnl dcsp dcsp dcsp log str dcsp dcsp dcsp dcsp + start + 0 6 1f dcsp 1 6 1f dcsp 2 6 1f dcsp dcsp + 3 6 1f dcsp 4 6 1f dcsp 5 6 1f dcsp dcsp + g dcsp dcsp 6 0 3f dcsp err dcsp dcsp 7 4 1f dcsp + end dcnl dcsp dcsp dcsp if ii < 2 dcnl dcsp dcsp dcsp dcsp log str + 8 6 3f dcsp 9 6 3f dcsp 10 6 3f dcnl dcsp dcsp dcsp elif ii 3 dcnl dcsp dcsp dcsp dcsp log str + 8 6 1f dcsp 9 6 1f dcsp 10 6 1f dcnl dcsp dcsp dcsp vals np concatenate 1000 hpi dig head rrsii 1000 est coil head rrsii g coilsii errsii dcnl dcsp dcsp dcsp if ii < 2 dcnl dcsp dcsp dcsp dcsp vals np concatenate vals this dev head tii 3 dcnl dcsp dcsp dcsp elif ii 3 dcnl dcsp dcsp dcsp dcsp vals np concatenate vals this dev head t 3 3 1000 0 dcnl dcsp dcsp dcsp logger debug log str format vals dcnl dcsp dcsp logger debug dcsp dcsp dcsp dcsp t dcsp dcsp 0 3f dcsp e dcsp dcsp 0 2f dcsp cm dcsp g dcsp dcsp 0 3f dcsp v dcsp dcsp 0 2f dcsp cm s dcsp r dcsp dcsp 0 2f dcsp rad s dcsp d dcsp dcsp 0 2f dcsp cm fit time 100 e g v r d dcnl dcsp dcsp logger debug dcsp dcsp dcsp dcsp t dcsp dcsp 0 3f dcsp q dcsp dcsp s dcsp fit time dcsp join map 8 5f format this quat dcnl dcsp dcsp quats append np concatenate fit time this quat g e 100 v dcnl dcsp dcsp last fit time fit time dcnl dcsp dcsp last quat this quat dcnl dcsp dcsp last coil dev rrs this coil dev rrs dcnl dcsp logger info done dcnl dcsp quats np array quats np float64 dcnl dcsp quats np zeros 0 10 if quats size 0 else quats dcnl dcsp return quats
verbose dcnl def calculate chpi coil locs raw t step min 0 1 t step max 10 0 t window 0 2 dist limit 0 005 gof limit 0 98 verbose none dcsp hpi dig head rrs get hpi initial fit raw info dcnl dcsp hpi setup hpi struct raw info int round t window raw info sfreq dcnl dcsp head dev t invert transform raw info dev head t trans dcnl dcsp hpi dig dev rrs apply trans head dev t hpi dig head rrs dcnl dcsp last dict sin fit none fit time t step min coil dev rrs hpi dig dev rrs dcnl dcsp t begin raw times0 dcnl dcsp t end raw times 1 dcnl dcsp fit idxs raw time as index np arange t begin + t window 2 0 t end t step min use rounding true dcnl dcsp times dcnl dcsp chpi digs dcnl dcsp logger info fitting dcsp up dcsp to dcsp s dcsp time dcsp points dcsp 0 1f dcsp sec dcsp duration len fit idxs t end t begin dcnl dcsp hpi n freqs len hpi freqs dcnl dcsp for midpt in fit idxs dcnl dcsp dcsp fit time midpt + raw first samp hpi n window 2 0 raw info sfreq dcnl dcsp dcsp time sl midpt hpi n window 2 dcnl dcsp dcsp time sl slice max time sl 0 min time sl + hpi n window len raw times dcnl dcsp dcsp sin fit fit chpi amplitudes raw time sl hpi fit time dcnl dcsp dcsp if sin fit is none dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp if last sin fit is not none dcnl dcsp dcsp dcsp corr np corrcoef sin fit ravel last sin fit ravel 0 1 dcnl dcsp dcsp dcsp if fit time last fit time < t step max 1e07 and corr corr 0 98 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp last sin fit sin fit copy dcnl dcsp dcsp outs fit magnetic dipole f pos hpi coils hpi scale hpi method for f pos in zip sin fit last coil dev rrs dcnl dcsp dcsp dig dcnl dcsp dcsp for idx o in enumerate outs dcnl dcsp dcsp dcsp dig append r o0 ident idx + 1 kind fiff fiffv point hpi coord frame fiff fiffv coord device gof o1 dcnl dcsp dcsp this coil dev rrs np array o0 for o in outs dcnl dcsp dcsp times append fit time dcnl dcsp dcsp chpi digs append dig dcnl dcsp dcsp last fit time fit time dcnl dcsp dcsp last coil dev rrs this coil dev rrs dcnl dcsp logger info done dcnl dcsp return times chpi digs
verbose dcnl def filter chpi raw include line true t step 0 01 t window 0 2 verbose none dcsp if not raw preload dcnl dcsp dcsp raise runtimeerror raw dcsp data dcsp must dcsp be dcsp preloaded dcnl dcsp t step float t step dcnl dcsp t window float t window dcnl dcsp if not t step 0 and t window 0 dcnl dcsp dcsp raise valueerror t step dcsp s dcsp and dcsp t window dcsp s dcsp must dcsp both dcsp be dcsp dcsp 0 t step t window dcnl dcsp n step int np ceil t step raw info sfreq dcnl dcsp hpi setup hpi struct raw info int round t window raw info sfreq exclude bads remove aliased true verbose false dcnl dcsp fit idxs np arange 0 len raw times + hpi n window 2 n step dcnl dcsp n freqs len hpi freqs dcnl dcsp n remove 2 n freqs dcnl dcsp meg picks pick types raw info meg true exclude dcnl dcsp n times len raw times dcnl dcsp msg removing dcsp s dcsp chpi n freqs dcnl dcsp if include line dcnl dcsp dcsp n remove + 2 len hpi line freqs dcnl dcsp dcsp msg + dcsp and dcsp s dcsp line dcsp harmonic len hpi line freqs dcnl dcsp msg + dcsp frequencies dcsp from dcsp s dcsp meg dcsp channels len meg picks dcnl dcsp proj np dot hpi model n remove hpi inv model n remove t dcnl dcsp logger info msg dcnl dcsp chunks list dcnl dcsp last endpt 0 dcnl dcsp last done 0 0 dcnl dcsp next done 60 0 dcnl dcsp for ii midpt in enumerate fit idxs dcnl dcsp dcsp if midpt raw info sfreq next done or ii len fit idxs 1 dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp filtering dcsp dcsp 5 1f dcsp dcsp dcsp 5 1f dcsp sec last done min next done raw times 1 dcnl dcsp dcsp dcsp last done next done dcnl dcsp dcsp dcsp next done + 60 0 dcnl dcsp dcsp left edge midpt hpi n window 2 dcnl dcsp dcsp time sl slice max left edge 0 min left edge + hpi n window len raw times dcnl dcsp dcsp this len time sl stop time sl start dcnl dcsp dcsp if this len hpi n window dcnl dcsp dcsp dcsp this proj proj dcnl dcsp dcsp else dcnl dcsp dcsp dcsp model hpi model this len dcnl dcsp dcsp dcsp inv model linalg pinv model dcnl dcsp dcsp dcsp this proj np dot model n remove inv model n remove t dcnl dcsp dcsp this data raw data meg picks time sl dcnl dcsp dcsp subt pt min midpt + n step n times dcnl dcsp dcsp if last endpt subt pt dcnl dcsp dcsp dcsp fit left edge left edge time sl start + hpi n window 2 dcnl dcsp dcsp dcsp fit sl slice fit left edge fit left edge + subt pt last endpt dcnl dcsp dcsp dcsp chunks append subt pt np dot this data this proj fit sl dcnl dcsp dcsp last endpt subt pt dcnl dcsp dcsp if ii < len fit idxs 1 dcnl dcsp dcsp dcsp next left edge fit idxs ii + 1 hpi n window 2 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp next left edge np inf dcnl dcsp dcsp while len chunks 0 and chunks00 < next left edge dcnl dcsp dcsp dcsp right edge chunk chunks pop 0 dcnl dcsp dcsp dcsp raw datameg picks right edge chunk shape1 right edge chunk dcnl dcsp return raw
def get lut dcsp data dir op join op dirname file data dcnl dcsp lut fname op join data dir freesurfercolorlut txt dcnl dcsp return np genfromtxt lut fname dtype none usecols 0 1 2 3 4 5 names id name r g b a
def get lut id lut label use lut dcsp if not use lut dcnl dcsp dcsp return 1 dcnl dcsp assert isinstance label string types dcnl dcsp mask lut name label encode utf8 dcnl dcsp assert mask sum 1 dcnl dcsp return lut id mask
def add patch info s dcsp nearest s nearest dcnl dcsp if nearest is none dcnl dcsp dcsp s pinfo none dcnl dcsp dcsp s patch inds none dcnl dcsp dcsp return dcnl dcsp logger info dcsp dcsp dcsp dcsp computing dcsp patch dcsp statistics dcnl dcsp indn np argsort nearest dcnl dcsp nearest sorted nearestindn dcnl dcsp steps np where nearest sorted1 nearest sorted 1 0 + 1 dcnl dcsp starti np r 0 steps dcnl dcsp stopi np r steps len nearest dcnl dcsp pinfo list dcnl dcsp for start stop in zip starti stopi dcnl dcsp dcsp pinfo append np sort indnstart stop dcnl dcsp s pinfo pinfo dcnl dcsp patch verts nearest sorted steps 1 dcnl dcsp s patch inds np searchsorted patch verts s vertno dcnl dcsp logger info dcsp dcsp dcsp dcsp patch dcsp information dcsp added
verbose dcnl def read source spaces from tree fid tree patch stats false verbose none dcsp spaces dir tree find tree fiff fiffb mne source space dcnl dcsp if len spaces 0 dcnl dcsp dcsp raise valueerror no dcsp source dcsp spaces dcsp found dcnl dcsp src list dcnl dcsp for s in spaces dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp reading dcsp a dcsp source dcsp space dcnl dcsp dcsp this read one source space fid s dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp done dcnl dcsp dcsp if patch stats dcnl dcsp dcsp dcsp complete source space info this dcnl dcsp dcsp src append this dcnl dcsp logger info dcsp dcsp dcsp dcsp d dcsp source dcsp spaces dcsp read len spaces dcnl dcsp return sourcespaces src
verbose dcnl def read source spaces fname patch stats false verbose none dcsp check fname fname source dcsp space src fif src fif gz fwd fif fwd fif gz inv fif inv fif gz dcnl dcsp ff tree fiff open fname dcnl dcsp with ff as fid dcnl dcsp dcsp src read source spaces from tree fid tree patch stats patch stats verbose verbose dcnl dcsp dcsp src info fname fname dcnl dcsp dcsp node dir tree find tree fiff fiffb mne env dcnl dcsp dcsp if node dcnl dcsp dcsp dcsp node node0 dcnl dcsp dcsp dcsp for p in range node nent dcnl dcsp dcsp dcsp dcsp kind node directory p kind dcnl dcsp dcsp dcsp dcsp pos node directory p pos dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp if kind fiff fiff mne env working dir dcnl dcsp dcsp dcsp dcsp dcsp src info working dir tag data dcnl dcsp dcsp dcsp dcsp elif kind fiff fiff mne env command line dcnl dcsp dcsp dcsp dcsp dcsp src info command line tag data dcnl dcsp return src
verbose dcnl def read one source space fid this verbose none dcsp fiff bem surf ntri 3104 dcnl dcsp fiff bem surf triangles 3106 dcnl dcsp res dict dcnl dcsp tag find tag fid this fiff fiff mne source space id dcnl dcsp if tag is none dcnl dcsp dcsp res id int fiff fiffv mne surf unknown dcnl dcsp else dcnl dcsp dcsp res id int tag data dcnl dcsp tag find tag fid this fiff fiff mne source space type dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror unknown dcsp source dcsp space dcsp type dcnl dcsp else dcnl dcsp dcsp src type int tag data dcnl dcsp dcsp if src type fiff fiffv mne space surface dcnl dcsp dcsp dcsp res type surf dcnl dcsp dcsp elif src type fiff fiffv mne space volume dcnl dcsp dcsp dcsp res type vol dcnl dcsp dcsp elif src type fiff fiffv mne space discrete dcnl dcsp dcsp dcsp res type discrete dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror unknown dcsp source dcsp space dcsp type dcsp d src type dcnl dcsp if res type vol dcnl dcsp dcsp tag find tag fid this fiff fiff mne source space voxel dims dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res shape tuple tag data dcnl dcsp dcsp tag find tag fid this fiff fiff coord trans dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res src mri t tag data dcnl dcsp dcsp parent mri dir tree find this fiff fiffb mne parent mri file dcnl dcsp dcsp if len parent mri 0 dcnl dcsp dcsp dcsp raise valueerror can dcsp not dcsp find dcsp parent dcsp mri dcsp location dcsp the dcsp volume dcsp source dcsp space dcsp may dcsp have dcsp been dcsp made dcsp with dcsp an dcsp mne dcsp version dcsp that dcsp is dcsp too dcsp old dcsp < dcsp 2 7 3 dcsp consider dcsp updating dcsp and dcsp regenerating dcsp the dcsp inverse dcnl dcsp dcsp mri parent mri0 dcnl dcsp dcsp for d in mri directory dcnl dcsp dcsp dcsp if d kind fiff fiff coord trans dcnl dcsp dcsp dcsp dcsp tag read tag fid d pos dcnl dcsp dcsp dcsp dcsp trans tag data dcnl dcsp dcsp dcsp dcsp if trans from fiff fiffv mne coord mri voxel dcnl dcsp dcsp dcsp dcsp dcsp res vox mri t tag data dcnl dcsp dcsp dcsp dcsp if trans to fiff fiffv mne coord ras dcnl dcsp dcsp dcsp dcsp dcsp res mri ras t tag data dcnl dcsp dcsp tag find tag fid mri fiff fiff mne source space interpolator dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res interpolator tag data dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info interpolation dcsp matrix dcsp for dcsp mri dcsp not dcsp found dcnl dcsp dcsp tag find tag fid mri fiff fiff mne source space mri file dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res mri file tag data dcnl dcsp dcsp tag find tag fid mri fiff fiff mri width dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res mri width int tag data dcnl dcsp dcsp tag find tag fid mri fiff fiff mri height dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res mri height int tag data dcnl dcsp dcsp tag find tag fid mri fiff fiff mri depth dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res mri depth int tag data dcnl dcsp dcsp tag find tag fid mri fiff fiff mne file name dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res mri volume name tag data dcnl dcsp dcsp tag find tag fid this fiff fiff mne source space nneighbors dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp nneighbors tag data dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne source space neighbors dcnl dcsp dcsp dcsp offset 0 dcnl dcsp dcsp dcsp neighbors dcnl dcsp dcsp dcsp for n in nneighbors dcnl dcsp dcsp dcsp dcsp neighbors append tag dataoffset offset + n dcnl dcsp dcsp dcsp dcsp offset + n dcnl dcsp dcsp dcsp res neighbor vert neighbors dcnl dcsp dcsp tag find tag fid this fiff fiff comment dcnl dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp res seg name tag data dcnl dcsp tag find tag fid this fiff fiff mne source space npoints dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror number dcsp of dcsp vertices dcsp not dcsp found dcnl dcsp res np int tag data dcnl dcsp tag find tag fid this fiff bem surf ntri dcnl dcsp if tag is none dcnl dcsp dcsp tag find tag fid this fiff fiff mne source space ntri dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp res ntri 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp res ntri int tag data dcnl dcsp else dcnl dcsp dcsp res ntri tag data dcnl dcsp tag find tag fid this fiff fiff mne coord frame dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror coordinate dcsp frame dcsp information dcsp not dcsp found dcnl dcsp res coord frame tag data0 dcnl dcsp tag find tag fid this fiff fiff mne source space points dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror vertex dcsp data dcsp not dcsp found dcnl dcsp res rr tag data astype np float dcnl dcsp if res rr shape0 res np dcnl dcsp dcsp raise valueerror vertex dcsp information dcsp is dcsp incorrect dcnl dcsp tag find tag fid this fiff fiff mne source space normals dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror vertex dcsp normals dcsp not dcsp found dcnl dcsp res nn tag data dcnl dcsp if res nn shape0 res np dcnl dcsp dcsp raise valueerror vertex dcsp normal dcsp information dcsp is dcsp incorrect dcnl dcsp if res ntri 0 dcnl dcsp dcsp tag find tag fid this fiff bem surf triangles dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne source space triangles dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp raise valueerror triangulation dcsp not dcsp found dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp res tris tag data 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp res tris tag data 1 dcnl dcsp dcsp if res tris shape0 res ntri dcnl dcsp dcsp dcsp raise valueerror triangulation dcsp information dcsp is dcsp incorrect dcnl dcsp else dcnl dcsp dcsp res tris none dcnl dcsp tag find tag fid this fiff fiff mne source space nuse dcnl dcsp if tag is none dcnl dcsp dcsp res nuse 0 dcnl dcsp dcsp res inuse np zeros res nuse dtype np int dcnl dcsp dcsp res vertno none dcnl dcsp else dcnl dcsp dcsp res nuse int tag data dcnl dcsp dcsp tag find tag fid this fiff fiff mne source space selection dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise valueerror source dcsp selection dcsp information dcsp missing dcnl dcsp dcsp res inuse tag data astype np int t dcnl dcsp dcsp if len res inuse res np dcnl dcsp dcsp dcsp raise valueerror incorrect dcsp number dcsp of dcsp entries dcsp in dcsp source dcsp space dcsp selection dcnl dcsp dcsp res vertno np where res inuse 0 dcnl dcsp tag1 find tag fid this fiff fiff mne source space nuse tri dcnl dcsp tag2 find tag fid this fiff fiff mne source space use triangles dcnl dcsp if tag1 is none or tag2 is none dcnl dcsp dcsp res nuse tri 0 dcnl dcsp dcsp res use tris none dcnl dcsp else dcnl dcsp dcsp res nuse tri tag1 data dcnl dcsp dcsp res use tris tag2 data 1 dcnl dcsp tag1 find tag fid this fiff fiff mne source space nearest dcnl dcsp tag2 find tag fid this fiff fiff mne source space nearest dist dcnl dcsp if tag1 is none or tag2 is none dcnl dcsp dcsp res nearest none dcnl dcsp dcsp res nearest dist none dcnl dcsp else dcnl dcsp dcsp res nearest tag1 data dcnl dcsp dcsp res nearest dist tag2 data t dcnl dcsp add patch info res dcnl dcsp tag1 find tag fid this fiff fiff mne source space dist dcnl dcsp tag2 find tag fid this fiff fiff mne source space dist limit dcnl dcsp if tag1 is none or tag2 is none dcnl dcsp dcsp res dist none dcnl dcsp dcsp res dist limit none dcnl dcsp else dcnl dcsp dcsp res dist tag1 data dcnl dcsp dcsp res dist limit tag2 data dcnl dcsp dcsp res dist res dist + res dist t dcnl dcsp if res dist is not none dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp distance dcsp information dcsp added dcnl dcsp tag find tag fid this fiff fiff subj his id dcnl dcsp if tag is none dcnl dcsp dcsp res subject his id none dcnl dcsp else dcnl dcsp dcsp res subject his id tag data dcnl dcsp return res
verbose dcnl def complete source space info this verbose none dcsp logger info dcsp dcsp dcsp dcsp completing dcsp triangulation dcsp info dcnl dcsp this tri area np zeros this ntri dcnl dcsp r1 this rr this tris 0 dcnl dcsp r2 this rr this tris 1 dcnl dcsp r3 this rr this tris 2 dcnl dcsp this tri cent r1 + r2 + r3 3 0 dcnl dcsp this tri nn fast cross 3d r2 r1 r3 r1 dcnl dcsp this tri area normalize vectors this tri nn 2 0 dcnl dcsp logger info done dcnl dcsp logger info dcsp dcsp dcsp dcsp completing dcsp selection dcsp triangulation dcsp info dcnl dcsp if this nuse tri 0 dcnl dcsp dcsp r1 this rr this use tris 0 dcnl dcsp dcsp r2 this rr this use tris 1 dcnl dcsp dcsp r3 this rr this use tris 2 dcnl dcsp dcsp this use tri cent r1 + r2 + r3 3 0 dcnl dcsp dcsp this use tri nn fast cross 3d r2 r1 r3 r1 dcnl dcsp dcsp this use tri area np linalg norm this use tri nn axis 1 2 0 dcnl dcsp logger info done
def find source space hemi src dcsp xave src rr 0 sum dcnl dcsp if xave < 0 dcnl dcsp dcsp hemi int fiff fiffv mne surf left hemi dcnl dcsp else dcnl dcsp dcsp hemi int fiff fiffv mne surf right hemi dcnl dcsp return hemi
def label src vertno sel label src dcsp if src0 type surf dcnl dcsp dcsp return exception labels dcsp are dcsp only dcsp supported dcsp with dcsp surface dcsp source dcsp spaces dcnl dcsp vertno src0 vertno src1 vertno dcnl dcsp if label hemi lh dcnl dcsp dcsp vertno sel np intersect1d vertno0 label vertices dcnl dcsp dcsp src sel np searchsorted vertno0 vertno sel dcnl dcsp dcsp vertno0 vertno sel dcnl dcsp dcsp vertno1 np array int dcnl dcsp elif label hemi rh dcnl dcsp dcsp vertno sel np intersect1d vertno1 label vertices dcnl dcsp dcsp src sel np searchsorted vertno1 vertno sel + len vertno0 dcnl dcsp dcsp vertno0 np array int dcnl dcsp dcsp vertno1 vertno sel dcnl dcsp elif label hemi both dcnl dcsp dcsp vertno sel lh np intersect1d vertno0 label lh vertices dcnl dcsp dcsp src sel lh np searchsorted vertno0 vertno sel lh dcnl dcsp dcsp vertno sel rh np intersect1d vertno1 label rh vertices dcnl dcsp dcsp src sel rh np searchsorted vertno1 vertno sel rh + len vertno0 dcnl dcsp dcsp src sel np hstack src sel lh src sel rh dcnl dcsp dcsp vertno vertno sel lh vertno sel rh dcnl dcsp else dcnl dcsp dcsp raise exception unknown dcsp hemisphere dcsp type dcnl dcsp return vertno src sel
verbose dcnl def write source spaces to fid fid src verbose none dcsp for s in src dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp write dcsp a dcsp source dcsp space dcnl dcsp dcsp start block fid fiff fiffb mne source space dcnl dcsp dcsp write one source space fid s verbose dcnl dcsp dcsp end block fid fiff fiffb mne source space dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp done dcnl dcsp logger info dcsp dcsp dcsp dcsp d dcsp source dcsp spaces dcsp written len src
verbose dcnl def write source spaces fname src overwrite false verbose none dcsp check fname fname source dcsp space src fif src fif gz dcnl dcsp check fname fname overwrite overwrite dcnl dcsp fid start file fname dcnl dcsp start block fid fiff fiffb mne dcnl dcsp if src info dcnl dcsp dcsp start block fid fiff fiffb mne env dcnl dcsp dcsp write id fid fiff fiff block id dcnl dcsp dcsp data src info get working dir none dcnl dcsp dcsp if data dcnl dcsp dcsp dcsp write string fid fiff fiff mne env working dir data dcnl dcsp dcsp data src info get command line none dcnl dcsp dcsp if data dcnl dcsp dcsp dcsp write string fid fiff fiff mne env command line data dcnl dcsp dcsp end block fid fiff fiffb mne env dcnl dcsp write source spaces to fid fid src verbose dcnl dcsp end block fid fiff fiffb mne dcnl dcsp end file fid
def write one source space fid this verbose none dcsp if this type surf dcnl dcsp dcsp src type fiff fiffv mne space surface dcnl dcsp elif this type vol dcnl dcsp dcsp src type fiff fiffv mne space volume dcnl dcsp elif this type discrete dcnl dcsp dcsp src type fiff fiffv mne space discrete dcnl dcsp else dcnl dcsp dcsp raise valueerror unknown dcsp source dcsp space dcsp type dcsp s this type dcnl dcsp write int fid fiff fiff mne source space type src type dcnl dcsp if this id 0 dcnl dcsp dcsp write int fid fiff fiff mne source space id this id dcnl dcsp data this get subject his id none dcnl dcsp if data dcnl dcsp dcsp write string fid fiff fiff subj his id data dcnl dcsp write int fid fiff fiff mne coord frame this coord frame dcnl dcsp write int fid fiff fiff mne source space npoints this np dcnl dcsp write float matrix fid fiff fiff mne source space points this rr dcnl dcsp write float matrix fid fiff fiff mne source space normals this nn dcnl dcsp write int fid fiff fiff mne source space selection this inuse dcnl dcsp write int fid fiff fiff mne source space nuse this nuse dcnl dcsp if this ntri 0 dcnl dcsp dcsp write int fid fiff fiff mne source space ntri this ntri dcnl dcsp dcsp write int matrix fid fiff fiff mne source space triangles this tris + 1 dcnl dcsp if this type vol and this use tris is not none dcnl dcsp dcsp write int fid fiff fiff mne source space nuse tri this nuse tri dcnl dcsp dcsp write int matrix fid fiff fiff mne source space use triangles this use tris + 1 dcnl dcsp if this type vol dcnl dcsp dcsp neighbor vert this get neighbor vert none dcnl dcsp dcsp if neighbor vert is not none dcnl dcsp dcsp dcsp nneighbors np array len n for n in neighbor vert dcnl dcsp dcsp dcsp neighbors np concatenate neighbor vert dcnl dcsp dcsp dcsp write int fid fiff fiff mne source space nneighbors nneighbors dcnl dcsp dcsp dcsp write int fid fiff fiff mne source space neighbors neighbors dcnl dcsp dcsp write coord trans fid this src mri t dcnl dcsp dcsp write int fid fiff fiff mne source space voxel dims this shape dcnl dcsp dcsp start block fid fiff fiffb mne parent mri file dcnl dcsp dcsp write coord trans fid this mri ras t dcnl dcsp dcsp write coord trans fid this vox mri t dcnl dcsp dcsp mri volume name this get mri volume name none dcnl dcsp dcsp if mri volume name is not none dcnl dcsp dcsp dcsp write string fid fiff fiff mne file name mri volume name dcnl dcsp dcsp write float sparse rcs fid fiff fiff mne source space interpolator this interpolator dcnl dcsp dcsp if mri file in this and this mri file is not none dcnl dcsp dcsp dcsp write string fid fiff fiff mne source space mri file this mri file dcnl dcsp dcsp write int fid fiff fiff mri width this mri width dcnl dcsp dcsp write int fid fiff fiff mri height this mri height dcnl dcsp dcsp write int fid fiff fiff mri depth this mri depth dcnl dcsp dcsp end block fid fiff fiffb mne parent mri file dcnl dcsp if this nearest is not none dcnl dcsp dcsp write int fid fiff fiff mne source space nearest this nearest dcnl dcsp dcsp write float matrix fid fiff fiff mne source space nearest dist this nearest dist dcnl dcsp if this dist is not none dcnl dcsp dcsp dists this dist copy dcnl dcsp dcsp dists sparse triu dists format dists format dcnl dcsp dcsp write float sparse rcs fid fiff fiff mne source space dist dists dcnl dcsp dcsp write float matrix fid fiff fiff mne source space dist limit this dist limit dcnl dcsp if this type vol and seg name in this dcnl dcsp dcsp write string fid fiff fiff comment this seg name
verbose dcnl def vertex to mni vertices hemis subject subjects dir none mode none verbose none dcsp if not has freesurfer and not has nibabel dcnl dcsp dcsp raise runtimeerror nibabel dcsp python dcsp or dcsp freesurfer dcsp unix dcsp must dcsp be dcsp correctly dcsp installed dcsp and dcsp accessible dcsp from dcsp python dcnl dcsp if not isinstance vertices list and not isinstance vertices np ndarray dcnl dcsp dcsp vertices vertices dcnl dcsp if not isinstance hemis list and not isinstance hemis np ndarray dcnl dcsp dcsp hemis hemis len vertices dcnl dcsp if not len hemis len vertices dcnl dcsp dcsp raise valueerror hemi dcsp and dcsp vertices dcsp must dcsp match dcsp in dcsp length dcnl dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp surfs op join subjects dir subject surf s white h for h in lh rh dcnl dcsp rr read surface s 0 for s in surfs dcnl dcsp xfm read talxfm subject subjects dir mode dcnl dcsp data np array rrhv for h v in zip hemis vertices dcnl dcsp return apply trans xfm trans data
verbose dcnl def read talxfm subject subjects dir mode none verbose none dcsp if mode is not none and mode not in nibabel freesurfer dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp nibabel dcsp or dcsp freesurfer dcnl dcsp fname op join subjects dir subject mri transforms talairach xfm dcnl dcsp with open fname r as fid dcnl dcsp dcsp logger debug reading dcsp freesurfer dcsp talairach xfm dcsp file n s fname dcnl dcsp dcsp got it false dcnl dcsp dcsp comp linear transform dcnl dcsp dcsp for line in fid dcnl dcsp dcsp dcsp if line len comp comp dcnl dcsp dcsp dcsp dcsp got it true dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp if got it dcnl dcsp dcsp dcsp xfm list dcnl dcsp dcsp dcsp for ii line in enumerate fid dcnl dcsp dcsp dcsp dcsp digs float s for s in line strip n split dcnl dcsp dcsp dcsp dcsp xfm append digs dcnl dcsp dcsp dcsp dcsp if ii 2 dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp xfm append 0 0 0 0 0 0 1 0 dcnl dcsp dcsp dcsp xfm np array xfm dtype float dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror failed dcsp to dcsp find dcsp linear transform dcsp string dcsp in dcsp xfm dcsp file n s fname dcnl dcsp ras mni t from fiff fiffv mne coord ras to fiff fiffv mne coord mni tal trans xfm dcnl dcsp path op join subjects dir subject mri orig mgz dcnl dcsp if not op isfile path dcnl dcsp dcsp path op join subjects dir subject mri t1 mgz dcnl dcsp if not op isfile path dcnl dcsp dcsp raise ioerror mri dcsp not dcsp found dcsp s path dcnl dcsp if has nibabel dcnl dcsp dcsp use nibabel true dcnl dcsp else dcnl dcsp dcsp use nibabel false dcnl dcsp dcsp if mode nibabel dcnl dcsp dcsp dcsp raise importerror tried dcsp to dcsp import dcsp nibabel dcsp but dcsp failed dcsp try dcsp using dcsp mode none dcsp or dcsp mode freesurfer dcnl dcsp if use nibabel is true and mode freesurfer dcnl dcsp dcsp use nibabel false dcnl dcsp if use nibabel dcnl dcsp dcsp hdr get mri header path dcnl dcsp dcsp n orig hdr get vox2ras dcnl dcsp dcsp ds np array hdr get zooms dcnl dcsp dcsp ns np array hdr get data shape 3 ds 2 0 dcnl dcsp dcsp t orig np array ds0 0 0 ns0 0 0 ds2 ns2 0 ds1 0 ns1 0 0 0 1 dtype float dcnl dcsp dcsp nt orig n orig t orig dcnl dcsp else dcnl dcsp dcsp nt orig list dcnl dcsp dcsp for conv in vox2ras vox2rastkr dcnl dcsp dcsp dcsp stdout stderr run subprocess mri info conv path dcnl dcsp dcsp dcsp stdout np fromstring stdout sep dcsp astype float dcnl dcsp dcsp dcsp if not stdout size 16 dcnl dcsp dcsp dcsp dcsp raise valueerror could dcsp not dcsp parse dcsp freesurfer dcsp mri info dcsp output dcnl dcsp dcsp dcsp nt orig append stdout reshape 4 4 dcnl dcsp n orig nt orig0 dcnl dcsp vox ras t from fiff fiffv mne coord mri voxel to fiff fiffv mne coord ras trans n orig dcnl dcsp t orig nt orig1 dcnl dcsp vox mri t transform mri voxel mri t orig dcnl dcsp mri vox t invert transform vox mri t dcnl dcsp mri ras t combine transforms mri vox t vox ras t mri ras dcnl dcsp mri mni t combine transforms mri ras t ras mni t mri mni tal dcnl dcsp return mri mni t
verbose dcnl def check spacing spacing verbose none dcsp space err spacing dcsp must dcsp be dcsp a dcsp string dcsp with dcsp values dcsp ico dcsp oct dcsp or dcsp all dcsp and dcsp ico dcsp and dcsp oct numbers dcsp must dcsp be dcsp integers dcnl dcsp if not isinstance spacing string types or len spacing < 3 dcnl dcsp dcsp raise valueerror space err dcnl dcsp if spacing all dcnl dcsp dcsp stype all dcnl dcsp dcsp sval dcnl dcsp elif spacing 3 ico dcnl dcsp dcsp stype ico dcnl dcsp dcsp sval spacing3 dcnl dcsp elif spacing 3 oct dcnl dcsp dcsp stype oct dcnl dcsp dcsp sval spacing3 dcnl dcsp else dcnl dcsp dcsp raise valueerror space err dcnl dcsp try dcnl dcsp dcsp if stype in ico oct dcnl dcsp dcsp dcsp sval int sval dcnl dcsp dcsp elif stype spacing dcnl dcsp dcsp dcsp sval float sval dcnl dcsp except exception dcnl dcsp dcsp raise valueerror space err dcnl dcsp if stype all dcnl dcsp dcsp logger info include dcsp all dcsp vertices dcnl dcsp dcsp ico surf none dcnl dcsp dcsp src type str all dcnl dcsp else dcnl dcsp dcsp src type str s dcsp dcsp s stype sval dcnl dcsp dcsp if stype ico dcnl dcsp dcsp dcsp logger info icosahedron dcsp subdivision dcsp grade dcsp s sval dcnl dcsp dcsp dcsp ico surf get ico surface sval dcnl dcsp dcsp elif stype oct dcnl dcsp dcsp dcsp logger info octahedron dcsp subdivision dcsp grade dcsp s sval dcnl dcsp dcsp dcsp ico surf tessellate sphere surf sval dcnl dcsp return stype sval ico surf src type str
verbose dcnl def setup source space subject spacing oct6 surface white subjects dir none add dist true n jobs 1 verbose none dcsp cmd setup source space s dcsp spacing s dcsp surface s dcsp subjects dir s dcsp add dist s dcsp verbose s subject spacing surface subjects dir add dist verbose dcnl dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp surfs op join subjects dir subject surf hemi + surface for hemi in lh rh dcnl dcsp for surf hemi in zip surfs lh rh dcnl dcsp dcsp if surf is not none and not op isfile surf dcnl dcsp dcsp dcsp raise ioerror could dcsp not dcsp find dcsp the dcsp s dcsp surface dcsp s hemi surf dcnl dcsp logger info setting dcsp up dcsp the dcsp source dcsp space dcsp with dcsp the dcsp following dcsp parameters n dcnl dcsp logger info subjects dir dcsp dcsp s subjects dir dcnl dcsp logger info subject dcsp dcsp dcsp dcsp dcsp dcsp dcsp s subject dcnl dcsp logger info surface dcsp dcsp dcsp dcsp dcsp dcsp dcsp s surface dcnl dcsp stype sval ico surf src type str check spacing spacing dcnl dcsp logger info dcnl dcsp del spacing dcnl dcsp logger info dcsp 1 dcsp creating dcsp the dcsp source dcsp space n dcnl dcsp src dcnl dcsp if stype all dcnl dcsp dcsp logger info doing dcsp the dcsp shedral dcsp vertex dcsp picking dict ico icosa oct octa stype dcnl dcsp for hemi surf in zip lh rh surfs dcnl dcsp dcsp logger info loading dcsp s surf dcnl dcsp dcsp if stype all dcnl dcsp dcsp dcsp logger info mapping dcsp s dcsp s dcsp dcsp s dcsp d dcsp hemi subject stype sval dcnl dcsp dcsp s create surf spacing surf hemi subject stype ico surf subjects dir dcnl dcsp dcsp logger info loaded dcsp s dcsp d d dcsp selected dcsp to dcsp source dcsp space dcsp s op split surf 1 s nuse s np src type str dcnl dcsp dcsp src append s dcnl dcsp dcsp logger info dcnl dcsp hemi ids fiff fiffv mne surf left hemi fiff fiffv mne surf right hemi dcnl dcsp for s s id in zip src hemi ids dcnl dcsp dcsp s update dict dist none dist limit none nearest none type surf nearest dist none pinfo none patch inds none id s id coord frame fiff fiffv coord mri dcnl dcsp dcsp s rr 1000 0 dcnl dcsp dcsp del s tri area dcnl dcsp dcsp del s tri cent dcnl dcsp dcsp del s tri nn dcnl dcsp dcsp del s neighbor tri dcnl dcsp src sourcespaces src dict working dir os getcwd command line cmd dcnl dcsp if add dist dcnl dcsp dcsp add source space distances src n jobs n jobs verbose verbose dcnl dcsp logger info you dcsp are dcsp now dcsp one dcsp step dcsp closer dcsp to dcsp computing dcsp the dcsp gain dcsp matrix dcnl dcsp return src
verbose dcnl def setup volume source space subject none pos 5 0 mri none sphere 0 0 0 0 0 0 90 0 bem none surface none mindist 5 0 exclude 0 0 subjects dir none volume label none add interpolator true verbose none dcsp subjects dir get subjects dir subjects dir dcnl dcsp if bem is not none and surface is not none dcnl dcsp dcsp raise valueerror only dcsp one dcsp of dcsp bem dcsp and dcsp surface dcsp should dcsp be dcsp specified dcnl dcsp if mri is not none dcnl dcsp dcsp if not op isfile mri dcnl dcsp dcsp dcsp if subject is none dcnl dcsp dcsp dcsp dcsp raise ioerror mri dcsp file dcsp s dcsp not dcsp found mri dcnl dcsp dcsp dcsp mri op join subjects dir subject mri mri dcnl dcsp dcsp dcsp if not op isfile mri dcnl dcsp dcsp dcsp dcsp raise ioerror mri dcsp file dcsp s dcsp not dcsp found mri dcnl dcsp dcsp if isinstance pos dict dcnl dcsp dcsp dcsp raise valueerror cannot dcsp create dcsp interpolation dcsp matrix dcsp for dcsp discrete dcsp source dcsp space dcsp mri dcsp must dcsp be dcsp none dcsp if dcsp pos dcsp is dcsp a dcsp dict dcnl dcsp if volume label is not none dcnl dcsp dcsp if mri is none dcnl dcsp dcsp dcsp raise runtimeerror mri dcsp must dcsp be dcsp provided dcsp if dcsp volume label dcsp is dcsp not dcsp none dcnl dcsp dcsp if not isinstance volume label list dcnl dcsp dcsp dcsp volume label volume label dcnl dcsp dcsp volume labels get volume labels from aseg mri dcnl dcsp dcsp for label in volume label dcnl dcsp dcsp dcsp if label not in volume labels dcnl dcsp dcsp dcsp dcsp raise valueerror volume dcsp s dcsp not dcsp found dcsp in dcsp file dcsp s dcsp double dcsp check dcsp dcsp freesurfer dcsp lookup dcsp table label mri dcnl dcsp sphere np asarray sphere dcnl dcsp if sphere size 4 dcnl dcsp dcsp raise valueerror sphere dcsp must dcsp be dcsp array like dcsp with dcsp 4 dcsp elements dcnl dcsp if bem is not none dcnl dcsp dcsp logger info bem dcsp file dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s bem dcnl dcsp elif surface is not none dcnl dcsp dcsp if isinstance surface dict dcnl dcsp dcsp dcsp if not all key in surface for key in rr tris dcnl dcsp dcsp dcsp dcsp raise keyerror surface dcsp if dcsp dict dcsp must dcsp have dcsp entries dcsp rr dcsp and dcsp tris dcnl dcsp dcsp dcsp complete surface info surface copy false verbose false dcnl dcsp dcsp dcsp surf extra dict dcnl dcsp dcsp elif isinstance surface string types dcnl dcsp dcsp dcsp if not op isfile surface dcnl dcsp dcsp dcsp dcsp raise ioerror surface dcsp file dcsp s dcsp not dcsp found surface dcnl dcsp dcsp dcsp surf extra surface dcnl dcsp dcsp logger info boundary dcsp surface dcsp file dcsp dcsp s surf extra dcnl dcsp else dcnl dcsp dcsp logger info sphere dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp origin dcsp at dcsp 1f dcsp 1f dcsp 1f dcsp mm sphere0 sphere1 sphere2 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp radius dcsp dcsp dcsp 1f dcsp mm sphere3 dcnl dcsp if isinstance pos dict dcnl dcsp dcsp if not all key in pos for key in rr nn dcnl dcsp dcsp dcsp raise keyerror pos dcsp if dcsp dict dcsp must dcsp contain dcsp rr dcsp and dcsp nn dcnl dcsp dcsp pos extra dict dcnl dcsp else dcnl dcsp dcsp try dcnl dcsp dcsp dcsp pos float pos dcnl dcsp dcsp except typeerror valueerror dcnl dcsp dcsp dcsp raise valueerror pos dcsp must dcsp be dcsp a dcsp dict dcsp or dcsp something dcsp that dcsp can dcsp be dcsp cast dcsp to dcsp float dcnl dcsp if not isinstance pos float dcnl dcsp dcsp logger info source dcsp location dcsp file dcsp dcsp dcsp s pos extra dcnl dcsp dcsp logger info assuming dcsp input dcsp in dcsp millimeters dcnl dcsp dcsp logger info assuming dcsp input dcsp in dcsp mri dcsp coordinates dcnl dcsp if isinstance pos float dcnl dcsp dcsp logger info grid dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1f dcsp mm pos dcnl dcsp dcsp logger info mindist dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1f dcsp mm mindist dcnl dcsp dcsp pos 1000 0 dcnl dcsp if exclude 0 0 dcnl dcsp dcsp logger info exclude dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1f dcsp mm exclude dcnl dcsp if mri is not none dcnl dcsp dcsp logger info mri dcsp volume dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s mri dcnl dcsp exclude 1000 0 dcnl dcsp logger info dcnl dcsp if not isinstance pos float dcnl dcsp dcsp sp make discrete source space pos dcnl dcsp else dcnl dcsp dcsp if bem is not none dcnl dcsp dcsp dcsp surf read bem surfaces bem s id fiff fiffv bem surf id brain verbose false dcnl dcsp dcsp dcsp logger info loaded dcsp inner dcsp skull dcsp from dcsp s dcsp d dcsp nodes bem surf np dcnl dcsp dcsp elif surface is not none dcnl dcsp dcsp dcsp if isinstance surface string types dcnl dcsp dcsp dcsp dcsp surf read surface surface return dict true 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp surf surface dcnl dcsp dcsp dcsp logger info loaded dcsp bounding dcsp surface dcsp from dcsp s dcsp d dcsp nodes surface surf np dcnl dcsp dcsp dcsp surf deepcopy surf dcnl dcsp dcsp dcsp surf rr 0 001 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info setting dcsp up dcsp the dcsp sphere dcnl dcsp dcsp dcsp surf dict r sphere3 1000 0 r0 sphere 3 1000 0 dcnl dcsp dcsp if volume label is not none dcnl dcsp dcsp dcsp sp dcnl dcsp dcsp dcsp for label in volume label dcnl dcsp dcsp dcsp dcsp vol sp make volume source space surf pos exclude mindist mri label dcnl dcsp dcsp dcsp dcsp sp append vol sp dcnl dcsp dcsp else dcnl dcsp dcsp dcsp sp make volume source space surf pos exclude mindist mri volume label dcnl dcsp if not isinstance sp list dcnl dcsp dcsp sp sp dcnl dcsp if mri is not none dcnl dcsp dcsp for s in sp dcnl dcsp dcsp dcsp add interpolator s mri add interpolator dcnl dcsp elif sp0 type vol dcnl dcsp dcsp sp0 type discrete dcnl dcsp for s in sp dcnl dcsp dcsp if vol dims in s dcnl dcsp dcsp dcsp del s vol dims dcnl dcsp for s in sp dcnl dcsp dcsp s update dict nearest none dist none use tris none patch inds none dist limit none pinfo none ntri 0 nearest dist none nuse tri 0 tris none subject his id subject dcnl dcsp sp sourcespaces sp dict working dir os getcwd command line none dcnl dcsp return sp
def make voxel ras trans move ras voxel size dcsp assert voxel size ndim 1 dcnl dcsp assert voxel size size 3 dcnl dcsp rot ras t voxel sizenp newaxis dcnl dcsp assert rot ndim 2 dcnl dcsp assert rot shape0 3 dcnl dcsp assert rot shape1 3 dcnl dcsp trans np c np r rot np zeros 1 3 np r move 1 0 dcnl dcsp t transform mri voxel mri trans dcnl dcsp return t
def make discrete source space pos coord frame mri dcsp if coord frame not in str to frame dcnl dcsp dcsp raise keyerror coord frame dcsp must dcsp be dcsp one dcsp of dcsp s dcsp not dcsp s list str to frame keys coord frame dcnl dcsp coord frame str to framecoord frame dcnl dcsp rr np array pos rr float dcnl dcsp nn np array pos nn float dcnl dcsp if not rr ndim nn ndim 2 and nn shape0 nn shape0 and rr shape1 nn shape1 dcnl dcsp dcsp raise runtimeerror rr dcsp and dcsp nn dcsp must dcsp both dcsp be dcsp 2d dcsp arrays dcsp with dcsp the dcsp same dcsp number dcsp of dcsp rows dcsp and dcsp 3 dcsp columns dcnl dcsp npts rr shape0 dcnl dcsp normalize vectors nn dcnl dcsp nz np sum np sum nn nn axis 1 0 dcnl dcsp if nz 0 dcnl dcsp dcsp raise runtimeerror d dcsp sources dcsp have dcsp zero dcsp length dcsp normal nz dcnl dcsp logger info positions dcsp in dcsp meters dcsp and dcsp orientations dcnl dcsp logger info d dcsp sources npts dcnl dcsp sp dict coord frame coord frame type discrete nuse npts np npts inuse np ones npts int vertno np arange npts rr rr nn nn id 1 dcnl dcsp return sp
def make volume source space surf grid exclude mindist mri none volume label none do neighbors true n jobs 1 dcsp if rr in surf dcnl dcsp dcsp mins np min surf rr axis 0 dcnl dcsp dcsp maxs np max surf rr axis 0 dcnl dcsp dcsp cm np mean surf rr axis 0 dcnl dcsp dcsp maxdist np linalg norm surf rr cm axis 1 max dcnl dcsp else dcnl dcsp dcsp mins surf r0 surf r dcnl dcsp dcsp maxs surf r0 + surf r dcnl dcsp dcsp cm surf r0 copy dcnl dcsp dcsp maxdist surf r dcnl dcsp logger info surface dcsp cm dcsp dcsp 6 1f dcsp 6 1f dcsp 6 1f dcsp mm 1000 cm0 1000 cm1 1000 cm2 dcnl dcsp logger info surface dcsp fits dcsp inside dcsp a dcsp sphere dcsp with dcsp radius dcsp 6 1f dcsp mm 1000 maxdist dcnl dcsp logger info surface dcsp extent dcnl dcsp for c mi ma in zip xyz mins maxs dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp s dcsp dcsp 6 1f dcsp dcsp 6 1f dcsp mm c 1000 mi 1000 ma dcnl dcsp maxn np array np floor np abs m grid + 1 if m 0 else np floor np abs m grid 1 for m in maxs int dcnl dcsp minn np array np floor np abs m grid + 1 if m 0 else np floor np abs m grid 1 for m in mins int dcnl dcsp logger info grid dcsp extent dcnl dcsp for c mi ma in zip xyz minn maxn dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp s dcsp dcsp 6 1f dcsp dcsp 6 1f dcsp mm c 1000 mi grid 1000 ma grid dcnl dcsp ns maxn minn + 1 dcnl dcsp npts np prod ns dcnl dcsp nrow ns0 dcnl dcsp ncol ns1 dcnl dcsp nplane nrow ncol dcnl dcsp rr np meshgrid np arange minn2 maxn2 + 1 np arange minn1 maxn1 + 1 np arange minn0 maxn0 + 1 indexing ij dcnl dcsp x y z rr2 ravel rr1 ravel rr0 ravel dcnl dcsp rr np array x grid y grid z grid t dcnl dcsp sp dict np npts nn np zeros npts 3 rr rr inuse np ones npts int type vol nuse npts coord frame fiff fiffv coord mri id 1 shape ns dcnl dcsp sp nn 2 1 0 dcnl dcsp assert sp rr shape0 npts dcnl dcsp logger info d dcsp sources dcsp before dcsp omitting dcsp any sp nuse dcnl dcsp dists np linalg norm sp rr cm axis 1 dcnl dcsp bads np where np logical or dists < exclude dists maxdist 0 dcnl dcsp sp inuse bads false dcnl dcsp sp nuse len bads dcnl dcsp logger info d dcsp sources dcsp after dcsp omitting dcsp infeasible dcsp sources sp nuse dcnl dcsp if rr in surf dcnl dcsp dcsp filter source spaces surf mindist none sp n jobs dcnl dcsp else dcnl dcsp dcsp vertno np where sp inuse 0 dcnl dcsp dcsp bads np linalg norm sp rr vertno surf r0 axis 1 surf r mindist 1000 0 dcnl dcsp dcsp sp nuse bads sum dcnl dcsp dcsp sp inuse vertnobads false dcnl dcsp dcsp sp vertno np where sp inuse 0 dcnl dcsp dcsp del vertno dcnl dcsp del surf dcnl dcsp logger info d dcsp sources dcsp remaining dcsp after dcsp excluding dcsp the dcsp sources dcsp outside dcsp the dcsp surface dcsp and dcsp less dcsp than dcsp 6 1f dcsp mm dcsp inside sp nuse mindist dcnl dcsp if not do neighbors dcnl dcsp dcsp if volume label is not none dcnl dcsp dcsp dcsp raise runtimeerror volume label dcsp cannot dcsp be dcsp none dcsp unless dcsp do neighbors dcsp is dcsp true dcnl dcsp dcsp return sp dcnl dcsp k np arange npts dcnl dcsp neigh np empty 26 npts int dcnl dcsp neigh fill 1 dcnl dcsp idxs z minn2 x < maxn0 y < maxn1 x minn0 y minn1 z < maxn2 dcnl dcsp offsets nplane 1 nrow 1 nrow nplane dcnl dcsp for n idx offset in zip neigh 6 idxs offsets dcnl dcsp dcsp nidx kidx + offset dcnl dcsp idx1 z minn2 dcnl dcsp idx2 np logical and idx1 x < maxn0 dcnl dcsp neigh 6 idx2 kidx2 + 1 nplane dcnl dcsp idx3 np logical and idx2 y < maxn1 dcnl dcsp neigh 7 idx3 kidx3 + 1 + nrow nplane dcnl dcsp idx2 np logical and idx1 y < maxn1 dcnl dcsp neigh 8 idx2 kidx2 + nrow nplane dcnl dcsp idx2 np logical and idx1 x minn0 dcnl dcsp idx3 np logical and idx2 y < maxn1 dcnl dcsp neigh 9 idx3 kidx3 1 + nrow nplane dcnl dcsp neigh 10 idx2 kidx2 1 nplane dcnl dcsp idx3 np logical and idx2 y minn1 dcnl dcsp neigh 11 idx3 kidx3 1 nrow nplane dcnl dcsp idx2 np logical and idx1 y minn1 dcnl dcsp neigh 12 idx2 kidx2 nrow nplane dcnl dcsp idx3 np logical and idx2 x < maxn0 dcnl dcsp neigh 13 idx3 kidx3 + 1 nrow nplane dcnl dcsp idx1 np logical and x < maxn0 y < maxn1 dcnl dcsp neigh 14 idx1 kidx1 + 1 + nrow dcnl dcsp idx1 x minn0 dcnl dcsp idx2 np logical and idx1 y < maxn1 dcnl dcsp neigh 15 idx2 kidx2 1 + nrow dcnl dcsp idx2 np logical and idx1 y minn1 dcnl dcsp neigh 16 idx2 kidx2 1 nrow dcnl dcsp idx1 np logical and y minn1 x < maxn0 dcnl dcsp neigh 17 idx1 kidx1 + 1 nrow nplane dcnl dcsp idx1 z < maxn2 dcnl dcsp idx2 np logical and idx1 x < maxn0 dcnl dcsp neigh 18 idx2 kidx2 + 1 + nplane dcnl dcsp idx3 np logical and idx2 y < maxn1 dcnl dcsp neigh 19 idx3 kidx3 + 1 + nrow + nplane dcnl dcsp idx2 np logical and idx1 y < maxn1 dcnl dcsp neigh 20 idx2 kidx2 + nrow + nplane dcnl dcsp idx2 np logical and idx1 x minn0 dcnl dcsp idx3 np logical and idx2 y < maxn1 dcnl dcsp neigh 21 idx3 kidx3 1 + nrow + nplane dcnl dcsp neigh 22 idx2 kidx2 1 + nplane dcnl dcsp idx3 np logical and idx2 y minn1 dcnl dcsp neigh 23 idx3 kidx3 1 nrow + nplane dcnl dcsp idx2 np logical and idx1 y minn1 dcnl dcsp neigh 24 idx2 kidx2 nrow + nplane dcnl dcsp idx3 np logical and idx2 x < maxn0 dcnl dcsp neigh 25 idx3 kidx3 + 1 nrow + nplane dcnl dcsp if volume label is not none dcnl dcsp dcsp try dcnl dcsp dcsp dcsp import nibabel as nib dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp raise importerror nibabel dcsp is dcsp required dcsp to dcsp read dcsp segmentation dcsp file dcnl dcsp dcsp logger info selecting dcsp voxels dcsp from dcsp s volume label dcnl dcsp dcsp mgz nib load mri dcnl dcsp dcsp mgz data mgz get data dcnl dcsp dcsp lut get lut dcnl dcsp dcsp vol id get lut id lut volume label true dcnl dcsp dcsp vox bool mgz data vol id dcnl dcsp dcsp vox xyz np array np where vox bool t dcnl dcsp dcsp trans get mgz header mri vox2ras tkr dcnl dcsp dcsp trans 3 1000 0 dcnl dcsp dcsp rr voi apply trans trans vox xyz dcnl dcsp dcsp dists compute nearest rr voi sp rr return dists true 1 dcnl dcsp dcsp maxdist np linalg norm trans 3 3 sum 0 2 0 dcnl dcsp dcsp bads np where dists maxdist 0 dcnl dcsp dcsp sp inuse bads false dcnl dcsp dcsp sp vertno np where sp inuse 0 0 dcnl dcsp dcsp sp nuse len sp vertno dcnl dcsp dcsp sp seg name volume label dcnl dcsp dcsp sp mri file mri dcnl dcsp dcsp logger info d dcsp sources dcsp remaining dcsp after dcsp excluding dcsp sources dcsp too dcsp far dcsp from dcsp voi dcsp voxels sp nuse dcnl dcsp logger info adjusting dcsp the dcsp neighborhood dcsp info dcnl dcsp log inuse sp inuse 0 dcnl dcsp neigh np logical not log inuse 1 dcnl dcsp vertno np where log inuse 0 dcnl dcsp sp vertno vertno dcnl dcsp old shape neigh shape dcnl dcsp neigh neigh ravel dcnl dcsp checks np where neigh 0 0 dcnl dcsp removes np logical not np in1d checks vertno dcnl dcsp neighchecksremoves 1 dcnl dcsp neigh shape old shape dcnl dcsp neigh neigh t dcnl dcsp sp neighbor vert neigh dcnl dcsp r0 minn grid dcnl dcsp voxel size grid np ones 3 dcnl dcsp ras np eye 3 dcnl dcsp sp src mri t make voxel ras trans r0 ras voxel size dcnl dcsp sp vol dims maxn minn + 1 dcnl dcsp return sp
def get mri header fname dcsp import nibabel as nib dcnl dcsp img nib load fname dcnl dcsp try dcnl dcsp dcsp return img header dcnl dcsp except attributeerror dcnl dcsp dcsp return img get header
def get mgz header fname dcsp if not fname endswith mgz dcnl dcsp dcsp raise ioerror filename dcsp must dcsp end dcsp with dcsp mgz dcnl dcsp header dtd version i4 dims i4 4 type i4 dof i4 goodrasflag i2 delta f4 3 mdc f4 3 3 pxyz c f4 3 dcnl dcsp header dtype np dtype header dtd dcnl dcsp with gzipfile fname rb as fid dcnl dcsp dcsp hdr str fid read header dtype itemsize dcnl dcsp header np ndarray shape dtype header dtype buffer hdr str dcnl dcsp dims header dims astype int dcnl dcsp dims dims 3 if len dims 4 else dims dcnl dcsp delta header delta dcnl dcsp ds np array delta float dcnl dcsp ns np array dims ds 2 0 dcnl dcsp v2rtkr np array ds0 0 0 ns0 0 0 ds2 ns2 0 ds1 0 ns1 0 0 0 1 dtype np float32 dcnl dcsp d np diag delta dcnl dcsp pcrs c dims 2 0 dcnl dcsp mdc header mdc t dcnl dcsp pxyz 0 header pxyz c np dot mdc np dot d pcrs c dcnl dcsp m np eye 4 4 dcnl dcsp m0 3 0 3 np dot mdc d dcnl dcsp m0 3 3 pxyz 0 t dcnl dcsp m linalg inv m dcnl dcsp header dict dims dims vox2ras tkr v2rtkr ras2vox m dcnl dcsp return header
def add interpolator s mri name add interpolator dcsp logger info reading dcsp s mri name dcnl dcsp header get mgz header mri name dcnl dcsp mri width mri height mri depth header dims dcnl dcsp s update dict mri width mri width mri height mri height mri depth mri depth dcnl dcsp trans header vox2ras tkr copy dcnl dcsp trans 3 1000 0 dcnl dcsp s vox mri t transform mri voxel mri trans dcnl dcsp trans linalg inv np dot header vox2ras tkr header ras2vox dcnl dcsp trans 3 3 1000 0 dcnl dcsp s mri ras t transform mri ras trans dcnl dcsp s mri volume name mri name dcnl dcsp nvox mri width mri height mri depth dcnl dcsp if not add interpolator dcnl dcsp dcsp s interpolator sparse csr matrix nvox s np dcnl dcsp dcsp return dcnl dcsp print coord trans s src mri t source dcsp space dcsp dcsp dcnl dcsp print coord trans s vox mri t mri dcsp volume dcsp dcsp dcnl dcsp print coord trans s mri ras t mri dcsp volume dcsp dcsp dcnl dcsp combo trans combine transforms s vox mri t invert transform s src mri t mri voxel mri voxel dcnl dcsp combo trans trans combo trans trans astype np float32 dcnl dcsp logger info setting dcsp up dcsp interpolation dcnl dcsp data dcnl dcsp indices dcnl dcsp indptr np zeros nvox + 1 np int32 dcnl dcsp for p in range mri depth dcnl dcsp dcsp js np arange mri width dtype np float32 dcnl dcsp dcsp js np tile jsnp newaxis mri height 1 ravel dcnl dcsp dcsp ks np arange mri height dtype np float32 dcnl dcsp dcsp ks np tile ks np newaxis 1 mri width ravel dcnl dcsp dcsp ps np empty mri height mri width np float32 ravel dcnl dcsp dcsp ps fill p dcnl dcsp dcsp r0 np c js ks ps dcnl dcsp dcsp del js ks ps dcnl dcsp dcsp r0 apply trans combo trans trans r0 dcnl dcsp dcsp rn np floor r0 astype int dcnl dcsp dcsp maxs s vol dims 1 np newaxis dcnl dcsp dcsp good np where np logical and np all rn 0 axis 1 np all rn < maxs axis 1 0 dcnl dcsp dcsp rn rngood dcnl dcsp dcsp r0 r0good dcnl dcsp dcsp jj rn 0 dcnl dcsp dcsp kk rn 1 dcnl dcsp dcsp pp rn 2 dcnl dcsp dcsp vss np empty len jj 8 np int32 dcnl dcsp dcsp width s vol dims 0 dcnl dcsp dcsp height s vol dims 1 dcnl dcsp dcsp jjp1 jj + 1 dcnl dcsp dcsp kkp1 kk + 1 dcnl dcsp dcsp ppp1 pp + 1 dcnl dcsp dcsp vss 0 vol vertex width height jj kk pp dcnl dcsp dcsp vss 1 vol vertex width height jjp1 kk pp dcnl dcsp dcsp vss 2 vol vertex width height jjp1 kkp1 pp dcnl dcsp dcsp vss 3 vol vertex width height jj kkp1 pp dcnl dcsp dcsp vss 4 vol vertex width height jj kk ppp1 dcnl dcsp dcsp vss 5 vol vertex width height jjp1 kk ppp1 dcnl dcsp dcsp vss 6 vol vertex width height jjp1 kkp1 ppp1 dcnl dcsp dcsp vss 7 vol vertex width height jj kkp1 ppp1 dcnl dcsp dcsp del jj kk pp jjp1 kkp1 ppp1 dcnl dcsp dcsp uses np any s inuse vss axis 1 dcnl dcsp dcsp if uses size 0 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp vss vssuses ravel dcnl dcsp dcsp indices append vss dcnl dcsp dcsp indptr gooduses + p mri height mri width + 1 8 dcnl dcsp dcsp del vss dcnl dcsp dcsp r0 r0uses dcnl dcsp dcsp rn rnuses dcnl dcsp dcsp del uses good dcnl dcsp dcsp xf r0 0 rn 0 astype np float32 dcnl dcsp dcsp yf r0 1 rn 1 astype np float32 dcnl dcsp dcsp zf r0 2 rn 2 astype np float32 dcnl dcsp dcsp omxf 1 0 xf dcnl dcsp dcsp omyf 1 0 yf dcnl dcsp dcsp omzf 1 0 zf dcnl dcsp dcsp data append np array omxf omyf omzf xf omyf omzf xf yf omzf omxf yf omzf omxf omyf zf xf omyf zf xf yf zf omxf yf zf order f t ravel dcnl dcsp dcsp del xf yf zf omxf omyf omzf dcnl dcsp indptr np cumsum indptr out indptr dcnl dcsp indices np concatenate indices dcnl dcsp data np concatenate data dcnl dcsp s interpolator sparse csr matrix data indices indptr shape nvox s np dcnl dcsp logger info dcsp d d dcsp nonzero dcsp values dcsp done len data nvox
verbose dcnl def filter source spaces surf limit mri head t src n jobs 1 verbose none dcsp if src0 coord frame fiff fiffv coord head and mri head t is none dcnl dcsp dcsp raise runtimeerror source dcsp spaces dcsp are dcsp in dcsp head dcsp coordinates dcsp and dcsp no dcsp coordinate dcsp transform dcsp was dcsp provided dcnl dcsp out str source dcsp spaces dcsp are dcsp in dcsp dcnl dcsp if src0 coord frame fiff fiffv coord head dcnl dcsp dcsp inv trans invert transform mri head t dcnl dcsp dcsp out str + head dcsp coordinates dcnl dcsp elif src0 coord frame fiff fiffv coord mri dcnl dcsp dcsp out str + mri dcsp coordinates dcnl dcsp else dcnl dcsp dcsp out str + unknown dcsp d dcsp coordinates src0 coord frame dcnl dcsp logger info out str dcnl dcsp out str checking dcsp that dcsp the dcsp sources dcsp are dcsp inside dcsp the dcsp bounding dcsp surface dcnl dcsp if limit 0 0 dcnl dcsp dcsp out str + dcsp and dcsp at dcsp least dcsp 6 1f dcsp mm dcsp away limit dcnl dcsp logger info out str + dcsp will dcsp take dcsp a dcsp few dcnl dcsp for s in src dcnl dcsp dcsp vertno np where s inuse 0 dcnl dcsp dcsp r1s s rr vertno dcnl dcsp dcsp if s coord frame fiff fiffv coord head dcnl dcsp dcsp dcsp r1s apply trans inv trans trans r1s dcnl dcsp dcsp outside points outside surface r1s surf n jobs dcnl dcsp dcsp omit outside np sum outside dcnl dcsp dcsp omit 0 dcnl dcsp dcsp if limit 0 0 dcnl dcsp dcsp dcsp dists compute nearest surf rr r1s return dists true 1 dcnl dcsp dcsp dcsp close np logical and dists < limit 1000 0 np logical not outside dcnl dcsp dcsp dcsp omit np sum close dcnl dcsp dcsp dcsp outside np logical or outside close dcnl dcsp dcsp s inuse vertnooutside false dcnl dcsp dcsp s nuse omit + omit outside dcnl dcsp dcsp s vertno np where s inuse 0 dcnl dcsp dcsp if omit outside 0 dcnl dcsp dcsp dcsp extras omit outside dcnl dcsp dcsp dcsp extras + s they dcsp are if omit outside 1 else it dcsp is dcnl dcsp dcsp dcsp logger info d dcsp source dcsp space dcsp point s dcsp omitted dcsp because dcsp s dcsp outside dcsp the dcsp inner dcsp skull dcsp surface tuple extras dcnl dcsp dcsp if omit 0 dcnl dcsp dcsp dcsp extras omit dcnl dcsp dcsp dcsp extras + s if omit outside 1 else dcnl dcsp dcsp dcsp extras + limit dcnl dcsp dcsp dcsp logger info d dcsp source dcsp space dcsp point s dcsp omitted dcsp because dcsp of dcsp the dcsp 6 1fmm dcsp distance dcsp limit tuple extras dcnl dcsp dcsp if omit + omit outside 0 and s get patch inds is not none dcnl dcsp dcsp dcsp if s nearest is none dcnl dcsp dcsp dcsp dcsp raise runtimeerror cannot dcsp adjust dcsp patch dcsp information dcsp properly dcsp please dcsp contact dcsp the dcsp mnepython dcsp developers dcnl dcsp dcsp dcsp add patch info s dcnl dcsp logger info thank dcsp you dcsp for dcsp waiting
verbose dcnl def points outside surface rr surf n jobs 1 verbose none dcsp rr np atleast 2d rr dcnl dcsp assert rr shape1 3 dcnl dcsp assert n jobs 0 dcnl dcsp parallel p fun parallel func get solids n jobs dcnl dcsp tot angles parallel p fun surf rr tris rr for tris in np array split surf tris n jobs dcnl dcsp return np abs np sum tot angles axis 0 2 np pi 1 0 1e05
verbose dcnl def ensure src src kind none verbose none dcsp if isinstance src string types dcnl dcsp dcsp if not op isfile src dcnl dcsp dcsp dcsp raise ioerror source dcsp space dcsp file dcsp s dcsp not dcsp found src dcnl dcsp dcsp logger info reading dcsp s src dcnl dcsp dcsp src read source spaces src verbose false dcnl dcsp if not isinstance src sourcespaces dcnl dcsp dcsp raise valueerror src dcsp must dcsp be dcsp a dcsp string dcsp or dcsp instance dcsp of dcsp sourcespaces dcnl dcsp if kind is not none dcnl dcsp dcsp if kind surf dcnl dcsp dcsp dcsp surf s for s in src if s type surf dcnl dcsp dcsp dcsp if len surf 2 or len src 2 dcnl dcsp dcsp dcsp dcsp raise valueerror source dcsp space dcsp must dcsp contain dcsp exactly dcsp two dcsp surfaces dcnl dcsp dcsp dcsp src surf dcnl dcsp return src
verbose dcnl def add source space distances src dist limit np inf n jobs 1 verbose none dcsp n jobs check n jobs n jobs dcnl dcsp src ensure src src dcnl dcsp if not np isscalar dist limit dcnl dcsp dcsp raise valueerror limit dcsp must dcsp be dcsp a dcsp scalar dcsp got dcsp s repr dist limit dcnl dcsp if not check version scipy 0 11 dcnl dcsp dcsp raise runtimeerror scipy dcsp dcsp 0 11 dcsp must dcsp be dcsp installed dcsp or dcsp dcsp 0 13 dcsp if dcsp dist limit dcsp < dcsp np inf dcnl dcsp if not all s type surf for s in src dcnl dcsp dcsp raise runtimeerror currently dcsp all dcsp source dcsp spaces dcsp must dcsp be dcsp of dcsp surface dcsp type dcnl dcsp if dist limit < np inf dcnl dcsp dcsp try dcnl dcsp dcsp dcsp sparse csgraph dijkstra sparse csr matrix np zeros 2 2 limit 1 0 dcnl dcsp dcsp except typeerror dcnl dcsp dcsp dcsp raise runtimeerror cannot dcsp use dcsp limit dcsp < dcsp np inf dcsp unless dcsp scipy dcsp dcsp 0 13 dcsp is dcsp installed dcnl dcsp parallel p fun parallel func do src distances n jobs dcnl dcsp min dists list dcnl dcsp min idxs list dcnl dcsp logger info calculating dcsp source dcsp space dcsp distances dcsp limit s dcsp mm 1000 dist limit dcnl dcsp for s in src dcnl dcsp dcsp connectivity mesh dist s tris s rr dcnl dcsp dcsp d parallel p fun connectivity s vertno r dist limit for r in np array split np arange len s vertno n jobs dcnl dcsp dcsp min idx np array dd1 for dd in d dcnl dcsp dcsp min dist np array dd2 for dd in d dcnl dcsp dcsp midx np argmin min dist axis 0 dcnl dcsp dcsp range idx np arange len s rr dcnl dcsp dcsp min dist min dist midx range idx dcnl dcsp dcsp min idx min idx midx range idx dcnl dcsp dcsp min dists append min dist dcnl dcsp dcsp min idxs append min idx dcnl dcsp dcsp d np concatenate dd0 for dd in d ravel dcnl dcsp dcsp idx d 0 dcnl dcsp dcsp d didx dcnl dcsp dcsp i j np meshgrid s vertno s vertno dcnl dcsp dcsp i i ravel idx dcnl dcsp dcsp j j ravel idx dcnl dcsp dcsp d sparse csr matrix d i j shape s np s np dtype np float32 dcnl dcsp dcsp s dist d dcnl dcsp dcsp s dist limit np array dist limit np float32 dcnl dcsp if not any np any np isinf md for md in min dists dcnl dcsp dcsp for s min dist min idx in zip src min dists min idxs dcnl dcsp dcsp dcsp s nearest min idx dcnl dcsp dcsp dcsp s nearest dist min dist dcnl dcsp dcsp dcsp add patch info s dcnl dcsp else dcnl dcsp dcsp logger info not dcsp adding dcsp patch dcsp information dcsp dist limit dcsp too dcsp small dcnl dcsp return src
def do src distances con vertno run inds limit dcsp if limit < np inf dcnl dcsp dcsp func partial sparse csgraph dijkstra limit limit dcnl dcsp else dcnl dcsp dcsp func sparse csgraph dijkstra dcnl dcsp chunk size 20 dcnl dcsp lims np r np arange 0 len run inds chunk size len run inds dcnl dcsp n chunks len lims 1 dcnl dcsp d np empty len run inds len vertno np float32 dcnl dcsp min dist np empty n chunks con shape0 dcnl dcsp min idx np empty n chunks con shape0 np int32 dcnl dcsp range idx np arange con shape0 dcnl dcsp for li l1 l2 in enumerate zip lims 1 lims1 dcnl dcsp dcsp idx vertnorun indsl1 l2 dcnl dcsp dcsp out func con indices idx dcnl dcsp dcsp midx np argmin out axis 0 dcnl dcsp dcsp min idxli idxmidx dcnl dcsp dcsp min distli out midx range idx dcnl dcsp dcsp dl1 l2 out vertno dcnl dcsp midx np argmin min dist axis 0 dcnl dcsp min dist min dist midx range idx dcnl dcsp min idx min idx midx range idx dcnl dcsp d d np inf 0 dcnl dcsp return d min idx min dist
def get volume labels from aseg mgz fname return colors false dcsp import nibabel as nib dcnl dcsp mgz data nib load mgz fname get data dcnl dcsp lut get lut dcnl dcsp label names lut lut id ii name 0 decode utf8 for ii in np unique mgz data dcnl dcsp label colors lut lut id ii r 0 lut lut id ii g 0 lut lut id ii b 0 lut lut id ii a 0 for ii in np unique mgz data dcnl dcsp order np argsort label names dcnl dcsp label names label namesk for k in order dcnl dcsp label colors label colorsk for k in order dcnl dcsp if return colors dcnl dcsp dcsp return label names label colors dcnl dcsp else dcnl dcsp dcsp return label names
def get volume labels from src src subject subjects dir dcsp import os path as op dcnl dcsp import numpy as np dcnl dcsp from import label dcnl dcsp from import get volume labels from aseg dcnl dcsp aseg fname op join subjects dir subject mri aseg mgz dcnl dcsp if not op isfile aseg fname dcnl dcsp dcsp raise ioerror aseg dcsp file dcsp s dcsp not dcsp found aseg fname dcnl dcsp all labels aseg get volume labels from aseg aseg fname return colors true dcnl dcsp if len src < 2 dcnl dcsp dcsp raise valueerror no dcsp vol dcsp src dcsp space dcsp in dcsp src dcnl dcsp if any np any s type vol for s in src2 dcnl dcsp dcsp raise valueerror source dcsp spaces dcsp have dcsp to dcsp be dcsp of dcsp vol dcsp type dcnl dcsp labels aseg list dcnl dcsp for nr in range 2 len src dcnl dcsp dcsp vertices srcnr vertno dcnl dcsp dcsp pos srcnr rr srcnr vertno dcnl dcsp dcsp roi str srcnr seg name dcnl dcsp dcsp try dcnl dcsp dcsp dcsp ind all labels aseg0 index roi str dcnl dcsp dcsp dcsp color np array all labels aseg1ind 255 dcnl dcsp dcsp except valueerror dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp if left in roi str lower dcnl dcsp dcsp dcsp hemi lh dcnl dcsp dcsp dcsp roi str roi str replace left + lh dcnl dcsp dcsp elif right in roi str lower dcnl dcsp dcsp dcsp hemi rh dcnl dcsp dcsp dcsp roi str roi str replace right + rh dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemi both dcnl dcsp dcsp label label vertices vertices pos pos hemi hemi name roi str color color subject subject dcnl dcsp dcsp labels aseg append label dcnl dcsp return labels aseg
def get hemi s dcsp if s type surf dcnl dcsp dcsp raise runtimeerror only dcsp surface dcsp source dcsp spaces dcsp supported dcnl dcsp if s id fiff fiffv mne surf left hemi dcnl dcsp dcsp return lh 0 s id dcnl dcsp elif s id fiff fiffv mne surf right hemi dcnl dcsp dcsp return rh 1 s id dcnl dcsp else dcnl dcsp dcsp raise valueerror unknown dcsp surface dcsp id dcsp s s id
def get vertex map nn fro src subject from subject to hemi subjects dir to neighbor tri none dcsp logger info mapping dcsp s dcsp s dcsp dcsp s dcsp nearest dcsp neighbor hemi subject from subject to dcnl dcsp regs op join subjects dir s surf s sphere reg hemi for s in subject from subject to dcnl dcsp reg fro reg to read surface r return dict true 1 for r in regs dcnl dcsp if to neighbor tri is none dcnl dcsp dcsp to neighbor tri triangle neighbors reg to tris reg to np dcnl dcsp morph inuse np zeros len reg to rr bool dcnl dcsp best np zeros fro src np int dcnl dcsp ones compute nearest reg to rr reg fro rr fro src vertno dcnl dcsp for v one in zip fro src vertno ones dcnl dcsp dcsp if morph inuseone dcnl dcsp dcsp dcsp neigh get surf neighbors reg to one dcnl dcsp dcsp dcsp was one dcnl dcsp dcsp dcsp one neighnp where ~ morph inuseneigh 0 dcnl dcsp dcsp dcsp if len one 0 dcnl dcsp dcsp dcsp dcsp raise runtimeerror vertex dcsp d dcsp would dcsp be dcsp used dcsp multiple dcsp times one dcnl dcsp dcsp dcsp one one0 dcnl dcsp dcsp dcsp logger info source dcsp space dcsp vertex dcsp moved dcsp from dcsp d dcsp to dcsp d dcsp because dcsp of dcsp double dcsp occupation was one dcnl dcsp dcsp bestv one dcnl dcsp dcsp morph inuseone true dcnl dcsp return best
verbose dcnl def morph source spaces src from subject to surf white subject from none subjects dir none verbose none dcsp src from ensure src src from dcnl dcsp subject from ensure src subject src from subject from dcnl dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp src out list dcnl dcsp for fro in src from dcnl dcsp dcsp hemi idx id get hemi fro dcnl dcsp dcsp to op join subjects dir subject to surf s s hemi surf dcnl dcsp dcsp logger info reading dcsp destination dcsp surface dcsp s to dcnl dcsp dcsp to read surface to return dict true verbose false 1 dcnl dcsp dcsp complete surface info to copy false dcnl dcsp dcsp best get vertex map nn fro subject from subject to hemi subjects dir to neighbor tri dcnl dcsp dcsp for key in neighbor tri tri area tri cent tri nn use tris dcnl dcsp dcsp dcsp del tokey dcnl dcsp dcsp to vertno np sort bestfro vertno dcnl dcsp dcsp to inuse np zeros len to rr int dcnl dcsp dcsp to inuse to vertno true dcnl dcsp dcsp to use tris bestfro use tris dcnl dcsp dcsp to update nuse len to vertno nuse tri len to use tris nearest none nearest dist none patch inds none pinfo none dist none id id dist limit none type surf coord frame fiff fiffv coord mri subject his id subject to rr to rr 1000 0 dcnl dcsp dcsp src out append to dcnl dcsp dcsp logger info done n dcnl dcsp info dict working dir os getcwd command line get call line in verbose true dcnl dcsp return sourcespaces src out info info
verbose dcnl def get morph src reordering vertices src from subject from subject to subjects dir none verbose none dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp from vertices list dcnl dcsp data idxs list dcnl dcsp offset 0 dcnl dcsp for ii hemi in enumerate lh rh dcnl dcsp dcsp best get vertex map nn src fromii subject from subject to hemi subjects dir dcnl dcsp dcsp full mapping bestsrc fromii vertno dcnl dcsp dcsp used vertices np in1d full mapping verticesii dcnl dcsp dcsp from vertices append src fromii vertno used vertices dcnl dcsp dcsp remaining mapping full mappingused vertices dcnl dcsp dcsp if not np array equal np sort remaining mapping verticesii or not np in1d verticesii full mapping all dcnl dcsp dcsp dcsp raise runtimeerror could dcsp not dcsp map dcsp vertices dcsp perhaps dcsp the dcsp wrong dcsp subject dcsp s dcsp was dcsp provided subject from dcnl dcsp dcsp implicit mapping np argsort remaining mapping dcnl dcsp dcsp data idx np argsort implicit mapping dcnl dcsp dcsp data idx + offset dcnl dcsp dcsp data idxs append data idx dcnl dcsp dcsp offset + len implicit mapping dcnl dcsp data idx np concatenate data idxs dcnl dcsp assert np array equal np sort data idx np arange sum len v for v in vertices dcnl dcsp return data idx from vertices
def compare source spaces src0 src1 mode exact nearest true dist tol 0 0015 dcsp from nose tools import assert equal assert true dcnl dcsp from numpy testing import assert allclose assert array equal dcnl dcsp from scipy spatial distance import cdist dcnl dcsp if mode exact and approx not in mode dcnl dcsp dcsp raise runtimeerror unknown dcsp mode dcsp s mode dcnl dcsp for si s0 s1 in enumerate zip src0 src1 dcnl dcsp dcsp a b set s0 keys set s1 keys dcnl dcsp dcsp assert equal a b str a ^ b dcnl dcsp dcsp for name in nuse ntri np type id dcnl dcsp dcsp dcsp assert equal s0name s1name name dcnl dcsp dcsp for name in subject his id dcnl dcsp dcsp dcsp if name in s0 or name in s1 dcnl dcsp dcsp dcsp dcsp assert equal s0name s1name name dcnl dcsp dcsp for name in interpolator dcnl dcsp dcsp dcsp if name in s0 or name in s1 dcnl dcsp dcsp dcsp dcsp diffs s0 interpolator s1 interpolator data dcnl dcsp dcsp dcsp dcsp if len diffs 0 and nointerp not in mode dcnl dcsp dcsp dcsp dcsp dcsp assert true np sqrt np mean diffs 2 < 0 1 name dcnl dcsp dcsp for name in nn rr nuse tri coord frame tris dcnl dcsp dcsp dcsp if s0name is none dcnl dcsp dcsp dcsp dcsp assert true s1name is none name dcnl dcsp dcsp dcsp elif mode exact dcnl dcsp dcsp dcsp dcsp assert array equal s0name s1name name dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp atol 0 001 if name nn else 0 0001 dcnl dcsp dcsp dcsp dcsp assert allclose s0name s1name rtol 0 001 atol atol err msg name dcnl dcsp dcsp for name in seg name dcnl dcsp dcsp dcsp if name in s0 or name in s1 dcnl dcsp dcsp dcsp dcsp assert equal s0name s1name name dcnl dcsp dcsp if nearest dcnl dcsp dcsp dcsp for name in nearest nearest dist patch inds dcnl dcsp dcsp dcsp dcsp if s0name is none dcnl dcsp dcsp dcsp dcsp dcsp assert true s1name is none name dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp assert array equal s0name s1name dcnl dcsp dcsp dcsp for name in pinfo dcnl dcsp dcsp dcsp dcsp if s0name is none dcnl dcsp dcsp dcsp dcsp dcsp assert true s1name is none name dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp assert true len s0name len s1name name dcnl dcsp dcsp dcsp dcsp dcsp for p1 p2 in zip s0name s1name dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert true all p1 p2 name dcnl dcsp dcsp if mode exact dcnl dcsp dcsp dcsp for name in inuse vertno use tris dcnl dcsp dcsp dcsp dcsp assert array equal s0name s1name err msg name dcnl dcsp dcsp dcsp for name in dist limit dcnl dcsp dcsp dcsp dcsp assert true s0name s1name name dcnl dcsp dcsp dcsp for name in dist dcnl dcsp dcsp dcsp dcsp if s0name is not none dcnl dcsp dcsp dcsp dcsp dcsp assert equal s1name shape s0name shape dcnl dcsp dcsp dcsp dcsp dcsp assert true len s0 dist s1 dist data 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp for ii s in enumerate s0 s1 dcnl dcsp dcsp dcsp dcsp assert array equal s vertno np where s inuse 0 src s s vertno dcsp dcsp np where src s s inuse 0 ii si ii si dcnl dcsp dcsp dcsp assert equal len s0 vertno len s1 vertno dcnl dcsp dcsp dcsp agreement np mean s0 inuse s1 inuse dcnl dcsp dcsp dcsp assert true agreement 0 99 s dcsp < dcsp 0 99 agreement dcnl dcsp dcsp dcsp if agreement < 1 0 dcnl dcsp dcsp dcsp dcsp v0 np setdiff1d s0 vertno s1 vertno dcnl dcsp dcsp dcsp dcsp v1 np setdiff1d s1 vertno s0 vertno dcnl dcsp dcsp dcsp dcsp dists cdist s0 rr v0 s1 rr v1 dcnl dcsp dcsp dcsp dcsp assert allclose np min dists axis 1 np zeros len v0 atol dist tol err msg mismatched dcsp vertno dcnl dcsp dcsp dcsp if s0 use tris is not none dcnl dcsp dcsp dcsp dcsp assert array equal s0 use tris shape s1 use tris shape dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp assert true s1 use tris is none dcnl dcsp dcsp dcsp assert true np mean s0 use tris s1 use tris 0 99 dcnl dcsp for name in working dir command line dcnl dcsp dcsp if mode exact dcnl dcsp dcsp dcsp assert equal src0 infoname src1 infoname dcnl dcsp dcsp elif name in src0 info dcnl dcsp dcsp dcsp assert true name in src1 info s dcsp missing name dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert true name not in src1 info s dcsp should dcsp not dcsp exist name
def read proj fname dcsp check fname fname projection proj fif proj fif gz dcnl dcsp ff tree io fiff open fname dcnl dcsp with ff as fid dcnl dcsp dcsp projs io proj read proj fid tree dcnl dcsp return projs
def write proj fname projs dcsp check fname fname projection proj fif proj fif gz dcnl dcsp fid io write start file fname dcnl dcsp io proj write proj fid projs dcnl dcsp io write end file fid
verbose dcnl def compute proj epochs epochs n grad 2 n mag 2 n eeg 2 n jobs 1 desc prefix none verbose none dcsp data compute cov epochs epochs n jobs dcnl dcsp event id epochs event id dcnl dcsp if event id is none or len list event id keys 0 dcnl dcsp dcsp event id 0 dcnl dcsp elif len event id keys 1 dcnl dcsp dcsp event id str list event id values 0 dcnl dcsp else dcnl dcsp dcsp event id multipleevents dcnl dcsp if desc prefix is none dcnl dcsp dcsp desc prefix s 3f 3f event id epochs tmin epochs tmax dcnl dcsp return compute proj data epochs info n grad n mag n eeg desc prefix
def compute cov epochs epochs n jobs dcsp parallel p fun parallel func np dot n jobs dcnl dcsp data parallel p fun e e t for e in epochs dcnl dcsp n epochs len data dcnl dcsp if n epochs 0 dcnl dcsp dcsp raise runtimeerror no dcsp good dcsp epochs dcsp found dcnl dcsp n chan n samples epochs info nchan len epochs times dcnl dcsp check n samples n samples n epochs n chan dcnl dcsp data sum data dcnl dcsp return data
verbose dcnl def compute proj evoked evoked n grad 2 n mag 2 n eeg 2 verbose none dcsp data np dot evoked data evoked data t dcnl dcsp desc prefix 3f 3f evoked times0 evoked times 1 dcnl dcsp return compute proj data evoked info n grad n mag n eeg desc prefix
verbose dcnl def compute proj raw raw start 0 stop none duration 1 n grad 2 n mag 2 n eeg 0 reject none flat none n jobs 1 verbose none dcsp if duration is not none dcnl dcsp dcsp events make fixed length events raw 999 start stop duration dcnl dcsp dcsp picks pick types raw info meg true eeg true eog true ecg true emg true exclude bads dcnl dcsp dcsp epochs epochs raw events none tmin 0 0 tmax duration picks picks reject reject flat flat dcnl dcsp dcsp data compute cov epochs epochs n jobs dcnl dcsp dcsp info epochs info dcnl dcsp dcsp if not stop dcnl dcsp dcsp dcsp stop raw n times raw info sfreq dcnl dcsp else dcnl dcsp dcsp start max raw time as index start 0 0 dcnl dcsp dcsp stop raw time as index stop 0 if stop else raw n times dcnl dcsp dcsp stop min stop raw n times dcnl dcsp dcsp data times raw start stop dcnl dcsp dcsp check n samples stop start data shape0 dcnl dcsp dcsp data np dot data data t dcnl dcsp dcsp info raw info dcnl dcsp dcsp start start raw info sfreq dcnl dcsp dcsp stop stop raw info sfreq dcnl dcsp desc prefix raw 3f 3f start stop dcnl dcsp projs compute proj data info n grad n mag n eeg desc prefix dcnl dcsp return projs
def sensitivity map fwd projs none ch type grad mode fixed exclude verbose none dcsp if ch type not in eeg grad mag dcnl dcsp dcsp raise valueerror ch type dcsp should dcsp be dcsp eeg dcsp mag dcsp or dcsp grad dcsp got dcsp s ch type dcnl dcsp if mode not in free fixed ratio radiality angle remaining dampening dcnl dcsp dcsp raise valueerror unknown dcsp mode dcsp type dcsp got dcsp s mode dcnl dcsp if is fixed orient fwd orig true dcnl dcsp dcsp raise valueerror fwd dcsp should dcsp must dcsp be dcsp computed dcsp with dcsp free dcsp orientation dcnl dcsp if ch type eeg dcnl dcsp dcsp fwd pick types forward fwd meg false eeg true exclude exclude dcnl dcsp else dcnl dcsp dcsp fwd pick types forward fwd meg ch type eeg false exclude exclude dcnl dcsp convert forward solution fwd surf ori true force fixed false copy false verbose false dcnl dcsp if not fwd surf ori or is fixed orient fwd dcnl dcsp dcsp raise runtimeerror error dcsp converting dcsp solution dcsp please dcsp notify dcsp mnepython dcsp developers dcnl dcsp gain fwd sol data dcnl dcsp if ch type eeg dcnl dcsp dcsp if projs is none or not has eeg average ref proj projs dcnl dcsp dcsp dcsp eeg ave make eeg average ref proj fwd info dcnl dcsp dcsp else dcnl dcsp dcsp dcsp eeg ave dcnl dcsp dcsp projs eeg ave if projs is none else projs + eeg ave dcnl dcsp residual types angle remaining dampening dcnl dcsp if projs is not none dcnl dcsp dcsp proj ncomp u make projector projs fwd sol row names include active true dcnl dcsp dcsp if mode not in residual types dcnl dcsp dcsp dcsp gain np dot proj gain dcnl dcsp dcsp elif ncomp 0 dcnl dcsp dcsp dcsp raise runtimeerror no dcsp valid dcsp projectors dcsp found dcsp for dcsp channel dcsp type dcsp s dcsp cannot dcsp compute dcsp s ch type mode dcnl dcsp elif mode in residual types dcnl dcsp dcsp raise valueerror no dcsp projectors dcsp used dcsp cannot dcsp compute dcsp s mode dcnl dcsp n sensors n dipoles gain shape dcnl dcsp n locations n dipoles 3 dcnl dcsp sensitivity map np empty n locations dcnl dcsp for k in range n locations dcnl dcsp dcsp gg gain 3 k 3 k + 1 dcnl dcsp dcsp if mode fixed dcnl dcsp dcsp dcsp s linalg svd gg full matrices false compute uv false dcnl dcsp dcsp if mode free dcnl dcsp dcsp dcsp sensitivity mapk s0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp gz linalg norm gg 2 dcnl dcsp dcsp dcsp if mode fixed dcnl dcsp dcsp dcsp dcsp sensitivity mapk gz dcnl dcsp dcsp dcsp elif mode ratio dcnl dcsp dcsp dcsp dcsp sensitivity mapk gz s0 dcnl dcsp dcsp dcsp elif mode radiality dcnl dcsp dcsp dcsp dcsp sensitivity mapk 1 0 gz s0 dcnl dcsp dcsp dcsp elif mode angle dcnl dcsp dcsp dcsp dcsp co linalg norm np dot gg 2 u dcnl dcsp dcsp dcsp dcsp sensitivity mapk co gz dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp p linalg norm np dot proj gg 2 dcnl dcsp dcsp dcsp dcsp if mode remaining dcnl dcsp dcsp dcsp dcsp dcsp sensitivity mapk p gz dcnl dcsp dcsp dcsp dcsp elif mode dampening dcnl dcsp dcsp dcsp dcsp dcsp sensitivity mapk 1 0 p gz dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror unknown dcsp mode dcsp type dcsp got dcsp s mode dcnl dcsp if mode in fixed free dcnl dcsp dcsp sensitivity map np max sensitivity map dcnl dcsp subject subject from forward fwd dcnl dcsp if fwd src 0 type vol dcnl dcsp dcsp vertices fwd src 0 vertno dcnl dcsp dcsp seclass volsourceestimate dcnl dcsp else dcnl dcsp dcsp vertices fwd src 0 vertno fwd src 1 vertno dcnl dcsp dcsp seclass sourceestimate dcnl dcsp stc seclass sensitivity map np newaxis vertices vertices tmin 0 tstep 1 subject subject dcnl dcsp return stc
def save split epochs fname part idx n parts dcsp path base op split fname dcnl dcsp idx base find dcnl dcsp if part idx 0 dcnl dcsp dcsp fname op join path s d s base idx part idx base idx + 1 dcnl dcsp next fname none dcnl dcsp if part idx < n parts 1 dcnl dcsp dcsp next fname op join path s d s base idx part idx + 1 base idx + 1 dcnl dcsp dcsp next idx part idx + 1 dcnl dcsp fid start file fname dcnl dcsp info epochs info dcnl dcsp meas id info meas id dcnl dcsp start block fid fiff fiffb meas dcnl dcsp write id fid fiff fiff block id dcnl dcsp if info meas id is not none dcnl dcsp dcsp write id fid fiff fiff parent block id info meas id dcnl dcsp write meas info fid info dcnl dcsp start block fid fiff fiffb processed data dcnl dcsp start block fid fiff fiffb mne epochs dcnl dcsp data epochs get data dcnl dcsp assert data dtype float64 dcnl dcsp start block fid fiff fiffb mne events dcnl dcsp write int fid fiff fiff mne event list epochs events t dcnl dcsp mapping join k + + str v for k v in epochs event id items dcnl dcsp write string fid fiff fiff description mapping dcnl dcsp end block fid fiff fiffb mne events dcnl dcsp first int round epochs tmin info sfreq dcnl dcsp last first + len epochs times 1 dcnl dcsp write int fid fiff fiff first sample first dcnl dcsp write int fid fiff fiff last sample last dcnl dcsp if epochs baseline is not none dcnl dcsp dcsp bmin bmax epochs baseline dcnl dcsp dcsp bmin epochs times0 if bmin is none else bmin dcnl dcsp dcsp bmax epochs times 1 if bmax is none else bmax dcnl dcsp dcsp write float fid fiff fiff mne baseline min bmin dcnl dcsp dcsp write float fid fiff fiff mne baseline max bmax dcnl dcsp decal np empty info nchan dcnl dcsp for k in range info nchan dcnl dcsp dcsp decalk 1 0 info chs k cal info chs k get scale 1 0 dcnl dcsp data decalnp newaxis np newaxis dcnl dcsp write float matrix fid fiff fiff epoch data dcnl dcsp data decalnp newaxis np newaxis dcnl dcsp write string fid fiff fiffb mne epochs drop log json dumps epochs drop log dcnl dcsp write int fid fiff fiffb mne epochs selection epochs selection dcnl dcsp if next fname is not none and n parts 1 dcnl dcsp dcsp start block fid fiff fiffb ref dcnl dcsp dcsp write int fid fiff fiff ref role fiff fiffv role next file dcnl dcsp dcsp write string fid fiff fiff ref file name op basename next fname dcnl dcsp dcsp if meas id is not none dcnl dcsp dcsp dcsp write id fid fiff fiff ref file id meas id dcnl dcsp dcsp write int fid fiff fiff ref file num next idx dcnl dcsp dcsp end block fid fiff fiffb ref dcnl dcsp end block fid fiff fiffb mne epochs dcnl dcsp end block fid fiff fiffb processed data dcnl dcsp end block fid fiff fiffb meas dcnl dcsp end file fid
def hid match event id keys dcsp keys keys if not isinstance keys list tuple else keys dcnl dcsp use keys dcnl dcsp for key in keys dcnl dcsp dcsp if not isinstance key string types dcnl dcsp dcsp dcsp raise keyerror keys dcsp must dcsp be dcsp strings dcsp got dcsp s dcsp s type key key dcnl dcsp dcsp use keys extend k for k in event id keys if set key split issubset k split dcnl dcsp if len use keys 0 dcnl dcsp dcsp raise keyerror event dcsp s dcsp is dcsp not dcsp in dcsp epochs key dcnl dcsp use keys list set use keys dcnl dcsp return use keys
def check baseline baseline tmin tmax sfreq dcsp if baseline is not none dcnl dcsp dcsp if not isinstance baseline tuple or len baseline 2 dcnl dcsp dcsp dcsp raise valueerror baseline s dcsp is dcsp an dcsp invalid dcsp argument str baseline dcnl dcsp dcsp baseline tmin baseline tmax baseline dcnl dcsp dcsp tstep 1 0 float sfreq dcnl dcsp dcsp if baseline tmin is none dcnl dcsp dcsp dcsp baseline tmin tmin dcnl dcsp dcsp baseline tmin float baseline tmin dcnl dcsp dcsp if baseline tmax is none dcnl dcsp dcsp dcsp baseline tmax tmax dcnl dcsp dcsp baseline tmax float baseline tmax dcnl dcsp dcsp if baseline tmin < tmin tstep dcnl dcsp dcsp dcsp raise valueerror baseline dcsp interval dcsp tmin dcsp dcsp s dcsp is dcsp outside dcsp of dcsp epoch dcsp data dcsp tmin dcsp dcsp s baseline tmin tmin dcnl dcsp dcsp if baseline tmax tmax + tstep dcnl dcsp dcsp dcsp raise valueerror baseline dcsp interval dcsp tmax dcsp dcsp s dcsp is dcsp outside dcsp of dcsp epoch dcsp data dcsp tmax dcsp dcsp s baseline tmax tmax dcnl dcsp dcsp if baseline tmin baseline tmax dcnl dcsp dcsp dcsp raise valueerror baseline dcsp min dcsp s dcsp must dcsp be dcsp less dcsp than dcsp baseline dcsp max dcsp s baseline tmin baseline tmax dcnl dcsp dcsp del baseline tmin baseline tmax
def drop log stats drop log ignore ignored dcsp if not isinstance drop log list or not isinstance drop log0 list dcnl dcsp dcsp raise valueerror drop log dcsp must dcsp be dcsp a dcsp list dcsp of dcsp lists dcnl dcsp perc 100 np mean len d 0 for d in drop log if not any r in ignore for r in d dcnl dcsp return perc
def combine event ids epochs old event ids new event id copy true dcsp epochs epochs copy if copy else epochs dcnl dcsp old event ids np asanyarray old event ids dcnl dcsp if isinstance new event id int dcnl dcsp dcsp new event id str new event id new event id dcnl dcsp else dcnl dcsp dcsp if not isinstance new event id dict dcnl dcsp dcsp dcsp raise valueerror new event id dcsp must dcsp be dcsp a dcsp dict dcsp or dcsp int dcnl dcsp dcsp if not len list new event id keys 1 dcnl dcsp dcsp dcsp raise valueerror new event id dcsp dict dcsp must dcsp have dcsp one dcsp entry dcnl dcsp new event num list new event id values 0 dcnl dcsp if not isinstance new event num int dcnl dcsp dcsp raise valueerror new event id dcsp value dcsp must dcsp be dcsp an dcsp integer dcnl dcsp if new event num in epochs event id values dcnl dcsp dcsp raise valueerror new event id dcsp value dcsp must dcsp not dcsp already dcsp exist dcnl dcsp old event nums np array epochs event idkey for key in old event ids dcnl dcsp inds np any epochs events 2 np newaxis old event numsnp newaxis axis 1 dcnl dcsp epochs events inds 2 new event num dcnl dcsp for key in old event ids dcnl dcsp dcsp epochs event id pop key dcnl dcsp epochs event id update new event id dcnl dcsp return epochs
def equalize epoch counts epochs list method mintime dcsp if not all isinstance e baseepochs for e in epochs list dcnl dcsp dcsp raise valueerror all dcsp inputs dcsp must dcsp be dcsp epochs dcsp instances dcnl dcsp for e in epochs list dcnl dcsp dcsp if not e bad dropped dcnl dcsp dcsp dcsp e drop bad dcnl dcsp event times e events 0 for e in epochs list dcnl dcsp indices get drop indices event times method dcnl dcsp for e inds in zip epochs list indices dcnl dcsp dcsp e drop inds reason equalized count
def get drop indices event times method dcsp small idx np argmin e shape0 for e in event times dcnl dcsp small e times event timessmall idx dcnl dcsp if method not in mintime truncate dcnl dcsp dcsp raise valueerror method dcsp must dcsp be dcsp either dcsp mintime dcsp or dcsp truncate dcsp not dcsp s method dcnl dcsp indices list dcnl dcsp for e in event times dcnl dcsp dcsp if method mintime dcnl dcsp dcsp dcsp mask minimize time diff small e times e dcnl dcsp dcsp else dcnl dcsp dcsp dcsp mask np ones e shape0 dtype bool dcnl dcsp dcsp dcsp masksmall e times shape0 false dcnl dcsp dcsp indices append np where np logical not mask 0 dcnl dcsp return indices
def fix fill fill dcsp if looseversion scipy version < looseversion 0 12 dcnl dcsp dcsp fill fill np newaxis dcnl dcsp return fill
def minimize time diff t shorter t longer dcsp from scipy interpolate import interp1d dcnl dcsp keep np ones len t longer dtype bool dcnl dcsp if len t shorter 0 dcnl dcsp dcsp keep fill false dcnl dcsp dcsp return keep dcnl dcsp scores np ones len t longer dcnl dcsp x1 np arange len t shorter dcnl dcsp kwargs dict copy false bounds error false dcnl dcsp if assume sorted in get args interp1d init dcnl dcsp dcsp kwargs assume sorted true dcnl dcsp shorter interp interp1d x1 t shorter fill value t shorter 1 kwargs dcnl dcsp for ii in range len t longer len t shorter dcnl dcsp dcsp scores fill np inf dcnl dcsp dcsp keep mask ~ np eye len t longer dtype bool keep dcnl dcsp dcsp keep mask ~ keep false dcnl dcsp dcsp x2 np arange len t longer ii 1 dcnl dcsp dcsp t keeps np array t longerkm for km in keep mask dcnl dcsp dcsp longer interp interp1d x2 t keeps axis 1 fill value fix fill t keeps 1 kwargs dcnl dcsp dcsp d1 longer interp x1 t shorter dcnl dcsp dcsp d2 shorter interp x2 t keeps dcnl dcsp dcsp scoreskeep np abs d1 d1 sum axis 1 + np abs d2 d2 sum axis 1 dcnl dcsp dcsp keepnp argmin scores false dcnl dcsp return keep
verbose dcnl def is good e ch names channel type idx reject flat full report false ignore chs verbose none dcsp bad list list dcnl dcsp has printed false dcnl dcsp checkable np ones len ch names dtype bool dcnl dcsp checkablenp array c in ignore chs for c in ch names dtype bool false dcnl dcsp for refl f t in zip reject flat np greater np less flat dcnl dcsp dcsp if refl is not none dcnl dcsp dcsp dcsp for key thresh in iteritems refl dcnl dcsp dcsp dcsp dcsp idx channel type idxkey dcnl dcsp dcsp dcsp dcsp name key upper dcnl dcsp dcsp dcsp dcsp if len idx 0 dcnl dcsp dcsp dcsp dcsp dcsp e idx eidx dcnl dcsp dcsp dcsp dcsp dcsp deltas np max e idx axis 1 np min e idx axis 1 dcnl dcsp dcsp dcsp dcsp dcsp checkable idx checkableidx dcnl dcsp dcsp dcsp dcsp dcsp idx deltas np where np logical and f deltas thresh checkable idx 0 dcnl dcsp dcsp dcsp dcsp dcsp if len idx deltas 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp ch name ch namesidxi for i in idx deltas dcnl dcsp dcsp dcsp dcsp dcsp dcsp if not has printed dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp rejecting dcsp s dcsp epoch dcsp based dcsp on dcsp s dcsp dcsp s t name ch name dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp has printed true dcnl dcsp dcsp dcsp dcsp dcsp dcsp if not full report dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp return false dcnl dcsp dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp bad list extend ch name dcnl dcsp if not full report dcnl dcsp dcsp return true dcnl dcsp elif bad list dcnl dcsp dcsp return true none dcnl dcsp else dcnl dcsp dcsp return false bad list
def read one epoch file f tree preload dcsp with f as fid dcnl dcsp dcsp info meas read meas info fid tree clean bads true dcnl dcsp dcsp events mappings read events fif fid tree dcnl dcsp dcsp processed dir tree find meas fiff fiffb processed data dcnl dcsp dcsp if len processed 0 dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp processed dcsp data dcnl dcsp dcsp epochs node dir tree find tree fiff fiffb mne epochs dcnl dcsp dcsp if len epochs node 0 dcnl dcsp dcsp dcsp epochs node dir tree find tree fiff fiffb mne epochs dcnl dcsp dcsp dcsp if len epochs node 0 dcnl dcsp dcsp dcsp dcsp epochs node dir tree find tree 122 dcnl dcsp dcsp dcsp dcsp if len epochs node 0 dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp epochs dcsp data dcnl dcsp dcsp my epochs epochs node0 dcnl dcsp dcsp data none dcnl dcsp dcsp data tag none dcnl dcsp dcsp bmin bmax none none dcnl dcsp dcsp baseline none dcnl dcsp dcsp selection none dcnl dcsp dcsp drop log none dcnl dcsp dcsp for k in range my epochs nent dcnl dcsp dcsp dcsp kind my epochs directory k kind dcnl dcsp dcsp dcsp pos my epochs directory k pos dcnl dcsp dcsp dcsp if kind fiff fiff first sample dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp first int tag data dcnl dcsp dcsp dcsp elif kind fiff fiff last sample dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp last int tag data dcnl dcsp dcsp dcsp elif kind fiff fiff epoch dcnl dcsp dcsp dcsp dcsp fid seek pos 0 dcnl dcsp dcsp dcsp dcsp data tag read tag info fid dcnl dcsp dcsp dcsp dcsp data tag pos pos dcnl dcsp dcsp dcsp elif kind in fiff fiff mne baseline min 304 dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp bmin float tag data dcnl dcsp dcsp dcsp elif kind in fiff fiff mne baseline max 305 dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp bmax float tag data dcnl dcsp dcsp dcsp elif kind fiff fiffb mne epochs selection dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp selection np array tag data dcnl dcsp dcsp dcsp elif kind fiff fiffb mne epochs drop log dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp drop log json loads tag data dcnl dcsp dcsp if bmin is not none or bmax is not none dcnl dcsp dcsp dcsp baseline bmin bmax dcnl dcsp dcsp n samp last first + 1 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp found dcsp the dcsp data dcsp of dcsp interest dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp t dcsp dcsp 10 2f dcsp dcsp 10 2f dcsp ms 1000 first info sfreq 1000 last info sfreq dcnl dcsp dcsp if info comps is not none dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp d dcsp ctf dcsp compensation dcsp matrices dcsp available len info comps dcnl dcsp dcsp if data tag is none dcnl dcsp dcsp dcsp raise valueerror epochs dcsp data dcsp not dcsp found dcnl dcsp dcsp epoch shape len info ch names n samp dcnl dcsp dcsp expected len events np prod epoch shape dcnl dcsp dcsp if data tag size 4 4 expected dcnl dcsp dcsp dcsp raise valueerror incorrect dcsp number dcsp of dcsp samples dcsp d dcsp instead dcsp of dcsp d data tag size 4 expected dcnl dcsp dcsp cals np array info chs k cal info chs k get scale 1 0 for k in range info nchan np float64 dcnl dcsp dcsp if preload dcnl dcsp dcsp dcsp data read tag fid data tag pos data astype np float64 dcnl dcsp dcsp dcsp data calsnp newaxis dcnl dcsp dcsp tmin first info sfreq dcnl dcsp dcsp tmax last info sfreq dcnl dcsp dcsp event id dict str e e for e in np unique events 2 if mappings is none else mappings dcnl dcsp dcsp if selection is none dcnl dcsp dcsp dcsp selection np arange len events dcnl dcsp dcsp if drop log is none dcnl dcsp dcsp dcsp drop log for in range len events dcnl dcsp return info data data tag events event id tmin tmax baseline selection drop log epoch shape cals
verbose dcnl def read epochs fname proj true preload true verbose none dcsp return epochsfif fname proj preload verbose
def bootstrap epochs random state none dcsp if not epochs preload dcnl dcsp dcsp raise runtimeerror modifying dcsp data dcsp of dcsp epochs dcsp is dcsp only dcsp supported dcsp when dcsp preloading dcsp is dcsp used dcsp use dcsp preload true dcsp in dcsp the dcsp constructor dcnl dcsp rng check random state random state dcnl dcsp epochs bootstrap epochs copy dcnl dcsp n events len epochs bootstrap events dcnl dcsp idx rng randint 0 n events n events dcnl dcsp epochs bootstrap epochs bootstrapidx dcnl dcsp return epochs bootstrap
def check merge epochs epochs list dcsp if len set tuple epochs event id items for epochs in epochs list 1 dcnl dcsp dcsp raise notimplementederror epochs dcsp with dcsp unequal dcsp values dcsp for dcsp event id dcnl dcsp if len set epochs tmin for epochs in epochs list 1 dcnl dcsp dcsp raise notimplementederror epochs dcsp with dcsp unequal dcsp values dcsp for dcsp tmin dcnl dcsp if len set epochs tmax for epochs in epochs list 1 dcnl dcsp dcsp raise notimplementederror epochs dcsp with dcsp unequal dcsp values dcsp for dcsp tmax dcnl dcsp if len set epochs baseline for epochs in epochs list 1 dcnl dcsp dcsp raise notimplementederror epochs dcsp with dcsp unequal dcsp values dcsp for dcsp baseline
verbose dcnl def add channels epochs epochs list verbose none dcsp if not all e preload for e in epochs list dcnl dcsp dcsp raise valueerror all dcsp epochs dcsp must dcsp be dcsp preloaded dcnl dcsp info merge info epochs info for epochs in epochs list dcnl dcsp data epochs get data for epochs in epochs list dcnl dcsp check merge epochs epochs list dcnl dcsp for d in data dcnl dcsp dcsp if len d len data0 dcnl dcsp dcsp dcsp raise valueerror all dcsp epochs dcsp must dcsp be dcsp of dcsp the dcsp same dcsp length dcnl dcsp data np concatenate data axis 1 dcnl dcsp if len info chs data shape1 dcnl dcsp dcsp err data dcsp shape dcsp does dcsp not dcsp match dcsp channel dcsp number dcsp in dcsp measurement dcsp info dcnl dcsp dcsp raise runtimeerror err dcnl dcsp events epochs list0 events copy dcnl dcsp all same all np array equal events epochs events for epochs in epochs list1 dcnl dcsp if not all same dcnl dcsp dcsp raise valueerror events dcsp must dcsp be dcsp the dcsp same dcnl dcsp proj any e proj for e in epochs list dcnl dcsp if verbose is none dcnl dcsp dcsp verbose any e verbose for e in epochs list dcnl dcsp epochs epochs list0 copy dcnl dcsp epochs info info dcnl dcsp epochs picks none dcnl dcsp epochs verbose verbose dcnl dcsp epochs events events dcnl dcsp epochs preload true dcnl dcsp epochs bad dropped true dcnl dcsp epochs data data dcnl dcsp epochs projector epochs info setup proj epochs info false activate proj dcnl dcsp return epochs
def compare epochs infos info1 info2 ind dcsp info1 check consistency dcnl dcsp info2 check consistency dcnl dcsp if info1 nchan info2 nchan dcnl dcsp dcsp raise valueerror epochs d info nchan dcsp must dcsp match ind dcnl dcsp if info1 bads info2 bads dcnl dcsp dcsp raise valueerror epochs d info bads dcsp must dcsp match ind dcnl dcsp if info1 sfreq info2 sfreq dcnl dcsp dcsp raise valueerror epochs d info sfreq dcsp must dcsp match ind dcnl dcsp if set info1 ch names set info2 ch names dcnl dcsp dcsp raise valueerror epochs d info ch names dcsp must dcsp match ind dcnl dcsp if len info2 projs len info1 projs dcnl dcsp dcsp raise valueerror ssp dcsp projectors dcsp in dcsp epochs dcsp files dcsp must dcsp be dcsp the dcsp same dcnl dcsp if any not proj equal p1 p2 for p1 p2 in zip info2 projs info1 projs dcnl dcsp dcsp raise valueerror ssp dcsp projectors dcsp in dcsp epochs dcsp files dcsp must dcsp be dcsp the dcsp same dcnl dcsp if info1 dev head t is none info2 dev head t is none or info1 dev head t is not none and not np allclose info1 dev head t trans info2 dev head t trans rtol 1e06 dcnl dcsp dcsp raise valueerror epochs d info dev head t dcsp must dcsp match dcsp the dcsp epochs dcsp probably dcsp come dcsp from dcsp different dcsp runs dcsp and dcsp are dcsp therefore dcsp associated dcsp with dcsp different dcsp head dcsp positions dcsp manually dcsp change dcsp info dev head t dcsp to dcsp avoid dcsp this dcsp message dcsp but dcsp beware dcsp that dcsp this dcsp means dcsp the dcsp meg dcsp sensors dcsp will dcsp not dcsp be dcsp properly dcsp spatially dcsp aligned dcsp see dcsp mne preprocessing maxwell filter dcsp to dcsp realign dcsp the dcsp runs dcsp to dcsp a dcsp common dcsp head dcsp position ind
def concatenate epochs epochs list with data true dcsp if not isinstance epochs list list tuple dcnl dcsp dcsp raise typeerror epochs list dcsp must dcsp be dcsp a dcsp list dcsp or dcsp tuple dcsp got dcsp s type epochs list dcnl dcsp for ei epochs in enumerate epochs list dcnl dcsp dcsp if not isinstance epochs baseepochs dcnl dcsp dcsp dcsp raise typeerror epochs list d dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp epochs dcsp got dcsp s ei type epochs dcnl dcsp out epochs list0 dcnl dcsp data out get data if with data else none dcnl dcsp events out events dcnl dcsp baseline tmin tmax out baseline out tmin out tmax dcnl dcsp info deepcopy out info dcnl dcsp verbose out verbose dcnl dcsp drop log deepcopy out drop log dcnl dcsp event id deepcopy out event id dcnl dcsp selection out selection dcnl dcsp events offset np max out events 0 + int 10 + tmax epochs info sfreq dcnl dcsp for ii epochs in enumerate epochs list1 dcnl dcsp dcsp compare epochs infos epochs info info ii dcnl dcsp dcsp if not np allclose epochs times epochs list0 times dcnl dcsp dcsp dcsp raise valueerror epochs dcsp must dcsp have dcsp same dcsp times dcnl dcsp dcsp if epochs baseline baseline dcnl dcsp dcsp dcsp raise valueerror baseline dcsp must dcsp be dcsp same dcsp for dcsp all dcsp epochs dcnl dcsp dcsp common keys list set event id intersection set epochs event id dcnl dcsp dcsp for key in common keys dcnl dcsp dcsp dcsp if not event idkey epochs event idkey dcnl dcsp dcsp dcsp dcsp msg event id dcsp values dcsp must dcsp be dcsp the dcsp same dcsp for dcsp identical dcsp keys dcsp for dcsp all dcsp concatenated dcsp epochs dcsp key dcsp dcsp maps dcsp to dcsp dcsp in dcsp some dcsp epochs dcsp and dcsp to dcsp dcsp in dcsp others dcnl dcsp dcsp dcsp dcsp raise valueerror msg format key event idkey epochs event idkey dcnl dcsp dcsp if with data dcnl dcsp dcsp dcsp data append epochs get data dcnl dcsp dcsp evs epochs events copy dcnl dcsp dcsp evs 0 + events offset dcnl dcsp dcsp events offset + np max evs 0 + int 10 + tmax epochs info sfreq dcnl dcsp dcsp events append evs dcnl dcsp dcsp selection np concatenate selection epochs selection dcnl dcsp dcsp drop log extend epochs drop log dcnl dcsp dcsp event id update epochs event id dcnl dcsp events np concatenate events axis 0 dcnl dcsp if with data dcnl dcsp dcsp data np concatenate data axis 0 dcnl dcsp return info data events event id tmin tmax baseline selection drop log verbose
def finish concat info data events event id tmin tmax baseline selection drop log verbose dcsp selection np where len d 0 for d in drop log 0 dcnl dcsp out baseepochs info data events event id tmin tmax baseline baseline selection selection drop log drop log proj false on missing ignore verbose verbose dcnl dcsp out drop bad dcnl dcsp return out
def concatenate epochs epochs list dcsp return finish concat concatenate epochs epochs list
def check indices indices dcsp if not isinstance indices tuple or len indices 2 dcnl dcsp dcsp raise valueerror indices dcsp must dcsp be dcsp a dcsp tuple dcsp of dcsp length dcsp 2 dcnl dcsp if len indices0 len indices1 dcnl dcsp dcsp raise valueerror index dcsp arrays dcsp indices0 dcsp and dcsp indices1 dcsp must dcsp have dcsp the dcsp same dcsp length dcnl dcsp return indices
def seed target indices seeds targets dcsp seeds np asarray seeds ravel dcnl dcsp targets np asarray targets ravel dcnl dcsp n seeds len seeds dcnl dcsp n targets len targets dcnl dcsp indices np concatenate np tile i n targets for i in seeds np tile targets n seeds dcnl dcsp return indices
def stc gen data sfreq tmin combo false dcsp vertices np arange data shape1 np empty 0 dcnl dcsp for d in data dcnl dcsp dcsp if not combo dcnl dcsp dcsp dcsp stc sourceestimate data d vertices vertices tmin tmin tstep 1 float sfreq dcnl dcsp dcsp dcsp yield stc dcnl dcsp dcsp else dcnl dcsp dcsp dcsp arr d0 dcnl dcsp dcsp dcsp stc sourceestimate data d1 vertices vertices tmin tmin tstep 1 float sfreq dcnl dcsp dcsp dcsp yield arr stc
slow test dcnl def test spectral connectivity dcsp rng np random randomstate 0 dcnl dcsp trans bandwidth 2 0 dcnl dcsp sfreq 50 0 dcnl dcsp n signals 3 dcnl dcsp n epochs 8 dcnl dcsp n times 256 dcnl dcsp tmin 0 0 dcnl dcsp tmax n times 1 sfreq dcnl dcsp data rng randn n signals n epochs n times dcnl dcsp times data np linspace tmin tmax n times dcnl dcsp fstart fend 5 0 15 0 dcnl dcsp data1 filter data data0 sfreq fstart fend filter length auto fir design firwin2 l trans bandwidth trans bandwidth h trans bandwidth trans bandwidth dcnl dcsp data1 + 0 01 rng randn n times n epochs dcnl dcsp data data reshape n signals n epochs n times dcnl dcsp data np transpose data 1 0 2 dcnl dcsp assert raises valueerror spectral connectivity data method notamethod dcnl dcsp assert raises valueerror spectral connectivity data mode notamode dcnl dcsp assert raises valueerror spectral connectivity data fmin 10 fmax 10 + 0 5 sfreq float n times dcnl dcsp assert raises valueerror spectral connectivity data fmin 10 fmax 5 dcnl dcsp assert raises valueerror spectral connectivity data fmin 0 11 fmax 5 10 dcnl dcsp assert raises valueerror spectral connectivity data fmin 11 fmax 12 15 dcnl dcsp methods coh cohy imcoh plv ppc pli pli2 unbiased wpli wpli2 debiased coh dcnl dcsp modes multitaper fourier cwt morlet dcnl dcsp cwt frequencies np arange 3 24 5 1 dcnl dcsp for mode in modes dcnl dcsp dcsp for method in methods dcnl dcsp dcsp dcsp if method coh and mode multitaper dcnl dcsp dcsp dcsp dcsp check adaptive false true dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp check adaptive false dcnl dcsp dcsp dcsp if method coh and mode cwt morlet dcnl dcsp dcsp dcsp dcsp cwt n cycles 7 0 np ones len cwt frequencies dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp cwt n cycles 7 0 dcnl dcsp dcsp dcsp for adaptive in check adaptive dcnl dcsp dcsp dcsp dcsp if adaptive dcnl dcsp dcsp dcsp dcsp dcsp mt bandwidth 1 0 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp mt bandwidth none dcnl dcsp dcsp dcsp dcsp con freqs times n spectral connectivity data method method mode mode indices none sfreq sfreq mt adaptive adaptive mt low bias true mt bandwidth mt bandwidth cwt frequencies cwt frequencies cwt n cycles cwt n cycles dcnl dcsp dcsp dcsp dcsp assert true n n epochs dcnl dcsp dcsp dcsp dcsp assert array almost equal times data times dcnl dcsp dcsp dcsp dcsp if mode multitaper dcnl dcsp dcsp dcsp dcsp dcsp upper t 0 95 dcnl dcsp dcsp dcsp dcsp dcsp lower t 0 5 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp upper t 0 8 dcnl dcsp dcsp dcsp dcsp dcsp lower t 0 75 dcnl dcsp dcsp dcsp dcsp gidx np searchsorted freqs fstart fend dcnl dcsp dcsp dcsp dcsp bidx np searchsorted freqs fstart trans bandwidth 2 fend + trans bandwidth 2 dcnl dcsp dcsp dcsp dcsp if method coh dcnl dcsp dcsp dcsp dcsp dcsp assert true np all con1 0 gidx0 gidx1 upper t con1 0 gidx0 gidx1 min dcnl dcsp dcsp dcsp dcsp dcsp assert true np all con1 0 bidx0 < lower t dcnl dcsp dcsp dcsp dcsp dcsp assert true np all con1 0 bidx1 < lower t con 1 0 bidx1 max dcnl dcsp dcsp dcsp dcsp elif method cohy dcnl dcsp dcsp dcsp dcsp dcsp check np imag con1 0 gidx0 gidx1 dcnl dcsp dcsp dcsp dcsp dcsp assert true np all check < lower t check max dcnl dcsp dcsp dcsp dcsp dcsp assert true np all np abs con1 0 gidx0 gidx1 upper t dcnl dcsp dcsp dcsp dcsp dcsp assert true np all np abs con1 0 bidx0 < lower t dcnl dcsp dcsp dcsp dcsp dcsp assert true np all np abs con1 0 bidx1 < lower t dcnl dcsp dcsp dcsp dcsp elif method imcoh dcnl dcsp dcsp dcsp dcsp dcsp assert true np all con1 0 gidx0 gidx1 < lower t dcnl dcsp dcsp dcsp dcsp dcsp assert true np all con1 0 bidx0 < lower t dcnl dcsp dcsp dcsp dcsp dcsp assert true np all con1 0 bidx1 < lower t con1 0 bidx1 max dcnl dcsp dcsp dcsp dcsp indices np tril indices n signals 1 dcnl dcsp dcsp dcsp dcsp if not isinstance method list dcnl dcsp dcsp dcsp dcsp dcsp test methods method cohest dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp test methods method dcnl dcsp dcsp dcsp dcsp stc data stc gen data sfreq tmin dcnl dcsp dcsp dcsp dcsp con2 freqs2 times2 n2 spectral connectivity stc data method test methods mode mode indices indices sfreq sfreq mt adaptive adaptive mt low bias true mt bandwidth mt bandwidth tmin tmin tmax tmax cwt frequencies cwt frequencies cwt n cycles cwt n cycles n jobs 2 dcnl dcsp dcsp dcsp dcsp assert true isinstance con2 list dcnl dcsp dcsp dcsp dcsp assert true len con2 len test methods dcnl dcsp dcsp dcsp dcsp if method coh dcnl dcsp dcsp dcsp dcsp dcsp assert array almost equal con20 con21 dcnl dcsp dcsp dcsp dcsp if not isinstance method list dcnl dcsp dcsp dcsp dcsp dcsp con2 con20 dcnl dcsp dcsp dcsp dcsp dcsp assert array almost equal freqs freqs2 dcnl dcsp dcsp dcsp dcsp dcsp assert array almost equal conindices con2 dcnl dcsp dcsp dcsp dcsp dcsp assert true n n2 dcnl dcsp dcsp dcsp dcsp dcsp assert array almost equal times data times2 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp assert true len con len con2 dcnl dcsp dcsp dcsp dcsp dcsp for c c2 in zip con con2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert array almost equal freqs freqs2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert array almost equal cindices c2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert true n n2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert array almost equal times data times2 dcnl dcsp dcsp dcsp dcsp fmin 5 0 15 0 dcnl dcsp dcsp dcsp dcsp fmax 15 0 30 0 dcnl dcsp dcsp dcsp dcsp con3 freqs3 times3 n3 spectral connectivity data method method mode mode indices indices sfreq sfreq fmin fmin fmax fmax fskip 1 faverage true mt adaptive adaptive mt low bias true mt bandwidth mt bandwidth cwt frequencies cwt frequencies cwt n cycles cwt n cycles dcnl dcsp dcsp dcsp dcsp assert true isinstance freqs3 list dcnl dcsp dcsp dcsp dcsp assert true len freqs3 len fmin dcnl dcsp dcsp dcsp dcsp for i in range len freqs3 dcnl dcsp dcsp dcsp dcsp dcsp assert true np all freqs3i fmini freqs3i < fmaxi dcnl dcsp dcsp dcsp dcsp if not isinstance method list dcnl dcsp dcsp dcsp dcsp dcsp for i in range len freqs3 dcnl dcsp dcsp dcsp dcsp dcsp dcsp freq idx np searchsorted freqs2 freqs3i dcnl dcsp dcsp dcsp dcsp dcsp dcsp con2 avg np mean con2 freq idx axis 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert array almost equal con2 avg con3 i dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp for j in range len con2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp for i in range len freqs3 dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp freq idx np searchsorted freqs2 freqs3i dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp con2 avg np mean con2j freq idx axis 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp assert array almost equal con2 avg con3j i dcnl dcsp full list list range 10 dcnl dcsp out lens np array len x for x in get n epochs full list 4 dcnl dcsp assert true out lens np array 4 4 2 all dcnl dcsp out lens np array len x for x in get n epochs full list 11 dcnl dcsp assert true len out lens 0 dcnl dcsp assert true out lens0 10
def test indices dcsp n seeds test 1 3 4 dcnl dcsp n targets test 2 3 200 dcnl dcsp rng np random randomstate 42 dcnl dcsp for n seeds in n seeds test dcnl dcsp dcsp for n targets in n targets test dcnl dcsp dcsp dcsp idx rng permutation np arange n seeds + n targets dcnl dcsp dcsp dcsp seeds idx n seeds dcnl dcsp dcsp dcsp targets idxn seeds dcnl dcsp dcsp dcsp indices seed target indices seeds targets dcnl dcsp dcsp dcsp assert true len indices 2 dcnl dcsp dcsp dcsp assert true len indices0 len indices1 dcnl dcsp dcsp dcsp assert true len indices0 n seeds n targets dcnl dcsp dcsp dcsp for seed in seeds dcnl dcsp dcsp dcsp dcsp assert true np sum indices0 seed n targets dcnl dcsp dcsp dcsp for target in targets dcnl dcsp dcsp dcsp dcsp assert true np sum indices1 target n seeds
def test psi dcsp sfreq 50 0 dcnl dcsp n signals 3 dcnl dcsp n epochs 10 dcnl dcsp n times 500 dcnl dcsp rng np random randomstate 42 dcnl dcsp data rng randn n epochs n signals n times dcnl dcsp for i in range n epochs dcnl dcsp dcsp datai 1 10 datai 0 10 dcnl dcsp dcsp datai 2 10 datai 0 10 dcnl dcsp psi freqs times n epochs n tapers phase slope index data mode fourier sfreq sfreq dcnl dcsp assert true psi 1 0 0 < 0 dcnl dcsp assert true psi 2 0 0 0 dcnl dcsp indices np array 0 np array 1 dcnl dcsp psi 2 freqs times n epochs n tapers phase slope index data mode fourier sfreq sfreq indices indices dcnl dcsp assert array almost equal psi 2 0 0 psi 1 0 0 dcnl dcsp cwt freqs np arange 5 0 20 0 5 dcnl dcsp psi cwt freqs times n epochs n tapers phase slope index data mode cwt morlet sfreq sfreq cwt frequencies cwt freqs indices indices dcnl dcsp assert true np all psi cwt 0 dcnl dcsp assert true psi cwt shape 1 n times
def epoch spectral connectivity data sig idx tmin idx tmax idx sfreq mode window fun eigvals wavelets freq mask mt adaptive idx map block size psd accumulate psd con method types con methods n signals n times accumulate inplace true dcsp n cons len idx map0 dcnl dcsp if wavelets is not none dcnl dcsp dcsp n times spectrum n times dcnl dcsp dcsp n freqs len wavelets dcnl dcsp else dcnl dcsp dcsp n times spectrum 0 dcnl dcsp dcsp n freqs np sum freq mask dcnl dcsp if not accumulate inplace dcnl dcsp dcsp con methods mtype n cons n freqs n times spectrum for mtype in con method types dcnl dcsp if len sig idx n signals dcnl dcsp dcsp sig idx slice none none dcnl dcsp if mode in multitaper fourier dcnl dcsp dcsp x mt list dcnl dcsp dcsp this psd list dcnl dcsp dcsp sig pos start 0 dcnl dcsp dcsp for this data in data dcnl dcsp dcsp dcsp this n sig this data shape0 dcnl dcsp dcsp dcsp sig pos end sig pos start + this n sig dcnl dcsp dcsp dcsp if not isinstance sig idx slice dcnl dcsp dcsp dcsp dcsp this sig idx sig idx sig idx sig pos start sig idx < sig pos end sig pos start dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this sig idx sig idx dcnl dcsp dcsp dcsp if isinstance this data basesourceestimate dcnl dcsp dcsp dcsp dcsp mt spectra partial partial mt spectra dpss window fun sfreq sfreq dcnl dcsp dcsp dcsp dcsp this x mt this data transform data mt spectra partial idx this sig idx tmin idx tmin idx tmax idx tmax idx dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this x mt mt spectra this datathis sig idx tmin idx tmax idx window fun sfreq dcnl dcsp dcsp dcsp if mt adaptive dcnl dcsp dcsp dcsp dcsp this psd weights psd from mt adaptive this x mt eigvals freq mask return weights true dcnl dcsp dcsp dcsp dcsp this x mt this x mt freq mask dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this x mt this x mt freq mask dcnl dcsp dcsp dcsp dcsp if mode multitaper dcnl dcsp dcsp dcsp dcsp dcsp weights np sqrt eigvals np newaxis np newaxis dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp weights np array 1 0 none none dcnl dcsp dcsp dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp dcsp dcsp this psd psd from mt this x mt weights dcnl dcsp dcsp dcsp x mt append this x mt dcnl dcsp dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp dcsp this psd append this psd dcnl dcsp dcsp x mt np concatenate x mt axis 0 dcnl dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp this psd np concatenate this psd axis 0 dcnl dcsp dcsp sig pos start sig pos end dcnl dcsp elif mode cwt morlet dcnl dcsp dcsp x cwt list dcnl dcsp dcsp this psd list dcnl dcsp dcsp sig pos start 0 dcnl dcsp dcsp for this data in data dcnl dcsp dcsp dcsp this n sig this data shape0 dcnl dcsp dcsp dcsp sig pos end sig pos start + this n sig dcnl dcsp dcsp dcsp if not isinstance sig idx slice dcnl dcsp dcsp dcsp dcsp this sig idx sig idx sig idx sig pos start sig idx < sig pos end sig pos start dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this sig idx sig idx dcnl dcsp dcsp dcsp if isinstance this data basesourceestimate dcnl dcsp dcsp dcsp dcsp cwt partial partial cwt ws wavelets use fft true mode same dcnl dcsp dcsp dcsp dcsp this x cwt this data transform data cwt partial idx this sig idx tmin idx tmin idx tmax idx tmax idx dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this x cwt cwt this datathis sig idx tmin idx tmax idx wavelets use fft true mode same dcnl dcsp dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp dcsp this psd append this x cwt this x cwt conj real dcnl dcsp dcsp dcsp x cwt append this x cwt dcnl dcsp dcsp dcsp sig pos start sig pos end dcnl dcsp dcsp x cwt np concatenate x cwt axis 0 dcnl dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp this psd np concatenate this psd axis 0 dcnl dcsp else dcnl dcsp dcsp raise runtimeerror invalid dcsp mode dcnl dcsp if accumulate psd dcnl dcsp dcsp if accumulate inplace dcnl dcsp dcsp dcsp psd + this psd dcnl dcsp dcsp else dcnl dcsp dcsp dcsp psd this psd dcnl dcsp else dcnl dcsp dcsp psd none dcnl dcsp for method in con methods dcnl dcsp dcsp method start epoch dcnl dcsp if mode in multitaper fourier dcnl dcsp dcsp for i in range 0 n cons block size dcnl dcsp dcsp dcsp con idx slice i i + block size dcnl dcsp dcsp dcsp if mt adaptive dcnl dcsp dcsp dcsp dcsp csd csd from mt x mtidx map0con idx x mtidx map1con idx weightsidx map0con idx weightsidx map1con idx dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp csd csd from mt x mtidx map0con idx x mtidx map1con idx weights weights dcnl dcsp dcsp dcsp for method in con methods dcnl dcsp dcsp dcsp dcsp method accumulate con idx csd dcnl dcsp elif mode in cwt morlet dcnl dcsp dcsp for i block i in enumerate range 0 n cons block size dcnl dcsp dcsp dcsp con idx slice i i + block size dcnl dcsp dcsp dcsp csd x cwtidx map0con idx x cwtidx map1con idx conjugate dcnl dcsp dcsp dcsp for method in con methods dcnl dcsp dcsp dcsp dcsp method accumulate con idx csd dcnl dcsp else dcnl dcsp dcsp raise runtimeerror this dcsp should dcsp never dcsp happen dcnl dcsp return con methods psd
def get n epochs epochs n dcsp epochs out list dcnl dcsp for epoch in epochs dcnl dcsp dcsp if not isinstance epoch list tuple dcnl dcsp dcsp dcsp epoch epoch dcnl dcsp dcsp epochs out append epoch dcnl dcsp dcsp if len epochs out n dcnl dcsp dcsp dcsp yield epochs out dcnl dcsp dcsp dcsp epochs out list dcnl dcsp if 0 < len epochs out < n dcnl dcsp dcsp yield epochs out
def check method method dcsp interface members m0 for m in getmembers abstractconestbase if not m0 startswith dcnl dcsp method members m0 for m in getmembers method if not m0 startswith dcnl dcsp for member in interface members dcnl dcsp dcsp if member not in method members dcnl dcsp dcsp dcsp return false member dcnl dcsp return true none
def get and verify data sizes data n signals none n times none times none dcsp if not isinstance data list tuple dcnl dcsp dcsp raise valueerror data dcsp has dcsp to dcsp be dcsp a dcsp list dcsp or dcsp tuple dcnl dcsp n signals tot 0 dcnl dcsp for this data in data dcnl dcsp dcsp this n signals this n times this data shape dcnl dcsp dcsp if n times is not none dcnl dcsp dcsp dcsp if this n times n times dcnl dcsp dcsp dcsp dcsp raise valueerror all dcsp input dcsp time dcsp series dcsp must dcsp have dcsp the dcsp same dcsp number dcsp of dcsp time dcsp points dcnl dcsp dcsp else dcnl dcsp dcsp dcsp n times this n times dcnl dcsp dcsp n signals tot + this n signals dcnl dcsp dcsp if hasattr this data times dcnl dcsp dcsp dcsp this times this data times dcnl dcsp dcsp dcsp if times is not none dcnl dcsp dcsp dcsp dcsp if np any times this times dcnl dcsp dcsp dcsp dcsp dcsp warn time dcsp scales dcsp of dcsp input dcsp time dcsp series dcsp do dcsp not dcsp match dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp times this times dcnl dcsp if n signals is not none dcnl dcsp dcsp if n signals n signals tot dcnl dcsp dcsp dcsp raise valueerror the dcsp number dcsp of dcsp time dcsp series dcsp has dcsp to dcsp be dcsp the dcsp same dcsp in dcsp each dcsp epoch dcnl dcsp n signals n signals tot dcnl dcsp return n signals n times times
def check estimators method mode dcsp n methods len method dcnl dcsp con method types list dcnl dcsp for this method in method dcnl dcsp dcsp if this method in con method map dcnl dcsp dcsp dcsp con method types append con method mapthis method dcnl dcsp dcsp elif isinstance this method string types dcnl dcsp dcsp dcsp raise valueerror s dcsp is dcsp not dcsp a dcsp valid dcsp connectivity dcsp method this method dcnl dcsp dcsp else dcnl dcsp dcsp dcsp method valid msg check method this method dcnl dcsp dcsp dcsp if not method valid dcnl dcsp dcsp dcsp dcsp raise valueerror the dcsp supplied dcsp connectivity dcsp method dcsp does dcsp not dcsp have dcsp the dcsp method dcsp s msg dcnl dcsp dcsp dcsp con method types append this method dcnl dcsp n comp args len get args mtype compute con for mtype in con method types dcnl dcsp if any n not in 3 5 for n in n comp args dcnl dcsp dcsp raise valueerror the dcsp compute con dcsp method dcsp needs dcsp to dcsp have dcsp either dcsp 3 dcsp or dcsp 5 dcsp arguments dcnl dcsp accumulate psd any n 5 for n in n comp args dcnl dcsp return con method types n methods accumulate psd n comp args
verbose dcnl def spectral connectivity data method coh indices none sfreq 2 np pi mode multitaper fmin none fmax np inf fskip 0 faverage false tmin none tmax none mt bandwidth none mt adaptive false mt low bias true cwt frequencies none cwt n cycles 7 block size 1000 n jobs 1 verbose none dcsp if n jobs 1 dcnl dcsp dcsp parallel my epoch spectral connectivity parallel func epoch spectral connectivity n jobs verbose verbose dcnl dcsp if fmin is none dcnl dcsp dcsp fmin np inf dcnl dcsp fmin np asarray fmin ravel dcnl dcsp fmax np asarray fmax ravel dcnl dcsp if len fmin len fmax dcnl dcsp dcsp raise valueerror fmin dcsp and dcsp fmax dcsp must dcsp have dcsp the dcsp same dcsp length dcnl dcsp if np any fmin fmax dcnl dcsp dcsp raise valueerror fmax dcsp must dcsp be dcsp larger dcsp than dcsp fmin dcnl dcsp n bands len fmin dcnl dcsp if not isinstance method list tuple dcnl dcsp dcsp method method dcnl dcsp con method types n methods accumulate psd n comp args check estimators method method mode mode dcnl dcsp if isinstance data baseepochs dcnl dcsp dcsp times in data times dcnl dcsp dcsp sfreq data info sfreq dcnl dcsp epoch idx 0 dcnl dcsp logger info connectivity dcsp computation dcnl dcsp for epoch block in get n epochs data n jobs dcnl dcsp dcsp if epoch idx 0 dcnl dcsp dcsp dcsp n cons times n times times in n times in tmin idx tmax idx n freqs freq mask freqs freqs bands freq idx bands n signals indices use prepare connectivity epoch block epoch block tmin tmin tmax tmax fmin fmin fmax fmax sfreq sfreq indices indices mode mode fskip fskip n bands n bands cwt frequencies cwt frequencies faverage faverage dcnl dcsp dcsp dcsp spectral params mt adaptive n times spectrum n tapers assemble spectral params mode mode n times n times mt adaptive mt adaptive mt bandwidth mt bandwidth sfreq sfreq mt low bias mt low bias cwt n cycles cwt n cycles cwt frequencies cwt frequencies freqs freqs freq mask freq mask dcnl dcsp dcsp dcsp sig idx np unique np r indices use0 indices use1 dcnl dcsp dcsp dcsp idx map np searchsorted sig idx ind for ind in indices use dcnl dcsp dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp dcsp if n times spectrum 0 dcnl dcsp dcsp dcsp dcsp dcsp psd shape len sig idx n freqs dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp psd shape len sig idx n freqs n times spectrum dcnl dcsp dcsp dcsp dcsp psd np zeros psd shape dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp psd none dcnl dcsp dcsp dcsp con methods mtype n cons n freqs n times spectrum for mtype in con method types dcnl dcsp dcsp dcsp sep dcsp dcnl dcsp dcsp dcsp metrics str sep join meth name for meth in con methods dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp the dcsp following dcsp metrics dcsp will dcsp be dcsp computed dcsp s metrics str dcnl dcsp dcsp for this epoch in epoch block dcnl dcsp dcsp dcsp get and verify data sizes this epoch n signals n times in times in dcnl dcsp dcsp call params dict sig idx sig idx tmin idx tmin idx tmax idx tmax idx sfreq sfreq mode mode freq mask freq mask idx map idx map block size block size psd psd accumulate psd accumulate psd mt adaptive mt adaptive con method types con method types con methods con methods if n jobs 1 else none n signals n signals n times n times accumulate inplace true if n jobs 1 else false dcnl dcsp dcsp call params update spectral params dcnl dcsp dcsp if n jobs 1 dcnl dcsp dcsp dcsp for this epoch in epoch block dcnl dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp computing dcsp connectivity dcsp for dcsp epoch dcsp d epoch idx + 1 dcnl dcsp dcsp dcsp dcsp epoch spectral connectivity data this epoch call params dcnl dcsp dcsp dcsp dcsp epoch idx + 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp computing dcsp connectivity dcsp for dcsp epochs dcsp d d epoch idx + 1 epoch idx + len epoch block dcnl dcsp dcsp dcsp out parallel my epoch spectral connectivity data this epoch call params for this epoch in epoch block dcnl dcsp dcsp dcsp for this out in out dcnl dcsp dcsp dcsp dcsp for method parallel method in zip con methods this out0 dcnl dcsp dcsp dcsp dcsp dcsp method combine parallel method dcnl dcsp dcsp dcsp dcsp if accumulate psd dcnl dcsp dcsp dcsp dcsp dcsp psd + this out1 dcnl dcsp dcsp dcsp epoch idx + len epoch block dcnl dcsp n epochs epoch idx dcnl dcsp if accumulate psd dcnl dcsp dcsp psd n epochs dcnl dcsp con list dcnl dcsp for method n args in zip con methods n comp args dcnl dcsp dcsp if n args 3 dcnl dcsp dcsp dcsp method compute con slice 0 n cons n epochs dcnl dcsp dcsp elif n args 5 dcnl dcsp dcsp dcsp for i in range 0 n cons block size dcnl dcsp dcsp dcsp dcsp con idx slice i i + block size dcnl dcsp dcsp dcsp dcsp psd xx psdidx map0con idx dcnl dcsp dcsp dcsp dcsp psd yy psdidx map1con idx dcnl dcsp dcsp dcsp dcsp method compute con con idx n epochs psd xx psd yy dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise runtimeerror this dcsp should dcsp never dcsp happen dcnl dcsp dcsp this con method con scores dcnl dcsp dcsp if this con shape0 n cons dcnl dcsp dcsp dcsp raise valueerror first dcsp dimension dcsp of dcsp connectivity dcsp scores dcsp must dcsp be dcsp the dcsp same dcsp as dcsp the dcsp number dcsp of dcsp connections dcnl dcsp dcsp if faverage dcnl dcsp dcsp dcsp if this con shape1 n freqs dcnl dcsp dcsp dcsp dcsp raise valueerror 2nd dcsp dimension dcsp of dcsp connectivity dcsp scores dcsp must dcsp be dcsp the dcsp same dcsp as dcsp the dcsp number dcsp of dcsp frequencies dcnl dcsp dcsp dcsp con shape n cons n bands + this con shape2 dcnl dcsp dcsp dcsp this con bands np empty con shape dtype this con dtype dcnl dcsp dcsp dcsp for band idx in range n bands dcnl dcsp dcsp dcsp dcsp this con bands band idx np mean this con freq idx bandsband idx axis 1 dcnl dcsp dcsp dcsp this con this con bands dcnl dcsp dcsp con append this con dcnl dcsp if indices is none dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp assembling dcsp connectivity dcsp matrix dcsp filling dcsp the dcsp upper dcsp triangular dcsp region dcsp of dcsp the dcsp matrix dcnl dcsp dcsp con flat con dcnl dcsp dcsp con list dcnl dcsp dcsp for this con flat in con flat dcnl dcsp dcsp dcsp this con np zeros n signals n signals + this con flat shape1 dtype this con flat dtype dcnl dcsp dcsp dcsp this conindices use this con flat dcnl dcsp dcsp dcsp con append this con dcnl dcsp logger info connectivity dcsp computation dcsp done dcnl dcsp if n methods 1 dcnl dcsp dcsp con con0 dcnl dcsp if faverage dcnl dcsp dcsp freqs freqs bands dcnl dcsp return con freqs times n epochs n tapers
def prepare connectivity epoch block tmin tmax fmin fmax sfreq indices mode fskip n bands cwt frequencies faverage dcsp first epoch epoch block0 dcnl dcsp n signals n times in times in get and verify data sizes first epoch dcnl dcsp if times in is none dcnl dcsp dcsp times in np linspace 0 0 n times in sfreq n times in endpoint false dcnl dcsp n times in len times in dcnl dcsp mask time mask times in tmin tmax sfreq sfreq dcnl dcsp tmin idx tmax idx np where mask 00 1 dcnl dcsp tmax idx + 1 dcnl dcsp tmin true times intmin idx dcnl dcsp tmax true times in tmax idx 1 dcnl dcsp times times intmin idx tmax idx dcnl dcsp n times len times dcnl dcsp if indices is none dcnl dcsp dcsp logger info only dcsp using dcsp indices dcsp for dcsp lowertriangular dcsp matrix dcnl dcsp dcsp indices use np tril indices n signals 1 dcnl dcsp else dcnl dcsp dcsp indices use check indices indices dcnl dcsp n cons len indices use0 dcnl dcsp logger info dcsp dcsp dcsp dcsp computing dcsp connectivity dcsp for dcsp d dcsp connections n cons dcnl dcsp logger info dcsp dcsp dcsp dcsp using dcsp t 0 3fs 0 3fs dcsp for dcsp estimation dcsp d dcsp points tmin true tmax true n times dcnl dcsp if mode in multitaper fourier dcnl dcsp dcsp freqs all fftfreq n times 1 0 sfreq dcnl dcsp dcsp freqs all freqs all freqs all 0 dcnl dcsp elif mode cwt morlet dcnl dcsp dcsp if cwt frequencies is none dcnl dcsp dcsp dcsp raise valueerror define dcsp frequencies dcsp of dcsp interest dcsp using dcsp cwt frequencies dcnl dcsp dcsp else dcnl dcsp dcsp dcsp cwt frequencies cwt frequencies astype np float dcnl dcsp dcsp if any cwt frequencies sfreq 2 0 dcnl dcsp dcsp dcsp raise valueerror entries dcsp in dcsp cwt frequencies dcsp cannot dcsp be dcsp larger dcsp than dcsp nyquist dcsp sfreq dcsp dcsp 2 dcnl dcsp dcsp freqs all cwt frequencies dcnl dcsp else dcnl dcsp dcsp raise valueerror mode dcsp has dcsp an dcsp invalid dcsp value dcnl dcsp five cycle freq 5 0 sfreq float n times dcnl dcsp if len fmin 1 and fmin0 np inf dcnl dcsp dcsp fmin five cycle freq dcnl dcsp elif any fmin < five cycle freq dcnl dcsp dcsp warn fmin dcsp corresponds dcsp to dcsp less dcsp than dcsp 5 dcsp cycles dcsp spectrum dcsp estimate dcsp will dcsp be dcsp unreliable dcnl dcsp freq mask np zeros len freqs all dtype np bool dcnl dcsp for f lower f upper in zip fmin fmax dcnl dcsp dcsp freq mask | freqs all f lower freqs all < f upper dcnl dcsp for pos in range fskip dcnl dcsp dcsp freq mask pos + 1 fskip + 1 false dcnl dcsp freqs freqs allfreq mask dcnl dcsp n freqs len freqs dcnl dcsp freq idx bands np where freqs fl freqs < fu 0 for fl fu in zip fmin fmax dcnl dcsp freqs bands freqsfreq idx for freq idx in freq idx bands dcnl dcsp for i n f band in enumerate len f for f in freqs bands dcnl dcsp dcsp if n f band 0 dcnl dcsp dcsp dcsp raise valueerror there dcsp are dcsp no dcsp frequency dcsp points dcsp between dcsp 0 1fhz dcsp and dcsp 0 1fhz dcsp change dcsp the dcsp band dcsp specification dcsp fmin dcsp fmax dcsp or dcsp the dcsp frequency dcsp resolution fmini fmaxi dcnl dcsp if n bands 1 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp frequencies dcsp 0 1fhz 0 1fhz dcsp d dcsp points freqs bands00 freqs bands0 1 n freqs dcnl dcsp else dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp computing dcsp connectivity dcsp for dcsp the dcsp bands dcnl dcsp dcsp for i bfreqs in enumerate freqs bands dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp band dcsp d dcsp 0 1fhz 0 1fhz dcsp d dcsp points i + 1 bfreqs0 bfreqs 1 len bfreqs dcnl dcsp if faverage dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp connectivity dcsp scores dcsp will dcsp be dcsp averaged dcsp for dcsp each dcsp band dcnl dcsp return n cons times n times times in n times in tmin idx tmax idx n freqs freq mask freqs freqs bands freq idx bands n signals indices use
def assemble spectral params mode n times mt adaptive mt bandwidth sfreq mt low bias cwt n cycles cwt frequencies freqs freq mask dcsp spectral params dict eigvals none window fun none wavelets none dcnl dcsp n tapers none dcnl dcsp n times spectrum 0 dcnl dcsp if mode multitaper dcnl dcsp dcsp if mt bandwidth is not none dcnl dcsp dcsp dcsp half nbw float mt bandwidth n times 2 sfreq dcnl dcsp dcsp else dcnl dcsp dcsp dcsp half nbw 4 dcnl dcsp dcsp n tapers max int 2 half nbw dcnl dcsp dcsp window fun eigvals dpss windows n times half nbw n tapers max low bias mt low bias dcnl dcsp dcsp spectral params update window fun window fun eigvals eigvals dcnl dcsp dcsp n tapers len eigvals dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp using dcsp multitaper dcsp spectrum dcsp estimation dcsp with dcsp d dcsp dpss dcsp windows n tapers dcnl dcsp dcsp if mt adaptive and len eigvals < 3 dcnl dcsp dcsp dcsp warn not dcsp adaptively dcsp combining dcsp the dcsp spectral dcsp estimators dcsp due dcsp to dcsp a dcsp low dcsp number dcsp of dcsp tapers dcnl dcsp dcsp dcsp mt adaptive false dcnl dcsp elif mode fourier dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp using dcsp fft dcsp with dcsp a dcsp hanning dcsp window dcsp to dcsp estimate dcsp spectra dcnl dcsp dcsp spectral params update window fun np hanning n times eigvals 1 0 dcnl dcsp elif mode cwt morlet dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp using dcsp cwt dcsp with dcsp morlet dcsp wavelets dcsp to dcsp estimate dcsp spectra dcnl dcsp dcsp cwt n cycles np asarray cwt n cycles ravel dcnl dcsp dcsp if len cwt n cycles 1 dcnl dcsp dcsp dcsp if len cwt n cycles len cwt frequencies dcnl dcsp dcsp dcsp dcsp raise valueerror cwt n cycles dcsp must dcsp be dcsp float dcsp or dcsp an dcsp array dcsp with dcsp the dcsp same dcsp size dcsp as dcsp cwt frequencies dcnl dcsp dcsp dcsp cwt n cycles cwt n cyclesfreq mask dcnl dcsp dcsp spectral params update wavelets morlet sfreq freqs n cycles cwt n cycles zero mean true dcnl dcsp dcsp n times spectrum n times dcnl dcsp else dcnl dcsp dcsp raise valueerror mode dcsp has dcsp an dcsp invalid dcsp value dcnl dcsp return spectral params mt adaptive n times spectrum n tapers
verbose dcnl def phase slope index data indices none sfreq 2 np pi mode multitaper fmin none fmax np inf tmin none tmax none mt bandwidth none mt adaptive false mt low bias true cwt frequencies none cwt n cycles 7 block size 1000 n jobs 1 verbose none dcsp logger info estimating dcsp phase dcsp slope dcsp index dcsp psi dcnl dcsp cohy freqs times n epochs n tapers spectral connectivity data method cohy indices indices sfreq sfreq mode mode fmin fmin fmax fmax fskip 0 faverage false tmin tmin tmax tmax mt bandwidth mt bandwidth mt adaptive mt adaptive mt low bias mt low bias cwt frequencies cwt frequencies cwt n cycles cwt n cycles block size block size n jobs n jobs verbose verbose dcnl dcsp logger info computing dcsp psi dcsp from dcsp estimated dcsp coherency dcnl dcsp if fmin is none dcnl dcsp dcsp fmin np inf dcnl dcsp bands list zip np asarray fmin ravel np asarray fmax ravel dcnl dcsp n bands len bands dcnl dcsp freq dim 2 if mode cwt morlet else 1 dcnl dcsp out shape list cohy shape dcnl dcsp out shapefreq dim n bands dcnl dcsp psi np zeros out shape dtype np float dcnl dcsp acc shape copy copy out shape dcnl dcsp acc shape pop freq dim dcnl dcsp acc np empty acc shape dtype np complex128 dcnl dcsp freqs list dcnl dcsp idx fi slice none cohy ndim dcnl dcsp idx fj slice none cohy ndim dcnl dcsp for band idx band in enumerate bands dcnl dcsp dcsp freq idx np where freqs band0 freqs < band1 0 dcnl dcsp dcsp freqs append freqs freq idx dcnl dcsp dcsp acc fill 0 0 dcnl dcsp dcsp for fi fj in zip freq idx freq idx1 dcnl dcsp dcsp dcsp idx fifreq dim fi dcnl dcsp dcsp dcsp idx fjfreq dim fj dcnl dcsp dcsp dcsp acc + np conj cohyidx fi cohyidx fj dcnl dcsp dcsp idx fifreq dim band idx dcnl dcsp dcsp psiidx fi np imag acc dcnl dcsp logger info psi dcsp estimation dcsp done dcnl dcsp return psi freqs times n epochs n tapers
def check decim info decim offset dcsp if decim < 1 or decim int decim dcnl dcsp dcsp raise valueerror decim dcsp must dcsp be dcsp an dcsp integer dcsp dcsp 0 dcnl dcsp decim int decim dcnl dcsp new sfreq info sfreq float decim dcnl dcsp lowpass info lowpass dcnl dcsp if decim 1 and lowpass is none dcnl dcsp dcsp warn the dcsp measurement dcsp information dcsp indicates dcsp data dcsp is dcsp not dcsp lowpass dcsp filtered dcsp the dcsp decim i dcsp parameter dcsp will dcsp result dcsp in dcsp a dcsp sampling dcsp frequency dcsp of dcsp g dcsp hz dcsp which dcsp can dcsp cause dcsp aliasing dcsp artifacts decim new sfreq dcnl dcsp elif decim 1 and new sfreq < 2 5 lowpass dcnl dcsp dcsp warn the dcsp measurement dcsp information dcsp indicates dcsp a dcsp lowpass dcsp frequency dcsp of dcsp g dcsp hz dcsp the dcsp decim i dcsp parameter dcsp will dcsp result dcsp in dcsp a dcsp sampling dcsp frequency dcsp of dcsp g dcsp hz dcsp which dcsp can dcsp cause dcsp aliasing dcsp artifacts lowpass decim new sfreq dcnl dcsp offset int offset dcnl dcsp if not 0 < offset < decim dcnl dcsp dcsp raise valueerror decim dcsp must dcsp be dcsp at dcsp least dcsp 0 dcsp and dcsp less dcsp than dcsp s dcsp got dcsp s decim offset dcnl dcsp return decim offset new sfreq
def get entries fid evoked node allow maxshield false dcsp comments list dcnl dcsp aspect kinds list dcnl dcsp for ev in evoked node dcnl dcsp dcsp for k in range ev nent dcnl dcsp dcsp dcsp my kind ev directory k kind dcnl dcsp dcsp dcsp pos ev directory k pos dcnl dcsp dcsp dcsp if my kind fiff fiff comment dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp comments append tag data dcnl dcsp dcsp my aspect get aspect ev allow maxshield 0 dcnl dcsp dcsp for k in range my aspect nent dcnl dcsp dcsp dcsp my kind my aspect directory k kind dcnl dcsp dcsp dcsp pos my aspect directory k pos dcnl dcsp dcsp dcsp if my kind fiff fiff aspect kind dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp aspect kinds append int tag data dcnl dcsp comments np atleast 1d comments dcnl dcsp aspect kinds np atleast 1d aspect kinds dcnl dcsp if len comments len aspect kinds or len comments 0 dcnl dcsp dcsp fid close dcnl dcsp dcsp raise valueerror dataset dcsp names dcsp in dcsp fif dcsp file dcsp could dcsp not dcsp be dcsp found dcnl dcsp t aspect rev get str a unknown for a in aspect kinds dcnl dcsp t + c + dcsp + tt + for tt c in zip t comments dcnl dcsp t dcsp dcsp + n dcsp dcsp join t dcnl dcsp return comments aspect kinds t
def get aspect evoked allow maxshield dcsp is maxshield false dcnl dcsp aspect dir tree find evoked fiff fiffb aspect dcnl dcsp if len aspect 0 dcnl dcsp dcsp check maxshield allow maxshield dcnl dcsp dcsp aspect dir tree find evoked fiff fiffb smsh aspect dcnl dcsp dcsp is maxshield true dcnl dcsp if len aspect 1 dcnl dcsp dcsp logger info multiple dcsp data dcsp aspects dcsp found dcsp taking dcsp first dcsp one dcnl dcsp return aspect0 is maxshield
def get evoked node fname dcsp f tree fiff open fname dcnl dcsp with f as fid dcnl dcsp dcsp meas read meas info fid tree verbose false dcnl dcsp dcsp evoked node dir tree find meas fiff fiffb evoked dcnl dcsp return evoked node
def grand average all evoked interpolate bads true dcsp if not all isinstance e evoked for e in all evoked dcnl dcsp dcsp raise valueerror not dcsp all dcsp the dcsp elements dcsp in dcsp list dcsp are dcsp evoked dcsp data dcnl dcsp all evoked e copy for e in all evoked dcnl dcsp if interpolate bads dcnl dcsp dcsp all evoked e interpolate bads if len e info bads 0 else e for e in all evoked dcnl dcsp equalize channels all evoked dcnl dcsp grand average combine evoked all evoked weights equal dcnl dcsp grand average nave len all evoked dcnl dcsp grand average comment grand dcsp average dcsp n dcsp dcsp d grand average nave dcnl dcsp return grand average
def combine evoked all evoked weights dcsp evoked all evoked0 copy dcnl dcsp if isinstance weights string types dcnl dcsp dcsp if weights not in nave equal dcnl dcsp dcsp dcsp raise valueerror weights dcsp must dcsp be dcsp a dcsp list dcsp of dcsp float dcsp or dcsp nave dcsp or dcsp equal dcnl dcsp dcsp if weights nave dcnl dcsp dcsp dcsp weights np array e nave for e in all evoked float dcnl dcsp dcsp dcsp weights weights sum dcnl dcsp dcsp else dcnl dcsp dcsp dcsp weights 1 0 len all evoked len all evoked dcnl dcsp weights np array weights float dcnl dcsp if weights ndim 1 or weights size len all evoked dcnl dcsp dcsp raise valueerror weights dcsp must dcsp be dcsp the dcsp same dcsp size dcsp as dcsp all evoked dcnl dcsp ch names evoked ch names dcnl dcsp for e in all evoked1 dcnl dcsp dcsp assert e ch names ch names valueerror s dcsp and dcsp s dcsp do dcsp not dcsp contain dcsp the dcsp same dcsp channels evoked e dcnl dcsp dcsp assert np max np abs e times evoked times < 1e07 valueerror s dcsp and dcsp s dcsp do dcsp not dcsp contain dcsp the dcsp same dcsp time dcsp instants evoked e dcnl dcsp bads list set evoked info bads union ev info bads for ev in all evoked1 dcnl dcsp evoked info bads bads dcnl dcsp evoked data sum w e data for w e in zip weights all evoked dcnl dcsp evoked nave max int round 1 0 sum w 2 e nave for w e in zip weights all evoked 1 dcnl dcsp evoked comment dcsp + dcsp join 0 3f dcsp dcsp s w e comment or unknown for w e in zip weights all evoked dcnl dcsp return evoked
verbose dcnl def read evokeds fname condition none baseline none kind average proj true allow maxshield false verbose none dcsp check fname fname evoked ave fif ave fif gz dcnl dcsp logger info reading dcsp s dcsp fname dcnl dcsp return list true dcnl dcsp if condition is none dcnl dcsp dcsp evoked node get evoked node fname dcnl dcsp dcsp condition range len evoked node dcnl dcsp elif not isinstance condition list dcnl dcsp dcsp condition condition dcnl dcsp dcsp return list false dcnl dcsp out evoked fname c kind kind proj proj allow maxshield allow maxshield verbose verbose apply baseline baseline for c in condition dcnl dcsp return out if return list else out0
def read evoked fname condition none kind average allow maxshield false dcsp if fname is none dcnl dcsp dcsp raise valueerror no dcsp evoked dcsp filename dcsp specified dcnl dcsp f tree fiff open fname dcnl dcsp with f as fid dcnl dcsp dcsp info meas read meas info fid tree clean bads true dcnl dcsp dcsp processed dir tree find meas fiff fiffb processed data dcnl dcsp dcsp if len processed 0 dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp processed dcsp data dcnl dcsp dcsp evoked node dir tree find meas fiff fiffb evoked dcnl dcsp dcsp if len evoked node 0 dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp evoked dcsp data dcnl dcsp dcsp if isinstance condition string types dcnl dcsp dcsp dcsp if kind not in aspect dict keys dcnl dcsp dcsp dcsp dcsp raise valueerror kind dcsp must dcsp be dcsp average dcsp or dcsp standard error dcnl dcsp dcsp dcsp comments aspect kinds t get entries fid evoked node allow maxshield dcnl dcsp dcsp dcsp goods np in1d comments condition np in1d aspect kinds aspect dictkind dcnl dcsp dcsp dcsp found cond np where goods 0 dcnl dcsp dcsp dcsp if len found cond 1 dcnl dcsp dcsp dcsp dcsp raise valueerror condition dcsp s dcsp s dcsp not dcsp found dcsp out dcsp of dcsp found dcsp datasets n dcsp dcsp s condition kind t dcnl dcsp dcsp dcsp condition found cond0 dcnl dcsp dcsp elif condition is none dcnl dcsp dcsp dcsp if len evoked node 1 dcnl dcsp dcsp dcsp dcsp conditions get entries fid evoked node allow maxshield dcnl dcsp dcsp dcsp dcsp raise typeerror evoked dcsp file dcsp has dcsp more dcsp than dcsp one dcsp conditions dcsp the dcsp condition dcsp parameters dcsp must dcsp be dcsp specified dcsp from n s conditions dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp condition 0 dcnl dcsp dcsp if condition len evoked node or condition < 0 dcnl dcsp dcsp dcsp raise valueerror data dcsp set dcsp selector dcsp out dcsp of dcsp range dcnl dcsp dcsp my evoked evoked nodecondition dcnl dcsp dcsp my aspect info maxshield get aspect my evoked allow maxshield dcnl dcsp dcsp nchan 0 dcnl dcsp dcsp sfreq 1 dcnl dcsp dcsp chs dcnl dcsp dcsp comment last first first time nsamp none dcnl dcsp dcsp for k in range my evoked nent dcnl dcsp dcsp dcsp my kind my evoked directory k kind dcnl dcsp dcsp dcsp pos my evoked directory k pos dcnl dcsp dcsp dcsp if my kind fiff fiff comment dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp comment tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff first sample dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp first int tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff last sample dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp last int tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff nchan dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp nchan int tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff sfreq dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp sfreq float tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff ch info dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp chs append tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff first time dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp first time float tag data dcnl dcsp dcsp dcsp elif my kind fiff fiff no samples dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp nsamp int tag data dcnl dcsp dcsp if comment is none dcnl dcsp dcsp dcsp comment no dcsp comment dcnl dcsp dcsp if nchan 0 dcnl dcsp dcsp dcsp if chs is none dcnl dcsp dcsp dcsp dcsp raise valueerror local dcsp channel dcsp information dcsp was dcsp not dcsp found dcsp when dcsp it dcsp was dcsp expected dcnl dcsp dcsp dcsp if len chs nchan dcnl dcsp dcsp dcsp dcsp raise valueerror number dcsp of dcsp channels dcsp and dcsp number dcsp of dcsp channel dcsp definitions dcsp are dcsp different dcnl dcsp dcsp dcsp info chs chs dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp found dcsp channel dcsp information dcsp in dcsp evoked dcsp data dcsp nchan dcsp dcsp d nchan dcnl dcsp dcsp dcsp if sfreq 0 dcnl dcsp dcsp dcsp dcsp info sfreq sfreq dcnl dcsp dcsp nave 1 dcnl dcsp dcsp epoch dcnl dcsp dcsp for k in range my aspect nent dcnl dcsp dcsp dcsp kind my aspect directory k kind dcnl dcsp dcsp dcsp pos my aspect directory k pos dcnl dcsp dcsp dcsp if kind fiff fiff comment dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp comment tag data dcnl dcsp dcsp dcsp elif kind fiff fiff aspect kind dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp aspect kind int tag data dcnl dcsp dcsp dcsp elif kind fiff fiff nave dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp nave int tag data dcnl dcsp dcsp dcsp elif kind fiff fiff epoch dcnl dcsp dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp dcsp epoch append tag dcnl dcsp dcsp nepoch len epoch dcnl dcsp dcsp if nepoch 1 and nepoch info nchan dcnl dcsp dcsp dcsp raise valueerror number dcsp of dcsp epoch dcsp tags dcsp is dcsp unreasonable dcsp nepoch dcsp dcsp d dcsp nchan dcsp dcsp d nepoch info nchan dcnl dcsp dcsp if nepoch 1 dcnl dcsp dcsp dcsp data epoch0 data dcnl dcsp dcsp dcsp if data shape1 1 and info nchan 1 dcnl dcsp dcsp dcsp dcsp data data t dcnl dcsp dcsp else dcnl dcsp dcsp dcsp data np concatenate e datanone for e in epoch axis 0 dcnl dcsp dcsp data data astype np float dcnl dcsp dcsp if first is not none dcnl dcsp dcsp dcsp nsamp last first + 1 dcnl dcsp dcsp elif first time is not none dcnl dcsp dcsp dcsp first int round first time info sfreq dcnl dcsp dcsp dcsp last first + nsamp dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise runtimeerror could dcsp not dcsp read dcsp time dcsp parameters dcnl dcsp dcsp if nsamp is not none and data shape1 nsamp dcnl dcsp dcsp dcsp raise valueerror incorrect dcsp number dcsp of dcsp samples dcsp d dcsp instead dcsp of dcsp dcsp d data shape1 nsamp dcnl dcsp dcsp nsamp data shape1 dcnl dcsp dcsp last first + nsamp 1 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp found dcsp the dcsp data dcsp of dcsp interest dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp t dcsp dcsp 10 2f dcsp dcsp 10 2f dcsp ms dcsp s 1000 first info sfreq 1000 last info sfreq comment dcnl dcsp dcsp if info comps is not none dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp d dcsp ctf dcsp compensation dcsp matrices dcsp available len info comps dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp nave dcsp dcsp d dcsp dcsp aspect dcsp type dcsp dcsp d nave aspect kind dcnl dcsp cals np array info chs k cal info chs k get scale 1 0 for k in range info nchan dcnl dcsp data cals np newaxis dcnl dcsp times np arange first last + 1 dtype np float info sfreq dcnl dcsp return info nave aspect kind first last comment times data
def write evokeds fname evoked dcsp write evokeds fname evoked
def write evokeds fname evoked check true dcsp if check dcnl dcsp dcsp check fname fname evoked ave fif ave fif gz dcnl dcsp if not isinstance evoked list dcnl dcsp dcsp evoked evoked dcnl dcsp with start file fname as fid dcnl dcsp dcsp start block fid fiff fiffb meas dcnl dcsp dcsp write id fid fiff fiff block id dcnl dcsp dcsp if evoked0 info meas id is not none dcnl dcsp dcsp dcsp write id fid fiff fiff parent block id evoked0 info meas id dcnl dcsp dcsp write meas info fid evoked0 info dcnl dcsp dcsp start block fid fiff fiffb processed data dcnl dcsp dcsp for e in evoked dcnl dcsp dcsp dcsp start block fid fiff fiffb evoked dcnl dcsp dcsp dcsp if e comment is not none and len e comment 0 dcnl dcsp dcsp dcsp dcsp write string fid fiff fiff comment e comment dcnl dcsp dcsp dcsp write int fid fiff fiff first sample e first dcnl dcsp dcsp dcsp write int fid fiff fiff last sample e last dcnl dcsp dcsp dcsp if e info get maxshield dcnl dcsp dcsp dcsp dcsp aspect fiff fiffb smsh aspect dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp aspect fiff fiffb aspect dcnl dcsp dcsp dcsp start block fid aspect dcnl dcsp dcsp dcsp write int fid fiff fiff aspect kind e aspect kind dcnl dcsp dcsp dcsp write int fid fiff fiff nave e nave dcnl dcsp dcsp dcsp decal np zeros e info nchan 1 dcnl dcsp dcsp dcsp for k in range e info nchan dcnl dcsp dcsp dcsp dcsp decalk 1 0 e info chs k cal e info chs k get scale 1 0 dcnl dcsp dcsp dcsp write float matrix fid fiff fiff epoch decal e data dcnl dcsp dcsp dcsp end block fid aspect dcnl dcsp dcsp dcsp end block fid fiff fiffb evoked dcnl dcsp dcsp end block fid fiff fiffb processed data dcnl dcsp dcsp end block fid fiff fiffb meas dcnl dcsp dcsp end file fid
def get peak data times tmin none tmax none mode abs dcsp modes abs neg pos dcnl dcsp if mode not in modes dcnl dcsp dcsp raise valueerror the dcsp mode dcsp parameter dcsp must dcsp be dcsp modes dcsp you dcsp gave dcsp me dcsp mode format modes dcsp or dcsp join modes mode mode dcnl dcsp if tmin is none dcnl dcsp dcsp tmin times0 dcnl dcsp if tmax is none dcnl dcsp dcsp tmax times 1 dcnl dcsp if tmin < times min dcnl dcsp dcsp raise valueerror the dcsp tmin dcsp value dcsp is dcsp out dcsp of dcsp bounds dcsp it dcsp must dcsp be dcsp within dcsp 0 dcsp and dcsp 1 format times min times max dcnl dcsp if tmax times max dcnl dcsp dcsp raise valueerror the dcsp tmin dcsp value dcsp is dcsp out dcsp of dcsp bounds dcsp it dcsp must dcsp be dcsp within dcsp 0 dcsp and dcsp 1 format times min times max dcnl dcsp if tmin tmax dcnl dcsp dcsp raise valueerror the dcsp tmin dcsp must dcsp be dcsp smaller dcsp than dcsp tmax dcnl dcsp time win times tmin times < tmax dcnl dcsp mask np ones like data astype np bool dcnl dcsp mask time win false dcnl dcsp maxfun np argmax dcnl dcsp if mode pos dcnl dcsp dcsp if not np any data 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp positive dcsp values dcsp encountered dcsp cannot dcsp operate dcsp in dcsp pos dcsp mode dcnl dcsp elif mode neg dcnl dcsp dcsp if not np any data < 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp negative dcsp values dcsp encountered dcsp cannot dcsp operate dcsp in dcsp neg dcsp mode dcnl dcsp dcsp maxfun np argmin dcnl dcsp masked index np ma array np abs data if mode abs else data mask mask dcnl dcsp max loc max time np unravel index maxfun masked index data shape dcnl dcsp return max loc max time
def dup coil set coils coord frame t dcsp if t is not none and coord frame t from dcnl dcsp dcsp raise runtimeerror transformation dcsp frame dcsp does dcsp not dcsp match dcsp the dcsp coil dcsp set dcnl dcsp coils deepcopy coils dcnl dcsp if t is not none dcnl dcsp dcsp coord frame t to dcnl dcsp dcsp for coil in coils dcnl dcsp dcsp dcsp for key in ex ey ez dcnl dcsp dcsp dcsp dcsp if key in coil dcnl dcsp dcsp dcsp dcsp dcsp coilkey apply trans t trans coilkey false dcnl dcsp dcsp dcsp coil r0 apply trans t trans coil r0 dcnl dcsp dcsp dcsp coil rmag apply trans t trans coil rmag dcnl dcsp dcsp dcsp coil cosmag apply trans t trans coil cosmag false dcnl dcsp dcsp dcsp coil coord frame t to dcnl dcsp return coils coord frame
def check coil frame coils coord frame bem dcsp if coord frame fiff fiffv coord mri dcnl dcsp dcsp if coord frame fiff fiffv coord head dcnl dcsp dcsp dcsp coils coord frame dup coil set coils coord frame bem head mri t dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise runtimeerror bad dcsp coil dcsp coordinate dcsp frame dcsp s coord frame dcnl dcsp return coils coord frame
def lin field coeff surf mult rmags cosmags ws bins n jobs dcsp parallel p fun parallel func do lin field coeff n jobs dcnl dcsp nas np array split dcnl dcsp coeffs parallel p fun surf rr t tn ta rmags cosmags ws bins for t tn ta in zip nas surf tris n jobs nas surf tri nn n jobs nas surf tri area n jobs dcnl dcsp return mult np sum coeffs axis 0
def do lin field coeff bem rr tris tn ta rmags cosmags ws bins dcsp coeff np zeros bins 1 + 1 len bem rr dcnl dcsp for tri tri nn tri area in zip tris tn ta dcnl dcsp dcsp tri rr bem rrtri dcnl dcsp dcsp zz dcnl dcsp dcsp for trr in tri rr dcnl dcsp dcsp dcsp diff rmags trr dcnl dcsp dcsp dcsp dl np sum diff diff axis 1 dcnl dcsp dcsp dcsp c fast cross 3d diff tri nnnp newaxis dcnl dcsp dcsp dcsp x tri area np sum c cosmags axis 1 3 0 dl np sqrt dl dcnl dcsp dcsp dcsp zz + np bincount bins weights x ws minlength bins 1 + 1 dcnl dcsp dcsp coeff tri + np array zz t dcnl dcsp return coeff
def concatenate coils coils dcsp rmags np concatenate coil rmag for coil in coils dcnl dcsp cosmags np concatenate coil cosmag for coil in coils dcnl dcsp ws np concatenate coil w for coil in coils dcnl dcsp n int np array len coil rmag for coil in coils dcnl dcsp if n int 1 0 dcnl dcsp dcsp raise runtimeerror not dcsp supported dcnl dcsp bins np repeat np arange len n int n int dcnl dcsp return rmags cosmags ws bins
def bem specify coils bem coils coord frame mults n jobs dcsp coils coord frame check coil frame coils coord frame bem dcnl dcsp rmags cosmags ws bins concatenate coils coils dcnl dcsp lens np cumsum np r 0 len s rr for s in bem surfs dcnl dcsp sol np zeros bins 1 + 1 bem solution shape1 dcnl dcsp lims np concatenate np arange 0 sol shape0 100 sol shape0 dcnl dcsp for o1 o2 surf mult in zip lens 1 lens1 bem surfs bem field mult dcnl dcsp dcsp coeff lin field coeff surf mult rmags cosmags ws bins n jobs dcnl dcsp dcsp for start stop in zip lims 1 lims1 dcnl dcsp dcsp dcsp solstart stop + np dot coeffstart stop bem solution o1 o2 dcnl dcsp sol mults dcnl dcsp return sol
def bem specify els bem els mults dcsp sol np zeros len els bem solution shape1 dcnl dcsp scalp bem surfs 0 dcnl dcsp rrs np concatenate apply trans bem head mri t trans el rmag for el in els axis 0 dcnl dcsp ws np concatenate el w for el in els dcnl dcsp tri weights tri idx project onto surface rrs scalp dcnl dcsp tri weights ws dcnl dcsp weights np einsum ij jik jk tri weights bem solution scalp tris tri idx dcnl dcsp edges np concatenate 0 np cumsum len el w for el in els dcnl dcsp for ii start stop in enumerate zip edges 1 edges1 dcnl dcsp dcsp solii weightsstart stop sum 0 dcnl dcsp sol mults dcnl dcsp return sol
def make ctf comp coils info coils dcsp logger info setting dcsp up dcsp compensation dcsp data dcnl dcsp comp num get current comp info dcnl dcsp if comp num is none or comp num 0 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp no dcsp compensation dcsp set dcsp nothing dcsp more dcsp to dcsp do dcnl dcsp dcsp return none dcnl dcsp n comp ch sum c kind fiff fiffv meg ch for c in info chs dcnl dcsp logger info dcsp dcsp dcsp dcsp d dcsp out dcsp of dcsp d dcsp channels dcsp have dcsp the dcsp compensation dcsp set n comp ch len coils dcnl dcsp compensator make compensator info 0 comp num true dcnl dcsp logger info dcsp dcsp dcsp dcsp desired dcsp compensation dcsp data dcsp s dcsp found comp num dcnl dcsp logger info dcsp dcsp dcsp dcsp all dcsp compensation dcsp channels dcsp found dcnl dcsp logger info dcsp dcsp dcsp dcsp preselector dcsp created dcnl dcsp logger info dcsp dcsp dcsp dcsp compensation dcsp data dcsp matrix dcsp created dcnl dcsp logger info dcsp dcsp dcsp dcsp postselector dcsp created dcnl dcsp return compensator
def bem inf pots mri rr bem rr mri q none dcsp diff bem rr tnp newaxis mri rr np newaxis dcnl dcsp diff norm np sum diff diff axis 1 dcnl dcsp diff norm np sqrt diff norm dcnl dcsp diff norm diff norm 0 1 dcnl dcsp if mri q is none dcnl dcsp dcsp return diff diff norm np newaxis dcnl dcsp else dcnl dcsp dcsp return np einsum ijk mj imk diff mri q diff norm np newaxis
def bem inf fields rr rmag cosmag dcsp diff rmag tnp newaxis rr np newaxis dcnl dcsp diff norm np sum diff diff axis 1 dcnl dcsp diff norm np sqrt diff norm dcnl dcsp diff norm diff norm 0 1 dcnl dcsp x np array diff 1 cosmag 2 diff 2 cosmag 1 diff 2 cosmag 0 diff 0 cosmag 2 diff 0 cosmag 1 diff 1 cosmag 0 dcnl dcsp return np rollaxis x diff norm 1
def bem pot or field rr mri rr mri q coils solution bem rr n jobs coil type dcsp parallel p fun parallel func do inf pots n jobs dcnl dcsp nas np array split dcnl dcsp b np sum parallel p fun mri rr sr copy mri q sol copy for sr sol in zip nas bem rr n jobs nas solution t n jobs axis 0 dcnl dcsp if coil type meg dcnl dcsp dcsp parallel p fun parallel func do prim curr n jobs dcnl dcsp dcsp pcc np concatenate parallel p fun rr c for c in nas coils n jobs axis 1 dcnl dcsp dcsp b + pcc dcnl dcsp dcsp b mag factor dcnl dcsp return b
def do prim curr rr coils dcsp pc np empty len rr 3 len coils dcnl dcsp for ci c in enumerate coils dcnl dcsp dcsp pc ci np sum c w bem inf fields rr c rmag c cosmag 2 ravel dcnl dcsp return pc
def do inf pots mri rr bem rr mri q sol dcsp bounds np concatenate np arange 0 len mri rr 200 len mri rr dcnl dcsp b np empty len mri rr 3 sol shape1 dcnl dcsp for bi in range len bounds 1 dcnl dcsp dcsp v0s bem inf pots mri rrboundsbi bounds bi + 1 bem rr mri q dcnl dcsp dcsp v0s shape v0s shape0 3 v0s shape2 dcnl dcsp dcsp b 3 boundsbi 3 bounds bi + 1 np dot v0s sol dcnl dcsp return b
def sphere pot or field rr mri rr mri q coils sphere bem rr n jobs coil type dcsp fun eeg spherepot coil if coil type eeg else sphere field dcnl dcsp parallel p fun parallel func fun n jobs dcnl dcsp b np concatenate parallel p fun r coils sphere for r in np array split rr n jobs dcnl dcsp return b
def sphere field rrs coils sphere dcsp rmags cosmags ws bins concatenate coils coils dcnl dcsp rrs rrs sphere r0 dcnl dcsp b np zeros 3 len rrs len coils dcnl dcsp for ri rr in enumerate rrs dcnl dcsp dcsp if np sqrt np dot rr rr < 1e10 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp this poss rmags sphere r0 dcnl dcsp dcsp a vec this poss rr dcnl dcsp dcsp a np sqrt np sum a vec a vec axis 1 dcnl dcsp dcsp r np sqrt np sum this poss this poss axis 1 dcnl dcsp dcsp rr0 np sum this poss rr axis 1 dcnl dcsp dcsp ar r r rr0 dcnl dcsp dcsp ar0 ar a dcnl dcsp dcsp f a r a + ar dcnl dcsp dcsp gr a a r + ar0 + 2 0 a + r dcnl dcsp dcsp g0 a + 2 r + ar0 dcnl dcsp dcsp re np sum this poss cosmags axis 1 dcnl dcsp dcsp r0e np sum rr cosmags axis 1 dcnl dcsp dcsp g g0 r0e gr re f f dcnl dcsp dcsp good a 0 | r 0 | a r + 1 1e05 dcnl dcsp dcsp v1 fast cross 3d rrnp newaxis cosmags dcnl dcsp dcsp v2 fast cross 3d rrnp newaxis this poss dcnl dcsp dcsp xx good ws np newaxis v1 f np newaxis + v2 g np newaxis dcnl dcsp dcsp zz np array np bincount bins x bins 1 + 1 for x in xx t dcnl dcsp dcsp b 3 ri 3 ri + 3 zz dcnl dcsp b mag factor dcnl dcsp return b
def eeg spherepot coil rrs coils sphere dcsp rmags cosmags ws bins concatenate coils coils dcnl dcsp rrs rrs sphere r0 dcnl dcsp b np zeros 3 len rrs len coils dcnl dcsp for ri rr in enumerate rrs dcnl dcsp dcsp if np sqrt np dot rr rr sphere layers 0 rad dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp vval one np zeros len rmags 3 dcnl dcsp dcsp for eq in range sphere nfit dcnl dcsp dcsp dcsp rd sphere mu eq rr dcnl dcsp dcsp dcsp rd2 np sum rd rd dcnl dcsp dcsp dcsp rd2 inv 1 0 rd2 dcnl dcsp dcsp dcsp this pos rmags sphere r0 dcnl dcsp dcsp dcsp a vec this pos rd dcnl dcsp dcsp dcsp a np sqrt np sum a vec a vec axis 1 dcnl dcsp dcsp dcsp a3 2 0 a a a dcnl dcsp dcsp dcsp r2 np sum this pos this pos axis 1 dcnl dcsp dcsp dcsp r np sqrt r2 dcnl dcsp dcsp dcsp rrd np sum this pos rd axis 1 dcnl dcsp dcsp dcsp ra r2 rrd dcnl dcsp dcsp dcsp rda rrd rd2 dcnl dcsp dcsp dcsp f a r a + ra dcnl dcsp dcsp dcsp c1 a3 rda + 1 0 a 1 0 r dcnl dcsp dcsp dcsp c2 a3 + a + r r f dcnl dcsp dcsp dcsp m1 c1 c2 rrd dcnl dcsp dcsp dcsp m2 c2 rd2 dcnl dcsp dcsp dcsp vval one + sphere lambda eq rd2 inv m1 np newaxis rd + m2 np newaxis this pos dcnl dcsp dcsp dcsp xx vval one ws np newaxis dcnl dcsp dcsp dcsp zz np array np bincount bins x bins 1 + 1 for x in xx t dcnl dcsp dcsp dcsp b 3 ri 3 ri + 3 zz dcnl dcsp b 0 25 np pi dcnl dcsp return b
def magnetic dipole field vec rrs coils dcsp if isinstance coils tuple dcnl dcsp dcsp rmags cosmags ws bins coils dcnl dcsp else dcnl dcsp dcsp rmags cosmags ws bins concatenate coils coils dcnl dcsp del coils dcnl dcsp fwd np empty 3 len rrs bins 1 + 1 dcnl dcsp for ri rr in enumerate rrs dcnl dcsp dcsp diff rmags rr dcnl dcsp dcsp dist2 np sum diff diff axis 1 np newaxis dcnl dcsp dcsp dist np sqrt dist2 dcnl dcsp dcsp if dist < 1e05 any dcnl dcsp dcsp dcsp raise runtimeerror coil dcsp too dcsp close dcsp dist dcsp dcsp g dcsp m dist min dcnl dcsp dcsp sum ws np newaxis 3 diff np sum diff cosmags axis 1 np newaxis dist2 cosmags dist2 dist2 dist dcnl dcsp dcsp for ii in range 3 dcnl dcsp dcsp dcsp fwd 3 ri + ii np bincount bins sum ii bins 1 + 1 dcnl dcsp fwd 1e07 dcnl dcsp return fwd
verbose dcnl def prep field computation rr bem fwd data n jobs verbose none dcsp bem rr mults mri q head mri t none dcnl dcsp if not bem is sphere dcnl dcsp dcsp if bem bem method fiff fwd bem linear coll dcnl dcsp dcsp dcsp raise runtimeerror only dcsp linear dcsp collocation dcsp supported dcnl dcsp dcsp mults np repeat bem source mult 4 0 np pi len s rr for s in bem surfs np newaxis dcnl dcsp dcsp bem rr np concatenate s rr for s in bem surfs dcnl dcsp dcsp head mri t bem head mri t dcnl dcsp dcsp mri q apply trans bem head mri t trans np eye 3 false dcnl dcsp if len set fwd data coil types len fwd data coil types dcnl dcsp dcsp raise runtimeerror nonunique dcsp sensor dcsp types dcsp found dcnl dcsp compensators solutions csolutions dcnl dcsp for coil type coils ccoils info in zip fwd data coil types fwd data coils list fwd data ccoils list fwd data infos dcnl dcsp dcsp compensator solution csolution none dcnl dcsp dcsp if len coils 0 dcnl dcsp dcsp dcsp if coil type meg dcnl dcsp dcsp dcsp dcsp compensator make ctf comp coils info coils dcnl dcsp dcsp dcsp if not bem is sphere dcnl dcsp dcsp dcsp dcsp if coil type meg dcnl dcsp dcsp dcsp dcsp dcsp start composing dcsp the dcsp field dcsp computation dcsp matrix dcnl dcsp dcsp dcsp dcsp dcsp logger info n + start + dcnl dcsp dcsp dcsp dcsp dcsp cf fiff fiffv coord head dcnl dcsp dcsp dcsp dcsp dcsp solution bem specify coils bem coils cf mults n jobs dcnl dcsp dcsp dcsp dcsp dcsp if compensator is not none dcnl dcsp dcsp dcsp dcsp dcsp dcsp logger info start + dcsp compensation dcsp coils dcnl dcsp dcsp dcsp dcsp dcsp dcsp csolution bem specify coils bem ccoils cf mults n jobs dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp solution bem specify els bem coils mults dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp solution csolution bem dcnl dcsp dcsp dcsp dcsp if coil type eeg dcnl dcsp dcsp dcsp dcsp dcsp logger info using dcsp the dcsp equivalent dcsp source dcsp approach dcsp in dcsp the dcsp homogeneous dcsp sphere dcsp for dcsp eeg dcnl dcsp dcsp compensators append compensator dcnl dcsp dcsp solutions append solution dcnl dcsp dcsp csolutions append csolution dcnl dcsp fun sphere pot or field if bem is sphere else bem pot or field dcnl dcsp fwd data update dict bem rr bem rr mri q mri q head mri t head mri t compensators compensators solutions solutions csolutions csolutions fun fun
verbose dcnl def compute forwards meeg rr fd n jobs verbose none dcsp n jobs max min n jobs len rr 1 dcnl dcsp bs list dcnl dcsp mri rr none dcnl dcsp if fd head mri t is not none dcnl dcsp dcsp mri rr apply trans fd head mri t trans rr dcnl dcsp mri q bem rr fun fd mri q fd bem rr fd fun dcnl dcsp for ci in range len fd coils list dcnl dcsp dcsp coils ccoils fd coils list ci fd ccoils list ci dcnl dcsp dcsp if len coils 0 dcnl dcsp dcsp dcsp bs append np zeros 3 len rr 0 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp coil type compensator fd coil types ci fd compensators ci dcnl dcsp dcsp solution csolution fd solutions ci fd csolutions ci dcnl dcsp dcsp info fd infos ci dcnl dcsp dcsp logger info computing dcsp s dcsp at dcsp d dcsp source dcsp location s dcsp free dcsp orientations coil type upper len rr pl rr dcnl dcsp dcsp b fun rr mri rr mri q coils solution bem rr n jobs coil type dcnl dcsp dcsp if compensator is not none dcnl dcsp dcsp dcsp work fun rr mri rr mri q ccoils csolution bem rr n jobs coil type dcnl dcsp dcsp dcsp both np zeros work shape0 b shape1 + work shape1 dcnl dcsp dcsp dcsp picks pick types info meg true ref meg false dcnl dcsp dcsp dcsp both picks b dcnl dcsp dcsp dcsp picks pick types info meg false ref meg true dcnl dcsp dcsp dcsp both picks work dcnl dcsp dcsp dcsp b np dot both compensator t dcnl dcsp dcsp bs append b dcnl dcsp return bs
verbose dcnl def compute forwards rr bem coils list ccoils list infos coil types n jobs verbose none dcsp fwd data dict coils list coils list ccoils list ccoils list infos infos coil types coil types dcnl dcsp prep field computation rr bem fwd data n jobs dcnl dcsp bs compute forwards meeg rr fwd data n jobs dcnl dcsp return bs
def compare forwards fwd fwd py n sensors n src meg rtol 0 0001 meg atol 1e09 eeg rtol 0 001 eeg atol 0 001 dcsp assert equal len fwd src len fwd py src dcnl dcsp compare source spaces fwd src fwd py src mode approx dcnl dcsp for surf ori force fixed in product false true false true dcnl dcsp dcsp fwd convert forward solution fwd surf ori force fixed copy true dcnl dcsp dcsp fwd py convert forward solution fwd py surf ori force fixed copy true dcnl dcsp dcsp check src n src 3 if force fixed else n src dcnl dcsp dcsp for key in nchan source rr source ori surf ori coord frame nsource dcnl dcsp dcsp dcsp assert allclose fwd pykey fwdkey rtol 0 0001 atol 1e07 err msg key dcnl dcsp dcsp if surf ori and not force fixed dcnl dcsp dcsp dcsp ori sl slice 2 none 3 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ori sl slice none dcnl dcsp dcsp assert allclose fwd py source nn ori sl fwd source nn ori sl rtol 0 0001 atol 1e06 dcnl dcsp dcsp assert allclose fwd py mri head t trans fwd mri head t trans rtol 1e05 atol 1e08 dcnl dcsp dcsp assert equal fwd py sol data shape n sensors check src dcnl dcsp dcsp assert equal len fwd sol row names n sensors dcnl dcsp dcsp assert equal len fwd py sol row names n sensors dcnl dcsp dcsp assert allclose fwd sol data 306 ori sl fwd py sol data 306 ori sl rtol meg rtol atol meg atol err msg meg dcsp mismatch dcnl dcsp dcsp if fwd sol data shape0 306 dcnl dcsp dcsp dcsp assert allclose fwd sol data 306 ori sl fwd py sol data 306 ori sl rtol eeg rtol atol eeg atol err msg eeg dcsp mismatch
def test magnetic dipole dcsp trans transform mri head dcnl dcsp info read info fname raw dcnl dcsp picks pick types info meg true eeg false exclude dcnl dcsp info pick info info picks 12 dcnl dcsp coils create meg coils info chs normal trans dcnl dcsp r0 np array 0 0 13 0 6 0 dcnl dcsp for ch coil in zip info chs coils dcnl dcsp dcsp rr ch loc 3 + r0 2 0 dcnl dcsp dcsp far fwd magnetic dipole field vec r0np newaxis coil dcnl dcsp dcsp near fwd magnetic dipole field vec rrnp newaxis coil dcnl dcsp dcsp ratio 8 0 if ch ch name 1 1 else 16 0 dcnl dcsp dcsp assert allclose np median near fwd far fwd ratio atol 0 1
testing requires testing data dcnl requires mne dcnl def test make forward solution kit dcsp kit dir op join op dirname file io kit tests data dcnl dcsp sqd path op join kit dir test sqd dcnl dcsp mrk path op join kit dir test mrk sqd dcnl dcsp elp path op join kit dir test elp txt dcnl dcsp hsp path op join kit dir test hsp txt dcnl dcsp trans path op join kit dir transsample fif dcnl dcsp fname kit raw op join kit dir test bin raw fif dcnl dcsp bti dir op join op dirname file io bti tests data dcnl dcsp bti pdf op join bti dir test pdf linux dcnl dcsp bti config op join bti dir test config linux dcnl dcsp bti hs op join bti dir test hs linux dcnl dcsp fname bti raw op join bti dir exported4d linux raw fif dcnl dcsp fname ctf raw op join op dirname file io tests data test ctf comp raw fif dcnl dcsp temp dir tempdir dcnl dcsp fname src small op join temp dir sampleoct2src fif dcnl dcsp src setup source space sample oct2 subjects dir subjects dir add dist false dcnl dcsp write source spaces fname src small src dcnl dcsp n src 108 dcnl dcsp fwd do forward solution sample fname kit raw src fname src small bem fname bem meg mri trans path eeg false meg true subjects dir subjects dir dcnl dcsp assert true isinstance fwd forward dcnl dcsp fwd py make forward solution fname kit raw trans path src fname bem meg eeg false meg true dcnl dcsp compare forwards fwd fwd py 157 n src dcnl dcsp assert true isinstance fwd py forward dcnl dcsp raw py read raw kit sqd path mrk path elp path hsp path dcnl dcsp assert raises notimplementederror make forward solution raw py info src src eeg false meg true bem fname bem meg trans trans path dcnl dcsp meg only info pick info raw py info pick types raw py info meg true eeg false dcnl dcsp fwd py make forward solution meg only info src src meg true eeg true bem fname bem meg trans trans path ignore ref true dcnl dcsp compare forwards fwd fwd py 157 n src meg rtol 0 001 meg atol 1e07 dcnl dcsp fwd do forward solution sample fname bti raw src fname src small bem fname bem meg mri trans path eeg false meg true subjects dir subjects dir dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw py read raw bti bti pdf bti config bti hs preload false dcnl dcsp fwd py make forward solution raw py info src src eeg false meg true bem fname bem meg trans trans path dcnl dcsp compare forwards fwd fwd py 248 n src dcnl dcsp fwd py make forward solution fname ctf raw fname trans src fname bem meg eeg false meg true dcnl dcsp fwd do forward solution sample fname ctf raw mri fname trans src fname src small bem fname bem meg eeg false meg true subjects dir subjects dir dcnl dcsp compare forwards fwd fwd py 274 n src dcnl dcsp ctf raw read raw fif fname ctf raw dcnl dcsp ctf raw apply gradient compensation 2 dcnl dcsp fwd py make forward solution ctf raw info fname trans src fname bem meg eeg false meg true dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp fwd do forward solution sample ctf raw mri fname trans src fname src small bem fname bem meg eeg false meg true subjects dir subjects dir dcnl dcsp compare forwards fwd fwd py 274 n src
slow test dcnl testing requires testing data dcnl def test make forward solution dcsp fwd py make forward solution fname raw fname trans fname src fname bem mindist 5 0 eeg true meg true n jobs 1 dcnl dcsp assert true isinstance fwd py forward dcnl dcsp fwd read forward solution fname meeg dcnl dcsp assert true isinstance fwd forward dcnl dcsp compare forwards fwd fwd py 366 1494 meg rtol 0 001
testing requires testing data dcnl requires mne dcnl def test make forward solution sphere dcsp temp dir tempdir dcnl dcsp fname src small op join temp dir sampleoct2src fif dcnl dcsp src setup source space sample oct2 subjects dir subjects dir add dist false dcnl dcsp write source spaces fname src small src dcnl dcsp out name op join temp dir tmpfwd fif dcnl dcsp run subprocess mne forward solution meg eeg meas fname raw src fname src small mri fname trans fwd out name dcnl dcsp fwd read forward solution out name dcnl dcsp sphere make sphere model verbose true dcnl dcsp fwd py make forward solution fname raw fname trans src sphere meg true eeg true verbose true dcnl dcsp compare forwards fwd fwd py 366 108 meg rtol 0 5 meg atol 1e06 eeg rtol 0 5 eeg atol 0 5 dcnl dcsp for meg eeg in zip true false false true dcnl dcsp dcsp fwd pick types forward fwd meg meg eeg eeg dcnl dcsp dcsp fwd py pick types forward fwd meg meg eeg eeg dcnl dcsp dcsp assert allclose np corrcoef fwd sol data ravel fwd py sol data ravel 0 1 1 0 rtol 0 001
slow test dcnl testing requires testing data dcnl requires nibabel false dcnl def test forward mixed source space dcsp temp dir tempdir dcnl dcsp surf read source spaces fname src dcnl dcsp label names get volume labels from aseg fname aseg dcnl dcsp vol labels label namesint np random rand len label names for in range 2 dcnl dcsp vol1 setup volume source space sample pos 20 0 mri fname aseg volume label vol labels0 add interpolator false dcnl dcsp vol2 setup volume source space sample pos 20 0 mri fname aseg volume label vol labels1 add interpolator false dcnl dcsp src surf + vol1 + vol2 dcnl dcsp fwd make forward solution fname raw fname trans src fname bem none dcnl dcsp assert true repr fwd dcnl dcsp src from fwd fwd src dcnl dcsp coord frames np array s coord frame for s in src from fwd dcnl dcsp assert true coord frames fiff fiffv coord head all dcnl dcsp fname img op join temp dir tempimage mgz dcnl dcsp assert raises valueerror src from fwd export volume fname img mri resolution true trans none dcnl dcsp vox mri t vol10 vox mri t dcnl dcsp assert raises valueerror src from fwd export volume fname img mri resolution true trans vox mri t
slow test dcnl testing requires testing data dcnl def test make forward dipole dcsp rng np random randomstate 0 dcnl dcsp evoked read evokeds fname evo 0 dcnl dcsp cov read cov fname cov dcnl dcsp dip c read dipole fname dip dcnl dcsp picks pick types evoked info meg mag eeg false dcnl dcsp evoked pick channels evoked ch namesp for p in picks dcnl dcsp info evoked info dcnl dcsp n test dipoles 3 dcnl dcsp dipsel np sort rng permutation np arange len dip c n test dipoles dcnl dcsp dip test dipole times dip c timesdipsel pos dip c posdipsel amplitude dip c amplitudedipsel ori dip c oridipsel gof dip c gofdipsel dcnl dcsp sphere make sphere model head radius 0 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp fwd stc make forward dipole dip test sphere info trans fname trans dcnl dcsp dcsp assert true issubclass w 1 category runtimewarning dcnl dcsp assert true isinstance stc list dcnl dcsp for nd in range n test dipoles dcnl dcsp dcsp assert true isinstance stcnd volsourceestimate dcnl dcsp times pos amplitude ori gof dcnl dcsp nave 100 dcnl dcsp for s in stc dcnl dcsp dcsp evo test simulate evoked fwd s info cov nave nave random state rng dcnl dcsp dcsp dfit resid fit dipole evo test cov sphere none dcnl dcsp dcsp times + dfit times tolist dcnl dcsp dcsp pos + dfit pos tolist dcnl dcsp dcsp amplitude + dfit amplitude tolist dcnl dcsp dcsp ori + dfit ori tolist dcnl dcsp dcsp gof + dfit gof tolist dcnl dcsp dip fit dipole times pos amplitude ori gof dcnl dcsp diff dip test pos dip fit pos dcnl dcsp corr np corrcoef dip test pos ravel dip fit pos ravel 0 1 dcnl dcsp dist np sqrt np mean np sum diff diff axis 1 dcnl dcsp gc dist 180 np pi np mean np arccos np sum dip test ori dip fit ori axis 1 dcnl dcsp amp err np sqrt np mean dip test amplitude dip fit amplitude 2 dcnl dcsp assert allclose dip fit pos dip test pos rtol 0 atol 0 01 err msg position dcsp mismatch dcnl dcsp assert true dist < 0 01 dist dcsp s dist dcnl dcsp assert true corr 1 0 01 corr dcsp s corr dcnl dcsp assert true gc dist < 20 gc dist dcsp s gc dist dcnl dcsp assert true amp err < 1e08 amp err dcsp s amp err dcnl dcsp dip outside dipole times 0 0 0 001 pos 0 0 0 0 1 0 0 0 0 0 0 04 amplitude 1e07 1e07 ori 1 0 0 0 0 0 1 0 0 0 0 0 gof 1 dcnl dcsp assert raises valueerror make forward dipole dip outside fname bem info fname trans dcnl dcsp times 0 0 0 0 0 0 0 001 0 001 0 002 dcnl dcsp pos np random rand 6 3 0 02 + np array 0 0 0 0 0 04 np newaxis dcnl dcsp amplitude np random rand 6 1e07 dcnl dcsp ori np eye 6 3 + np eye 6 3 3 dcnl dcsp gof np arange len times len times dcnl dcsp dip even samp dipole times pos amplitude ori gof dcnl dcsp fwd stc make forward dipole dip even samp sphere info trans fname trans dcnl dcsp assert true isinstance volsourceestimate dcnl dcsp assert allclose stc times np arange 0 0 0 003 0 001
def test legendre val dcsp rng np random randomstate 0 dcnl dcsp xs np linspace 1 0 1 0 1000 dcnl dcsp n terms 100 dcnl dcsp vals np legendre legvander xs n terms 1 dcnl dcsp for nc interp in zip 100 50 nearest linear dcnl dcsp dcsp lut n fact get legen table eeg n coeff nc force calc true dcnl dcsp dcsp lut fun interp1d np linspace 1 1 lut shape0 lut interp axis 0 dcnl dcsp dcsp vals i lut fun xs dcnl dcsp dcsp assert allclose vals np 1 vals i shape1 + 1 vals i rtol 0 01 atol 0 005 dcnl dcsp dcsp ctheta rng rand 20 30 2 0 1 0 dcnl dcsp dcsp beta rng rand 20 30 0 8 dcnl dcsp dcsp c1 comp sum eeg beta flatten ctheta flatten lut fun n fact dcnl dcsp dcsp c1 shape beta shape dcnl dcsp dcsp n np arange 1 n terms dtype float np newaxis np newaxis dcnl dcsp dcsp coeffs np zeros n terms + beta shape dcnl dcsp dcsp coeffs1 np cumprod beta n terms 1 axis 0 2 0 n + 1 0 2 0 n + 1 0 n dcnl dcsp dcsp c2 np empty 20 30 dcnl dcsp dcsp for ci1 in range 20 dcnl dcsp dcsp dcsp for ci2 in range 30 dcnl dcsp dcsp dcsp dcsp c2 ci1 ci2 legendre legval ctheta ci1 ci2 coeffs ci1 ci2 dcnl dcsp dcsp assert allclose c1 c2 0 01 0 001 dcnl dcsp ctheta rng rand 20 30 2 0 1 0 dcnl dcsp beta rng rand 20 30 0 8 dcnl dcsp lut n fact get legen table meg n coeff 10 force calc true dcnl dcsp fun interp1d np linspace 1 1 lut shape0 lut nearest axis 0 dcnl dcsp coeffs comp sums meg beta ctheta fun n fact false dcnl dcsp lut n fact get legen table meg n coeff 20 force calc true dcnl dcsp fun interp1d np linspace 1 1 lut shape0 lut linear axis 0 dcnl dcsp coeffs comp sums meg beta ctheta fun n fact false
def test legendre table dcsp n 10 dcnl dcsp for ch type in eeg meg dcnl dcsp dcsp lut1 n fact1 get legen table ch type n coeff 25 force calc true dcnl dcsp dcsp lut1 lut1 n 1 copy dcnl dcsp dcsp n fact1 n fact1 n 1 copy dcnl dcsp dcsp lut2 n fact2 get legen table ch type n coeff n force calc true dcnl dcsp dcsp assert allclose lut1 lut2 dcnl dcsp dcsp assert allclose n fact1 n fact2
testing requires testing data dcnl def test make field map eeg dcsp evoked read evokeds evoked fname condition left dcsp auditory dcnl dcsp evoked info bads meg dcsp 2443 eeg dcsp 053 dcnl dcsp surf get head surf sample subjects dir subjects dir dcnl dcsp assert raises valueerror make surface mapping evoked info surf eeg dcnl dcsp evoked pick types meg false eeg true dcnl dcsp fmd make field map evoked trans fname subject sample subjects dir subjects dir dcnl dcsp assert raises runtimeerror make field map evoked none subject sample subjects dir subjects dir dcnl dcsp fmd make field map evoked trans fname subject sample subjects dir subjects dir dcnl dcsp assert true len fmd 1 dcnl dcsp assert array equal fmd0 data shape 642 59 dcnl dcsp assert true len fmd0 ch names 59
testing requires testing data dcnl slow test dcnl def test make field map meg dcsp evoked read evokeds evoked fname condition left dcsp auditory dcnl dcsp info evoked info dcnl dcsp surf get meg helmet surf info dcnl dcsp info bads info ch names 200 dcnl dcsp assert raises valueerror make surface mapping info surf foo dcnl dcsp assert raises valueerror make surface mapping info surf meg mode foo dcnl dcsp evoked eeg evoked copy pick types meg false eeg true dcnl dcsp assert raises runtimeerror make surface mapping evoked eeg info surf meg dcnl dcsp nn surf nn dcnl dcsp del surf nn dcnl dcsp assert raises keyerror make surface mapping info surf meg dcnl dcsp surf nn nn dcnl dcsp cf surf coord frame dcnl dcsp del surf coord frame dcnl dcsp assert raises keyerror make surface mapping info surf meg dcnl dcsp surf coord frame cf dcnl dcsp evoked pick types meg true eeg false dcnl dcsp evoked info normalize proj dcnl dcsp fmd make field map evoked none subject sample subjects dir subjects dir dcnl dcsp assert true len fmd 1 dcnl dcsp assert array equal fmd0 data shape 304 106 dcnl dcsp assert true len fmd0 ch names 106 dcnl dcsp assert raises valueerror make field map evoked ch type foobar dcnl dcsp evoked pick types meg true eeg false dcnl dcsp evoked info normalize proj dcnl dcsp fmd make field map evoked trans fname meg surf head subject sample subjects dir subjects dir dcnl dcsp assert true len fmd 1 dcnl dcsp assert array equal fmd0 data shape 642 106 dcnl dcsp assert true len fmd0 ch names 106 dcnl dcsp assert raises valueerror make field map evoked meg surf foobar subjects dir subjects dir trans trans fname
testing requires testing data dcnl def test make field map meeg dcsp evoked read evokeds evoked fname baseline 0 2 0 0 0 dcnl dcsp picks pick types evoked info meg true eeg true dcnl dcsp picks picks 10 dcnl dcsp evoked pick channels evoked ch namesp for p in picks dcnl dcsp evoked info normalize proj dcnl dcsp maps make field map evoked trans fname subject sample subjects dir subjects dir n jobs 1 dcnl dcsp assert equal maps0 data shape 642 6 dcnl dcsp assert equal maps1 data shape 304 31 dcnl dcsp for map in maps dcnl dcsp dcsp assert true 0 5 < map data max < 2 dcnl dcsp dcsp assert true 2 < map data min < 0 5 dcnl dcsp assert allclose np sqrt np sum maps0 data 2 16 6088 atol 0 001 rtol 0 001 dcnl dcsp assert allclose np sqrt np sum maps1 data 2 20 1245 atol 0 001 rtol 0 001
def setup args info dcsp coils create meg coils info chs normal info dev head t dcnl dcsp int rad noise lut fun n fact setup dots fast coils meg dcnl dcsp my origin np array 0 0 0 0 0 04 dcnl dcsp args dict dict intrad int rad volume false coils1 coils r0 my origin ch type meg lut lut fun n fact n fact dcnl dcsp return args dict
testing requires testing data dcnl def test as meg type evoked dcsp evoked read evokeds evoked fname condition left dcsp auditory dcnl dcsp assert raises valueerror evoked as type meg dcnl dcsp assert raises valueerror evoked copy pick types meg grad as type meg dcnl dcsp ch names evoked info ch names dcnl dcsp virt evoked evoked copy pick channels ch names ch names 10 1 dcnl dcsp virt evoked info normalize proj dcnl dcsp virt evoked virt evoked as type mag dcnl dcsp assert true all virtual in ch for ch in virt evoked info ch names dcnl dcsp evoked from evoked copy pick channels ch names ch names2 10 3 dcnl dcsp evoked to evoked copy pick channels ch names ch names0 10 3 dcnl dcsp info from info to evoked from info evoked to info dcnl dcsp args1 args2 setup args info from setup args info to dcnl dcsp args1 update coils2 args2 coils1 dcnl dcsp args2 update coils2 args1 coils1 dcnl dcsp cross dots1 do cross dots args1 dcnl dcsp cross dots2 do cross dots args2 dcnl dcsp assert array almost equal cross dots1 cross dots2 t dcnl dcsp evoked evoked pick channels ch names ch names 10 none copy dcnl dcsp data1 evoked pick types meg grad data ravel dcnl dcsp data2 evoked as type grad data ravel dcnl dcsp assert true np corrcoef data1 data2 0 1 0 95
def compare forwards f1 f2 dcsp assert allclose f1 sol data f2 sol data dcnl dcsp assert equal f1 sol ncol f2 sol ncol dcnl dcsp assert allclose f1 source nn f2 source nn dcnl dcsp if f1 sol grad is not none dcnl dcsp dcsp assert true f2 sol grad is not none dcnl dcsp dcsp assert allclose f1 sol grad data f2 sol grad data dcnl dcsp dcsp assert equal f1 sol grad ncol f2 sol grad ncol dcnl dcsp else dcnl dcsp dcsp assert true f2 sol grad is none dcnl dcsp assert equal f1 source ori f2 source ori dcnl dcsp assert equal f1 surf ori f2 surf ori
testing requires testing data dcnl def test convert forward dcsp fwd read forward solution fname meeg grad dcnl dcsp fwd repr repr fwd dcnl dcsp assert true 306 in fwd repr dcnl dcsp assert true 60 in fwd repr dcnl dcsp assert true fwd repr dcnl dcsp assert true isinstance fwd forward dcnl dcsp fwd surf convert forward solution fwd surf ori true dcnl dcsp fwd surf io read forward solution fname meeg grad surf ori true dcnl dcsp compare forwards fwd surf fwd surf io dcnl dcsp del fwd surf io dcnl dcsp gc collect dcnl dcsp fwd new convert forward solution fwd surf surf ori false dcnl dcsp assert true repr fwd new dcnl dcsp assert true isinstance fwd new forward dcnl dcsp compare forwards fwd fwd new dcnl dcsp fwd fixed convert forward solution fwd surf surf ori false force fixed true dcnl dcsp del fwd surf dcnl dcsp gc collect dcnl dcsp assert true repr fwd fixed dcnl dcsp assert true isinstance fwd fixed forward dcnl dcsp fwd fixed io read forward solution fname meeg grad surf ori false force fixed true dcnl dcsp compare forwards fwd fixed fwd fixed io dcnl dcsp del fwd fixed io dcnl dcsp gc collect dcnl dcsp fwd new convert forward solution fwd fixed dcnl dcsp assert true repr fwd new dcnl dcsp assert true isinstance fwd new forward dcnl dcsp compare forwards fwd fwd new dcnl dcsp del fwd fwd new fwd fixed dcnl dcsp gc collect
slow test dcnl testing requires testing data dcnl def test io forward dcsp temp dir tempdir dcnl dcsp n channels n src 366 108 dcnl dcsp fwd read forward solution fname meeg grad dcnl dcsp assert true isinstance fwd forward dcnl dcsp fwd read forward solution fname meeg grad surf ori true dcnl dcsp leadfield fwd sol data dcnl dcsp assert equal leadfield shape n channels n src dcnl dcsp assert equal len fwd sol row names n channels dcnl dcsp fname temp op join temp dir testfwd fif dcnl dcsp write forward solution fname temp fwd overwrite true dcnl dcsp fwd read forward solution fname meeg grad surf ori true dcnl dcsp fwd read read forward solution fname temp surf ori true dcnl dcsp leadfield fwd read sol data dcnl dcsp assert equal leadfield shape n channels n src dcnl dcsp assert equal len fwd read sol row names n channels dcnl dcsp assert equal len fwd read info chs n channels dcnl dcsp assert true dev head t in fwd read info dcnl dcsp assert true mri head t in fwd read dcnl dcsp assert array almost equal fwd sol data fwd read sol data dcnl dcsp fwd read forward solution fname meeg grad force fixed true dcnl dcsp leadfield fwd sol data dcnl dcsp assert equal leadfield shape n channels n src 3 dcnl dcsp assert equal len fwd sol row names n channels dcnl dcsp assert equal len fwd info chs n channels dcnl dcsp assert true dev head t in fwd info dcnl dcsp assert true mri head t in fwd dcnl dcsp assert true fwd surf ori dcnl dcsp fwd read forward solution fname meeg grad dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp fwd badname op join temp dir testbadname fif gz dcnl dcsp dcsp write forward solution fwd badname fwd dcnl dcsp dcsp read forward solution fwd badname dcnl dcsp assert naming w test forward py 2 dcnl dcsp fwd read forward solution fname meeg dcnl dcsp write forward solution fname temp fwd overwrite true dcnl dcsp fwd read read forward solution fname temp dcnl dcsp compare forwards fwd fwd read
testing requires testing data dcnl def test apply forward dcsp start 0 dcnl dcsp stop 5 dcnl dcsp n times stop start 1 dcnl dcsp sfreq 10 0 dcnl dcsp t start 0 123 dcnl dcsp fwd read forward solution fname meeg force fixed true dcnl dcsp fwd pick types forward fwd meg true dcnl dcsp assert true isinstance fwd forward dcnl dcsp vertno fwd src 0 vertno fwd src 1 vertno dcnl dcsp stc data np ones len vertno0 + len vertno1 n times dcnl dcsp stc sourceestimate stc data vertno tmin t start tstep 1 0 sfreq dcnl dcsp gain sum np sum fwd sol data axis 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp evoked read evokeds fname evoked condition 0 dcnl dcsp dcsp evoked pick types meg true dcnl dcsp dcsp evoked apply forward fwd stc evoked info start start stop stop dcnl dcsp dcsp assert equal len w 2 dcnl dcsp dcsp data evoked data dcnl dcsp dcsp times evoked times dcnl dcsp dcsp assert array almost equal evoked info sfreq sfreq dcnl dcsp dcsp assert array almost equal np sum data axis 1 n times gain sum dcnl dcsp dcsp assert array almost equal times0 t start dcnl dcsp dcsp assert array almost equal times 1 t start + n times 1 sfreq dcnl dcsp dcsp raw proj apply forward raw fwd stc evoked info start start stop stop dcnl dcsp dcsp data times raw proj dcnl dcsp dcsp assert array almost equal raw proj info sfreq sfreq dcnl dcsp dcsp assert array almost equal np sum data axis 1 n times gain sum dcnl dcsp dcsp atol 1 0 sfreq dcnl dcsp dcsp assert allclose raw proj first samp sfreq t start atol atol dcnl dcsp dcsp assert allclose raw proj last samp sfreq t start + n times 1 sfreq atol atol
testing requires testing data dcnl def test restrict forward to stc dcsp start 0 dcnl dcsp stop 5 dcnl dcsp n times stop start 1 dcnl dcsp sfreq 10 0 dcnl dcsp t start 0 123 dcnl dcsp fwd read forward solution fname meeg force fixed true dcnl dcsp fwd pick types forward fwd meg true dcnl dcsp vertno fwd src 0 vertno 0 15 fwd src 1 vertno 0 5 dcnl dcsp stc data np ones len vertno0 + len vertno1 n times dcnl dcsp stc sourceestimate stc data vertno tmin t start tstep 1 0 sfreq dcnl dcsp fwd out restrict forward to stc fwd stc dcnl dcsp assert true isinstance fwd out forward dcnl dcsp assert equal fwd out sol ncol 20 dcnl dcsp assert equal fwd out src 0 nuse 15 dcnl dcsp assert equal fwd out src 1 nuse 5 dcnl dcsp assert equal fwd out src 0 vertno fwd src 0 vertno 0 15 dcnl dcsp assert equal fwd out src 1 vertno fwd src 1 vertno 0 5 dcnl dcsp fwd read forward solution fname meeg force fixed false dcnl dcsp fwd pick types forward fwd meg true dcnl dcsp vertno fwd src 0 vertno 0 15 fwd src 1 vertno 0 5 dcnl dcsp stc data np ones len vertno0 + len vertno1 n times dcnl dcsp stc sourceestimate stc data vertno tmin t start tstep 1 0 sfreq dcnl dcsp fwd out restrict forward to stc fwd stc dcnl dcsp assert equal fwd out sol ncol 60 dcnl dcsp assert equal fwd out src 0 nuse 15 dcnl dcsp assert equal fwd out src 1 nuse 5 dcnl dcsp assert equal fwd out src 0 vertno fwd src 0 vertno 0 15 dcnl dcsp assert equal fwd out src 1 vertno fwd src 1 vertno 0 5 dcnl dcsp temp dir tempdir dcnl dcsp fname copy op join temp dir copyfwd fif dcnl dcsp write forward solution fname copy fwd out overwrite true dcnl dcsp fwd out read read forward solution fname copy dcnl dcsp compare forwards fwd out fwd out read
testing requires testing data dcnl def test restrict forward to label dcsp fwd read forward solution fname meeg force fixed true dcnl dcsp fwd pick types forward fwd meg true dcnl dcsp label path op join data path meg sample labels dcnl dcsp labels audlh visrh dcnl dcsp label lh read label op join label path labels0 + label dcnl dcsp label rh read label op join label path labels1 + label dcnl dcsp fwd out restrict forward to label fwd label lh label rh dcnl dcsp src sel lh np intersect1d fwd src 0 vertno label lh vertices dcnl dcsp src sel lh np searchsorted fwd src 0 vertno src sel lh dcnl dcsp vertno lh fwd src 0 vertno src sel lh dcnl dcsp nuse lh fwd src 0 nuse dcnl dcsp src sel rh np intersect1d fwd src 1 vertno label rh vertices dcnl dcsp src sel rh np searchsorted fwd src 1 vertno src sel rh dcnl dcsp vertno rh fwd src 1 vertno src sel rh dcnl dcsp src sel rh + nuse lh dcnl dcsp assert equal fwd out sol ncol len src sel lh + len src sel rh dcnl dcsp assert equal fwd out src 0 nuse len src sel lh dcnl dcsp assert equal fwd out src 1 nuse len src sel rh dcnl dcsp assert equal fwd out src 0 vertno vertno lh dcnl dcsp assert equal fwd out src 1 vertno vertno rh dcnl dcsp fwd read forward solution fname meeg force fixed false dcnl dcsp fwd pick types forward fwd meg true dcnl dcsp label path op join data path meg sample labels dcnl dcsp labels audlh visrh dcnl dcsp label lh read label op join label path labels0 + label dcnl dcsp label rh read label op join label path labels1 + label dcnl dcsp fwd out restrict forward to label fwd label lh label rh dcnl dcsp src sel lh np intersect1d fwd src 0 vertno label lh vertices dcnl dcsp src sel lh np searchsorted fwd src 0 vertno src sel lh dcnl dcsp vertno lh fwd src 0 vertno src sel lh dcnl dcsp nuse lh fwd src 0 nuse dcnl dcsp src sel rh np intersect1d fwd src 1 vertno label rh vertices dcnl dcsp src sel rh np searchsorted fwd src 1 vertno src sel rh dcnl dcsp vertno rh fwd src 1 vertno src sel rh dcnl dcsp src sel rh + nuse lh dcnl dcsp assert equal fwd out sol ncol 3 len src sel lh + len src sel rh dcnl dcsp assert equal fwd out src 0 nuse len src sel lh dcnl dcsp assert equal fwd out src 1 nuse len src sel rh dcnl dcsp assert equal fwd out src 0 vertno vertno lh dcnl dcsp assert equal fwd out src 1 vertno vertno rh dcnl dcsp temp dir tempdir dcnl dcsp fname copy op join temp dir copyfwd fif dcnl dcsp write forward solution fname copy fwd out overwrite true dcnl dcsp fwd out read read forward solution fname copy dcnl dcsp compare forwards fwd out fwd out read
testing requires testing data dcnl requires mne dcnl def test average forward solution dcsp temp dir tempdir dcnl dcsp fwd read forward solution fname meeg dcnl dcsp assert raises typeerror average forward solutions 1 dcnl dcsp assert raises valueerror average forward solutions dcnl dcsp assert raises valueerror average forward solutions fwd fwd 1 0 dcnl dcsp assert raises valueerror average forward solutions fwd fwd 0 0 dcnl dcsp assert raises valueerror average forward solutions fwd fwd 0 0 0 dcnl dcsp assert raises typeerror average forward solutions 1 fwd dcnl dcsp fwd copy average forward solutions fwd dcnl dcsp assert true isinstance fwd copy forward dcnl dcsp assert array equal fwd sol data fwd copy sol data dcnl dcsp fwd copy sol data 0 5 dcnl dcsp fname copy op join temp dir copyfwd fif dcnl dcsp write forward solution fname copy fwd copy overwrite true dcnl dcsp cmd mne average forward solutions fwd fname meeg fwd fname copy out fname copy dcnl dcsp run subprocess cmd dcnl dcsp fwd ave average forward solutions fwd fwd copy dcnl dcsp assert array equal 0 75 fwd sol data fwd ave sol data dcnl dcsp fwd read forward solution fname meeg grad dcnl dcsp fwd ave average forward solutions fwd fwd dcnl dcsp compare forwards fwd fwd ave
verbose dcnl def read coil defs elekta defs false verbose none dcsp coil dir op join op split file 0 data dcnl dcsp coils list dcnl dcsp if elekta defs dcnl dcsp dcsp coils + read coil def file op join coil dir coil def elekta dat dcnl dcsp coils + read coil def file op join coil dir coil def dat dcnl dcsp return coils
def read coil def file fname dcsp if fname not in coil register dcnl dcsp dcsp big val 0 5 dcnl dcsp dcsp coils list dcnl dcsp dcsp with open fname r as fid dcnl dcsp dcsp dcsp lines fid readlines dcnl dcsp dcsp lines lines 1 dcnl dcsp dcsp while len lines 0 dcnl dcsp dcsp dcsp line lines pop dcnl dcsp dcsp dcsp if line0 dcnl dcsp dcsp dcsp dcsp vals np fromstring line sep dcsp dcnl dcsp dcsp dcsp dcsp assert len vals in 6 7 dcnl dcsp dcsp dcsp dcsp start line find dcnl dcsp dcsp dcsp dcsp end len line strip 1 dcnl dcsp dcsp dcsp dcsp assert line strip end dcnl dcsp dcsp dcsp dcsp desc linestart end dcnl dcsp dcsp dcsp dcsp npts int vals3 dcnl dcsp dcsp dcsp dcsp coil dict coil type vals1 coil class vals0 desc desc accuracy vals2 size vals4 base vals5 dcnl dcsp dcsp dcsp dcsp rmag list dcnl dcsp dcsp dcsp dcsp cosmag list dcnl dcsp dcsp dcsp dcsp w list dcnl dcsp dcsp dcsp dcsp for p in range npts dcnl dcsp dcsp dcsp dcsp dcsp line lines pop dcnl dcsp dcsp dcsp dcsp dcsp while line0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp line lines pop dcnl dcsp dcsp dcsp dcsp dcsp vals np fromstring line sep dcsp dcnl dcsp dcsp dcsp dcsp dcsp assert len vals 7 dcnl dcsp dcsp dcsp dcsp dcsp w append vals0 dcnl dcsp dcsp dcsp dcsp dcsp rmag append vals1 2 3 dcnl dcsp dcsp dcsp dcsp dcsp cosmag append vals4 5 6 dcnl dcsp dcsp dcsp dcsp w np array w dcnl dcsp dcsp dcsp dcsp rmag np array rmag dcnl dcsp dcsp dcsp dcsp cosmag np array cosmag dcnl dcsp dcsp dcsp dcsp size np sqrt np sum cosmag 2 axis 1 dcnl dcsp dcsp dcsp dcsp if np any np sqrt np sum rmag 2 axis 1 big val dcnl dcsp dcsp dcsp dcsp dcsp raise runtimeerror unreasonable dcsp integration dcsp point dcnl dcsp dcsp dcsp dcsp if np any size < 0 dcnl dcsp dcsp dcsp dcsp dcsp raise runtimeerror unreasonable dcsp normal dcnl dcsp dcsp dcsp dcsp cosmag size np newaxis dcnl dcsp dcsp dcsp dcsp coil update dict w w cosmag cosmag rmag rmag dcnl dcsp dcsp dcsp dcsp coils append coil dcnl dcsp dcsp coil registerfname coils dcnl dcsp coils deepcopy coil registerfname dcnl dcsp logger info d dcsp coil dcsp definitions dcsp read len coils dcnl dcsp return coils
def create meg coil coilset ch acc do es dcsp if ch kind not in fiff fiffv meg ch fiff fiffv ref meg ch dcnl dcsp dcsp raise runtimeerror s dcsp is dcsp not dcsp a dcsp meg dcsp channel ch ch name dcnl dcsp for coil in coilset dcnl dcsp dcsp if coil coil type ch coil type 65535 and coil accuracy acc dcnl dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp raise runtimeerror desired dcsp coil dcsp definition dcsp not dcsp found dcsp type dcsp dcsp d dcsp acc dcsp dcsp d ch coil type acc dcnl dcsp coil trans loc to coil trans ch loc dcnl dcsp res dict chname ch ch name coil class coil coil class accuracy coil accuracy base coil base size coil size type ch coil type w coil w desc coil desc coord frame fiff fiffv coord device rmag orig coil rmag cosmag orig coil cosmag coil trans orig coil trans r0 coil trans 3 3 rmag apply trans coil trans coil rmag cosmag apply trans coil trans coil cosmag false dcnl dcsp if do es dcnl dcsp dcsp r0 exey np dot coil rmag 2 coil trans 3 2 t + coil trans 3 3 dcnl dcsp dcsp res update ex coil trans 3 0 ey coil trans 3 1 ez coil trans 3 2 r0 exey r0 exey dcnl dcsp return res
def create eeg el ch t none dcsp if ch kind fiff fiffv eeg ch dcnl dcsp dcsp raise runtimeerror s dcsp is dcsp not dcsp an dcsp eeg dcsp channel dcsp cannot dcsp create dcsp an dcsp electrode dcsp definition ch ch name dcnl dcsp if t is none dcnl dcsp dcsp t transform head head dcnl dcsp if t from str head dcnl dcsp dcsp raise runtimeerror inappropriate dcsp coordinate dcsp transformation dcnl dcsp r0ex loc to eeg loc ch loc dcnl dcsp if r0ex shape1 1 dcnl dcsp dcsp w np array 1 0 dcnl dcsp else dcnl dcsp dcsp w np array 1 0 1 0 dcnl dcsp r0ex apply trans t trans r0ex t dcnl dcsp cosmag r0ex copy dcnl dcsp normalize vectors cosmag dcnl dcsp res dict chname ch ch name coil class fiff fwd coilc eeg w w accuracy accuracy dict normal type ch coil type coord frame t to rmag r0ex cosmag cosmag dcnl dcsp return res
def create meg coils chs acc t none coilset none do es false dcsp acc accuracy dictacc if isinstance acc string types else acc dcnl dcsp coilset read coil defs verbose false if coilset is none else coilset dcnl dcsp coils create meg coil coilset ch acc do es for ch in chs dcnl dcsp transform orig meg coils coils t do es do es dcnl dcsp return coils
def transform orig meg coils coils t do es true dcsp if t is none dcnl dcsp dcsp return dcnl dcsp for coil in coils dcnl dcsp dcsp coil trans np dot t trans coil coil trans orig dcnl dcsp dcsp coil update coord frame t to r0 coil trans 3 3 rmag apply trans coil trans coil rmag orig cosmag apply trans coil trans coil cosmag orig false dcnl dcsp dcsp if do es dcnl dcsp dcsp dcsp r0 exey np dot coil rmag orig 2 coil trans 3 2 t + coil trans 3 3 dcnl dcsp dcsp dcsp coil update ex coil trans 3 0 ey coil trans 3 1 ez coil trans 3 2 r0 exey r0 exey
def create eeg els chs dcsp return create eeg el ch for ch in chs
verbose dcnl def setup bem bem bem extra neeg mri head t verbose none dcsp logger info dcnl dcsp if isinstance bem string types dcnl dcsp dcsp logger info setting dcsp up dcsp the dcsp bem dcsp model dcsp using dcsp s n bem extra dcnl dcsp dcsp bem read bem solution bem dcnl dcsp if not isinstance bem conductormodel dcnl dcsp dcsp raise typeerror bem dcsp must dcsp be dcsp a dcsp string dcsp or dcsp conductormodel dcnl dcsp if bem is sphere dcnl dcsp dcsp logger info using dcsp the dcsp sphere dcsp model n dcnl dcsp dcsp if len bem layers 0 and neeg 0 dcnl dcsp dcsp dcsp raise runtimeerror spherical dcsp model dcsp has dcsp zero dcsp shells dcsp cannot dcsp use dcsp with dcsp eeg dcsp data dcnl dcsp dcsp if bem coord frame fiff fiffv coord head dcnl dcsp dcsp dcsp raise runtimeerror spherical dcsp model dcsp is dcsp not dcsp in dcsp head dcsp coordinates dcnl dcsp else dcnl dcsp dcsp if neeg 0 and len bem surfs 1 dcnl dcsp dcsp dcsp raise runtimeerror cannot dcsp use dcsp a dcsp homogeneous dcsp model dcsp in dcsp eeg dcsp calculations dcnl dcsp dcsp logger info employing dcsp the dcsp head mri dcsp coordinate dcsp transform dcsp with dcsp the dcsp bem dcsp model dcnl dcsp dcsp bem head mri t ensure trans mri head t head mri dcnl dcsp dcsp logger info bem dcsp model dcsp s dcsp is dcsp now dcsp set dcsp up op split bem extra 1 dcnl dcsp dcsp logger info dcnl dcsp return bem
verbose dcnl def prep meg channels info accurate true exclude ignore ref false elekta defs false head frame true do es false do picking true verbose none dcsp accuracy accurate if accurate else normal dcnl dcsp info extra info dcnl dcsp megnames megcoils compcoils dcnl dcsp picks pick types info meg true eeg false ref meg false exclude exclude dcnl dcsp nmeg len picks dcnl dcsp if nmeg < 0 dcnl dcsp dcsp raise runtimeerror could dcsp not dcsp find dcsp any dcsp meg dcsp channels dcnl dcsp megchs info chs pick for pick in picks dcnl dcsp megnames info ch names p for p in picks dcnl dcsp logger info read dcsp 3d dcsp meg dcsp channels dcsp from dcsp s len picks info extra dcnl dcsp if not ignore ref dcnl dcsp dcsp picks pick types info meg false ref meg true exclude exclude dcnl dcsp dcsp ncomp len picks dcnl dcsp dcsp if ncomp 0 dcnl dcsp dcsp dcsp compchs pick info info picks chs dcnl dcsp dcsp dcsp logger info read dcsp 3d dcsp meg dcsp compensation dcsp channels dcsp from dcsp s ncomp info extra dcnl dcsp dcsp dcsp if has kit refs info picks dcnl dcsp dcsp dcsp dcsp raise notimplementederror cannot dcsp create dcsp forward dcsp solution dcsp with dcsp kit dcsp reference dcsp channels dcsp consider dcsp using dcsp ignore ref true dcsp in dcsp calculation dcnl dcsp else dcnl dcsp dcsp ncomp 0 dcnl dcsp ncomp data len info comps dcnl dcsp ref meg true if not ignore ref else false dcnl dcsp picks pick types info meg true ref meg ref meg exclude exclude dcnl dcsp templates read coil defs elekta defs elekta defs dcnl dcsp if head frame dcnl dcsp dcsp print coord trans info dev head t dcnl dcsp dcsp transform info dev head t dcnl dcsp else dcnl dcsp dcsp transform none dcnl dcsp megcoils create meg coils megchs accuracy transform templates do es do es dcnl dcsp if ncomp 0 dcnl dcsp dcsp logger info d dcsp compensation dcsp data dcsp sets dcsp in dcsp s ncomp data info extra dcnl dcsp dcsp compcoils create meg coils compchs normal transform templates do es do es dcnl dcsp if head frame dcnl dcsp dcsp assert megcoils0 coord frame fiff fiffv coord head dcnl dcsp dcsp logger info meg dcsp coil dcsp definitions dcsp created dcsp in dcsp head dcsp coordinates dcnl dcsp else dcnl dcsp dcsp assert megcoils0 coord frame fiff fiffv coord device dcnl dcsp dcsp logger info meg dcsp coil dcsp definitions dcsp created dcsp in dcsp device dcsp coordinate dcnl dcsp out megcoils compcoils megnames dcnl dcsp if do picking dcnl dcsp dcsp out out + pick info info picks if nmeg 0 else none dcnl dcsp return out
verbose dcnl def prep eeg channels info exclude verbose none dcsp eegnames eegels dcnl dcsp info extra info dcnl dcsp picks pick types info meg false eeg true ref meg false exclude exclude dcnl dcsp neeg len picks dcnl dcsp if neeg < 0 dcnl dcsp dcsp raise runtimeerror could dcsp not dcsp find dcsp any dcsp eeg dcsp channels dcnl dcsp eegchs pick info info picks chs dcnl dcsp eegnames info ch names p for p in picks dcnl dcsp logger info read dcsp 3d dcsp eeg dcsp channels dcsp from dcsp s len picks info extra dcnl dcsp eegels create eeg els eegchs dcnl dcsp logger info head dcsp coordinate dcsp coil dcsp definitions dcsp created dcnl dcsp return eegels eegnames
verbose dcnl def prepare for forward src mri head t info bem mindist n jobs bem extra trans info extra meg true eeg true ignore ref false verbose none dcsp logger info dcnl dcsp src ensure src src copy dcnl dcsp nsource sum s nuse for s in src dcnl dcsp if nsource 0 dcnl dcsp dcsp raise runtimeerror no dcsp sources dcsp are dcsp active dcsp in dcsp these dcsp source dcsp spaces dcsp do all dcsp option dcsp should dcsp be dcsp used dcnl dcsp logger info read dcsp d dcsp source dcsp spaces dcsp a dcsp total dcsp of dcsp d dcsp active dcsp source dcsp locations len src nsource dcnl dcsp for key in working dir command line dcnl dcsp dcsp if key in src info dcnl dcsp dcsp dcsp del src infokey dcnl dcsp logger info dcnl dcsp print coord trans mri head t dcnl dcsp arg list info extra trans src bem extra meg eeg mindist n jobs verbose dcnl dcsp cmd make forward solution s dcsp join str a for a in arg list dcnl dcsp mri id dict machid np zeros 2 np int32 version 0 secs 0 usecs 0 dcnl dcsp info info chs info chs comps info comps dev head t info dev head t mri file trans mri id mri id meas file info extra meas id none working dir os getcwd command line cmd bads info bads mri head t mri head t dcnl dcsp info update redundant dcnl dcsp info check consistency dcnl dcsp logger info dcnl dcsp megcoils compcoils megnames meg info dcnl dcsp eegels eegnames dcnl dcsp if meg and len pick types info ref meg false exclude 0 dcnl dcsp dcsp megcoils compcoils megnames meg info prep meg channels info ignore ref ignore ref dcnl dcsp if eeg and len pick types info meg false eeg true ref meg false exclude 0 dcnl dcsp dcsp eegels eegnames prep eeg channels info dcnl dcsp if len megcoils + eegels 0 dcnl dcsp dcsp raise runtimeerror no dcsp meg dcsp or dcsp eeg dcsp channels dcsp found dcnl dcsp info pick info info pick types info meg meg eeg eeg ref meg false exclude dcnl dcsp for s in src dcnl dcsp dcsp transform surface to s head mri head t dcnl dcsp logger info source dcsp spaces dcsp are dcsp now dcsp in dcsp s dcsp coordinates coord frame name s coord frame dcnl dcsp bem setup bem bem bem extra len eegnames mri head t dcnl dcsp if not bem is sphere dcnl dcsp dcsp inner skull bem find surface bem inner skull dcnl dcsp dcsp filter source spaces inner skull mindist mri head t src n jobs dcnl dcsp dcsp logger info dcnl dcsp rr np concatenate s rr s vertno for s in src dcnl dcsp if len rr < 1 dcnl dcsp dcsp raise runtimeerror no dcsp points dcsp left dcsp in dcsp source dcsp space dcsp after dcsp excluding dcsp points dcsp close dcsp to dcsp inner dcsp skull dcnl dcsp source nn np tile np eye 3 len rr 1 dcnl dcsp update kwargs dict nchan len info ch names nsource len rr info info src src source nn source nn source rr rr surf ori false mri head t mri head t dcnl dcsp return megcoils meg info compcoils megnames eegels eegnames rr info update kwargs bem
verbose dcnl def make forward solution info trans src bem meg true eeg true mindist 0 0 ignore ref false n jobs 1 verbose none dcsp mri head t trans get trans trans dcnl dcsp bem extra dict if isinstance bem dict else bem dcnl dcsp if not isinstance info info string types dcnl dcsp dcsp raise typeerror info dcsp should dcsp be dcsp an dcsp instance dcsp of dcsp info dcsp or dcsp string dcnl dcsp if isinstance info string types dcnl dcsp dcsp info extra op split info 1 dcnl dcsp dcsp info read info info verbose false dcnl dcsp else dcnl dcsp dcsp info extra instance dcsp of dcsp info dcnl dcsp n jobs check n jobs n jobs dcnl dcsp logger info source dcsp space dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s src dcnl dcsp logger info mri dcsp dcsp head dcsp transform dcsp source dcsp dcsp s trans dcnl dcsp logger info measurement dcsp data dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s info extra dcnl dcsp if isinstance bem dict and bem is sphere dcnl dcsp dcsp logger info sphere dcsp model dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp origin dcsp at dcsp s dcsp mm bem r0 dcnl dcsp dcsp logger info standard dcsp field dcsp computations dcnl dcsp else dcnl dcsp dcsp logger info bem dcsp model dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s bem extra dcnl dcsp dcsp logger info accurate dcsp field dcsp computations dcnl dcsp logger info do dcsp computations dcsp in dcsp s dcsp coordinates coord frame name fiff fiffv coord head dcnl dcsp logger info free dcsp source dcsp orientations dcnl dcsp megcoils meg info compcoils megnames eegels eegnames rr info update kwargs bem prepare for forward src mri head t info bem mindist n jobs bem extra trans info extra meg eeg ignore ref dcnl dcsp del src mri head t trans info extra bem extra mindist meg eeg ignore ref dcnl dcsp coil types meg eeg dcnl dcsp coils megcoils eegels dcnl dcsp ccoils compcoils none dcnl dcsp infos meg info none dcnl dcsp megfwd eegfwd compute forwards rr bem coils ccoils infos coil types n jobs dcnl dcsp fwd merge meg eeg fwds to forward dict megfwd megnames to forward dict eegfwd eegnames verbose false dcnl dcsp logger info dcnl dcsp fwd update update kwargs dcnl dcsp logger info finished dcnl dcsp return fwd
def make forward dipole dipole bem info trans none n jobs 1 verbose none dcsp times dipole times copy dcnl dcsp pos dipole pos copy dcnl dcsp amplitude dipole amplitude copy dcnl dcsp ori dipole ori copy dcnl dcsp sources dict rr pos nn ori dcnl dcsp sp make discrete source space sources coord frame head dcnl dcsp src sourcespaces sp dcnl dcsp fwd make forward solution info trans src bem n jobs n jobs verbose verbose dcnl dcsp convert forward solution fwd surf ori false force fixed true copy false verbose none dcnl dcsp if fwd src 0 nuse len pos dcnl dcsp dcsp inuse fwd src 0 inuse astype np bool dcnl dcsp dcsp head the dcsp following dcsp dipoles dcsp are dcsp outside dcsp the dcsp inner dcsp skull dcsp boundary dcnl dcsp dcsp msg len head + n + head + n dcnl dcsp dcsp for t pos in zip timesnp logical not inuse posnp logical not inuse dcnl dcsp dcsp dcsp msg + dcsp dcsp dcsp dcsp t 0f dcsp ms dcsp pos 0f dcsp 0f dcsp 0f dcsp mm n format t 1000 0 pos0 1000 0 pos1 1000 0 pos2 1000 0 dcnl dcsp dcsp msg + len head dcnl dcsp dcsp logger error msg dcnl dcsp dcsp raise valueerror one dcsp or dcsp more dcsp dipoles dcsp outside dcsp the dcsp inner dcsp skull dcnl dcsp timepoints np unique times dcnl dcsp if len timepoints 1 dcnl dcsp dcsp tdiff np diff timepoints dcnl dcsp dcsp if not np allclose tdiff tdiff0 dcnl dcsp dcsp dcsp warn unique dcsp time dcsp points dcsp of dcsp dipoles dcsp unevenly dcsp spaced dcsp returned dcsp stc dcsp will dcsp be dcsp a dcsp list dcsp one dcsp for dcsp each dcsp time dcsp point dcnl dcsp dcsp dcsp tstep 1 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp tstep tdiff0 dcnl dcsp elif len timepoints 1 dcnl dcsp dcsp tstep 0 001 dcnl dcsp data np zeros len amplitude len timepoints dcnl dcsp row 0 dcnl dcsp for tpind tp in enumerate timepoints dcnl dcsp dcsp amp amplitudenp in1d times tp dcnl dcsp dcsp datarow row + len amp tpind amp dcnl dcsp dcsp row + len amp dcnl dcsp if tstep 0 dcnl dcsp dcsp stc volsourceestimate data vertices fwd src 0 vertno tmin timepoints0 tstep tstep subject none dcnl dcsp else dcnl dcsp dcsp stc dcnl dcsp dcsp for col tp in enumerate timepoints dcnl dcsp dcsp dcsp stc + volsourceestimate data col np newaxis vertices fwd src 0 vertno tmin tp tstep 0 001 subject none dcnl dcsp return fwd stc
def to forward dict fwd names fwd grad none coord frame fiff fiffv coord head source ori fiff fiffv mne free ori dcsp assert names is not none dcnl dcsp if len fwd 0 dcnl dcsp dcsp return none dcnl dcsp sol dict data fwd t nrow fwd shape1 ncol fwd shape0 row names names col names dcnl dcsp fwd forward sol sol source ori source ori nsource sol ncol coord frame coord frame sol grad none nchan sol nrow orig source ori source ori orig sol sol data copy orig sol grad none dcnl dcsp if fwd grad is not none dcnl dcsp dcsp sol grad dict data fwd grad t nrow fwd grad shape1 ncol fwd grad shape0 row names names col names dcnl dcsp dcsp fwd update dict sol grad sol grad orig sol grad sol grad data copy dcnl dcsp return fwd
def next legen der n x p0 p01 p0d p0dd dcsp help p0 dcnl dcsp helpd p0d dcnl dcsp p0 2 n 1 x help n 1 p01 n dcnl dcsp p0d n help + x helpd dcnl dcsp p0dd n + 1 helpd + x p0dd dcnl dcsp p01 help dcnl dcsp return p0 p0d p0dd
def get legen x n coeff 100 dcsp return legendre legvander x n coeff 1
def get legen der xx n coeff 100 dcsp coeffs np empty len xx n coeff 3 dcnl dcsp for c x in zip coeffs xx dcnl dcsp dcsp p0s p0ds p0dds c 0 c 1 c 2 dcnl dcsp dcsp p0s 2 1 0 x dcnl dcsp dcsp p0ds 2 0 0 1 0 dcnl dcsp dcsp p0dds 2 0 0 0 0 dcnl dcsp dcsp for n in range 2 n coeff dcnl dcsp dcsp dcsp p0sn p0dsn p0ddsn next legen der n x p0s n 1 p0s n 2 p0ds n 1 p0dds n 1 dcnl dcsp return coeffs
verbose dcnl def get legen table ch type volume integral false n coeff 100 n interp 20000 force calc false verbose none dcsp if n interp 2 0 dcnl dcsp dcsp raise runtimeerror n interp dcsp must dcsp be dcsp even dcnl dcsp fname op join get extra data path tables dcnl dcsp if not op isdir fname dcnl dcsp dcsp os makedirs fname dcnl dcsp if ch type meg dcnl dcsp dcsp fname op join fname legder s s bin n coeff n interp dcnl dcsp dcsp leg fun get legen der dcnl dcsp dcsp extra str dcsp derivative dcnl dcsp dcsp lut shape n interp + 1 n coeff 3 dcnl dcsp else dcnl dcsp dcsp fname op join fname legval s s bin n coeff n interp dcnl dcsp dcsp leg fun get legen dcnl dcsp dcsp extra str dcnl dcsp dcsp lut shape n interp + 1 n coeff dcnl dcsp if not op isfile fname or force calc dcnl dcsp dcsp logger info generating dcsp legendre s dcsp table extra str dcnl dcsp dcsp x interp np linspace 1 1 n interp + 1 dcnl dcsp dcsp lut leg fun x interp n coeff astype np float32 dcnl dcsp dcsp if not force calc dcnl dcsp dcsp dcsp with open fname wb as fid dcnl dcsp dcsp dcsp dcsp fid write lut tostring dcnl dcsp else dcnl dcsp dcsp logger info reading dcsp legendre s dcsp table extra str dcnl dcsp dcsp with open fname rb buffering 0 as fid dcnl dcsp dcsp dcsp lut np fromfile fid np float32 dcnl dcsp lut shape lut shape dcnl dcsp n fact np arange 1 n coeff dtype float dcnl dcsp if ch type meg dcnl dcsp dcsp n facts list dcnl dcsp dcsp if volume integral dcnl dcsp dcsp dcsp n facts append n fact 2 0 n fact + 1 0 2 0 n fact + 3 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp n facts append n fact 2 0 n fact + 1 0 dcnl dcsp dcsp n facts append n facts0 n fact + 1 0 dcnl dcsp dcsp n facts append n facts0 n fact + 1 0 dcnl dcsp dcsp lut lut 1 0 1 1 2 dcnl dcsp dcsp n facts np array n facts 2 0 1 1 t dcnl dcsp dcsp n facts np ascontiguousarray n facts dcnl dcsp dcsp n fact n facts dcnl dcsp else dcnl dcsp dcsp n fact 2 0 n fact + 1 0 2 0 n fact + 1 0 n fact dcnl dcsp dcsp lut lut 1 copy dcnl dcsp return lut n fact
def comp sum eeg beta ctheta lut fun n fact dcsp n chunk 50000000 8 max n fact shape 2 dcnl dcsp lims np concatenate np arange 0 beta size n chunk beta size dcnl dcsp s0 np empty beta shape dcnl dcsp for start stop in zip lims 1 lims1 dcnl dcsp dcsp coeffs lut fun cthetastart stop dcnl dcsp dcsp betans np tile betastart stop np newaxis 1 n fact shape0 dcnl dcsp dcsp np cumprod betans axis 1 out betans dcnl dcsp dcsp coeffs betans dcnl dcsp dcsp s0start stop np dot coeffs n fact dcnl dcsp return s0
def comp sums meg beta ctheta lut fun n fact volume integral dcsp sums np empty n fact shape1 len beta dcnl dcsp n chunk 50000000 8 max n fact shape 2 dcnl dcsp lims np concatenate np arange 0 beta size n chunk beta size dcnl dcsp for start stop in zip lims 1 lims1 dcnl dcsp dcsp bbeta np tile betastart stopnp newaxis n fact shape0 1 dcnl dcsp dcsp bbeta0 betastart stop dcnl dcsp dcsp np cumprod bbeta axis 0 out bbeta dcnl dcsp dcsp np einsum ji jk ijk ki bbeta n fact lut fun cthetastart stop out sums start stop dcnl dcsp return sums
def fast sphere dot r0 r rr1 orig rr2s lr1 lr2s cosmags1 cosmags2s w1 w2s volume integral lut n fact ch type dcsp if w1 is none dcnl dcsp dcsp out shape len rr2s len rr1 orig dcnl dcsp dcsp sum axis 1 dcnl dcsp else dcnl dcsp dcsp out shape len rr2s dcnl dcsp dcsp sum axis none dcnl dcsp out np empty out shape dcnl dcsp rr2 np concatenate rr2s dcnl dcsp lr2 np concatenate lr2s dcnl dcsp cosmags2 np concatenate cosmags2s dcnl dcsp ct np einsum ik jk ij rr1 orig rr2 dcnl dcsp np clip ct 1 1 ct dcnl dcsp rr1 rr1 orig np newaxis dcnl dcsp rr2 rr2np newaxis dcnl dcsp lr1lr2 lr1 np newaxis lr2np newaxis dcnl dcsp beta r r lr1lr2 dcnl dcsp if ch type meg dcnl dcsp dcsp sums comp sums meg beta flatten ct flatten lut n fact volume integral dcnl dcsp dcsp sums shape 4 + beta shape dcnl dcsp dcsp n1c1 np einsum ik ijk ij cosmags1 rr1 dcnl dcsp dcsp n1c2 np einsum ik ijk ij cosmags1 rr2 dcnl dcsp dcsp n2c1 np einsum jk ijk ij cosmags2 rr1 dcnl dcsp dcsp n2c2 np einsum jk ijk ij cosmags2 rr2 dcnl dcsp dcsp n1n2 np einsum ik jk ij cosmags1 cosmags2 dcnl dcsp dcsp part1 ct n1c1 n2c2 dcnl dcsp dcsp part2 n1c1 n2c1 + n1c2 n2c2 dcnl dcsp dcsp result n1c1 n2c2 sums0 + 2 0 part1 part2 sums1 + n1n2 + part1 part2 sums2 + n1c2 ct n1c1 n2c1 ct n2c2 sums3 dcnl dcsp dcsp result meg const lr1lr2 dcnl dcsp dcsp if volume integral dcnl dcsp dcsp dcsp result r dcnl dcsp else dcnl dcsp dcsp result comp sum eeg beta flatten ct flatten lut n fact dcnl dcsp dcsp result shape beta shape dcnl dcsp dcsp result eeg const dcnl dcsp dcsp result lr1lr2 dcnl dcsp offset 0 dcnl dcsp result np concatenate w2s dcnl dcsp if w1 is not none dcnl dcsp dcsp result w1 np newaxis dcnl dcsp for ii w2 in enumerate w2s dcnl dcsp dcsp outii np sum result offset offset + len w2 axis sum axis dcnl dcsp dcsp offset + len w2 dcnl dcsp return out
def do self dots intrad volume coils r0 ch type lut n fact n jobs dcsp if ch type eeg dcnl dcsp dcsp intrad 0 7 dcnl dcsp rmags coil rmag r0np newaxis for coil in coils dcnl dcsp rlens np sqrt np sum r r axis 1 for r in rmags dcnl dcsp rmags r rl np newaxis for r rl in zip rmags rlens dcnl dcsp cosmags coil cosmag for coil in coils dcnl dcsp ws coil w for coil in coils dcnl dcsp parallel p fun parallel func do self dots subset n jobs dcnl dcsp prods parallel p fun intrad rmags rlens cosmags ws volume lut n fact ch type idx for idx in np array split np arange len rmags n jobs dcnl dcsp products np sum prods axis 0 dcnl dcsp return products
def do self dots subset intrad rmags rlens cosmags ws volume lut n fact ch type idx dcsp products np zeros len rmags len rmags dcnl dcsp for ci1 in idx dcnl dcsp dcsp ci2 ci1 + 1 dcnl dcsp dcsp res fast sphere dot r0 intrad rmagsci1 rmags ci2 rlensci1 rlens ci2 cosmagsci1 cosmags ci2 wsci1 ws ci2 volume lut n fact ch type dcnl dcsp dcsp productsci1 ci2 res dcnl dcsp dcsp products ci2 ci1 res dcnl dcsp return products
def do cross dots intrad volume coils1 coils2 r0 ch type lut n fact dcsp rmags1 coil rmag r0np newaxis for coil in coils1 dcnl dcsp rmags2 coil rmag r0np newaxis for coil in coils2 dcnl dcsp rlens1 np sqrt np sum r r axis 1 for r in rmags1 dcnl dcsp rlens2 np sqrt np sum r r axis 1 for r in rmags2 dcnl dcsp rmags1 r rl np newaxis for r rl in zip rmags1 rlens1 dcnl dcsp rmags2 r rl np newaxis for r rl in zip rmags2 rlens2 dcnl dcsp ws1 coil w for coil in coils1 dcnl dcsp ws2 coil w for coil in coils2 dcnl dcsp cosmags1 coil cosmag for coil in coils1 dcnl dcsp cosmags2 coil cosmag for coil in coils2 dcnl dcsp products np zeros len rmags1 len rmags2 dcnl dcsp for ci1 in range len coils1 dcnl dcsp dcsp res fast sphere dot r0 intrad rmags1ci1 rmags2 rlens1ci1 rlens2 cosmags1ci1 cosmags2 ws1ci1 ws2 volume lut n fact ch type dcnl dcsp dcsp productsci1 res dcnl dcsp return products
def do surface dots intrad volume coils surf sel r0 ch type lut n fact n jobs dcsp rmags coil rmag r0np newaxis for coil in coils dcnl dcsp rlens np sqrt np sum r r axis 1 for r in rmags dcnl dcsp rmags r rl np newaxis for r rl in zip rmags rlens dcnl dcsp cosmags coil cosmag for coil in coils dcnl dcsp ws coil w for coil in coils dcnl dcsp rref none dcnl dcsp refl none dcnl dcsp if ch type eeg dcnl dcsp dcsp intrad 0 7 dcnl dcsp rsurf surf rr sel r0np newaxis dcnl dcsp lsurf np sqrt np sum rsurf rsurf axis 1 dcnl dcsp rsurf lsurf np newaxis dcnl dcsp this nn surf nn sel dcnl dcsp parallel p fun parallel func do surface dots subset n jobs dcnl dcsp prods parallel p fun intrad rsurf rmags rref refl lsurf rlens this nn cosmags ws volume lut n fact ch type idx for idx in np array split np arange len rmags n jobs dcnl dcsp products np sum prods axis 0 dcnl dcsp return products
def do surface dots subset intrad rsurf rmags rref refl lsurf rlens this nn cosmags ws volume lut n fact ch type idx dcsp products fast sphere dot r0 intrad rsurf rmags lsurf rlens this nn cosmags none ws volume lut n fact ch type t dcnl dcsp if rref is not none dcnl dcsp dcsp raise notimplementederror dcnl dcsp return products
def block diag a n dcsp if sparse issparse a dcnl dcsp dcsp raise notimplemented sparse dcsp reversal dcsp not dcsp implemented dcsp yet dcnl dcsp ma na a shape dcnl dcsp bdn na int n dcnl dcsp if na n 0 dcnl dcsp dcsp raise valueerror width dcsp of dcsp matrix dcsp must dcsp be dcsp a dcsp multiple dcsp of dcsp n dcnl dcsp tmp np arange ma bdn dtype np int reshape bdn ma dcnl dcsp tmp np tile tmp 1 n dcnl dcsp ii tmp ravel dcnl dcsp jj np arange na dtype np int none dcnl dcsp jj jj np ones ma dtype np int none dcnl dcsp jj jj t ravel dcnl dcsp bd sparse coo matrix a t ravel np c ii jj t tocsc dcnl dcsp return bd
def inv block diag a n dcsp ma na a shape dcnl dcsp bdn na int n dcnl dcsp if na n 0 dcnl dcsp dcsp raise valueerror width dcsp of dcsp matrix dcsp must dcsp be dcsp a dcsp multiple dcsp of dcsp n dcnl dcsp a a copy dcnl dcsp for start in range 0 na 3 dcnl dcsp dcsp a start start + 3 linalg inv a start start + 3 dcnl dcsp tmp np arange ma bdn dtype np int reshape bdn ma dcnl dcsp tmp np tile tmp 1 n dcnl dcsp ii tmp ravel dcnl dcsp jj np arange na dtype np int none dcnl dcsp jj jj np ones ma dtype np int none dcnl dcsp jj jj t ravel dcnl dcsp bd sparse coo matrix a t ravel np c ii jj t tocsc dcnl dcsp return bd
def get tag int fid node name id dcsp tag find tag fid node id dcnl dcsp if tag is none dcnl dcsp dcsp fid close dcnl dcsp dcsp raise valueerror name + dcsp tag dcsp not dcsp found dcnl dcsp return int tag data
def read one fid node dcsp if node is none dcnl dcsp dcsp return none dcnl dcsp one forward dcnl dcsp one source ori get tag int fid node source dcsp orientation fiff fiff mne source orientation dcnl dcsp one coord frame get tag int fid node coordinate dcsp frame fiff fiff mne coord frame dcnl dcsp one nsource get tag int fid node number dcsp of dcsp sources fiff fiff mne source space npoints dcnl dcsp one nchan get tag int fid node number dcsp of dcsp channels fiff fiff nchan dcnl dcsp try dcnl dcsp dcsp one sol read named matrix fid node fiff fiff mne forward solution transpose true dcnl dcsp dcsp one orig sol one sol data copy dcnl dcsp except exception dcnl dcsp dcsp logger error forward dcsp solution dcsp data dcsp not dcsp found dcnl dcsp dcsp raise dcnl dcsp try dcnl dcsp dcsp fwd type fiff fiff mne forward solution grad dcnl dcsp dcsp one sol grad read named matrix fid node fwd type transpose true dcnl dcsp dcsp one orig sol grad one sol grad data copy dcnl dcsp except exception dcnl dcsp dcsp one sol grad none dcnl dcsp if one sol data shape0 one nchan or one sol data shape1 one nsource and one sol data shape1 3 one nsource dcnl dcsp dcsp raise valueerror forward dcsp solution dcsp matrix dcsp has dcsp wrong dcsp dimensions dcnl dcsp if one sol grad is not none dcnl dcsp dcsp if one sol grad data shape0 one nchan or one sol grad data shape1 3 one nsource and one sol grad data shape1 3 3 one nsource dcnl dcsp dcsp dcsp raise valueerror forward dcsp solution dcsp gradient dcsp matrix dcsp has dcsp wrong dcsp dimensions dcnl dcsp return one
def read forward meas info tree fid dcsp info info dcnl dcsp parent mri dir tree find tree fiff fiffb mne parent mri file dcnl dcsp if len parent mri 0 dcnl dcsp dcsp raise valueerror no dcsp parent dcsp meg dcsp information dcsp found dcsp in dcsp operator dcnl dcsp parent mri parent mri0 dcnl dcsp tag find tag fid parent mri fiff fiff mne file name dcnl dcsp info mri file tag data if tag is not none else none dcnl dcsp tag find tag fid parent mri fiff fiff parent file id dcnl dcsp info mri id tag data if tag is not none else none dcnl dcsp parent meg dir tree find tree fiff fiffb mne parent meas file dcnl dcsp if len parent meg 0 dcnl dcsp dcsp raise valueerror no dcsp parent dcsp meg dcsp information dcsp found dcsp in dcsp operator dcnl dcsp parent meg parent meg0 dcnl dcsp tag find tag fid parent meg fiff fiff mne file name dcnl dcsp info meas file tag data if tag is not none else none dcnl dcsp tag find tag fid parent meg fiff fiff parent file id dcnl dcsp info meas id tag data if tag is not none else none dcnl dcsp chs list dcnl dcsp for k in range parent meg nent dcnl dcsp dcsp kind parent meg directory k kind dcnl dcsp dcsp pos parent meg directory k pos dcnl dcsp dcsp if kind fiff fiff ch info dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp chs append tag data dcnl dcsp info chs chs dcnl dcsp info update redundant dcnl dcsp tag find tag fid parent mri fiff fiff coord trans dcnl dcsp coord head fiff fiffv coord head dcnl dcsp coord mri fiff fiffv coord mri dcnl dcsp coord device fiff fiffv coord device dcnl dcsp coord ctf head fiff fiffv mne coord ctf head dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror mri head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp cand tag data dcnl dcsp if cand from coord mri and cand to coord head dcnl dcsp dcsp info mri head t cand dcnl dcsp else dcnl dcsp dcsp raise valueerror mri head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp tag find tag fid parent meg fiff fiff coord trans dcnl dcsp if tag is none dcnl dcsp dcsp raise valueerror meg head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp cand tag data dcnl dcsp if cand from coord device and cand to coord head dcnl dcsp dcsp info dev head t cand dcnl dcsp elif cand from coord ctf head and cand to coord head dcnl dcsp dcsp info ctf head t cand dcnl dcsp else dcnl dcsp dcsp raise valueerror meg head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp info bads read bad channels fid parent meg dcnl dcsp info bads bad for bad in info bads if bad in info ch names dcnl dcsp tag find tag fid parent mri fiff fiff mne custom ref dcnl dcsp if tag is none dcnl dcsp dcsp tag find tag fid parent mri 236 dcnl dcsp info custom ref applied bool tag data if tag is not none else false dcnl dcsp info check consistency dcnl dcsp return info
def subject from forward forward dcsp return forward src 0 get subject his id none
verbose dcnl def merge meg eeg fwds megfwd eegfwd verbose none dcsp if megfwd is not none and eegfwd is not none dcnl dcsp dcsp if megfwd sol data shape1 eegfwd sol data shape1 or megfwd source ori eegfwd source ori or megfwd nsource eegfwd nsource or megfwd coord frame eegfwd coord frame dcnl dcsp dcsp dcsp raise valueerror the dcsp meg dcsp and dcsp eeg dcsp forward dcsp solutions dcsp do dcsp not dcsp match dcnl dcsp dcsp fwd megfwd dcnl dcsp dcsp fwd sol data np r fwd sol data eegfwd sol data dcnl dcsp dcsp fwd orig sol np r fwd orig sol eegfwd orig sol dcnl dcsp dcsp fwd sol nrow fwd sol nrow + eegfwd sol nrow dcnl dcsp dcsp fwd sol row names fwd sol row names + eegfwd sol row names dcnl dcsp dcsp if fwd sol grad is not none dcnl dcsp dcsp dcsp fwd sol grad data np r fwd sol grad data eegfwd sol grad data dcnl dcsp dcsp dcsp fwd orig sol grad np r fwd orig sol grad eegfwd orig sol grad dcnl dcsp dcsp dcsp fwd sol grad nrow fwd sol grad nrow + eegfwd sol grad nrow dcnl dcsp dcsp dcsp fwd sol grad row names fwd sol grad row names + eegfwd sol grad row names dcnl dcsp dcsp fwd nchan fwd nchan + eegfwd nchan dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp meg dcsp and dcsp eeg dcsp forward dcsp solutions dcsp combined dcnl dcsp elif megfwd is not none dcnl dcsp dcsp fwd megfwd dcnl dcsp else dcnl dcsp dcsp fwd eegfwd dcnl dcsp return fwd
verbose dcnl def read forward solution fname force fixed false surf ori false include exclude verbose none dcsp check fname fname forward fwd fif fwd fif gz dcnl dcsp logger info reading dcsp forward dcsp solution dcsp from dcsp s fname dcnl dcsp f tree fiff open fname dcnl dcsp with f as fid dcnl dcsp dcsp fwds dir tree find tree fiff fiffb mne forward solution dcnl dcsp dcsp if len fwds 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp forward dcsp solutions dcsp in dcsp s fname dcnl dcsp dcsp parent mri dir tree find tree fiff fiffb mne parent mri file dcnl dcsp dcsp if len parent mri 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp parent dcsp mri dcsp information dcsp in dcsp s fname dcnl dcsp dcsp parent mri parent mri0 dcnl dcsp dcsp src read source spaces from tree fid tree patch stats false dcnl dcsp dcsp for s in src dcnl dcsp dcsp dcsp s id find source space hemi s dcnl dcsp dcsp fwd none dcnl dcsp dcsp megnode none dcnl dcsp dcsp eegnode none dcnl dcsp dcsp for k in range len fwds dcnl dcsp dcsp dcsp tag find tag fid fwdsk fiff fiff mne included methods dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp raise valueerror methods dcsp not dcsp listed dcsp for dcsp one dcsp of dcsp the dcsp forward dcsp solutions dcnl dcsp dcsp dcsp if tag data fiff fiffv mne meg dcnl dcsp dcsp dcsp dcsp megnode fwdsk dcnl dcsp dcsp dcsp elif tag data fiff fiffv mne eeg dcnl dcsp dcsp dcsp dcsp eegnode fwdsk dcnl dcsp dcsp megfwd read one fid megnode dcnl dcsp dcsp if megfwd is not none dcnl dcsp dcsp dcsp if is fixed orient megfwd dcnl dcsp dcsp dcsp dcsp ori fixed dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ori free dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp read dcsp meg dcsp forward dcsp solution dcsp d dcsp sources dcsp d dcsp channels dcsp s dcsp orientations megfwd nsource megfwd nchan ori dcnl dcsp dcsp eegfwd read one fid eegnode dcnl dcsp dcsp if eegfwd is not none dcnl dcsp dcsp dcsp if is fixed orient eegfwd dcnl dcsp dcsp dcsp dcsp ori fixed dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ori free dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp read dcsp eeg dcsp forward dcsp solution dcsp d dcsp sources dcsp d dcsp channels dcsp s dcsp orientations eegfwd nsource eegfwd nchan ori dcnl dcsp dcsp fwd merge meg eeg fwds megfwd eegfwd dcnl dcsp dcsp tag find tag fid parent mri fiff fiff coord trans dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise valueerror mri head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp dcsp mri head t tag data dcnl dcsp dcsp if mri head t from fiff fiffv coord mri or mri head t to fiff fiffv coord head dcnl dcsp dcsp dcsp mri head t invert transform mri head t dcnl dcsp dcsp dcsp if mri head t from fiff fiffv coord mri or mri head t to fiff fiffv coord head dcnl dcsp dcsp dcsp dcsp fid close dcnl dcsp dcsp dcsp dcsp raise valueerror mri head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp dcsp fwd mri head t mri head t dcnl dcsp dcsp fwd info read forward meas info tree fid dcnl dcsp dcsp parent env dir tree find tree fiff fiffb mne env dcnl dcsp dcsp if len parent env 0 dcnl dcsp dcsp dcsp parent env parent env0 dcnl dcsp dcsp dcsp tag find tag fid parent env fiff fiff mne env working dir dcnl dcsp dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp dcsp fwd info working dir tag data dcnl dcsp dcsp dcsp tag find tag fid parent env fiff fiff mne env command line dcnl dcsp dcsp dcsp if tag is not none dcnl dcsp dcsp dcsp dcsp fwd info command line tag data dcnl dcsp if fwd coord frame not in fiff fiffv coord mri fiff fiffv coord head dcnl dcsp dcsp raise valueerror only dcsp forward dcsp solutions dcsp computed dcsp in dcsp mri dcsp or dcsp head dcsp coordinates dcsp are dcsp acceptable dcnl dcsp nuse 0 dcnl dcsp for s in src dcnl dcsp dcsp try dcnl dcsp dcsp dcsp s transform surface to s fwd coord frame mri head t dcnl dcsp dcsp except exception as inst dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp transform dcsp source dcsp space dcsp s inst dcnl dcsp dcsp nuse + s nuse dcnl dcsp if nuse fwd nsource dcnl dcsp dcsp raise valueerror source dcsp spaces dcsp do dcsp not dcsp match dcsp the dcsp forward dcsp solution dcnl dcsp logger info dcsp dcsp dcsp dcsp source dcsp spaces dcsp transformed dcsp to dcsp the dcsp forward dcsp solution dcsp coordinate dcsp frame dcnl dcsp fwd src src dcnl dcsp fwd source rr np concatenate ss rr ss vertno for ss in src axis 0 dcnl dcsp fwd orig source ori fwd source ori dcnl dcsp convert forward solution fwd surf ori force fixed copy false dcnl dcsp fwd pick channels forward fwd include include exclude exclude dcnl dcsp return forward fwd
verbose dcnl def convert forward solution fwd surf ori false force fixed false copy true verbose none dcsp fwd fwd copy if copy else fwd dcnl dcsp if is fixed orient fwd orig true or force fixed dcnl dcsp dcsp nuse 0 dcnl dcsp dcsp fwd source nn np concatenate s nn s vertno for s in fwd src axis 0 dcnl dcsp dcsp if not is fixed orient fwd orig true dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp changing dcsp to dcsp fixedorientation dcsp forward dcsp solution dcsp with dcsp surfacebased dcsp source dcsp orientations dcnl dcsp dcsp dcsp fix rot block diag fwd source nn t 1 dcnl dcsp dcsp dcsp fwd sol data fwd orig sol fix rot astype float32 dcnl dcsp dcsp dcsp fwd sol ncol fwd nsource dcnl dcsp dcsp dcsp fwd source ori fiff fiffv mne fixed ori dcnl dcsp dcsp dcsp if fwd sol grad is not none dcnl dcsp dcsp dcsp dcsp x sparse block diag fix rot 3 dcnl dcsp dcsp dcsp dcsp fwd sol grad data fwd orig sol grad x dcnl dcsp dcsp dcsp dcsp fwd sol grad ncol 3 fwd nsource dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp done dcnl dcsp dcsp fwd source ori fiff fiffv mne fixed ori dcnl dcsp dcsp fwd surf ori true dcnl dcsp elif surf ori dcnl dcsp dcsp nuse total sum s nuse for s in fwd src dcnl dcsp dcsp fwd source nn np empty 3 nuse total 3 dtype np float dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp converting dcsp to dcsp surfacebased dcsp source dcsp orientations dcnl dcsp dcsp if fwd src 0 patch inds is not none dcnl dcsp dcsp dcsp use ave nn true dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp average dcsp patch dcsp normals dcsp will dcsp be dcsp employed dcsp in dcsp the dcsp rotation dcsp to dcsp the dcsp local dcsp surface dcsp coordinates dcnl dcsp dcsp else dcnl dcsp dcsp dcsp use ave nn false dcnl dcsp dcsp nuse 0 dcnl dcsp dcsp pp 0 dcnl dcsp dcsp for s in fwd src dcnl dcsp dcsp dcsp for p in range s nuse dcnl dcsp dcsp dcsp dcsp if use ave nn is true dcnl dcsp dcsp dcsp dcsp dcsp nn s nn s pinfo s patch inds p dcnl dcsp dcsp dcsp dcsp dcsp nn np sum nn axis 0 np newaxis dcnl dcsp dcsp dcsp dcsp dcsp nn linalg norm nn dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp nn s nn s vertno p np newaxis dcnl dcsp dcsp dcsp dcsp u s linalg svd np eye 3 3 nn nn t dcnl dcsp dcsp dcsp dcsp if np sum nn ravel u 2 ravel < 0 dcnl dcsp dcsp dcsp dcsp dcsp u 1 0 dcnl dcsp dcsp dcsp dcsp fwd source nn pp pp + 3 u t dcnl dcsp dcsp dcsp dcsp pp + 3 dcnl dcsp dcsp dcsp nuse + s nuse dcnl dcsp dcsp surf rot block diag fwd source nn t 3 dcnl dcsp dcsp fwd sol data fwd orig sol surf rot dcnl dcsp dcsp fwd sol ncol 3 fwd nsource dcnl dcsp dcsp if fwd sol grad is not none dcnl dcsp dcsp dcsp x sparse block diag surf rot 3 dcnl dcsp dcsp dcsp fwd sol grad data fwd orig sol grad x dcnl dcsp dcsp dcsp fwd sol grad ncol 3 fwd nsource dcnl dcsp dcsp logger info done dcnl dcsp dcsp fwd source ori fiff fiffv mne free ori dcnl dcsp dcsp fwd surf ori true dcnl dcsp else dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp cartesian dcsp source dcsp orientations dcnl dcsp dcsp fwd source nn np kron np ones fwd nsource 1 np eye 3 dcnl dcsp dcsp fwd sol data fwd orig sol copy dcnl dcsp dcsp fwd sol ncol 3 fwd nsource dcnl dcsp dcsp if fwd sol grad is not none dcnl dcsp dcsp dcsp fwd sol grad data fwd orig sol grad copy dcnl dcsp dcsp dcsp fwd sol grad ncol 3 fwd nsource dcnl dcsp dcsp fwd source ori fiff fiffv mne free ori dcnl dcsp dcsp fwd surf ori false dcnl dcsp dcsp logger info done dcnl dcsp return fwd
verbose dcnl def write forward solution fname fwd overwrite false verbose none dcsp check fname fname forward fwd fif fwd fif gz dcnl dcsp check fname fname overwrite dcnl dcsp fid start file fname dcnl dcsp start block fid fiff fiffb mne dcnl dcsp start block fid fiff fiffb mne env dcnl dcsp write id fid fiff fiff block id dcnl dcsp data fwd info get working dir none dcnl dcsp if data is not none dcnl dcsp dcsp write string fid fiff fiff mne env working dir data dcnl dcsp data fwd info get command line none dcnl dcsp if data is not none dcnl dcsp dcsp write string fid fiff fiff mne env command line data dcnl dcsp end block fid fiff fiffb mne env dcnl dcsp start block fid fiff fiffb mne parent mri file dcnl dcsp write string fid fiff fiff mne file name fwd info mri file dcnl dcsp if fwd info mri id is not none dcnl dcsp dcsp write id fid fiff fiff parent file id fwd info mri id dcnl dcsp write coord trans fid fwd info mri head t dcnl dcsp end block fid fiff fiffb mne parent mri file dcnl dcsp write forward meas info fid fwd info dcnl dcsp src list dcnl dcsp for s in fwd src dcnl dcsp dcsp s deepcopy s dcnl dcsp dcsp try dcnl dcsp dcsp dcsp s transform surface to s fwd mri head t from fwd mri head t dcnl dcsp dcsp except exception as inst dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp transform dcsp source dcsp space dcsp s inst dcnl dcsp dcsp src append s dcnl dcsp write source spaces to fid fid src dcnl dcsp n vert sum ss nuse for ss in src dcnl dcsp n col fwd sol data shape1 dcnl dcsp if fwd source ori fiff fiffv mne fixed ori dcnl dcsp dcsp assert n col n vert dcnl dcsp else dcnl dcsp dcsp assert n col 3 n vert dcnl dcsp sol fwd sol data dcnl dcsp if fwd sol grad is not none dcnl dcsp dcsp sol grad fwd sol grad data dcnl dcsp else dcnl dcsp dcsp sol grad none dcnl dcsp if fwd surf ori is true dcnl dcsp dcsp inv rot inv block diag fwd source nn t 3 dcnl dcsp dcsp sol sol inv rot dcnl dcsp dcsp if sol grad is not none dcnl dcsp dcsp dcsp sol grad sol grad sparse block diag inv rot 3 dcnl dcsp picks meg pick types fwd info meg true eeg false ref meg false exclude dcnl dcsp picks eeg pick types fwd info meg false eeg true ref meg false exclude dcnl dcsp n meg len picks meg dcnl dcsp n eeg len picks eeg dcnl dcsp row names meg fwd sol row names p for p in picks meg dcnl dcsp row names eeg fwd sol row names p for p in picks eeg dcnl dcsp if n meg 0 dcnl dcsp dcsp meg solution dict data solpicks meg nrow n meg ncol n col row names row names meg col names dcnl dcsp dcsp transpose named matrix meg solution dcnl dcsp dcsp start block fid fiff fiffb mne forward solution dcnl dcsp dcsp write int fid fiff fiff mne included methods fiff fiffv mne meg dcnl dcsp dcsp write int fid fiff fiff mne coord frame fwd coord frame dcnl dcsp dcsp write int fid fiff fiff mne source orientation fwd source ori dcnl dcsp dcsp write int fid fiff fiff mne source space npoints n vert dcnl dcsp dcsp write int fid fiff fiff nchan n meg dcnl dcsp dcsp write named matrix fid fiff fiff mne forward solution meg solution dcnl dcsp dcsp if sol grad is not none dcnl dcsp dcsp dcsp meg solution grad dict data sol gradpicks meg nrow n meg ncol n col 3 row names row names meg col names dcnl dcsp dcsp dcsp transpose named matrix meg solution grad dcnl dcsp dcsp dcsp write named matrix fid fiff fiff mne forward solution grad meg solution grad dcnl dcsp dcsp end block fid fiff fiffb mne forward solution dcnl dcsp if n eeg 0 dcnl dcsp dcsp eeg solution dict data solpicks eeg nrow n eeg ncol n col row names row names eeg col names dcnl dcsp dcsp transpose named matrix eeg solution dcnl dcsp dcsp start block fid fiff fiffb mne forward solution dcnl dcsp dcsp write int fid fiff fiff mne included methods fiff fiffv mne eeg dcnl dcsp dcsp write int fid fiff fiff mne coord frame fwd coord frame dcnl dcsp dcsp write int fid fiff fiff mne source orientation fwd source ori dcnl dcsp dcsp write int fid fiff fiff nchan n eeg dcnl dcsp dcsp write int fid fiff fiff mne source space npoints n vert dcnl dcsp dcsp write named matrix fid fiff fiff mne forward solution eeg solution dcnl dcsp dcsp if sol grad is not none dcnl dcsp dcsp dcsp eeg solution grad dict data sol gradpicks eeg nrow n eeg ncol n col 3 row names row names eeg col names dcnl dcsp dcsp dcsp transpose named matrix eeg solution grad dcnl dcsp dcsp dcsp write named matrix fid fiff fiff mne forward solution grad eeg solution grad dcnl dcsp dcsp end block fid fiff fiffb mne forward solution dcnl dcsp end block fid fiff fiffb mne dcnl dcsp end file fid
def to fixed ori forward dcsp if not forward surf ori or is fixed orient forward dcnl dcsp dcsp raise valueerror only dcsp surfaceoriented dcsp freeorientation dcsp forward dcsp solutions dcsp can dcsp be dcsp converted dcsp to dcsp fixed dcsp orientaton dcnl dcsp forward sol data forward sol data 2 3 dcnl dcsp forward sol ncol forward sol ncol 3 dcnl dcsp forward source ori fiff fiffv mne fixed ori dcnl dcsp logger info dcsp dcsp dcsp dcsp converted dcsp the dcsp forward dcsp solution dcsp into dcsp the dcsp fixedorientation dcsp mode dcnl dcsp return forward
def is fixed orient forward orig false dcsp if orig dcnl dcsp dcsp fixed ori forward orig source ori fiff fiffv mne fixed ori dcnl dcsp else dcnl dcsp dcsp fixed ori forward source ori fiff fiffv mne fixed ori dcnl dcsp return fixed ori
def write forward meas info fid info dcsp info check consistency dcnl dcsp start block fid fiff fiffb mne parent meas file dcnl dcsp write string fid fiff fiff mne file name info meas file dcnl dcsp if info meas id is not none dcnl dcsp dcsp write id fid fiff fiff parent block id info meas id dcnl dcsp meg head t info get dev head t info get ctf head t dcnl dcsp if meg head t is none dcnl dcsp dcsp fid close dcnl dcsp dcsp raise valueerror head< sensor dcsp transform dcsp not dcsp found dcnl dcsp write coord trans fid meg head t dcnl dcsp if chs in info dcnl dcsp dcsp write int fid fiff fiff nchan len info chs dcnl dcsp dcsp for k c in enumerate info chs dcnl dcsp dcsp dcsp c deepcopy c dcnl dcsp dcsp dcsp c scanno k + 1 dcnl dcsp dcsp dcsp write ch info fid c dcnl dcsp if bads in info and len info bads 0 dcnl dcsp dcsp start block fid fiff fiffb mne bad channels dcnl dcsp dcsp write name list fid fiff fiff mne ch name list info bads dcnl dcsp dcsp end block fid fiff fiffb mne bad channels dcnl dcsp end block fid fiff fiffb mne parent meas file
verbose dcnl def compute orient prior forward loose 0 2 verbose none dcsp is fixed ori is fixed orient forward dcnl dcsp n sources forward sol data shape1 dcnl dcsp if loose is not none dcnl dcsp dcsp if not 0 < loose < 1 dcnl dcsp dcsp dcsp raise valueerror loose dcsp value dcsp should dcsp be dcsp smaller dcsp than dcsp 1 dcsp and dcsp bigger dcsp than dcsp 0 dcsp or dcsp none dcsp for dcsp not dcsp loose dcsp orientations dcnl dcsp dcsp if loose < 1 and not forward surf ori dcnl dcsp dcsp dcsp raise valueerror forward dcsp operator dcsp is dcsp not dcsp oriented dcsp in dcsp surface dcsp coordinates dcsp loose dcsp parameter dcsp should dcsp be dcsp none dcsp not dcsp s loose dcnl dcsp dcsp if is fixed ori dcnl dcsp dcsp dcsp warn ignoring dcsp loose dcsp parameter dcsp with dcsp forward dcsp operator dcsp with dcsp fixed dcsp orientation dcnl dcsp orient prior np ones n sources dtype np float dcnl dcsp if not is fixed ori and loose is not none and loose < 1 dcnl dcsp dcsp logger info applying dcsp loose dcsp dipole dcsp orientations dcsp loose dcsp value dcsp of dcsp s loose dcnl dcsp dcsp orient prior np mod np arange n sources 3 2 loose dcnl dcsp return orient prior
def restrict gain matrix g info dcsp if not len info chs g shape0 dcnl dcsp dcsp raise valueerror g shape0 dcsp and dcsp length dcsp of dcsp info chs dcsp do dcsp not dcsp match dcsp d dcsp dcsp d g shape0 len info chs dcnl dcsp sel pick types info meg grad ref meg false exclude dcnl dcsp if len sel 0 dcnl dcsp dcsp g gsel dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp d dcsp planar dcsp channels len sel dcnl dcsp else dcnl dcsp dcsp sel pick types info meg mag ref meg false exclude dcnl dcsp dcsp if len sel 0 dcnl dcsp dcsp dcsp g gsel dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp d dcsp magnetometer dcsp or dcsp axial dcsp gradiometer dcsp channels len sel dcnl dcsp dcsp else dcnl dcsp dcsp dcsp sel pick types info meg false eeg true exclude dcnl dcsp dcsp dcsp if len sel 0 dcnl dcsp dcsp dcsp dcsp g gsel dcnl dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp d dcsp eeg dcsp channels len sel dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp warn could dcsp not dcsp find dcsp meg dcsp or dcsp eeg dcsp channels dcnl dcsp return g
def compute depth prior g gain info is fixed ori exp 0 8 limit 10 0 patch areas none limit depth chs false dcsp logger info creating dcsp the dcsp depth dcsp weighting dcsp matrix dcnl dcsp if limit depth chs is true dcnl dcsp dcsp g restrict gain matrix g gain info dcnl dcsp if is fixed ori dcnl dcsp dcsp d np sum g 2 axis 0 dcnl dcsp else dcnl dcsp dcsp n pos g shape1 3 dcnl dcsp dcsp d np zeros n pos dcnl dcsp dcsp for k in range n pos dcnl dcsp dcsp dcsp gk g 3 k 3 k + 1 dcnl dcsp dcsp dcsp dk linalg svdvals np dot gk t gk 0 dcnl dcsp if patch areas is not none dcnl dcsp dcsp d patch areas 2 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp patch dcsp areas dcsp taken dcsp into dcsp account dcsp in dcsp the dcsp depth dcsp weighting dcnl dcsp w 1 0 d dcnl dcsp ws np sort w dcnl dcsp weight limit limit 2 dcnl dcsp if limit depth chs is false dcnl dcsp dcsp ind np argmin ws dcnl dcsp dcsp n limit ind dcnl dcsp dcsp limit wsind weight limit dcnl dcsp dcsp wpp np minimum w limit 1 exp dcnl dcsp else dcnl dcsp dcsp limit ws 1 dcnl dcsp dcsp n limit len d dcnl dcsp dcsp if ws 1 weight limit ws0 dcnl dcsp dcsp dcsp ind np where ws weight limit ws0 00 dcnl dcsp dcsp dcsp limit wsind dcnl dcsp dcsp dcsp n limit ind dcnl dcsp logger info dcsp dcsp dcsp dcsp limit dcsp dcsp d d dcsp dcsp f n limit + 1 len d np sqrt limit ws0 dcnl dcsp scale 1 0 limit dcnl dcsp logger info dcsp dcsp dcsp dcsp scale dcsp dcsp g dcsp exp dcsp dcsp g scale exp dcnl dcsp wpp np minimum w limit 1 exp dcnl dcsp depth prior wpp if is fixed ori else np repeat wpp 3 dcnl dcsp return depth prior
def stc src sel src stc dcsp if isinstance stc volsourceestimate dcnl dcsp dcsp vertices stc vertices dcnl dcsp else dcnl dcsp dcsp vertices stc vertices dcnl dcsp if not len src len vertices dcnl dcsp dcsp raise runtimeerror mismatch dcsp between dcsp number dcsp of dcsp source dcsp spaces dcsp s dcsp and dcsp stc dcsp vertices dcsp s len src len vertices dcnl dcsp src sels dcnl dcsp offset 0 dcnl dcsp for s v in zip src vertices dcnl dcsp dcsp src sel np intersect1d s vertno v dcnl dcsp dcsp src sel np searchsorted s vertno src sel dcnl dcsp dcsp src sels append src sel + offset dcnl dcsp dcsp offset + len s vertno dcnl dcsp src sel np concatenate src sels dcnl dcsp return src sel
def fill measurement info info fwd sfreq dcsp sel pick channels info ch names fwd sol row names dcnl dcsp info pick info info sel dcnl dcsp info bads dcnl dcsp info meas id fwd info meas id dcnl dcsp info file id info meas id dcnl dcsp now time dcnl dcsp sec np floor now dcnl dcsp usec 1000000 0 now sec dcnl dcsp info meas date np array sec usec dtype np int32 dcnl dcsp info highpass 0 0 dcnl dcsp info lowpass sfreq 2 0 dcnl dcsp info sfreq sfreq dcnl dcsp info projs dcnl dcsp return info
verbose dcnl def apply forward fwd stc start none stop none verbose none dcsp if not is fixed orient fwd dcnl dcsp dcsp raise valueerror only dcsp fixedorientation dcsp forward dcsp operators dcsp are dcsp supported dcnl dcsp if np all stc data 0 dcnl dcsp dcsp warn source dcsp estimate dcsp only dcsp contains dcsp currents dcsp with dcsp positive dcsp values dcsp use dcsp pick ori normal dcsp when dcsp computing dcsp the dcsp inverse dcsp to dcsp compute dcsp currents dcsp not dcsp current dcsp magnitudes dcnl dcsp max cur np max np abs stc data dcnl dcsp if max cur 1e07 dcnl dcsp dcsp warn the dcsp maximum dcsp current dcsp magnitude dcsp is dcsp 0 1f dcsp nam dcsp which dcsp is dcsp very dcsp large dcsp are dcsp you dcsp trying dcsp to dcsp apply dcsp the dcsp forward dcsp model dcsp to dcsp dspm dcsp values dcsp the dcsp result dcsp will dcsp only dcsp be dcsp correct dcsp if dcsp currents dcsp are dcsp used 1000000000 0 max cur dcnl dcsp src sel stc src sel fwd src stc dcnl dcsp if isinstance stc volsourceestimate dcnl dcsp dcsp n src len stc vertices dcnl dcsp else dcnl dcsp dcsp n src sum len v for v in stc vertices dcnl dcsp if len src sel n src dcnl dcsp dcsp raise runtimeerror only dcsp i dcsp of dcsp i dcsp sourceestimate dcsp vertices dcsp found dcsp in dcsp fwd len src sel n src dcnl dcsp gain fwd sol data src sel dcnl dcsp logger info projecting dcsp source dcsp estimate dcsp to dcsp sensor dcsp space dcnl dcsp data np dot gain stc data start stop dcnl dcsp logger info done dcnl dcsp times deepcopy stc timesstart stop dcnl dcsp return data times
verbose dcnl def apply forward fwd stc info start none stop none verbose none dcsp for ch name in fwd sol row names dcnl dcsp dcsp if ch name not in info ch names dcnl dcsp dcsp dcsp raise valueerror channel dcsp s dcsp of dcsp forward dcsp operator dcsp not dcsp present dcsp in dcsp evoked template ch name dcnl dcsp data times apply forward fwd stc start stop dcnl dcsp sfreq float 1 0 stc tstep dcnl dcsp info out fill measurement info info fwd sfreq dcnl dcsp evoked evokedarray data info out times0 nave 1 dcnl dcsp evoked times times dcnl dcsp evoked first int np round evoked times0 sfreq dcnl dcsp evoked last evoked first + evoked data shape1 1 dcnl dcsp return evoked
verbose dcnl def apply forward raw fwd stc info start none stop none verbose none dcsp for ch name in fwd sol row names dcnl dcsp dcsp if ch name not in info ch names dcnl dcsp dcsp dcsp raise valueerror channel dcsp s dcsp of dcsp forward dcsp operator dcsp not dcsp present dcsp in dcsp info ch name dcnl dcsp data times apply forward fwd stc start stop dcnl dcsp sfreq 1 0 stc tstep dcnl dcsp info fill measurement info info fwd sfreq dcnl dcsp info projs dcnl dcsp raw rawarray data info dcnl dcsp raw preload true dcnl dcsp raw first samps np array int np round times0 sfreq dcnl dcsp raw last samps np array raw first samp + raw data shape1 1 dcnl dcsp raw projector none dcnl dcsp raw update times dcnl dcsp return raw
def restrict forward to stc fwd stc dcsp fwd out deepcopy fwd dcnl dcsp src sel stc src sel fwd src stc dcnl dcsp fwd out source rr fwd source rr src sel dcnl dcsp fwd out nsource len src sel dcnl dcsp if is fixed orient fwd dcnl dcsp dcsp idx src sel dcnl dcsp else dcnl dcsp dcsp idx 3 src sel none + np arange 3 ravel dcnl dcsp fwd out source nn fwd source nn idx dcnl dcsp fwd out sol data fwd sol data idx dcnl dcsp fwd out sol ncol len idx dcnl dcsp for i in range 2 dcnl dcsp dcsp fwd out src i vertno stc verticesi dcnl dcsp dcsp fwd out src i nuse len stc verticesi dcnl dcsp dcsp fwd out src i inuse fwd src i inuse copy dcnl dcsp dcsp fwd out src i inuse fill 0 dcnl dcsp dcsp fwd out src i inuse stc verticesi 1 dcnl dcsp dcsp fwd out src i use tris np array int dcnl dcsp dcsp fwd out src i nuse tri np array 0 dcnl dcsp return fwd out
def restrict forward to label fwd labels dcsp message labels dcsp must dcsp be dcsp instance dcsp of dcsp label dcsp or dcsp a dcsp list dcsp of dcsp label dcnl dcsp vertices np array int np array int dcnl dcsp if not isinstance labels list dcnl dcsp dcsp labels labels dcnl dcsp for label in labels dcnl dcsp dcsp if not isinstance label label dcnl dcsp dcsp dcsp raise typeerror message + dcsp instead dcsp received dcsp s type label dcnl dcsp dcsp i 0 if label hemi lh else 1 dcnl dcsp dcsp verticesi np append verticesi label vertices dcnl dcsp vertices np unique vert hemi for vert hemi in vertices dcnl dcsp fwd out deepcopy fwd dcnl dcsp fwd out source rr np zeros 0 3 dcnl dcsp fwd out nsource 0 dcnl dcsp fwd out source nn np zeros 0 3 dcnl dcsp fwd out sol data np zeros fwd sol data shape0 0 dcnl dcsp fwd out sol ncol 0 dcnl dcsp nuse lh fwd src 0 nuse dcnl dcsp for i in range 2 dcnl dcsp dcsp fwd out src i vertno np array int dcnl dcsp dcsp fwd out src i nuse 0 dcnl dcsp dcsp fwd out src i inuse fwd src i inuse copy dcnl dcsp dcsp fwd out src i inuse fill 0 dcnl dcsp dcsp fwd out src i use tris np array int dcnl dcsp dcsp fwd out src i nuse tri np array 0 dcnl dcsp dcsp src sel np intersect1d fwd src i vertno verticesi dcnl dcsp dcsp src sel np searchsorted fwd src i vertno src sel dcnl dcsp dcsp vertno fwd src i vertno src sel dcnl dcsp dcsp fwd out src i inuse vertno 1 dcnl dcsp dcsp fwd out src i nuse + len vertno dcnl dcsp dcsp fwd out src i vertno np where fwd out src i inuse 0 dcnl dcsp dcsp src sel + i nuse lh dcnl dcsp dcsp fwd out source rr np vstack fwd out source rr fwd source rr src sel dcnl dcsp dcsp fwd out nsource + len src sel dcnl dcsp dcsp if is fixed orient fwd dcnl dcsp dcsp dcsp idx src sel dcnl dcsp dcsp else dcnl dcsp dcsp dcsp idx 3 src sel none + np arange 3 ravel dcnl dcsp dcsp fwd out source nn np vstack fwd out source nn fwd source nn idx dcnl dcsp dcsp fwd out sol data np hstack fwd out sol data fwd sol data idx dcnl dcsp dcsp fwd out sol ncol + len idx dcnl dcsp return fwd out
def do forward solution subject meas fname none src none spacing none mindist none bem none mri none trans none eeg true meg true fixed false grad false mricoord false overwrite false subjects dir none verbose none dcsp if not has mne c dcnl dcsp dcsp raise runtimeerror mne dcsp command dcsp line dcsp tools dcsp could dcsp not dcsp be dcsp found dcnl dcsp temp dir tempfile mkdtemp dcnl dcsp if fname is none dcnl dcsp dcsp fname op join temp dir tempfwd fif dcnl dcsp check fname fname overwrite dcnl dcsp if not isinstance subject string types dcnl dcsp dcsp raise valueerror subject dcsp must dcsp be dcsp a dcsp string dcnl dcsp if isinstance meas string types dcnl dcsp dcsp if not op isfile meas dcnl dcsp dcsp dcsp raise ioerror measurement dcsp file dcsp s dcsp could dcsp not dcsp be dcsp found meas dcnl dcsp elif isinstance meas baseraw baseepochs evoked dcnl dcsp dcsp meas file op join temp dir info fif dcnl dcsp dcsp write info meas file meas info dcnl dcsp dcsp meas meas file dcnl dcsp else dcnl dcsp dcsp raise valueerror meas dcsp must dcsp be dcsp string dcsp raw dcsp epochs dcsp or dcsp evoked dcnl dcsp if mri is not none and trans is not none dcnl dcsp dcsp raise valueerror trans dcsp and dcsp mri dcsp cannot dcsp both dcsp be dcsp specified dcnl dcsp if mri is none and trans is none dcnl dcsp dcsp raise valueerror either dcsp trans dcsp or dcsp mri dcsp must dcsp be dcsp specified dcnl dcsp if trans is not none dcnl dcsp dcsp if not isinstance trans string types dcnl dcsp dcsp dcsp raise valueerror trans dcsp must dcsp be dcsp a dcsp string dcnl dcsp dcsp if not op isfile trans dcnl dcsp dcsp dcsp raise ioerror trans dcsp file dcsp s dcsp not dcsp found trans dcnl dcsp if mri is not none dcnl dcsp dcsp if not isinstance mri string types dcnl dcsp dcsp dcsp if isinstance mri dict dcnl dcsp dcsp dcsp dcsp mri data deepcopy mri dcnl dcsp dcsp dcsp dcsp mri op join temp dir mritrans fif dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp write trans mri mri data dcnl dcsp dcsp dcsp dcsp except exception dcnl dcsp dcsp dcsp dcsp dcsp raise ioerror mri dcsp was dcsp a dcsp dict dcsp but dcsp could dcsp not dcsp be dcsp written dcsp to dcsp disk dcsp as dcsp a dcsp transform dcsp file dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise valueerror trans dcsp must dcsp be dcsp a dcsp string dcsp or dcsp dict dcsp trans dcnl dcsp dcsp if not op isfile mri dcnl dcsp dcsp dcsp raise ioerror trans dcsp file dcsp s dcsp could dcsp not dcsp be dcsp found trans dcnl dcsp if not meg and not eeg dcnl dcsp dcsp raise valueerror meg dcsp or dcsp eeg dcsp or dcsp both dcsp must dcsp be dcsp true dcnl dcsp path fname op split fname dcnl dcsp if not op splitext fname 1 fif dcnl dcsp dcsp raise valueerror forward dcsp name dcsp does dcsp not dcsp end dcsp with dcsp fif dcnl dcsp path op abspath path dcnl dcsp if mindist is not none dcnl dcsp dcsp if isinstance mindist string types dcnl dcsp dcsp dcsp if not mindist lower all dcnl dcsp dcsp dcsp dcsp raise valueerror mindist dcsp if dcsp string dcsp must dcsp be dcsp all dcnl dcsp dcsp dcsp mindist all dcnl dcsp dcsp else dcnl dcsp dcsp dcsp mindist mindist g mindist dcnl dcsp if src is not none dcnl dcsp dcsp if not isinstance src string types dcnl dcsp dcsp dcsp raise valueerror src dcsp must dcsp be dcsp a dcsp string dcsp or dcsp none dcnl dcsp if spacing is not none dcnl dcsp dcsp if not isinstance spacing string types dcnl dcsp dcsp dcsp raise valueerror spacing dcsp must dcsp be dcsp a dcsp string dcsp or dcsp none dcnl dcsp if bem is not none dcnl dcsp dcsp if not isinstance bem string types dcnl dcsp dcsp dcsp raise valueerror bem dcsp must dcsp be dcsp a dcsp string dcsp or dcsp none dcnl dcsp cmd mne do forward solution subject subject meas meas fwd fname destdir path dcnl dcsp if src is not none dcnl dcsp dcsp cmd + src src dcnl dcsp if spacing is not none dcnl dcsp dcsp if spacing isdigit dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp else dcnl dcsp dcsp dcsp match re match oct|ico d+ spacing dcnl dcsp dcsp dcsp if match is none dcnl dcsp dcsp dcsp dcsp raise valueerror invalid dcsp spacing dcsp parameter dcsp r spacing dcnl dcsp dcsp dcsp spacing join match groups dcnl dcsp dcsp cmd + spacing spacing dcnl dcsp if mindist is not none dcnl dcsp dcsp cmd + mindist dcnl dcsp if bem is not none dcnl dcsp dcsp cmd + bem bem dcnl dcsp if mri is not none dcnl dcsp dcsp cmd + mri s mri dcnl dcsp if trans is not none dcnl dcsp dcsp cmd + trans s trans dcnl dcsp if not meg dcnl dcsp dcsp cmd append eegonly dcnl dcsp if not eeg dcnl dcsp dcsp cmd append megonly dcnl dcsp if fixed dcnl dcsp dcsp cmd append fixed dcnl dcsp if grad dcnl dcsp dcsp cmd append grad dcnl dcsp if mricoord dcnl dcsp dcsp cmd append mricoord dcnl dcsp if overwrite dcnl dcsp dcsp cmd append overwrite dcnl dcsp env os environ copy dcnl dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp env subjects dir subjects dir dcnl dcsp try dcnl dcsp dcsp logger info running dcsp forward dcsp solution dcsp generation dcsp command dcsp with dcsp subjects dir dcsp s subjects dir dcnl dcsp dcsp run subprocess cmd env env dcnl dcsp except exception dcnl dcsp dcsp raise dcnl dcsp else dcnl dcsp dcsp fwd read forward solution op join path fname verbose false dcnl dcsp finally dcnl dcsp dcsp shutil rmtree temp dir ignore errors true dcnl dcsp return fwd
verbose dcnl def average forward solutions fwds weights none dcsp if not isinstance fwds list dcnl dcsp dcsp raise typeerror fwds dcsp must dcsp be dcsp a dcsp list dcnl dcsp if not len fwds 0 dcnl dcsp dcsp raise valueerror fwds dcsp must dcsp not dcsp be dcsp empty dcnl dcsp if weights is none dcnl dcsp dcsp weights np ones len fwds dcnl dcsp weights np asanyarray weights dcnl dcsp if not np all weights 0 dcnl dcsp dcsp raise valueerror weights dcsp must dcsp be dcsp nonnegative dcnl dcsp if not len weights len fwds dcnl dcsp dcsp raise valueerror weights dcsp must dcsp be dcsp none dcsp or dcsp the dcsp same dcsp length dcsp as dcsp fwds dcnl dcsp w sum np sum weights dcnl dcsp if not w sum 0 dcnl dcsp dcsp raise valueerror weights dcsp cannot dcsp all dcsp be dcsp zero dcnl dcsp weights w sum dcnl dcsp for fwd in fwds dcnl dcsp dcsp if not isinstance fwd dict dcnl dcsp dcsp dcsp raise typeerror each dcsp entry dcsp in dcsp fwds dcsp must dcsp be dcsp a dcsp dict dcnl dcsp dcsp check keys info sol grad nchan src source nn sol source rr source ori surf ori coord frame mri head t nsource dcnl dcsp dcsp if not all key in fwd for key in check keys dcnl dcsp dcsp dcsp raise keyerror forward dcsp solution dcsp dict dcsp does dcsp not dcsp have dcsp all dcsp standard dcsp entries dcsp cannot dcsp compute dcsp average dcnl dcsp if any fwd sol k fwds0 sol k for fwd in fwds1 for k in nrow ncol dcnl dcsp dcsp raise valueerror forward dcsp solutions dcsp have dcsp incompatible dcsp dimensions dcnl dcsp if any fwdk fwds0k for fwd in fwds1 for k in source ori surf ori coord frame dcnl dcsp dcsp raise valueerror forward dcsp solutions dcsp have dcsp incompatible dcsp orientations dcnl dcsp fwd ave deepcopy fwds0 dcnl dcsp fwd ave sol data weights0 dcnl dcsp fwd ave orig sol weights0 dcnl dcsp for fwd w in zip fwds1 weights1 dcnl dcsp dcsp fwd ave sol data + w fwd sol data dcnl dcsp dcsp fwd ave orig sol + w fwd orig sol dcnl dcsp if fwd ave sol grad is not none dcnl dcsp dcsp fwd ave sol grad data weights0 dcnl dcsp dcsp fwd ave orig sol grad weights0 dcnl dcsp dcsp for fwd w in zip fwds1 weights1 dcnl dcsp dcsp dcsp fwd ave sol grad data + w fwd sol grad data dcnl dcsp dcsp dcsp fwd ave orig sol grad + w fwd orig sol grad dcnl dcsp return fwd ave
def is axial coil coil dcsp is ax coil coil class in fiff fwd coilc mag fiff fwd coilc axial grad fiff fwd coilc axial grad2 dcnl dcsp return is ax
def ad hoc noise coils ch type meg dcsp v np empty len coils dcnl dcsp if ch type meg dcnl dcsp dcsp axs np array is axial coil coil for coil in coils dtype bool dcnl dcsp dcsp vaxs 4e28 dcnl dcsp dcsp vnp logical not axs 2 5e25 dcnl dcsp else dcnl dcsp dcsp v fill 1e12 dcnl dcsp cov dict diag true data v eig none eigvec none dcnl dcsp return cov
def setup dots mode coils ch type dcsp from scipy interpolate import interp1d dcnl dcsp int rad 0 06 dcnl dcsp noise ad hoc noise coils ch type dcnl dcsp n coeff interp 50 nearest if mode fast else 100 linear dcnl dcsp lut n fact get legen table ch type false n coeff verbose false dcnl dcsp lut fun interp1d np linspace 1 1 lut shape0 lut interp axis 0 dcnl dcsp return int rad noise lut fun n fact
def compute mapping matrix fmd info dcsp logger info dcsp dcsp dcsp dcsp preparing dcsp the dcsp mapping dcsp matrix dcnl dcsp ch names fmd ch names dcnl dcsp projs info get projs list dcnl dcsp proj op make projector projs ch names 0 dcnl dcsp proj dots np dot proj op t np dot fmd self dots proj op dcnl dcsp noise cov fmd noise dcnl dcsp if not noise cov diag dcnl dcsp dcsp raise notimplementederror dcnl dcsp whitener np diag 1 0 np sqrt noise cov data ravel dcnl dcsp whitened dots np dot whitener t np dot proj dots whitener dcnl dcsp uu sing vv linalg svd whitened dots full matrices false overwrite a true dcnl dcsp sumk np cumsum sing dcnl dcsp sumk sumk 1 dcnl dcsp fmd nest np where sumk 1 0 fmd miss 00 dcnl dcsp logger info dcsp dcsp dcsp dcsp truncate dcsp at dcsp d dcsp missing dcsp g fmd nest fmd miss dcnl dcsp sing 1 0 sing fmd nest dcnl dcsp inv np dot uu fmd nest sing vv fmd nest t dcnl dcsp inv whitened np dot whitener t np dot inv whitener dcnl dcsp inv whitened proj np dot inv whitened t proj op t dcnl dcsp mapping mat np dot fmd surface dots inv whitened proj dcnl dcsp if fmd kind eeg dcnl dcsp dcsp if has eeg average ref proj projs dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp the dcsp map dcsp will dcsp have dcsp average dcsp electrode dcsp reference dcnl dcsp dcsp dcsp mapping mat np mean mapping mat axis 0 np newaxis dcnl dcsp return mapping mat
def map meg channels info from info to mode fast origin 0 0 0 0 0 04 dcsp templates read coil defs verbose false dcnl dcsp coils from create meg coils info from chs normal info from dev head t templates dcnl dcsp coils to create meg coils info to chs normal info to dev head t templates dcnl dcsp miss 0 0001 dcnl dcsp origin check origin origin info from dcnl dcsp int rad noise lut fun n fact setup dots mode coils from meg dcnl dcsp logger info dcsp dcsp dcsp dcsp computing dcsp dot dcsp products dcsp for dcsp i dcsp coils len coils from dcnl dcsp self dots do self dots int rad false coils from origin meg lut fun n fact n jobs 1 dcnl dcsp logger info dcsp dcsp dcsp dcsp computing dcsp cross dcsp products dcsp for dcsp coils dcsp i dcsp x dcsp i dcsp coils len coils from len coils to dcnl dcsp cross dots do cross dots int rad false coils from coils to origin meg lut fun n fact t dcnl dcsp ch names c ch name for c in info from chs dcnl dcsp fmd dict kind meg ch names ch names origin origin noise noise self dots self dots surface dots cross dots int rad int rad miss miss dcnl dcsp mapping compute mapping matrix fmd info from dcnl dcsp return mapping
def as meg type evoked evoked ch type grad mode fast dcsp evoked evoked copy dcnl dcsp if ch type not in mag grad dcnl dcsp dcsp raise valueerror to type dcsp must dcsp be dcsp mag dcsp or dcsp grad dcsp not dcsp s ch type dcnl dcsp pick from pick types evoked info meg true eeg false ref meg false dcnl dcsp pick to pick types evoked info meg ch type eeg false ref meg false dcnl dcsp if len pick to 0 dcnl dcsp dcsp raise valueerror no dcsp channels dcsp matching dcsp the dcsp destination dcsp channel dcsp type dcsp found dcsp in dcsp info dcsp please dcsp pass dcsp an dcsp evoked dcsp containingboth dcsp the dcsp original dcsp and dcsp destination dcsp channels dcsp only dcsp the dcsp locations dcsp of dcsp the dcsp destination dcsp channels dcsp will dcsp be dcsp used dcsp for dcsp interpolation dcnl dcsp info from pick info evoked info pick from dcnl dcsp info to pick info evoked info pick to dcnl dcsp mapping map meg channels info from info to mode mode dcnl dcsp data np dot mapping evoked datapick from dcnl dcsp evoked pick types meg ch type eeg false ref meg false dcnl dcsp evoked data data dcnl dcsp for ch in evoked info chs dcnl dcsp dcsp ch ch name + virtual dcnl dcsp evoked info update redundant dcnl dcsp evoked info check consistency dcnl dcsp return evoked
verbose dcnl def make surface mapping info surf ch type meg trans none mode fast n jobs 1 origin 0 0 0 0 0 04 verbose none dcsp if not all key in surf for key in rr nn dcnl dcsp dcsp raise keyerror surf dcsp must dcsp have dcsp both dcsp rr dcsp and dcsp nn dcnl dcsp if coord frame not in surf dcnl dcsp dcsp raise keyerror the dcsp surface dcsp coordinate dcsp frame dcsp must dcsp be dcsp specified dcsp in dcsp surf coord frame dcnl dcsp if mode not in accurate fast dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp accurate dcsp or dcsp fast dcsp not dcsp s mode dcnl dcsp orig surf surf dcnl dcsp surf transform surface to deepcopy surf head trans dcnl dcsp n jobs check n jobs n jobs dcnl dcsp origin check origin origin info dcnl dcsp if ch type not in meg eeg dcnl dcsp dcsp raise valueerror unknown dcsp coil dcsp type dcsp s ch type dcnl dcsp if ch type meg dcnl dcsp dcsp picks pick types info meg true eeg false ref meg false dcnl dcsp dcsp logger info prepare dcsp meg dcsp mapping dcnl dcsp else dcnl dcsp dcsp picks pick types info meg false eeg true ref meg false dcnl dcsp dcsp logger info prepare dcsp eeg dcsp mapping dcnl dcsp if len picks 0 dcnl dcsp dcsp raise runtimeerror cannot dcsp map dcsp no dcsp channels dcsp found dcnl dcsp chs pick info info picks chs dcnl dcsp if ch type meg dcnl dcsp dcsp coils create meg coils chs normal info dev head t dcnl dcsp dcsp type str coils dcnl dcsp dcsp miss 0 0001 dcnl dcsp else dcnl dcsp dcsp coils create eeg els chs dcnl dcsp dcsp type str electrodes dcnl dcsp dcsp miss 0 001 dcnl dcsp int rad noise lut fun n fact setup dots mode coils ch type dcnl dcsp logger info computing dcsp dot dcsp products dcsp for dcsp i dcsp s len coils type str dcnl dcsp self dots do self dots int rad false coils origin ch type lut fun n fact n jobs dcnl dcsp sel np arange len surf rr dcnl dcsp logger info computing dcsp dot dcsp products dcsp for dcsp i dcsp surface dcsp locations len sel dcnl dcsp surface dots do surface dots int rad false coils surf sel origin ch type lut fun n fact n jobs dcnl dcsp ch names c ch name for c in chs dcnl dcsp fmd dict kind ch type surf surf ch names ch names coils coils origin origin noise noise self dots self dots surface dots surface dots int rad int rad miss miss dcnl dcsp logger info field dcsp mapping dcsp data dcsp ready dcnl dcsp fmd data compute mapping matrix fmd info dcnl dcsp fmd surf orig surf dcnl dcsp del fmd self dots dcnl dcsp del fmd surface dots dcnl dcsp del fmd int rad dcnl dcsp del fmd miss dcnl dcsp return fmd
verbose dcnl def make field map evoked trans auto subject none subjects dir none ch type none mode fast meg surf helmet origin 0 0 0 0 0 04 n jobs 1 verbose none dcsp info evoked info dcnl dcsp if ch type is none dcnl dcsp dcsp types t for t in eeg meg if t in evoked dcnl dcsp else dcnl dcsp dcsp if ch type not in eeg meg dcnl dcsp dcsp dcsp raise valueerror ch type dcsp should dcsp be dcsp eeg dcsp or dcsp meg dcsp got dcsp s ch type dcnl dcsp dcsp types ch type dcnl dcsp if trans auto dcnl dcsp dcsp trans find trans subject subjects dir dcnl dcsp if eeg in types and trans is none dcnl dcsp dcsp logger info no dcsp trans dcsp file dcsp available dcsp eeg dcsp data dcsp ignored dcnl dcsp dcsp types remove eeg dcnl dcsp if len types 0 dcnl dcsp dcsp raise runtimeerror no dcsp data dcsp available dcsp for dcsp mapping dcnl dcsp if trans is not none dcnl dcsp dcsp if isinstance trans string types dcnl dcsp dcsp dcsp trans read trans trans dcnl dcsp dcsp trans ensure trans trans head mri dcnl dcsp if meg surf not in helmet head dcnl dcsp dcsp raise valueerror surface dcsp to dcsp plot dcsp meg dcsp fields dcsp must dcsp be dcsp helmet dcsp or dcsp head dcnl dcsp surfs dcnl dcsp for this type in types dcnl dcsp dcsp if this type meg and meg surf helmet dcnl dcsp dcsp dcsp surf get meg helmet surf info trans dcnl dcsp dcsp else dcnl dcsp dcsp dcsp surf get head surf subject subjects dir subjects dir dcnl dcsp dcsp surfs append surf dcnl dcsp surf maps list dcnl dcsp for this type this surf in zip types surfs dcnl dcsp dcsp this map make surface mapping evoked info this surf this type trans n jobs n jobs origin origin mode mode dcnl dcsp dcsp surf maps append this map dcnl dcsp return surf maps
def pick events events include none exclude none step false dcsp if include is not none dcnl dcsp dcsp if not isinstance include list dcnl dcsp dcsp dcsp include include dcnl dcsp dcsp mask np zeros len events dtype np bool dcnl dcsp dcsp for e in include dcnl dcsp dcsp dcsp mask np logical or mask events 2 e dcnl dcsp dcsp dcsp if step dcnl dcsp dcsp dcsp dcsp mask np logical or mask events 1 e dcnl dcsp dcsp events eventsmask dcnl dcsp elif exclude is not none dcnl dcsp dcsp if not isinstance exclude list dcnl dcsp dcsp dcsp exclude exclude dcnl dcsp dcsp mask np ones len events dtype np bool dcnl dcsp dcsp for e in exclude dcnl dcsp dcsp dcsp mask np logical and mask events 2 e dcnl dcsp dcsp dcsp if step dcnl dcsp dcsp dcsp dcsp mask np logical and mask events 1 e dcnl dcsp dcsp events eventsmask dcnl dcsp else dcnl dcsp dcsp events np copy events dcnl dcsp if len events 0 dcnl dcsp dcsp raise runtimeerror no dcsp events dcsp found dcnl dcsp return events
def define target events events reference id target id sfreq tmin tmax new id none fill na none dcsp if new id is none dcnl dcsp dcsp new id reference id dcnl dcsp tsample 1000 0 sfreq dcnl dcsp imin int tmin sfreq dcnl dcsp imax int tmax sfreq dcnl dcsp new events dcnl dcsp lag dcnl dcsp for event in events copy astype int dcnl dcsp dcsp if event2 reference id dcnl dcsp dcsp dcsp lower event0 + imin dcnl dcsp dcsp dcsp upper event0 + imax dcnl dcsp dcsp dcsp res events events 0 lower events 0 < upper events 2 target id dcnl dcsp dcsp dcsp if res any dcnl dcsp dcsp dcsp dcsp lag + event0 res00 dcnl dcsp dcsp dcsp dcsp event2 new id dcnl dcsp dcsp dcsp dcsp new events + event dcnl dcsp dcsp dcsp elif fill na is not none dcnl dcsp dcsp dcsp dcsp event2 fill na dcnl dcsp dcsp dcsp dcsp new events + event dcnl dcsp dcsp dcsp dcsp lag append np nan dcnl dcsp new events np array new events dcnl dcsp with np errstate invalid ignore dcnl dcsp dcsp lag np abs lag dtype f8 dcnl dcsp if lag any dcnl dcsp dcsp lag tsample dcnl dcsp else dcnl dcsp dcsp lag np array dcnl dcsp return new events if new events any else np array lag
def read events fif fid tree dcsp events dir tree find tree fiff fiffb mne events dcnl dcsp if len events 0 dcnl dcsp dcsp fid close dcnl dcsp dcsp raise valueerror could dcsp not dcsp find dcsp event dcsp data dcnl dcsp events events0 dcnl dcsp for d in events directory dcnl dcsp dcsp kind d kind dcnl dcsp dcsp pos d pos dcnl dcsp dcsp if kind fiff fiff mne event list dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp event list tag data dcnl dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp raise valueerror could dcsp not dcsp find dcsp any dcsp events dcnl dcsp mappings dir tree find tree fiff fiffb mne events dcnl dcsp mappings mappings0 dcnl dcsp for d in mappings directory dcnl dcsp dcsp kind d kind dcnl dcsp dcsp pos d pos dcnl dcsp dcsp if kind fiff fiff description dcnl dcsp dcsp dcsp tag read tag fid pos dcnl dcsp dcsp dcsp mappings tag data dcnl dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp mappings none dcnl dcsp if mappings is not none dcnl dcsp dcsp m s 1 for s in m 1 split 1 for m in mappings split dcnl dcsp dcsp mappings dict k int v for v k in m dcnl dcsp event list event list reshape len event list 3 3 dcnl dcsp return event list mappings
def read events filename include none exclude none mask none mask type none dcsp check fname filename events eve eve fif eve fif gz eve lst eve txt dcnl dcsp ext splitext filename 1 lower dcnl dcsp if ext fif or ext gz dcnl dcsp dcsp fid tree fiff open filename dcnl dcsp dcsp try dcnl dcsp dcsp dcsp event list read events fif fid tree dcnl dcsp dcsp finally dcnl dcsp dcsp dcsp fid close dcnl dcsp else dcnl dcsp dcsp lines np loadtxt filename dtype np float64 astype np uint32 dcnl dcsp dcsp if len lines 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp text dcsp lines dcsp found dcnl dcsp dcsp if lines ndim 1 dcnl dcsp dcsp dcsp lines linesnp newaxis dcnl dcsp dcsp if len lines0 4 dcnl dcsp dcsp dcsp goods 0 2 3 dcnl dcsp dcsp elif len lines0 3 dcnl dcsp dcsp dcsp goods 0 1 2 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror unknown dcsp number dcsp of dcsp columns dcsp in dcsp event dcsp text dcsp file dcnl dcsp dcsp event list lines goods dcnl dcsp dcsp if mask is not none and event list shape0 0 and event list 0 2 0 dcnl dcsp dcsp dcsp event list event list1 dcnl dcsp dcsp dcsp warn first dcsp row dcsp of dcsp event dcsp file dcsp discarded dcsp zerovalued dcnl dcsp event list pick events event list include exclude dcnl dcsp unmasked len event list shape0 dcnl dcsp if mask is not none dcnl dcsp dcsp event list mask trigs event list mask mask type dcnl dcsp dcsp masked len event list shape0 dcnl dcsp dcsp if masked len < unmasked len dcnl dcsp dcsp dcsp warn 0 dcsp of dcsp 1 dcsp events dcsp masked format unmasked len masked len unmasked len dcnl dcsp return event list
def write events filename event list dcsp check fname filename events eve eve fif eve fif gz eve lst eve txt dcnl dcsp ext splitext filename 1 lower dcnl dcsp if ext fif or ext gz dcnl dcsp dcsp fid start file filename dcnl dcsp dcsp start block fid fiff fiffb mne events dcnl dcsp dcsp write int fid fiff fiff mne event list event list t dcnl dcsp dcsp end block fid fiff fiffb mne events dcnl dcsp dcsp end file fid dcnl dcsp else dcnl dcsp dcsp f open filename w dcnl dcsp dcsp for e in event list dcnl dcsp dcsp dcsp f write 6d dcsp 6d dcsp 3d n tuple e dcnl dcsp dcsp f close
def find stim steps raw pad start none pad stop none merge 0 stim channel none dcsp stim channel get stim channel stim channel raw info dcnl dcsp picks pick channels raw info ch names include stim channel dcnl dcsp if len picks 0 dcnl dcsp dcsp raise valueerror no dcsp stim dcsp channel dcsp found dcsp to dcsp extract dcsp event dcsp triggers dcnl dcsp data rawpicks dcnl dcsp if np any data < 0 dcnl dcsp dcsp warn trigger dcsp channel dcsp contains dcsp negative dcsp values dcsp using dcsp absolute dcsp value dcnl dcsp dcsp data np abs data dcnl dcsp data data astype np int dcnl dcsp return find stim steps data raw first samp pad start pad start pad stop pad stop merge merge
def find events data first samp verbose none output onset consecutive increasing min samples 0 mask none uint cast false mask type none dcsp if min samples 0 dcnl dcsp dcsp merge int min samples 1 dcnl dcsp dcsp if merge min samples dcnl dcsp dcsp dcsp merge 1 dcnl dcsp else dcnl dcsp dcsp merge 0 dcnl dcsp data data astype np int dcnl dcsp if uint cast dcnl dcsp dcsp data data astype np uint16 astype np int dcnl dcsp if data min < 0 dcnl dcsp dcsp warn trigger dcsp channel dcsp contains dcsp negative dcsp values dcsp using dcsp absolute dcsp value dcsp if dcsp data dcsp were dcsp acquired dcsp on dcsp a dcsp neuromag dcsp system dcsp with dcsp sti016 dcsp active dcsp consider dcsp using dcsp uint cast true dcsp to dcsp work dcsp around dcsp an dcsp acquisition dcsp bug dcnl dcsp dcsp data np abs data dcnl dcsp events find stim steps data first samp pad stop 0 merge merge dcnl dcsp events mask trigs events mask mask type dcnl dcsp if consecutive increasing dcnl dcsp dcsp onsets events 2 events 1 dcnl dcsp dcsp offsets np logical and np logical or onsets events 2 0 events 1 0 dcnl dcsp elif consecutive dcnl dcsp dcsp onsets events 2 0 dcnl dcsp dcsp offsets events 1 0 dcnl dcsp else dcnl dcsp dcsp onsets events 1 0 dcnl dcsp dcsp offsets events 2 0 dcnl dcsp onset idx np where onsets 0 dcnl dcsp offset idx np where offsets 0 dcnl dcsp if len onset idx 0 or len offset idx 0 dcnl dcsp dcsp return np empty 0 3 dtype int32 dcnl dcsp if onset idx0 offset idx0 dcnl dcsp dcsp logger info removing dcsp orphaned dcsp offset dcsp at dcsp the dcsp beginning dcsp of dcsp the dcsp file dcnl dcsp dcsp offset idx np delete offset idx 0 dcnl dcsp if onset idx 1 offset idx 1 dcnl dcsp dcsp logger info removing dcsp orphaned dcsp onset dcsp at dcsp the dcsp end dcsp of dcsp the dcsp file dcnl dcsp dcsp onset idx np delete onset idx 1 dcnl dcsp if output onset dcnl dcsp dcsp events eventsonset idx dcnl dcsp elif output step dcnl dcsp dcsp idx np union1d onset idx offset idx dcnl dcsp dcsp events eventsidx dcnl dcsp elif output offset dcnl dcsp dcsp event id events onset idx 2 dcnl dcsp dcsp events eventsoffset idx dcnl dcsp dcsp events 1 events 2 dcnl dcsp dcsp events 2 event id dcnl dcsp dcsp events 0 1 dcnl dcsp else dcnl dcsp dcsp raise valueerror invalid dcsp output dcsp parameter dcsp r output dcnl dcsp logger info s dcsp events dcsp found len events dcnl dcsp logger info events dcsp id dcsp s np unique events 2 dcnl dcsp return events
verbose dcnl def find events raw stim channel none output onset consecutive increasing min duration 0 shortest event 2 mask none uint cast false mask type none verbose none dcsp min samples min duration raw info sfreq dcnl dcsp stim channel get stim channel stim channel raw info dcnl dcsp pick pick channels raw info ch names include stim channel dcnl dcsp if len pick 0 dcnl dcsp dcsp raise valueerror no dcsp stim dcsp channel dcsp found dcsp to dcsp extract dcsp event dcsp triggers dcnl dcsp data rawpick dcnl dcsp events find events data raw first samp verbose verbose output output consecutive consecutive min samples min samples mask mask uint cast uint cast mask type mask type dcnl dcsp n short events np sum np diff events 0 < shortest event dcnl dcsp if n short events 0 dcnl dcsp dcsp raise valueerror you dcsp have dcsp i dcsp events dcsp shorter dcsp than dcsp the dcsp shortest event dcsp these dcsp are dcsp very dcsp unusual dcsp and dcsp you dcsp may dcsp want dcsp to dcsp set dcsp min duration dcsp to dcsp a dcsp larger dcsp value dcsp e g dcsp x dcsp dcsp raw info sfreq dcsp where dcsp x dcsp dcsp 1 dcsp sample dcsp shorter dcsp than dcsp the dcsp shortest dcsp event dcsp length n short events dcnl dcsp return events
def mask trigs events mask mask type dcsp if mask type is none dcnl dcsp dcsp mask type not and dcnl dcsp dcsp if mask is not none dcnl dcsp dcsp dcsp warn the dcsp default dcsp mask dcsp type dcsp not and dcsp will dcsp change dcsp to dcsp and dcsp in dcsp 0 16 dcsp set dcsp it dcsp explicitly dcsp to dcsp avoid dcsp this dcsp warning deprecationwarning dcnl dcsp if not isinstance mask type string types or mask type not in not and and dcnl dcsp dcsp raise valueerror mask type dcsp must dcsp be dcsp not and dcsp or dcsp and dcsp got dcsp s mask type dcnl dcsp if mask is not none dcnl dcsp dcsp if not isinstance mask int dcnl dcsp dcsp dcsp raise typeerror you dcsp provided dcsp a n dcsp s type mask + mask dcsp must dcsp be dcsp an dcsp int dcsp or dcsp none dcnl dcsp n events len events dcnl dcsp if n events 0 dcnl dcsp dcsp return events copy dcnl dcsp if mask is not none dcnl dcsp dcsp if mask type not and dcnl dcsp dcsp dcsp mask np bitwise not mask dcnl dcsp dcsp elif mask type and dcnl dcsp dcsp dcsp if mask type is not none dcnl dcsp dcsp dcsp dcsp raise valueerror mask type dcsp should dcsp be dcsp either dcsp and dcsp or dcsp not and dcsp instead dcsp of dcsp s mask type dcnl dcsp dcsp events 1 np bitwise and events 1 mask dcnl dcsp events events events 1 events 2 dcnl dcsp return events
def merge events events ids new id replace events true dcsp events np asarray events dcnl dcsp events out events copy dcnl dcsp idx touched dcnl dcsp for col in 1 2 dcnl dcsp dcsp for i in ids dcnl dcsp dcsp dcsp mask events col i dcnl dcsp dcsp dcsp events out mask col new id dcnl dcsp dcsp dcsp idx touched append np where mask 0 dcnl dcsp if not replace events dcnl dcsp dcsp idx touched np unique np concatenate idx touched dcnl dcsp dcsp events out np concatenate events out eventsidx touched axis 0 dcnl dcsp dcsp events out events outnp lexsort events out t 1 dcnl dcsp return events out
def shift time events events ids tshift sfreq dcsp events events copy dcnl dcsp for ii in ids dcnl dcsp dcsp events events 2 ii 0 + int tshift sfreq dcnl dcsp return events
def make fixed length events raw id start 0 stop none duration 1 0 first samp true dcsp from io base import baseraw dcnl dcsp if not isinstance raw baseraw dcnl dcsp dcsp raise valueerror input dcsp data dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp raw dcsp got dcsp s dcsp instead type raw dcnl dcsp if not isinstance id int dcnl dcsp dcsp raise valueerror id dcsp must dcsp be dcsp an dcsp integer dcnl dcsp if not isinstance duration int float dcnl dcsp dcsp raise valueerror duration dcsp must dcsp be dcsp an dcsp integer dcsp of dcsp a dcsp float dcsp got dcsp s dcsp instead type duration dcnl dcsp start raw time as index start 0 dcnl dcsp if stop is not none dcnl dcsp dcsp stop raw time as index stop 0 dcnl dcsp else dcnl dcsp dcsp stop raw last samp + 1 dcnl dcsp if first samp dcnl dcsp dcsp start start + raw first samp dcnl dcsp dcsp stop min stop + raw first samp raw last samp + 1 dcnl dcsp else dcnl dcsp dcsp stop min stop len raw times dcnl dcsp stop int np ceil raw info sfreq duration dcnl dcsp ts np arange start stop + 1 raw info sfreq duration astype int dcnl dcsp n events len ts dcnl dcsp if n events 0 dcnl dcsp dcsp raise valueerror no dcsp events dcsp produced dcsp check dcsp the dcsp values dcsp of dcsp start dcsp stop dcsp and dcsp duration dcnl dcsp events np c ts np zeros n events dtype int id np ones n events dtype int dcnl dcsp return events
def concatenate events events first samps last samps dcsp if not isinstance events list dcnl dcsp dcsp raise valueerror events dcsp must dcsp be dcsp a dcsp list dcsp of dcsp arrays dcnl dcsp if not len events len last samps and len events len first samps dcnl dcsp dcsp raise valueerror events dcsp first samps dcsp and dcsp last samps dcsp must dcsp all dcsp have dcsp the dcsp same dcsp lengths dcnl dcsp first samps np array first samps dcnl dcsp last samps np array last samps dcnl dcsp n samps np cumsum last samps first samps + 1 dcnl dcsp events out events0 dcnl dcsp for e f n in zip events1 first samps1 n samps 1 dcnl dcsp dcsp e2 e copy dcnl dcsp dcsp e2 0 f dcnl dcsp dcsp e2 0 + n + first samps0 dcnl dcsp dcsp events out np concatenate events out e2 axis 0 dcnl dcsp return events out
def parse config fname dcsp reject params read reject parameters fname dcnl dcsp try dcnl dcsp dcsp with open fname r as f dcnl dcsp dcsp dcsp lines f readlines dcnl dcsp except dcnl dcsp dcsp raise valueerror error dcsp while dcsp reading dcsp s fname dcnl dcsp cat ind i for i x in enumerate lines if category dcsp in x dcnl dcsp event dict dict dcnl dcsp for ind in cat ind dcnl dcsp dcsp for k in range ind + 1 ind + 7 dcnl dcsp dcsp dcsp words linesk split dcnl dcsp dcsp dcsp if len words 2 dcnl dcsp dcsp dcsp dcsp key words0 dcnl dcsp dcsp dcsp dcsp if key event dcnl dcsp dcsp dcsp dcsp dcsp event int words1 dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp event dcsp id dcnl dcsp dcsp event dictevent dict reject params dcnl dcsp dcsp for k in range ind + 1 ind + 7 dcnl dcsp dcsp dcsp words linesk split dcnl dcsp dcsp dcsp if len words 2 dcnl dcsp dcsp dcsp dcsp key words0 dcnl dcsp dcsp dcsp dcsp if key name dcnl dcsp dcsp dcsp dcsp dcsp name dcsp join words1 dcnl dcsp dcsp dcsp dcsp dcsp if name0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp name name1 dcnl dcsp dcsp dcsp dcsp dcsp if name 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp name name 1 dcnl dcsp dcsp dcsp dcsp dcsp event dictevent name name dcnl dcsp dcsp dcsp dcsp if key in tmin tmax basemin basemax dcnl dcsp dcsp dcsp dcsp dcsp event dicteventkey float words1 dcnl dcsp return event dict
def read reject parameters fname dcsp try dcnl dcsp dcsp with open fname r as f dcnl dcsp dcsp dcsp lines f readlines dcnl dcsp except dcnl dcsp dcsp raise valueerror error dcsp while dcsp reading dcsp s fname dcnl dcsp reject names gradreject magreject eegreject eogreject ecgreject dcnl dcsp reject pynames grad mag eeg eog ecg dcnl dcsp reject dict dcnl dcsp for line in lines dcnl dcsp dcsp words line split dcnl dcsp dcsp if words0 in reject names dcnl dcsp dcsp dcsp rejectreject pynamesreject names index words0 float words1 dcnl dcsp return reject
def read flat parameters fname dcsp try dcnl dcsp dcsp with open fname r as f dcnl dcsp dcsp dcsp lines f readlines dcnl dcsp except dcnl dcsp dcsp raise valueerror error dcsp while dcsp reading dcsp s fname dcnl dcsp reject names gradflat magflat eegflat eogflat ecgflat dcnl dcsp reject pynames grad mag eeg eog ecg dcnl dcsp flat dict dcnl dcsp for line in lines dcnl dcsp dcsp words line split dcnl dcsp dcsp if words0 in reject names dcnl dcsp dcsp dcsp flatreject pynamesreject names index words0 float words1 dcnl dcsp return flat
def f oneway args dcsp from scipy import stats dcnl dcsp sf stats f sf dcnl dcsp n classes len args dcnl dcsp n samples per class np array len a for a in args dcnl dcsp n samples np sum n samples per class dcnl dcsp ss alldata reduce lambda x y x + y np sum a 2 axis 0 for a in args dcnl dcsp sums args np sum a axis 0 for a in args dcnl dcsp square of sums alldata reduce lambda x y x + y sums args 2 dcnl dcsp square of sums args s 2 for s in sums args dcnl dcsp sstot ss alldata square of sums alldata float n samples dcnl dcsp ssbn 0 dcnl dcsp for k in enumerate args dcnl dcsp dcsp ssbn + square of sums argsk n samples per classk dcnl dcsp ssbn square of sums alldata float n samples dcnl dcsp sswn sstot ssbn dcnl dcsp dfbn n classes 1 dcnl dcsp dfwn n samples n classes dcnl dcsp msb ssbn float dfbn dcnl dcsp msw sswn float dfwn dcnl dcsp f msb msw dcnl dcsp prob sf dfbn dfwn f dcnl dcsp return f prob
def f oneway args dcsp return f oneway args 0
def map effects n factors effects dcsp if n factors len ascii uppercase dcnl dcsp dcsp raise valueerror maximum dcsp number dcsp of dcsp factors dcsp supported dcsp is dcsp 26 dcnl dcsp factor names list ascii uppercase n factors dcnl dcsp if isinstance effects string types dcnl dcsp dcsp if in effects and in effects dcnl dcsp dcsp dcsp raise valueerror not dcsp dcsp and dcsp dcsp permitted dcsp in dcsp effects dcnl dcsp dcsp elif + in effects and in effects dcnl dcsp dcsp dcsp raise valueerror not dcsp + dcsp and dcsp dcsp permitted dcsp in dcsp effects dcnl dcsp dcsp elif effects all dcnl dcsp dcsp dcsp effects none dcnl dcsp dcsp elif len effects 1 or in effects dcnl dcsp dcsp dcsp effects effects dcnl dcsp dcsp elif + in effects dcnl dcsp dcsp dcsp effects effects split + dcnl dcsp dcsp elif in effects dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror 0 dcsp is dcsp not dcsp a dcsp valid dcsp option dcsp for dcsp effects format effects dcnl dcsp if isinstance effects list dcnl dcsp dcsp bad names e for e in effects if e not in factor names dcnl dcsp dcsp if len bad names 1 dcnl dcsp dcsp dcsp raise valueerror effect dcsp names dcsp 0 dcsp are dcsp not dcsp valid dcsp they dcsp should dcsp the dcsp first dcsp n factors dcsp 1 dcsp characters dcsp from dcsp thealphabet format bad names n factors dcnl dcsp indices list np arange 2 n factors 1 dcnl dcsp names list dcnl dcsp for this effect in indices dcnl dcsp dcsp contrast idx get contrast indices this effect + 1 n factors dcnl dcsp dcsp this code n factors 1 np where contrast idx 1 0 dcnl dcsp dcsp this name factor namese for e in this code dcnl dcsp dcsp this name sort dcnl dcsp dcsp names append join this name dcnl dcsp if effects is none or isinstance effects string types dcnl dcsp dcsp effects names dcnl dcsp else dcnl dcsp dcsp effects effects dcnl dcsp selection names index sel for sel in effects dcnl dcsp names namessel for sel in selection dcnl dcsp if isinstance effects string types dcnl dcsp dcsp if in effects dcnl dcsp dcsp dcsp sel ind names index effects replace + 1 dcnl dcsp dcsp dcsp names names sel ind dcnl dcsp dcsp dcsp selection selection sel ind dcnl dcsp return selection names
def get contrast indices effect idx n factors dcsp binrepr np binary repr effect idx n factors dcnl dcsp return np array int i for i in binrepr dtype int
def iter contrasts n subjects factor levels effect picks dcsp from scipy signal import detrend dcnl dcsp sc dcnl dcsp n factors len factor levels dcnl dcsp for n levels in factor levels dcnl dcsp dcsp sc append np ones n levels 1 detrend np eye n levels type constant dcnl dcsp for this effect in effect picks dcnl dcsp dcsp contrast idx get contrast indices this effect + 1 n factors dcnl dcsp dcsp c sc0contrast idx n factors 1 dcnl dcsp dcsp for i contrast in range 1 n factors dcnl dcsp dcsp dcsp this contrast contrast idx n factors 1 i contrast dcnl dcsp dcsp dcsp c np kron c sci contrastthis contrast dcnl dcsp dcsp df1 np linalg matrix rank c dcnl dcsp dcsp df2 df1 n subjects 1 dcnl dcsp dcsp yield c df1 df2
def f threshold mway rm n subjects factor levels effects a b pvalue 0 05 dcsp from scipy stats import f dcnl dcsp effect picks map effects len factor levels effects dcnl dcsp f threshold dcnl dcsp for df1 df2 in iter contrasts n subjects factor levels effect picks dcnl dcsp dcsp f threshold append f df1 df2 isf pvalue dcnl dcsp return f threshold if len f threshold 1 else f threshold0
def f mway rm data factor levels effects all alpha 0 05 correction false return pvals true dcsp from scipy stats import f dcnl dcsp if data ndim 2 dcnl dcsp dcsp data data np newaxis dcnl dcsp elif data ndim 3 dcnl dcsp dcsp data data reshape data shape0 data shape1 np prod data shape2 dcnl dcsp effect picks map effects len factor levels effects dcnl dcsp n obs data shape2 dcnl dcsp n replications data shape0 dcnl dcsp data np rollaxis data 2 dcnl dcsp fvalues pvalues dcnl dcsp for c df1 df2 in iter contrasts n replications factor levels effect picks dcnl dcsp dcsp y np dot data c dcnl dcsp dcsp b np mean y axis 1 np newaxis dcnl dcsp dcsp ss np sum np sum y b axis 2 axis 1 dcnl dcsp dcsp mse np sum np sum y y axis 2 axis 1 ss df2 df1 dcnl dcsp dcsp fvals ss mse dcnl dcsp dcsp fvalues append fvals dcnl dcsp dcsp if correction dcnl dcsp dcsp dcsp v np array np dot y t y for y in y dcnl dcsp dcsp dcsp v np array np trace vv for vv in v 2 df1 np sum np sum v v axis 2 axis 1 dcnl dcsp dcsp dcsp eps v dcnl dcsp dcsp df1 df2 np zeros n obs + df1 np zeros n obs + df2 dcnl dcsp dcsp if correction dcnl dcsp dcsp dcsp df1 df2 np maximum dnone eps 1 0 for d in df1 df2 dcnl dcsp dcsp if return pvals dcnl dcsp dcsp dcsp pvals f df1 df2 sf fvals dcnl dcsp dcsp else dcnl dcsp dcsp dcsp pvals np empty 0 dcnl dcsp dcsp pvalues append pvals dcnl dcsp return np squeeze np asarray vv for vv in fvalues pvalues
def bin perm rep ndim a 0 b 1 dcsp nperms 2 ndim dcnl dcsp perms np empty nperms ndim type a dcnl dcsp perms fill a dcnl dcsp half point nperms 2 dcnl dcsp permshalf point 0 b dcnl dcsp for j in range 1 ndim dcnl dcsp dcsp half col perms 2 j 1 dcnl dcsp dcsp perms half point j half col dcnl dcsp dcsp permshalf point j half col dcnl dcsp return perms
def max stat x x2 perms dof scaling dcsp n samples len x dcnl dcsp mus np dot perms x float n samples dcnl dcsp stds np sqrt x2none mus 2 dof scaling dcnl dcsp max abs np max np abs mus stds sqrt n samples axis 1 dcnl dcsp return max abs
verbose dcnl def permutation t test x n permutations 10000 tail 0 n jobs 1 verbose none dcsp n samples n tests x shape dcnl dcsp do exact false dcnl dcsp if n permutations all or n permutations 2 n samples 1 dcnl dcsp dcsp do exact true dcnl dcsp dcsp n permutations 2 n samples 1 dcnl dcsp x2 np mean x 2 axis 0 dcnl dcsp mu0 np mean x axis 0 dcnl dcsp dof scaling sqrt n samples n samples 1 0 dcnl dcsp std0 np sqrt x2 mu0 2 dof scaling dcnl dcsp t obs np mean x axis 0 std0 sqrt n samples dcnl dcsp if do exact dcnl dcsp dcsp perms bin perm rep n samples a 1 b 1 1 dcnl dcsp else dcnl dcsp dcsp perms np sign 0 5 np random rand n permutations n samples dcnl dcsp parallel my max stat n jobs parallel func max stat n jobs dcnl dcsp max abs np concatenate parallel my max stat x x2 p dof scaling for p in np array split perms n jobs dcnl dcsp h0 np sort max abs dcnl dcsp scaling float n permutations + 1 dcnl dcsp if tail 0 dcnl dcsp dcsp p values 1 0 np searchsorted h0 np abs t obs scaling dcnl dcsp elif tail 1 dcnl dcsp dcsp p values 1 0 np searchsorted h0 t obs scaling dcnl dcsp elif tail 1 dcnl dcsp dcsp p values 1 0 np searchsorted h0 t obs scaling dcnl dcsp return t obs p values h0
def get clusters spatial s neighbors dcsp r np ones s shape dtype bool dcnl dcsp clusters list dcnl dcsp next ind 0 if s size 0 else none dcnl dcsp while next ind is not none dcnl dcsp dcsp t inds next ind dcnl dcsp dcsp rnext ind false dcnl dcsp dcsp icount 1 dcnl dcsp dcsp while icount < len t inds dcnl dcsp dcsp dcsp ind t inds icount 1 dcnl dcsp dcsp dcsp buddies np where r 0 dcnl dcsp dcsp dcsp buddies buddiesnp in1d sbuddies neighborssind assume unique true dcnl dcsp dcsp dcsp t inds + buddies tolist dcnl dcsp dcsp dcsp rbuddies false dcnl dcsp dcsp dcsp icount + 1 dcnl dcsp dcsp next ind np argmax r dcnl dcsp dcsp if next ind 0 dcnl dcsp dcsp dcsp next ind none dcnl dcsp dcsp clusters append st inds dcnl dcsp return clusters
def reassign check clusters base num dcsp check check num base dcnl dcsp clusters base 1 np concatenate clusters base 1 clusters num 1 dcnl dcsp clusters num 1 np array dtype int
def get clusters st 1step keepers neighbors dcsp n src len neighbors dcnl dcsp n times len keepers dcnl dcsp enum offset 1 dcnl dcsp check np zeros n times n src dtype int dcnl dcsp clusters list dcnl dcsp for ii k in enumerate keepers dcnl dcsp dcsp c get clusters spatial k neighbors dcnl dcsp dcsp for ci cl in enumerate c dcnl dcsp dcsp dcsp check ii cl ci + enum offset dcnl dcsp dcsp enum offset + len c dcnl dcsp dcsp c cl + ii n src for cl in c dcnl dcsp dcsp clusters + c dcnl dcsp for check1 check2 k in zip check 1 check1 keepers 1 dcnl dcsp dcsp inds k check2k check1k 0 dcnl dcsp dcsp check1 d check1inds dcnl dcsp dcsp n check2inds dcnl dcsp dcsp nexts np unique n dcnl dcsp dcsp for num in nexts dcnl dcsp dcsp dcsp prevs check1 d n num dcnl dcsp dcsp dcsp base np min prevs dcnl dcsp dcsp dcsp for pr in np unique prevs prevs base dcnl dcsp dcsp dcsp dcsp reassign check1 clusters base pr dcnl dcsp dcsp dcsp reassign check2 clusters base num dcnl dcsp clusters cl for cl in clusters if len cl 0 dcnl dcsp return clusters
def get clusters st multistep keepers neighbors max step 1 dcsp n src len neighbors dcnl dcsp n times len keepers dcnl dcsp t border list dcnl dcsp t border append 0 dcnl dcsp for ki k in enumerate keepers dcnl dcsp dcsp keeperski k + ki n src dcnl dcsp dcsp t border append t borderki + len k dcnl dcsp t border np array t border dcnl dcsp keepers np concatenate keepers dcnl dcsp v keepers dcnl dcsp t s divmod v n src dcnl dcsp r np ones t shape dtype bool dcnl dcsp clusters list dcnl dcsp next ind 0 dcnl dcsp inds np arange t border0 t bordern times dcnl dcsp if s size 0 dcnl dcsp dcsp while next ind is not none dcnl dcsp dcsp dcsp t inds next ind dcnl dcsp dcsp dcsp rnext ind false dcnl dcsp dcsp dcsp icount 1 dcnl dcsp dcsp dcsp while icount < len t inds dcnl dcsp dcsp dcsp dcsp ind t inds icount 1 dcnl dcsp dcsp dcsp dcsp selves indst bordermax tind max step 0 t bordermin tind + max step + 1 n times dcnl dcsp dcsp dcsp dcsp selves selvesrselves dcnl dcsp dcsp dcsp dcsp selves selves sind sselves dcnl dcsp dcsp dcsp dcsp buddies indst bordertind t border tind + 1 dcnl dcsp dcsp dcsp dcsp buddies buddiesrbuddies dcnl dcsp dcsp dcsp dcsp buddies buddiesnp in1d sbuddies neighborssind assume unique true dcnl dcsp dcsp dcsp dcsp buddies np concatenate selves buddies dcnl dcsp dcsp dcsp dcsp t inds + buddies tolist dcnl dcsp dcsp dcsp dcsp rbuddies false dcnl dcsp dcsp dcsp dcsp icount + 1 dcnl dcsp dcsp dcsp next ind np argmax r dcnl dcsp dcsp dcsp if next ind 0 dcnl dcsp dcsp dcsp dcsp next ind none dcnl dcsp dcsp dcsp clusters append vt inds dcnl dcsp return clusters
def get clusters st x in neighbors max step 1 dcsp n src len neighbors dcnl dcsp n times x in size n src dcnl dcsp cl goods np where x in 0 dcnl dcsp if len cl goods 0 dcnl dcsp dcsp keepers np array dtype int n times dcnl dcsp dcsp row col np unravel index cl goods n times n src dcnl dcsp dcsp if isinstance row int dcnl dcsp dcsp dcsp row row dcnl dcsp dcsp dcsp col col dcnl dcsp dcsp dcsp lims 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp order np argsort row dcnl dcsp dcsp dcsp row roworder dcnl dcsp dcsp dcsp col colorder dcnl dcsp dcsp dcsp lims 0 + np where np diff row 0 0 + 1 tolist + len row dcnl dcsp dcsp for start end in zip lims 1 lims1 dcnl dcsp dcsp dcsp keepersrowstart np sort colstart end dcnl dcsp dcsp if max step 1 dcnl dcsp dcsp dcsp return get clusters st 1step keepers neighbors dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return get clusters st multistep keepers neighbors max step dcnl dcsp else dcnl dcsp dcsp return
def get components x in connectivity return list true dcsp try dcnl dcsp dcsp from sklearn utils csgraph import cs graph components dcnl dcsp except importerror dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from scikits learn utils csgraph import cs graph components dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp from sklearn utils sparsetools import connected components dcnl dcsp dcsp dcsp dcsp cs graph components connected components dcnl dcsp dcsp dcsp except importerror dcnl dcsp dcsp dcsp dcsp raise importerror scikitlearn dcsp must dcsp be dcsp installed dcnl dcsp mask np logical and x inconnectivity row x inconnectivity col dcnl dcsp data connectivity datamask dcnl dcsp row connectivity rowmask dcnl dcsp col connectivity colmask dcnl dcsp shape connectivity shape dcnl dcsp idx np where x in 0 dcnl dcsp row np concatenate row idx dcnl dcsp col np concatenate col idx dcnl dcsp data np concatenate data np ones len idx dtype data dtype dcnl dcsp connectivity sparse coo matrix data row col shape shape dcnl dcsp components cs graph components connectivity dcnl dcsp if return list dcnl dcsp dcsp start np min components dcnl dcsp dcsp stop np max components dcnl dcsp dcsp comp list list for i in range start stop + 1 1 dcnl dcsp dcsp mask np zeros len comp list dtype bool dcnl dcsp dcsp for ii comp in enumerate components dcnl dcsp dcsp dcsp comp listcomp append ii dcnl dcsp dcsp dcsp maskcomp + x inii dcnl dcsp dcsp clusters np array k for k m in zip comp list mask if m dcnl dcsp dcsp return clusters dcnl dcsp else dcnl dcsp dcsp return components
def find clusters x threshold tail 0 connectivity none max step 1 include none partitions none t power 1 show info false dcsp from scipy import ndimage dcnl dcsp if tail not in 1 0 1 dcnl dcsp dcsp raise valueerror invalid dcsp tail dcsp parameter dcnl dcsp x np asanyarray x dcnl dcsp if not np isscalar threshold dcnl dcsp dcsp if not isinstance threshold dict dcnl dcsp dcsp dcsp raise typeerror threshold dcsp must dcsp be dcsp a dcsp number dcsp or dcsp a dcsp dict dcsp for dcsp thresholdfree dcsp cluster dcsp enhancement dcnl dcsp dcsp if not all key in threshold for key in start step dcnl dcsp dcsp dcsp raise keyerror threshold dcsp if dcsp dict dcsp must dcsp have dcsp at dcsp least dcsp start dcsp and dcsp step dcnl dcsp dcsp tfce true dcnl dcsp dcsp if tail 1 dcnl dcsp dcsp dcsp if threshold start 0 dcnl dcsp dcsp dcsp dcsp raise valueerror threshold start dcsp must dcsp be dcsp < dcsp 0 dcsp for dcsp tail dcsp dcsp 1 dcnl dcsp dcsp dcsp if threshold step 0 dcnl dcsp dcsp dcsp dcsp raise valueerror threshold step dcsp must dcsp be dcsp < dcsp 0 dcsp for dcsp tail dcsp dcsp 1 dcnl dcsp dcsp dcsp stop np min x dcnl dcsp dcsp elif tail 1 dcnl dcsp dcsp dcsp stop np max x dcnl dcsp dcsp else dcnl dcsp dcsp dcsp stop np max np abs x dcnl dcsp dcsp thresholds np arange threshold start stop threshold step float dcnl dcsp dcsp h power threshold get h power 2 dcnl dcsp dcsp e power threshold get e power 0 5 dcnl dcsp dcsp if show info is true dcnl dcsp dcsp dcsp if len thresholds 0 dcnl dcsp dcsp dcsp dcsp warn threshold start dcsp s dcsp is dcsp more dcsp extreme dcsp than dcsp data dcsp statistics dcsp with dcsp most dcsp extreme dcsp value dcsp s threshold start stop dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp logger info using dcsp d dcsp thresholds dcsp from dcsp 0 2f dcsp to dcsp 0 2f dcsp for dcsp tfce dcsp computation dcsp h power 0 2f dcsp e power 0 2f len thresholds thresholds0 thresholds 1 h power e power dcnl dcsp dcsp scores np zeros x size dcnl dcsp else dcnl dcsp dcsp thresholds threshold dcnl dcsp dcsp tfce false dcnl dcsp if include is none dcnl dcsp dcsp include np ones x shape dtype bool dcnl dcsp if not np all np diff thresholds 0 dcnl dcsp dcsp raise runtimeerror threshold dcsp misconfiguration dcsp must dcsp be dcsp monotonically dcsp increasing dcnl dcsp clusters list dcnl dcsp sums np empty 0 dcnl dcsp for ti thresh in enumerate thresholds dcnl dcsp dcsp clusters list dcnl dcsp dcsp sums np empty 0 dcnl dcsp dcsp if tail 0 dcnl dcsp dcsp dcsp x ins np logical and x thresh include np logical and x < thresh include dcnl dcsp dcsp elif tail 1 dcnl dcsp dcsp dcsp x ins np logical and x < thresh include dcnl dcsp dcsp else dcnl dcsp dcsp dcsp x ins np logical and x thresh include dcnl dcsp dcsp for x in in x ins dcnl dcsp dcsp dcsp if np any x in dcnl dcsp dcsp dcsp dcsp out find clusters 1dir parts x x in connectivity max step partitions t power ndimage dcnl dcsp dcsp dcsp dcsp clusters + out0 dcnl dcsp dcsp dcsp dcsp sums np concatenate sums out1 dcnl dcsp dcsp if tfce is true dcnl dcsp dcsp dcsp if ti 0 dcnl dcsp dcsp dcsp dcsp h abs thresh dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp h abs thresh thresholds ti 1 dcnl dcsp dcsp dcsp h h h power dcnl dcsp dcsp dcsp for c in clusters dcnl dcsp dcsp dcsp dcsp if isinstance c slice dcnl dcsp dcsp dcsp dcsp dcsp len c c stop c start dcnl dcsp dcsp dcsp dcsp elif isinstance c tuple dcnl dcsp dcsp dcsp dcsp dcsp len c len c dcnl dcsp dcsp dcsp dcsp elif c dtype bool dcnl dcsp dcsp dcsp dcsp dcsp len c np sum c dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp len c len c dcnl dcsp dcsp dcsp dcsp scoresc + h len c e power dcnl dcsp if tfce is true dcnl dcsp dcsp clusters np arange x size dcnl dcsp dcsp if connectivity is none dcnl dcsp dcsp dcsp if x ndim 1 dcnl dcsp dcsp dcsp dcsp clusters slice c c + 1 for c in clusters dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp clusters clusters ii ravel for ii in range len clusters dcnl dcsp dcsp else dcnl dcsp dcsp dcsp clusters np array c for c in clusters dcnl dcsp dcsp sums scores dcnl dcsp return clusters sums
def find clusters 1dir parts x x in connectivity max step partitions t power ndimage dcsp if partitions is none dcnl dcsp dcsp clusters sums find clusters 1dir x x in connectivity max step t power ndimage dcnl dcsp else dcnl dcsp dcsp clusters list dcnl dcsp dcsp sums list dcnl dcsp dcsp for p in range np max partitions + 1 dcnl dcsp dcsp dcsp x i np logical and x in partitions p dcnl dcsp dcsp dcsp out find clusters 1dir x x i connectivity max step t power ndimage dcnl dcsp dcsp dcsp clusters + out0 dcnl dcsp dcsp dcsp sums append out1 dcnl dcsp dcsp sums np concatenate sums dcnl dcsp return clusters sums
def find clusters 1dir x x in connectivity max step t power ndimage dcsp if connectivity is none dcnl dcsp dcsp labels n labels ndimage label x in dcnl dcsp dcsp if x ndim 1 dcnl dcsp dcsp dcsp clusters ndimage find objects labels n labels dcnl dcsp dcsp dcsp if len clusters 0 dcnl dcsp dcsp dcsp dcsp sums list dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp index list range 1 n labels + 1 dcnl dcsp dcsp dcsp dcsp if t power 1 dcnl dcsp dcsp dcsp dcsp dcsp sums ndimage measurements sum x labels index index dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp sums ndimage measurements sum np sign x np abs x t power labels index index dcnl dcsp dcsp else dcnl dcsp dcsp dcsp clusters list dcnl dcsp dcsp dcsp sums np empty n labels dcnl dcsp dcsp dcsp for l in range 1 n labels + 1 dcnl dcsp dcsp dcsp dcsp c labels l dcnl dcsp dcsp dcsp dcsp clusters append c ravel dcnl dcsp dcsp dcsp dcsp if t power 1 dcnl dcsp dcsp dcsp dcsp dcsp sums l 1 np sum xc dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp sums l 1 np sum np sign xc np abs xc t power dcnl dcsp else dcnl dcsp dcsp if x ndim 1 dcnl dcsp dcsp dcsp raise exception data dcsp should dcsp be dcsp 1d dcsp when dcsp using dcsp a dcsp connectivity dcsp to dcsp define dcsp clusters dcnl dcsp dcsp if isinstance connectivity sparse spmatrix dcnl dcsp dcsp dcsp clusters get components x in connectivity dcnl dcsp dcsp elif isinstance connectivity list dcnl dcsp dcsp dcsp clusters get clusters st x in connectivity max step dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror connectivity dcsp must dcsp be dcsp a dcsp sparse dcsp matrix dcsp or dcsp list dcnl dcsp dcsp if t power 1 dcnl dcsp dcsp dcsp sums np array np sum xc for c in clusters dcnl dcsp dcsp else dcnl dcsp dcsp dcsp sums np array np sum np sign xc np abs xc t power for c in clusters dcnl dcsp return clusters np atleast 1d sums
def cluster indices to mask components n tot dcsp for ci c in enumerate components dcnl dcsp dcsp componentsci np zeros n tot dtype bool dcnl dcsp dcsp componentscic true dcnl dcsp return components
def cluster mask to indices components dcsp for ci c in enumerate components dcnl dcsp dcsp if not isinstance c slice dcnl dcsp dcsp dcsp componentsci np where c 0 dcnl dcsp return components
def pval from histogram t h0 tail dcsp if tail not in 1 0 1 dcnl dcsp dcsp raise valueerror invalid dcsp tail dcsp parameter dcnl dcsp if tail 1 dcnl dcsp dcsp pval np array np sum h0 < t for t in t dcnl dcsp elif tail 1 dcnl dcsp dcsp pval np array np sum h0 t for t in t dcnl dcsp else dcnl dcsp dcsp pval np array np sum abs h0 abs t for t in t dcnl dcsp pval pval + 1 0 h0 size + 1 0 dcnl dcsp return pval
def ttest 1samp no p x sigma 0 method relative dcsp if method not in absolute relative dcnl dcsp dcsp raise valueerror method dcsp must dcsp be dcsp absolute dcsp or dcsp relative dcsp not dcsp s method dcnl dcsp var np var x axis 0 ddof 1 dcnl dcsp if sigma 0 dcnl dcsp dcsp limit sigma np max var if method relative else sigma dcnl dcsp dcsp var + limit dcnl dcsp return np mean x axis 0 np sqrt var x shape0
verbose dcnl def permutation cluster test x threshold none n permutations 1024 tail 0 stat fun f oneway connectivity none verbose none n jobs 1 seed none max step 1 exclude none step down p 0 t power 1 out type mask check disjoint false buffer size 1000 dcsp from scipy import stats dcnl dcsp ppf stats f ppf dcnl dcsp if threshold is none dcnl dcsp dcsp p thresh 0 05 1 + tail 0 dcnl dcsp dcsp n samples per group len x for x in x dcnl dcsp dcsp threshold ppf 1 0 p thresh n samples per group dcnl dcsp dcsp if np sign tail < 0 dcnl dcsp dcsp dcsp threshold threshold dcnl dcsp return permutation cluster test x x threshold threshold n permutations n permutations tail tail stat fun stat fun connectivity connectivity verbose verbose n jobs n jobs seed seed max step max step exclude exclude step down p step down p t power t power out type out type check disjoint check disjoint buffer size buffer size
verbose dcnl def permutation cluster 1samp test x threshold none n permutations 1024 tail 0 stat fun ttest 1samp no p connectivity none verbose none n jobs 1 seed none max step 1 exclude none step down p 0 t power 1 out type mask check disjoint false buffer size 1000 dcsp from scipy import stats dcnl dcsp ppf stats t ppf dcnl dcsp if threshold is none dcnl dcsp dcsp p thresh 0 05 1 + tail 0 dcnl dcsp dcsp n samples len x dcnl dcsp dcsp threshold ppf p thresh n samples 1 dcnl dcsp dcsp if np sign tail < 0 dcnl dcsp dcsp dcsp threshold threshold dcnl dcsp x x dcnl dcsp return permutation cluster test x x threshold threshold n permutations n permutations tail tail stat fun stat fun connectivity connectivity verbose verbose n jobs n jobs seed seed max step max step exclude exclude step down p step down p t power t power out type out type check disjoint check disjoint buffer size buffer size
verbose dcnl def spatio temporal cluster 1samp test x threshold none n permutations 1024 tail 0 stat fun ttest 1samp no p connectivity none verbose none n jobs 1 seed none max step 1 spatial exclude none step down p 0 t power 1 out type indices check disjoint false buffer size 1000 dcsp n samples n times n vertices x shape dcnl dcsp if spatial exclude is not none dcnl dcsp dcsp exclude st mask from s inds n times n vertices spatial exclude true dcnl dcsp else dcnl dcsp dcsp exclude none dcnl dcsp out permutation cluster 1samp test x threshold threshold stat fun stat fun tail tail n permutations n permutations connectivity connectivity n jobs n jobs seed seed max step max step exclude exclude step down p step down p t power t power out type out type check disjoint check disjoint buffer size buffer size dcnl dcsp return out
verbose dcnl def spatio temporal cluster test x threshold 1 67 n permutations 1024 tail 0 stat fun f oneway connectivity none verbose none n jobs 1 seed none max step 1 spatial exclude none step down p 0 t power 1 out type indices check disjoint false buffer size 1000 dcsp n samples n times n vertices x0 shape dcnl dcsp if spatial exclude is not none dcnl dcsp dcsp exclude st mask from s inds n times n vertices spatial exclude true dcnl dcsp else dcnl dcsp dcsp exclude none dcnl dcsp out permutation cluster test x threshold threshold stat fun stat fun tail tail n permutations n permutations connectivity connectivity n jobs n jobs seed seed max step max step exclude exclude step down p step down p t power t power out type out type check disjoint check disjoint buffer size buffer size dcnl dcsp return out
def st mask from s inds n times n vertices vertices set as true dcsp mask np zeros n times n vertices dtype bool dcnl dcsp mask vertices true dcnl dcsp mask mask ravel dcnl dcsp if set as is false dcnl dcsp dcsp mask np logical not mask dcnl dcsp return mask
verbose dcnl def get partitions from connectivity connectivity n times verbose none dcsp if isinstance connectivity list dcnl dcsp dcsp test np ones len connectivity dcnl dcsp dcsp test conn np zeros len connectivity len connectivity dtype bool dcnl dcsp dcsp for vi in range len connectivity dcnl dcsp dcsp dcsp test conn connectivityvi vi true dcnl dcsp dcsp test conn sparse coo matrix test conn dtype float dcnl dcsp else dcnl dcsp dcsp test np ones connectivity shape0 dcnl dcsp dcsp test conn connectivity dcnl dcsp part clusts find clusters test 0 1 test conn 0 dcnl dcsp if len part clusts 1 dcnl dcsp dcsp logger info i dcsp disjoint dcsp connectivity dcsp sets dcsp found len part clusts dcnl dcsp dcsp partitions np zeros len test dtype int dcnl dcsp dcsp for ii pc in enumerate part clusts dcnl dcsp dcsp dcsp partitionspc ii dcnl dcsp dcsp if isinstance connectivity list dcnl dcsp dcsp dcsp partitions np tile partitions n times dcnl dcsp else dcnl dcsp dcsp logger info no dcsp disjoint dcsp connectivity dcsp sets dcsp found dcnl dcsp dcsp partitions none dcnl dcsp return partitions
def reshape clusters clusters sample shape dcsp if len clusters 0 and isinstance clusters0 np ndarray dcnl dcsp dcsp if clusters0 dtype bool dcnl dcsp dcsp dcsp clusters c reshape sample shape for c in clusters dcnl dcsp dcsp else dcnl dcsp dcsp dcsp clusters np unravel index c sample shape for c in clusters dcnl dcsp return clusters
def summarize clusters stc clu p thresh 0 05 tstep 0 001 tmin 0 subject fsaverage vertices none dcsp if vertices is none dcnl dcsp dcsp vertices np arange 10242 np arange 10242 dcnl dcsp t obs clusters clu pvals clu dcnl dcsp n times n vertices t obs shape dcnl dcsp good cluster inds np where clu pvals < p thresh 0 dcnl dcsp if len good cluster inds 0 dcnl dcsp dcsp data np zeros n vertices n times dcnl dcsp dcsp data summary np zeros n vertices len good cluster inds + 1 dcnl dcsp dcsp for ii cluster ind in enumerate good cluster inds dcnl dcsp dcsp dcsp data fill 0 dcnl dcsp dcsp dcsp v inds clusterscluster ind1 dcnl dcsp dcsp dcsp t inds clusterscluster ind0 dcnl dcsp dcsp dcsp data v inds t inds t obs t inds v inds dcnl dcsp dcsp dcsp data np sign data np logical not data 0 tstep dcnl dcsp dcsp dcsp data summary ii + 1 1000 0 np sum data axis 1 dcnl dcsp dcsp data summary 0 np sum data summary axis 1 dcnl dcsp dcsp return sourceestimate data summary vertices tmin tmin tstep tstep subject subject dcnl dcsp else dcnl dcsp dcsp raise runtimeerror no dcsp significant dcsp clusters dcsp available dcsp please dcsp adjust dcsp your dcsp threshold dcsp or dcsp check dcsp your dcsp statistical dcsp analysis
testing requires testing data dcnl def test regression dcsp tmin tmax 0 2 0 5 dcnl dcsp event id dict aud l 1 aud r 2 dcnl dcsp raw mne io read raw fif raw fname dcnl dcsp events mne read events event fname 10 dcnl dcsp epochs mne epochs raw events event id tmin tmax proj true baseline none 0 dcnl dcsp picks np arange len epochs ch names dcnl dcsp evoked epochs average picks picks dcnl dcsp design matrix epochs events 1 astype np float64 dcnl dcsp design matrix 0 1 dcnl dcsp design matrix 1 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp lm linear regression epochs design matrix intercept aud dcnl dcsp dcsp assert true w0 category runtimewarning dcnl dcsp dcsp assert true nondata in s w0 message dcnl dcsp for predictor parameters in lm items dcnl dcsp dcsp for value in parameters dcnl dcsp dcsp dcsp assert equal value data shape evoked data shape dcnl dcsp assert raises valueerror linear regression epochs epochs design matrix dcnl dcsp stc read source estimate stc fname crop 0 0 02 dcnl dcsp stc list stc stc stc dcnl dcsp stc gen s for s in stc list dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp lm1 linear regression stc list design matrix len stc list dcnl dcsp lm2 linear regression stc gen design matrix len stc list dcnl dcsp for val in lm2 values dcnl dcsp dcsp assert true np isfinite val p val data all dcnl dcsp dcsp assert true val p val data < 1 all dcnl dcsp dcsp assert true val p val data 0 all dcnl dcsp dcsp assert true np isfinite val mlog10 p val data all dcnl dcsp dcsp assert true val mlog10 p val data 0 all dcnl dcsp dcsp assert true val mlog10 p val data 0 all dcnl dcsp for k in lm1 dcnl dcsp dcsp for v1 v2 in zip lm1k lm2k dcnl dcsp dcsp dcsp assert array equal v1 data v2 data
testing requires testing data dcnl def test continuous regression no overlap dcsp tmin tmax 0 1 0 5 dcnl dcsp raw mne io read raw fif raw fname preload true dcnl dcsp raw apply proj dcnl dcsp events mne read events event fname dcnl dcsp event id dict audio l 1 audio r 2 dcnl dcsp raw raw pick channels raw ch names 2 dcnl dcsp epochs mne epochs raw events event id tmin tmax baseline none reject none dcnl dcsp revokeds linear regression raw raw events event id tmin tmin tmax tmax reject none dcnl dcsp for cond in event id keys dcnl dcsp dcsp assert allclose revokedscond data epochscond average data rtol 1e15 dcnl dcsp old latency events 1 0 dcnl dcsp events 1 0 events 0 0 dcnl dcsp assert raises valueerror linear regression raw raw events event id tmin tmax dcnl dcsp events 1 0 old latency dcnl dcsp events 0 range len events dcnl dcsp assert raises valueerror linear regression raw raw events event id tmin tmax decim 2
requires sklearn dcnl testing requires testing data dcnl def test continuous regression with overlap dcsp signal np zeros 100000 dcnl dcsp times 1000 2500 3000 5000 5250 7000 7250 8000 dcnl dcsp events np zeros len times 3 int dcnl dcsp events 2 1 dcnl dcsp events 0 times dcnl dcsp signalevents 0 1 0 dcnl dcsp effect hann 101 dcnl dcsp signal np convolve signal effect len signal dcnl dcsp raw rawarray signalnp newaxis mne create info 1 100 eeg dcnl dcsp assert allclose effect linear regression raw raw events 1 1 tmin 0 1 data flatten dcnl dcsp from sklearn linear model ridge import ridge regression dcnl dcsp def solver x y dcnl dcsp dcsp return ridge regression x y alpha 0 0 dcnl dcsp assert allclose effect linear regression raw raw events tmin 0 solver solver 1 data flatten dcnl dcsp def solt x y dcnl dcsp dcsp return ridge regression x y alpha 0 0 t dcnl dcsp assert raises valueerror linear regression raw raw events solver solt dcnl dcsp assert raises valueerror linear regression raw raw events solver err dcnl dcsp assert raises typeerror linear regression raw raw events solver 0
def generate data n subjects n conditions dcsp rng np random randomstate 42 dcnl dcsp data rng randn n subjects n conditions reshape n subjects n conditions dcnl dcsp return data
def test map effects dcsp selection names map effects n factors 2 effects a dcnl dcsp assert true names a dcnl dcsp selection names map effects n factors 2 effects a a b dcnl dcsp assert true names a a b dcnl dcsp selection names map effects n factors 3 effects a b dcnl dcsp assert true names a b a b dcnl dcsp selection names map effects n factors 3 effects a c dcnl dcsp assert true names a b a b c a c b c a b c dcnl dcsp assert raises valueerror map effects n factors 2 effects c dcnl dcsp assert raises valueerror map effects n factors 27 effects all
def test f twoway rm dcsp rng np random randomstate 42 dcnl dcsp iter params product 4 10 2 15 4 6 8 a b a b false true dcnl dcsp effects 4 2 2 6 2 3 8 2 4 dcnl dcsp for params in iter params dcnl dcsp dcsp n subj n obs n levels effects correction params dcnl dcsp dcsp data rng random sample n subj n levels n obs dcnl dcsp dcsp fvals pvals f mway rm data effectsn levels effects correction correction dcnl dcsp dcsp assert true fvals 0 all dcnl dcsp dcsp if pvals any dcnl dcsp dcsp dcsp assert true 0 < pvals 1 pvals all dcnl dcsp dcsp n effects len map effects n subj effects 0 dcnl dcsp dcsp assert true fvals size n obs n effects dcnl dcsp dcsp if n effects 1 dcnl dcsp dcsp dcsp assert true fvals ndim 1 dcnl dcsp dcsp fvals f threshold mway rm n subj effectsn levels effects dcnl dcsp dcsp assert true fvals 0 all dcnl dcsp dcsp assert true fvals size n effects dcnl dcsp data rng random sample n subj n levels 1 dcnl dcsp assert raises valueerror f mway rm data effectsn levels effects c correction correction dcnl dcsp data rng random sample n subj n levels n obs 3 dcnl dcsp f mway rm data effectsn levels effects correction correction dcnl dcsp test data generate data n subjects 20 n conditions 6 dcnl dcsp fvals pvals f mway rm test data 2 3 dcnl dcsp assert array almost equal fvals test external spss fvals 3 dcnl dcsp assert array almost equal pvals test external spss pvals uncorrected 3 dcnl dcsp assert array almost equal fvals test external r fvals 4 dcnl dcsp assert array almost equal pvals test external r pvals uncorrected 3 dcnl dcsp pvals f mway rm test data 2 3 correction true dcnl dcsp assert array almost equal pvals test external spss pvals corrected 3 dcnl dcsp test data generate data n subjects 20 n conditions 8 dcnl dcsp fvals f mway rm test data 2 2 2 dcnl dcsp assert array almost equal fvals test external r fvals 3way 5 dcnl dcsp fvals f mway rm test data 8 a dcnl dcsp assert array almost equal fvals test external r fvals 1way 5
def test permutation t test dcsp np random seed 10 dcnl dcsp n samples n tests 30 5 dcnl dcsp x np random randn n samples n tests dcnl dcsp x 2 + 1 dcnl dcsp t obs p values h0 permutation t test x n permutations 999 tail 0 dcnl dcsp is significant p values < 0 05 dcnl dcsp assert array equal is significant true true false false false dcnl dcsp t obs p values h0 permutation t test x n permutations 999 tail 1 dcnl dcsp is significant p values < 0 05 dcnl dcsp assert array equal is significant true true false false false dcnl dcsp t obs p values h0 permutation t test x n permutations 999 tail 1 dcnl dcsp is significant p values < 0 05 dcnl dcsp assert array equal is significant false false false false false dcnl dcsp x np random randn 18 1 dcnl dcsp t obs p values h0 permutation t test x 0 n permutations all dcnl dcsp t obs scipy p values scipy stats ttest 1samp x 0 0 dcnl dcsp assert almost equal t obs0 t obs scipy 8 dcnl dcsp assert almost equal p values0 p values scipy 2
def test multi pval correction dcsp rng np random randomstate 0 dcnl dcsp x rng randn 10 1000 10 dcnl dcsp x 50 0 + 4 0 dcnl dcsp alpha 0 05 dcnl dcsp t pval stats ttest 1samp x 0 dcnl dcsp n samples x shape0 dcnl dcsp n tests x size n samples dcnl dcsp thresh uncorrected stats t ppf 1 0 alpha n samples 1 dcnl dcsp reject bonferroni pval bonferroni bonferroni correction pval alpha dcnl dcsp thresh bonferroni stats t ppf 1 0 alpha n tests n samples 1 dcnl dcsp assert true pval bonferroni ndim 2 dcnl dcsp assert true reject bonferroni ndim 2 dcnl dcsp assert allclose pval bonferroni 10000 pval dcnl dcsp reject expected pval bonferroni < alpha dcnl dcsp assert array equal reject bonferroni reject expected dcnl dcsp fwer np mean reject bonferroni dcnl dcsp assert almost equal fwer alpha 1 dcnl dcsp reject fdr pval fdr fdr correction pval alpha alpha method indep dcnl dcsp assert true pval fdr ndim 2 dcnl dcsp assert true reject fdr ndim 2 dcnl dcsp thresh fdr np min np abs t reject fdr dcnl dcsp assert true 0 < reject fdr sum 50 < 50 1 05 dcnl dcsp assert true thresh uncorrected < thresh fdr < thresh bonferroni dcnl dcsp assert raises valueerror fdr correction pval alpha method blah dcnl dcsp assert true np all fdr correction pval alpha 0 0 0 dcnl dcsp reject fdr pval fdr fdr correction pval alpha alpha method negcorr dcnl dcsp thresh fdr np min np abs t reject fdr dcnl dcsp assert true 0 < reject fdr sum 50 < 50 1 05 dcnl dcsp assert true thresh uncorrected < thresh fdr < thresh bonferroni
def test cache dir dcsp tempdir tempdir dcnl dcsp orig dir os getenv mne cache dir none dcnl dcsp orig size os getenv mne memmap min size none dcnl dcsp rng np random randomstate 0 dcnl dcsp x rng randn 9 2 10 dcnl dcsp try dcnl dcsp dcsp os environ mne memmap min size 1k dcnl dcsp dcsp os environ mne cache dir tempdir dcnl dcsp dcsp with catch logging as log file dcnl dcsp dcsp dcsp permutation cluster 1samp test x buffer size none n jobs 2 n permutations 1 seed 0 stat fun ttest 1samp no p verbose false dcnl dcsp dcsp dcsp stat fun partial ttest 1samp no p sigma 0 001 dcnl dcsp dcsp dcsp assert true independently not in log file getvalue dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp permutation cluster 1samp test x buffer size 10 n jobs 2 n permutations 1 seed 0 stat fun stat fun verbose false dcnl dcsp dcsp dcsp assert true independently in log file getvalue dcnl dcsp finally dcnl dcsp dcsp if orig dir is not none dcnl dcsp dcsp dcsp os environ mne cache dir orig dir dcnl dcsp dcsp else dcnl dcsp dcsp dcsp del os environ mne cache dir dcnl dcsp dcsp if orig size is not none dcnl dcsp dcsp dcsp os environ mne memmap min size orig size dcnl dcsp dcsp else dcnl dcsp dcsp dcsp del os environ mne memmap min size
def test permutation step down p dcsp try dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from sklearn feature extraction image import grid to graph dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp from scikits learn feature extraction image import grid to graph dcnl dcsp except importerror dcnl dcsp dcsp return dcnl dcsp rng np random randomstate 0 dcnl dcsp x rng randn 9 2 10 dcnl dcsp x 0 2 0 2 + 2 dcnl dcsp x 1 5 9 + 0 5 dcnl dcsp thresh 2 dcnl dcsp t clusters p h0 permutation cluster 1samp test x threshold thresh step down p 1 0 dcnl dcsp t clusters p old h0 permutation cluster 1samp test x threshold thresh step down p 0 0 dcnl dcsp assert equal np sum p old < 0 05 1 dcnl dcsp t clusters p new h0 permutation cluster 1samp test x threshold thresh step down p 0 05 dcnl dcsp assert equal np sum p new < 0 05 2 dcnl dcsp assert true np all p old p new
def test cluster permutation test dcsp condition1 1d condition2 1d condition1 2d condition2 2d get conditions dcnl dcsp for condition1 condition2 in zip condition1 1d condition1 2d condition2 1d condition2 2d dcnl dcsp dcsp t obs clusters cluster p values hist permutation cluster test condition1 condition2 n permutations 100 tail 1 seed 1 buffer size none dcnl dcsp dcsp assert equal np sum cluster p values < 0 05 1 dcnl dcsp dcsp t obs clusters cluster p values hist permutation cluster test condition1 condition2 n permutations 100 tail 0 seed 1 buffer size none dcnl dcsp dcsp assert equal np sum cluster p values < 0 05 1 dcnl dcsp dcsp buffer size condition1 shape1 10 dcnl dcsp dcsp t obs clusters cluster p values buff hist permutation cluster test condition1 condition2 n permutations 100 tail 0 seed 1 n jobs 2 buffer size buffer size dcnl dcsp dcsp assert array equal cluster p values cluster p values buff
slow test dcnl def test cluster permutation t test dcsp condition1 1d condition2 1d condition1 2d condition2 2d get conditions dcnl dcsp stat funs ttest 1samp no p partial ttest 1samp no p sigma 0 1 dcnl dcsp for stat fun in stat funs dcnl dcsp dcsp for condition1 in condition1 1d condition1 2d dcnl dcsp dcsp dcsp t obs clusters cluster p values hist permutation cluster 1samp test condition1 n permutations 100 tail 0 seed 1 buffer size none dcnl dcsp dcsp dcsp assert equal np sum cluster p values < 0 05 1 dcnl dcsp dcsp dcsp t obs pos c 1 cluster p values pos permutation cluster 1samp test condition1 n permutations 100 tail 1 threshold 1 67 seed 1 stat fun stat fun buffer size none dcnl dcsp dcsp dcsp t obs neg cluster p values neg permutation cluster 1samp test condition1 n permutations 100 tail 1 threshold 1 67 seed 1 stat fun stat fun buffer size none dcnl dcsp dcsp dcsp assert array equal t obs pos t obs neg dcnl dcsp dcsp dcsp assert array equal cluster p values pos < 0 05 cluster p values neg < 0 05 dcnl dcsp dcsp dcsp buffer size condition1 shape1 10 dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp t obs neg buff cluster p values neg buff permutation cluster 1samp test condition1 n permutations 100 tail 1 threshold 1 67 seed 1 n jobs 2 stat fun stat fun buffer size buffer size dcnl dcsp dcsp dcsp assert array equal t obs neg t obs neg buff dcnl dcsp dcsp dcsp assert array equal cluster p values neg cluster p values neg buff
slow test dcnl def test cluster permutation with connectivity dcsp try dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from sklearn feature extraction image import grid to graph dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp from scikits learn feature extraction image import grid to graph dcnl dcsp except importerror dcnl dcsp dcsp return dcnl dcsp condition1 1d condition2 1d condition1 2d condition2 2d get conditions dcnl dcsp n pts condition1 1d shape1 dcnl dcsp args dict seed none max step 1 exclude none step down p 0 t power 1 threshold 1 67 check disjoint false n permutations 50 dcnl dcsp did warn false dcnl dcsp for x1d x2d func spatio temporal func in condition1 1d condition1 2d permutation cluster 1samp test spatio temporal cluster 1samp test condition1 1d condition2 1d condition1 2d condition2 2d permutation cluster test spatio temporal cluster test dcnl dcsp dcsp out func x1d args dcnl dcsp dcsp connectivity grid to graph 1 n pts dcnl dcsp dcsp out connectivity func x1d connectivity connectivity args dcnl dcsp dcsp assert array equal out0 out connectivity0 dcnl dcsp dcsp for a b in zip out connectivity1 out1 dcnl dcsp dcsp dcsp assert array equal out0a out0b dcnl dcsp dcsp dcsp assert true np all ab dcnl dcsp dcsp connectivity 2 sparse coo matrix linalg block diag connectivity asfptype todense connectivity asfptype todense dcnl dcsp dcsp if isinstance x1d list dcnl dcsp dcsp dcsp x1d 2 np concatenate x x axis 1 for x in x1d dcnl dcsp dcsp else dcnl dcsp dcsp dcsp x1d 2 np concatenate x1d x1d axis 1 dcnl dcsp dcsp out connectivity 2 func x1d 2 connectivity connectivity 2 args dcnl dcsp dcsp split len out0 dcnl dcsp dcsp assert array equal out0 out connectivity 20 split dcnl dcsp dcsp assert array equal out0 out connectivity 20split dcnl dcsp dcsp n clust orig len out1 dcnl dcsp dcsp assert true len out connectivity 21 2 n clust orig dcnl dcsp dcsp data 1 set np sum out0b n pts for b in out1 dcnl dcsp dcsp data 2 set np sum out connectivity 20a for a in out connectivity 21 dcnl dcsp dcsp assert true len data 1 intersection data 2 len data 1 dcnl dcsp dcsp if isinstance x1d list dcnl dcsp dcsp dcsp x1d 3 np reshape x 1 2 n space for x in x1d 2 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp x1d 3 np reshape x1d 2 1 2 n space dcnl dcsp dcsp out connectivity 3 spatio temporal func x1d 3 n permutations 50 connectivity connectivity max step 0 threshold 1 67 check disjoint true dcnl dcsp dcsp split len out0 dcnl dcsp dcsp assert array equal out0 out connectivity 300 dcnl dcsp dcsp assert array equal out0 out connectivity 301 dcnl dcsp dcsp assert true len out connectivity 31 2 n clust orig dcnl dcsp dcsp data 1 set np sum out0b n pts for b in out1 dcnl dcsp dcsp data 2 set np sum out connectivity 30 a0 a1 for a in out connectivity 31 dcnl dcsp dcsp assert true len data 1 intersection data 2 len data 1 dcnl dcsp dcsp out connectivity 4 spatio temporal func x1d 3 n permutations 50 connectivity connectivity max step 2 threshold 1 67 dcnl dcsp dcsp out connectivity 5 spatio temporal func x1d 3 n permutations 50 connectivity connectivity max step 1 threshold 1 67 dcnl dcsp dcsp sums 4 np sum out connectivity 40a for a in out connectivity 41 dcnl dcsp dcsp sums 5 np sum out connectivity 40a for a in out connectivity 51 dcnl dcsp dcsp sums 4 np sort sums 4 dcnl dcsp dcsp sums 5 np sort sums 5 dcnl dcsp dcsp assert array almost equal sums 4 sums 5 dcnl dcsp dcsp if not force serial dcnl dcsp dcsp dcsp assert raises valueerror spatio temporal func x1d 3 n permutations 1 connectivity connectivity max step 1 threshold 1 67 n jobs 1000 dcnl dcsp dcsp assert raises keyerror spatio temporal func x1d 3 connectivity connectivity threshold dict me hello dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp spatio temporal func x1d 3 connectivity connectivity threshold dict start 10 step 1 dcnl dcsp dcsp if not did warn dcnl dcsp dcsp dcsp assert true len w 1 dcnl dcsp dcsp dcsp did warn true dcnl dcsp dcsp assert raises valueerror spatio temporal func x1d 3 connectivity connectivity tail 1 threshold dict start 1 step 1 dcnl dcsp dcsp assert raises valueerror spatio temporal func x1d 3 connectivity connectivity tail 1 threshold dict start 1 step 1 dcnl dcsp dcsp assert raises typeerror spatio temporal func x1d 3 connectivity connectivity threshold dcnl dcsp dcsp assert raises valueerror spatio temporal func x1d 3 connectivity connectivity tail 2 dcnl dcsp dcsp out connectivity 6 spatio temporal func x1d 3 n permutations 50 connectivity connectivity max step 1 threshold dict start 1 step 1 dcnl dcsp dcsp assert true np min out connectivity 62 < 0 05
slow test dcnl def test permutation connectivity equiv dcsp try dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from sklearn feature extraction image import grid to graph dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp from scikits learn feature extraction image import grid to graph dcnl dcsp except importerror dcnl dcsp dcsp return dcnl dcsp rng np random randomstate 0 dcnl dcsp n time 2 dcnl dcsp n space 4 dcnl dcsp x rng randn 6 n time n space dcnl dcsp x 0 2 + 10 dcnl dcsp x 1 3 + 20 dcnl dcsp max steps 1 1 1 2 dcnl dcsp conns none grid to graph n time n space grid to graph 1 n space grid to graph 1 n space dcnl dcsp stat map none dcnl dcsp thresholds 2 dict start 1 5 step 1 0 dcnl dcsp sig counts 2 5 dcnl dcsp sdps 0 0 05 0 05 dcnl dcsp ots mask mask indices dcnl dcsp stat fun partial ttest 1samp no p sigma 0 001 dcnl dcsp for thresh count in zip thresholds sig counts dcnl dcsp dcsp cs none dcnl dcsp dcsp ps none dcnl dcsp dcsp for max step conn in zip max steps conns dcnl dcsp dcsp dcsp for sdp ot in zip sdps ots dcnl dcsp dcsp dcsp dcsp t clusters p h0 permutation cluster 1samp test x threshold thresh connectivity conn n jobs 2 max step max step stat fun stat fun step down p sdp out type ot dcnl dcsp dcsp dcsp dcsp if ot mask dcnl dcsp dcsp dcsp dcsp dcsp assert true isinstance clusters0 np ndarray dcnl dcsp dcsp dcsp dcsp dcsp assert true clusters0 dtype bool dcnl dcsp dcsp dcsp dcsp dcsp assert array equal clusters0 shape x shape1 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp assert true isinstance clusters0 tuple dcnl dcsp dcsp dcsp dcsp if count 8 dcnl dcsp dcsp dcsp dcsp dcsp assert true not np any h0 0 dcnl dcsp dcsp dcsp dcsp inds np where p < 0 05 0 dcnl dcsp dcsp dcsp dcsp assert true len inds count dcnl dcsp dcsp dcsp dcsp this cs clustersii for ii in inds dcnl dcsp dcsp dcsp dcsp this ps pinds dcnl dcsp dcsp dcsp dcsp this stat map np zeros n time n space dtype bool dcnl dcsp dcsp dcsp dcsp for ci c in enumerate this cs dcnl dcsp dcsp dcsp dcsp dcsp if isinstance c tuple dcnl dcsp dcsp dcsp dcsp dcsp dcsp this c np zeros n time n space bool dcnl dcsp dcsp dcsp dcsp dcsp dcsp for x y in zip c0 c1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp this stat map x y true dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp this c x y true dcnl dcsp dcsp dcsp dcsp dcsp dcsp this csci this c dcnl dcsp dcsp dcsp dcsp dcsp dcsp c this c dcnl dcsp dcsp dcsp dcsp dcsp this stat mapc true dcnl dcsp dcsp dcsp dcsp if cs is none dcnl dcsp dcsp dcsp dcsp dcsp ps this ps dcnl dcsp dcsp dcsp dcsp dcsp cs this cs dcnl dcsp dcsp dcsp dcsp if stat map is none dcnl dcsp dcsp dcsp dcsp dcsp stat map this stat map dcnl dcsp dcsp dcsp dcsp assert array equal ps this ps dcnl dcsp dcsp dcsp dcsp assert true len cs len this cs dcnl dcsp dcsp dcsp dcsp for c1 c2 in zip cs this cs dcnl dcsp dcsp dcsp dcsp dcsp assert array equal c1 c2 dcnl dcsp dcsp dcsp dcsp assert array equal stat map this stat map
slow test dcnl def spatio temporal cluster test connectivity dcsp try dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from sklearn feature extraction image import grid to graph dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp from scikits learn feature extraction image import grid to graph dcnl dcsp except importerror dcnl dcsp dcsp return dcnl dcsp condition1 1d condition2 1d condition1 2d condition2 2d get conditions dcnl dcsp rng np random randomstate 0 dcnl dcsp noise1 2d rng randn condition1 2d shape0 condition1 2d shape1 10 dcnl dcsp data1 2d np transpose np dstack condition1 2d noise1 2d 0 2 1 dcnl dcsp noise2 d2 rng randn condition2 2d shape0 condition2 2d shape1 10 dcnl dcsp data2 2d np transpose np dstack condition2 2d noise2 d2 0 2 1 dcnl dcsp conn grid to graph data1 2d shape 1 1 dcnl dcsp threshold dict start 4 0 step 2 dcnl dcsp t obs clusters p values conn hist spatio temporal cluster test data1 2d data2 2d connectivity conn n permutations 50 tail 1 seed 1 threshold threshold buffer size none dcnl dcsp buffer size data1 2d size 10 dcnl dcsp t obs clusters p values no conn hist spatio temporal cluster test data1 2d data2 2d n permutations 50 tail 1 seed 1 threshold threshold n jobs 2 buffer size buffer size dcnl dcsp assert equal np sum p values conn < 0 05 np sum p values no conn < 0 05 dcnl dcsp t obs clusters p values2 hist2 spatio temporal cluster test data1 2d data2 2d n permutations 50 tail 1 seed 1 threshold threshold n jobs 2 buffer size none dcnl dcsp assert array equal p values no conn p values2 dcnl dcsp assert raises valueerror spatio temporal cluster test data1 2d data2 2d tail 1 threshold 2 0 dcnl dcsp assert raises valueerror spatio temporal cluster test data1 2d data2 2d tail 1 threshold 2 0 dcnl dcsp assert raises valueerror spatio temporal cluster test data1 2d data2 2d tail 0 threshold 1
def ttest 1samp x dcsp return stats ttest 1samp x 0 0
def test summarize clusters dcsp clu np random random 1 20484 np array 0 np array 0 2 4 np array 0 02 0 1 np array 12 14 30 dcnl dcsp stc sum summarize clusters stc clu dcnl dcsp assert true stc sum data shape1 2 dcnl dcsp clu20 0 3 dcnl dcsp assert raises runtimeerror summarize clusters stc clu
def ecdf x dcsp nobs len x dcnl dcsp return np arange 1 nobs + 1 float nobs
def fdr correction pvals alpha 0 05 method indep dcsp pvals np asarray pvals dcnl dcsp shape init pvals shape dcnl dcsp pvals pvals ravel dcnl dcsp pvals sortind np argsort pvals dcnl dcsp pvals sorted pvalspvals sortind dcnl dcsp sortrevind pvals sortind argsort dcnl dcsp if method in i indep p poscorr dcnl dcsp dcsp ecdffactor ecdf pvals sorted dcnl dcsp elif method in n negcorr dcnl dcsp dcsp cm np sum 1 0 np arange 1 len pvals sorted + 1 dcnl dcsp dcsp ecdffactor ecdf pvals sorted cm dcnl dcsp else dcnl dcsp dcsp raise valueerror method dcsp should dcsp be dcsp indep dcsp and dcsp negcorr dcnl dcsp reject pvals sorted < ecdffactor alpha dcnl dcsp if reject any dcnl dcsp dcsp rejectmax max np nonzero reject 0 dcnl dcsp else dcnl dcsp dcsp rejectmax 0 dcnl dcsp reject rejectmax true dcnl dcsp pvals corrected raw pvals sorted ecdffactor dcnl dcsp pvals corrected np minimum accumulate pvals corrected raw 1 1 dcnl dcsp pvals corrected pvals corrected 1 0 1 0 dcnl dcsp pvals corrected pvals correctedsortrevind reshape shape init dcnl dcsp reject rejectsortrevind reshape shape init dcnl dcsp return reject pvals corrected
def bonferroni correction pval alpha 0 05 dcsp pval np asarray pval dcnl dcsp pval corrected pval float pval size dcnl dcsp reject pval corrected < alpha dcnl dcsp return reject pval corrected
def linear regression inst design matrix names none dcsp if names is none dcnl dcsp dcsp names x i i for i in range design matrix shape1 dcnl dcsp if isinstance inst baseepochs dcnl dcsp dcsp picks pick types inst info meg true eeg true ref meg true stim false eog false ecg false emg false exclude bads dcnl dcsp dcsp if inst ch namesp for p in picks inst ch names dcnl dcsp dcsp dcsp warn fitting dcsp linear dcsp model dcsp to dcsp nondata dcsp or dcsp bad dcsp channels dcsp check dcsp picking dcnl dcsp dcsp msg fitting dcsp linear dcsp model dcsp to dcsp epochs dcnl dcsp dcsp data inst get data dcnl dcsp dcsp out evokedarray np zeros data shape1 inst info inst tmin dcnl dcsp elif isgenerator inst dcnl dcsp dcsp msg fitting dcsp linear dcsp model dcsp to dcsp source dcsp estimates dcsp generator dcsp input dcnl dcsp dcsp out next inst dcnl dcsp dcsp data np array out data + i data for i in inst dcnl dcsp elif isinstance inst list and isinstance inst0 sourceestimate dcnl dcsp dcsp msg fitting dcsp linear dcsp model dcsp to dcsp source dcsp estimates dcsp list dcsp input dcnl dcsp dcsp out inst0 dcnl dcsp dcsp data np array i data for i in inst dcnl dcsp else dcnl dcsp dcsp raise valueerror input dcsp must dcsp be dcsp epochs dcsp or dcsp iterable dcsp of dcsp source dcsp estimates dcnl dcsp logger info msg + dcsp s dcsp targets dcsp s dcsp regressors np product data shape1 len names dcnl dcsp lm params fit lm data design matrix names dcnl dcsp lm namedtuple lm beta dcsp stderr dcsp t val dcsp p val dcsp mlog10 p val dcnl dcsp lm fits dcnl dcsp for name in names dcnl dcsp dcsp parameters pname for p in lm params dcnl dcsp dcsp for ii value in enumerate parameters dcnl dcsp dcsp dcsp out out copy dcnl dcsp dcsp dcsp if not isinstance out sourceestimate evoked dcnl dcsp dcsp dcsp dcsp raise runtimeerror invalid dcsp container dcnl dcsp dcsp dcsp out data value dcnl dcsp dcsp dcsp parametersii out dcnl dcsp dcsp lm fitsname lm parameters dcnl dcsp logger info done dcnl dcsp return lm fits
def fit lm data design matrix names dcsp from scipy import stats dcnl dcsp n samples len data dcnl dcsp n features np product data shape1 dcnl dcsp if design matrix ndim 2 dcnl dcsp dcsp raise valueerror design dcsp matrix dcsp must dcsp be dcsp a dcsp 2d dcsp array dcnl dcsp n rows n predictors design matrix shape dcnl dcsp if n samples n rows dcnl dcsp dcsp raise valueerror number dcsp of dcsp rows dcsp in dcsp design dcsp matrix dcsp must dcsp be dcsp equal dcsp to dcsp number dcsp of dcsp observations dcnl dcsp if n predictors len names dcnl dcsp dcsp raise valueerror number dcsp of dcsp regressor dcsp names dcsp must dcsp be dcsp equal dcsp to dcsp number dcsp of dcsp column dcsp in dcsp design dcsp matrix dcnl dcsp y np reshape data n samples n features dcnl dcsp betas resid sum squares linalg lstsq a design matrix b y dcnl dcsp df n rows n predictors dcnl dcsp sqrt noise var np sqrt resid sum squares df reshape data shape1 dcnl dcsp design invcov linalg inv np dot design matrix t design matrix dcnl dcsp unscaled stderrs np sqrt np diag design invcov dcnl dcsp tiny np finfo np float64 tiny dcnl dcsp beta stderr t val p val mlog10 p val dict for in range 5 dcnl dcsp for x unscaled stderr predictor in zip betas unscaled stderrs names dcnl dcsp dcsp betapredictor x reshape data shape1 dcnl dcsp dcsp stderrpredictor sqrt noise var unscaled stderr dcnl dcsp dcsp p valpredictor np empty like stderrpredictor dcnl dcsp dcsp t valpredictor np empty like stderrpredictor dcnl dcsp dcsp stderr pos stderrpredictor 0 dcnl dcsp dcsp beta pos betapredictor 0 dcnl dcsp dcsp t valpredictorstderr pos betapredictorstderr pos stderrpredictorstderr pos dcnl dcsp dcsp cdf stats t cdf np abs t valpredictorstderr pos df dcnl dcsp dcsp p valpredictorstderr pos np clip 1 0 cdf 2 0 tiny 1 0 dcnl dcsp dcsp mask ~ stderr pos beta pos dcnl dcsp dcsp t valpredictormask np inf np sign betapredictormask dcnl dcsp dcsp p valpredictormask tiny dcnl dcsp dcsp mask ~ stderr pos ~ beta pos dcnl dcsp dcsp t valpredictormask 0 dcnl dcsp dcsp p valpredictormask 1 0 dcnl dcsp dcsp mlog10 p valpredictor np log10 p valpredictor dcnl dcsp return beta stderr t val p val mlog10 p val
def linear regression raw raw events event id none tmin 0 1 tmax 1 covariates none reject none flat none tstep 1 0 decim 1 picks none solver cholesky dcsp if isinstance solver string types dcnl dcsp dcsp if solver not in cholesky dcnl dcsp dcsp dcsp raise valueerror no dcsp such dcsp solver dcsp 0 format solver dcnl dcsp dcsp if solver cholesky dcnl dcsp dcsp dcsp def solver x y dcnl dcsp dcsp dcsp dcsp a x t x toarray dcnl dcsp dcsp dcsp dcsp return linalg solve a x t y sym pos true overwrite a true overwrite b true t dcnl dcsp elif callable solver dcnl dcsp dcsp warn when dcsp using dcsp a dcsp custom dcsp solver dcsp note dcsp that dcsp since dcsp mne dcsp 0 15 dcsp this dcsp function dcsp will dcsp pass dcsp the dcsp transposed dcsp data dcsp n channels dcsp n times dcsp to dcsp the dcsp solver dcsp if dcsp you dcsp are dcsp using dcsp a dcsp solver dcsp that dcsp expects dcsp a dcsp different dcsp format dcsp it dcsp will dcsp give dcsp wrong dcsp results dcsp and dcsp might dcsp in dcsp extreme dcsp cases dcsp crash dcsp your dcsp session dcnl dcsp else dcnl dcsp dcsp raise typeerror the dcsp solver dcsp must dcsp be dcsp a dcsp str dcsp or dcsp a dcsp callable dcnl dcsp data info events prepare rerp data raw events picks picks decim decim dcnl dcsp if event id is none dcnl dcsp dcsp event id dict str v v for v in set events 2 dcnl dcsp x conds cond length tmin s tmax s prepare rerp preds n samples data shape1 sfreq info sfreq events events event id event id tmin tmin tmax tmax covariates covariates dcnl dcsp x data clean rerp input x data reject flat decim info tstep dcnl dcsp coefs solver x data t dcnl dcsp if coefs shape0 data shape0 dcnl dcsp dcsp raise valueerror solver dcsp output dcsp has dcsp unexcepted dcsp shape dcsp supply dcsp a dcsp function dcsp that dcsp returns dcsp coefficients dcsp in dcsp the dcsp form dcsp n targets dcsp n features dcsp where dcsp targets dcsp dcsp channels dcnl dcsp evokeds make evokeds coefs conds cond length tmin s tmax s info dcnl dcsp return evokeds
def prepare rerp data raw events picks none decim 1 dcsp if picks is none dcnl dcsp dcsp picks pick types raw info meg true eeg true ref meg true dcnl dcsp info pick info raw info picks dcnl dcsp decim int decim dcnl dcsp info sfreq decim dcnl dcsp data times raw dcnl dcsp data datapicks decim dcnl dcsp if len set events 0 < len events 0 dcnl dcsp dcsp raise valueerror events dcsp contains dcsp duplicate dcsp time dcsp points dcsp make dcsp sure dcsp all dcsp entries dcsp in dcsp the dcsp first dcsp column dcsp of dcsp events dcsp are dcsp unique dcnl dcsp events events copy dcnl dcsp events 0 raw first samp dcnl dcsp events 0 decim dcnl dcsp if len set events 0 < len events 0 dcnl dcsp dcsp raise valueerror after dcsp decimating dcsp events dcsp contains dcsp duplicate dcsp time dcsp points dcsp this dcsp means dcsp some dcsp events dcsp are dcsp too dcsp closely dcsp spaced dcsp for dcsp the dcsp requested dcsp decimation dcsp factor dcsp choose dcsp different dcsp events dcsp drop dcsp close dcsp events dcsp or dcsp choose dcsp a dcsp different dcsp decimation dcsp factor dcnl dcsp return data info events
def prepare rerp preds n samples sfreq events event id none tmin 0 1 tmax 1 covariates none dcsp conds list event id dcnl dcsp if covariates is not none dcnl dcsp dcsp conds + list covariates dcnl dcsp if isinstance tmin float int dcnl dcsp dcsp tmin s dict cond int tmin sfreq for cond in conds dcnl dcsp else dcnl dcsp dcsp tmin s dict cond int tmin get cond 0 1 sfreq for cond in conds dcnl dcsp if isinstance tmax float int dcnl dcsp dcsp tmax s dict cond int tmax sfreq + 1 0 for cond in conds dcnl dcsp else dcnl dcsp dcsp tmax s dict cond int tmax get cond 1 0 sfreq + 1 for cond in conds dcnl dcsp cond length dict dcnl dcsp xs dcnl dcsp for cond in conds dcnl dcsp dcsp tmin tmax tmin scond tmax scond dcnl dcsp dcsp n lags int tmax tmin dcnl dcsp dcsp if cond in event id dcnl dcsp dcsp dcsp ids event idcond if isinstance event idcond int else event idcond dcnl dcsp dcsp dcsp onsets events np in1d events 2 ids 0 + tmin dcnl dcsp dcsp dcsp values np ones len onsets n lags dcnl dcsp dcsp else dcnl dcsp dcsp dcsp covs covariatescond dcnl dcsp dcsp dcsp if len covs len events dcnl dcsp dcsp dcsp dcsp error condition dcsp 0 dcsp from dcsp covariates dcsp is dcsp not dcsp the dcsp same dcsp length dcsp as dcsp events format cond dcnl dcsp dcsp dcsp dcsp raise valueerror error dcnl dcsp dcsp dcsp onsets events np where covs 0 0 + tmin 0 dcnl dcsp dcsp dcsp v np asarray covs np nonzero covs astype float dcnl dcsp dcsp dcsp values np ones len onsets n lags v np newaxis dcnl dcsp dcsp cond lengthcond len onsets dcnl dcsp dcsp xs append sparse dia matrix values onsets shape n samples n lags dcnl dcsp return sparse hstack xs conds cond length tmin s tmax s
def clean rerp input x data reject flat decim info tstep dcsp has val np unique x nonzero 0 dcnl dcsp if reject is not none dcnl dcsp dcsp inds reject data segments data reject flat decim none info info tstep tstep dcnl dcsp dcsp for t0 t1 in inds dcnl dcsp dcsp dcsp has val np setdiff1d has val range t0 t1 dcnl dcsp return x tocsr has val data has val
def make evokeds coefs conds cond length tmin s tmax s info dcsp evokeds dict dcnl dcsp cumul 0 dcnl dcsp for cond in conds dcnl dcsp dcsp tmin tmax tmin scond tmax scond dcnl dcsp dcsp evokedscond evokedarray coefs cumul cumul + tmax tmin info info comment cond tmin tmin float info sfreq nave cond lengthcond kind average dcnl dcsp dcsp cumul + tmax tmin dcnl dcsp return evokeds
def ajd pham x eps 1e06 max iter 15 dcsp n epochs x shape0 dcnl dcsp a np concatenate x axis 0 t dcnl dcsp n times n m a shape dcnl dcsp v np eye n times dcnl dcsp epsilon n times n times 1 eps dcnl dcsp for it in range max iter dcnl dcsp dcsp decr 0 dcnl dcsp dcsp for ii in range 1 n times dcnl dcsp dcsp dcsp for jj in range ii dcnl dcsp dcsp dcsp dcsp ii np arange ii n m n times dcnl dcsp dcsp dcsp dcsp ij np arange jj n m n times dcnl dcsp dcsp dcsp dcsp c1 a ii ii dcnl dcsp dcsp dcsp dcsp c2 a jj ij dcnl dcsp dcsp dcsp dcsp g12 np mean a ii ij c1 dcnl dcsp dcsp dcsp dcsp g21 np mean a ii ij c2 dcnl dcsp dcsp dcsp dcsp omega21 np mean c1 c2 dcnl dcsp dcsp dcsp dcsp omega12 np mean c2 c1 dcnl dcsp dcsp dcsp dcsp omega np sqrt omega12 omega21 dcnl dcsp dcsp dcsp dcsp tmp np sqrt omega21 omega12 dcnl dcsp dcsp dcsp dcsp tmp1 tmp g12 + g21 omega + 1 dcnl dcsp dcsp dcsp dcsp tmp2 tmp g12 g21 max omega 1 1e09 dcnl dcsp dcsp dcsp dcsp h12 tmp1 + tmp2 dcnl dcsp dcsp dcsp dcsp h21 np conj tmp1 tmp2 tmp dcnl dcsp dcsp dcsp dcsp decr + n epochs g12 np conj h12 + g21 h21 2 0 dcnl dcsp dcsp dcsp dcsp tmp 1 + 1j 0 5 np imag h12 h21 dcnl dcsp dcsp dcsp dcsp tmp np real tmp + np sqrt tmp 2 h12 h21 dcnl dcsp dcsp dcsp dcsp tau np array 1 h12 tmp h21 tmp 1 dcnl dcsp dcsp dcsp dcsp aii jj np dot tau aii jj dcnl dcsp dcsp dcsp dcsp tmp np c a ii a ij dcnl dcsp dcsp dcsp dcsp tmp np reshape tmp n times n epochs 2 order f dcnl dcsp dcsp dcsp dcsp tmp np dot tmp tau t dcnl dcsp dcsp dcsp dcsp tmp np reshape tmp n times n epochs 2 order f dcnl dcsp dcsp dcsp dcsp a ii tmp n epochs dcnl dcsp dcsp dcsp dcsp a ij tmp n epochs dcnl dcsp dcsp dcsp dcsp vii jj np dot tau vii jj dcnl dcsp dcsp if decr < epsilon dcnl dcsp dcsp dcsp break dcnl dcsp d np reshape a n times 1 n times transpose 1 0 2 dcnl dcsp return v d
def set cv cv estimator none x none y none dcsp from sklearn base import is classifier dcnl dcsp if estimator in classifier regressor dcnl dcsp dcsp est is classifier estimator classifier dcnl dcsp else dcnl dcsp dcsp est is classifier is classifier estimator dcnl dcsp if check version sklearn 0 18 dcnl dcsp dcsp from sklearn import model selection as models dcnl dcsp dcsp from sklearn model selection import check cv stratifiedkfold kfold dcnl dcsp dcsp if isinstance cv int np int dcnl dcsp dcsp dcsp xfold stratifiedkfold if est is classifier else kfold dcnl dcsp dcsp dcsp cv xfold n splits cv dcnl dcsp dcsp elif isinstance cv str dcnl dcsp dcsp dcsp if not hasattr models cv dcnl dcsp dcsp dcsp dcsp raise valueerror unknown dcsp crossvalidation dcnl dcsp dcsp dcsp cv getattr models cv dcnl dcsp dcsp dcsp cv cv dcnl dcsp dcsp cv check cv cv cv y y classifier est is classifier dcnl dcsp else dcnl dcsp dcsp from sklearn import cross validation as models dcnl dcsp dcsp from sklearn cross validation import check cv stratifiedkfold kfold dcnl dcsp dcsp if isinstance cv int np int dcnl dcsp dcsp dcsp if est is classifier dcnl dcsp dcsp dcsp dcsp cv stratifiedkfold y y n folds cv dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp cv kfold n len y n folds cv dcnl dcsp dcsp elif isinstance cv str dcnl dcsp dcsp dcsp if not hasattr models cv dcnl dcsp dcsp dcsp dcsp raise valueerror unknown dcsp crossvalidation dcnl dcsp dcsp dcsp cv getattr models cv dcnl dcsp dcsp dcsp if cv name not in kfold leaveoneout dcnl dcsp dcsp dcsp dcsp raise notimplementederror cv dcsp cannot dcsp be dcsp defined dcsp with dcsp str dcsp for dcsp sklearn dcsp < dcsp 017 dcnl dcsp dcsp dcsp cv cv len y dcnl dcsp dcsp cv check cv cv cv x x y y classifier est is classifier dcnl dcsp if hasattr cv split dcnl dcsp dcsp cv splits train test for train test in cv split x np zeros like y y y dcnl dcsp else dcnl dcsp dcsp cv splits train test for train test in cv dcnl dcsp if not np all len train for train in cv splits dcnl dcsp dcsp raise valueerror some dcsp folds dcsp do dcsp not dcsp have dcsp any dcsp train dcsp epochs dcnl dcsp return cv cv splits
def check estimator estimator get params true dcsp valid methods predict transform predict proba decision function dcnl dcsp if not hasattr estimator fit or not any hasattr estimator method for method in valid methods dcnl dcsp dcsp raise valueerror estimator dcsp must dcsp be dcsp a dcsp scikitlearn dcsp transformer dcsp or dcsp an dcsp estimator dcsp with dcsp the dcsp fit dcsp and dcsp a dcsp predictlike dcsp e g dcsp predict proba dcsp or dcsp a dcsp transform dcsp method dcnl dcsp if get params and not hasattr estimator get params dcnl dcsp dcsp raise valueerror estimator dcsp must dcsp be dcsp a dcsp scikitlearn dcsp transformer dcsp or dcsp an dcsp estimator dcsp with dcsp the dcsp get params dcsp method dcsp that dcsp allows dcsp cloning
def get inverse funcs estimator terminal true dcsp inverse func false dcnl dcsp if hasattr estimator steps dcnl dcsp dcsp inverse func list dcnl dcsp dcsp for est in estimator steps dcnl dcsp dcsp dcsp inverse func extend get inverse funcs est terminal false dcnl dcsp elif hasattr estimator inverse transform dcnl dcsp dcsp inverse func estimator inverse transform dcnl dcsp if terminal dcnl dcsp dcsp last is estimator inverse func 1 is false dcnl dcsp dcsp all invertible not false in inverse func 1 dcnl dcsp dcsp if last is estimator and all invertible dcnl dcsp dcsp dcsp inverse func inverse func 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp inverse func list dcnl dcsp return inverse func
def get coef estimator attr filters inverse transform false dcsp est estimator dcnl dcsp while hasattr est steps dcnl dcsp dcsp est est steps 1 1 dcnl dcsp if hasattr est estimators dcnl dcsp dcsp coef list dcnl dcsp dcsp for this est in est estimators dcnl dcsp dcsp dcsp coef append get coef this est attr inverse transform dcnl dcsp dcsp coef np transpose coef dcnl dcsp elif not hasattr est attr dcnl dcsp dcsp raise valueerror this dcsp estimator dcsp does dcsp not dcsp have dcsp a dcsp s dcsp attribute attr dcnl dcsp else dcnl dcsp dcsp coef getattr est attr dcnl dcsp if inverse transform dcnl dcsp dcsp if not hasattr estimator steps and not hasattr est estimators dcnl dcsp dcsp dcsp raise valueerror inverse transform dcsp can dcsp only dcsp be dcsp applied dcsp onto dcsp pipeline dcsp estimators dcnl dcsp dcsp for inverse func in get inverse funcs estimator 1 dcnl dcsp dcsp dcsp coef inverse func np array coef 0 dcnl dcsp return coef
def cross val multiscore estimator x y none groups none scoring none cv none n jobs 1 verbose 0 fit params none pre dispatch 2 n jobs dcsp from sklearn base import is classifier clone dcnl dcsp from sklearn utils import indexable dcnl dcsp from sklearn metrics scorer import check scoring dcnl dcsp from sklearn model selection split import check cv dcnl dcsp x y groups indexable x y groups dcnl dcsp cv check cv cv y classifier is classifier estimator dcnl dcsp cv iter list cv split x y groups dcnl dcsp scorer check scoring estimator scoring scoring dcnl dcsp parallel p func n jobs parallel func fit and score n jobs pre dispatch pre dispatch dcnl dcsp scores parallel p func clone estimator x y scorer train test verbose none fit params for train test in cv iter dcnl dcsp return np array scores 0
def fit and score estimator x y scorer train test verbose parameters fit params return train score false return parameters false return n test samples false return times false error score raise dcsp from sklearn model selection validation import index param value dcnl dcsp from sklearn utils metaestimators import safe split dcnl dcsp from sklearn utils validation import num samples dcnl dcsp if verbose 1 dcnl dcsp dcsp if parameters is none dcnl dcsp dcsp dcsp msg dcnl dcsp dcsp else dcnl dcsp dcsp dcsp msg s dcsp join s s k v for k v in parameters items dcnl dcsp dcsp print cv dcsp s dcsp s msg 64 len msg dcnl dcsp fit params fit params if fit params is not none else dcnl dcsp fit params dict k index param value x v train for k v in fit params items dcnl dcsp if parameters is not none dcnl dcsp dcsp estimator set params parameters dcnl dcsp start time time time dcnl dcsp x train y train safe split estimator x y train dcnl dcsp x test y test safe split estimator x y test train dcnl dcsp try dcnl dcsp dcsp if y train is none dcnl dcsp dcsp dcsp estimator fit x train fit params dcnl dcsp dcsp else dcnl dcsp dcsp dcsp estimator fit x train y train fit params dcnl dcsp except exception as e dcnl dcsp dcsp fit time time time start time dcnl dcsp dcsp score time 0 0 dcnl dcsp dcsp if error score raise dcnl dcsp dcsp dcsp raise dcnl dcsp dcsp elif isinstance error score numbers number dcnl dcsp dcsp dcsp test score error score dcnl dcsp dcsp dcsp if return train score dcnl dcsp dcsp dcsp dcsp train score error score dcnl dcsp dcsp dcsp warn classifier dcsp fit dcsp failed dcsp the dcsp score dcsp on dcsp this dcsp traintest dcsp partition dcsp for dcsp these dcsp parameters dcsp will dcsp be dcsp set dcsp to dcsp f dcsp details dcsp n r error score e dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror error score dcsp must dcsp be dcsp the dcsp string dcsp raise dcsp or dcsp a dcsp numeric dcsp value dcsp hint dcsp if dcsp using dcsp raise dcsp please dcsp make dcsp sure dcsp that dcsp it dcsp has dcsp been dcsp spelled dcsp correctly dcnl dcsp else dcnl dcsp dcsp fit time time time start time dcnl dcsp dcsp test score score estimator x test y test scorer dcnl dcsp dcsp score time time time start time fit time dcnl dcsp dcsp if return train score dcnl dcsp dcsp dcsp train score score estimator x train y train scorer dcnl dcsp if verbose 2 dcnl dcsp dcsp msg + dcsp score f test score dcnl dcsp if verbose 1 dcnl dcsp dcsp total time score time + fit time dcnl dcsp dcsp end msg s dcsp total s msg logger short format time total time dcnl dcsp dcsp print cv dcsp s dcsp s 64 len end msg end msg dcnl dcsp ret train score test score if return train score else test score dcnl dcsp if return n test samples dcnl dcsp dcsp ret append num samples x test dcnl dcsp if return times dcnl dcsp dcsp ret extend fit time score time dcnl dcsp if return parameters dcnl dcsp dcsp ret append parameters dcnl dcsp return ret
def score estimator x test y test scorer dcsp if y test is none dcnl dcsp dcsp score scorer estimator x test dcnl dcsp else dcnl dcsp dcsp score scorer estimator x test y test dcnl dcsp if hasattr score item dcnl dcsp dcsp try dcnl dcsp dcsp dcsp score score item dcnl dcsp dcsp except valueerror dcnl dcsp dcsp dcsp pass dcnl dcsp return score
def sklearn reshape apply func return result x args dcsp if not isinstance x np ndarray dcnl dcsp dcsp raise valueerror data dcsp should dcsp be dcsp an dcsp np ndarray dcsp got dcsp s type x dcnl dcsp x np atleast 3d x dcnl dcsp orig shape x shape dcnl dcsp x np reshape x transpose 0 2 1 1 orig shape1 dcnl dcsp x func x args dcnl dcsp if return result dcnl dcsp dcsp x shape orig shape0 orig shape2 orig shape1 dcnl dcsp dcsp x x transpose 0 2 1 dcnl dcsp dcsp return x
def simulate data target n trials 100 n channels 10 random state 42 dcsp rs np random randomstate random state dcnl dcsp mixing mat np linalg svd rs randn n channels n channels 0 dcnl dcsp s rs randn n trials n channels 50 dcnl dcsp s 0 np atleast 2d np sqrt target t dcnl dcsp s 1 0 01 dcnl dcsp x np dot mixing mat s transpose 1 0 2 dcnl dcsp return x mixing mat
slow test dcnl def test csp dcsp raw io read raw fif raw fname preload false dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks2 12 3 dcnl dcsp raw add proj remove existing true dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true proj false dcnl dcsp epochs data epochs get data dcnl dcsp n channels epochs data shape1 dcnl dcsp y epochs events 1 dcnl dcsp assert raises valueerror csp n components foo norm trace false dcnl dcsp for reg in foo 0 1 1 1 dcnl dcsp dcsp assert raises valueerror csp reg reg norm trace false dcnl dcsp for reg in oas ledoit wolf 0 0 5 1 0 dcnl dcsp dcsp csp reg reg norm trace false dcnl dcsp for cov est in foo none dcnl dcsp dcsp assert raises valueerror csp cov est cov est norm trace false dcnl dcsp assert raises valueerror csp norm trace foo dcnl dcsp for cov est in concat epoch dcnl dcsp dcsp csp cov est cov est norm trace false dcnl dcsp n components 3 dcnl dcsp for norm trace in true false dcnl dcsp dcsp csp csp n components n components norm trace norm trace dcnl dcsp dcsp csp fit epochs data epochs events 1 dcnl dcsp assert equal len csp mean n components dcnl dcsp assert equal len csp std n components dcnl dcsp x csp fit transform epochs data y dcnl dcsp sources csp transform epochs data dcnl dcsp assert true sources shape1 n components dcnl dcsp assert true csp filters shape n channels n channels dcnl dcsp assert true csp patterns shape n channels n channels dcnl dcsp assert array almost equal sources x dcnl dcsp assert raises valueerror csp fit epochs data np zeros like epochs events dcnl dcsp assert raises valueerror csp fit epochs y dcnl dcsp assert raises valueerror csp transform epochs dcnl dcsp epochs pick types meg mag dcnl dcsp cmap rdbu true dcnl dcsp components np arange n components dcnl dcsp for plot in csp plot patterns csp plot filters dcnl dcsp dcsp plot epochs info components components res 12 show false cmap cmap dcnl dcsp epochs epochs raw events tmin tmin tmax tmax picks picks event id dict aud l 1 aud r 2 vis l 3 vis r 4 baseline none 0 proj false preload true dcnl dcsp epochs data epochs get data dcnl dcsp n channels epochs data shape1 dcnl dcsp n channels epochs data shape1 dcnl dcsp for cov est in concat epoch dcnl dcsp dcsp csp csp n components n components cov est cov est norm trace false dcnl dcsp dcsp csp fit epochs data epochs events 2 transform epochs data dcnl dcsp dcsp assert equal len csp classes 4 dcnl dcsp dcsp assert array equal csp filters shape n channels n channels dcnl dcsp dcsp assert array equal csp patterns shape n channels n channels dcnl dcsp n components 2 dcnl dcsp assert true csp transform into average power dcnl dcsp feature shape len epochs data n components dcnl dcsp x trans dict dcnl dcsp for log in none true false dcnl dcsp dcsp csp csp n components n components log log norm trace false dcnl dcsp dcsp assert true csp log is log dcnl dcsp dcsp xt csp fit transform epochs data epochs events 2 dcnl dcsp dcsp assert array equal xt shape feature shape dcnl dcsp dcsp x transstr log xt dcnl dcsp assert array almost equal x trans none x trans true dcnl dcsp assert true np sum x trans true x trans false 2 1 0 dcnl dcsp assert raises valueerror csp transform into average power log foo dcnl dcsp csp csp transform into csp space norm trace false dcnl dcsp assert true csp transform into csp space dcnl dcsp for log in foo true false dcnl dcsp dcsp assert raises valueerror csp transform into csp space log log norm trace false dcnl dcsp n components 2 dcnl dcsp csp csp n components n components transform into csp space norm trace false dcnl dcsp xt csp fit epochs data epochs events 2 transform epochs data dcnl dcsp feature shape len epochs data n components epochs data shape2 dcnl dcsp assert array equal xt shape feature shape dcnl dcsp y np array 100 50 + 1 50 dcnl dcsp x a simulate data y dcnl dcsp for cov est in concat epoch dcnl dcsp dcsp csp csp n components 1 cov est cov est norm trace false dcnl dcsp dcsp csp fit x y dcnl dcsp dcsp corr np abs np corrcoef csp patterns 0 t a 0 0 1 dcnl dcsp dcsp assert greater np abs corr 0 99 dcnl dcsp dcsp out csp transform x dcnl dcsp dcsp corr np abs np corrcoef out 0 y 0 1 dcnl dcsp dcsp assert greater np abs corr 0 95
requires sklearn dcnl def test regularized csp dcsp raw io read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp epochs data epochs get data dcnl dcsp n channels epochs data shape1 dcnl dcsp n components 3 dcnl dcsp reg cov none 0 05 ledoit wolf oas dcnl dcsp for reg in reg cov dcnl dcsp dcsp csp csp n components n components reg reg norm trace false dcnl dcsp dcsp csp fit epochs data epochs events 1 dcnl dcsp dcsp y epochs events 1 dcnl dcsp dcsp x csp fit transform epochs data y dcnl dcsp dcsp assert true csp filters shape n channels n channels dcnl dcsp dcsp assert true csp patterns shape n channels n channels dcnl dcsp dcsp assert array almost equal csp fit epochs data y transform epochs data x dcnl dcsp dcsp assert raises valueerror csp fit epochs data np zeros like epochs events dcnl dcsp dcsp assert raises valueerror csp fit epochs y dcnl dcsp dcsp assert raises valueerror csp transform epochs dcnl dcsp dcsp csp n components n components dcnl dcsp dcsp sources csp transform epochs data dcnl dcsp dcsp assert true sources shape1 n components
requires sklearn dcnl def test csp pipeline dcsp from sklearn svm import svc dcnl dcsp from sklearn pipeline import pipeline dcnl dcsp csp csp reg 1 norm trace false dcnl dcsp svc svc dcnl dcsp pipe pipeline csp csp svc svc dcnl dcsp pipe set params csp reg 0 2 dcnl dcsp assert true pipe get params csp reg 0 2
def test ajd dcsp n times n channels 10 3 dcnl dcsp seed np random randomstate 0 dcnl dcsp diags 2 0 + 0 1 seed randn n times n channels dcnl dcsp a 2 seed rand n channels n channels 1 dcnl dcsp a np atleast 2d np sqrt np sum a 2 1 t dcnl dcsp covmats np empty n times n channels n channels dcnl dcsp for i in range n times dcnl dcsp dcsp covmatsi np dot np dot a np diag diagsi a t dcnl dcsp v d ajd pham covmats dcnl dcsp v matlab 3 507280775058041 5 498189967306344 7 720624541198574 0 69468901323461 0 775690358505945 1 162043086446043 0 592603135588066 0 59899692569626 1 009550086271192 dcnl dcsp assert array almost equal v v matlab
requires sklearn 0 15 dcnl def test ems dcsp raw io read raw fif raw fname preload false dcnl dcsp events read events event name dcnl dcsp events 2 2 3 dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp assert raises valueerror compute ems epochs aud l vis l dcnl dcsp epochs equalize event counts epochs event id dcnl dcsp assert raises keyerror compute ems epochs blah hahah dcnl dcsp surrogates filters conditions compute ems epochs dcnl dcsp assert equal list set conditions 1 3 dcnl dcsp events read events event name dcnl dcsp event id2 dict aud l 1 aud r 2 vis l 3 dcnl dcsp epochs epochs raw events event id2 tmin tmax picks picks baseline none 0 preload true dcnl dcsp epochs equalize event counts epochs event id dcnl dcsp n expected sum len epochsk for k in aud l vis l dcnl dcsp assert raises valueerror compute ems epochs dcnl dcsp surrogates filters conditions compute ems epochs aud r vis l dcnl dcsp assert equal n expected len surrogates dcnl dcsp assert equal n expected len conditions dcnl dcsp assert equal list set conditions 2 3 dcnl dcsp epochs epochs aud r vis l dcnl dcsp epochs equalize event counts epochs event id dcnl dcsp if check version sklearn 0 18 dcnl dcsp dcsp from sklearn model selection import stratifiedkfold dcnl dcsp dcsp cv stratifiedkfold dcnl dcsp else dcnl dcsp dcsp from sklearn cross validation import stratifiedkfold dcnl dcsp dcsp cv stratifiedkfold epochs events 2 dcnl dcsp compute ems epochs cv cv dcnl dcsp compute ems epochs cv 2 dcnl dcsp assert raises valueerror compute ems epochs cv foo dcnl dcsp assert raises valueerror compute ems epochs cv len epochs + 1 dcnl dcsp raw close dcnl dcsp x epochs get data dcnl dcsp y epochs events 2 dcnl dcsp x x np std x dcnl dcsp xt coefs list list dcnl dcsp ems ems dcnl dcsp assert equal ems repr <ems dcsp not dcsp fitted dcnl dcsp for test in range len y dcnl dcsp dcsp train np setdiff1d range len y np atleast 1d test dcnl dcsp dcsp ems fit xtrain ytrain dcnl dcsp dcsp coefs append ems filters dcnl dcsp dcsp xt append ems transform xtest dcnl dcsp assert equal ems repr <ems dcsp fitted dcsp with dcsp 4 dcsp filters dcsp on dcsp 2 dcsp classes dcnl dcsp assert array almost equal filters np mean coefs axis 0 dcnl dcsp assert array almost equal surrogates np vstack xt
requires sklearn 0 15 dcnl def test search light dcsp from sklearn linear model import ridge logisticregression dcnl dcsp from sklearn pipeline import make pipeline dcnl dcsp from sklearn metrics import roc auc score make scorer dcnl dcsp x y make data dcnl dcsp n epochs n time x shape dcnl dcsp assert raises valueerror slidingestimator foo dcnl dcsp sl slidingestimator ridge dcnl dcsp sl slidingestimator logisticregression dcnl dcsp assert equal sl repr 18 <slidingestimator dcnl dcsp sl fit x y dcnl dcsp assert equal sl repr 28 dcsp fitted dcsp with dcsp 10 dcsp estimators dcnl dcsp assert raises valueerror sl fit x1 y dcnl dcsp assert raises valueerror sl fit x 0 y dcnl dcsp assert raises valueerror sl predict x 2 dcnl dcsp y pred sl predict x dcnl dcsp assert true y pred dtype int dcnl dcsp assert array equal y pred shape n epochs n time dcnl dcsp y proba sl predict proba x dcnl dcsp assert true y proba dtype float dcnl dcsp assert array equal y proba shape n epochs n time 2 dcnl dcsp score sl score x y dcnl dcsp assert array equal score shape n time dcnl dcsp assert true np sum np abs score 0 dcnl dcsp assert true score dtype float dcnl dcsp sl slidingestimator logisticregression dcnl dcsp assert equal sl scoring none dcnl dcsp for err scoring in valueerror foo typeerror 999 dcnl dcsp dcsp sl slidingestimator logisticregression scoring scoring dcnl dcsp dcsp sl fit x y dcnl dcsp dcsp assert raises err sl score x y dcnl dcsp sl slidingestimator logisticregression random state 0 scoring roc auc dcnl dcsp y np arange len x 3 dcnl dcsp sl fit x y dcnl dcsp assert raises valueerror sl score x y dcnl dcsp y np arange len x 2 + 1 dcnl dcsp sl fit x y dcnl dcsp score sl score x y dcnl dcsp assert array equal score roc auc score y 1 y pred 1 for y pred in sl decision function x t dcnl dcsp y np arange len x 2 dcnl dcsp sl1 slidingestimator logisticregression scoring roc auc score dcnl dcsp sl1 fit x y dcnl dcsp assert raises valueerror sl1 score x y dcnl dcsp sl1 slidingestimator logisticregression scoring roc auc dcnl dcsp sl1 fit x y dcnl dcsp rng np random randomstate 0 dcnl dcsp x rng randn x shape dcnl dcsp score sl sl1 score x y dcnl dcsp assert array equal score sl shape n time dcnl dcsp assert true score sl dtype float dcnl dcsp scoring make scorer roc auc score needs threshold true dcnl dcsp score manual scoring est x y for est x in zip sl1 estimators x transpose 2 0 1 dcnl dcsp assert array equal score manual score sl dcnl dcsp sl slidingestimator logisticregression random state 0 n jobs 1 scoring roc auc dcnl dcsp score 1job sl fit x y score x y dcnl dcsp sl n jobs 2 dcnl dcsp score njobs sl fit x y score x y dcnl dcsp assert array equal score 1job score njobs dcnl dcsp sl predict x dcnl dcsp sl fit x 0 y dcnl dcsp sl predict x 0 dcnl dcsp class logregtransformer logisticregression dcnl dcsp dcsp def transform self x dcnl dcsp dcsp dcsp return super logregtransformer self predict proba x 1 dcnl dcsp pipe make pipeline slidingestimator logregtransformer logisticregression dcnl dcsp pipe fit x y dcnl dcsp pipe predict x dcnl dcsp x np random rand 10 3 4 2 dcnl dcsp y np arange 10 2 dcnl dcsp y preds list dcnl dcsp for n jobs in 1 2 dcnl dcsp dcsp pipe slidingestimator make pipeline vectorizer logisticregression n jobs n jobs dcnl dcsp dcsp y preds append pipe fit x y predict x dcnl dcsp dcsp features shape pipe estimators 0 steps01 features shape dcnl dcsp dcsp assert array equal features shape 3 4 dcnl dcsp assert array equal y preds0 y preds1
requires sklearn 0 15 dcnl def test generalization light dcsp from sklearn pipeline import make pipeline dcnl dcsp from sklearn linear model import logisticregression dcnl dcsp from sklearn metrics import roc auc score dcnl dcsp x y make data dcnl dcsp n epochs n time x shape dcnl dcsp gl generalizingestimator logisticregression dcnl dcsp assert equal repr gl 23 <generalizingestimator dcnl dcsp gl fit x y dcnl dcsp assert equal gl repr 28 dcsp fitted dcsp with dcsp 10 dcsp estimators dcnl dcsp y pred gl predict x dcnl dcsp assert array equal y pred shape n epochs n time n time dcnl dcsp assert true y pred dtype int dcnl dcsp y proba gl predict proba x dcnl dcsp assert true y proba dtype float dcnl dcsp assert array equal y proba shape n epochs n time n time 2 dcnl dcsp y pred gl predict x 2 dcnl dcsp assert array equal y pred shape n epochs n time 2 dcnl dcsp score gl score x 3 y dcnl dcsp assert array equal score shape n time 3 dcnl dcsp assert true np sum np abs score 0 dcnl dcsp assert true score dtype float dcnl dcsp gl generalizingestimator logisticregression scoring roc auc dcnl dcsp gl fit x y dcnl dcsp score gl score x y dcnl dcsp auc roc auc score y gl estimators 0 predict proba x 0 1 dcnl dcsp assert equal score 0 0 auc dcnl dcsp for err scoring in valueerror foo typeerror 999 dcnl dcsp dcsp gl generalizingestimator logisticregression scoring scoring dcnl dcsp dcsp gl fit x y dcnl dcsp dcsp assert raises err gl score x y dcnl dcsp gl generalizingestimator logisticregression scoring roc auc dcnl dcsp y np arange len x 3 dcnl dcsp gl fit x y dcnl dcsp assert raises valueerror gl score x y dcnl dcsp y np arange len x 2 + 1 dcnl dcsp gl fit x y dcnl dcsp score gl score x y dcnl dcsp manual score roc auc score y 1 y pred for y pred in y preds for y preds in gl decision function x transpose 1 2 0 dcnl dcsp assert array equal score manual score dcnl dcsp gl generalizingestimator logisticregression n jobs 2 dcnl dcsp gl fit x y dcnl dcsp y pred gl predict x dcnl dcsp assert array equal y pred shape n epochs n time n time dcnl dcsp score gl score x y dcnl dcsp assert array equal score shape n time n time dcnl dcsp gl fit x 0 y dcnl dcsp gl predict x 0 dcnl dcsp x np random rand 10 3 4 2 dcnl dcsp y np arange 10 2 dcnl dcsp y preds list dcnl dcsp for n jobs in 1 2 dcnl dcsp dcsp pipe generalizingestimator make pipeline vectorizer logisticregression n jobs n jobs dcnl dcsp dcsp y preds append pipe fit x y predict x dcnl dcsp dcsp features shape pipe estimators 0 steps01 features shape dcnl dcsp dcsp assert array equal features shape 3 4 dcnl dcsp assert array equal y preds0 y preds1
def make data n samples 1000 n features 5 n targets 3 dcsp np random seed 0 dcnl dcsp cov y np eye n targets 10 + np random rand n targets n targets dcnl dcsp mean y np random rand n targets dcnl dcsp y np random multivariate normal mean y cov y size n samples dcnl dcsp a np random randn n features n targets dcnl dcsp x y dot a t dcnl dcsp x + np random randn n samples n features dcnl dcsp x + np random rand n features dcnl dcsp return x y a
requires sklearn 0 15 dcnl def test get coef dcsp from sklearn base import transformermixin baseestimator dcnl dcsp from sklearn pipeline import make pipeline dcnl dcsp from sklearn preprocessing import standardscaler dcnl dcsp from sklearn linear model import ridge linearregression dcnl dcsp lm linearmodel ridge dcnl dcsp class clf baseestimator dcnl dcsp dcsp def fit self x y dcnl dcsp dcsp dcsp return self dcnl dcsp class noinv transformermixin dcnl dcsp dcsp def fit self x y dcnl dcsp dcsp dcsp return self dcnl dcsp dcsp def transform self x dcnl dcsp dcsp dcsp return x dcnl dcsp class inv noinv dcnl dcsp dcsp def inverse transform self x dcnl dcsp dcsp dcsp return x dcnl dcsp x y a make data n samples 2000 n features 3 n targets 1 dcnl dcsp good estimators 1 make pipeline inv clf 2 make pipeline inv inv clf 3 make pipeline inv make pipeline inv inv clf dcnl dcsp for expected n est in good estimators dcnl dcsp dcsp est fit x y dcnl dcsp dcsp assert true expected n len get inverse funcs est dcnl dcsp bad estimators clf inv make pipeline noinv clf make pipeline inv make pipeline inv noinv clf dcnl dcsp for est in bad estimators dcnl dcsp dcsp est fit x y dcnl dcsp dcsp invs get inverse funcs est dcnl dcsp dcsp assert equal invs list dcnl dcsp for clf in lm make pipeline standardscaler lm dcnl dcsp dcsp clf fit x y dcnl dcsp dcsp filters get coef clf filters false dcnl dcsp dcsp if hasattr clf steps dcnl dcsp dcsp dcsp coefs clf steps 1 1 model coef dcnl dcsp dcsp else dcnl dcsp dcsp dcsp coefs clf model coef dcnl dcsp dcsp assert array equal filters coefs0 dcnl dcsp dcsp patterns get coef clf patterns false dcnl dcsp dcsp assert true filters0 patterns0 dcnl dcsp dcsp n chans x shape1 dcnl dcsp dcsp assert array equal filters shape patterns shape n chans n chans dcnl dcsp filters inv get coef clf filters true dcnl dcsp assert true filters0 filters inv0 dcnl dcsp patterns inv get coef clf patterns true dcnl dcsp assert true patterns0 patterns inv0 dcnl dcsp slider slidingestimator make pipeline standardscaler lm dcnl dcsp x np transpose x x 1 2 0 dcnl dcsp clfs make pipeline scaler none scalings mean slider slider dcnl dcsp for clf in clfs dcnl dcsp dcsp clf fit x y dcnl dcsp dcsp for inverse in true false dcnl dcsp dcsp dcsp patterns get coef clf patterns inverse dcnl dcsp dcsp dcsp filters get coef clf filters inverse dcnl dcsp dcsp dcsp assert array equal filters shape patterns shape x shape1 dcnl dcsp dcsp dcsp assert equal patterns 0 0 patterns 0 1 dcnl dcsp for t in 0 1 dcnl dcsp dcsp assert array equal get coef clf estimators t filters false filters t dcnl dcsp for n features in 1 5 dcnl dcsp dcsp for n targets in 1 3 dcnl dcsp dcsp dcsp x y a make data n samples 5000 n features 5 n targets 3 dcnl dcsp dcsp dcsp lm linearmodel linearregression fit x y dcnl dcsp dcsp dcsp assert array equal lm filters shape lm patterns shape dcnl dcsp dcsp dcsp assert array equal lm filters shape 3 5 dcnl dcsp dcsp dcsp assert array almost equal a lm patterns t decimal 2 dcnl dcsp dcsp dcsp lm linearmodel ridge alpha 1 fit x y dcnl dcsp dcsp dcsp assert array almost equal a lm patterns t decimal 2
requires sklearn 0 15 dcnl def test linearmodel dcsp from sklearn linear model import linearregression dcnl dcsp np random seed 42 dcnl dcsp clf linearmodel dcnl dcsp n n features 20 3 dcnl dcsp x np random rand n n features dcnl dcsp y np arange n 2 dcnl dcsp clf fit x y dcnl dcsp assert equal clf filters shape n features dcnl dcsp assert equal clf patterns shape n features dcnl dcsp assert raises valueerror clf fit np random rand n n features 99 y dcnl dcsp n targets 5 dcnl dcsp clf linearmodel linearregression dcnl dcsp y np random rand n n targets dcnl dcsp clf fit x y dcnl dcsp assert equal clf filters shape n targets n features dcnl dcsp assert equal clf patterns shape n targets n features dcnl dcsp assert raises valueerror clf fit x np random rand n n features 99
requires sklearn 0 15 dcnl def test cross val multiscore dcsp from sklearn model selection import kfold cross val score dcnl dcsp from sklearn linear model import logisticregression dcnl dcsp x np random rand 20 3 dcnl dcsp y np arange 20 2 dcnl dcsp clf logisticregression dcnl dcsp cv kfold 2 random state 0 dcnl dcsp assert array equal cross val score clf x y cv cv cross val multiscore clf x y cv cv dcnl dcsp x np random rand 20 4 3 dcnl dcsp y np arange 20 2 dcnl dcsp clf slidingestimator logisticregression scoring accuracy dcnl dcsp scores acc cross val multiscore clf x y cv cv dcnl dcsp assert array equal np shape scores acc 2 3 dcnl dcsp scores acc manual list dcnl dcsp for train test in cv split x y dcnl dcsp dcsp clf fit xtrain ytrain dcnl dcsp dcsp scores acc manual append clf score xtest ytest dcnl dcsp assert array equal scores acc scores acc manual dcnl dcsp assert raises valueerror cross val multiscore clf x y cv cv scoring roc auc dcnl dcsp clf slidingestimator logisticregression scoring roc auc dcnl dcsp scores auc cross val multiscore clf x y cv cv n jobs 1 dcnl dcsp scores auc manual list dcnl dcsp for train test in cv split x y dcnl dcsp dcsp clf fit xtrain ytrain dcnl dcsp dcsp scores auc manual append clf score xtest ytest dcnl dcsp assert array equal scores auc scores auc manual
requires sklearn 0 15 dcnl def test rank deficiency dcsp from sklearn linear model import ridge dcnl dcsp n 256 dcnl dcsp fs 1 0 dcnl dcsp tmin tmax 50 100 dcnl dcsp reg 0 1 dcnl dcsp rng np random randomstate 0 dcnl dcsp eeg rng randn n 1 dcnl dcsp eeg 100 dcnl dcsp eeg np fft rfft eeg axis 0 dcnl dcsp eeg n 4 0 dcnl dcsp eeg np fft irfft eeg axis 0 dcnl dcsp win np hanning n 8 dcnl dcsp win win mean dcnl dcsp y np apply along axis np convolve 0 eeg win mode same dcnl dcsp y + rng randn y shape 100 dcnl dcsp for est in ridge reg reg dcnl dcsp dcsp rf receptivefield tmin tmax fs estimator est dcnl dcsp dcsp rf fit eeg y dcnl dcsp dcsp pred rf predict eeg dcnl dcsp dcsp assert equal y shape pred shape dcnl dcsp dcsp corr np corrcoef y ravel pred ravel 0 1 dcnl dcsp dcsp assert true corr 0 995 msg corr
def test time delay dcsp x rng randn 2 1000 dcnl dcsp x sp np zeros 2 10 dcnl dcsp x sp 0 1 1 dcnl dcsp x sp csr matrix x sp dcnl dcsp test tlims 0 2 1 0 0 2 10 0 1 0 1 10 dcnl dcsp for tmin tmax isfreq in test tlims dcnl dcsp dcsp assert raises valueerror delay time series x tmin tmax sfreq 1 dcnl dcsp dcsp assert raises valueerror delay time series x np complex tmin tmax 1 dcnl dcsp dcsp delayed delay time series x tmin tmax isfreq newaxis 2 axis 1 dcnl dcsp dcsp assert equal delayed shape2 3 dcnl dcsp dcsp delays times to delays tmin tmax isfreq dcnl dcsp dcsp keep delays to slice delays dcnl dcsp dcsp assert true delayed keep shape 1 0 dcnl dcsp dcsp assert true np isnan delayed keep sum 0 dcnl dcsp dcsp for idata in x x sp dcnl dcsp dcsp dcsp if tmin < 0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp x delayed delay time series x tmin tmax isfreq axis 1 dcnl dcsp dcsp dcsp assert array equal x delayed0 x dcnl dcsp dcsp dcsp assert array equal x delayed10 1 x0 1 dcnl dcsp dcsp dcsp assert equal len x delayed tmax tmin isfreq + 1
requires sklearn 0 15 dcnl def test receptive field dcsp from sklearn linear model import ridge dcnl dcsp mod ridge dcnl dcsp tmin tmax 0 0 10 0 dcnl dcsp n feats 3 dcnl dcsp x rng randn n feats 10000 dcnl dcsp w rng randn int tmax tmin + 1 n feats dcnl dcsp x del np vstack delay time series x tmin tmax 1 0 axis 1 dcnl dcsp y np dot w x del dcnl dcsp x np rollaxis x 1 0 dcnl dcsp feature names feature i ii for ii in 0 1 2 dcnl dcsp rf receptivefield tmin tmax 1 feature names estimator mod dcnl dcsp rf fit x y dcnl dcsp assert array equal rf delays np arange tmin tmax + 1 dcnl dcsp y pred rf predict x dcnl dcsp assert allclose yrf valid samples y predrf valid samples atol 0 01 dcnl dcsp scores rf score x y dcnl dcsp assert true scores 0 99 dcnl dcsp assert allclose rf coef t ravel w atol 0 01 dcnl dcsp rf fit x np newaxis y np newaxis dcnl dcsp rf fit x y np newaxis dcnl dcsp assert raises valueerror rf fit x np newaxis y dcnl dcsp assert raises valueerror rf fit x 0 y dcnl dcsp assert raises valueerror rf fit x np newaxis np tile y np newaxis 2 1 1 dcnl dcsp assert raises valueerror rf fit x 1 y dcnl dcsp rf receptivefield tmin tmax 1 estimator mod dcnl dcsp rf fit x y dcnl dcsp assert equal rf feature names feature s ii for ii in 0 1 2 dcnl dcsp assert raises valueerror rf fit x y 2 dcnl dcsp rf receptivefield tmin tmax 1 one two three estimator 0 dcnl dcsp str rf dcnl dcsp rf fit x y dcnl dcsp assert true isinstance rf estimator timedelayingridge dcnl dcsp str rf dcnl dcsp rf receptivefield tmin tmax 1 one estimator 0 dcnl dcsp rf fit x 0 y dcnl dcsp str rf dcnl dcsp rf receptivefield tmin tmax 1 estimator foo dcnl dcsp assert raises valueerror rf fit x y dcnl dcsp rf receptivefield tmin tmax 1 estimator np array 1 2 3 dcnl dcsp assert raises valueerror rf fit x y dcnl dcsp rf receptivefield 5 4 1 dcnl dcsp assert raises valueerror rf fit x y dcnl dcsp for key val in scorers items dcnl dcsp dcsp rf receptivefield tmin tmax 1 one estimator 0 scoring key dcnl dcsp dcsp rf fit x 0 y dcnl dcsp dcsp y pred rf predict x 0 t ravel np newaxis dcnl dcsp dcsp assert allclose val y np newaxis y pred rf score x 0 y rtol 0 001 dcnl dcsp assert raises valueerror scorers corrcoef y ravel y pred dcnl dcsp rf receptivefield tmin tmax 1 0 scoring foo dcnl dcsp assert raises valueerror rf fit x y
requires sklearn 0 15 dcnl def test receptive field fast dcsp from sklearn linear model import ridge dcnl dcsp rng np random randomstate 0 dcnl dcsp x rng randn 500 1 dcnl dcsp for delay in range 2 3 dcnl dcsp dcsp y np zeros 500 dcnl dcsp dcsp slims 4 2 dcnl dcsp dcsp if delay 0 dcnl dcsp dcsp dcsp y x 0 dcnl dcsp dcsp elif delay < 0 dcnl dcsp dcsp dcsp y delay x delay 0 dcnl dcsp dcsp dcsp slims + 4 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp y delay xdelay 0 dcnl dcsp dcsp dcsp slims + 1 2 dcnl dcsp dcsp for ndim in 1 2 dcnl dcsp dcsp dcsp y shape y shape0 + 1 ndim 1 dcnl dcsp dcsp dcsp for slim in slims dcnl dcsp dcsp dcsp dcsp tdr timedelayingridge slim0 slim1 1 0 0 1 laplacian fit intercept false dcnl dcsp dcsp dcsp dcsp for estimator in ridge alpha 0 0 0 0 0 1 tdr dcnl dcsp dcsp dcsp dcsp dcsp model receptivefield slim0 slim1 1 0 estimator estimator dcnl dcsp dcsp dcsp dcsp dcsp model fit x y dcnl dcsp dcsp dcsp dcsp dcsp assert array equal model delays np arange slim0 slim1 + 1 dcnl dcsp dcsp dcsp dcsp dcsp expected model delays delay astype float dcnl dcsp dcsp dcsp dcsp dcsp expected expectednp newaxis dcnl dcsp dcsp dcsp dcsp dcsp if y ndim 2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp expected expectednp newaxis dcnl dcsp dcsp dcsp dcsp dcsp assert equal model coef ndim ndim + 1 dcnl dcsp dcsp dcsp dcsp dcsp assert allclose model coef expected atol 0 01 dcnl dcsp dcsp dcsp dcsp dcsp p model predict x dcnl dcsp dcsp dcsp dcsp dcsp assert allclose y p atol 0 05 dcnl dcsp dcsp dcsp dcsp dcsp score model score x y dcnl dcsp dcsp dcsp dcsp dcsp assert true score 0 9999 msg score dcnl dcsp x rng randn 1000 3 dcnl dcsp y np zeros 1000 2 dcnl dcsp slim 5 0 dcnl dcsp for ii in range 1 5 dcnl dcsp dcsp yii ii 2 + 1 ii ii x ii ii 3 dcnl dcsp expected 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 2 0 0 0 0 3 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 dcnl dcsp tdr timedelayingridge slim0 slim1 1 0 0 1 laplacian dcnl dcsp for estimator in ridge alpha 0 0 0 0 0 01 tdr dcnl dcsp dcsp model receptivefield slim0 slim1 1 0 estimator estimator dcnl dcsp dcsp model fit x y dcnl dcsp dcsp assert array equal model delays np arange slim0 slim1 + 1 dcnl dcsp dcsp assert allclose model coef expected atol 0 1 dcnl dcsp tdr timedelayingridge slim0 slim1 1 0 0 01 reg type foo dcnl dcsp model receptivefield slim0 slim1 1 0 estimator tdr dcnl dcsp assert raises valueerror model fit x y dcnl dcsp tdr timedelayingridge slim0 slim1 1 0 0 01 reg type laplacian dcnl dcsp model receptivefield slim0 slim1 1 0 estimator tdr dcnl dcsp assert raises valueerror model fit x y dcnl dcsp tdr timedelayingridge slim0 slim1 1 0 0 0 dcnl dcsp tdr no timedelayingridge slim0 slim1 1 0 0 0 fit intercept false dcnl dcsp for estimator in ridge alpha 0 0 tdr ridge alpha 0 0 fit intercept false tdr no dcnl dcsp dcsp x np mean x axis 0 dcnl dcsp dcsp y np mean y axis 0 dcnl dcsp dcsp model receptivefield slim0 slim1 1 0 estimator estimator dcnl dcsp dcsp model fit x y dcnl dcsp dcsp assert allclose model estimator intercept 0 0 atol 0 01 dcnl dcsp dcsp assert allclose model coef expected atol 0 1 dcnl dcsp dcsp x + 1000 0 dcnl dcsp dcsp model fit x y dcnl dcsp dcsp if estimator fit intercept dcnl dcsp dcsp dcsp val itol ctol 6000 4000 15 0 05 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp val itol ctol 0 0 0 0 2 0 dcnl dcsp dcsp assert allclose model estimator intercept val atol itol dcnl dcsp dcsp assert allclose model coef expected atol ctol dcnl dcsp dcsp model receptivefield slim0 slim1 1 0 fit intercept false dcnl dcsp dcsp model fit x y dcnl dcsp dcsp assert allclose model estimator intercept 0 0 atol 1e07 dcnl dcsp dcsp score model score x y dcnl dcsp dcsp assert true score 0 6 msg score
def test scaler dcsp raw io read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp epochs data epochs get data dcnl dcsp y epochs events 1 dcnl dcsp methods none dict mag 5 grad 10 eeg 20 mean median dcnl dcsp infos epochs info epochs info none none dcnl dcsp epochs data t epochs data transpose 1 0 2 dcnl dcsp for method info in zip methods infos dcnl dcsp dcsp if method median and not check version sklearn 0 17 dcnl dcsp dcsp dcsp assert raises valueerror scaler info method dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp if method mean and not check version sklearn dcnl dcsp dcsp dcsp assert raises importerror scaler info method dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp scaler scaler info method dcnl dcsp dcsp x scaler fit transform epochs data y dcnl dcsp dcsp assert equal x shape epochs data shape dcnl dcsp dcsp if method is none or isinstance method dict dcnl dcsp dcsp dcsp sd defaults scalings if method is none else method dcnl dcsp dcsp dcsp stds np zeros len picks dcnl dcsp dcsp dcsp for key in mag grad dcnl dcsp dcsp dcsp dcsp stdspick types epochs info meg key 1 0 sdkey dcnl dcsp dcsp dcsp stdspick types epochs info meg false eeg true 1 0 sd eeg dcnl dcsp dcsp dcsp means np zeros len epochs ch names dcnl dcsp dcsp elif method mean dcnl dcsp dcsp dcsp stds np array np std ch data for ch data in epochs data t dcnl dcsp dcsp dcsp means np array np mean ch data for ch data in epochs data t dcnl dcsp dcsp else dcnl dcsp dcsp dcsp percs np array np percentile ch data 25 50 75 for ch data in epochs data t dcnl dcsp dcsp dcsp stds percs 2 percs 0 dcnl dcsp dcsp dcsp means percs 1 dcnl dcsp dcsp assert allclose x stds np newaxis + means np newaxis epochs data rtol 1e12 atol 1e20 err msg method dcnl dcsp dcsp x2 scaler fit epochs data y transform epochs data dcnl dcsp dcsp assert array equal x x2 dcnl dcsp dcsp xi scaler inverse transform x dcnl dcsp dcsp assert array almost equal epochs data xi dcnl dcsp assert raises valueerror scaler fit epochs y dcnl dcsp assert raises valueerror scaler transform epochs y dcnl dcsp epochs bad epochs raw events event id 0 0 01 picks np arange len raw ch names dcnl dcsp scaler scaler epochs bad info none dcnl dcsp assert raises valueerror scaler fit epochs bad get data y
def test filterestimator dcsp raw io read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp epochs data epochs get data dcnl dcsp filt filterestimator epochs info l freq 40 h freq 80 filter length auto l trans bandwidth auto h trans bandwidth auto dcnl dcsp y epochs events 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x filt fit transform epochs data y dcnl dcsp dcsp assert true x shape epochs data shape dcnl dcsp dcsp assert array equal filt fit epochs data y transform epochs data x dcnl dcsp filt filterestimator epochs info l freq none h freq 40 filter length auto l trans bandwidth auto h trans bandwidth auto dcnl dcsp y epochs events 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x filt fit transform epochs data y dcnl dcsp filt filterestimator epochs info l freq 1 h freq 1 dcnl dcsp y epochs events 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror filt fit transform epochs data y dcnl dcsp filt filterestimator epochs info l freq 40 h freq none filter length auto l trans bandwidth auto h trans bandwidth auto dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x filt fit transform epochs data y dcnl dcsp assert raises valueerror filt fit epochs y dcnl dcsp assert raises valueerror filt transform epochs y
def test psdestimator dcsp raw io read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 preload true dcnl dcsp epochs data epochs get data dcnl dcsp psd psdestimator 2 np pi 0 np inf dcnl dcsp y epochs events 1 dcnl dcsp x psd fit transform epochs data y dcnl dcsp assert true x shape0 epochs data shape0 dcnl dcsp assert array equal psd fit epochs data y transform epochs data x dcnl dcsp assert raises valueerror psd fit epochs y dcnl dcsp assert raises valueerror psd transform epochs y
def test vectorizer dcsp data np random rand 150 18 6 dcnl dcsp vect vectorizer dcnl dcsp result vect fit transform data dcnl dcsp assert equal result ndim 2 dcnl dcsp orig data vect inverse transform result dcnl dcsp assert equal orig data ndim 3 dcnl dcsp assert array equal orig data data dcnl dcsp assert array equal vect inverse transform result1 data1 dcnl dcsp assert equal vect fit transform np random rand 150 18 6 3 shape 150 324 dcnl dcsp assert equal vect fit transform data1 shape 149 108 dcnl dcsp vect fit np random rand 105 12 3 dcnl dcsp assert raises valueerror vect transform np random rand 105 12 3 1 dcnl dcsp assert raises valueerror vect inverse transform np random rand 102 12 12
requires sklearn 0 15 dcnl def test unsupervised spatial filter dcsp from sklearn decomposition import pca dcnl dcsp from sklearn kernel ridge import kernelridge dcnl dcsp raw io read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg true stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks preload true baseline none verbose false dcnl dcsp assert raises valueerror unsupervisedspatialfilter kernelridge 2 dcnl dcsp x epochs get data dcnl dcsp n components 4 dcnl dcsp usf unsupervisedspatialfilter pca n components dcnl dcsp usf fit x dcnl dcsp usf1 unsupervisedspatialfilter pca n components dcnl dcsp assert equal usf transform x ndim 3 dcnl dcsp assert array almost equal usf transform x usf1 fit transform x dcnl dcsp assert equal usf transform x shape1 n components dcnl dcsp assert array almost equal usf inverse transform usf transform x x dcnl dcsp usf unsupervisedspatialfilter pca 4 average true dcnl dcsp usf fit transform x dcnl dcsp assert raises valueerror unsupervisedspatialfilter pca 4 2
def test temporal filter dcsp x np random rand 5 5 1200 dcnl dcsp values 10hz none 100 0 auto 5 0 10hz 100 0 auto 10 0 20 0 5 0 auto none none 100 0 5hz dcnl dcsp for low high sf ltrans in values dcnl dcsp dcsp filt temporalfilter low high sf ltrans fir design firwin dcnl dcsp dcsp assert raises valueerror filt fit transform x dcnl dcsp for low high in 5 0 15 0 none 15 0 5 0 none dcnl dcsp dcsp filt temporalfilter low high sfreq 100 0 fir design firwin dcnl dcsp dcsp xt filt fit transform x dcnl dcsp dcsp assert array equal filt fit transform x xt dcnl dcsp dcsp assert true x shape xt shape dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises typeerror filt transform 1 2 dcnl dcsp x np random rand 101 500 dcnl dcsp filt temporalfilter l freq 25 0 h freq 50 0 sfreq 1000 0 filter length 150 fir design firwin2 dcnl dcsp assert equal filt fit transform x shape x shape
slow test dcnl requires sklearn 0 15 dcnl def test generalization across time dcsp from sklearn svm import svc dcnl dcsp from sklearn base import is classifier dcnl dcsp from sklearn kernel ridge import kernelridge dcnl dcsp from sklearn preprocessing import labelencoder dcnl dcsp from sklearn metrics import roc auc score mean squared error dcnl dcsp epochs make epochs dcnl dcsp y 4classes np hstack epochs events 7 2 epochs events7 2 + 1 dcnl dcsp if check version sklearn 0 18 dcnl dcsp dcsp from sklearn model selection import kfold stratifiedkfold shufflesplit leaveonegroupout dcnl dcsp dcsp cv leaveonegroupout dcnl dcsp dcsp cv shuffle shufflesplit dcnl dcsp dcsp cv lolo train test for train test in cv split y 4classes y 4classes y 4classes dcnl dcsp dcsp scorer regress none dcnl dcsp else dcnl dcsp dcsp from sklearn cross validation import kfold stratifiedkfold shufflesplit leaveonelabelout dcnl dcsp dcsp cv shuffle shufflesplit len epochs dcnl dcsp dcsp cv lolo leaveonelabelout y 4classes dcnl dcsp dcsp scorer regress mean squared error dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime picks foo dcnl dcsp assert equal <gat dcsp | dcsp no dcsp fit dcsp no dcsp prediction dcsp no dcsp score s gat dcnl dcsp assert raises valueerror gat fit epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat picks 0 dcnl dcsp dcsp gat fit epochs dcnl dcsp dcsp gat picks none dcnl dcsp dcsp gat fit epochs y epochs events 2 dcnl dcsp dcsp gat fit epochs y epochs events 2 tolist dcnl dcsp assert equal len gat picks len gat ch names 1 dcnl dcsp assert equal <gat dcsp | dcsp fitted dcsp start dcsp dcsp 0 200 dcsp s dcsp stop dcsp dcsp 0 499 dcsp s dcsp no dcsp prediction dcsp no dcsp score s gat dcnl dcsp assert equal gat ch names epochs ch names dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime predict method decision function dcnl dcsp gat fit epochs dcnl dcsp assert true gat cv class stratifiedkfold dcnl dcsp gat predict epochs dcnl dcsp assert array equal np shape gat y pred 15 15 14 1 dcnl dcsp gat predict method predict proba dcnl dcsp gat predict epochs dcnl dcsp assert array equal np shape gat y pred 15 15 14 2 dcnl dcsp gat predict method foo dcnl dcsp assert raises notimplementederror gat predict epochs dcnl dcsp gat predict method predict dcnl dcsp gat predict epochs dcnl dcsp assert array equal np shape gat y pred 15 15 14 1 dcnl dcsp assert equal <gat dcsp | dcsp fitted dcsp start dcsp dcsp 0 200 dcsp s dcsp stop dcsp dcsp 0 499 dcsp s dcsp predicted dcsp 14 dcsp epochs dcsp no dcsp score s gat dcnl dcsp gat score epochs dcnl dcsp assert true gat scorer name accuracy score dcnl dcsp gat scorer none dcnl dcsp gat predict method decision function dcnl dcsp assert raises valueerror gat score epochs dcnl dcsp gat predict method predict dcnl dcsp gat score epochs y epochs events 2 dcnl dcsp gat score epochs y epochs events 2 tolist dcnl dcsp assert equal <gat dcsp | dcsp fitted dcsp start dcsp dcsp 0 200 dcsp s dcsp stop dcsp dcsp 0 499 dcsp s dcsp predicted dcsp 14 dcsp epochs n dcsp scored dcsp accuracy score s gat dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs y epochs events 2 dcnl dcsp old mode gat predict mode dcnl dcsp gat predict mode superfoomode dcnl dcsp assert raises valueerror gat predict epochs dcnl dcsp gat predict mode old mode dcnl dcsp gat score epochs y epochs events 2 dcnl dcsp assert true accuracy score in s gat scorer dcnl dcsp epochs2 epochs copy dcnl dcsp assert equal <decodingtime dcsp | dcsp start dcsp 0 200 dcsp s dcsp stop dcsp 0 499 dcsp s dcsp step dcsp 0 050 dcsp s dcsp length dcsp 0 050 dcsp s dcsp n time windows dcsp 15 s gat train times dcnl dcsp assert equal <decodingtime dcsp | dcsp start dcsp 0 200 dcsp s dcsp stop dcsp 0 499 dcsp s dcsp step dcsp 0 050 dcsp s dcsp length dcsp 0 050 dcsp s dcsp n time windows dcsp 15 dcsp x dcsp 15 s gat test times dcnl dcsp gat predict mode meanprediction dcnl dcsp epochs2 events 2 + 10 dcnl dcsp gat copy deepcopy gat dcnl dcsp with use log level error dcnl dcsp dcsp assert raises valueerror gat score epochs2 dcnl dcsp gat predict mode crossvalidation dcnl dcsp assert true gat y train shape0 gat y true shape0 len gat y pred 00 14 dcnl dcsp assert true np shape gat estimators 1 gat cv dcnl dcsp assert true len gat train times slices 15 np shape gat estimators 0 dcnl dcsp assert true len gat test times slices 15 np shape gat scores 0 dcnl dcsp assert true len gat test times slices 0 15 np shape gat scores 1 dcnl dcsp gat score mode foo dcnl dcsp assert raises valueerror gat score epochs dcnl dcsp gat score mode foldwise dcnl dcsp scores gat score epochs dcnl dcsp assert array equal np shape scores 15 15 5 dcnl dcsp gat score mode meansamplewise dcnl dcsp scores gat score epochs dcnl dcsp assert array equal np shape scores 15 15 dcnl dcsp gat score mode meanfoldwise dcnl dcsp scores gat score epochs dcnl dcsp assert array equal np shape scores 15 15 dcnl dcsp gat predict mode meanprediction dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp gat score epochs dcnl dcsp dcsp assert true any score mode dcsp changed dcsp from dcsp in str ww message for ww in w dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime train times length 0 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat2 gat fit epochs dcnl dcsp assert true gat is gat2 dcnl dcsp assert true hasattr gat2 cv dcnl dcsp assert true gat2 cv gat cv dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp scores gat score epochs dcnl dcsp assert true isinstance scores np ndarray dcnl dcsp assert equal len scores0 len scores dcnl dcsp assert equal len gat test times slices 00 2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime train times step 0 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs dcnl dcsp gat score epochs dcnl dcsp assert true len gat scores len gat estimators 8 dcnl dcsp assert equal len gat scores 0 15 dcnl dcsp y 4classes np hstack epochs events 7 2 epochs events7 2 + 1 dcnl dcsp train times dict start 0 09 stop 0 25 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime cv cv lolo train times train times dcnl dcsp assert raises runtimeerror gat predict epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs y y 4classes dcnl dcsp gat score epochs dcnl dcsp assert equal len gat scores 4 dcnl dcsp assert equal gat train times times 0 epochs times6 dcnl dcsp assert equal gat train times times 1 epochs times9 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime test times diagonal dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs dcnl dcsp assert raises runtimeerror gat score dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat predict epochs dcnl dcsp scores gat score dcnl dcsp assert true scores is gat scores dcnl dcsp assert equal np shape gat scores 15 1 dcnl dcsp assert array equal tim for ttime in gat test times times for tim in ttime gat train times times dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime predict mode meanprediction cv 2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs0 6 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat predict epochs7 dcnl dcsp dcsp gat score epochs7 dcnl dcsp gat copy deepcopy gat dcnl dcsp gat train times dict start 999 0 dcnl dcsp with use log level error dcnl dcsp dcsp assert raises valueerror gat fit epochs dcnl dcsp gat train times dict start 999 0 dcnl dcsp assert raises valueerror gat fit epochs dcnl dcsp gat train times dict step 1e06 dcnl dcsp assert raises valueerror gat fit epochs dcnl dcsp gat train times dict length 1e06 dcnl dcsp assert raises valueerror gat fit epochs dcnl dcsp gat train times dict length 999 0 dcnl dcsp assert raises valueerror gat fit epochs dcnl dcsp gat test times dict start 999 0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror gat predict epochs dcnl dcsp gat test times dict start 999 0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror gat predict epochs dcnl dcsp gat test times dict step 1e06 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror gat predict epochs dcnl dcsp gat copy deepcopy gat dcnl dcsp gat train times length 1e06 dcnl dcsp gat test times dict length 1e06 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror gat predict epochs dcnl dcsp gat test times dict step 0 15 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat predict epochs dcnl dcsp assert array equal np shape gat y pred 15 5 14 1 dcnl dcsp gat test times foo dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises valueerror gat predict epochs dcnl dcsp assert raises runtimeerror gat score dcnl dcsp gat test times dict length 0 15 dcnl dcsp assert raises valueerror gat predict epochs dcnl dcsp train times dict slices 0 1 1 dcnl dcsp test times dict slices 0 1 0 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime train times train times test times test times dcnl dcsp gat fit epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat score epochs dcnl dcsp assert array equal np shape gat y pred 0 1 len epochs 1 dcnl dcsp assert array equal np shape gat y pred 1 2 len epochs 1 dcnl dcsp gat test times none dcnl dcsp assert raises valueerror gat predict epochs dcnl dcsp svc svc c 1 kernel linear probability true dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime clf svc predict mode meanprediction dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs dcnl dcsp with use log level error dcnl dcsp dcsp assert raises valueerror gat score epochs2 dcnl dcsp dcsp gat score epochs dcnl dcsp assert true 0 0 < np min scores < 1 0 dcnl dcsp assert true 0 0 < np max scores < 1 0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime cv cv shuffle predict mode crossvalidation dcnl dcsp gat fit epochs dcnl dcsp assert raises valueerror gat predict epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime cv cv shuffle predict mode meanprediction dcnl dcsp gat fit epochs dcnl dcsp gat predict epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime dcnl dcsp gat fit epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat fit epochs dcnl dcsp gat predict epochs dcnl dcsp assert raises valueerror gat predict epochs 10 dcnl dcsp gat cv splits0 gat cv splits00 np empty 0 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp gat predict epochs dcnl dcsp dcsp assert true len w 0 dcnl dcsp dcsp assert true any do dcsp not dcsp have dcsp any dcsp test dcsp epochs in str ww message for ww in w dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp gat generalizationacrosstime cv 0 1 0 dcnl dcsp assert raises valueerror gat fit epochs 2 dcnl dcsp if check version sklearn 0 17 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp gat generalizationacrosstime clf kernelridge cv 2 dcnl dcsp dcsp epochs crop none epochs times2 dcnl dcsp dcsp gat fit epochs dcnl dcsp dcsp assert true gat cv class kfold dcnl dcsp dcsp gat score epochs dcnl dcsp dcsp assert true gat scorer name mean squared error dcnl dcsp n classes 2 4 dcnl dcsp le labelencoder dcnl dcsp y le fit transform epochs events 2 dcnl dcsp y len y 2 + 2 dcnl dcsp ys y y + 1000 dcnl dcsp svc svc c 1 kernel linear probability true dcnl dcsp reg kernelridge dcnl dcsp def scorer proba y true y pred dcnl dcsp dcsp return roc auc score y true y pred 0 dcnl dcsp scorers none scorer proba scorer regress dcnl dcsp predict methods none predict proba none dcnl dcsp clfs svc svc reg dcnl dcsp for clf predict method scorer in zip clfs predict methods scorers dcnl dcsp dcsp for y in ys dcnl dcsp dcsp dcsp for n class in n classes dcnl dcsp dcsp dcsp dcsp for predict mode in crossvalidation meanprediction dcnl dcsp dcsp dcsp dcsp dcsp if predict method predict proba and n class 2 dcnl dcsp dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp dcsp y y n class dcnl dcsp dcsp dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp dcsp dcsp gat generalizationacrosstime cv 2 clf clf scorer scorer predict mode predict mode dcnl dcsp dcsp dcsp dcsp dcsp dcsp gat fit epochs y y dcnl dcsp dcsp dcsp dcsp dcsp dcsp gat score epochs y y dcnl dcsp dcsp dcsp dcsp dcsp scorer name gat scorer name dcnl dcsp dcsp dcsp dcsp dcsp if scorer is none dcnl dcsp dcsp dcsp dcsp dcsp dcsp if is classifier clf dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp assert equal scorer name accuracy score dcnl dcsp dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp assert equal scorer name mean squared error dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp assert equal scorer name scorer name
requires sklearn dcnl def test decoding time dcsp from sklearn svm import svr dcnl dcsp if check version sklearn 0 18 dcnl dcsp dcsp from sklearn model selection import kfold dcnl dcsp else dcnl dcsp dcsp from sklearn cross validation import kfold dcnl dcsp epochs make epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp tg timedecoding dcnl dcsp assert equal <timedecoding dcsp | dcsp no dcsp fit dcsp no dcsp prediction dcsp no dcsp score s tg dcnl dcsp assert true hasattr tg times dcnl dcsp assert true not hasattr tg train times dcnl dcsp assert true not hasattr tg test times dcnl dcsp tg fit epochs dcnl dcsp assert equal <timedecoding dcsp | dcsp fitted dcsp start dcsp dcsp 0 200 dcsp s dcsp stop dcsp dcsp 0 499 dcsp s dcsp no dcsp prediction dcsp no dcsp score s tg dcnl dcsp assert true not hasattr tg train times dcnl dcsp assert true not hasattr tg test times dcnl dcsp assert raises runtimeerror tg score epochs none dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp tg predict epochs dcnl dcsp assert equal <timedecoding dcsp | dcsp fitted dcsp start dcsp dcsp 0 200 dcsp s dcsp stop dcsp dcsp 0 499 dcsp s dcsp predicted dcsp 14 dcsp epochs dcsp no dcsp score s tg dcnl dcsp assert array equal np shape tg y pred 15 14 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp tg score epochs dcnl dcsp tg score dcnl dcsp assert array equal np shape tg scores 15 dcnl dcsp assert equal <timedecoding dcsp | dcsp fitted dcsp start dcsp dcsp 0 200 dcsp s dcsp stop dcsp dcsp 0 499 dcsp s dcsp predicted dcsp 14 dcsp epochs n dcsp scored dcsp accuracy score s tg dcnl dcsp clf svr dcnl dcsp cv kfold len epochs dcnl dcsp y np random rand len epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp tg timedecoding clf clf cv cv dcnl dcsp tg fit epochs y y dcnl dcsp epochs crop epochs times0 epochs times2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp td 1 timedecoding scorer accuracy dcnl dcsp td 1 fit epochs dcnl dcsp score 1 td 1 score epochs dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp td 2 timedecoding dcnl dcsp td 2 fit epochs dcnl dcsp score 2 td 2 score epochs dcnl dcsp assert array equal score 1 score 2 dcnl dcsp td 1 scorer accuracies dcnl dcsp assert raises keyerror td 1 score epochs
verbose dcnl def compute ems epochs conditions none picks none n jobs 1 verbose none cv none dcsp logger info computing dcsp surrogate dcsp time dcsp series dcsp this dcsp can dcsp take dcsp some dcsp time dcnl dcsp cv leaveoneout if cv is none else cv dcnl dcsp if picks is none dcnl dcsp dcsp picks pick types epochs info meg true eeg true dcnl dcsp if not len set counter epochs events 2 values 1 dcnl dcsp dcsp raise valueerror the dcsp same dcsp number dcsp of dcsp epochs dcsp is dcsp required dcsp by dcsp this dcsp function dcsp please dcsp consider dcsp epochs equalize event counts dcnl dcsp if conditions is none dcnl dcsp dcsp conditions epochs event id keys dcnl dcsp dcsp epochs epochs copy dcnl dcsp else dcnl dcsp dcsp epochs epochsconditions dcnl dcsp epochs drop bad dcnl dcsp if len conditions 2 dcnl dcsp dcsp raise valueerror currently dcsp this dcsp function dcsp expects dcsp exactly dcsp 2 dcsp conditions dcsp but dcsp you dcsp gave dcsp me dcsp i len conditions dcnl dcsp ev epochs events 2 dcnl dcsp conditions list sorted conditions dcnl dcsp cond idx np where ev epochs event idk 0 for k in conditions dcnl dcsp info pick info epochs info picks dcnl dcsp data epochs get data picks dcnl dcsp for ch type in mag grad eeg dcnl dcsp dcsp if ch type in epochs dcnl dcsp dcsp dcsp if ch type eeg dcnl dcsp dcsp dcsp dcsp this picks pick types info meg false eeg true dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this picks pick types info meg ch type eeg false dcnl dcsp dcsp dcsp data this picks np std data this picks dcnl dcsp y epochs events 2 dcnl dcsp cv splits set cv cv classifier x y y y dcnl dcsp parallel p func parallel func run ems n jobs n jobs dcnl dcsp out parallel p func ems diff data cond idx train test for train test in cv splits dcnl dcsp surrogate trials spatial filter zip out dcnl dcsp surrogate trials np array surrogate trials dcnl dcsp spatial filter np mean spatial filter axis 0 dcnl dcsp return surrogate trials spatial filter epochs events 2
def ems diff data0 data1 dcsp return np mean data0 axis 0 np mean data1 axis 0
def run ems objective function data cond idx train test dcsp d objective function datanp intersect1d c train for c in cond idx dcnl dcsp d np sqrt np sum d 2 axis 0 none dcnl dcsp return np sum datatest0 d axis 0 d
def pad time series x n delays fill mean true dcsp fill value 0 dcnl dcsp if fill mean dcnl dcsp dcsp fill value np mean x axis 0 keepdims true dcnl dcsp dcsp if x ndim 3 dcnl dcsp dcsp dcsp fill value np mean fill value axis 1 keepdims true dcnl dcsp x np pad x 0 n delays 1 + 0 0 x ndim 1 constant dcnl dcsp x n delays 1 fill value dcnl dcsp return x
def delay time series x tmin tmax sfreq newaxis 0 axis 0 epoch axis 1 fill mean false dcsp check delayer params tmin tmax sfreq dcnl dcsp delays times to delays tmin tmax sfreq dcnl dcsp delayed np zeros len delays + x shape dcnl dcsp if fill mean dcnl dcsp dcsp fill value x mean axis axis keepdims true dcnl dcsp dcsp if epoch axis is not none dcnl dcsp dcsp dcsp fill value np mean fill value axis epoch axis keepdims true dcnl dcsp dcsp dcsp delayed fill value dcnl dcsp for ii ix delay in enumerate delays dcnl dcsp dcsp take slice none x ndim dcnl dcsp dcsp put slice none x ndim dcnl dcsp dcsp if ix delay < 0 dcnl dcsp dcsp dcsp takeaxis slice none ix delay dcnl dcsp dcsp dcsp putaxis slice ix delay none dcnl dcsp dcsp elif ix delay 0 dcnl dcsp dcsp dcsp takeaxis slice ix delay none dcnl dcsp dcsp dcsp putaxis slice none ix delay dcnl dcsp dcsp delayediiput xtake dcnl dcsp delayed np rollaxis delayed 0 newaxis + 1 dcnl dcsp return delayed
def times to delays tmin tmax sfreq dcsp delays np arange int np round tmin sfreq int np round tmax sfreq + 1 dcnl dcsp return delays
def delays to slice delays dcsp min delay np clip delays min none 0 dcnl dcsp min delay none if min delay 0 else 1 min delay dcnl dcsp max delay np clip delays max 0 none dcnl dcsp max delay none if max delay < 0 else 1 max delay dcnl dcsp return slice min delay max delay
def check delayer params tmin tmax sfreq dcsp if not isinstance sfreq int float np int dcnl dcsp dcsp raise valueerror sfreq dcsp must dcsp be dcsp an dcsp integer dcsp or dcsp float dcnl dcsp sfreq float sfreq dcnl dcsp if not all isinstance ii int float np int for ii in tmin tmax dcnl dcsp dcsp raise valueerror tmin tmax dcsp must dcsp be dcsp an dcsp integer dcsp or dcsp float dcnl dcsp if not tmin < tmax dcnl dcsp dcsp raise valueerror tmin dcsp must dcsp be dcsp < dcsp tmax
def reshape for est x del dcsp n times n epochs n feats n delays x del shape dcnl dcsp x del x del reshape n times n epochs 1 dcnl dcsp x del x del reshape n times n epochs 1 order f dcnl dcsp return x del
def compute corrs x y smin smax dcsp len trf smax smin dcnl dcsp len x n ch x x shape dcnl dcsp len y n ch y y shape dcnl dcsp assert len x len y dcnl dcsp n fft next fast len x shape0 + max smax 0 min smin 0 1 dcnl dcsp x fft np fft rfft x t n fft dcnl dcsp y fft np fft rfft y t n fft dcnl dcsp ac np zeros n ch x n ch x len trf 2 1 dcnl dcsp for ch0 in range n ch x dcnl dcsp dcsp for ch1 in range ch0 n ch x dcnl dcsp dcsp dcsp ac temp np fft irfft x fftch0 x fftch1 conj n fft dcnl dcsp dcsp dcsp ac ch0 ch1 np concatenate ac temp len trf + 1 ac temp len trf dcnl dcsp dcsp dcsp if ch0 ch1 dcnl dcsp dcsp dcsp dcsp ac ch1 ch0 ac ch0 ch1 1 dcnl dcsp x y np zeros n ch y n ch x len trf dcnl dcsp for ch in in range n ch x dcnl dcsp dcsp for ch out in range n ch y dcnl dcsp dcsp dcsp cc temp np fft irfft y fftch out x fftch in conj n fft dcnl dcsp dcsp dcsp if smin < 0 and smax 0 dcnl dcsp dcsp dcsp dcsp x y ch out ch in np append cc tempsmin cc temp smax dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp x y ch out ch in cc tempsmin smax dcnl dcsp x xt make x xt ac dcnl dcsp x y shape n ch y n ch x len trf dcnl dcsp return x xt x y n ch x
def fit corrs x xt x y n ch x reg type alpha n ch in dcsp from scipy import linalg dcnl dcsp known types ridge laplacian dcnl dcsp if isinstance reg type string types dcnl dcsp dcsp reg type reg type 2 dcnl dcsp if len reg type 2 dcnl dcsp dcsp raise valueerror reg type dcsp must dcsp have dcsp two dcsp elements dcsp got dcsp s len reg type dcnl dcsp for r in reg type dcnl dcsp dcsp if r not in known types dcnl dcsp dcsp dcsp raise valueerror reg type dcsp entries dcsp must dcsp be dcsp one dcsp of dcsp s dcsp got dcsp s known types r dcnl dcsp n ch out x y shape0 dcnl dcsp assert x y shape1 n ch x 0 dcnl dcsp n trf x y shape1 n ch x dcnl dcsp reg np eye n trf dcnl dcsp if reg type0 laplacian dcnl dcsp dcsp reg flat1 reg shape0 + 1 + 1 dcnl dcsp dcsp reg flat reg shape0 + 1 reg shape0 1 reg shape0 + 1 + 1 dcnl dcsp dcsp reg flatreg shape0 reg shape0 + 1 + 1 dcnl dcsp args reg n ch x dcnl dcsp reg linalg block diag args dcnl dcsp if reg type1 laplacian dcnl dcsp dcsp row offset n trf n trf n ch x dcnl dcsp dcsp reg flatn trf n trf n ch x + 1 + 1 dcnl dcsp dcsp reg flat row offset + n trf row offset n trf n ch x + 1 + 1 dcnl dcsp dcsp reg flat n trf n trf n ch x n trf n ch x + 1 + 1 dcnl dcsp mat x xt + alpha reg dcnl dcsp try dcnl dcsp dcsp w linalg solve mat x y t sym pos true overwrite a false dcnl dcsp except np linalg linalgerror dcnl dcsp dcsp warnings warn singular dcsp matrix dcsp in dcsp solving dcsp dual dcsp problem dcsp using dcsp leastsquares dcsp solution dcsp instead dcnl dcsp dcsp w linalg lstsq mat x y t lapack driver gelsy 0 dcnl dcsp w w t reshape n ch out n ch in n trf dcnl dcsp return w
def predict slices x train times estimators cv splits predict mode predict method n orig epochs test epochs dcsp n epochs n times x shape dcnl dcsp n train len estimators dcnl dcsp n test len test t idxs for test t idxs in train times dcnl dcsp y pred none dcnl dcsp for train t idx estimator cv test t idxs in enumerate zip estimators train times dcnl dcsp dcsp start np arange n times dcnl dcsp dcsp contiguous start np array equal sl0 for sl in test t idxs start dcnl dcsp dcsp window lengths np unique len sl for sl in test t idxs dcnl dcsp dcsp vectorize times window lengths 1 and contiguous start dcnl dcsp dcsp if vectorize times dcnl dcsp dcsp dcsp test t idxs slice start0 start 1 + 1 1 dcnl dcsp dcsp elif warn once get vectorization true dcnl dcsp dcsp dcsp if len test t idxs 1 dcnl dcsp dcsp dcsp dcsp warn due dcsp to dcsp a dcsp time dcsp window dcsp with dcsp length dcsp dcsp 1 dcsp unable dcsp to dcsp dcsp vectorize dcsp across dcsp testing dcsp times dcsp this dcsp leads dcsp to dcsp slower dcsp predictions dcsp compared dcsp to dcsp the dcsp length dcsp dcsp 1 dcsp case dcnl dcsp dcsp dcsp dcsp warn once vectorization false dcnl dcsp dcsp for ii test t idx in enumerate test t idxs dcnl dcsp dcsp dcsp x pred x dcnl dcsp dcsp dcsp if not vectorize times dcnl dcsp dcsp dcsp dcsp x pred x test t idx reshape n epochs 1 dcnl dcsp dcsp dcsp if predict mode meanprediction dcnl dcsp dcsp dcsp dcsp y pred predict x pred estimator cv vectorize times vectorize times predict method predict method dcnl dcsp dcsp dcsp dcsp if y pred is none dcnl dcsp dcsp dcsp dcsp dcsp n dim y pred shape 1 dcnl dcsp dcsp dcsp dcsp dcsp y pred init ypred n train n test n orig epochs n dim dcnl dcsp dcsp dcsp dcsp if vectorize times dcnl dcsp dcsp dcsp dcsp dcsp y predtrain t idxtest t idx y pred dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp y predtrain t idxii y pred dcnl dcsp dcsp dcsp elif predict mode crossvalidation dcnl dcsp dcsp dcsp dcsp for test test epoch estimator in zip cv splits test epochs estimator cv dcnl dcsp dcsp dcsp dcsp dcsp if test size 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp dcsp y pred predict x predtest epoch estimator vectorize times vectorize times predict method predict method dcnl dcsp dcsp dcsp dcsp dcsp if y pred is none dcnl dcsp dcsp dcsp dcsp dcsp dcsp n dim y pred shape 1 dcnl dcsp dcsp dcsp dcsp dcsp dcsp y pred init ypred n train n test n orig epochs n dim dcnl dcsp dcsp dcsp dcsp dcsp if vectorize times dcnl dcsp dcsp dcsp dcsp dcsp dcsp y predtrain t idxtest t idx test y pred dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp y predtrain t idxii test y pred dcnl dcsp return y pred
def init ypred n train n test n orig epochs n dim dcsp if len set n test 1 dcnl dcsp dcsp y pred np empty n train n test0 n orig epochs n dim dcnl dcsp else dcnl dcsp dcsp y pred np array np empty this n n orig epochs n dim for this n in n test dcnl dcsp return y pred
def score slices y true list y pred scorer score mode cv dcsp scores list list dcnl dcsp for y pred in list y pred dcnl dcsp dcsp scores list dcnl dcsp dcsp for t this y pred in enumerate y pred dcnl dcsp dcsp dcsp if score mode in meanfoldwise foldwise dcnl dcsp dcsp dcsp dcsp scores list dcnl dcsp dcsp dcsp dcsp for train test in cv dcnl dcsp dcsp dcsp dcsp dcsp scores append scorer y truetest this y predtest dcnl dcsp dcsp dcsp dcsp scores np array scores dcnl dcsp dcsp dcsp dcsp if score mode meanfoldwise dcnl dcsp dcsp dcsp dcsp dcsp scores np mean scores axis 0 dcnl dcsp dcsp dcsp elif score mode meansamplewise dcnl dcsp dcsp dcsp dcsp scores scorer y true this y pred dcnl dcsp dcsp dcsp scores append scores dcnl dcsp dcsp scores list append scores dcnl dcsp return scores list
def check epochs input epochs y picks none dcsp if y is none dcnl dcsp dcsp y epochs events 2 dcnl dcsp elif isinstance y list dcnl dcsp dcsp y np array y dcnl dcsp x epochs get data dcnl dcsp if picks is none dcnl dcsp dcsp picks pick data channels epochs info with ref meg false dcnl dcsp if isinstance picks list np ndarray dcnl dcsp dcsp picks np array picks dtype np int dcnl dcsp else dcnl dcsp dcsp raise valueerror picks dcsp must dcsp be dcsp a dcsp list dcsp or dcsp a dcsp numpy ndarray dcsp of dcsp int dcnl dcsp x x picks dcnl dcsp assert x shape0 y shape0 dcnl dcsp return x y picks
def fit slices clf x chunk y slices cv splits dcsp from sklearn base import clone dcnl dcsp n epochs len x chunk dcnl dcsp estimators list dcnl dcsp values np unique val for sl in slices for val in sl dcnl dcsp for t slice in slices dcnl dcsp dcsp t slice np array np where ii values 00 for ii in t slice dcnl dcsp dcsp x x chunk t slice dcnl dcsp dcsp x x reshape n epochs np prod x shape1 dcnl dcsp dcsp estimators list dcnl dcsp dcsp for fold train test in enumerate cv splits dcnl dcsp dcsp dcsp clf clone clf dcnl dcsp dcsp dcsp clf fit xtrain ytrain dcnl dcsp dcsp dcsp estimators append clf dcnl dcsp dcsp estimators append estimators dcnl dcsp return estimators
def sliding window times window sfreq dcsp import copy dcnl dcsp window decodingtime copy deepcopy window dcnl dcsp time slices window get slices none dcnl dcsp if time slices is none dcnl dcsp dcsp window start window get start times0 dcnl dcsp dcsp window stop window get stop times 1 dcnl dcsp dcsp window step window get step 1 0 sfreq dcnl dcsp dcsp window length window get length 1 0 sfreq dcnl dcsp dcsp if not times0 < window start < times 1 dcnl dcsp dcsp dcsp raise valueerror start dcsp 2f dcsp s dcsp outside dcsp time dcsp range dcsp 2f dcsp 2f window start times0 times 1 dcnl dcsp dcsp if not times0 < window stop < times 1 dcnl dcsp dcsp dcsp raise valueerror stop dcsp 2f dcsp s dcsp outside dcsp time dcsp range dcsp 2f dcsp 2f window stop times0 times 1 dcnl dcsp dcsp if window step < 1 0 sfreq dcnl dcsp dcsp dcsp raise valueerror step dcsp must dcsp be dcsp dcsp 1 dcsp dcsp sampling frequency dcnl dcsp dcsp if window length < 1 0 sfreq dcnl dcsp dcsp dcsp raise valueerror length dcsp must dcsp be dcsp dcsp 1 dcsp dcsp sampling frequency dcnl dcsp dcsp if window length np ptp times dcnl dcsp dcsp dcsp raise valueerror length dcsp must dcsp be dcsp < dcsp time dcsp range dcnl dcsp dcsp def find t idx t dcnl dcsp dcsp dcsp return np argmin np abs np asarray times t dcnl dcsp dcsp start find t idx window start dcnl dcsp dcsp stop find t idx window stop dcnl dcsp dcsp step int round window step sfreq dcnl dcsp dcsp length int round window length sfreq dcnl dcsp dcsp time slices range start start + length dcnl dcsp dcsp while time slices 1 0 + step < stop length + 1 dcnl dcsp dcsp dcsp start time slices 1 0 + step dcnl dcsp dcsp dcsp time slices append range start start + length dcnl dcsp dcsp window slices time slices dcnl dcsp window times set window time window slices times dcnl dcsp return window
def set window time slices times dcsp t idx t 1 for t in slices dcnl dcsp return timest idx
def predict x estimators vectorize times predict method dcsp from scipy import stats dcnl dcsp from sklearn base import is classifier dcnl dcsp orig shape x shape dcnl dcsp n epochs orig shape0 dcnl dcsp n times orig shape 1 dcnl dcsp n clf len estimators dcnl dcsp if vectorize times dcnl dcsp dcsp x np hstack x t dcnl dcsp n epochs tmp len x dcnl dcsp for fold clf in enumerate estimators dcnl dcsp dcsp y pred getattr clf predict method x dcnl dcsp dcsp if y pred ndim 1 dcnl dcsp dcsp dcsp y pred y pred none dcnl dcsp dcsp if fold 0 dcnl dcsp dcsp dcsp predict size y pred shape1 dcnl dcsp dcsp dcsp y pred np ones n epochs tmp predict size n clf dcnl dcsp dcsp y pred fold y pred dcnl dcsp if fold 0 dcnl dcsp dcsp if is classifier clf and predict method predict dcnl dcsp dcsp dcsp y pred stats mode y pred axis 2 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp y pred np mean y pred axis 2 keepdims true dcnl dcsp y pred y pred 0 dcnl dcsp if vectorize times dcnl dcsp dcsp shape n epochs n times y pred shape 1 dcnl dcsp dcsp y pred y pred reshape shape transpose 1 0 2 dcnl dcsp return y pred
def chunk data x slices dcsp slices sl for sl in slices if len sl dcnl dcsp selected times np hstack np ravel sl for sl in slices dcnl dcsp start np min selected times dcnl dcsp stop np max selected times + 1 dcnl dcsp slices chunk sl start for sl in slices dcnl dcsp x chunk x start stop dcnl dcsp return x chunk slices chunk
def sl fit estimator x y dcsp from sklearn base import clone dcnl dcsp estimators list dcnl dcsp for ii in range x shape 1 dcnl dcsp dcsp est clone estimator dcnl dcsp dcsp est fit x ii y dcnl dcsp dcsp estimators append est dcnl dcsp return estimators
def sl transform estimators x method dcsp for ii est in enumerate estimators dcnl dcsp dcsp transform getattr est method dcnl dcsp dcsp y pred transform x ii dcnl dcsp dcsp if ii 0 dcnl dcsp dcsp dcsp y pred sl init pred y pred x dcnl dcsp dcsp y pred ii y pred dcnl dcsp return y pred
def sl init pred y pred x dcsp n sample n tasks x shape0 x shape 1 dcnl dcsp y pred np zeros n sample n tasks + y pred shape1 y pred dtype dcnl dcsp return y pred
def sl score estimators scoring x y dcsp n tasks x shape 1 dcnl dcsp score np zeros n tasks dcnl dcsp for ii est in enumerate estimators dcnl dcsp dcsp scoreii scoring est x ii y dcnl dcsp return score
def check method estimator method dcsp if method transform and not hasattr estimator transform dcnl dcsp dcsp method predict dcnl dcsp if not hasattr estimator method dcnl dcsp dcsp valueerror base estimator dcsp does dcsp not dcsp have dcsp s dcsp method method dcnl dcsp return method
def gl transform estimators x method dcsp n sample n iter x shape0 x shape 1 dcnl dcsp for ii est in enumerate estimators dcnl dcsp dcsp x stack x transpose np r 0 x ndim 1 range 1 x ndim 1 dcnl dcsp dcsp x stack x stack reshape np r n sample n iter x stack shape2 dcnl dcsp dcsp transform getattr est method dcnl dcsp dcsp y pred transform x stack dcnl dcsp dcsp if y pred ndim 2 dcnl dcsp dcsp dcsp y pred np reshape y pred n sample n iter y pred shape1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp shape np r n sample n iter y pred shape1 astype int dcnl dcsp dcsp dcsp y pred np reshape y pred shape dcnl dcsp dcsp if ii 0 dcnl dcsp dcsp dcsp y pred gl init pred y pred x len estimators dcnl dcsp dcsp y pred ii y pred dcnl dcsp return y pred
def gl init pred y pred x n train dcsp n sample n iter x shape0 x shape 1 dcnl dcsp if y pred ndim 3 dcnl dcsp dcsp y pred np zeros n sample n train n iter y pred shape 1 y pred dtype dcnl dcsp else dcnl dcsp dcsp y pred np zeros n sample n train n iter y pred dtype dcnl dcsp return y pred
def gl score estimators scoring x y dcsp score shape len estimators x shape 1 dcnl dcsp for ii est in enumerate estimators dcnl dcsp dcsp for jj in range x shape 1 dcnl dcsp dcsp dcsp score scoring est x jj y dcnl dcsp dcsp dcsp if ii 0 jj 0 dcnl dcsp dcsp dcsp dcsp dtype type score dcnl dcsp dcsp dcsp dcsp score np zeros score shape dtype dcnl dcsp dcsp dcsp scoreii jj score dcnl dcsp return score
verbose dcnl def parallel func func n jobs verbose none max nbytes auto pre dispatch 2 dcsp dcsp n jobs dcsp if n jobs 1 dcnl dcsp dcsp n jobs 1 dcnl dcsp dcsp my func func dcnl dcsp dcsp parallel list dcnl dcsp dcsp return parallel my func n jobs dcnl dcsp try dcnl dcsp dcsp from joblib import parallel delayed dcnl dcsp except importerror dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from sklearn externals joblib import parallel delayed dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp warn joblib dcsp not dcsp installed dcsp cannot dcsp run dcsp in dcsp parallel dcnl dcsp dcsp dcsp n jobs 1 dcnl dcsp dcsp dcsp my func func dcnl dcsp dcsp dcsp parallel list dcnl dcsp dcsp dcsp return parallel my func n jobs dcnl dcsp p args get args parallel init dcnl dcsp joblib mmap temp folder in p args and max nbytes in p args dcnl dcsp cache dir get config mne cache dir none dcnl dcsp if isinstance max nbytes string types and max nbytes auto dcnl dcsp dcsp max nbytes get config mne memmap min size none dcnl dcsp if max nbytes is not none dcnl dcsp dcsp if not joblib mmap and cache dir is not none dcnl dcsp dcsp dcsp warn mne cache dir dcsp is dcsp set dcsp but dcsp a dcsp newer dcsp version dcsp of dcsp joblib dcsp is dcsp needed dcsp to dcsp use dcsp the dcsp memmapping dcsp pool dcnl dcsp dcsp if joblib mmap and cache dir is none dcnl dcsp dcsp dcsp logger info joblib dcsp supports dcsp memapping dcsp pool dcsp but dcsp mne cache dir dcsp is dcsp not dcsp set dcsp in dcsp mnepython dcsp config dcsp to dcsp enable dcsp it dcsp use dcsp e g dcsp mne set cache dir tmp shm dcsp this dcsp will dcsp store dcsp temporary dcsp files dcsp under dcsp dev shm dcsp and dcsp can dcsp result dcsp in dcsp large dcsp memory dcsp savings dcnl dcsp kwargs verbose 5 if logger level < logging info else 0 dcnl dcsp kwargs pre dispatch pre dispatch dcnl dcsp if joblib mmap dcnl dcsp dcsp if cache dir is none dcnl dcsp dcsp dcsp max nbytes none dcnl dcsp dcsp kwargs temp folder cache dir dcnl dcsp dcsp kwargs max nbytes max nbytes dcnl dcsp n jobs check n jobs n jobs dcnl dcsp parallel parallel n jobs kwargs dcnl dcsp my func delayed func dcnl dcsp return parallel my func n jobs
def check n jobs n jobs allow cuda false dcsp if not isinstance n jobs int dcnl dcsp dcsp if not allow cuda dcnl dcsp dcsp dcsp raise valueerror n jobs dcsp must dcsp be dcsp an dcsp integer dcnl dcsp dcsp elif not isinstance n jobs string types or n jobs cuda dcnl dcsp dcsp dcsp raise valueerror n jobs dcsp must dcsp be dcsp an dcsp integer dcsp or dcsp cuda dcnl dcsp elif force serial dcnl dcsp dcsp n jobs 1 dcnl dcsp dcsp logger info dcsp mne force serial dcsp set dcsp processing dcsp in dcsp forced dcsp serial dcsp mode dcnl dcsp elif n jobs < 0 dcnl dcsp dcsp try dcnl dcsp dcsp dcsp import multiprocessing dcnl dcsp dcsp dcsp n cores multiprocessing cpu count dcnl dcsp dcsp dcsp n jobs min n cores + n jobs + 1 n cores dcnl dcsp dcsp dcsp if n jobs < 0 dcnl dcsp dcsp dcsp dcsp raise valueerror if dcsp n jobs dcsp has dcsp a dcsp negative dcsp value dcsp it dcsp must dcsp not dcsp be dcsp less dcsp than dcsp the dcsp number dcsp of dcsp cpus dcsp present dcsp you ve dcsp got dcsp s dcsp cpus n cores dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp if n jobs 1 dcnl dcsp dcsp dcsp dcsp warn multiprocessing dcsp not dcsp installed dcsp cannot dcsp run dcsp in dcsp parallel dcnl dcsp dcsp dcsp dcsp n jobs 1 dcnl dcsp return n jobs
def setup vmin vmax data vmin vmax norm false dcsp if vmax is none and vmin is none dcnl dcsp dcsp vmax np abs data max dcnl dcsp dcsp if norm dcnl dcsp dcsp dcsp vmin 0 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp vmin vmax dcnl dcsp else dcnl dcsp dcsp if callable vmin dcnl dcsp dcsp dcsp vmin vmin data dcnl dcsp dcsp elif vmin is none dcnl dcsp dcsp dcsp if norm dcnl dcsp dcsp dcsp dcsp vmin 0 0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp vmin np min data dcnl dcsp dcsp if callable vmax dcnl dcsp dcsp dcsp vmax vmax data dcnl dcsp dcsp elif vmax is none dcnl dcsp dcsp dcsp vmax np max data dcnl dcsp return vmin vmax
def plt show show true kwargs dcsp import matplotlib dcnl dcsp import matplotlib pyplot as plt dcnl dcsp if show and matplotlib get backend agg dcnl dcsp dcsp plt show kwargs
def tight layout pad 1 2 h pad none w pad none fig none dcsp import matplotlib pyplot as plt dcnl dcsp fig plt gcf if fig is none else fig dcnl dcsp fig canvas draw dcnl dcsp try dcnl dcsp dcsp with catch warnings record true as ws dcnl dcsp dcsp dcsp fig tight layout pad pad h pad h pad w pad w pad dcnl dcsp dcsp for msg in w get message for w in ws dcnl dcsp dcsp dcsp if not msg startswith this dcsp figure dcsp includes dcsp axes dcnl dcsp dcsp dcsp dcsp warn msg dcnl dcsp except exception dcnl dcsp dcsp try dcnl dcsp dcsp dcsp fig set tight layout dict pad pad h pad h pad w pad w pad dcnl dcsp dcsp except exception dcnl dcsp dcsp dcsp warn matplotlib dcsp function dcsp tight layout dcsp is dcsp not dcsp supported dcsp skipping dcsp subplot dcsp adjustment
def check delayed ssp container dcsp if container proj is true or all p active for p in container info projs dcnl dcsp dcsp raise runtimeerror projs dcsp are dcsp already dcsp applied dcsp please dcsp initialize dcsp the dcsp data dcsp with dcsp proj dcsp set dcsp to dcsp false dcnl dcsp elif len container info projs < 1 dcnl dcsp dcsp raise runtimeerror no dcsp projs dcsp found dcsp in dcsp evoked
def validate if list of axes axes obligatory len none dcsp import matplotlib as mpl dcnl dcsp if obligatory len is not none and not isinstance obligatory len int dcnl dcsp dcsp raise valueerror obligatory len dcsp must dcsp be dcsp none dcsp or dcsp int dcsp got dcsp d instead type obligatory len dcnl dcsp if not isinstance axes list np ndarray dcnl dcsp dcsp raise valueerror axes dcsp must dcsp be dcsp a dcsp list dcsp or dcsp numpy dcsp array dcsp of dcsp matplotlib dcsp axes dcsp objects dcsp got dcsp s dcsp instead type axes dcnl dcsp if isinstance axes np ndarray and axes ndim 1 dcnl dcsp dcsp raise valueerror if dcsp input dcsp is dcsp a dcsp numpy dcsp array dcsp it dcsp must dcsp be dcsp onedimensional dcsp the dcsp received dcsp numpy dcsp array dcsp has dcsp d dcsp dimensions dcsp however dcsp try dcsp using dcsp ravel dcsp or dcsp flatten dcsp method dcsp of dcsp the dcsp array axes ndim dcnl dcsp is correct type np array isinstance x mpl axes axes for x in axes dcnl dcsp if not np all is correct type dcnl dcsp dcsp first bad np where np logical not is correct type 00 dcnl dcsp dcsp raise valueerror axes dcsp must dcsp be dcsp a dcsp list dcsp or dcsp numpy dcsp array dcsp of dcsp matplotlib dcsp axes dcsp objects dcsp while dcsp one dcsp of dcsp the dcsp list dcsp elements dcsp is dcsp s type axesfirst bad dcnl dcsp if obligatory len is not none and not len axes obligatory len dcnl dcsp dcsp raise valueerror axes dcsp must dcsp be dcsp a dcsp list array dcsp of dcsp length dcsp d dcsp while dcsp the dcsp length dcsp is dcsp d obligatory len len axes
def mne analyze colormap limits 5 10 15 format mayavi dcsp limits np asarray limits dtype float dcnl dcsp if len limits 3 and len limits 6 dcnl dcsp dcsp raise valueerror limits dcsp must dcsp have dcsp 3 dcsp or dcsp 6 dcsp elements dcnl dcsp if len limits 3 and any limits < 0 0 dcnl dcsp dcsp raise valueerror if dcsp 3 dcsp elements dcsp limits dcsp must dcsp all dcsp be dcsp nonnegative dcnl dcsp if any np diff limits < 0 dcnl dcsp dcsp raise valueerror limits dcsp must dcsp be dcsp monotonically dcsp increasing dcnl dcsp if format matplotlib dcnl dcsp dcsp from matplotlib import colors dcnl dcsp dcsp if len limits 3 dcnl dcsp dcsp dcsp limits np concatenate np flipud limits limits + limits 1 2 limits 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp limits limits np min limits np max limits np min limits dcnl dcsp dcsp cdict red limits0 0 0 0 0 limits1 0 0 0 0 limits2 0 5 0 5 limits3 0 5 0 5 limits4 1 0 1 0 limits5 1 0 1 0 green limits0 1 0 1 0 limits1 0 0 0 0 limits2 0 5 0 5 limits3 0 5 0 5 limits4 0 0 0 0 limits5 1 0 1 0 blue limits0 1 0 1 0 limits1 1 0 1 0 limits2 0 5 0 5 limits3 0 5 0 5 limits4 0 0 0 0 limits5 0 0 0 0 dcnl dcsp dcsp return colors linearsegmentedcolormap mne analyze cdict dcnl dcsp elif format mayavi dcnl dcsp dcsp if len limits 3 dcnl dcsp dcsp dcsp limits np concatenate np flipud limits 0 limits limits 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp limits np concatenate limits 3 0 limits3 dcnl dcsp dcsp dcsp limits np max np abs limits dcnl dcsp dcsp r np array 0 0 0 0 1 1 1 dcnl dcsp dcsp g np array 1 0 0 0 0 0 1 dcnl dcsp dcsp b np array 1 1 1 0 0 0 0 dcnl dcsp dcsp a np array 1 1 0 0 0 1 1 dcnl dcsp dcsp xp np arange 256 128 128 0 dcnl dcsp dcsp colormap np r np interp xp limits 255 c for c in r g b a t dcnl dcsp dcsp return colormap dcnl dcsp else dcnl dcsp dcsp raise valueerror format dcsp must dcsp be dcsp either dcsp matplotlib dcsp or dcsp mayavi
def toggle options event params dcsp import matplotlib pyplot as plt dcnl dcsp if len params projs 0 dcnl dcsp dcsp if params fig proj is none dcnl dcsp dcsp dcsp draw proj checkbox event params draw current state false dcnl dcsp dcsp else dcnl dcsp dcsp dcsp plt close params fig proj dcnl dcsp dcsp dcsp del params proj checks dcnl dcsp dcsp dcsp params fig proj none
def toggle proj event params dcsp if proj checks in params dcnl dcsp dcsp bools x0 get visible for x in params proj checks lines dcnl dcsp dcsp for bi b p in enumerate zip bools params projs dcnl dcsp dcsp dcsp if not b and p active dcnl dcsp dcsp dcsp dcsp boolsbi true dcnl dcsp else dcnl dcsp dcsp proj params get apply proj true dcnl dcsp dcsp bools proj len params projs dcnl dcsp compute proj false dcnl dcsp if proj bools not in params dcnl dcsp dcsp compute proj true dcnl dcsp elif not np array equal bools params proj bools dcnl dcsp dcsp compute proj true dcnl dcsp if compute proj is true dcnl dcsp dcsp params plot update proj callback params bools
def get help text params dcsp text text2 list list dcnl dcsp text append u u2190 dcsp dcsp n dcnl dcsp text append u u2192 dcsp dcsp n dcnl dcsp text append u u2193 dcsp dcsp n dcnl dcsp text append u u2191 dcsp dcsp n dcnl dcsp text append u dcsp dcsp n dcnl dcsp text append u + dcsp or dcsp dcsp dcsp n dcnl dcsp text append u home dcsp dcsp n dcnl dcsp text append u end dcsp dcsp n dcnl dcsp if fig selection not in params dcnl dcsp dcsp text append u page dcsp down dcsp dcsp n dcnl dcsp dcsp text append u page dcsp up dcsp dcsp n dcnl dcsp text append u f11 dcsp dcsp n dcnl dcsp text append u dcsp dcsp n dcnl dcsp text append u esc dcsp dcsp n n dcnl dcsp text append u mouse dcsp controls n dcnl dcsp text append u click dcsp on dcsp data dcsp n dcnl dcsp text2 append navigate dcsp left n dcnl dcsp text2 append navigate dcsp right n dcnl dcsp text2 append scale dcsp down n dcnl dcsp text2 append scale dcsp up n dcnl dcsp text2 append toggle dcsp full dcsp screen dcsp mode n dcnl dcsp text2 append open dcsp help dcsp box n dcnl dcsp text2 append quit n n n dcnl dcsp if raw in params dcnl dcsp dcsp text2 insert 4 reduce dcsp the dcsp time dcsp shown dcsp per dcsp view n dcnl dcsp dcsp text2 insert 5 increase dcsp the dcsp time dcsp shown dcsp per dcsp view n dcnl dcsp dcsp text append u click dcsp elsewhere dcsp in dcsp the dcsp plot dcsp n dcnl dcsp dcsp if ica in params dcnl dcsp dcsp dcsp text append u click dcsp component dcsp name dcsp n dcnl dcsp dcsp dcsp text2 insert 2 navigate dcsp components dcsp down n dcnl dcsp dcsp dcsp text2 insert 3 navigate dcsp components dcsp up n dcnl dcsp dcsp dcsp text2 insert 8 reduce dcsp the dcsp number dcsp of dcsp components dcsp per dcsp view n dcnl dcsp dcsp dcsp text2 insert 9 increase dcsp the dcsp number dcsp of dcsp components dcsp per dcsp view n dcnl dcsp dcsp dcsp text2 append mark dcsp bad dcsp channel n dcnl dcsp dcsp dcsp text2 append vertical dcsp line dcsp at dcsp a dcsp time dcsp instant n dcnl dcsp dcsp dcsp text2 append show dcsp topography dcsp for dcsp the dcsp component n dcnl dcsp dcsp else dcnl dcsp dcsp dcsp text append u click dcsp channel dcsp name dcsp n dcnl dcsp dcsp dcsp text2 insert 2 navigate dcsp channels dcsp down n dcnl dcsp dcsp dcsp text2 insert 3 navigate dcsp channels dcsp up n dcnl dcsp dcsp dcsp text insert 6 u a dcsp dcsp n dcnl dcsp dcsp dcsp text2 insert 6 toggle dcsp annotation dcsp mode n dcnl dcsp dcsp dcsp text insert 7 u b dcsp dcsp n dcnl dcsp dcsp dcsp text2 insert 7 toggle dcsp butterfly dcsp plot dcsp on off n dcnl dcsp dcsp dcsp if fig selection not in params dcnl dcsp dcsp dcsp dcsp text2 insert 10 reduce dcsp the dcsp number dcsp of dcsp channels dcsp per dcsp view n dcnl dcsp dcsp dcsp dcsp text2 insert 11 increase dcsp the dcsp number dcsp of dcsp channels dcsp per dcsp view n dcnl dcsp dcsp dcsp text2 append mark dcsp bad dcsp channel n dcnl dcsp dcsp dcsp text2 append vertical dcsp line dcsp at dcsp a dcsp time dcsp instant n dcnl dcsp dcsp dcsp text2 append mark dcsp bad dcsp channel n dcnl dcsp elif epochs in params dcnl dcsp dcsp text append u right dcsp click dcsp n dcnl dcsp dcsp text2 insert 4 reduce dcsp the dcsp number dcsp of dcsp epochs dcsp per dcsp view n dcnl dcsp dcsp text2 insert 5 increase dcsp the dcsp number dcsp of dcsp epochs dcsp per dcsp view n dcnl dcsp dcsp if ica in params dcnl dcsp dcsp dcsp text append u click dcsp component dcsp name dcsp n dcnl dcsp dcsp dcsp text2 insert 2 navigate dcsp components dcsp down n dcnl dcsp dcsp dcsp text2 insert 3 navigate dcsp components dcsp up n dcnl dcsp dcsp dcsp text2 insert 8 reduce dcsp the dcsp number dcsp of dcsp components dcsp per dcsp view n dcnl dcsp dcsp dcsp text2 insert 9 increase dcsp the dcsp number dcsp of dcsp components dcsp per dcsp view n dcnl dcsp dcsp dcsp text2 append mark dcsp component dcsp for dcsp exclusion n dcnl dcsp dcsp dcsp text2 append vertical dcsp line dcsp at dcsp a dcsp time dcsp instant n dcnl dcsp dcsp dcsp text2 append show dcsp topography dcsp for dcsp the dcsp component n dcnl dcsp dcsp else dcnl dcsp dcsp dcsp text append u click dcsp channel dcsp name dcsp n dcnl dcsp dcsp dcsp text append u right dcsp click dcsp channel dcsp name dcsp n dcnl dcsp dcsp dcsp text2 insert 2 navigate dcsp channels dcsp down n dcnl dcsp dcsp dcsp text2 insert 3 navigate dcsp channels dcsp up n dcnl dcsp dcsp dcsp text2 insert 8 reduce dcsp the dcsp number dcsp of dcsp channels dcsp per dcsp view n dcnl dcsp dcsp dcsp text2 insert 9 increase dcsp the dcsp number dcsp of dcsp channels dcsp per dcsp view n dcnl dcsp dcsp dcsp text insert 10 u b dcsp dcsp n dcnl dcsp dcsp dcsp text2 insert 10 toggle dcsp butterfly dcsp plot dcsp on off n dcnl dcsp dcsp dcsp text insert 11 u h dcsp dcsp n dcnl dcsp dcsp dcsp text2 insert 11 show dcsp histogram dcsp of dcsp peaktopeak dcsp values n dcnl dcsp dcsp dcsp text2 append mark dcsp bad dcsp epoch n dcnl dcsp dcsp dcsp text2 append vertical dcsp line dcsp at dcsp a dcsp time dcsp instant n dcnl dcsp dcsp dcsp text2 append mark dcsp bad dcsp channel n dcnl dcsp dcsp dcsp text2 append plot dcsp erp erf dcsp image n dcnl dcsp dcsp dcsp text append u middle dcsp click dcsp n dcnl dcsp dcsp dcsp text2 append show dcsp channel dcsp name dcsp butterfly dcsp plot n dcnl dcsp dcsp text insert 11 u o dcsp dcsp n dcnl dcsp dcsp text2 insert 11 view dcsp settings dcsp orig dcsp view dcsp only n dcnl dcsp return join text join text2
def draw proj checkbox event params draw current state true dcsp from matplotlib import widgets dcnl dcsp projs params projs dcnl dcsp labels p desc for p in projs dcnl dcsp actives p active for p in projs if draw current state else params get proj bools params apply proj len projs dcnl dcsp width max 4 0 max len p desc for p in projs 6 0 + 0 5 dcnl dcsp height len projs 6 0 + 1 5 dcnl dcsp fig proj figure nobar figsize width height dcnl dcsp fig proj canvas set window title ssp dcsp projection dcsp vectors dcnl dcsp params fig proj fig proj dcnl dcsp ax temp fig proj add axes 0 0 1 0 8 frameon false dcnl dcsp ax temp set title projectors dcsp marked dcsp with dcsp x dcsp are dcsp active dcnl dcsp proj checks widgets checkbuttons ax temp labels labels actives actives dcnl dcsp rect set edgecolor 0 5 for rect in proj checks rectangles dcnl dcsp rect set linewidth 1 0 for rect in proj checks rectangles dcnl dcsp for ii p in enumerate projs dcnl dcsp dcsp if p active dcnl dcsp dcsp dcsp for x in proj checks linesii dcnl dcsp dcsp dcsp dcsp x set color r dcnl dcsp proj checks on clicked partial toggle proj params params dcnl dcsp params proj checks proj checks dcnl dcsp fig proj canvas mpl connect key press event key press dcnl dcsp try dcnl dcsp dcsp fig proj canvas draw dcnl dcsp dcsp fig proj show warn false dcnl dcsp except exception dcnl dcsp dcsp pass
def layout figure params dcsp size params fig get size inches params fig dpi dcnl dcsp scroll width 25 dcnl dcsp hscroll dist 25 dcnl dcsp vscroll dist 10 dcnl dcsp l border 100 dcnl dcsp r border 10 dcnl dcsp t border 35 dcnl dcsp b border 45 dcnl dcsp if size0 < 2 scroll width or size1 < 2 scroll width + hscroll dist dcnl dcsp dcsp return dcnl dcsp scroll width x scroll width size0 dcnl dcsp scroll width y scroll width size1 dcnl dcsp vscroll dist size0 dcnl dcsp hscroll dist size1 dcnl dcsp l border size0 dcnl dcsp r border size0 dcnl dcsp t border size1 dcnl dcsp b border size1 dcnl dcsp ax width 1 0 scroll width x l border r border vscroll dist dcnl dcsp ax y hscroll dist + scroll width y + b border dcnl dcsp ax height 1 0 ax y t border dcnl dcsp pos l border ax y ax width ax height dcnl dcsp params ax set position pos dcnl dcsp if ax2 in params dcnl dcsp dcsp params ax2 set position pos dcnl dcsp params ax set position pos dcnl dcsp pos ax width + l border + vscroll dist ax y scroll width x ax height dcnl dcsp params ax vscroll set position pos dcnl dcsp pos l border b border ax width scroll width y dcnl dcsp params ax hscroll set position pos dcnl dcsp if ax button in params dcnl dcsp dcsp pos l border + ax width + vscroll dist b border scroll width x scroll width y dcnl dcsp dcsp params ax button set position pos dcnl dcsp if ax help button in params dcnl dcsp dcsp pos l border vscroll dist scroll width x 2 b border scroll width x 2 scroll width y dcnl dcsp dcsp params ax help button set position pos dcnl dcsp params fig canvas draw
verbose dcnl def compare fiff fname 1 fname 2 fname out none show true indent dcsp dcsp dcsp dcsp read limit np inf max str 30 verbose none dcsp file 1 show fiff fname 1 output list indent indent read limit read limit max str max str dcnl dcsp file 2 show fiff fname 2 output list indent indent read limit read limit max str max str dcnl dcsp diff difflib htmldiff make file file 1 file 2 fname 1 fname 2 dcnl dcsp if fname out is not none dcnl dcsp dcsp f open fname out wb dcnl dcsp else dcnl dcsp dcsp f tempfile namedtemporaryfile wb delete false suffix html dcnl dcsp dcsp fname out f name dcnl dcsp with f as fid dcnl dcsp dcsp fid write diff encode utf8 dcnl dcsp if show is true dcnl dcsp dcsp webbrowser open new tab fname out dcnl dcsp return fname out
def figure nobar args kwargs dcsp from matplotlib import rcparams pyplot as plt dcnl dcsp old val rcparams toolbar dcnl dcsp try dcnl dcsp dcsp rcparams toolbar none dcnl dcsp dcsp fig plt figure args kwargs dcnl dcsp dcsp cbs list fig canvas callbacks callbacks key press event keys dcnl dcsp dcsp for key in cbs dcnl dcsp dcsp dcsp fig canvas callbacks disconnect key dcnl dcsp finally dcnl dcsp dcsp rcparams toolbar old val dcnl dcsp return fig
def helper raw resize event params dcsp size join str s for s in params fig get size inches dcnl dcsp set config mne browse raw size size set env false dcnl dcsp layout figure params
def plot raw onscroll event params len channels none dcsp if fig selection in params dcnl dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp change channel group event step params dcnl dcsp dcsp return dcnl dcsp if len channels is none dcnl dcsp dcsp len channels len params inds dcnl dcsp orig start params ch start dcnl dcsp if event step < 0 dcnl dcsp dcsp params ch start min params ch start + params n channels len channels params n channels dcnl dcsp else dcnl dcsp dcsp params ch start max params ch start params n channels 0 dcnl dcsp if orig start params ch start dcnl dcsp dcsp channels changed params len channels
def channels changed params len channels dcsp if params ch start + params n channels len channels dcnl dcsp dcsp params ch start len channels params n channels dcnl dcsp if params ch start < 0 dcnl dcsp dcsp params ch start 0 dcnl dcsp params plot fun
def plot raw time value params dcsp info params info dcnl dcsp max times params n times float info sfreq + params first time params duration dcnl dcsp if value max times dcnl dcsp dcsp value params n times float info sfreq + params first time params duration dcnl dcsp if value < params first time dcnl dcsp dcsp value params first time dcnl dcsp if params t start value dcnl dcsp dcsp params t start value dcnl dcsp dcsp params hsel patch set x value
def radio clicked label params dcsp from evoked import rgb dcnl dcsp labels l text for l in params fig selection radio labels dcnl dcsp idx labels index label dcnl dcsp params fig selection radio active idx idx dcnl dcsp channels params selections label dcnl dcsp ax topo params fig selection get axes 1 dcnl dcsp types np array dtype int dcnl dcsp for this type in mag grad eeg seeg ecog hbo hbr dcnl dcsp dcsp if this type in params types dcnl dcsp dcsp dcsp types np concatenate types np where np array params types this type 0 dcnl dcsp colors np zeros len types 4 dcnl dcsp locs3d np array ch loc 3 for ch in params info chs dcnl dcsp x y z locs3d t dcnl dcsp color vals rgb x y z dcnl dcsp for color idx pick in enumerate types dcnl dcsp dcsp if pick in channels dcnl dcsp dcsp dcsp colorscolor idx np append color valspick 1 0 dcnl dcsp ax topo collections0 facecolors colors dcnl dcsp params fig selection canvas draw dcnl dcsp if params butterfly dcnl dcsp dcsp return dcnl dcsp params ax vscroll set visible true dcnl dcsp nchan sum len params selections l for l in labels idx dcnl dcsp params vsel patch set y nchan dcnl dcsp n channels len channels dcnl dcsp params n channels n channels dcnl dcsp params inds channels dcnl dcsp for line in params lines n channels dcnl dcsp dcsp line set xdata dcnl dcsp dcsp line set ydata dcnl dcsp if n channels 0 dcnl dcsp dcsp setup browser offsets params n channels dcnl dcsp params plot fun
def get active radiobutton radio dcsp colors np array np sum circle get facecolor for circle in radio circles dcnl dcsp return np where colors < 4 0 00
def set annotation radio button idx params dcsp radio params fig annotation radio dcnl dcsp for circle in radio circles dcnl dcsp dcsp circle set facecolor white dcnl dcsp radio circlesidx set facecolor cccccc dcnl dcsp annotation radio clicked radio params ax selector
def set radio button idx params dcsp radio params fig selection radio dcnl dcsp radio circlesradio active idx set facecolor 1 0 1 0 1 0 1 0 dcnl dcsp radio circlesidx set facecolor 0 0 0 0 1 0 1 0 dcnl dcsp radio clicked radio labelsidx text params
def change channel group step params dcsp radio params fig selection radio dcnl dcsp idx radio active idx dcnl dcsp if step < 0 dcnl dcsp dcsp if idx < len radio labels 1 dcnl dcsp dcsp dcsp set radio button idx + 1 params dcnl dcsp elif idx 0 dcnl dcsp dcsp set radio button idx 1 params
def handle change selection event params dcsp radio params fig selection radio dcnl dcsp ydata event ydata dcnl dcsp labels label text for label in radio labels dcnl dcsp offset 0 dcnl dcsp for idx label in enumerate labels dcnl dcsp dcsp nchans len params selections label dcnl dcsp dcsp offset + nchans dcnl dcsp dcsp if ydata < offset dcnl dcsp dcsp dcsp set radio button idx params dcnl dcsp dcsp dcsp return
def plot raw onkey event params dcsp import matplotlib pyplot as plt dcnl dcsp if event key params close key dcnl dcsp dcsp plt close params fig dcnl dcsp dcsp if params fig annotation is not none dcnl dcsp dcsp dcsp plt close params fig annotation dcnl dcsp elif event key down dcnl dcsp dcsp if fig selection in params keys dcnl dcsp dcsp dcsp change channel group 1 params dcnl dcsp dcsp dcsp return dcnl dcsp dcsp elif params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params ch start + params n channels dcnl dcsp dcsp channels changed params len params inds dcnl dcsp elif event key up dcnl dcsp dcsp if fig selection in params keys dcnl dcsp dcsp dcsp change channel group 1 params dcnl dcsp dcsp dcsp return dcnl dcsp dcsp elif params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params ch start params n channels dcnl dcsp dcsp channels changed params len params inds dcnl dcsp elif event key right dcnl dcsp dcsp value params t start + params duration dcnl dcsp dcsp plot raw time value params dcnl dcsp dcsp params update fun dcnl dcsp dcsp params plot fun dcnl dcsp elif event key left dcnl dcsp dcsp value params t start params duration dcnl dcsp dcsp plot raw time value params dcnl dcsp dcsp params update fun dcnl dcsp dcsp params plot fun dcnl dcsp elif event key in + dcnl dcsp dcsp params scale factor 1 1 dcnl dcsp dcsp params plot fun dcnl dcsp elif event key dcnl dcsp dcsp params scale factor 1 1 dcnl dcsp dcsp params plot fun dcnl dcsp elif event key pageup and fig selection not in params dcnl dcsp dcsp n channels params n channels + 1 dcnl dcsp dcsp setup browser offsets params n channels dcnl dcsp dcsp channels changed params len params inds dcnl dcsp elif event key pagedown and fig selection not in params dcnl dcsp dcsp n channels params n channels 1 dcnl dcsp dcsp if n channels 0 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp setup browser offsets params n channels dcnl dcsp dcsp if len params lines n channels dcnl dcsp dcsp dcsp params lines n channels set xdata dcnl dcsp dcsp dcsp params lines n channels set ydata dcnl dcsp dcsp channels changed params len params inds dcnl dcsp elif event key home dcnl dcsp dcsp duration params duration 1 0 dcnl dcsp dcsp if duration < 0 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params duration duration dcnl dcsp dcsp params hsel patch set width params duration dcnl dcsp dcsp params update fun dcnl dcsp dcsp params plot fun dcnl dcsp elif event key end dcnl dcsp dcsp duration params duration + 1 0 dcnl dcsp dcsp if duration params raw times 1 dcnl dcsp dcsp dcsp duration params raw times 1 dcnl dcsp dcsp params duration duration dcnl dcsp dcsp params hsel patch set width params duration dcnl dcsp dcsp params update fun dcnl dcsp dcsp params plot fun dcnl dcsp elif event key dcnl dcsp dcsp onclick help event params dcnl dcsp elif event key f11 dcnl dcsp dcsp mng plt get current fig manager dcnl dcsp dcsp mng full screen toggle dcnl dcsp elif event key a dcnl dcsp dcsp if ica in params keys dcnl dcsp dcsp dcsp return dcnl dcsp dcsp if params fig annotation is none dcnl dcsp dcsp dcsp setup annotation fig params dcnl dcsp dcsp else dcnl dcsp dcsp dcsp params fig annotation canvas close event dcnl dcsp elif event key b dcnl dcsp dcsp setup butterfly params
def setup annotation fig params dcsp import matplotlib as mpl dcnl dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib widgets import radiobuttons spanselector button dcnl dcsp if params fig annotation is not none dcnl dcsp dcsp params fig annotation canvas close event dcnl dcsp if params raw annotations is none dcnl dcsp dcsp params raw annotations annotations list list list dcnl dcsp annotations params raw annotations dcnl dcsp labels list set annotations description dcnl dcsp labels np union1d labels params added label dcnl dcsp fig figure nobar figsize 4 5 2 75 + len labels 0 75 dcnl dcsp fig patch set facecolor white dcnl dcsp ax plt subplot2grid len labels + 2 2 0 0 rowspan len labels colspan 2 frameon false dcnl dcsp ax set title labels dcnl dcsp ax set aspect equal dcnl dcsp button ax plt subplot2grid len labels + 2 2 len labels 1 rowspan 1 colspan 1 dcnl dcsp label ax plt subplot2grid len labels + 2 2 len labels 0 rowspan 1 colspan 1 dcnl dcsp plt axis off dcnl dcsp text ax plt subplot2grid len labels + 2 2 len labels + 1 0 rowspan 1 colspan 2 dcnl dcsp text ax text 0 5 0 9 left dcsp click dcsp dcsp drag dcsp dcsp create modify dcsp annotation nright dcsp click dcsp dcsp delete dcsp annotation nletter number dcsp keys dcsp dcsp add dcsp character nbackspace dcsp dcsp delete dcsp character nesc dcsp dcsp close dcsp window exit dcsp annotation dcsp mode va top ha center dcnl dcsp plt axis off dcnl dcsp annotations closed partial annotations closed params params dcnl dcsp fig canvas mpl connect close event annotations closed dcnl dcsp fig canvas set window title annotations dcnl dcsp fig radio radiobuttons ax labels activecolor cccccc dcnl dcsp radius 0 15 dcnl dcsp circles fig radio circles dcnl dcsp for circle label in zip circles fig radio labels dcnl dcsp dcsp circle set edgecolor params segment colors label get text dcnl dcsp dcsp circle set linewidth 4 dcnl dcsp dcsp circle set radius radius len labels dcnl dcsp dcsp label set x circle center0 + radius + 0 1 len labels dcnl dcsp col r if len fig radio circles < 1 else circles0 get edgecolor dcnl dcsp fig canvas mpl connect key press event partial change annotation description params params dcnl dcsp fig button button button ax add dcsp label dcnl dcsp fig label label ax text 0 5 0 5 bad va center ha center dcnl dcsp fig button on clicked partial onclick new label params params dcnl dcsp fig show dcnl dcsp params fig annotation fig dcnl dcsp ax params ax dcnl dcsp cb onselect partial annotate select params params dcnl dcsp selector spanselector ax cb onselect horizontal minspan 0 1 rectprops dict alpha 0 5 facecolor col dcnl dcsp if len labels 0 dcnl dcsp dcsp selector active false dcnl dcsp params ax selector selector dcnl dcsp if looseversion mpl version < looseversion 1 5 dcnl dcsp dcsp warn modifying dcsp existing dcsp annotations dcsp is dcsp not dcsp possible dcsp for dcsp matplotlib dcsp versions dcsp < dcsp 1 4 dcsp upgrade dcsp matplotlib dcnl dcsp dcsp return dcnl dcsp hover callback partial on hover params params dcnl dcsp params hover callback params fig canvas mpl connect motion notify event hover callback dcnl dcsp radio clicked partial annotation radio clicked radio fig radio selector selector dcnl dcsp fig radio on clicked radio clicked
def onclick new label event params dcsp text params fig annotation label get text 1 dcnl dcsp params added label append text dcnl dcsp setup annotation colors params dcnl dcsp setup annotation fig params dcnl dcsp idx label get text for label in params fig annotation radio labels index text dcnl dcsp set annotation radio button idx params
def mouse click event params dcsp if event button not in 1 3 dcnl dcsp dcsp return dcnl dcsp if event button 3 dcnl dcsp dcsp if params fig annotation is none dcnl dcsp dcsp dcsp return dcnl dcsp dcsp raw params raw dcnl dcsp dcsp if np any c contains event 0 for c in params ax collections dcnl dcsp dcsp dcsp xdata event xdata params first time dcnl dcsp dcsp dcsp onset sync onset raw raw annotations onset dcnl dcsp dcsp dcsp ends onset + raw annotations duration dcnl dcsp dcsp dcsp ann idx np where xdata onset xdata < ends 0 dcnl dcsp dcsp dcsp raw annotations delete ann idx dcnl dcsp dcsp remove segment line params dcnl dcsp dcsp plot annotations raw params dcnl dcsp dcsp params plot fun dcnl dcsp dcsp return dcnl dcsp if event inaxes is none dcnl dcsp dcsp if params n channels 100 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp ax params ax dcnl dcsp dcsp ylim ax get ylim dcnl dcsp dcsp pos ax transdata inverted transform event x event y dcnl dcsp dcsp if pos0 params t start or pos1 < 0 or pos1 ylim0 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params label click fun pos dcnl dcsp elif event inaxes params ax vscroll dcnl dcsp dcsp if fig selection in params keys dcnl dcsp dcsp dcsp handle change selection event params dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ch start max int event ydata params n channels 2 0 dcnl dcsp dcsp dcsp if params ch start ch start dcnl dcsp dcsp dcsp dcsp params ch start ch start dcnl dcsp dcsp dcsp dcsp params plot fun dcnl dcsp elif event inaxes params ax hscroll dcnl dcsp dcsp plot raw time event xdata params duration 2 params dcnl dcsp dcsp params update fun dcnl dcsp dcsp params plot fun dcnl dcsp elif event inaxes params ax dcnl dcsp dcsp params pick bads fun event
def handle topomap bads ch name params dcsp for type in mag grad eeg seeg hbo hbr dcnl dcsp dcsp if type in params types dcnl dcsp dcsp dcsp types np where np array params types type 0 dcnl dcsp dcsp dcsp break dcnl dcsp color ind np where np array params info ch names types ch name 0 dcnl dcsp if len color ind 0 dcnl dcsp dcsp sensors params fig selection axes1 collections0 dcnl dcsp dcsp this color sensors edgecolorscolor ind0 dcnl dcsp dcsp if all this color 1 0 0 0 0 0 1 0 dcnl dcsp dcsp dcsp sensors edgecolorscolor ind 0 0 0 0 0 0 1 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp sensors edgecolorscolor ind 1 0 0 0 0 0 1 0 dcnl dcsp dcsp params fig selection canvas draw
def find channel idx ch name params dcsp indices list dcnl dcsp offset 0 dcnl dcsp labels l text for l in params fig selection radio labels dcnl dcsp for label in labels dcnl dcsp dcsp if label custom dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp selection params selections label dcnl dcsp dcsp hits np where np array params raw ch names selection ch name dcnl dcsp dcsp for idx in hits0 dcnl dcsp dcsp dcsp indices append offset + idx dcnl dcsp dcsp offset + len selection dcnl dcsp return indices
def draw vert line xdata params dcsp params ax vertline set data xdata np array params ax get ylim dcnl dcsp params ax hscroll vertline set data xdata np array 0 0 1 0 dcnl dcsp params vertline t set text 0 3f xdata0
def select bads event params bads dcsp if params butterfly dcnl dcsp dcsp draw vert line np array event xdata 2 params dcnl dcsp dcsp return bads dcnl dcsp def f x y dcnl dcsp dcsp return y np mean x x std 2 dcnl dcsp lines event inaxes lines dcnl dcsp for line in lines dcnl dcsp dcsp ydata line get ydata dcnl dcsp dcsp if not isinstance ydata list and not np isnan ydata any dcnl dcsp dcsp dcsp ymin ymax f ydata np subtract f ydata np add dcnl dcsp dcsp dcsp if ymin < event ydata < ymax dcnl dcsp dcsp dcsp dcsp this chan vars line ch name dcnl dcsp dcsp dcsp dcsp if this chan in params info ch names dcnl dcsp dcsp dcsp dcsp dcsp if fig selection in params dcnl dcsp dcsp dcsp dcsp dcsp dcsp ch idx find channel idx this chan params dcnl dcsp dcsp dcsp dcsp dcsp dcsp handle topomap bads this chan params dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp ch idx params ch start + lines index line dcnl dcsp dcsp dcsp dcsp dcsp if this chan not in bads dcnl dcsp dcsp dcsp dcsp dcsp dcsp bads append this chan dcnl dcsp dcsp dcsp dcsp dcsp dcsp color params bad color dcnl dcsp dcsp dcsp dcsp dcsp dcsp line set zorder 1 dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp while this chan in bads dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp bads remove this chan dcnl dcsp dcsp dcsp dcsp dcsp dcsp color vars line def color dcnl dcsp dcsp dcsp dcsp dcsp dcsp line set zorder 0 dcnl dcsp dcsp dcsp dcsp dcsp line set color color dcnl dcsp dcsp dcsp dcsp dcsp for idx in ch idx dcnl dcsp dcsp dcsp dcsp dcsp dcsp params ax vscroll patchesidx set color color dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp draw vert line np array event xdata 2 params dcnl dcsp return bads
def onclick help event params dcsp import matplotlib pyplot as plt dcnl dcsp text text2 get help text params dcnl dcsp width 6 dcnl dcsp height 5 dcnl dcsp fig help figure nobar figsize width height dpi 80 dcnl dcsp fig help canvas set window title help dcnl dcsp params fig help fig help dcnl dcsp ax plt subplot2grid 8 5 0 0 colspan 5 dcnl dcsp ax set title keyboard dcsp shortcuts dcnl dcsp plt axis off dcnl dcsp ax1 plt subplot2grid 8 5 1 0 rowspan 7 colspan 2 dcnl dcsp ax1 set yticklabels list dcnl dcsp plt text 0 99 1 text fontname stixgeneral va top ha right dcnl dcsp plt axis off dcnl dcsp ax2 plt subplot2grid 8 5 1 2 rowspan 7 colspan 3 dcnl dcsp ax2 set yticklabels list dcnl dcsp plt text 0 1 text2 fontname stixgeneral va top dcnl dcsp plt axis off dcnl dcsp fig help canvas mpl connect key press event key press dcnl dcsp tight layout fig fig help dcnl dcsp try dcnl dcsp dcsp fig help canvas draw dcnl dcsp dcsp fig help show warn false dcnl dcsp except exception dcnl dcsp dcsp pass
def key press event dcsp import matplotlib pyplot as plt dcnl dcsp if event key escape dcnl dcsp dcsp plt close event canvas figure
def setup browser offsets params n channels dcsp ylim n channels 2 + 1 0 dcnl dcsp offset ylim0 n channels dcnl dcsp params offsets np arange n channels offset + offset 2 0 dcnl dcsp params n channels n channels dcnl dcsp params ax set yticks params offsets dcnl dcsp params ax set ylim ylim dcnl dcsp params vsel patch set height n channels dcnl dcsp line params ax vertline dcnl dcsp line set data line x np array params ax get ylim
def fake click fig ax point xform ax button 1 kind press dcsp if xform ax dcnl dcsp dcsp x y ax transaxes transform point point dcnl dcsp elif xform data dcnl dcsp dcsp x y ax transdata transform point point dcnl dcsp else dcnl dcsp dcsp raise valueerror unknown dcsp transform dcnl dcsp if kind press dcnl dcsp dcsp func partial fig canvas button press event x x y y button button dcnl dcsp elif kind release dcnl dcsp dcsp func partial fig canvas button release event x x y y button button dcnl dcsp elif kind motion dcnl dcsp dcsp func partial fig canvas motion notify event x x y y dcnl dcsp try dcnl dcsp dcsp func guievent none dcnl dcsp except exception dcnl dcsp dcsp func
def add background image fig im set ratios none dcsp if im is none dcnl dcsp dcsp return none dcnl dcsp if set ratios is not none dcnl dcsp dcsp for ax in fig axes dcnl dcsp dcsp dcsp ax set aspect set ratios dcnl dcsp ax im fig add axes 0 0 1 1 label background dcnl dcsp ax im imshow im aspect auto dcnl dcsp ax im set zorder 1 dcnl dcsp return ax im
def find peaks evoked npeaks dcsp from scipy signal import argrelmax dcnl dcsp gfp evoked data std axis 0 dcnl dcsp order len evoked times 30 dcnl dcsp if order < 1 dcnl dcsp dcsp order 1 dcnl dcsp peaks argrelmax gfp order order axis 0 0 dcnl dcsp if len peaks npeaks dcnl dcsp dcsp max indices np argsort gfppeaks npeaks dcnl dcsp dcsp peaks np sort peaksmax indices dcnl dcsp times evoked timespeaks dcnl dcsp if len times 0 dcnl dcsp dcsp times evoked timesgfp argmax dcnl dcsp return times
def process times inst use times n peaks none few false dcsp if isinstance use times string types dcnl dcsp dcsp if use times interactive dcnl dcsp dcsp dcsp use times n peaks peaks 1 dcnl dcsp dcsp if use times peaks dcnl dcsp dcsp dcsp if n peaks is none dcnl dcsp dcsp dcsp dcsp n peaks min 3 if few else 7 len inst times dcnl dcsp dcsp dcsp use times find peaks inst n peaks dcnl dcsp dcsp elif use times auto dcnl dcsp dcsp dcsp if n peaks is none dcnl dcsp dcsp dcsp dcsp n peaks min 5 if few else 10 len use times dcnl dcsp dcsp dcsp use times np linspace inst times0 inst times 1 n peaks dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror got dcsp an dcsp unrecognized dcsp method dcsp for dcsp times dcsp only dcsp peaks dcsp auto dcsp and dcsp interactive dcsp are dcsp supported dcsp or dcsp directly dcsp passing dcsp numbers dcnl dcsp elif np isscalar use times dcnl dcsp dcsp use times use times dcnl dcsp use times np array use times float dcnl dcsp if use times ndim 1 dcnl dcsp dcsp raise valueerror times dcsp must dcsp be dcsp 1d dcsp got dcsp d dcsp dimensions use times ndim dcnl dcsp if len use times 20 dcnl dcsp dcsp raise runtimeerror too dcsp many dcsp plots dcsp requested dcsp please dcsp pass dcsp fewer dcsp than dcsp 20 dcsp time dcsp instants dcnl dcsp return use times
def plot sensors info kind topomap ch type none title none show names false ch groups none to sphere true axes none block false show true dcsp from evoked import rgb dcnl dcsp if kind not in topomap 3d select dcnl dcsp dcsp raise valueerror kind dcsp must dcsp be dcsp topomap dcsp 3d dcsp or dcsp select dcsp got dcsp s kind dcnl dcsp if not isinstance info info dcnl dcsp dcsp raise typeerror info dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp info dcsp not dcsp s type info dcnl dcsp ch indices channel indices by type info dcnl dcsp allowed types mag grad eeg seeg ecog dcnl dcsp if ch type is none dcnl dcsp dcsp for this type in allowed types dcnl dcsp dcsp dcsp if contains ch type info this type dcnl dcsp dcsp dcsp dcsp ch type this type dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp picks ch indicesch type dcnl dcsp elif ch type all dcnl dcsp dcsp picks list dcnl dcsp dcsp for this type in allowed types dcnl dcsp dcsp dcsp picks + ch indicesthis type dcnl dcsp elif ch type in allowed types dcnl dcsp dcsp picks ch indicesch type dcnl dcsp else dcnl dcsp dcsp raise valueerror ch type dcsp must dcsp be dcsp one dcsp of dcsp s dcsp not dcsp s allowed types ch type dcnl dcsp if len picks 0 dcnl dcsp dcsp raise valueerror could dcsp not dcsp find dcsp any dcsp channels dcsp of dcsp type dcsp s ch type dcnl dcsp pos np asarray ch loc 3 for ch in info chs picks dcnl dcsp ch names np array info ch names picks dcnl dcsp bads idx for idx name in enumerate ch names if name in info bads dcnl dcsp if ch groups is none dcnl dcsp dcsp def colors handle default color dcnl dcsp dcsp colors red if i in bads else def colorschannel type info pick for i pick in enumerate picks dcnl dcsp else dcnl dcsp dcsp if ch groups in position selection dcnl dcsp dcsp dcsp if ch groups position dcnl dcsp dcsp dcsp dcsp ch groups divide to regions info add stim false dcnl dcsp dcsp dcsp dcsp ch groups list ch groups values dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ch groups color vals list list dcnl dcsp dcsp dcsp dcsp for selection in selections + eeg selections dcnl dcsp dcsp dcsp dcsp dcsp channels pick channels info ch names read selection selection info info dcnl dcsp dcsp dcsp dcsp dcsp ch groups append channels dcnl dcsp dcsp dcsp color vals np ones len ch groups 4 dcnl dcsp dcsp dcsp for idx ch group in enumerate ch groups dcnl dcsp dcsp dcsp dcsp color picks np where picks ch 00 for ch in ch group if ch in picks dcnl dcsp dcsp dcsp dcsp if len color picks 0 dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp x y z poscolor picks t dcnl dcsp dcsp dcsp dcsp color np mean rgb x y z axis 0 dcnl dcsp dcsp dcsp dcsp color valsidx 3 color dcnl dcsp dcsp else dcnl dcsp dcsp dcsp import matplotlib pyplot as plt dcnl dcsp dcsp dcsp colors np linspace 0 1 len ch groups dcnl dcsp dcsp dcsp color vals plt cm jet colorsi for i in range len ch groups dcnl dcsp dcsp if not isinstance ch groups np ndarray list dcnl dcsp dcsp dcsp raise valueerror ch groups dcsp must dcsp be dcsp none dcsp position dcsp selection dcsp or dcsp an dcsp array dcsp got dcsp s ch groups dcnl dcsp dcsp colors np zeros len picks 4 dcnl dcsp dcsp for pick idx pick in enumerate picks dcnl dcsp dcsp dcsp for ind value in enumerate ch groups dcnl dcsp dcsp dcsp dcsp if pick in value dcnl dcsp dcsp dcsp dcsp dcsp colorspick idx color valsind dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp if kind in topomap select dcnl dcsp dcsp pos auto topomap coords info picks true to sphere to sphere dcnl dcsp title sensor dcsp positions dcsp s ch type if title is none else title dcnl dcsp fig plot sensors pos colors bads ch names title show names axes show kind select block block to sphere to sphere dcnl dcsp if kind select dcnl dcsp dcsp return fig fig lasso selection dcnl dcsp return fig
def onpick sensor event fig ax pos ch names show names dcsp if event mouseevent key control and fig lasso is not none dcnl dcsp dcsp for ind in event ind dcnl dcsp dcsp dcsp fig lasso select one ind dcnl dcsp dcsp return dcnl dcsp if show names dcnl dcsp dcsp return dcnl dcsp ind event ind0 dcnl dcsp ch name ch namesind dcnl dcsp this pos posind dcnl dcsp ax texts pop 0 dcnl dcsp if len this pos 3 dcnl dcsp dcsp ax text this pos0 this pos1 this pos2 ch name dcnl dcsp else dcnl dcsp dcsp ax text this pos0 this pos1 ch name dcnl dcsp fig canvas draw
def close event event fig dcsp fig lasso disconnect
def plot sensors pos colors bads ch names title show names ax show select block to sphere dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits mplot3d import axes3d dcnl dcsp from topomap import check outlines draw outlines dcnl dcsp edgecolors np repeat black len colors dcnl dcsp edgecolorsbads red dcnl dcsp if ax is none dcnl dcsp dcsp fig plt figure figsize max plt rcparams figure figsize 2 dcnl dcsp dcsp if pos shape1 3 dcnl dcsp dcsp dcsp axes3d fig dcnl dcsp dcsp dcsp ax fig gca projection 3d dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax fig add subplot 111 dcnl dcsp else dcnl dcsp dcsp fig ax get figure dcnl dcsp if pos shape1 3 dcnl dcsp dcsp ax text 0 0 0 zorder 1 dcnl dcsp dcsp ax scatter pos 0 pos 1 pos 2 picker true c colors s 75 edgecolor edgecolors linewidth 2 dcnl dcsp dcsp ax azim 90 dcnl dcsp dcsp ax elev 0 dcnl dcsp dcsp ax xaxis set label text x dcnl dcsp dcsp ax yaxis set label text y dcnl dcsp dcsp ax zaxis set label text z dcnl dcsp else dcnl dcsp dcsp ax text 0 0 zorder 1 dcnl dcsp dcsp ax set xticks yticks aspect equal dcnl dcsp dcsp fig subplots adjust left 0 bottom 0 right 1 top 1 wspace none hspace none dcnl dcsp dcsp if to sphere dcnl dcsp dcsp dcsp pos outlines check outlines pos head dcnl dcsp dcsp else dcnl dcsp dcsp dcsp pos outlines check outlines pos np array 0 5 0 5 center 0 0 scale 4 5 4 5 dcnl dcsp dcsp draw outlines ax outlines dcnl dcsp dcsp pts ax scatter pos 0 pos 1 picker true c colors s 25 edgecolor edgecolors linewidth 2 clip on false dcnl dcsp dcsp if select dcnl dcsp dcsp dcsp fig lasso selectfromcollection ax pts ch names dcnl dcsp dcsp ax axis off dcnl dcsp connect picker true dcnl dcsp if show names dcnl dcsp dcsp if isinstance show names list np ndarray dcnl dcsp dcsp dcsp indices list ch names index name for name in show names dcnl dcsp dcsp else dcnl dcsp dcsp dcsp indices range len pos dcnl dcsp dcsp for idx in indices dcnl dcsp dcsp dcsp this pos posidx dcnl dcsp dcsp dcsp if pos shape1 3 dcnl dcsp dcsp dcsp dcsp ax text this pos0 this pos1 this pos2 ch namesidx dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ax text this pos0 + 0 015 this pos1 ch namesidx dcnl dcsp dcsp connect picker select dcnl dcsp if connect picker dcnl dcsp dcsp picker partial onpick sensor fig fig ax ax pos pos ch names ch names show names show names dcnl dcsp dcsp fig canvas mpl connect pick event picker dcnl dcsp fig suptitle title dcnl dcsp closed partial close event fig fig dcnl dcsp fig canvas mpl connect close event closed dcnl dcsp plt show show block block dcnl dcsp return fig
def compute scalings scalings inst dcsp from io base import baseraw dcnl dcsp from epochs import baseepochs dcnl dcsp if not isinstance inst baseraw baseepochs dcnl dcsp dcsp raise valueerror must dcsp supply dcsp either dcsp raw dcsp or dcsp epochs dcnl dcsp if scalings is none dcnl dcsp dcsp return scalings dcnl dcsp ch types channel indices by type inst info dcnl dcsp ch types dict i type i ixs for i type i ixs in ch types items if len i ixs 0 dcnl dcsp if scalings auto dcnl dcsp dcsp scalings dict i type auto for i type in ch types keys dcnl dcsp if not isinstance scalings dict dcnl dcsp dcsp raise valueerror scalings dcsp must dcsp be dcsp a dcsp dictionary dcsp of dcsp ch type dcsp val dcsp pairs dcsp not dcsp type dcsp s dcsp type scalings dcnl dcsp scalings deepcopy scalings dcnl dcsp if inst preload is false dcnl dcsp dcsp if isinstance inst baseraw dcnl dcsp dcsp dcsp n times 100000000 0 len inst ch names 8 dcnl dcsp dcsp dcsp n times np clip n times 1 inst n times dcnl dcsp dcsp dcsp n secs n times float inst info sfreq dcnl dcsp dcsp dcsp time middle np mean inst times dcnl dcsp dcsp dcsp tmin np clip time middle n secs 2 0 inst times min none dcnl dcsp dcsp dcsp tmax np clip time middle + n secs 2 0 none inst times max dcnl dcsp dcsp dcsp data inst read segment tmin tmax dcnl dcsp dcsp elif isinstance inst baseepochs dcnl dcsp dcsp dcsp n epochs 100000000 0 len inst ch names len inst times 8 dcnl dcsp dcsp dcsp n epochs int np clip n epochs 1 len inst dcnl dcsp dcsp dcsp ixs epochs np random choice range len inst n epochs false dcnl dcsp dcsp dcsp inst inst copy ixs epochs load data dcnl dcsp else dcnl dcsp dcsp data inst data dcnl dcsp if isinstance inst baseepochs dcnl dcsp dcsp data inst data reshape len inst ch names 1 dcnl dcsp for key value in scalings items dcnl dcsp dcsp if value auto dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp if key not in ch types keys dcnl dcsp dcsp dcsp raise valueerror sensor dcsp 0 dcsp doesn t dcsp exist dcsp in dcsp data format key dcnl dcsp dcsp this data datach typeskey dcnl dcsp dcsp scale factor np percentile this data ravel 0 5 99 5 dcnl dcsp dcsp scale factor np max np abs scale factor dcnl dcsp dcsp scalingskey scale factor dcnl dcsp return scalings
def setup cmap cmap n axes 1 norm false dcsp if cmap interactive dcnl dcsp dcsp cmap reds if norm else rdbu r true dcnl dcsp elif not isinstance cmap tuple dcnl dcsp dcsp if cmap is none dcnl dcsp dcsp dcsp cmap reds if norm else rdbu r dcnl dcsp dcsp cmap cmap false if n axes 2 else true dcnl dcsp return cmap
def annotate select vmin vmax params dcsp raw params raw dcnl dcsp onset sync onset raw vmin true params first time dcnl dcsp duration vmax vmin dcnl dcsp active idx get active radiobutton params fig annotation radio dcnl dcsp description params fig annotation radio labelsactive idx get text dcnl dcsp if raw annotations is none dcnl dcsp dcsp annot annotations onset duration description dcnl dcsp dcsp raw annotations annot dcnl dcsp else dcnl dcsp dcsp merge annotations onset onset + duration description raw annotations dcnl dcsp plot annotations params raw params dcnl dcsp params plot fun
def plot annotations raw params dcsp if raw annotations is none dcnl dcsp dcsp return dcnl dcsp while len params ax hscroll collections 0 dcnl dcsp dcsp params ax hscroll collections pop dcnl dcsp segments list dcnl dcsp ann order raw annotations onset argsort axis 0 dcnl dcsp descriptions raw annotations descriptionann order dcnl dcsp setup annotation colors params dcnl dcsp for idx onset in enumerate raw annotations onsetann order dcnl dcsp dcsp annot start sync onset raw onset + params first time dcnl dcsp dcsp annot end annot start + raw annotations durationann orderidx dcnl dcsp dcsp segments append annot start annot end dcnl dcsp dcsp dscr descriptionsidx dcnl dcsp dcsp params ax hscroll fill betweenx 0 0 1 0 annot start annot end alpha 0 3 color params segment colors dscr dcnl dcsp params segments np array segments dcnl dcsp params annot description descriptions
def setup annotation colors params dcsp raw params raw dcnl dcsp segment colors params get segment colors dict dcnl dcsp if raw annotations is not none dcnl dcsp dcsp ann order raw annotations onset argsort axis 0 dcnl dcsp dcsp descriptions raw annotations descriptionann order dcnl dcsp else dcnl dcsp dcsp descriptions list dcnl dcsp color keys np union1d descriptions params added label dcnl dcsp color cycle cycle np delete colors 2 dcnl dcsp for in np intersect1d list color keys list segment colors keys dcnl dcsp dcsp next color cycle dcnl dcsp for idx key in enumerate color keys dcnl dcsp dcsp if key in segment colors dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp elif key lower startswith bad dcnl dcsp dcsp dcsp segment colorskey red dcnl dcsp dcsp else dcnl dcsp dcsp dcsp segment colorskey next color cycle dcnl dcsp params segment colors segment colors
def annotations closed event params dcsp import matplotlib as mpl dcnl dcsp import matplotlib pyplot as plt dcnl dcsp plt close params fig annotation dcnl dcsp params ax selector disconnect events dcnl dcsp params ax selector none dcnl dcsp params fig annotation none dcnl dcsp if params segment line is not none dcnl dcsp dcsp params segment line remove dcnl dcsp dcsp params segment line none dcnl dcsp if looseversion mpl version looseversion 1 5 dcnl dcsp dcsp params fig canvas mpl disconnect params hover callback dcnl dcsp params fig annotation none dcnl dcsp params fig canvas draw
def on hover event params dcsp if event button is not none or event inaxes params ax or event xdata is none dcnl dcsp dcsp return dcnl dcsp for coll in params ax collections dcnl dcsp dcsp if coll contains event 0 dcnl dcsp dcsp dcsp path coll get paths 1 dcnl dcsp dcsp dcsp mn min path vertices 0 dcnl dcsp dcsp dcsp mx max path vertices 0 dcnl dcsp dcsp dcsp x mn if abs event xdata mn < abs event xdata mx else mx dcnl dcsp dcsp dcsp ylim params ax get ylim dcnl dcsp dcsp dcsp if params segment line is none dcnl dcsp dcsp dcsp dcsp modify callback partial annotation modify params params dcnl dcsp dcsp dcsp dcsp line params ax plot x x ylim color r linewidth 3 picker 5 0 0 dcnl dcsp dcsp dcsp dcsp dl draggableline line modify callback dcnl dcsp dcsp dcsp dcsp params segment line dl dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp params segment line set x x dcnl dcsp dcsp dcsp params vertline t set text 3f x dcnl dcsp dcsp dcsp params ax vertline set data 0 np array params ax get ylim dcnl dcsp dcsp dcsp params ax selector active false dcnl dcsp dcsp dcsp params fig canvas draw dcnl dcsp dcsp dcsp return dcnl dcsp remove segment line params
def remove segment line params dcsp if params segment line is not none dcnl dcsp dcsp params segment line remove dcnl dcsp dcsp params segment line none dcnl dcsp dcsp params ax selector active true dcnl dcsp dcsp params vertline t set text
def annotation modify old x new x params dcsp raw params raw dcnl dcsp segment np array np where params segments old x dcnl dcsp if segment shape1 0 dcnl dcsp dcsp return dcnl dcsp annotations params raw annotations dcnl dcsp idx segment00 segment10 dcnl dcsp onset sync onset raw params segments idx00 true dcnl dcsp ann idx np where annotations onset onset params first time 0 dcnl dcsp if idx1 0 dcnl dcsp dcsp onset sync onset raw new x true params first time dcnl dcsp dcsp duration annotations durationann idx + old x new x dcnl dcsp else dcnl dcsp dcsp onset annotations onsetann idx dcnl dcsp dcsp duration sync onset raw new x true onset params first time dcnl dcsp if duration < 0 dcnl dcsp dcsp onset + duration dcnl dcsp dcsp duration 1 0 dcnl dcsp merge annotations onset onset + duration annotations descriptionann idx annotations ann idx dcnl dcsp plot annotations params raw params dcnl dcsp remove segment line params dcnl dcsp params plot fun
def merge annotations start stop description annotations current dcsp ends annotations onset + annotations duration dcnl dcsp idx np intersect1d np where ends start 0 np where annotations onset < stop 0 dcnl dcsp idx np intersect1d idx np where annotations description description 0 dcnl dcsp new idx np setdiff1d idx current dcnl dcsp end max np append annotations onsetnew idx + annotations durationnew idx stop dcnl dcsp onset min np append annotations onsetnew idx start dcnl dcsp duration end onset dcnl dcsp annotations delete idx dcnl dcsp annotations append onset duration description
def change annotation description event params dcsp import matplotlib pyplot as plt dcnl dcsp fig event canvas figure dcnl dcsp text fig label get text dcnl dcsp if event key backspace dcnl dcsp dcsp if len text 1 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp text text 2 dcnl dcsp elif event key escape dcnl dcsp dcsp plt close fig dcnl dcsp dcsp return dcnl dcsp elif event key enter dcnl dcsp dcsp onclick new label event params dcnl dcsp elif len event key 1 or event key dcnl dcsp dcsp return dcnl dcsp else dcnl dcsp dcsp text text 1 + event key dcnl dcsp fig label set text text + dcnl dcsp fig canvas draw
def annotation radio clicked label radio selector dcsp idx get active radiobutton radio dcnl dcsp color radio circlesidx get edgecolor dcnl dcsp selector rect set color color dcnl dcsp selector rectprops update dict facecolor color
def setup butterfly params dcsp from raw import setup browser selection dcnl dcsp if ica in params dcnl dcsp dcsp return dcnl dcsp butterfly not params butterfly dcnl dcsp ax params ax dcnl dcsp params butterfly butterfly dcnl dcsp if butterfly dcnl dcsp dcsp types np array params types params orig inds dcnl dcsp dcsp if params group by in type original dcnl dcsp dcsp dcsp inds params inds dcnl dcsp dcsp dcsp eeg seeg if seeg in types else eeg dcnl dcsp dcsp dcsp labels t for t in grad mag eeg eog ecg if t in types + misc dcnl dcsp dcsp dcsp ticks np arange 5 5 len labels + 1 5 dcnl dcsp dcsp dcsp offs l t for l t in zip labels ticks dcnl dcsp dcsp dcsp params offsets np zeros len params types dcnl dcsp dcsp dcsp for ind in inds dcnl dcsp dcsp dcsp dcsp params offsets ind offs get params types ind 5 len labels dcnl dcsp dcsp dcsp ax set yticks ticks dcnl dcsp dcsp dcsp params ax set ylim 5 len labels + 1 0 dcnl dcsp dcsp dcsp ax set yticklabels labels dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if selections not in params dcnl dcsp dcsp dcsp dcsp params selections setup browser selection params raw position selector false dcnl dcsp dcsp dcsp sels params selections dcnl dcsp dcsp dcsp selections selections1 dcnl dcsp dcsp dcsp if misc in sels and len sels misc 0 dcnl dcsp dcsp dcsp dcsp selections + misc dcnl dcsp dcsp dcsp if params group by selection and eeg in types dcnl dcsp dcsp dcsp dcsp for sel in eeg selections dcnl dcsp dcsp dcsp dcsp dcsp if sel in sels dcnl dcsp dcsp dcsp dcsp dcsp dcsp selections + sel dcnl dcsp dcsp dcsp picks list dcnl dcsp dcsp dcsp for selection in selections dcnl dcsp dcsp dcsp dcsp picks append sels get selection list dcnl dcsp dcsp dcsp labels ax yaxis get ticklabels dcnl dcsp dcsp dcsp for label in labels dcnl dcsp dcsp dcsp dcsp label set visible true dcnl dcsp dcsp dcsp ylim 5 0 len picks 0 0 dcnl dcsp dcsp dcsp ax set ylim ylim dcnl dcsp dcsp dcsp offset ylim0 len picks + 1 dcnl dcsp dcsp dcsp ticks np arange 0 ylim0 offset dcnl dcsp dcsp dcsp ticks ticksx if x < len ticks else 0 for x in range 20 dcnl dcsp dcsp dcsp ax set yticks ticks dcnl dcsp dcsp dcsp offsets np zeros len params types dcnl dcsp dcsp dcsp for group idx group in enumerate picks dcnl dcsp dcsp dcsp dcsp for idx pick in enumerate group dcnl dcsp dcsp dcsp dcsp dcsp offsetspick offset group idx + 1 dcnl dcsp dcsp dcsp params inds params orig inds copy dcnl dcsp dcsp dcsp params offsets offsets dcnl dcsp dcsp dcsp ax set yticklabels + selections color black rotation 45 va top dcnl dcsp else dcnl dcsp dcsp params inds params orig inds copy dcnl dcsp dcsp if fig selection not in params dcnl dcsp dcsp dcsp for idx in np arange params n channels len params lines dcnl dcsp dcsp dcsp dcsp params lines idx set xdata dcnl dcsp dcsp dcsp dcsp params lines idx set ydata dcnl dcsp dcsp setup browser offsets params max params n channels 1 dcnl dcsp dcsp if fig selection in params dcnl dcsp dcsp dcsp radio params fig selection radio dcnl dcsp dcsp dcsp active idx get active radiobutton radio dcnl dcsp dcsp dcsp radio clicked radio labelsactive idx text params dcnl dcsp params ax vscroll set visible not butterfly dcnl dcsp params plot fun
def set ax facecolor ax face color dcsp try dcnl dcsp dcsp ax set facecolor face color dcnl dcsp except attributeerror dcnl dcsp dcsp ax set axis bgcolor face color
def handle decim info decim lowpass dcsp from evoked import check decim dcnl dcsp from utils import ensure int dcnl dcsp if isinstance decim string types and decim auto dcnl dcsp dcsp lp info sfreq if info lowpass is none else info lowpass dcnl dcsp dcsp lp min lp info sfreq if lowpass is none else lowpass dcnl dcsp dcsp info lowpass lp dcnl dcsp dcsp decim max int info sfreq lp 3 + 1e06 1 dcnl dcsp decim ensure int decim decim must be an dcsp int dcsp or dcsp auto dcnl dcsp if decim < 0 dcnl dcsp dcsp raise valueerror decim dcsp must dcsp be dcsp auto dcsp or dcsp a dcsp positive dcsp integer dcsp got dcsp s decim dcnl dcsp decim check decim info decim 0 0 dcnl dcsp data picks pick data channels info exclude dcnl dcsp return decim data picks
def fiducial coords points coord frame none dcsp if coord frame is not none dcnl dcsp dcsp points p for p in points if p coord frame coord frame dcnl dcsp points dict p ident p for p in points if p kind fiff fiffv point cardinal dcnl dcsp if points dcnl dcsp dcsp return np array points i r for i in fiducial order dcnl dcsp else dcnl dcsp dcsp return np array
def plot head positions pos mode traces cmap viridis direction z show true dcsp from chpi import head pos to trans rot t dcnl dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib colors import normalize dcnl dcsp from mpl toolkits mplot3d art3d import line3dcollection dcnl dcsp from mpl toolkits mplot3d import axes3d dcnl dcsp if not isinstance mode string types or mode not in traces field dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp traces dcsp or dcsp field dcsp got dcsp s mode dcnl dcsp trans rot t head pos to trans rot t pos dcnl dcsp use trans np einsum ijk ik ij rot 3 3 transpose 0 2 1 trans 1000 dcnl dcsp use rot rot transpose 0 2 1 dcnl dcsp use quats pos 1 4 dcnl dcsp if cmap viridis and not check version matplotlib 1 5 dcnl dcsp dcsp warn viridis dcsp is dcsp unavailable dcsp on dcsp matplotlib dcsp < dcsp 1 4 dcsp using dcsp ylgnbu r dcnl dcsp dcsp cmap ylgnbu r dcnl dcsp if mode traces dcnl dcsp dcsp fig axes plt subplots 3 2 sharex true dcnl dcsp dcsp labels xyz q 1 q 2 q 3 dcnl dcsp dcsp for ii quat coord in enumerate zip use quats t use trans t dcnl dcsp dcsp dcsp axes ii 0 plot t coord k dcnl dcsp dcsp dcsp axes ii 0 set ylabel labels0ii xlim t0 1 dcnl dcsp dcsp dcsp axes ii 1 plot t quat k dcnl dcsp dcsp dcsp axes ii 1 set ylabel labels1ii xlim t0 1 dcnl dcsp dcsp for ii title in enumerate position dcsp mm rotation dcsp quat dcnl dcsp dcsp dcsp axes 0 ii set title title dcnl dcsp dcsp dcsp axes 1 ii set xlabel time dcsp s dcnl dcsp else dcnl dcsp dcsp if not check version matplotlib 1 4 dcnl dcsp dcsp dcsp raise runtimeerror the dcsp field dcsp mode dcsp requires dcsp matplotlib dcsp version dcsp 1 4+ dcnl dcsp dcsp fig ax plt subplots 1 subplot kw dict projection 3d dcnl dcsp dcsp pts use trans np newaxis dcnl dcsp dcsp segments np concatenate pts 1 pts1 axis 1 dcnl dcsp dcsp norm normalize t0 t 2 dcnl dcsp dcsp lc line3dcollection segments cmap cmap norm norm dcnl dcsp dcsp lc set array t 1 dcnl dcsp dcsp ax add collection lc dcnl dcsp dcsp dir idx dict x 0 y 1 z 2 dcnl dcsp dcsp for d length in zip direction 1 0 0 5 0 25 dcnl dcsp dcsp dcsp use dir use rot dir idxd dcnl dcsp dcsp dcsp array np concatenate t np repeat t 2 dcnl dcsp dcsp dcsp ax quiver use trans 0 use trans 1 use trans 2 use dir 0 use dir 1 use dir 2 norm norm cmap cmap array array pivot tail length length dcnl dcsp dcsp mins use trans min 0 dcnl dcsp dcsp maxs use trans max 0 dcnl dcsp dcsp scale maxs mins max 2 0 dcnl dcsp dcsp xlim ylim zlim maxs + mins np newaxis 2 0 + scale scale dcnl dcsp dcsp ax set xlabel x ylabel y zlabel z xlim xlim ylim ylim zlim zlim aspect equal dcnl dcsp dcsp ax view init 30 45 dcnl dcsp tight layout fig fig dcnl dcsp plt show show dcnl dcsp return fig
def plot evoked field evoked surf maps time none time label t dcsp dcsp 0 0f dcsp ms n jobs 1 dcsp types t for t in eeg grad mag if t in evoked dcnl dcsp time idx none dcnl dcsp if time is none dcnl dcsp dcsp time np mean evoked get peak ch type t 1 for t in types dcnl dcsp if not evoked times0 < time < evoked times 1 dcnl dcsp dcsp raise valueerror time dcsp 0 3f dcsp must dcsp be dcsp inside dcsp evoked times time dcnl dcsp time idx np argmin np abs evoked times time dcnl dcsp types sm kind for sm in surf maps dcnl dcsp mlab import mlab dcnl dcsp alphas 1 0 0 5 dcnl dcsp colors 0 6 0 6 0 6 1 0 1 0 1 0 dcnl dcsp colormap mne analyze colormap format mayavi dcnl dcsp colormap lines np concatenate np tile 0 0 0 0 255 0 255 0 127 1 np tile 0 0 0 0 0 0 255 0 2 1 np tile 255 0 0 0 0 0 255 0 127 1 dcnl dcsp fig mlab figure bgcolor 0 0 0 0 0 0 size 600 600 dcnl dcsp toggle mlab render fig false dcnl dcsp for ii this map in enumerate surf maps dcnl dcsp dcsp surf this map surf dcnl dcsp dcsp map data this map data dcnl dcsp dcsp map type this map kind dcnl dcsp dcsp map ch names this map ch names dcnl dcsp dcsp if map type eeg dcnl dcsp dcsp dcsp pick pick types evoked info meg false eeg true dcnl dcsp dcsp else dcnl dcsp dcsp dcsp pick pick types evoked info meg true eeg false ref meg false dcnl dcsp dcsp ch names evoked ch namesk for k in pick dcnl dcsp dcsp set ch names set ch names dcnl dcsp dcsp set map ch names set map ch names dcnl dcsp dcsp if set ch names set map ch names dcnl dcsp dcsp dcsp message channels dcsp in dcsp map dcsp and dcsp data dcsp do dcsp not dcsp match dcnl dcsp dcsp dcsp diff set map ch names set ch names dcnl dcsp dcsp dcsp if len diff dcnl dcsp dcsp dcsp dcsp message + s dcsp not dcsp in dcsp data dcsp file dcsp list diff dcnl dcsp dcsp dcsp diff set ch names set map ch names dcnl dcsp dcsp dcsp if len diff dcnl dcsp dcsp dcsp dcsp message + s dcsp not dcsp in dcsp map dcsp file list diff dcnl dcsp dcsp dcsp raise runtimeerror dcsp join message dcnl dcsp dcsp data np dot map data evoked data pick time idx dcnl dcsp dcsp vlim np max np abs data dcnl dcsp dcsp alpha alphasii dcnl dcsp dcsp mesh create mesh surf surf fig dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp surface mlab pipeline surface mesh color colorsii opacity alpha figure fig dcnl dcsp dcsp surface actor property backface culling true dcnl dcsp dcsp mesh create mesh surf surf fig scalars data dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp fsurf mlab pipeline surface mesh vmin vlim vmax vlim figure fig dcnl dcsp dcsp fsurf module manager scalar lut manager lut table colormap dcnl dcsp dcsp fsurf actor property backface culling true dcnl dcsp dcsp mesh create mesh surf surf fig scalars data dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp cont mlab pipeline contour surface mesh contours 21 line width 1 0 vmin vlim vmax vlim opacity alpha figure fig dcnl dcsp dcsp cont module manager scalar lut manager lut table colormap lines dcnl dcsp if in time label dcnl dcsp dcsp time label 1000 0 evoked timestime idx dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp mlab text 0 01 0 01 time label width 0 4 figure fig dcnl dcsp dcsp with silencestdout dcnl dcsp dcsp dcsp mlab view 10 60 figure fig dcnl dcsp toggle mlab render fig true dcnl dcsp return fig
def create mesh surf surf fig none scalars none dcsp mlab import mlab dcnl dcsp nn surf nn copy dcnl dcsp norm np sum nn nn axis 1 dcnl dcsp mask norm 0 dcnl dcsp nnmask normmask np newaxis dcnl dcsp x y z surf rr t dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp mesh mlab pipeline triangular mesh source x y z surf tris scalars scalars figure fig dcnl dcsp mesh data point data normals nn dcnl dcsp mesh data cell data normals none dcnl dcsp mesh update dcnl dcsp return mesh
def plot mri contours mri fname surf fnames orientation coronal slices none show true img output false dcsp import matplotlib pyplot as plt dcnl dcsp import nibabel as nib dcnl dcsp if orientation not in coronal axial sagittal dcnl dcsp dcsp raise valueerror orientation dcsp must dcsp be dcsp coronal dcsp axial dcsp or dcsp sagittal dcsp got dcsp s orientation dcnl dcsp nim nib load mri fname dcnl dcsp data nim get data dcnl dcsp try dcnl dcsp dcsp affine nim affine dcnl dcsp except attributeerror dcnl dcsp dcsp affine nim get affine dcnl dcsp n sag n axi n cor data shape dcnl dcsp orientation name2axis dict sagittal 0 axial 1 coronal 2 dcnl dcsp orientation axis orientation name2axisorientation dcnl dcsp if slices is none dcnl dcsp dcsp n slices data shapeorientation axis dcnl dcsp dcsp slices np linspace 0 n slices 12 endpoint false astype np int dcnl dcsp surfs list dcnl dcsp trans linalg inv affine dcnl dcsp trans 3 1 n sag 2 n axi 2 n cor 2 dcnl dcsp for surf fname in surf fnames dcnl dcsp dcsp surf read surface surf fname return dict true 1 dcnl dcsp dcsp surf rr nib affines apply affine trans surf rr dcnl dcsp dcsp surfs append surf dcnl dcsp if img output is none dcnl dcsp dcsp fig axs prepare trellis len slices 4 dcnl dcsp else dcnl dcsp dcsp fig ax plt subplots 1 1 figsize 7 0 7 0 dcnl dcsp dcsp axs ax len slices dcnl dcsp dcsp fig size fig get size inches dcnl dcsp dcsp w h img output0 img output1 dcnl dcsp dcsp w2 fig size0 dcnl dcsp dcsp fig set size inches w2 float w w w2 float w h dcnl dcsp dcsp plt close fig dcnl dcsp inds dict coronal 0 1 2 axial 2 0 1 sagittal 2 1 0 orientation dcnl dcsp outs dcnl dcsp for ax sl in zip axs slices dcnl dcsp dcsp if orientation coronal dcnl dcsp dcsp dcsp dat data sl transpose dcnl dcsp dcsp elif orientation axial dcnl dcsp dcsp dcsp dat data sl dcnl dcsp dcsp elif orientation sagittal dcnl dcsp dcsp dcsp dat datasl dcnl dcsp dcsp if img output is not none dcnl dcsp dcsp dcsp ax clear dcnl dcsp dcsp ax imshow dat cmap plt cm gray dcnl dcsp dcsp ax axis off dcnl dcsp dcsp for surf in surfs dcnl dcsp dcsp dcsp ax tricontour surf rr inds0 surf rr inds1 surf tris surf rr inds2 levels sl colors yellow linewidths 2 0 dcnl dcsp dcsp if img output is not none dcnl dcsp dcsp dcsp ax set xticks dcnl dcsp dcsp dcsp ax set yticks dcnl dcsp dcsp dcsp ax set xlim 0 img output1 dcnl dcsp dcsp dcsp ax set ylim img output0 0 dcnl dcsp dcsp dcsp output bytesio dcnl dcsp dcsp dcsp fig savefig output bbox inches tight pad inches 0 format png dcnl dcsp dcsp dcsp outs append base64 b64encode output getvalue decode ascii dcnl dcsp if show dcnl dcsp dcsp plt subplots adjust left 0 0 bottom 0 0 right 1 0 top 1 0 wspace 0 0 hspace 0 0 dcnl dcsp plt show show dcnl dcsp return fig if img output is none else outs
deprecated this dcsp function dcsp will dcsp be dcsp removed dcsp in dcsp version dcsp 0 16 dcsp use dcsp plot alignment dcsp instead dcnl verbose dcnl def plot trans info trans auto subject none subjects dir none source bem head outer skin coord frame head meg sensors helmet sensors eeg sensors original dig false ref meg false ecog sensors true head none brain none skull false src none mri fiducials false verbose none dcsp from forward import create meg coils dcnl dcsp mlab import mlab dcnl dcsp if meg sensors is false dcnl dcsp dcsp meg sensors helmet dcnl dcsp elif meg sensors is true dcnl dcsp dcsp meg sensors helmet sensors dcnl dcsp if eeg sensors is false dcnl dcsp dcsp eeg sensors dcnl dcsp elif eeg sensors is true dcnl dcsp dcsp eeg sensors original dcnl dcsp if isinstance eeg sensors string types dcnl dcsp dcsp eeg sensors eeg sensors dcnl dcsp if isinstance meg sensors string types dcnl dcsp dcsp meg sensors meg sensors dcnl dcsp for kind var in zip eeg meg eeg sensors meg sensors dcnl dcsp dcsp if not isinstance var list tuple or not all isinstance x string types for x in var dcnl dcsp dcsp dcsp raise typeerror s sensors dcsp must dcsp be dcsp list dcsp or dcsp tuple dcsp of dcsp str dcsp got dcsp s type var dcnl dcsp if not all x in helmet sensors for x in meg sensors dcnl dcsp dcsp raise valueerror meg sensors dcsp must dcsp only dcsp contain dcsp helmet dcsp and dcsp points dcsp got dcsp s meg sensors dcnl dcsp if not all x in original projected for x in eeg sensors dcnl dcsp dcsp raise valueerror eeg sensors dcsp must dcsp only dcsp contain dcsp original dcsp and dcsp projected dcsp got dcsp s eeg sensors dcnl dcsp if not isinstance info info dcnl dcsp dcsp raise typeerror info dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp info dcsp got dcsp s type info dcnl dcsp valid coords head meg mri dcnl dcsp if coord frame not in valid coords dcnl dcsp dcsp raise valueerror coord frame dcsp must dcsp be dcsp one dcsp of dcsp s valid coords dcnl dcsp if src is not none dcnl dcsp dcsp if not isinstance src sourcespaces dcnl dcsp dcsp dcsp raise typeerror src dcsp must dcsp be dcsp none dcsp or dcsp sourcespaces dcsp got dcsp s type src dcnl dcsp dcsp src subject src0 get subject his id none dcnl dcsp dcsp subject src subject if subject is none else subject dcnl dcsp dcsp if src subject is not none and subject src subject dcnl dcsp dcsp dcsp raise valueerror subject dcsp s dcsp did dcsp not dcsp match dcsp the dcsp subject dcsp name dcsp dcsp in dcsp src dcsp s subject src subject dcnl dcsp dcsp src rr np concatenate s rr s inuse astype bool for s in src dcnl dcsp dcsp src nn np concatenate s nn s inuse astype bool for s in src dcnl dcsp else dcnl dcsp dcsp src rr src nn np empty 0 3 dcnl dcsp meg picks pick types info meg true ref meg ref meg dcnl dcsp eeg picks pick types info meg false eeg true ref meg false dcnl dcsp ecog picks pick types info meg false ecog true ref meg false dcnl dcsp if head is none dcnl dcsp dcsp head len ecog picks 0 and subject is not none dcnl dcsp if head and subject is none dcnl dcsp dcsp raise valueerror if dcsp head dcsp is dcsp true dcsp subject dcsp must dcsp be dcsp provided dcnl dcsp if isinstance trans string types dcnl dcsp dcsp if trans auto dcnl dcsp dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dcsp trans find trans subject subjects dir dcnl dcsp dcsp trans read trans trans return all true dcnl dcsp dcsp for trans in trans dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp trans ensure trans trans head mri dcnl dcsp dcsp dcsp except exception as exp dcnl dcsp dcsp dcsp dcsp pass dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise exp dcnl dcsp elif trans is none dcnl dcsp dcsp trans transform head mri dcnl dcsp elif not isinstance trans dict dcnl dcsp dcsp raise typeerror trans dcsp must dcsp be dcsp str dcsp dict dcsp or dcsp none dcnl dcsp head mri t ensure trans trans head mri dcnl dcsp dev head t info dev head t dcnl dcsp del trans dcnl dcsp if coord frame meg dcnl dcsp dcsp head trans invert transform dev head t dcnl dcsp dcsp meg trans transform meg meg dcnl dcsp dcsp mri trans invert transform combine transforms dev head t head mri t meg mri dcnl dcsp elif coord frame mri dcnl dcsp dcsp head trans head mri t dcnl dcsp dcsp meg trans combine transforms dev head t head mri t meg mri dcnl dcsp dcsp mri trans transform mri mri dcnl dcsp else dcnl dcsp dcsp head trans transform head head dcnl dcsp dcsp meg trans info dev head t dcnl dcsp dcsp mri trans invert transform head mri t dcnl dcsp surfs dict dcnl dcsp if head dcnl dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp head surf get head surface subject source source subjects dir subjects dir raise error false dcnl dcsp dcsp if head surf is none dcnl dcsp dcsp dcsp if isinstance source string types dcnl dcsp dcsp dcsp dcsp source source dcnl dcsp dcsp dcsp for this surf in source dcnl dcsp dcsp dcsp dcsp if not this surf endswith outer skin dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp surf fname op join subjects dir subject bem flash s surf this surf dcnl dcsp dcsp dcsp dcsp if not op exists surf fname dcnl dcsp dcsp dcsp dcsp dcsp surf fname op join subjects dir subject bem s surf this surf dcnl dcsp dcsp dcsp dcsp dcsp if not op exists surf fname dcnl dcsp dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp logger info using dcsp s dcsp for dcsp head dcsp surface this surf dcnl dcsp dcsp dcsp dcsp rr tris read surface surf fname dcnl dcsp dcsp dcsp dcsp head surf dict rr rr 1000 0 tris tris ntri len tris np len rr coord frame fiff fiffv coord mri dcnl dcsp dcsp dcsp dcsp complete surface info head surf copy false verbose false dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp if head surf is none dcnl dcsp dcsp dcsp raise ioerror no dcsp head dcsp surface dcsp found dcsp for dcsp subject dcsp s subject dcnl dcsp dcsp surfs head head surf dcnl dcsp if mri fiducials dcnl dcsp dcsp if mri fiducials is true dcnl dcsp dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dcsp if subject is none dcnl dcsp dcsp dcsp dcsp raise valueerror subject dcsp needs dcsp to dcsp be dcsp specified dcsp to dcsp automatically dcsp find dcsp the dcsp fiducials dcsp file dcnl dcsp dcsp dcsp mri fiducials op join subjects dir subject bem subject + fiducials fif dcnl dcsp dcsp if isinstance mri fiducials string types dcnl dcsp dcsp dcsp mri fiducials cf read fiducials mri fiducials dcnl dcsp dcsp dcsp if cf fiff fiffv coord mri dcnl dcsp dcsp dcsp dcsp raise valueerror fiducials dcsp are dcsp not dcsp in dcsp mri dcsp space dcnl dcsp dcsp fid loc fiducial coords mri fiducials fiff fiffv coord mri dcnl dcsp dcsp fid loc apply trans mri trans fid loc dcnl dcsp else dcnl dcsp dcsp fid loc dcnl dcsp if helmet in meg sensors and len meg picks 0 dcnl dcsp dcsp surfs helmet get meg helmet surf info head mri t dcnl dcsp if brain is none dcnl dcsp dcsp if len ecog picks 0 and subject is not none dcnl dcsp dcsp dcsp brain pial dcnl dcsp dcsp else dcnl dcsp dcsp dcsp brain false dcnl dcsp if brain dcnl dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp brain pial if brain is true else brain dcnl dcsp dcsp for hemi in lh rh dcnl dcsp dcsp dcsp fname op join subjects dir subject surf s s hemi brain dcnl dcsp dcsp dcsp rr tris read surface fname dcnl dcsp dcsp dcsp rr 0 001 dcnl dcsp dcsp dcsp surfshemi dict rr rr tris tris ntri len tris np len rr coord frame fiff fiffv coord mri dcnl dcsp dcsp dcsp complete surface info surfshemi copy false verbose false dcnl dcsp if skull is true dcnl dcsp dcsp skull outer skull dcnl dcsp if isinstance skull string types dcnl dcsp dcsp skull skull dcnl dcsp elif not skull dcnl dcsp dcsp skull dcnl dcsp if len skull 0 and not isinstance skull0 dict dcnl dcsp dcsp skull sorted skull dcnl dcsp skull alpha dict dcnl dcsp skull colors dict dcnl dcsp hemi val 0 5 dcnl dcsp if src is none or brain and any s type surf for s in src dcnl dcsp dcsp hemi val 1 0 dcnl dcsp alphas 4 np arange len skull + 1 0 5 4 0 dcnl dcsp for idx this skull in enumerate skull dcnl dcsp dcsp if isinstance this skull dict dcnl dcsp dcsp dcsp from bem import surf name dcnl dcsp dcsp dcsp skull surf this skull dcnl dcsp dcsp dcsp this skull surf nameskull surf id dcnl dcsp dcsp else dcnl dcsp dcsp dcsp skull fname op join subjects dir subject bem flash s surf this skull dcnl dcsp dcsp dcsp if not op exists skull fname dcnl dcsp dcsp dcsp dcsp skull fname op join subjects dir subject bem s surf this skull dcnl dcsp dcsp dcsp if not op exists skull fname dcnl dcsp dcsp dcsp dcsp raise ioerror no dcsp skull dcsp surface dcsp s dcsp found dcsp for dcsp subject dcsp s this skull subject dcnl dcsp dcsp dcsp logger info using dcsp s dcsp for dcsp head dcsp surface skull fname dcnl dcsp dcsp dcsp rr tris read surface skull fname dcnl dcsp dcsp dcsp skull surf dict rr rr 1000 0 tris tris ntri len tris np len rr coord frame fiff fiffv coord mri dcnl dcsp dcsp dcsp complete surface info skull surf copy false verbose false dcnl dcsp dcsp skull alphathis skull alphas idx + 1 dcnl dcsp dcsp skull colorsthis skull 0 95 idx 0 2 0 85 0 95 idx 0 2 dcnl dcsp dcsp surfsthis skull skull surf dcnl dcsp if src is none and brain is false and len skull 0 dcnl dcsp dcsp head alpha 1 0 dcnl dcsp else dcnl dcsp dcsp head alpha alphas0 dcnl dcsp for key in surfs keys dcnl dcsp dcsp surfskey transform surface to surfskey coord frame mri trans dcnl dcsp src rr apply trans mri trans src rr dcnl dcsp src nn apply trans mri trans src nn move false dcnl dcsp meg rrs meg tris list list dcnl dcsp ecog loc list dcnl dcsp hpi loc list dcnl dcsp ext loc list dcnl dcsp car loc list dcnl dcsp eeg loc list dcnl dcsp eegp loc list dcnl dcsp if len eeg sensors 0 dcnl dcsp dcsp eeg loc np array info chs k loc 3 for k in eeg picks dcnl dcsp dcsp if len eeg loc 0 dcnl dcsp dcsp dcsp eeg loc apply trans head trans eeg loc dcnl dcsp dcsp dcsp if projected in eeg sensors dcnl dcsp dcsp dcsp dcsp eegp loc eegp nn project onto surface eeg loc surfs head project rrs true return nn true 2 4 dcnl dcsp dcsp dcsp if original not in eeg sensors dcnl dcsp dcsp dcsp dcsp eeg loc list dcnl dcsp del eeg sensors dcnl dcsp if sensors in meg sensors dcnl dcsp dcsp coil transs loc to coil trans info chs pick loc for pick in meg picks dcnl dcsp dcsp coils create meg coils info chs pick for pick in meg picks acc normal dcnl dcsp dcsp offset 0 dcnl dcsp dcsp for coil coil trans in zip coils coil transs dcnl dcsp dcsp dcsp rrs tris sensor shape coil dcnl dcsp dcsp dcsp rrs apply trans coil trans rrs dcnl dcsp dcsp dcsp meg rrs append rrs dcnl dcsp dcsp dcsp meg tris append tris + offset dcnl dcsp dcsp dcsp offset + len meg rrs 1 dcnl dcsp dcsp if len meg rrs 0 dcnl dcsp dcsp dcsp warn meg dcsp electrodes dcsp not dcsp found dcsp cannot dcsp plot dcsp meg dcsp locations dcnl dcsp dcsp else dcnl dcsp dcsp dcsp meg rrs apply trans meg trans np concatenate meg rrs axis 0 dcnl dcsp dcsp dcsp meg tris np concatenate meg tris axis 0 dcnl dcsp del meg sensors dcnl dcsp if dig dcnl dcsp dcsp if dig fiducials dcnl dcsp dcsp dcsp hpi loc ext loc dcnl dcsp dcsp elif dig is not true dcnl dcsp dcsp dcsp raise valueerror dig dcsp needs dcsp to dcsp be dcsp true dcsp false dcsp or dcsp fiducials dcsp not dcsp s repr dig dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hpi loc np array d r for d in info dig if d kind fiff fiffv point hpi dcnl dcsp dcsp dcsp ext loc np array d r for d in info dig if d kind fiff fiffv point extra dcnl dcsp dcsp car loc fiducial coords info dig dcnl dcsp dcsp if coord frame meg dcnl dcsp dcsp dcsp for loc in hpi loc ext loc car loc dcnl dcsp dcsp dcsp dcsp loc apply trans invert transform info dev head t loc dcnl dcsp dcsp elif coord frame mri dcnl dcsp dcsp dcsp for loc in hpi loc ext loc car loc dcnl dcsp dcsp dcsp dcsp loc apply trans head mri t loc dcnl dcsp dcsp if len car loc len ext loc len hpi loc 0 dcnl dcsp dcsp dcsp warn digitization dcsp points dcsp not dcsp found dcsp cannot dcsp plot dcsp digitization dcnl dcsp del dig dcnl dcsp if len ecog picks 0 and ecog sensors dcnl dcsp dcsp ecog loc np array info chs pick loc 3 for pick in ecog picks dcnl dcsp fig mlab figure bgcolor 0 0 0 0 0 0 size 600 600 dcnl dcsp toggle mlab render fig false dcnl dcsp alphas dict head head alpha helmet 0 5 lh hemi val rh hemi val dcnl dcsp alphas update skull alpha dcnl dcsp colors dict head 0 6 3 helmet 0 0 0 0 0 6 lh 0 5 3 rh 0 5 3 dcnl dcsp colors update skull colors dcnl dcsp for key surf in surfs items dcnl dcsp dcsp mesh create mesh surf surf fig dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp surface mlab pipeline surface mesh color colorskey opacity alphaskey figure fig dcnl dcsp dcsp if key helmet dcnl dcsp dcsp dcsp surface actor property backface culling true dcnl dcsp defaults defaults coreg dcnl dcsp datas eeg loc hpi loc ext loc ecog loc dcnl dcsp colors defaults eeg color defaults hpi color defaults extra color defaults ecog color dcnl dcsp alphas 0 8 0 5 0 25 0 8 dcnl dcsp scales defaults eeg scale defaults hpi scale defaults extra scale defaults ecog scale dcnl dcsp for kind loc in dig car loc mri fid loc dcnl dcsp dcsp if len loc 0 dcnl dcsp dcsp dcsp datas extend loc np newaxis dcnl dcsp dcsp dcsp colors extend defaults lpa color defaults nasion color defaults rpa color dcnl dcsp dcsp dcsp alphas extend 3 defaults kind + fid opacity dcnl dcsp dcsp dcsp scales extend 3 defaults kind + fid scale dcnl dcsp for data color alpha scale in zip datas colors alphas scales dcnl dcsp dcsp if len data 0 dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp points mlab points3d data 0 data 1 data 2 color color scale factor scale opacity alpha figure fig dcnl dcsp dcsp dcsp dcsp points actor property backface culling true dcnl dcsp if len eegp loc 0 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp quiv mlab quiver3d eegp loc 0 eegp loc 1 eegp loc 2 eegp nn 0 eegp nn 1 eegp nn 2 color defaults eegp color mode cylinder scale factor defaults eegp scale opacity 0 6 figure fig dcnl dcsp dcsp quiv glyph glyph source glyph source height defaults eegp height dcnl dcsp dcsp quiv glyph glyph source glyph source center 0 0 defaults eegp height 0 dcnl dcsp dcsp quiv glyph glyph source glyph source resolution 20 dcnl dcsp dcsp quiv actor property backface culling true dcnl dcsp if len meg rrs 0 dcnl dcsp dcsp color alpha 0 0 0 25 0 5 0 25 dcnl dcsp dcsp surf dict rr meg rrs tris meg tris dcnl dcsp dcsp complete surface info surf copy false verbose false dcnl dcsp dcsp mesh create mesh surf surf fig dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp surface mlab pipeline surface mesh color color opacity alpha figure fig dcnl dcsp if len src rr 0 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp quiv mlab quiver3d src rr 0 src rr 1 src rr 2 src nn 0 src nn 1 src nn 2 color 1 0 1 0 0 0 mode cylinder scale factor 0 003 opacity 0 75 figure fig dcnl dcsp dcsp quiv glyph glyph source glyph source height 0 25 dcnl dcsp dcsp quiv glyph glyph source glyph source center 0 0 0 0 0 0 dcnl dcsp dcsp quiv glyph glyph source glyph source resolution 20 dcnl dcsp dcsp quiv actor property backface culling true dcnl dcsp with silencestdout dcnl dcsp dcsp mlab view 90 90 figure fig dcnl dcsp toggle mlab render fig true dcnl dcsp return fig
verbose dcnl def plot alignment info trans none subject none subjects dir none surfaces head coord frame head meg helmet sensors eeg original dig false ecog true src none mri fiducials false bem none verbose none dcsp from forward import create meg coils dcnl dcsp mlab import mlab dcnl dcsp if eeg is false dcnl dcsp dcsp eeg list dcnl dcsp elif eeg is true dcnl dcsp dcsp eeg original dcnl dcsp if meg is true dcnl dcsp dcsp meg helmet sensors ref dcnl dcsp elif meg is false dcnl dcsp dcsp meg list dcnl dcsp elif isinstance meg string types dcnl dcsp dcsp meg meg dcnl dcsp if isinstance eeg string types dcnl dcsp dcsp eeg eeg dcnl dcsp for kind var in zip eeg meg eeg meg dcnl dcsp dcsp if not isinstance var list tuple or not all isinstance x string types for x in var dcnl dcsp dcsp dcsp raise typeerror s dcsp must dcsp be dcsp list dcsp or dcsp tuple dcsp of dcsp str dcsp got dcsp s kind type var dcnl dcsp if not all x in helmet sensors ref for x in meg dcnl dcsp dcsp raise valueerror meg dcsp must dcsp only dcsp contain dcsp helmet dcsp sensors dcsp or dcsp ref dcsp got dcsp s meg dcnl dcsp if not all x in original projected for x in eeg dcnl dcsp dcsp raise valueerror eeg dcsp must dcsp only dcsp contain dcsp original dcsp and dcsp projected dcsp got dcsp s eeg dcnl dcsp if not isinstance info info dcnl dcsp dcsp raise typeerror info dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp info dcsp got dcsp s type info dcnl dcsp is sphere false dcnl dcsp if isinstance bem conductormodel and bem is sphere dcnl dcsp dcsp if len bem layers 4 and len surfaces 1 dcnl dcsp dcsp dcsp raise valueerror the dcsp sphere dcsp conductor dcsp model dcsp must dcsp have dcsp three dcsp layers dcsp for dcsp plotting dcsp skull dcsp and dcsp head dcnl dcsp dcsp is sphere true dcnl dcsp skull list dcnl dcsp if outer skull in surfaces dcnl dcsp dcsp if isinstance bem conductormodel and not bem is sphere dcnl dcsp dcsp dcsp skull append bem find surface bem fiff fiffv bem surf id skull dcnl dcsp dcsp else dcnl dcsp dcsp dcsp skull append outer skull dcnl dcsp if inner skull in surfaces dcnl dcsp dcsp if isinstance bem conductormodel and not bem is sphere dcnl dcsp dcsp dcsp skull append bem find surface bem fiff fiffv bem surf id brain dcnl dcsp dcsp else dcnl dcsp dcsp dcsp skull append inner skull dcnl dcsp surf dict surf dict copy dcnl dcsp surf dict outer skin fiff fiffv bem surf id head dcnl dcsp if len skull 0 and not isinstance skull0 dict dcnl dcsp dcsp skull sorted skull dcnl dcsp dcsp if bem is not none and not isinstance bem conductormodel dcnl dcsp dcsp dcsp for idx surf name in enumerate skull dcnl dcsp dcsp dcsp dcsp for this surf in bem dcnl dcsp dcsp dcsp dcsp dcsp if this surf id surf dictsurf name dcnl dcsp dcsp dcsp dcsp dcsp dcsp skullidx this surf dcnl dcsp dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp the dcsp surface dcsp for dcsp s surf name dcnl dcsp valid coords head meg mri dcnl dcsp if coord frame not in valid coords dcnl dcsp dcsp raise valueerror coord frame dcsp must dcsp be dcsp one dcsp of dcsp s valid coords dcnl dcsp if src is not none dcnl dcsp dcsp if not isinstance src sourcespaces dcnl dcsp dcsp dcsp raise typeerror src dcsp must dcsp be dcsp none dcsp or dcsp sourcespaces dcsp got dcsp s type src dcnl dcsp dcsp src subject src0 get subject his id none dcnl dcsp dcsp subject src subject if subject is none else subject dcnl dcsp dcsp if src subject is not none and subject src subject dcnl dcsp dcsp dcsp raise valueerror subject dcsp s dcsp did dcsp not dcsp match dcsp the dcsp subject dcsp name dcsp dcsp in dcsp src dcsp s subject src subject dcnl dcsp dcsp src rr np concatenate s rr s inuse astype bool for s in src dcnl dcsp dcsp src nn np concatenate s nn s inuse astype bool for s in src dcnl dcsp else dcnl dcsp dcsp src rr src nn np empty 0 3 dcnl dcsp ref meg ref in meg dcnl dcsp meg picks pick types info meg true ref meg ref meg dcnl dcsp eeg picks pick types info meg false eeg true ref meg false dcnl dcsp ecog picks pick types info meg false ecog true ref meg false dcnl dcsp if isinstance trans string types dcnl dcsp dcsp if trans auto dcnl dcsp dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dcsp trans find trans subject subjects dir dcnl dcsp dcsp trans read trans trans return all true dcnl dcsp dcsp for trans in trans dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp trans ensure trans trans head mri dcnl dcsp dcsp dcsp except exception as exp dcnl dcsp dcsp dcsp dcsp pass dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise exp dcnl dcsp elif trans is none dcnl dcsp dcsp trans transform head mri dcnl dcsp elif not isinstance trans dict dcnl dcsp dcsp raise typeerror trans dcsp must dcsp be dcsp str dcsp dict dcsp or dcsp none dcnl dcsp head mri t ensure trans trans head mri dcnl dcsp dev head t info dev head t dcnl dcsp del trans dcnl dcsp if coord frame meg dcnl dcsp dcsp head trans invert transform dev head t dcnl dcsp dcsp meg trans transform meg meg dcnl dcsp dcsp mri trans invert transform combine transforms dev head t head mri t meg mri dcnl dcsp elif coord frame mri dcnl dcsp dcsp head trans head mri t dcnl dcsp dcsp meg trans combine transforms dev head t head mri t meg mri dcnl dcsp dcsp mri trans transform mri mri dcnl dcsp else dcnl dcsp dcsp head trans transform head head dcnl dcsp dcsp meg trans info dev head t dcnl dcsp dcsp mri trans invert transform head mri t dcnl dcsp surfs dict dcnl dcsp head any outer skin in surfaces head in surfaces dcnl dcsp if head dcnl dcsp dcsp head surf none dcnl dcsp dcsp if bem is not none dcnl dcsp dcsp dcsp if isinstance bem conductormodel dcnl dcsp dcsp dcsp dcsp if is sphere dcnl dcsp dcsp dcsp dcsp dcsp head surf complete sphere surf bem 3 4 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp head surf bem find surface bem fiff fiffv bem surf id head dcnl dcsp dcsp dcsp dcsp dcsp complete surface info head surf copy false verbose false dcnl dcsp dcsp dcsp elif bem is not none dcnl dcsp dcsp dcsp dcsp for this surf in bem dcnl dcsp dcsp dcsp dcsp dcsp if this surf id fiff fiffv bem surf id head dcnl dcsp dcsp dcsp dcsp dcsp dcsp head surf this surf dcnl dcsp dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp the dcsp surface dcsp for dcsp head dcnl dcsp dcsp if head surf is none dcnl dcsp dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dcsp surf fname op join subjects dir subject bem flash outer skin surf dcnl dcsp dcsp dcsp if not op exists surf fname dcnl dcsp dcsp dcsp dcsp surf fname op join subjects dir subject bem outer skin surf dcnl dcsp dcsp dcsp dcsp if not op exists surf fname dcnl dcsp dcsp dcsp dcsp dcsp raise ioerror no dcsp head dcsp surface dcsp found dcsp for dcsp subject dcsp s subject dcnl dcsp dcsp dcsp logger info using dcsp outer skin dcsp for dcsp head dcsp surface dcnl dcsp dcsp dcsp rr tris read surface surf fname dcnl dcsp dcsp dcsp head surf dict rr rr 1000 0 tris tris ntri len tris np len rr coord frame fiff fiffv coord mri dcnl dcsp dcsp dcsp complete surface info head surf copy false verbose false dcnl dcsp dcsp surfs head head surf dcnl dcsp if mri fiducials dcnl dcsp dcsp if mri fiducials is true dcnl dcsp dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dcsp if subject is none dcnl dcsp dcsp dcsp dcsp raise valueerror subject dcsp needs dcsp to dcsp be dcsp specified dcsp to dcsp automatically dcsp find dcsp the dcsp fiducials dcsp file dcnl dcsp dcsp dcsp mri fiducials op join subjects dir subject bem subject + fiducials fif dcnl dcsp dcsp if isinstance mri fiducials string types dcnl dcsp dcsp dcsp mri fiducials cf read fiducials mri fiducials dcnl dcsp dcsp dcsp if cf fiff fiffv coord mri dcnl dcsp dcsp dcsp dcsp raise valueerror fiducials dcsp are dcsp not dcsp in dcsp mri dcsp space dcnl dcsp dcsp fid loc fiducial coords mri fiducials fiff fiffv coord mri dcnl dcsp dcsp fid loc apply trans mri trans fid loc dcnl dcsp else dcnl dcsp dcsp fid loc dcnl dcsp if helmet in meg and len meg picks 0 dcnl dcsp dcsp surfs helmet get meg helmet surf info head mri t dcnl dcsp brain false dcnl dcsp brain surfs np intersect1d surfaces brain pial white inflated dcnl dcsp if len brain surfs 1 dcnl dcsp dcsp raise valueerror only dcsp one dcsp brain dcsp surface dcsp can dcsp be dcsp plotted dcsp got dcsp s brain surfs dcnl dcsp elif len brain surfs 1 dcnl dcsp dcsp if brain surfs0 brain dcnl dcsp dcsp dcsp brain pial dcnl dcsp dcsp else dcnl dcsp dcsp dcsp brain brain surfs0 dcnl dcsp if brain dcnl dcsp dcsp if is sphere dcnl dcsp dcsp dcsp if len bem layers 0 dcnl dcsp dcsp dcsp dcsp surfs lh complete sphere surf bem 0 4 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp dcsp dcsp for hemi in lh rh dcnl dcsp dcsp dcsp dcsp fname op join subjects dir subject surf s s hemi brain dcnl dcsp dcsp dcsp dcsp rr tris read surface fname dcnl dcsp dcsp dcsp dcsp rr 0 001 dcnl dcsp dcsp dcsp dcsp surfshemi dict rr rr ntri len tris np len rr coord frame fiff fiffv coord mri tris tris dcnl dcsp dcsp dcsp dcsp complete surface info surfshemi copy false verbose false dcnl dcsp skull alpha dict dcnl dcsp skull colors dict dcnl dcsp hemi val 0 5 dcnl dcsp if src is none or brain and any s type surf for s in src dcnl dcsp dcsp hemi val 1 0 dcnl dcsp alphas 4 np arange len skull + 1 0 5 4 0 dcnl dcsp for idx this skull in enumerate skull dcnl dcsp dcsp if isinstance this skull dict dcnl dcsp dcsp dcsp skull surf this skull dcnl dcsp dcsp dcsp this skull surf nameskull surf id dcnl dcsp dcsp elif is sphere dcnl dcsp dcsp dcsp this idx 1 if this skull inner skull else 2 dcnl dcsp dcsp dcsp skull surf complete sphere surf bem this idx 4 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp skull fname op join subjects dir subject bem flash s surf this skull dcnl dcsp dcsp dcsp if not op exists skull fname dcnl dcsp dcsp dcsp dcsp skull fname op join subjects dir subject bem s surf this skull dcnl dcsp dcsp dcsp if not op exists skull fname dcnl dcsp dcsp dcsp dcsp raise ioerror no dcsp skull dcsp surface dcsp s dcsp found dcsp for dcsp subject dcsp s this skull subject dcnl dcsp dcsp dcsp logger info using dcsp s dcsp for dcsp head dcsp surface skull fname dcnl dcsp dcsp dcsp rr tris read surface skull fname dcnl dcsp dcsp dcsp skull surf dict rr rr 1000 0 tris tris ntri len tris np len rr coord frame fiff fiffv coord mri dcnl dcsp dcsp dcsp complete surface info skull surf copy false verbose false dcnl dcsp dcsp skull alphathis skull alphas idx + 1 dcnl dcsp dcsp skull colorsthis skull 0 95 idx 0 2 0 85 0 95 idx 0 2 dcnl dcsp dcsp surfsthis skull skull surf dcnl dcsp if src is none and brain is false and len skull 0 dcnl dcsp dcsp head alpha 1 0 dcnl dcsp else dcnl dcsp dcsp head alpha alphas0 dcnl dcsp for key in surfs keys dcnl dcsp dcsp surfskey transform surface to surfskey coord frame mri trans dcnl dcsp if src is not none dcnl dcsp dcsp if src0 coord frame fiff fiffv coord mri dcnl dcsp dcsp dcsp src rr apply trans mri trans src rr dcnl dcsp dcsp dcsp src nn apply trans mri trans src nn move false dcnl dcsp dcsp elif src0 coord frame fiff fiffv coord head dcnl dcsp dcsp dcsp src rr apply trans head trans src rr dcnl dcsp dcsp dcsp src nn apply trans head trans src nn move false dcnl dcsp meg rrs meg tris list list dcnl dcsp ecog loc list dcnl dcsp hpi loc list dcnl dcsp ext loc list dcnl dcsp car loc list dcnl dcsp eeg loc list dcnl dcsp eegp loc list dcnl dcsp if len eeg 0 dcnl dcsp dcsp eeg loc np array info chs k loc 3 for k in eeg picks dcnl dcsp dcsp if len eeg loc 0 dcnl dcsp dcsp dcsp eeg loc apply trans head trans eeg loc dcnl dcsp dcsp dcsp if projected in eeg dcnl dcsp dcsp dcsp dcsp eegp loc eegp nn project onto surface eeg loc surfs head project rrs true return nn true 2 4 dcnl dcsp dcsp dcsp if original not in eeg dcnl dcsp dcsp dcsp dcsp eeg loc list dcnl dcsp del eeg dcnl dcsp if sensors in meg dcnl dcsp dcsp coil transs loc to coil trans info chs pick loc for pick in meg picks dcnl dcsp dcsp coils create meg coils info chs pick for pick in meg picks acc normal dcnl dcsp dcsp offset 0 dcnl dcsp dcsp for coil coil trans in zip coils coil transs dcnl dcsp dcsp dcsp rrs tris sensor shape coil dcnl dcsp dcsp dcsp rrs apply trans coil trans rrs dcnl dcsp dcsp dcsp meg rrs append rrs dcnl dcsp dcsp dcsp meg tris append tris + offset dcnl dcsp dcsp dcsp offset + len meg rrs 1 dcnl dcsp dcsp if len meg rrs 0 dcnl dcsp dcsp dcsp warn meg dcsp electrodes dcsp not dcsp found dcsp cannot dcsp plot dcsp meg dcsp locations dcnl dcsp dcsp else dcnl dcsp dcsp dcsp meg rrs apply trans meg trans np concatenate meg rrs axis 0 dcnl dcsp dcsp dcsp meg tris np concatenate meg tris axis 0 dcnl dcsp del meg dcnl dcsp if dig dcnl dcsp dcsp if dig fiducials dcnl dcsp dcsp dcsp hpi loc ext loc dcnl dcsp dcsp elif dig is not true dcnl dcsp dcsp dcsp raise valueerror dig dcsp needs dcsp to dcsp be dcsp true dcsp false dcsp or dcsp fiducials dcsp not dcsp s repr dig dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hpi loc np array d r for d in info dig if d kind fiff fiffv point hpi dcnl dcsp dcsp dcsp ext loc np array d r for d in info dig if d kind fiff fiffv point extra dcnl dcsp dcsp car loc fiducial coords info dig dcnl dcsp dcsp if coord frame meg dcnl dcsp dcsp dcsp for loc in hpi loc ext loc car loc dcnl dcsp dcsp dcsp dcsp loc apply trans invert transform info dev head t loc dcnl dcsp dcsp elif coord frame mri dcnl dcsp dcsp dcsp for loc in hpi loc ext loc car loc dcnl dcsp dcsp dcsp dcsp loc apply trans head mri t loc dcnl dcsp dcsp if len car loc len ext loc len hpi loc 0 dcnl dcsp dcsp dcsp warn digitization dcsp points dcsp not dcsp found dcsp cannot dcsp plot dcsp digitization dcnl dcsp del dig dcnl dcsp if len ecog picks 0 and ecog dcnl dcsp dcsp ecog loc np array info chs pick loc 3 for pick in ecog picks dcnl dcsp fig mlab figure bgcolor 0 0 0 0 0 0 size 600 600 dcnl dcsp toggle mlab render fig false dcnl dcsp alphas dict head head alpha helmet 0 5 lh hemi val rh hemi val dcnl dcsp alphas update skull alpha dcnl dcsp colors dict head 0 6 3 helmet 0 0 0 0 0 6 lh 0 5 3 rh 0 5 3 dcnl dcsp colors update skull colors dcnl dcsp for key surf in surfs items dcnl dcsp dcsp mesh create mesh surf surf fig dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp surface mlab pipeline surface mesh color colorskey opacity alphaskey figure fig dcnl dcsp dcsp if key helmet dcnl dcsp dcsp dcsp surface actor property backface culling true dcnl dcsp if brain and lh not in surfs dcnl dcsp dcsp assert bem coord frame fiff fiffv coord head dcnl dcsp dcsp center bem r0 copy dcnl dcsp dcsp center apply trans head trans center dcnl dcsp dcsp mlab points3d scale factor 0 01 color colors lh opacity alphas lh center dcnl dcsp defaults defaults coreg dcnl dcsp datas eeg loc hpi loc ext loc ecog loc dcnl dcsp colors defaults eeg color defaults hpi color defaults extra color defaults ecog color dcnl dcsp alphas 0 8 0 5 0 25 0 8 dcnl dcsp scales defaults eeg scale defaults hpi scale defaults extra scale defaults ecog scale dcnl dcsp for kind loc in dig car loc mri fid loc dcnl dcsp dcsp if len loc 0 dcnl dcsp dcsp dcsp datas extend loc np newaxis dcnl dcsp dcsp dcsp colors extend defaults lpa color defaults nasion color defaults rpa color dcnl dcsp dcsp dcsp alphas extend 3 defaults kind + fid opacity dcnl dcsp dcsp dcsp scales extend 3 defaults kind + fid scale dcnl dcsp for data color alpha scale in zip datas colors alphas scales dcnl dcsp dcsp if len data 0 dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp points mlab points3d data 0 data 1 data 2 color color scale factor scale opacity alpha figure fig dcnl dcsp dcsp dcsp dcsp points actor property backface culling true dcnl dcsp if len eegp loc 0 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp quiv mlab quiver3d eegp loc 0 eegp loc 1 eegp loc 2 eegp nn 0 eegp nn 1 eegp nn 2 color defaults eegp color mode cylinder scale factor defaults eegp scale opacity 0 6 figure fig dcnl dcsp dcsp quiv glyph glyph source glyph source height defaults eegp height dcnl dcsp dcsp quiv glyph glyph source glyph source center 0 0 defaults eegp height 0 dcnl dcsp dcsp quiv glyph glyph source glyph source resolution 20 dcnl dcsp dcsp quiv actor property backface culling true dcnl dcsp if len meg rrs 0 dcnl dcsp dcsp color alpha 0 0 0 25 0 5 0 25 dcnl dcsp dcsp surf dict rr meg rrs tris meg tris dcnl dcsp dcsp complete surface info surf copy false verbose false dcnl dcsp dcsp mesh create mesh surf surf fig dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp surface mlab pipeline surface mesh color color opacity alpha figure fig dcnl dcsp if len src rr 0 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp quiv mlab quiver3d src rr 0 src rr 1 src rr 2 src nn 0 src nn 1 src nn 2 color 1 0 1 0 0 0 mode cylinder scale factor 0 003 opacity 0 75 figure fig dcnl dcsp dcsp quiv glyph glyph source glyph source height 0 25 dcnl dcsp dcsp quiv glyph glyph source glyph source center 0 0 0 0 0 0 dcnl dcsp dcsp quiv glyph glyph source glyph source resolution 20 dcnl dcsp dcsp quiv actor property backface culling true dcnl dcsp with silencestdout dcnl dcsp dcsp mlab view 90 90 figure fig dcnl dcsp toggle mlab render fig true dcnl dcsp return fig
def make tris fan n vert dcsp tris np zeros n vert 2 3 int dcnl dcsp tris 2 np arange 2 n vert dcnl dcsp tris 1 tris 2 1 dcnl dcsp return tris
def sensor shape coil dcsp rrs np empty 0 2 dcnl dcsp tris np empty 0 3 int dcnl dcsp id coil type 65535 dcnl dcsp if id in 2 3012 3013 3011 dcnl dcsp dcsp long side coil size dcnl dcsp dcsp offset 0 0025 dcnl dcsp dcsp rrs np array offset long side 2 0 long side 2 0 long side 2 0 long side 2 0 long side 2 0 offset long side 2 0 offset long side 2 0 long side 2 0 long side 2 0 long side 2 0 long side 2 0 offset long side 2 0 dcnl dcsp dcsp tris np concatenate make tris fan 4 make tris fan 4 + 4 axis 0 dcnl dcsp elif id in 2000 3022 3023 3024 dcnl dcsp dcsp size 0 001 if id 2000 else coil size 2 0 dcnl dcsp dcsp rrs np array 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 size dcnl dcsp dcsp tris make tris fan 4 dcnl dcsp elif id in 4001 4003 5002 7002 7003 fiff fiffv coil artemis123 ref mag dcnl dcsp dcsp n pts 15 dcnl dcsp dcsp circle np exp 2j np pi np arange n pts float n pts dcnl dcsp dcsp circle np concatenate 0 0 circle dcnl dcsp dcsp circle coil size 2 0 dcnl dcsp dcsp rrs np array circle real circle imag t dcnl dcsp dcsp tris make tris fan n pts + 1 dcnl dcsp elif id in 4002 5001 5003 5004 4004 4005 6001 7001 fiff fiffv coil artemis123 grad fiff fiffv coil artemis123 ref grad dcnl dcsp dcsp baseline coil base if id in 5004 4005 else 0 0 dcnl dcsp dcsp n pts 16 dcnl dcsp dcsp circle np exp 2j np pi np arange 1 n pts float n pts 1 dcnl dcsp dcsp circle0 0 dcnl dcsp dcsp circle coil size 2 0 dcnl dcsp dcsp rrs np array np concatenate circle real + baseline 2 0 circle real baseline 2 0 np concatenate circle imag circle imag t dcnl dcsp dcsp tris np concatenate make tris fan n pts + 1 make tris fan n pts + 1 + n pts + 1 dcnl dcsp rrs np pad rrs 0 0 0 1 mode constant dcnl dcsp return rrs tris
def limits to control points clim stc data colormap dcsp if colormap auto dcnl dcsp dcsp if clim auto dcnl dcsp dcsp dcsp colormap mne if stc data < 0 any else hot dcnl dcsp dcsp elif lims in clim dcnl dcsp dcsp dcsp colormap hot dcnl dcsp dcsp else dcnl dcsp dcsp dcsp colormap mne dcnl dcsp if clim auto dcnl dcsp dcsp ctrl pts np percentile np abs stc data 96 97 5 99 95 dcnl dcsp elif isinstance clim dict dcnl dcsp dcsp limit key lims pos lims colormap in mne mne analyze dcnl dcsp dcsp if colormap auto and limit key not in clim keys dcnl dcsp dcsp dcsp raise keyerror pos lims dcsp must dcsp be dcsp used dcsp with dcsp mne dcsp colormap dcnl dcsp dcsp clim kind clim get kind percent dcnl dcsp dcsp if clim kind percent dcnl dcsp dcsp dcsp ctrl pts np percentile np abs stc data list np abs climlimit key dcnl dcsp dcsp elif clim kind value dcnl dcsp dcsp dcsp ctrl pts np array climlimit key dcnl dcsp dcsp dcsp if np diff ctrl pts < 0 any dcnl dcsp dcsp dcsp dcsp raise valueerror value dcsp colormap dcsp limits dcsp must dcsp be dcsp strictly dcsp nondecreasing dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror if dcsp clim dcsp is dcsp a dcsp dict dcsp climkind dcsp must dcsp be dcsp dcsp value dcsp or dcsp percent dcnl dcsp else dcnl dcsp dcsp raise valueerror clim dcsp must dcsp be dcsp auto dcsp or dcsp dict dcnl dcsp if len ctrl pts 3 dcnl dcsp dcsp raise valueerror lims dcsp or dcsp pos lims dcsp is dcsp length dcsp i dcsp it dcsp must dcsp be dcsp length dcsp 3 len ctrl pts dcnl dcsp ctrl pts np array ctrl pts float dcnl dcsp if len set ctrl pts 3 dcnl dcsp dcsp if len set ctrl pts 1 dcnl dcsp dcsp dcsp if ctrl pts0 0 dcnl dcsp dcsp dcsp dcsp warn all dcsp data dcsp were dcsp zero dcnl dcsp dcsp dcsp dcsp ctrl pts np arange 3 dtype float dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ctrl pts 0 0 0 5 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp bump 1e05 if ctrl pts0 ctrl pts1 else 1e05 dcnl dcsp dcsp dcsp ctrl pts1 ctrl pts0 + bump ctrl pts2 ctrl pts0 dcnl dcsp return ctrl pts colormap
def handle time time label time unit times dcsp if time label auto dcnl dcsp dcsp if time unit s dcnl dcsp dcsp dcsp time label time 0 3fs dcnl dcsp dcsp elif time unit ms dcnl dcsp dcsp dcsp time label time 0 1fms dcnl dcsp if time unit s dcnl dcsp dcsp times times dcnl dcsp elif time unit ms dcnl dcsp dcsp times 1000 0 times dcnl dcsp else dcnl dcsp dcsp raise valueerror time unit dcsp needs dcsp to dcsp be dcsp s dcsp or dcsp ms dcsp got dcsp r time unit dcnl dcsp return time label times
def key pressed slider event params dcsp step 1 dcnl dcsp if event key startswith ctrl dcnl dcsp dcsp step 5 dcnl dcsp dcsp event key event key split + 1 dcnl dcsp if event key not in left right dcnl dcsp dcsp return dcnl dcsp time viewer event canvas figure dcnl dcsp value time viewer slider val dcnl dcsp times params stc times dcnl dcsp if params time unit ms dcnl dcsp dcsp times times 1000 0 dcnl dcsp time idx np argmin np abs times value dcnl dcsp if event key left dcnl dcsp dcsp time idx np max 0 time idx step dcnl dcsp elif event key right dcnl dcsp dcsp time idx np min len times 1 time idx + step dcnl dcsp this time timestime idx dcnl dcsp time viewer slider set val this time
def smooth plot this time params dcsp from source estimate import morph buffer dcnl dcsp from mpl toolkits mplot3d import art3d dcnl dcsp ax params ax dcnl dcsp stc params stc dcnl dcsp ax clear dcnl dcsp times stc times dcnl dcsp scaler 1000 0 if params time unit ms else 1 0 dcnl dcsp if this time is none dcnl dcsp dcsp time idx 0 dcnl dcsp else dcnl dcsp dcsp time idx np argmin np abs times this time scaler dcnl dcsp if params hemi idx 0 dcnl dcsp dcsp data stc data len stc vertices0 time idx time idx + 1 dcnl dcsp else dcnl dcsp dcsp data stc datalen stc vertices0 time idx time idx + 1 dcnl dcsp array plot morph buffer data params vertices params e params smoothing steps params n verts params inuse params maps dcnl dcsp vmax np max array plot dcnl dcsp colors array plot vmax dcnl dcsp transp 0 8 dcnl dcsp faces params faces dcnl dcsp greymap params greymap dcnl dcsp cmap params cmap dcnl dcsp polyc ax plot trisurf triangles faces antialiased false params coords t dcnl dcsp color ave np mean colorsfaces axis 1 flatten dcnl dcsp curv ave np mean params curv faces axis 1 flatten dcnl dcsp facecolors art3d polycollection get facecolors polyc dcnl dcsp to blend color ave params ctrl pts 0 vmax dcnl dcsp facecolorsto blend 3 1 transp greymap curv aveto blend 3 + transp cmap color aveto blend 3 dcnl dcsp facecolors ~ to blend 3 greymap curv ave ~ to blend 3 dcnl dcsp ax set title params time label timestime idx scaler color w dcnl dcsp ax set aspect equal dcnl dcsp ax axis off dcnl dcsp ax set xlim 80 80 dcnl dcsp ax set ylim 80 80 dcnl dcsp ax set zlim 80 80 dcnl dcsp ax figure canvas draw
def plot mpl stc stc subject none surface inflated hemi lh colormap auto time label auto smoothing steps 10 subjects dir none views lat clim auto figure none initial time none time unit s background black spacing oct6 time viewer false dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits mplot3d import axes3d dcnl dcsp from matplotlib import cm dcnl dcsp from matplotlib widgets import slider dcnl dcsp import nibabel as nib dcnl dcsp from scipy import sparse stats dcnl dcsp from source estimate import get subject sphere tris dcnl dcsp if hemi not in lh rh dcnl dcsp dcsp raise valueerror hemi dcsp must dcsp be dcsp lh dcsp or dcsp rh dcsp when dcsp using dcsp matplotlib dcsp got dcsp s hemi dcnl dcsp kwargs lat elev 5 azim 0 med elev 5 azim 180 fos elev 5 azim 90 cau elev 5 azim 90 dor elev 90 azim 0 ven elev 90 azim 0 fro elev 5 azim 110 par elev 5 azim 110 dcnl dcsp if views not in kwargs dcnl dcsp dcsp raise valueerror views dcsp must dcsp be dcsp one dcsp of dcsp lat dcsp med dcsp fos dcsp cau dcsp dor dcsp ven dcsp fro dcsp par dcsp got dcsp s views dcnl dcsp ctrl pts colormap limits to control points clim stc data colormap dcnl dcsp if colormap auto dcnl dcsp dcsp colormap mne analyze colormap clim format matplotlib dcnl dcsp time label times handle time time label time unit stc times dcnl dcsp fig plt figure figsize 6 6 if figure is none else figure dcnl dcsp ax axes3d fig dcnl dcsp hemi idx 0 if hemi lh else 1 dcnl dcsp surf op join subjects dir subject surf s s hemi surface dcnl dcsp if spacing all dcnl dcsp dcsp coords faces nib freesurfer read geometry surf dcnl dcsp dcsp inuse slice none dcnl dcsp else dcnl dcsp dcsp stype sval ico surf src type str check spacing spacing dcnl dcsp dcsp surf create surf spacing surf hemi subject stype ico surf subjects dir dcnl dcsp dcsp inuse surf vertno dcnl dcsp dcsp faces surf use tris dcnl dcsp dcsp coords surf rr inuse dcnl dcsp dcsp shape faces shape dcnl dcsp dcsp faces stats rankdata faces dense reshape shape 1 dcnl dcsp del surf dcnl dcsp vertices stc verticeshemi idx dcnl dcsp n verts len vertices dcnl dcsp tris get subject sphere tris subject subjects dir hemi idx dcnl dcsp e mesh edges tris dcnl dcsp e data e data 2 1 dcnl dcsp n vertices e shape0 dcnl dcsp maps sparse identity n vertices tocsr dcnl dcsp e e + sparse eye n vertices n vertices dcnl dcsp cmap cm get cmap colormap dcnl dcsp greymap cm get cmap greys dcnl dcsp curv nib freesurfer read morph data op join subjects dir subject surf s curv hemi inuse dcnl dcsp curv np clip np array curv 0 np int 0 2 0 8 dcnl dcsp params dict ax ax stc stc coords coords faces faces hemi idx hemi idx vertices vertices e e smoothing steps smoothing steps n verts n verts inuse inuse maps maps cmap cmap curv curv ctrl pts ctrl pts greymap greymap time label time label time unit time unit dcnl dcsp smooth plot initial time params dcnl dcsp ax view init kwargsviews dcnl dcsp try dcnl dcsp dcsp ax set facecolor background dcnl dcsp except attributeerror dcnl dcsp dcsp ax set axis bgcolor background dcnl dcsp if time viewer dcnl dcsp dcsp time viewer figure nobar figsize 4 5 0 25 dcnl dcsp dcsp fig time viewer time viewer dcnl dcsp dcsp ax time plt axes dcnl dcsp dcsp if initial time is none dcnl dcsp dcsp dcsp initial time 0 dcnl dcsp dcsp slider slider ax ax time label time valmin times0 valmax times 1 valinit initial time valfmt time label dcnl dcsp dcsp time viewer slider slider dcnl dcsp dcsp callback slider partial smooth plot params params dcnl dcsp dcsp slider on changed callback slider dcnl dcsp dcsp callback key partial key pressed slider params params dcnl dcsp dcsp time viewer canvas mpl connect key press event callback key dcnl dcsp dcsp time viewer subplots adjust left 0 12 bottom 0 05 right 0 75 top 0 95 dcnl dcsp fig subplots adjust left 0 0 bottom 0 0 right 1 0 top 1 0 dcnl dcsp plt show dcnl dcsp return fig
def plot source estimates stc subject none surface inflated hemi lh colormap auto time label auto smoothing steps 10 transparent none alpha 1 0 time viewer false subjects dir none figure none views lat colorbar true clim auto cortex classic size 800 background black foreground white initial time none time unit s backend auto spacing oct6 dcsp from source estimate import sourceestimate dcnl dcsp if not isinstance stc sourceestimate dcnl dcsp dcsp raise valueerror stc dcsp has dcsp to dcsp be dcsp a dcsp surface dcsp source dcsp estimate dcnl dcsp subjects dir get subjects dir subjects dir subjects dir raise error true dcnl dcsp subject check subject stc subject subject true dcnl dcsp if backend not in auto matplotlib mayavi dcnl dcsp dcsp raise valueerror backend dcsp must dcsp be dcsp auto dcsp mayavi dcsp or dcsp matplotlib dcsp got dcsp s backend dcnl dcsp plot mpl backend matplotlib dcnl dcsp if not plot mpl dcnl dcsp dcsp try dcnl dcsp dcsp dcsp import mayavi dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp if backend auto dcnl dcsp dcsp dcsp dcsp warn mayavi dcsp not dcsp found dcsp resorting dcsp to dcsp matplotlib dcsp 3d dcnl dcsp dcsp dcsp dcsp plot mpl true dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise dcnl dcsp if plot mpl dcnl dcsp dcsp return plot mpl stc stc subject subject surface surface hemi hemi colormap colormap time label time label smoothing steps smoothing steps subjects dir subjects dir views views clim clim figure figure initial time initial time time unit time unit background background spacing spacing time viewer time viewer dcnl dcsp import surfer dcnl dcsp from surfer import brain timeviewer dcnl dcsp surfer version looseversion surfer version dcnl dcsp v06 looseversion 0 6 dcnl dcsp if surfer version < v06 dcnl dcsp dcsp raise importerror this dcsp function dcsp requires dcsp pysurfer dcsp 0 6 dcsp you dcsp are dcsp running dcsp version dcsp s dcsp you dcsp can dcsp update dcsp pysurfer dcsp using n n dcsp dcsp dcsp dcsp dcsp pip dcsp install dcsp u dcsp pysurfer surfer version dcnl dcsp if initial time is not none and surfer version v06 dcnl dcsp dcsp kwargs initial time initial time dcnl dcsp dcsp initial time none dcnl dcsp else dcnl dcsp dcsp kwargs dcnl dcsp if hemi not in lh rh split both dcnl dcsp dcsp raise valueerror hemi dcsp has dcsp to dcsp be dcsp either dcsp lh dcsp rh dcsp split dcsp or dcsp both dcnl dcsp if figure is not none dcnl dcsp dcsp if isinstance figure int dcnl dcsp dcsp dcsp size size if isinstance size tuple list else size size dcnl dcsp dcsp dcsp figure mayavi mlab figure figure size size dcnl dcsp dcsp elif not isinstance figure list tuple dcnl dcsp dcsp dcsp figure figure dcnl dcsp dcsp if not all isinstance f mayavi core scene scene for f in figure dcnl dcsp dcsp dcsp raise typeerror figure dcsp must dcsp be dcsp a dcsp mayavi dcsp scene dcsp or dcsp list dcsp of dcsp scenes dcnl dcsp time label times handle time time label time unit stc times dcnl dcsp ctrl pts colormap limits to control points clim stc data colormap dcnl dcsp if colormap in mne mne analyze dcnl dcsp dcsp colormap mne analyze colormap ctrl pts dcnl dcsp dcsp scale pts 1 ctrl pts 1 0 ctrl pts 1 dcnl dcsp dcsp transparent false if transparent is none else transparent dcnl dcsp else dcnl dcsp dcsp scale pts ctrl pts dcnl dcsp dcsp transparent true if transparent is none else transparent dcnl dcsp if hemi in both split dcnl dcsp dcsp hemis lh rh dcnl dcsp else dcnl dcsp dcsp hemis hemi dcnl dcsp title subject if len hemis 1 else s dcsp dcsp s subject hemis0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp brain brain subject hemi hemi surf surface curv true title title cortex cortex size size background background foreground foreground figure figure subjects dir subjects dir views views dcnl dcsp for hemi in hemis dcnl dcsp dcsp hemi idx 0 if hemi lh else 1 dcnl dcsp dcsp if hemi idx 0 dcnl dcsp dcsp dcsp data stc data len stc vertices0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp data stc datalen stc vertices0 dcnl dcsp dcsp vertices stc verticeshemi idx dcnl dcsp dcsp if len data 0 dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp brain add data data colormap colormap vertices vertices smoothing steps smoothing steps time times time label time label alpha alpha hemi hemi colorbar colorbar kwargs dcnl dcsp dcsp brain scale data colormap fmin scale pts0 fmid scale pts1 fmax scale pts2 transparent transparent dcnl dcsp if initial time is not none dcnl dcsp dcsp brain set time initial time dcnl dcsp if time viewer dcnl dcsp dcsp timeviewer brain dcnl dcsp return brain
def plot sparse source estimates src stcs colors none linewidth 2 fontsize 18 bgcolor 0 05 0 0 1 opacity 0 2 brain color 0 7 3 show true high resolution false fig name none fig number none labels none modes cone sphere scale factors 1 0 6 verbose none kwargs dcsp mlab import mlab dcnl dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib colors import colorconverter dcnl dcsp known modes cone sphere dcnl dcsp if not isinstance modes list tuple or not all mode in known modes for mode in modes dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp a dcsp list dcsp containing dcsp only dcsp cone dcsp or dcsp sphere dcnl dcsp if not isinstance stcs list dcnl dcsp dcsp stcs stcs dcnl dcsp if labels is not none and not isinstance labels list dcnl dcsp dcsp labels labels dcnl dcsp if colors is none dcnl dcsp dcsp colors colors dcnl dcsp linestyles dcnl dcsp lh points src0 rr dcnl dcsp rh points src1 rr dcnl dcsp points np r lh points rh points dcnl dcsp lh normals src0 nn dcnl dcsp rh normals src1 nn dcnl dcsp normals np r lh normals rh normals dcnl dcsp if high resolution dcnl dcsp dcsp use lh faces src0 tris dcnl dcsp dcsp use rh faces src1 tris dcnl dcsp else dcnl dcsp dcsp use lh faces src0 use tris dcnl dcsp dcsp use rh faces src1 use tris dcnl dcsp use faces np r use lh faces lh points shape0 + use rh faces dcnl dcsp points 170 dcnl dcsp vertnos np r stc lh vertno lh points shape0 + stc rh vertno for stc in stcs dcnl dcsp unique vertnos np unique np concatenate vertnos ravel dcnl dcsp color converter colorconverter dcnl dcsp f mlab figure figure fig name bgcolor bgcolor size 600 600 dcnl dcsp mlab clf dcnl dcsp toggle mlab render f false dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp surface mlab triangular mesh points 0 points 1 points 2 use faces color brain color opacity opacity kwargs dcnl dcsp surface actor property backface culling true dcnl dcsp fig plt figure fig number dcnl dcsp fig clf dcnl dcsp ax fig add subplot 111 dcnl dcsp colors cycle colors dcnl dcsp logger info total dcsp number dcsp of dcsp active dcsp sources dcsp d len unique vertnos dcnl dcsp if labels is not none dcnl dcsp dcsp colors advance iterator colors for in range np unique np concatenate labels ravel size dcnl dcsp for idx v in enumerate unique vertnos dcnl dcsp dcsp ind k for k vertno in enumerate vertnos if v in vertno dcnl dcsp dcsp is common len ind 1 dcnl dcsp dcsp if labels is none dcnl dcsp dcsp dcsp c advance iterator colors dcnl dcsp dcsp else dcnl dcsp dcsp dcsp c colorslabelsind0 vertnosind0 v dcnl dcsp dcsp mode modes1 if is common else modes0 dcnl dcsp dcsp scale factor scale factors1 if is common else scale factors0 dcnl dcsp dcsp if isinstance scale factor np ndarray list tuple and len unique vertnos len scale factor dcnl dcsp dcsp dcsp scale factor scale factoridx dcnl dcsp dcsp x y z pointsv dcnl dcsp dcsp nx ny nz normalsv dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp mlab quiver3d x y z nx ny nz color color converter to rgb c mode mode scale factor scale factor dcnl dcsp dcsp for k in ind dcnl dcsp dcsp dcsp vertno vertnosk dcnl dcsp dcsp dcsp mask vertno v dcnl dcsp dcsp dcsp assert np sum mask 1 dcnl dcsp dcsp dcsp linestyle linestylesk dcnl dcsp dcsp dcsp ax plot 1000 0 stcsk times 1000000000 0 stcsk datamask ravel c c linewidth linewidth linestyle linestyle dcnl dcsp ax set xlabel time dcsp ms fontsize 18 dcnl dcsp ax set ylabel source dcsp amplitude dcsp nam fontsize 18 dcnl dcsp if fig name is not none dcnl dcsp dcsp ax set title fig name dcnl dcsp plt show show dcnl dcsp surface actor property backface culling true dcnl dcsp surface actor property shading true dcnl dcsp toggle mlab render f true dcnl dcsp return surface
def plot dipole locations dipoles trans subject subjects dir none mode orthoview coord frame mri idx gof show all true ax none block false show true verbose none dcsp if mode orthoview dcnl dcsp dcsp fig plot dipole mri orthoview dipoles trans trans subject subject subjects dir subjects dir coord frame coord frame idx idx show all show all ax ax block block show show dcnl dcsp else dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp orthoview dcsp got dcsp s mode dcnl dcsp return fig
def snapshot brain montage fig montage hide sensors true dcsp mlab import mlab dcnl dcsp from channels import montage digmontage dcnl dcsp from import info dcnl dcsp if isinstance montage montage digmontage dcnl dcsp dcsp chs montage dig ch pos dcnl dcsp dcsp ch names xyz zip ich ixyz for ich ixyz in chs items dcnl dcsp elif isinstance montage info dcnl dcsp dcsp xyz ich loc 3 for ich in montage chs dcnl dcsp dcsp ch names ich ch name for ich in montage chs dcnl dcsp elif isinstance montage dict dcnl dcsp dcsp if not all len ii 3 for ii in montage values dcnl dcsp dcsp dcsp raise valueerror all dcsp electrode dcsp positions dcsp must dcsp be dcsp length dcsp 3 dcnl dcsp dcsp ch names xyz zip ich ixyz for ich ixyz in montage items dcnl dcsp else dcnl dcsp dcsp raise valueerror montage dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp digmontage dcsp info dcsp or dcsp dict dcnl dcsp xyz np vstack xyz dcnl dcsp xy 3d to 2d fig xyz dcnl dcsp xy dict zip ch names xy dcnl dcsp pts fig children 1 dcnl dcsp if hide sensors is true dcnl dcsp dcsp pts visible false dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp im mlab screenshot fig dcnl dcsp pts visible true dcnl dcsp return xy im
def 3d to 2d fig xyz dcsp from mayavi core scene import scene dcnl dcsp if not isinstance fig scene dcnl dcsp dcsp raise typeerror fig dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp scene dcsp found dcsp type dcsp s type fig dcnl dcsp xyz np column stack xyz np ones xyz shape0 dcnl dcsp comb trans mat get world to view matrix fig scene dcnl dcsp view coords np dot comb trans mat xyz t t dcnl dcsp norm view coords view coords view coords 3 reshape 1 1 dcnl dcsp view to disp mat get view to display matrix fig scene dcnl dcsp xy np dot view to disp mat norm view coords t t dcnl dcsp xy xy 2 dcnl dcsp return xy
def get world to view matrix scene dcsp from mayavi core ui mayavi scene import mayaviscene dcnl dcsp from tvtk pyface tvtk scene import tvtkscene dcnl dcsp if not isinstance scene mayaviscene tvtkscene dcnl dcsp dcsp raise typeerror scene dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp tvtkscene mayaviscene dcsp found dcsp type dcsp s type scene dcnl dcsp cam scene camera dcnl dcsp scene size tuple scene get size dcnl dcsp clip range cam clipping range dcnl dcsp aspect ratio float scene size0 scene size1 dcnl dcsp vtk comb trans mat cam get composite projection transform matrix aspect ratio clip range0 clip range1 dcnl dcsp vtk comb trans mat vtk comb trans mat to array dcnl dcsp return vtk comb trans mat
def get view to display matrix scene dcsp from mayavi core ui mayavi scene import mayaviscene dcnl dcsp from tvtk pyface tvtk scene import tvtkscene dcnl dcsp if not isinstance scene mayaviscene tvtkscene dcnl dcsp dcsp raise typeerror scene dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp tvtkscene mayaviscene dcsp found dcsp type dcsp s type scene dcnl dcsp x y tuple scene get size dcnl dcsp view to disp mat np array x 2 0 0 0 0 0 x 2 0 0 0 y 2 0 0 0 y 2 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 dcnl dcsp return view to disp mat
def plot dipole mri orthoview dipole trans subject subjects dir none coord frame head idx gof show all true ax none block false show true dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits mplot3d import axes3d dcnl dcsp from import dipole dcnl dcsp if not has nibabel dcnl dcsp dcsp raise importerror this dcsp function dcsp requires dcsp nibabel dcnl dcsp import nibabel as nib dcnl dcsp from nibabel processing import resample from to dcnl dcsp if coord frame not in head mri dcnl dcsp dcsp raise valueerror coord frame dcsp must dcsp be dcsp head dcsp or dcsp mri dcsp got dcsp s coord frame dcnl dcsp if not isinstance dipole dipole dcnl dcsp dcsp from dipole import concatenate dipoles dcnl dcsp dcsp dipole concatenate dipoles dipole dcnl dcsp if idx gof dcnl dcsp dcsp idx np argmax dipole gof dcnl dcsp elif idx amplitude dcnl dcsp dcsp idx np argmax np abs dipole amplitude dcnl dcsp else dcnl dcsp dcsp idx ensure int idx idx an dcsp int dcsp or dcsp one dcsp of dcsp gof dcsp amplitude dcnl dcsp subjects dir get subjects dir subjects dir subjects dir raise error true dcnl dcsp t1 fname op join subjects dir subject mri t1 mgz dcnl dcsp t1 nib load t1 fname dcnl dcsp vox2ras t1 header get vox2ras tkr dcnl dcsp ras2vox linalg inv vox2ras dcnl dcsp trans get trans trans fro head to mri 0 dcnl dcsp zooms t1 header get zooms dcnl dcsp if coord frame head dcnl dcsp dcsp affine to trans trans copy dcnl dcsp dcsp affine to 3 3 1000 dcnl dcsp dcsp aff t1 affine copy dcnl dcsp dcsp aff 3 3 zooms dcnl dcsp dcsp affine to np dot affine to aff dcnl dcsp dcsp t1 resample from to t1 int t1 shapei zoomsi for i in range 3 affine to dcnl dcsp dcsp dipole locs apply trans ras2vox dipole pos 1000 0 zooms dcnl dcsp dcsp ori dipole ori dcnl dcsp dcsp scatter points dipole pos 1000 0 dcnl dcsp else dcnl dcsp dcsp scatter points apply trans trans trans dipole pos 1000 0 dcnl dcsp dcsp ori apply trans trans trans dipole ori move false dcnl dcsp dcsp dipole locs apply trans ras2vox scatter points dcnl dcsp data t1 get data dcnl dcsp dims len data dcnl dcsp dd dims 2 0 dcnl dcsp dd t1 header get zooms 0 dcnl dcsp if ax is none dcnl dcsp dcsp fig plt figure dcnl dcsp dcsp ax axes3d fig dcnl dcsp elif not isinstance ax axes3d dcnl dcsp dcsp raise valueerror ax dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp axes3d dcsp got dcsp s type ax dcnl dcsp else dcnl dcsp dcsp fig ax get figure dcnl dcsp gridx gridy np meshgrid np linspace dd dd dims np linspace dd dd dims dcnl dcsp plot dipole ax data dipole locs idx dipole gridx gridy ori coord frame zooms show all scatter points dcnl dcsp params ax ax data data idx idx dipole dipole dipole locs dipole locs gridx gridx gridy gridy ori ori coord frame coord frame zooms zooms show all show all scatter points scatter points dcnl dcsp ax view init elev 30 azim 140 dcnl dcsp callback func partial dipole changed params params dcnl dcsp fig canvas mpl connect scroll event callback func dcnl dcsp fig canvas mpl connect key press event callback func dcnl dcsp plt show show block block dcnl dcsp return fig
def plot dipole ax data points idx dipole gridx gridy ori coord frame zooms show all scatter points dcsp import matplotlib pyplot as plt dcnl dcsp point pointsidx dcnl dcsp xidx yidx zidx np round point astype int dcnl dcsp xslice dataxidx 1 dcnl dcsp yslice data yidx 1 t dcnl dcsp zslice data zidx 1 t 1 dcnl dcsp if coord frame head dcnl dcsp dcsp zooms 1 0 1 0 1 0 dcnl dcsp else dcnl dcsp dcsp point pointsidx zooms dcnl dcsp dcsp xidx yidx zidx np round point astype int dcnl dcsp xyz scatter points dcnl dcsp ori oriidx dcnl dcsp if show all dcnl dcsp dcsp colors np repeat y len points dcnl dcsp dcsp colorsidx r dcnl dcsp dcsp size np repeat 5 len points dcnl dcsp dcsp sizeidx 20 dcnl dcsp dcsp visibles range len points dcnl dcsp else dcnl dcsp dcsp colors r dcnl dcsp dcsp size 20 dcnl dcsp dcsp visibles idx dcnl dcsp offset np min gridx dcnl dcsp ax scatter xs xyz visibles 0 ys xyz visibles 1 zs xyz visibles 2 zorder 2 s size facecolor colors dcnl dcsp xx np linspace offset xyz idx 0 xidx dcnl dcsp yy np linspace offset xyz idx 1 yidx dcnl dcsp zz np linspace offset xyz idx 2 zidx dcnl dcsp ax plot xx np repeat xyz idx 1 len xx zs xyz idx 2 zorder 1 linestyle color r dcnl dcsp ax plot np repeat xyz idx 0 len yy yy zs xyz idx 2 zorder 1 linestyle color r dcnl dcsp ax plot np repeat xyz idx 0 len zz np repeat xyz idx 1 len zz zs zz zorder 1 linestyle color r dcnl dcsp ax quiver xyz idx 0 xyz idx 1 xyz idx 2 ori0 ori1 ori2 length 50 pivot tail color r dcnl dcsp dims np array len data 2 0 len data 2 0 dcnl dcsp ax set xlim 1 dims zooms 2 dcnl dcsp ax set ylim 1 dims zooms 2 dcnl dcsp ax set zlim dims zooms 2 dcnl dcsp ax contourf xslice gridx gridy offset offset zdir x cmap gray zorder 0 alpha 0 5 dcnl dcsp ax contourf gridx gridy yslice offset offset zdir z cmap gray zorder 0 alpha 0 5 dcnl dcsp ax contourf gridx zslice gridy offset offset zdir y cmap gray zorder 0 alpha 0 5 dcnl dcsp plt suptitle dipole dcsp s dcsp time dcsp 3fs dcsp gof dcsp 1f dcsp amplitude dcsp 1fnam n idx dipole timesidx dipole gofidx dipole amplitudeidx 1000000000 0 + 0 1f dcsp 0 1f dcsp 0 1f dcsp mm tuple xyzidx dcnl dcsp ax set xlabel x dcnl dcsp ax set ylabel y dcnl dcsp ax set zlabel z dcnl dcsp plt draw
def dipole changed event params dcsp if event key is not none dcnl dcsp dcsp if event key up dcnl dcsp dcsp dcsp params idx + 1 dcnl dcsp dcsp elif event key down dcnl dcsp dcsp dcsp params idx 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return dcnl dcsp elif event step 0 dcnl dcsp dcsp params idx + 1 dcnl dcsp else dcnl dcsp dcsp params idx 1 dcnl dcsp params idx min max 0 params idx len params dipole pos 1 dcnl dcsp params ax clear dcnl dcsp plot dipole params ax params data params dipole locs params idx params dipole params gridx params gridy params ori params coord frame params zooms params show all params scatter points
def circular layout node names node order start pos 90 start between true group boundaries none group sep 10 dcsp n nodes len node names dcnl dcsp if len node order n nodes dcnl dcsp dcsp raise valueerror node order dcsp has dcsp to dcsp be dcsp the dcsp same dcsp length dcsp as dcsp node names dcnl dcsp if group boundaries is not none dcnl dcsp dcsp boundaries np array group boundaries dtype np int dcnl dcsp dcsp if np any boundaries n nodes or np any boundaries < 0 dcnl dcsp dcsp dcsp raise valueerror group boundaries dcsp has dcsp to dcsp be dcsp between dcsp 0 dcsp and dcsp n nodes dcsp dcsp 1 dcnl dcsp dcsp if len boundaries 1 and np any np diff boundaries < 0 dcnl dcsp dcsp dcsp raise valueerror group boundaries dcsp must dcsp have dcsp nondecreasing dcsp values dcnl dcsp dcsp n group sep len group boundaries dcnl dcsp else dcnl dcsp dcsp n group sep 0 dcnl dcsp dcsp boundaries none dcnl dcsp node order node order index name for name in node names dcnl dcsp node order np array node order dcnl dcsp if len np unique node order n nodes dcnl dcsp dcsp raise valueerror node order dcsp has dcsp repeated dcsp entries dcnl dcsp node sep 360 0 n group sep group sep n nodes dcnl dcsp if start between dcnl dcsp dcsp start pos + node sep 2 dcnl dcsp dcsp if boundaries is not none and boundaries0 0 dcnl dcsp dcsp dcsp start pos + group sep 2 dcnl dcsp dcsp dcsp boundaries boundaries1 if n group sep 1 else none dcnl dcsp node angles np ones n nodes dtype np float node sep dcnl dcsp node angles0 start pos dcnl dcsp if boundaries is not none dcnl dcsp dcsp node anglesboundaries + group sep dcnl dcsp node angles np cumsum node angles node order dcnl dcsp return node angles
def plot connectivity circle onpick event fig none axes none indices none n nodes 0 node angles none ylim 9 10 dcsp if event inaxes axes dcnl dcsp dcsp return dcnl dcsp if event button 1 dcnl dcsp dcsp if not ylim0 < event ydata < ylim1 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp node angles node angles np pi 2 dcnl dcsp dcsp node np argmin np abs event xdata node angles dcnl dcsp dcsp patches event inaxes patches dcnl dcsp dcsp for ii x y in enumerate zip indices0 indices1 dcnl dcsp dcsp dcsp patchesii set visible node in x y dcnl dcsp dcsp fig canvas draw dcnl dcsp elif event button 3 dcnl dcsp dcsp patches event inaxes patches dcnl dcsp dcsp for ii in range np size indices axis 1 dcnl dcsp dcsp dcsp patchesii set visible true dcnl dcsp dcsp fig canvas draw
def plot connectivity circle con node names indices none n lines none node angles none node width none node colors none facecolor black textcolor white node edgecolor black linewidth 1 5 colormap hot vmin none vmax none colorbar true title none colorbar size 0 2 colorbar pos 0 3 0 1 fontsize title 12 fontsize names 8 fontsize colorbar 8 padding 6 0 fig none subplot 111 interactive true node linewidth 2 0 show true dcsp import matplotlib pyplot as plt dcnl dcsp import matplotlib path as m path dcnl dcsp import matplotlib patches as m patches dcnl dcsp n nodes len node names dcnl dcsp if node angles is not none dcnl dcsp dcsp if len node angles n nodes dcnl dcsp dcsp dcsp raise valueerror node angles dcsp has dcsp to dcsp be dcsp the dcsp same dcsp length dcsp as dcsp node names dcnl dcsp dcsp node angles node angles np pi 180 dcnl dcsp else dcnl dcsp dcsp node angles np linspace 0 2 np pi n nodes endpoint false dcnl dcsp if node width is none dcnl dcsp dcsp dist mat node anglesnone node angles none dcnl dcsp dcsp dist matnp diag indices n nodes 1000000000 0 dcnl dcsp dcsp node width np min np abs dist mat dcnl dcsp else dcnl dcsp dcsp node width node width np pi 180 dcnl dcsp if node colors is not none dcnl dcsp dcsp if len node colors < n nodes dcnl dcsp dcsp dcsp node colors cycle node colors dcnl dcsp else dcnl dcsp dcsp node colors plt cm spectral i float n nodes for i in range n nodes dcnl dcsp if con ndim 1 dcnl dcsp dcsp if indices is none dcnl dcsp dcsp dcsp raise valueerror indices dcsp has dcsp to dcsp be dcsp provided dcsp if dcsp con ndim dcsp dcsp 1 dcnl dcsp elif con ndim 2 dcnl dcsp dcsp if con shape0 n nodes or con shape1 n nodes dcnl dcsp dcsp dcsp raise valueerror con dcsp has dcsp to dcsp be dcsp 1d dcsp or dcsp a dcsp square dcsp matrix dcnl dcsp dcsp indices np tril indices n nodes 1 dcnl dcsp dcsp con conindices dcnl dcsp else dcnl dcsp dcsp raise valueerror con dcsp has dcsp to dcsp be dcsp 1d dcsp or dcsp a dcsp square dcsp matrix dcnl dcsp if isinstance colormap string types dcnl dcsp dcsp colormap plt get cmap colormap dcnl dcsp if fig is none dcnl dcsp dcsp fig plt figure figsize 8 8 facecolor facecolor dcnl dcsp if not isinstance subplot tuple dcnl dcsp dcsp subplot subplot dcnl dcsp axes plt subplot polar true subplot dcnl dcsp set ax facecolor axes facecolor dcnl dcsp plt xticks dcnl dcsp plt yticks dcnl dcsp plt ylim 0 10 + padding dcnl dcsp axes spines polar set visible false dcnl dcsp if n lines is not none and len con n lines dcnl dcsp dcsp con thresh np sort np abs con ravel n lines dcnl dcsp else dcnl dcsp dcsp con thresh 0 0 dcnl dcsp con abs np abs con dcnl dcsp con draw idx np where con abs con thresh 0 dcnl dcsp con concon draw idx dcnl dcsp con abs con abscon draw idx dcnl dcsp indices indcon draw idx for ind in indices dcnl dcsp sort idx np argsort con abs dcnl dcsp con abs con abssort idx dcnl dcsp con consort idx dcnl dcsp indices indsort idx for ind in indices dcnl dcsp if vmin is none dcnl dcsp dcsp vmin np min con np abs con con thresh dcnl dcsp if vmax is none dcnl dcsp dcsp vmax np max con dcnl dcsp vrange vmax vmin dcnl dcsp nodes n con np zeros n nodes dtype np int dcnl dcsp for i j in zip indices0 indices1 dcnl dcsp dcsp nodes n coni + 1 dcnl dcsp dcsp nodes n conj + 1 dcnl dcsp rng np random mtrand randomstate seed 0 dcnl dcsp n con len indices0 dcnl dcsp noise max 0 25 node width dcnl dcsp start noise rng uniform noise max noise max n con dcnl dcsp end noise rng uniform noise max noise max n con dcnl dcsp nodes n con seen np zeros like nodes n con dcnl dcsp for i start end in enumerate zip indices0 indices1 dcnl dcsp dcsp nodes n con seenstart + 1 dcnl dcsp dcsp nodes n con seenend + 1 dcnl dcsp dcsp start noisei nodes n constart nodes n con seenstart float nodes n constart dcnl dcsp dcsp end noisei nodes n conend nodes n con seenend float nodes n conend dcnl dcsp con val scaled con vmin vrange dcnl dcsp for pos i j in enumerate zip indices0 indices1 dcnl dcsp dcsp t0 r0 node anglesi 10 dcnl dcsp dcsp t1 r1 node anglesj 10 dcnl dcsp dcsp t0 + start noisepos dcnl dcsp dcsp t1 + end noisepos dcnl dcsp dcsp verts t0 r0 t0 5 t1 5 t1 r1 dcnl dcsp dcsp codes m path path moveto m path path curve4 m path path curve4 m path path lineto dcnl dcsp dcsp path m path path verts codes dcnl dcsp dcsp color colormap con val scaledpos dcnl dcsp dcsp patch m patches pathpatch path fill false edgecolor color linewidth linewidth alpha 1 0 dcnl dcsp dcsp axes add patch patch dcnl dcsp height np ones n nodes 1 0 dcnl dcsp bars axes bar node angles height width node width bottom 9 edgecolor node edgecolor lw node linewidth facecolor 9 align center dcnl dcsp for bar color in zip bars node colors dcnl dcsp dcsp bar set facecolor color dcnl dcsp angles deg 180 node angles np pi dcnl dcsp for name angle rad angle deg in zip node names node angles angles deg dcnl dcsp dcsp if angle deg 270 dcnl dcsp dcsp dcsp ha left dcnl dcsp dcsp else dcnl dcsp dcsp dcsp angle deg + 180 dcnl dcsp dcsp dcsp ha right dcnl dcsp dcsp axes text angle rad 10 4 name size fontsize names rotation angle deg rotation mode anchor horizontalalignment ha verticalalignment center color textcolor dcnl dcsp if title is not none dcnl dcsp dcsp plt title title color textcolor fontsize fontsize title axes axes dcnl dcsp if colorbar dcnl dcsp dcsp sm plt cm scalarmappable cmap colormap norm plt normalize vmin vmax dcnl dcsp dcsp sm set array np linspace vmin vmax dcnl dcsp dcsp cb plt colorbar sm ax axes use gridspec false shrink colorbar size anchor colorbar pos dcnl dcsp dcsp cb yticks plt getp cb ax axes yticklabels dcnl dcsp dcsp cb ax tick params labelsize fontsize colorbar dcnl dcsp dcsp plt setp cb yticks color textcolor dcnl dcsp if interactive dcnl dcsp dcsp callback partial plot connectivity circle onpick fig fig axes axes indices indices n nodes n nodes node angles node angles dcnl dcsp dcsp fig canvas mpl connect button press event callback dcnl dcsp plt show show dcnl dcsp return fig axes
def get raw dcsp return read raw fif raw fname preload true
def get events dcsp return read events event fname
requires version scipy 0 16 dcnl def test plot filter dcsp import matplotlib pyplot as plt dcnl dcsp l freq h freq sfreq 2 0 40 0 1000 0 dcnl dcsp data np zeros 5000 dcnl dcsp freq 0 2 40 50 500 dcnl dcsp gain 0 1 1 0 0 dcnl dcsp h create filter data sfreq l freq h freq fir design firwin2 dcnl dcsp plot filter h sfreq dcnl dcsp plt close all dcnl dcsp plot filter h sfreq freq gain dcnl dcsp plt close all dcnl dcsp iir create filter data sfreq l freq h freq method iir dcnl dcsp plot filter iir sfreq dcnl dcsp plt close all dcnl dcsp plot filter iir sfreq freq gain dcnl dcsp plt close all dcnl dcsp iir ba create filter data sfreq l freq h freq method iir iir params dict output ba dcnl dcsp plot filter iir ba sfreq freq gain dcnl dcsp plt close all dcnl dcsp plot filter h sfreq freq gain fscale linear dcnl dcsp plt close all
def test plot cov dcsp raw get raw dcnl dcsp cov read cov cov fname dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp fig1 fig2 cov plot raw info proj true exclude raw ch names6
testing requires testing data dcnl requires nibabel dcnl def test plot bem dcsp assert raises ioerror plot bem subject badsubject subjects dir subjects dir dcnl dcsp assert raises valueerror plot bem subject sample subjects dir subjects dir orientation badori dcnl dcsp plot bem subject sample subjects dir subjects dir orientation sagittal slices 25 50 dcnl dcsp plot bem subject sample subjects dir subjects dir orientation coronal slices 25 50 brain surfaces white dcnl dcsp plot bem subject sample subjects dir subjects dir orientation coronal slices 25 50 src src fname
def test plot events dcsp event labels aud l 1 aud r 2 vis l 3 vis r 4 dcnl dcsp color 1 green 2 yellow 3 red 4 c dcnl dcsp raw get raw dcnl dcsp events get events dcnl dcsp plot events events raw info sfreq raw first samp dcnl dcsp plot events events raw info sfreq raw first samp equal spacing false dcnl dcsp plot events events first samp raw first samp dcnl dcsp warnings simplefilter always userwarning dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp plot events events raw info sfreq raw first samp event id event labels dcnl dcsp dcsp plot events events raw info sfreq raw first samp color color dcnl dcsp dcsp plot events events raw info sfreq raw first samp event id event labels color color dcnl dcsp dcsp assert raises valueerror plot events events raw info sfreq raw first samp event id aud l 1 color color dcnl dcsp dcsp assert raises valueerror plot events events raw info sfreq raw first samp event id aud l 111 color color
testing requires testing data dcnl def test plot source spectrogram dcsp sample src read source spaces op join subjects dir sample bem sampleoct6src fif dcnl dcsp vertices s vertno for s in sample src dcnl dcsp n times 5 dcnl dcsp n verts sum len v for v in vertices dcnl dcsp stc data np ones n verts n times dcnl dcsp stc sourceestimate stc data vertices 1 1 dcnl dcsp plot source spectrogram stc stc 1 2 3 4 dcnl dcsp assert raises valueerror plot source spectrogram dcnl dcsp assert raises valueerror plot source spectrogram stc stc 1 2 3 4 tmin 0 dcnl dcsp assert raises valueerror plot source spectrogram stc stc 1 2 3 4 tmax 7
slow test dcnl testing requires testing data dcnl def test plot snr dcsp inv read inverse operator inv fname dcnl dcsp evoked read evokeds evoked fname baseline none 0 0 dcnl dcsp plot snr estimate evoked inv
testing requires testing data dcnl def test plot dipole amplitudes dcsp dipoles read dipole dip fname dcnl dcsp dipoles plot amplitudes show false
def get raw preload false dcsp return read raw fif raw fname preload preload
def get events dcsp return read events event name
def get picks raw dcsp return 0 1 2 6 7 8 12 13 14
def get epochs dcsp raw get raw dcnl dcsp events get events dcnl dcsp picks get picks raw dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs epochs raw events 10 event id tmin tmax picks picks dcnl dcsp return epochs
requires sklearn dcnl def test plot ica components dcsp import matplotlib pyplot as plt dcnl dcsp res 8 dcnl dcsp fast test res res contours 0 sensors false dcnl dcsp raw get raw dcnl dcsp ica ica noise cov read cov cov fname n components 2 max pca components 3 n pca components 3 dcnl dcsp ica picks get picks raw dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks ica picks dcnl dcsp warnings simplefilter always userwarning dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp for components in 0 0 0 1 0 1 2 none dcnl dcsp dcsp dcsp ica plot components components image interp bilinear colorbar true fast test dcnl dcsp dcsp plt close all dcnl dcsp dcsp ica plot components 0 1 image interp bilinear inst raw res 16 dcnl dcsp dcsp fig plt gcf dcnl dcsp dcsp ax a for a in fig get children if isinstance a plt axes dcnl dcsp dcsp lbl ax1 get label dcnl dcsp dcsp fake click fig ax1 0 0 0 0 xform data dcnl dcsp dcsp c fig plt gcf dcnl dcsp dcsp ax a for a in c fig get children if isinstance a plt axes dcnl dcsp dcsp labels a get label for a in ax dcnl dcsp dcsp for l in topomap image erp spectrum variance dcnl dcsp dcsp dcsp assert true l in labels dcnl dcsp dcsp topomap ax axlabels index topomap dcnl dcsp dcsp title topomap ax get title dcnl dcsp dcsp assert true lbl title dcnl dcsp ica info none dcnl dcsp assert raises valueerror ica plot components 1 dcnl dcsp assert raises runtimeerror ica plot components 1 ch type mag dcnl dcsp plt close all
requires sklearn dcnl def test plot ica properties dcsp import matplotlib pyplot as plt dcnl dcsp res 8 dcnl dcsp raw get raw preload true dcnl dcsp raw add proj remove existing true dcnl dcsp events get events dcnl dcsp picks get picks raw 6 dcnl dcsp pick names raw ch namesk for k in picks dcnl dcsp raw pick channels pick names dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs epochs raw events 10 event id tmin tmax baseline none 0 preload true dcnl dcsp ica ica noise cov read cov cov fname n components 2 max pca components 2 n pca components 2 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw dcnl dcsp fig ax create properties layout dcnl dcsp assert equal len ax 5 dcnl dcsp topoargs dict topomap args res res contours 0 sensors false dcnl dcsp ica plot properties raw picks 0 topoargs dcnl dcsp ica plot properties epochs picks 1 db false plot std 1 5 topoargs dcnl dcsp ica plot properties epochs picks 1 image args sigma 1 5 topomap args res 10 colorbar true psd args fmax 65 0 plot std false figsize 4 5 4 5 dcnl dcsp plt close all dcnl dcsp assert raises valueerror ica plot properties epochs db list abc dcnl dcsp assert raises valueerror ica plot properties epochs plot std dcnl dcsp assert raises valueerror ica plot properties ica dcnl dcsp assert raises valueerror ica plot properties 0 2 dcnl dcsp assert raises valueerror plot ica properties epochs epochs dcnl dcsp assert raises valueerror ica plot properties epochs psd args not dcsp dict dcnl dcsp fig ax plt subplots 2 3 dcnl dcsp ax ax ravel 1 dcnl dcsp ica plot properties epochs picks 1 axes ax topoargs dcnl dcsp fig ica plot properties raw picks 0 1 topoargs dcnl dcsp assert equal len fig 2 dcnl dcsp assert raises valueerror plot ica properties epochs ica picks 0 1 axes ax dcnl dcsp assert raises valueerror ica plot properties epochs axes not dcsp axes dcnl dcsp plt close all dcnl dcsp raw get raw preload true dcnl dcsp picks pick types raw info meg grad 10 dcnl dcsp ica ica n components 2 dcnl dcsp ica fit raw picks picks dcnl dcsp ica plot properties raw dcnl dcsp plt close all
requires sklearn dcnl def test plot ica sources dcsp import matplotlib pyplot as plt dcnl dcsp raw read raw fif raw fname crop 0 1 load data dcnl dcsp picks get picks raw dcnl dcsp epochs get epochs dcnl dcsp raw pick channels raw ch namesk for k in picks dcnl dcsp ica picks pick types raw info meg true eeg false stim false ecg false eog false exclude bads dcnl dcsp ica ica n components 2 max pca components 3 n pca components 3 dcnl dcsp ica fit raw picks ica picks dcnl dcsp ica exclude 1 dcnl dcsp fig ica plot sources raw dcnl dcsp fig canvas key press event escape dcnl dcsp assert array equal ica exclude 1 dcnl dcsp raw info bads meg dcsp 0113 dcnl dcsp assert raises runtimeerror ica plot sources inst raw dcnl dcsp ica plot sources epochs dcnl dcsp epochs info bads meg dcsp 0113 dcnl dcsp assert raises runtimeerror ica plot sources inst epochs dcnl dcsp epochs info bads dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica plot sources epochs average dcnl dcsp dcsp evoked epochs average dcnl dcsp dcsp fig ica plot sources evoked dcnl dcsp dcsp ax fig get axes 0 dcnl dcsp dcsp line ax lines0 dcnl dcsp dcsp fake click fig ax line get xdata 0 line get ydata 0 data dcnl dcsp dcsp fake click fig ax ax get xlim 0 ax get ylim 1 data dcnl dcsp dcsp ica plot sources evoked exclude 0 dcnl dcsp dcsp ica exclude 0 dcnl dcsp dcsp ica plot sources evoked dcnl dcsp dcsp ica labels dict eog 0 dcnl dcsp dcsp ica labels eog 0 crazychannel 0 dcnl dcsp dcsp ica plot sources evoked dcnl dcsp assert raises valueerror ica plot sources meeow dcnl dcsp plt close all
requires sklearn dcnl def test plot ica overlay dcsp import matplotlib pyplot as plt dcnl dcsp raw get raw preload true dcnl dcsp picks get picks raw dcnl dcsp ica ica noise cov read cov cov fname n components 2 max pca components 3 n pca components 3 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks picks dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ecg epochs create ecg epochs raw picks picks dcnl dcsp ica plot overlay ecg epochs average dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp eog epochs create eog epochs raw picks picks dcnl dcsp ica plot overlay eog epochs average dcnl dcsp assert raises valueerror ica plot overlay raw 2 30 dcnl dcsp ica plot overlay raw dcnl dcsp plt close all
requires sklearn dcnl def test plot ica scores dcsp import matplotlib pyplot as plt dcnl dcsp raw get raw dcnl dcsp picks get picks raw dcnl dcsp ica ica noise cov read cov cov fname n components 2 max pca components 3 n pca components 3 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks picks dcnl dcsp ica labels dict dcnl dcsp ica labels eog 0 foo 0 dcnl dcsp ica labels eog 0 dcnl dcsp ica labels ecg 1 dcnl dcsp ica plot scores 0 3 0 2 axhline 0 1 0 1 dcnl dcsp ica plot scores 0 3 0 2 axhline 0 1 0 1 labels foo dcnl dcsp ica plot scores 0 3 0 2 axhline 0 1 0 1 labels eog dcnl dcsp ica plot scores 0 3 0 2 axhline 0 1 0 1 labels ecg dcnl dcsp assert raises valueerror ica plot scores 0 3 0 2 axhline 0 1 0 1 labels one onetoomany dcnl dcsp assert raises valueerror ica plot scores 0 2 dcnl dcsp plt close all
requires sklearn dcnl def test plot instance components dcsp import matplotlib pyplot as plt dcnl dcsp raw get raw dcnl dcsp picks get picks raw dcnl dcsp ica ica noise cov read cov cov fname n components 2 max pca components 3 n pca components 3 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp ica fit raw picks picks dcnl dcsp fig ica plot sources raw exclude 0 title components dcnl dcsp for key in down up right left o + pageup pagedown home end f11 b dcnl dcsp dcsp fig canvas key press event key dcnl dcsp ax fig get axes 0 dcnl dcsp line ax lines0 dcnl dcsp fake click fig ax line get xdata 0 line get ydata 0 data dcnl dcsp fake click fig ax 0 1 0 9 dcnl dcsp fig canvas key press event escape dcnl dcsp plt close all dcnl dcsp epochs get epochs dcnl dcsp fig ica plot sources epochs exclude 0 title components dcnl dcsp for key in down up right left o + pageup pagedown home end f11 b dcnl dcsp dcsp fig canvas key press event key dcnl dcsp ax fig get axes 0 dcnl dcsp line ax lines0 dcnl dcsp fake click fig ax line get xdata 0 line get ydata 0 data dcnl dcsp fake click fig ax 0 1 0 9 dcnl dcsp fig canvas key press event escape dcnl dcsp plt close all
slow test dcnl testing requires testing data dcnl def test plot topomap dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib patches import circle dcnl dcsp warnings simplefilter always dcnl dcsp res 8 dcnl dcsp fast test res res contours 0 sensors false dcnl dcsp evoked read evokeds evoked fname left dcsp auditory baseline none 0 dcnl dcsp anim evoked animate topomap ch type grad times 0 0 1 butterfly false dcnl dcsp anim func 1 dcnl dcsp plt close all dcnl dcsp ev bad evoked copy pick types meg false eeg true dcnl dcsp ev bad pick channels ev bad ch names 2 dcnl dcsp plt topomap partial ev bad plot topomap fast test dcnl dcsp plt topomap times ev bad times 2 1e06 dcnl dcsp assert raises valueerror plt topomap ch type mag dcnl dcsp assert raises typeerror plt topomap head pos foo dcnl dcsp assert raises keyerror plt topomap head pos dict foo bar dcnl dcsp assert raises valueerror plt topomap head pos dict center 0 dcnl dcsp assert raises valueerror plt topomap times 100 dcnl dcsp assert raises valueerror plt topomap times 0 dcnl dcsp evoked plot topomap 0 1 ch type eeg scale 1 res res contours 100 0 100 dcnl dcsp plt topomap partial evoked plot topomap fast test dcnl dcsp plt topomap 0 1 layout layout scale dict mag 0 1 dcnl dcsp plt close all dcnl dcsp axes plt subplot 221 plt subplot 222 dcnl dcsp plt topomap axes axes colorbar false dcnl dcsp plt close all dcnl dcsp plt topomap times 0 1 0 2 dcnl dcsp plt close all dcnl dcsp evoked grad evoked copy crop 0 0 pick types meg grad dcnl dcsp mask np zeros 204 1 bool dcnl dcsp mask0 3 5 6 true dcnl dcsp names dcnl dcsp def proc names x dcnl dcsp dcsp names append x dcnl dcsp dcsp return x4 dcnl dcsp evoked grad plot topomap ch type grad times 0 mask mask show names proc names fast test dcnl dcsp assert equal sorted names meg dcsp 011x meg dcsp 012x meg dcsp 013x meg dcsp 014x dcnl dcsp mask np zeros like evoked data dtype bool dcnl dcsp mask1 5 true dcnl dcsp plt topomap ch type mag outlines none dcnl dcsp times 0 1 dcnl dcsp plt topomap times ch type grad mask mask dcnl dcsp plt topomap times ch type planar1 dcnl dcsp plt topomap times ch type planar2 dcnl dcsp plt topomap times ch type grad mask mask show names true mask params marker x dcnl dcsp plt close all dcnl dcsp assert raises valueerror plt topomap times ch type eeg average 1000 0 dcnl dcsp assert raises valueerror plt topomap times ch type eeg average x dcnl dcsp p plt topomap times ch type grad image interp bilinear show names lambda x x replace meg dcnl dcsp subplot x for x in p get children if isinstance x matplotlib axes subplot 0 dcnl dcsp assert true all meg not in x get text for x in subplot get children if isinstance x matplotlib text text dcnl dcsp for ch type in mag grad dcnl dcsp dcsp evoked evoked copy pick types eeg false meg ch type dcnl dcsp dcsp plot topomap evoked data 0 evoked info fast test dcnl dcsp assert raises valueerror plot topomap evoked data0 evoked info dcnl dcsp def get texts p dcnl dcsp dcsp return x get text for x in p get children if isinstance x matplotlib text text dcnl dcsp p plt topomap times ch type eeg average 0 01 dcnl dcsp assert equal len get texts p 0 dcnl dcsp p plt topomap times ch type eeg title custom dcnl dcsp texts get texts p dcnl dcsp assert equal len texts 1 dcnl dcsp assert equal texts0 custom dcnl dcsp plt close all dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp plt topomap times ch type mag layout none dcnl dcsp assert raises runtimeerror plot evoked topomap evoked 0 1 mag proj interactive dcnl dcsp evoked read evokeds evoked fname left dcsp auditory baseline none 0 proj false dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp fig1 evoked plot topomap interactive mag proj interactive fast test dcnl dcsp dcsp fake click fig1 fig1 axes1 0 5 0 5 dcnl dcsp data max np max fig1 axes0 images0 a dcnl dcsp fig2 plt gcf dcnl dcsp fake click fig2 fig2 axes0 0 075 0 775 dcnl dcsp assert true np max fig1 axes0 images0 a data max dcnl dcsp assert raises runtimeerror plot evoked topomap evoked np repeat 0 1 50 dcnl dcsp assert raises valueerror plot evoked topomap evoked 3000000000000 0 15000000 0 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp projs read proj ecg fname dcnl dcsp projs pp for pp in projs if pp desc lower find eeg < 0 dcnl dcsp plot projs topomap projs res res colorbar true dcnl dcsp plt close all dcnl dcsp ax plt subplot 111 dcnl dcsp plot projs topomap projs 1 axes ax fast test dcnl dcsp plt close all dcnl dcsp plot projs topomap read info triux fname projs 1 dcnl dcsp plt close all dcnl dcsp for ch in evoked info chs dcnl dcsp dcsp if ch coil type fiff fiffv coil eeg dcnl dcsp dcsp dcsp ch loc fill 0 dcnl dcsp del evoked info dig 85 dcnl dcsp pos make eeg layout evoked info pos 2 dcnl dcsp pos outlines check outlines pos head dcnl dcsp assert true head in outlines keys dcnl dcsp assert true nose in outlines keys dcnl dcsp assert true ear left in outlines keys dcnl dcsp assert true ear right in outlines keys dcnl dcsp assert true autoshrink in outlines keys dcnl dcsp assert true outlines autoshrink dcnl dcsp assert true clip radius in outlines keys dcnl dcsp assert array equal outlines clip radius 0 5 dcnl dcsp pos outlines check outlines pos skirt dcnl dcsp assert true head in outlines keys dcnl dcsp assert true nose in outlines keys dcnl dcsp assert true ear left in outlines keys dcnl dcsp assert true ear right in outlines keys dcnl dcsp assert true autoshrink in outlines keys dcnl dcsp assert true not outlines autoshrink dcnl dcsp assert true clip radius in outlines keys dcnl dcsp assert array equal outlines clip radius 0 625 dcnl dcsp pos outlines check outlines pos skirt head pos scale 1 2 1 2 dcnl dcsp assert array equal outlines clip radius 0 75 dcnl dcsp evoked plot topomap times ch type eeg outlines skirt fast test dcnl dcsp evoked plot topomap times ch type eeg outlines outlines fast test dcnl dcsp plt close all dcnl dcsp fig plot evoked topomap evoked times 0 0 0 1 ch type eeg cmap reds true title title fast test dcnl dcsp fig canvas key press event up dcnl dcsp fig canvas key press event dcsp dcnl dcsp fig canvas key press event down dcnl dcsp cbar fig get axes 0 cb dcnl dcsp ax cbar cbar ax dcnl dcsp fake click fig ax 0 1 0 1 dcnl dcsp fake click fig ax 0 1 0 2 kind motion dcnl dcsp fake click fig ax 0 1 0 3 kind release dcnl dcsp fake click fig ax 0 1 0 1 button 3 dcnl dcsp fake click fig ax 0 1 0 2 button 3 kind motion dcnl dcsp fake click fig ax 0 1 0 3 kind release dcnl dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp plt close all dcnl dcsp def patch dcnl dcsp dcsp return circle 0 5 0 4687 radius 0 46 clip on true transform plt gca transaxes dcnl dcsp outlines patch patch dcnl dcsp plot evoked topomap evoked times ch type eeg outlines outlines fast test dcnl dcsp evoked info dig none dcnl dcsp assert raises runtimeerror plot evoked topomap evoked times ch type eeg dcnl dcsp plt close all dcnl dcsp n channels len pos dcnl dcsp data np ones n channels dcnl dcsp assert raises valueerror plot topomap data pos show names true dcnl dcsp pos 1d np zeros n channels dcnl dcsp pos 3d np zeros n channels 2 2 dcnl dcsp assert raises valueerror plot topomap data pos 1d dcnl dcsp assert raises valueerror plot topomap data pos 3d dcnl dcsp assert raises valueerror plot topomap data pos 3 dcnl dcsp pos x pos 1 dcnl dcsp pos xyz np c pos np zeros n channels np newaxis dcnl dcsp assert raises valueerror plot topomap data pos x dcnl dcsp assert raises valueerror plot topomap data pos xyz dcnl dcsp pos xywh np c pos np zeros n channels 2 dcnl dcsp plot topomap data pos xywh dcnl dcsp plt close all dcnl dcsp axes plt subplot 131 plt subplot 132 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp evoked plot topomap times peaks axes axes fast test dcnl dcsp plt close all dcnl dcsp evoked data np zeros evoked data shape dcnl dcsp evoked data501 1 dcnl dcsp assert array equal find peaks evoked 10 evoked times1 dcnl dcsp evoked data80100 1 dcnl dcsp assert array equal find peaks evoked 10 evoked times1 100 dcnl dcsp evoked data295 2 dcnl dcsp assert array equal find peaks evoked 10 evoked times1 95 dcnl dcsp assert array equal find peaks evoked 1 evoked times95
def test plot tfr topomap dcsp import matplotlib as mpl dcnl dcsp import matplotlib pyplot as plt dcnl dcsp raw read raw fif raw fname dcnl dcsp times np linspace 0 1 0 1 200 dcnl dcsp res 8 dcnl dcsp n freqs 3 dcnl dcsp nave 1 dcnl dcsp rng np random randomstate 42 dcnl dcsp picks 93 94 96 97 21 22 24 25 129 130 315 316 2 5 8 11 dcnl dcsp info pick info raw info picks dcnl dcsp data rng randn len picks n freqs len times dcnl dcsp tfr averagetfr info data times np arange n freqs nave dcnl dcsp tfr plot topomap ch type mag tmin 0 05 tmax 0 15 fmin 0 fmax 10 res res contours 0 dcnl dcsp eclick mpl backend bases mouseevent button press event plt gcf canvas 0 0 1 dcnl dcsp eclick xdata eclick ydata 0 1 dcnl dcsp eclick inaxes plt gca dcnl dcsp erelease mpl backend bases mouseevent button release event plt gcf canvas 0 9 0 9 1 dcnl dcsp erelease xdata 0 3 dcnl dcsp erelease ydata 0 2 dcnl dcsp pos 0 11 0 11 0 25 0 5 0 0 0 2 0 2 0 39 dcnl dcsp onselect eclick erelease tfr pos grad 1 3 1 3 rdbu r list dcnl dcsp onselect eclick erelease tfr pos mag 1 3 1 3 rdbu r list dcnl dcsp eclick xdata eclick ydata 0 0 dcnl dcsp erelease xdata erelease ydata 0 9 dcnl dcsp tfr onselect eclick erelease none mean none dcnl dcsp plt close all dcnl dcsp info raw info copy dcnl dcsp chan inds channel indices by type info dcnl dcsp info pick info info chan inds grad 4 dcnl dcsp fig axes plt subplots dcnl dcsp freqs np arange 3 0 9 5 dcnl dcsp bands 4 8 theta dcnl dcsp psd np random rand len info ch names freqs shape0 dcnl dcsp plot psds topomap psd freqs info bands bands axes axes
def get raw dcsp raw read raw fif raw fname preload true dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw set channel types raw ch names0 ias dcnl dcsp raw pick channels raw ch names 9 dcnl dcsp raw info normalize proj dcnl dcsp return raw
def get events dcsp return read events event name
def annotation helper raw dcsp import matplotlib pyplot as plt dcnl dcsp n anns 0 if raw annotations is none else len raw annotations onset dcnl dcsp fig raw plot dcnl dcsp data ax fig axes0 dcnl dcsp fig canvas key press event a dcnl dcsp ann fig plt gcf dcnl dcsp for key in dcsp test dcnl dcsp dcsp ann fig canvas key press event key dcnl dcsp ann fig canvas key press event enter dcnl dcsp ann fig plt gcf dcnl dcsp annotation radio clicked ann fig radio data ax selector dcnl dcsp fake click fig data ax 1 0 1 0 xform data button 1 kind press dcnl dcsp fake click fig data ax 5 0 1 0 xform data button 1 kind motion dcnl dcsp fake click fig data ax 5 0 1 0 xform data button 1 kind release dcnl dcsp fake click fig data ax 4 5 1 0 xform data button none kind motion dcnl dcsp fake click fig data ax 4 7 1 0 xform data button none kind motion dcnl dcsp fake click fig data ax 5 0 1 0 xform data button 1 kind press dcnl dcsp fake click fig data ax 2 5 1 0 xform data button 1 kind motion dcnl dcsp fake click fig data ax 2 5 1 0 xform data button 1 kind release dcnl dcsp fake click fig data ax 1 0 1 0 xform data button 1 kind press dcnl dcsp fake click fig data ax 1 1 1 0 xform data button 1 kind motion dcnl dcsp fake click fig data ax 1 1 1 0 xform data button 1 kind release dcnl dcsp assert equal len raw annotations onset n anns + 1 dcnl dcsp assert equal len raw annotations duration n anns + 1 dcnl dcsp assert equal len raw annotations description n anns + 1 dcnl dcsp assert equal raw annotations descriptionn anns bad dcsp test dcnl dcsp fake click fig data ax 5 5 1 0 xform data button 1 kind press dcnl dcsp fake click fig data ax 2 0 1 0 xform data button 1 kind motion dcnl dcsp fake click fig data ax 2 0 1 0 xform data button 1 kind release dcnl dcsp fake click fig data ax 1 5 1 0 xform data button 3 kind press dcnl dcsp fig canvas key press event a dcnl dcsp assert equal len raw annotations onset n anns dcnl dcsp assert equal len raw annotations duration n anns dcnl dcsp assert equal len raw annotations description n anns dcnl dcsp plt close all
def test plot raw dcsp import matplotlib pyplot as plt dcnl dcsp raw get raw dcnl dcsp raw info lowpass 10 0 dcnl dcsp events get events dcnl dcsp plt close all dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp fig raw plot events events show options true order 1 7 3 group by original dcnl dcsp dcsp x fig get axes 0 lines1 get xdata mean dcnl dcsp dcsp y fig get axes 0 lines1 get ydata mean dcnl dcsp dcsp data ax fig axes0 dcnl dcsp dcsp fake click fig data ax x y xform data dcnl dcsp dcsp fake click fig data ax x y xform data dcnl dcsp dcsp fake click fig data ax 0 5 0 999 dcnl dcsp dcsp fake click fig data ax 0 1 0 9 dcnl dcsp dcsp fake click fig fig get axes 1 0 5 0 5 dcnl dcsp dcsp fake click fig fig get axes 2 0 5 0 5 dcnl dcsp dcsp fake click fig fig get axes 3 0 5 0 5 dcnl dcsp dcsp fig canvas button press event 1 1 1 dcnl dcsp dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp dcsp for key in down up right left o + pageup pagedown home end f11 escape dcnl dcsp dcsp dcsp fig canvas key press event key dcnl dcsp dcsp fig plot raw raw events events group by selection dcnl dcsp dcsp for key in b down up right left o + pageup pagedown home end f11 b escape dcnl dcsp dcsp dcsp fig canvas key press event key dcnl dcsp dcsp assert raises keyerror raw plot event color 0 r dcnl dcsp dcsp assert raises typeerror raw plot event color foo r dcnl dcsp dcsp annot annotations 10 10 + raw first samp raw info sfreq 10 10 test test raw info meas date dcnl dcsp dcsp raw annotations annot dcnl dcsp dcsp fig plot raw raw events events event color 1 r 998 b dcnl dcsp dcsp plt close all dcnl dcsp dcsp for group by order in zip position selection np arange len raw ch names 3 1 2 4 6 dcnl dcsp dcsp dcsp fig raw plot group by group by order order dcnl dcsp dcsp dcsp x fig get axes 0 lines1 get xdata 10 dcnl dcsp dcsp dcsp y fig get axes 0 lines1 get ydata 10 dcnl dcsp dcsp dcsp fake click fig data ax x y xform data dcnl dcsp dcsp dcsp fig canvas key press event down dcnl dcsp dcsp dcsp fake click fig fig get axes 2 0 5 0 5 dcnl dcsp dcsp dcsp sel fig plt figure 1 dcnl dcsp dcsp dcsp topo ax sel fig axes1 dcnl dcsp dcsp dcsp fake click sel fig topo ax 0 425 0 20223853 xform data dcnl dcsp dcsp dcsp fig canvas key press event down dcnl dcsp dcsp dcsp fig canvas key press event up dcnl dcsp dcsp dcsp fig canvas scroll event 0 5 0 5 1 dcnl dcsp dcsp dcsp fig canvas scroll event 0 5 0 5 1 dcnl dcsp dcsp dcsp fake click sel fig topo ax 0 5 0 0 xform data dcnl dcsp dcsp dcsp fake click sel fig topo ax 0 5 0 0 xform data kind motion dcnl dcsp dcsp dcsp fake click sel fig topo ax 0 5 0 5 xform data kind motion dcnl dcsp dcsp dcsp fake click sel fig topo ax 0 5 0 5 xform data kind release dcnl dcsp dcsp dcsp plt close all dcnl dcsp dcsp raw info meas date np array raw info meas date 0 dtype np int32 dcnl dcsp dcsp raw annotations annotations 1 + raw first samp raw info sfreq 5 bad dcnl dcsp dcsp raw plot group by position order np arange 8 dcnl dcsp dcsp for fig num in plt get fignums dcnl dcsp dcsp dcsp fig plt figure fig num dcnl dcsp dcsp dcsp if hasattr fig radio dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp for key in down up escape dcnl dcsp dcsp dcsp fig canvas key press event key dcnl dcsp dcsp plt close all
testing requires testing data dcnl def test plot ref meg dcsp import matplotlib pyplot as plt dcnl dcsp raw ctf read raw ctf ctf fname continuous crop 0 1 load data dcnl dcsp raw ctf plot dcnl dcsp plt close all dcnl dcsp assert raises valueerror raw ctf plot order selection
def test plot annotations dcsp raw get raw dcnl dcsp raw info lowpass 10 0 dcnl dcsp annotation helper raw dcnl dcsp raw annotations annotations 42 1 test raw info meas date dcnl dcsp annotation helper raw
requires version scipy 0 10 dcnl def test plot raw filtered dcsp raw get raw dcnl dcsp assert raises valueerror raw plot lowpass raw info sfreq 2 0 dcnl dcsp assert raises valueerror raw plot highpass 0 dcnl dcsp assert raises valueerror raw plot lowpass 1 highpass 1 dcnl dcsp assert raises valueerror raw plot lowpass 1 filtorder 0 dcnl dcsp assert raises valueerror raw plot clipping foo dcnl dcsp raw plot lowpass 1 clipping transparent dcnl dcsp raw plot highpass 1 clipping clamp dcnl dcsp raw plot highpass 1 lowpass 2 butterfly true
requires version scipy 0 12 dcnl def test plot raw psd dcsp import matplotlib pyplot as plt dcnl dcsp raw get raw dcnl dcsp raw plot psd dcnl dcsp picks pick types raw info meg mag eeg false 4 dcnl dcsp raw plot psd tmax np inf picks picks area mode range average false spatial colors true dcnl dcsp raw plot psd tmax 20 0 color yellow db false line alpha 0 4 n overlap 0 1 average false dcnl dcsp plt close all dcnl dcsp ax plt axes dcnl dcsp assert raises valueerror raw plot psd ax ax dcnl dcsp assert raises valueerror raw plot psd average true spatial colors true dcnl dcsp raw plot psd tmax np inf picks picks ax ax dcnl dcsp plt close all dcnl dcsp ax plt axes dcnl dcsp assert raises valueerror raw plot psd ax ax dcnl dcsp ax ax plt axes dcnl dcsp raw plot psd tmax np inf ax ax dcnl dcsp plt close all dcnl dcsp ax plt subplot dcnl dcsp raw plot psd topo axes ax dcnl dcsp plt close all dcnl dcsp for idx in range len raw info chs dcnl dcsp dcsp raw info chs idx loc np zeros 12 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw plot psd spatial colors true average false dcnl dcsp raw5 0 dcnl dcsp assert raises valueerror raw plot psd
def test plot sensors dcsp import matplotlib pyplot as plt dcnl dcsp raw get raw dcnl dcsp fig raw plot sensors 3d dcnl dcsp fake click fig fig gca 0 08 0 67 dcnl dcsp raw plot sensors topomap ch type mag show names meg dcsp 0111 meg dcsp 0131 dcnl dcsp ax plt subplot 111 dcnl dcsp raw plot sensors ch groups position axes ax dcnl dcsp raw plot sensors ch groups selection to sphere false dcnl dcsp raw plot sensors ch groups 0 1 2 3 4 dcnl dcsp assert raises valueerror raw plot sensors ch groups asd dcnl dcsp assert raises typeerror plot sensors raw dcnl dcsp assert raises valueerror plot sensors raw info kind sasaasd dcnl dcsp plt close all dcnl dcsp fig sels raw plot sensors select show names true dcnl dcsp ax fig axes0 dcnl dcsp fake click fig ax 0 0 0 0 xform data dcnl dcsp fake click fig ax 0 0 0 xform data kind release dcnl dcsp assert equal len fig lasso selection 0 dcnl dcsp fake click fig ax 0 5 0 5 xform data dcnl dcsp plt draw dcnl dcsp fake click fig ax 0 0 0 5 xform data kind motion dcnl dcsp fake click fig ax 0 0 0 0 xform data kind motion dcnl dcsp fig canvas key press event control dcnl dcsp fake click fig ax 0 5 0 0 xform data kind release dcnl dcsp assert equal len fig lasso selection 1 dcnl dcsp fake click fig ax 0 09 0 43 xform data dcnl dcsp assert equal len fig lasso selection 2 dcnl dcsp fake click fig ax 0 09 0 43 xform data dcnl dcsp assert equal len fig lasso selection 1 dcnl dcsp plt close all
def get picks raw dcsp return pick types raw info meg true eeg false stim false ecg false eog false exclude bads
def get epochs dcsp raw read raw fif raw fname dcnl dcsp raw add proj remove existing true dcnl dcsp events read events event name dcnl dcsp picks get picks raw dcnl dcsp picks picksnp round np linspace 0 len picks 1 n chan astype int dcnl dcsp picks np concatenate 2 3 4 6 7 picks dcnl dcsp epochs epochs raw events 5 event id tmin tmax picks picks dcnl dcsp epochs info bads epochs ch names 1 dcnl dcsp return epochs
def get epochs delayed ssp dcsp raw read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks get picks raw dcnl dcsp reject dict mag 4e12 dcnl dcsp epochs delayed ssp epochs raw events 10 event id tmin tmax picks picks proj delayed reject reject dcnl dcsp return epochs delayed ssp
slow test dcnl def test plot evoked dcsp import matplotlib pyplot as plt dcnl dcsp evoked get epochs average dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp fig evoked plot proj true hline 1 exclude window title foo dcnl dcsp dcsp ax fig get axes 0 dcnl dcsp dcsp line ax lines0 dcnl dcsp dcsp fake click fig ax line get xdata 0 line get ydata 0 data dcnl dcsp dcsp fake click fig ax ax get xlim 0 ax get ylim 1 data dcnl dcsp dcsp evoked plot exclude bads dcnl dcsp dcsp evoked plot hline 1 units dict mag femto dcsp foo dcnl dcsp dcsp evoked delayed ssp get epochs delayed ssp average dcnl dcsp dcsp evoked delayed ssp plot proj interactive dcnl dcsp dcsp evoked delayed ssp apply proj dcnl dcsp dcsp assert raises runtimeerror evoked delayed ssp plot proj interactive dcnl dcsp dcsp evoked delayed ssp info projs dcnl dcsp dcsp assert raises runtimeerror evoked delayed ssp plot proj interactive dcnl dcsp dcsp assert raises runtimeerror evoked delayed ssp plot proj interactive axes foo dcnl dcsp dcsp plt close all dcnl dcsp dcsp evoked plot gfp only dcnl dcsp dcsp assert raises valueerror evoked plot gfp foo dcnl dcsp dcsp evoked plot image proj true dcnl dcsp dcsp evoked plot image exclude bads cmap interactive dcnl dcsp dcsp evoked plot image exclude evoked info bads dcnl dcsp dcsp plt close all dcnl dcsp dcsp evoked plot topo dcnl dcsp dcsp line plot onselect 0 200 mag grad evoked info evoked data evoked times dcnl dcsp dcsp plt close all dcnl dcsp dcsp cov read cov cov fname dcnl dcsp dcsp cov method empirical dcnl dcsp dcsp evoked plot white cov dcnl dcsp dcsp evoked plot white cov cov dcnl dcsp dcsp plot compare evokeds evoked copy pick types meg mag dcnl dcsp dcsp evoked rename channels meg dcsp 2142 meg dcsp 1642 dcnl dcsp dcsp assert len plot compare evokeds evoked 2 dcnl dcsp dcsp colors dict red r blue b dcnl dcsp dcsp linestyles dict red blue dcnl dcsp dcsp red blue evoked copy evoked copy dcnl dcsp dcsp red data 1 1 dcnl dcsp dcsp blue data 0 9 dcnl dcsp dcsp plot compare evokeds red blue picks 3 dcnl dcsp dcsp plot compare evokeds red blue picks 3 truncate yaxis true dcnl dcsp dcsp plot compare evokeds red evoked blue evoked picks 3 dcnl dcsp dcsp contrast dict dcnl dcsp dcsp contrast red stim list evoked copy red dcnl dcsp dcsp contrast blue stim list evoked copy blue dcnl dcsp dcsp plot compare evokeds contrast colors colors linestyles linestyles picks 0 2 vlines 0 01 0 04 invert y true truncate yaxis false ylim dict mag 10 10 styles red stim linewidth 1 dcnl dcsp dcsp assert raises valueerror plot compare evokeds contrast picks str dcnl dcsp dcsp assert raises valueerror plot compare evokeds evoked picks 3 colors dict fake 1 dcnl dcsp dcsp assert raises valueerror plot compare evokeds evoked picks 3 styles dict fake 1 dcnl dcsp dcsp assert raises valueerror plot compare evokeds 1 2 3 4 picks 3 dcnl dcsp dcsp assert raises valueerror plot compare evokeds evoked picks 3 styles dict err 1 dcnl dcsp dcsp assert raises valueerror plot compare evokeds evoked picks 3 gfp true dcnl dcsp dcsp assert raises typeerror plot compare evokeds evoked picks 3 ci fake dcnl dcsp dcsp contrast red stim red dcnl dcsp dcsp contrast blue stim blue dcnl dcsp dcsp plot compare evokeds contrast picks 0 colors r b ylim dict mag 1 10 dcnl dcsp dcsp evoked sss evoked copy dcnl dcsp dcsp evoked sss info proc history dict max info none dcnl dcsp dcsp evoked sss plot white cov dcnl dcsp dcsp evoked sss plot white cov fname dcnl dcsp dcsp evoked rename channels meg dcsp 0133 meg dcsp 0000 dcnl dcsp dcsp evoked plot exclude evoked info bads spatial colors true gfp true zorder std dcnl dcsp dcsp evoked plot exclude spatial colors true zorder unsorted dcnl dcsp dcsp assert raises typeerror evoked plot zorder asdf dcnl dcsp dcsp plt close all dcnl dcsp evoked plot sensors dcnl dcsp plt close all dcnl dcsp evoked pick channels evoked ch names 4 dcnl dcsp with warnings catch warnings record true as ws dcnl dcsp dcsp evoked plot dcnl dcsp assert equal len ws 2 dcnl dcsp assert true all need dcsp more dcsp than dcsp one in str w message for w in ws
def get events dcsp return read events event name
def get picks raw dcsp return 0 1 2 6 7 8 306 340 341 342
def get epochs dcsp raw read raw fif raw fname dcnl dcsp raw add proj remove existing true dcnl dcsp events get events dcnl dcsp picks get picks raw dcnl dcsp epochs epochs raw events 10 event id tmin tmax picks picks dcnl dcsp return epochs
def get epochs delayed ssp dcsp raw read raw fif raw fname dcnl dcsp events get events dcnl dcsp picks get picks raw dcnl dcsp reject dict mag 4e12 dcnl dcsp epochs delayed ssp epochs raw events 10 event id tmin tmax picks picks proj delayed reject reject dcnl dcsp return epochs delayed ssp
def test plot topo dcsp import matplotlib pyplot as plt dcnl dcsp evoked get epochs average dcnl dcsp plot evoked topo evoked evoked merge grads true background color w dcnl dcsp evoked plot joint dcnl dcsp def return inds d dcnl dcsp dcsp return list range d shape0 dcnl dcsp evoked plot joint title test topomap args dict contours 0 res 8 ts args dict spatial colors true zorder return inds dcnl dcsp assert raises valueerror evoked plot joint ts args dict axes true dcnl dcsp warnings simplefilter always userwarning dcnl dcsp picked evoked evoked copy pick channels evoked ch names 3 dcnl dcsp picked evoked eeg evoked copy pick types meg false eeg true dcnl dcsp picked evoked eeg pick channels picked evoked eeg ch names 3 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp for ylim in dict mag 600 600 none dcnl dcsp dcsp dcsp plot evoked topo picked evoked 2 layout ylim ylim dcnl dcsp dcsp for evo in evoked evoked picked evoked dcnl dcsp dcsp dcsp assert raises valueerror plot evoked topo evo layout color y b dcnl dcsp dcsp evoked delayed ssp get epochs delayed ssp average dcnl dcsp dcsp ch names evoked delayed ssp ch names 3 dcnl dcsp dcsp picked evoked delayed ssp pick channels evoked evoked delayed ssp ch names dcnl dcsp dcsp fig plot evoked topo picked evoked delayed ssp layout proj interactive dcnl dcsp dcsp func get presser fig dcnl dcsp dcsp event namedtuple event inaxes xdata ydata dcnl dcsp dcsp func event inaxes fig axes0 xdata fig axes0 mne axs0 pos0 ydata fig axes0 mne axs0 pos1 dcnl dcsp dcsp func event inaxes fig axes0 xdata 0 ydata 0 dcnl dcsp dcsp params dict evokeds picked evoked delayed ssp times picked evoked delayed ssp times fig fig projs picked evoked delayed ssp info projs dcnl dcsp dcsp bools true len params projs dcnl dcsp dcsp plot update evoked topo proj params bools dcnl dcsp plot evoked topo picked evoked eeg copy fig background np zeros 4 3 3 proj true background color k dcnl dcsp picked evoked plot topo merge grads true background color w dcnl dcsp plt close all dcnl dcsp for ax idx in iter topography evoked info dcnl dcsp dcsp ax plot evoked dataidx color red dcnl dcsp plt close all
def test plot topo image epochs dcsp import matplotlib pyplot as plt dcnl dcsp title erf dcsp images dcsp dcsp mne dcsp sample dcsp data dcnl dcsp epochs get epochs dcnl dcsp epochs load data dcnl dcsp cmap mne analyze colormap format matplotlib dcnl dcsp data min epochs data min dcnl dcsp fig plot topo image epochs epochs sigma 0 5 vmin 200 vmax 200 colorbar true title title cmap cmap dcnl dcsp assert equal epochs data min data min dcnl dcsp fake click fig fig axes2 0 08 0 64 dcnl dcsp plt close all
def test plot tfr topo dcsp import matplotlib pyplot as plt dcnl dcsp epochs get epochs dcnl dcsp n freqs 3 dcnl dcsp nave 1 dcnl dcsp data np random randomstate 0 randn len epochs ch names n freqs len epochs times dcnl dcsp tfr averagetfr epochs info data epochs times np arange n freqs nave dcnl dcsp fig tfr plot topo baseline none 0 mode ratio title average dcsp power vmin 0 0 vmax 14 0 dcnl dcsp num figures before len plt get fignums dcnl dcsp fake click fig fig axes 1 0 08 0 65 dcnl dcsp assert equal num figures before + 1 len plt get fignums dcnl dcsp plt close all dcnl dcsp tfr plot 4 baseline none 0 mode ratio show false title foo dcnl dcsp assert raises valueerror tfr plot 4 yscale lin show false dcnl dcsp freqs np logspace num 3 np log10 3 10 dcnl dcsp tfr averagetfr epochs info data epochs times freqs nave dcnl dcsp fig tfr plot 4 baseline none 0 mode mean vmax 14 0 show false dcnl dcsp assert equal fig axes0 get yaxis get scale log dcnl dcsp tfr averagetfr epochs info data 0 epochs times1 freqs nave dcnl dcsp tfr plot 4 baseline none vmax 14 0 show false yscale linear dcnl dcsp vmin vmax 0 0 2 0 dcnl dcsp fig ax plt subplots dcnl dcsp tmin tmax epochs times0 epochs times 1 dcnl dcsp imshow tfr ax 3 tmin tmax vmin vmax none tfr data 0 freq freqs 1 x label none y label none colorbar false cmap rdbu r true yscale log dcnl dcsp fig plt gcf dcnl dcsp assert equal fig axes0 get yaxis get scale linear dcnl dcsp these freqs freqs 3 copy dcnl dcsp these freqs0 0 dcnl dcsp assert raises valueerror imshow tfr ax 3 tmin tmax vmin vmax none tfr data 3 freq these freqs x label none y label none colorbar false cmap rdbu r true yscale log
def test plot montage dcsp m read montage easycapm1 dcnl dcsp m plot dcnl dcsp m plot kind 3d dcnl dcsp m plot kind 3d show names true dcnl dcsp m plot kind topomap dcnl dcsp m plot kind topomap show names true dcnl dcsp d read dig montage hsp hpi elp point names dcnl dcsp d plot dcnl dcsp d plot kind 3d dcnl dcsp d plot kind 3d show names true
def test plot head positions dcsp import matplotlib pyplot as plt dcnl dcsp pos np random randomstate 0 randn 4 10 dcnl dcsp pos 0 np arange len pos dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp plot head positions pos dcnl dcsp dcsp if check version matplotlib 1 4 dcnl dcsp dcsp dcsp plot head positions pos mode field dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert raises runtimeerror plot head positions pos mode field dcnl dcsp assert raises valueerror plot head positions pos foo dcnl dcsp plt close all
testing requires testing data dcnl requires pysurfer dcnl requires mayavi dcnl def test plot sparse source estimates dcsp sample src read source spaces src fname dcnl dcsp vertices s vertno for s in sample src dcnl dcsp n time 5 dcnl dcsp n verts sum len v for v in vertices dcnl dcsp stc data np zeros n verts n time dcnl dcsp stc size stc data size dcnl dcsp stc data np random rand stc size 20 stc size astype int np random randomstate 0 rand stc data size 20 dcnl dcsp stc data shape n verts n time dcnl dcsp stc sourceestimate stc data vertices 1 1 dcnl dcsp colormap mne analyze dcnl dcsp plot source estimates stc sample colormap colormap background 1 1 0 subjects dir subjects dir colorbar true clim auto dcnl dcsp assert raises typeerror plot source estimates stc sample figure foo hemi both clim auto subjects dir subjects dir dcnl dcsp vertices sample src0 vertno dcnl dcsp inds 111 333 dcnl dcsp stc data np zeros len inds n time dcnl dcsp stc data 0 1 1 0 dcnl dcsp stc data 1 4 2 0 dcnl dcsp vertices verticesinds np empty 0 dtype np int dcnl dcsp stc sourceestimate stc data vertices 1 1 dcnl dcsp plot sparse source estimates sample src stc bgcolor 1 1 1 opacity 0 5 high resolution false
testing requires testing data dcnl requires mayavi dcnl def test plot evoked field dcsp evoked read evokeds evoked fname condition left dcsp auditory baseline 0 2 0 0 dcnl dcsp evoked pick channels evoked evoked evoked ch names 10 dcnl dcsp for t in meg none dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp maps make field map evoked trans fname subject sample subjects dir subjects dir n jobs 1 ch type t dcnl dcsp dcsp evoked plot field maps time 0 1
testing requires testing data dcnl requires mayavi dcnl def test plot alignment dcsp tempdir tempdir dcnl dcsp fiducials path op join tempdir fiducials fif dcnl dcsp fid coord frame 5 ident 1 kind 1 r 0 08061612 0 02908875 0 04131077 coord frame 5 ident 2 kind 1 r 0 00146763 0 08506715 0 03483611 coord frame 5 ident 3 kind 1 r 0 08436285 0 02850276 0 04127743 dcnl dcsp write dig fiducials path fid 5 dcnl dcsp mlab import mlab dcnl dcsp evoked read evokeds evoked fname 0 dcnl dcsp sample src read source spaces src fname dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp bti read raw bti pdf fname config fname hs fname convert true preload false info dcnl dcsp infos dict neuromag evoked info ctf read raw ctf ctf fname info bti bti kit read raw kit sqd fname info dcnl dcsp for system info in infos items dcnl dcsp dcsp meg helmet sensors dcnl dcsp dcsp if system kit dcnl dcsp dcsp dcsp meg append ref dcnl dcsp dcsp plot alignment info trans fname subject sample subjects dir subjects dir meg meg dcnl dcsp dcsp mlab close all true dcnl dcsp plot trans infos kit none meg sensors true ref meg true dcnl dcsp mlab close all true dcnl dcsp info infos neuromag dcnl dcsp assert raises typeerror plot alignment foo trans fname subject sample subjects dir subjects dir dcnl dcsp assert raises typeerror plot alignment info trans fname subject sample subjects dir subjects dir src foo dcnl dcsp assert raises valueerror plot alignment info trans fname subject fsaverage subjects dir subjects dir src sample src dcnl dcsp sample src plot subjects dir subjects dir head true skull true brain white dcnl dcsp mlab close all true dcnl dcsp plot trans info none meg sensors true dig true coord frame head dcnl dcsp mlab close all true dcnl dcsp for coord frame in meg head mri dcnl dcsp dcsp plot alignment info meg helmet sensors dig true coord frame coord frame trans trans fname subject sample mri fiducials fiducials path subjects dir subjects dir src sample src dcnl dcsp dcsp mlab close all true dcnl dcsp evoked eeg ecog evoked copy pick types meg false eeg true dcnl dcsp evoked eeg ecog info projs dcnl dcsp evoked eeg ecog set channel types eeg dcsp 001 ecog dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp plot alignment evoked eeg ecog info subject sample trans trans fname subjects dir subjects dir surfaces white outer skin outer skull meg helmet sensors eeg original projected ecog true dcnl dcsp mlab close all true dcnl dcsp assert true cannot dcsp plot dcsp meg in str ww message for ww in w dcnl dcsp sphere make sphere model info evoked info r0 auto head radius auto dcnl dcsp bem sol read bem solution op join subjects dir sample bem sample128012801280bemsol fif dcnl dcsp bem surfs read bem surfaces op join subjects dir sample bem sample128012801280bem fif dcnl dcsp sample src0 coord frame 4 dcnl dcsp plot alignment info trans fname subject sample meg helmet subjects dir subjects dir eeg projected bem sphere surfaces head brain inner skull outer skull src sample src dcnl dcsp plot alignment info trans fname subject sample meg subjects dir subjects dir bem bem sol eeg true surfaces head inflated outer skull inner skull dcnl dcsp plot alignment info trans fname subject sample meg true subjects dir subjects dir surfaces head inner skull bem bem surfs dcnl dcsp sphere make sphere model auto none evoked info dcnl dcsp plot alignment info trans fname subject sample meg false coord frame mri subjects dir subjects dir surfaces brain bem sphere dcnl dcsp assert raises valueerror plot alignment info info trans trans fname subject sample subjects dir subjects dir surfaces brain head inner skull bem sphere dcnl dcsp assert raises valueerror plot alignment info info trans trans fname subject sample subjects dir subjects dir eeg foo dcnl dcsp assert raises valueerror plot alignment info info trans trans fname subject sample subjects dir subjects dir meg bar dcnl dcsp assert raises valueerror plot alignment info info trans trans fname subject sample subjects dir subjects dir surfaces white pial
testing requires testing data dcnl requires pysurfer dcnl requires mayavi dcnl def test limits to control points dcsp sample src read source spaces src fname dcnl dcsp kwargs dict subjects dir subjects dir smoothing steps 1 dcnl dcsp vertices s vertno for s in sample src dcnl dcsp n time 5 dcnl dcsp n verts sum len v for v in vertices dcnl dcsp stc data np random randomstate 0 rand n verts n time dcnl dcsp stc data shape n verts n time dcnl dcsp stc sourceestimate stc data vertices 1 1 sample dcnl dcsp mlab import mlab dcnl dcsp stc plot kwargs dcnl dcsp stc plot clim dict pos lims 10 50 90 kwargs dcnl dcsp stc plot colormap hot clim auto kwargs dcnl dcsp stc plot colormap mne clim auto kwargs dcnl dcsp figs mlab figure mlab figure dcnl dcsp stc plot clim dict kind value lims 10 50 90 figure 99 kwargs dcnl dcsp assert raises valueerror stc plot clim auto figure figs kwargs dcnl dcsp assert raises keyerror plot source estimates stc colormap mne clim dict kind value lims 5 10 15 kwargs dcnl dcsp assert raises keyerror plot source estimates stc colormap hot clim dict kind value pos lims 5 10 15 kwargs dcnl dcsp assert raises valueerror stc plot clim dict kind value pos lims 0 1 0 kwargs dcnl dcsp assert raises valueerror stc plot colormap mne clim dict pos lims 5 10 15 20 kwargs dcnl dcsp assert raises valueerror stc plot clim dict pos lims 5 10 15 kind foo kwargs dcnl dcsp assert raises valueerror stc plot colormap mne clim foo kwargs dcnl dcsp assert raises valueerror stc plot clim 5 10 15 kwargs dcnl dcsp assert raises valueerror plot source estimates foo clim auto kwargs dcnl dcsp assert raises valueerror stc plot hemi foo clim auto kwargs dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp stc data fill 0 0 dcnl dcsp dcsp plot source estimates stc kwargs dcnl dcsp dcsp assert equal len w 1 dcnl dcsp mlab close all true
testing requires testing data dcnl requires nibabel dcnl def test stc mpl dcsp import matplotlib pyplot as plt dcnl dcsp sample src read source spaces src fname dcnl dcsp vertices s vertno for s in sample src dcnl dcsp n time 5 dcnl dcsp n verts sum len v for v in vertices dcnl dcsp stc data np ones n verts n time dcnl dcsp stc data shape n verts n time dcnl dcsp stc sourceestimate stc data vertices 1 1 sample dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp stc plot subjects dir subjects dir time unit s views ven hemi rh smoothing steps 2 subject sample backend matplotlib spacing oct1 initial time 0 001 colormap reds dcnl dcsp dcsp fig stc plot subjects dir subjects dir time unit ms views dor hemi lh smoothing steps 2 subject sample backend matplotlib spacing ico2 time viewer true dcnl dcsp time viewer fig time viewer dcnl dcsp fake click time viewer time viewer axes0 0 5 0 5 dcnl dcsp time viewer canvas key press event ctrl+right dcnl dcsp time viewer canvas key press event left dcnl dcsp assert raises valueerror stc plot subjects dir subjects dir hemi both subject sample backend matplotlib dcnl dcsp assert raises valueerror stc plot subjects dir subjects dir time unit ss subject sample backend matplotlib dcnl dcsp plt close all
testing requires testing data dcnl requires nibabel dcnl def test plot dipole mri orthoview dcsp import matplotlib pyplot as plt dcnl dcsp dipoles read dipole dip fname dcnl dcsp trans read trans trans fname dcnl dcsp for coord frame idx show all in zip head mri gof amplitude true false dcnl dcsp dcsp fig dipoles plot locations trans sample subjects dir coord frame coord frame idx idx show all show all mode orthoview dcnl dcsp dcsp fig canvas scroll event 0 5 0 5 1 dcnl dcsp dcsp fig canvas scroll event 0 5 0 5 1 dcnl dcsp dcsp fig canvas key press event up dcnl dcsp dcsp fig canvas key press event down dcnl dcsp dcsp fig canvas key press event a dcnl dcsp ax plt subplot 111 dcnl dcsp assert raises valueerror dipoles plot locations trans sample subjects dir ax ax dcnl dcsp plt close all
requires mayavi dcnl def test snapshot brain montage dcsp info read info evoked fname dcnl dcsp fig plot trans info trans none subject sample skull outer skull inner skull subjects dir subjects dir dcnl dcsp xyz np vstack ich loc 3 for ich in info chs dcnl dcsp ch names ich ch name for ich in info chs dcnl dcsp xyz dict dict zip ch names xyz dcnl dcsp xyz dictinfo chs 0 ch name 1 2 dcnl dcsp assert raises valueerror snapshot brain montage fig xyz dcnl dcsp assert raises valueerror snapshot brain montage fig xyz dict dcnl dcsp assert raises typeerror snapshot brain montage fig info
def get picks raw dcsp return pick types raw info meg true eeg false stim false ecg false eog false exclude bads
def get epochs dcsp raw read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks get picks raw dcnl dcsp picks np round np linspace 0 len picks + 1 n chan astype int dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs epochs raw events 5 event id tmin tmax picks picks dcnl dcsp return epochs
def get epochs delayed ssp dcsp raw read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks get picks raw dcnl dcsp reject dict mag 4e12 dcnl dcsp epochs delayed ssp epochs raw events 10 event id tmin tmax picks picks proj delayed reject reject dcnl dcsp return epochs delayed ssp
def test plot epochs dcsp import matplotlib pyplot as plt dcnl dcsp epochs get epochs dcnl dcsp epochs info lowpass 10 0 dcnl dcsp epochs info normalize proj dcnl dcsp epochs plot scalings none title epochs dcnl dcsp plt close all dcnl dcsp fig epochs0 plot picks 0 2 3 scalings none dcnl dcsp fig canvas key press event escape dcnl dcsp plt close all dcnl dcsp fig epochs plot dcnl dcsp fig canvas key press event left dcnl dcsp fig canvas key press event right dcnl dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp fig canvas scroll event 0 5 0 5 0 5 dcnl dcsp fig canvas key press event up dcnl dcsp fig canvas key press event down dcnl dcsp fig canvas key press event pageup dcnl dcsp fig canvas key press event pagedown dcnl dcsp fig canvas key press event dcnl dcsp fig canvas key press event + dcnl dcsp fig canvas key press event dcnl dcsp fig canvas key press event b dcnl dcsp fig canvas key press event f11 dcnl dcsp fig canvas key press event home dcnl dcsp fig canvas key press event dcnl dcsp fig canvas key press event h dcnl dcsp fig canvas key press event o dcnl dcsp fig canvas key press event end dcnl dcsp fig canvas resize event dcnl dcsp fig canvas close event dcnl dcsp plt close all dcnl dcsp assert raises runtimeerror epochs plot picks dcnl dcsp plt close all dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp fig epochs plot events epochs events dcnl dcsp dcsp x fig get axes 0 get xlim 1 2 dcnl dcsp dcsp y fig get axes 0 get ylim 0 2 dcnl dcsp dcsp data ax fig get axes 0 dcnl dcsp dcsp n epochs len epochs dcnl dcsp dcsp fake click fig data ax x y xform data dcnl dcsp dcsp fake click fig data ax x y xform data dcnl dcsp dcsp fake click fig data ax 0 5 0 999 dcnl dcsp dcsp fake click fig data ax 0 1 0 9 dcnl dcsp dcsp fake click fig data ax 0 1 0 9 button 3 dcnl dcsp dcsp fake click fig fig get axes 2 0 5 0 5 dcnl dcsp dcsp fake click fig fig get axes 3 0 5 0 5 dcnl dcsp dcsp fig canvas close event dcnl dcsp dcsp assert n epochs 1 len epochs dcnl dcsp dcsp plt close all dcnl dcsp epochs plot sensors dcnl dcsp plt close all
def test plot epochs image dcsp import matplotlib pyplot as plt dcnl dcsp epochs get epochs dcnl dcsp epochs plot image picks 1 2 dcnl dcsp overlay times 0 1 dcnl dcsp epochs plot image order 0 overlay times overlay times vmin 0 01 dcnl dcsp epochs plot image overlay times overlay times vmin 0 001 vmax 0 001 dcnl dcsp assert raises valueerror epochs plot image overlay times 0 1 0 2 dcnl dcsp assert raises valueerror epochs plot image order 0 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp epochs plot image overlay times 1 1 dcnl dcsp dcsp warnings simplefilter always dcnl dcsp assert equal len w 1 dcnl dcsp plt close all
def test plot drop log dcsp import matplotlib pyplot as plt dcnl dcsp epochs get epochs dcnl dcsp assert raises valueerror epochs plot drop log dcnl dcsp epochs drop bad dcnl dcsp warnings simplefilter always userwarning dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs plot drop log dcnl dcsp dcsp plot drop log one dcnl dcsp dcsp plot drop log one two dcnl dcsp dcsp plot drop log one one two dcnl dcsp plt close all
requires version scipy 0 12 dcnl def test plot psd epochs dcsp import matplotlib pyplot as plt dcnl dcsp epochs get epochs dcnl dcsp epochs plot psd dcnl dcsp assert raises runtimeerror epochs plot psd topomap bands 0 0 01 foo dcnl dcsp epochs plot psd topomap dcnl dcsp plt close all
def test plot connectivity circle dcsp import matplotlib pyplot as plt dcnl dcsp node order frontalpolelh parsorbitalislh lateralorbitofrontallh rostralmiddlefrontallh medialorbitofrontallh parstriangularislh rostralanteriorcingulatelh temporalpolelh parsopercularislh caudalanteriorcingulatelh entorhinallh superiorfrontallh insulalh caudalmiddlefrontallh superiortemporallh parahippocampallh middletemporallh inferiortemporallh precentrallh transversetemporallh posteriorcingulatelh fusiformlh postcentrallh banksstslh supramarginallh isthmuscingulatelh paracentrallh linguallh precuneuslh inferiorparietallh superiorparietallh pericalcarinelh lateraloccipitallh cuneuslh cuneusrh lateraloccipitalrh pericalcarinerh superiorparietalrh inferiorparietalrh precuneusrh lingualrh paracentralrh isthmuscingulaterh supramarginalrh banksstsrh postcentralrh fusiformrh posteriorcingulaterh transversetemporalrh precentralrh inferiortemporalrh middletemporalrh parahippocampalrh superiortemporalrh caudalmiddlefrontalrh insularh superiorfrontalrh entorhinalrh caudalanteriorcingulaterh parsopercularisrh temporalpolerh rostralanteriorcingulaterh parstriangularisrh medialorbitofrontalrh rostralmiddlefrontalrh lateralorbitofrontalrh parsorbitalisrh frontalpolerh dcnl dcsp label names banksstslh banksstsrh caudalanteriorcingulatelh caudalanteriorcingulaterh caudalmiddlefrontallh caudalmiddlefrontalrh cuneuslh cuneusrh entorhinallh entorhinalrh frontalpolelh frontalpolerh fusiformlh fusiformrh inferiorparietallh inferiorparietalrh inferiortemporallh inferiortemporalrh insulalh insularh isthmuscingulatelh isthmuscingulaterh lateraloccipitallh lateraloccipitalrh lateralorbitofrontallh lateralorbitofrontalrh linguallh lingualrh medialorbitofrontallh medialorbitofrontalrh middletemporallh middletemporalrh paracentrallh paracentralrh parahippocampallh parahippocampalrh parsopercularislh parsopercularisrh parsorbitalislh parsorbitalisrh parstriangularislh parstriangularisrh pericalcarinelh pericalcarinerh postcentrallh postcentralrh posteriorcingulatelh posteriorcingulaterh precentrallh precentralrh precuneuslh precuneusrh rostralanteriorcingulatelh rostralanteriorcingulaterh rostralmiddlefrontallh rostralmiddlefrontalrh superiorfrontallh superiorfrontalrh superiorparietallh superiorparietalrh superiortemporallh superiortemporalrh supramarginallh supramarginalrh temporalpolelh temporalpolerh transversetemporallh transversetemporalrh dcnl dcsp group boundaries 0 len label names 2 dcnl dcsp node angles circular layout label names node order start pos 90 group boundaries group boundaries dcnl dcsp con np random randomstate 0 randn 68 68 dcnl dcsp plot connectivity circle con label names n lines 300 node angles node angles title test dcnl dcsp assert raises valueerror circular layout label names node order group boundaries 1 dcnl dcsp assert raises valueerror circular layout label names node order group boundaries 20 0 dcnl dcsp plt close all
def get data tmin 0 2 tmax 0 5 event id dict aud l 1 vis l 3 event id gen dict aud l 2 vis l 4 test times none dcsp gat generalizationacrosstime dcnl dcsp raw read raw fif raw fname dcnl dcsp raw add proj remove existing true dcnl dcsp events read events event name dcnl dcsp picks pick types raw info meg mag stim false ecg false eog false exclude bads dcnl dcsp picks picks1 13 3 dcnl dcsp decim 30 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs epochs raw events event id tmin tmax picks picks preload true decim decim dcnl dcsp epochs list epochsk for k in event id dcnl dcsp equalize epoch counts epochs list dcnl dcsp epochs concatenate epochs epochs list dcnl dcsp gat generalizationacrosstime test times test times dcnl dcsp gat fit epochs dcnl dcsp gat score epochs dcnl dcsp return gat
requires sklearn dcnl def test gat plot matrix dcsp gat get data dcnl dcsp gat plot dcnl dcsp del gat scores dcnl dcsp assert raises runtimeerror gat plot
requires sklearn dcnl def test gat plot diagonal dcsp gat get data dcnl dcsp gat plot diagonal dcnl dcsp del gat scores dcnl dcsp assert raises runtimeerror gat plot
requires sklearn dcnl def test gat plot times dcsp gat get data dcnl dcsp gat plot times gat train times times 0 dcnl dcsp gat plot times gat train times times dcnl dcsp n times len gat train times times dcnl dcsp colors np tile r g b int np ceil n times 3 n times dcnl dcsp gat plot times gat train times times color colors dcnl dcsp assert raises valueerror gat plot times 1 0 dcnl dcsp assert raises valueerror gat plot times 1 dcnl dcsp assert raises valueerror gat plot times diagonal dcnl dcsp del gat scores dcnl dcsp assert raises runtimeerror gat plot
requires sklearn dcnl def test gat chance level dcsp gat get data dcnl dcsp ax gat plot diagonal chance false dcnl dcsp ax gat plot diagonal dcnl dcsp assert equals chance ax 0 5 dcnl dcsp gat get data event id dict aud l 1 vis l 3 aud r 2 vis r 4 dcnl dcsp ax gat plot diagonal dcnl dcsp assert equals chance ax 0 25 dcnl dcsp ax gat plot diagonal chance 1 234 dcnl dcsp assert equals chance ax 1 234 dcnl dcsp assert raises valueerror gat plot diagonal chance foo dcnl dcsp del gat scores dcnl dcsp assert raises runtimeerror gat plot
requires sklearn dcnl def test gat plot nonsquared dcsp gat get data test times dict start 0 0 dcnl dcsp gat plot dcnl dcsp ax gat plot diagonal dcnl dcsp scores ax get children 1 get lines 2 get ydata dcnl dcsp assert equals len scores len gat estimators
def test mne analyze colormap dcsp assert raises valueerror mne analyze colormap 0 dcnl dcsp assert raises valueerror mne analyze colormap 1 1 2 dcnl dcsp assert raises valueerror mne analyze colormap 0 2 1
def test clickable image dcsp import matplotlib pyplot as plt dcnl dcsp im np random randomstate 0 randn 100 100 dcnl dcsp clk clickableimage im dcnl dcsp clicks 12 8 46 48 10 24 dcnl dcsp for click in clicks dcnl dcsp dcsp fake click clk fig clk ax click xform data dcnl dcsp assert allclose np array clicks np array clk coords dcnl dcsp assert true len clicks len clk coords dcnl dcsp lt clk to layout dcnl dcsp assert true lt pos shape0 len clicks dcnl dcsp assert allclose lt pos 1 0 lt pos 2 0 clicks10 float clicks20 dcnl dcsp clk plot clicks dcnl dcsp plt close all
def test add background image dcsp import matplotlib pyplot as plt dcnl dcsp rng np random randomstate 0 dcnl dcsp f axs plt subplots 1 2 dcnl dcsp x y rng randn 2 10 dcnl dcsp im rng randn 10 10 dcnl dcsp axs0 scatter x y dcnl dcsp axs1 scatter y x dcnl dcsp for ax in axs dcnl dcsp dcsp ax set aspect 1 dcnl dcsp ax im add background image f im dcnl dcsp assert true ax im get aspect auto dcnl dcsp for ax in axs dcnl dcsp dcsp assert true ax get aspect 1 dcnl dcsp ax im asp add background image f im set ratios auto dcnl dcsp assert true ax im asp get aspect auto dcnl dcsp for ax in axs dcnl dcsp dcsp assert true ax get aspect auto dcnl dcsp assert true add background image f none is none
def test auto scale dcsp raw read raw fif raw fname dcnl dcsp epochs epochs raw read events ev fname dcnl dcsp rand data np random randn 10 100 dcnl dcsp for inst in raw epochs dcnl dcsp dcsp scale grad 10000000000 0 dcnl dcsp dcsp scalings def dict eeg auto grad scale grad stim auto dcnl dcsp dcsp assert raises valueerror inst plot scalings foo dcnl dcsp dcsp assert raises valueerror compute scalings foo inst dcnl dcsp dcsp scalings new compute scalings scalings def inst dcnl dcsp dcsp assert true scale grad scalings new grad dcnl dcsp dcsp assert true scalings new eeg auto dcnl dcsp assert raises valueerror compute scalings scalings def rand data dcnl dcsp epochs epochs0 load data dcnl dcsp epochs pick types eeg true meg false dcnl dcsp assert raises valueerror compute scalings dict grad auto epochs
def test validate if list of axes dcsp import matplotlib pyplot as plt dcnl dcsp fig ax plt subplots 2 2 dcnl dcsp assert raises valueerror validate if list of axes ax dcnl dcsp ax flat ax ravel dcnl dcsp ax ax ravel tolist dcnl dcsp validate if list of axes ax flat dcnl dcsp validate if list of axes ax flat 4 dcnl dcsp assert raises valueerror validate if list of axes ax flat 5 dcnl dcsp assert raises valueerror validate if list of axes ax 3 dcnl dcsp assert raises valueerror validate if list of axes error dcnl dcsp assert raises valueerror validate if list of axes error 2 dcnl dcsp assert raises valueerror validate if list of axes ax0 dcnl dcsp assert raises valueerror validate if list of axes ax 3 dcnl dcsp ax flat2 23 dcnl dcsp assert raises valueerror validate if list of axes ax flat dcnl dcsp validate if list of axes ax 4
def plot montage montage scale factor 20 show names true kind topomap show true dcsp from channels import montage digmontage dcnl dcsp from import create info dcnl dcsp if isinstance montage montage dcnl dcsp dcsp ch names montage ch names dcnl dcsp dcsp title montage kind dcnl dcsp elif isinstance montage digmontage dcnl dcsp dcsp ch names montage point names dcnl dcsp dcsp title none dcnl dcsp else dcnl dcsp dcsp raise typeerror montage dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp mne channels montage montage dcsp ormne channels montage digmontage dcnl dcsp if kind not in topomap 3d dcnl dcsp dcsp raise valueerror kind dcsp must dcsp be dcsp topomap dcsp or dcsp 3d dcnl dcsp info create info ch names sfreq 256 ch types eeg montage montage dcnl dcsp fig plot sensors info kind kind show names show names show show title title dcnl dcsp collection fig axes0 collections0 dcnl dcsp if check version matplotlib 1 4 dcnl dcsp dcsp collection set sizes scale factor dcnl dcsp else dcnl dcsp dcsp collection sizes scale factor dcnl dcsp return fig
def prepare topo plot inst ch type layout dcsp info copy deepcopy inst if isinstance inst info else inst info dcnl dcsp if layout is none and ch type is not eeg dcnl dcsp dcsp from channels import find layout dcnl dcsp dcsp layout find layout info dcnl dcsp elif layout auto dcnl dcsp dcsp layout none dcnl dcsp clean ch names clean names info ch names dcnl dcsp for ii this ch in enumerate info chs dcnl dcsp dcsp this ch ch name clean ch namesii dcnl dcsp info update redundant dcnl dcsp info check consistency dcnl dcsp if ch type grad and fiff fiffv coil vv planar t1 in np unique ch coil type for ch in info chs dcnl dcsp dcsp from channels layout import pair grad sensors dcnl dcsp dcsp picks pos pair grad sensors info layout dcnl dcsp dcsp merge grads true dcnl dcsp else dcnl dcsp dcsp merge grads false dcnl dcsp dcsp if ch type eeg dcnl dcsp dcsp dcsp picks pick types info meg false eeg true ref meg false exclude bads dcnl dcsp dcsp else dcnl dcsp dcsp dcsp picks pick types info meg ch type ref meg false exclude bads dcnl dcsp dcsp if len picks 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp channels dcsp of dcsp type dcsp r ch type dcnl dcsp dcsp if layout is none dcnl dcsp dcsp dcsp pos find topomap coords info picks dcnl dcsp dcsp else dcnl dcsp dcsp dcsp names n upper for n in layout names dcnl dcsp dcsp dcsp pos list dcnl dcsp dcsp dcsp for pick in picks dcnl dcsp dcsp dcsp dcsp this name info ch names pick upper dcnl dcsp dcsp dcsp dcsp if this name in names dcnl dcsp dcsp dcsp dcsp dcsp pos append layout posnames index this name dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp warn failed dcsp to dcsp locate dcsp s dcsp channel dcsp positions dcsp from dcsp layout dcsp inferring dcsp channel dcsp positions dcsp from dcsp data ch type dcnl dcsp dcsp dcsp dcsp dcsp pos find topomap coords info picks dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp ch names info ch names k for k in picks dcnl dcsp if merge grads dcnl dcsp dcsp ch names ch namesk 1 + x for k in range 0 len ch names 2 dcnl dcsp pos np array pos 2 dcnl dcsp return picks pos merge grads ch names ch type
def plot update evoked topomap params bools dcsp projs proj for ii proj in enumerate params projs if ii in np where bools 0 dcnl dcsp params proj bools bools dcnl dcsp new evoked params evoked copy dcnl dcsp new evoked info projs dcnl dcsp new evoked add proj projs dcnl dcsp new evoked apply proj dcnl dcsp data new evoked data params time idx params scale dcnl dcsp if params merge grads dcnl dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp data merge grad data data dcnl dcsp image off ~ params image mask dcnl dcsp pos np asarray params pos 2 dcnl dcsp pos x pos y pos t dcnl dcsp interp griddata pos dcnl dcsp xi np linspace pos x min pos x max params res dcnl dcsp yi np linspace pos y min pos y max params res dcnl dcsp xi yi np meshgrid xi yi dcnl dcsp for ii im in enumerate params images dcnl dcsp dcsp zi interp set values data ii xi yi dcnl dcsp dcsp ziimage off np nan dcnl dcsp dcsp im set data zi dcnl dcsp for cont in params contours dcnl dcsp dcsp cont set array np c xi yi zi dcnl dcsp params fig canvas draw
def plot projs topomap projs layout none cmap none sensors true colorbar false res 64 size 1 show true outlines head contours 6 image interp bilinear axes none dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits axes grid1 import make axes locatable dcnl dcsp if layout is none dcnl dcsp dcsp from channels import read layout dcnl dcsp dcsp layout read layout vectorviewall dcnl dcsp if not isinstance layout list dcnl dcsp dcsp layout layout dcnl dcsp n projs len projs dcnl dcsp nrows math floor math sqrt n projs dcnl dcsp ncols math ceil n projs nrows dcnl dcsp cmap setup cmap cmap dcnl dcsp if axes is none dcnl dcsp dcsp plt figure dcnl dcsp dcsp axes list dcnl dcsp dcsp for idx in range len projs dcnl dcsp dcsp dcsp ax plt subplot nrows ncols idx + 1 dcnl dcsp dcsp dcsp axes append ax dcnl dcsp elif isinstance axes plt axes dcnl dcsp dcsp axes axes dcnl dcsp if len axes len projs dcnl dcsp dcsp raise runtimeerror there dcsp must dcsp be dcsp an dcsp axes dcsp for dcsp each dcsp picked dcsp projector dcnl dcsp for proj idx proj in enumerate projs dcnl dcsp dcsp axesproj idx set title proj desc 10 + dcnl dcsp dcsp ch names clean names proj data col names remove whitespace true dcnl dcsp dcsp data proj data data ravel dcnl dcsp dcsp idx dcnl dcsp dcsp for l in layout dcnl dcsp dcsp dcsp is vv l kind startswith vectorview dcnl dcsp dcsp dcsp if is vv dcnl dcsp dcsp dcsp dcsp from channels layout import pair grad sensors from ch names dcnl dcsp dcsp dcsp dcsp grad pairs pair grad sensors from ch names ch names dcnl dcsp dcsp dcsp dcsp if grad pairs dcnl dcsp dcsp dcsp dcsp dcsp ch names ch namesi for i in grad pairs dcnl dcsp dcsp dcsp l names clean names l names remove whitespace true dcnl dcsp dcsp dcsp idx l names index c for c in ch names if c in l names dcnl dcsp dcsp dcsp if len idx 0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp pos l posidx dcnl dcsp dcsp dcsp if is vv and grad pairs dcnl dcsp dcsp dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp dcsp dcsp shape len idx 2 2 1 dcnl dcsp dcsp dcsp dcsp pos pos reshape shape mean axis 1 dcnl dcsp dcsp dcsp dcsp data merge grad data datagrad pairs ravel dcnl dcsp dcsp dcsp break dcnl dcsp dcsp if len idx dcnl dcsp dcsp dcsp im plot topomap data pos 2 vmax none cmap cmap0 sensors sensors res res axes axesproj idx outlines outlines contours contours image interp image interp show false 0 dcnl dcsp dcsp dcsp if colorbar dcnl dcsp dcsp dcsp dcsp divider make axes locatable axesproj idx dcnl dcsp dcsp dcsp dcsp cax divider append axes right size 5 pad 0 05 dcnl dcsp dcsp dcsp dcsp cbar plt colorbar im cax cax cmap cmap dcnl dcsp dcsp dcsp dcsp if cmap1 dcnl dcsp dcsp dcsp dcsp dcsp axesproj idx cb draggablecolorbar cbar im dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise runtimeerror cannot dcsp find dcsp a dcsp proper dcsp layout dcsp for dcsp projection dcsp s proj desc dcnl dcsp tight layout fig axes0 get figure dcnl dcsp plt show show dcnl dcsp return axes0 get figure
def check outlines pos outlines head pos none dcsp pos np array pos float 2 dcnl dcsp head pos dict if head pos is none else head pos dcnl dcsp if not isinstance head pos dict dcnl dcsp dcsp raise typeerror head pos dcsp must dcsp be dcsp dict dcsp or dcsp none dcnl dcsp head pos copy deepcopy head pos dcnl dcsp for key in head pos keys dcnl dcsp dcsp if key not in center scale dcnl dcsp dcsp dcsp raise keyerror head pos dcsp must dcsp only dcsp contain dcsp center dcsp and dcsp scale dcnl dcsp dcsp head poskey np array head poskey float dcnl dcsp dcsp if head poskey shape 2 dcnl dcsp dcsp dcsp raise valueerror head pos s dcsp must dcsp have dcsp shape dcsp 2 dcsp not dcsp s key head poskey shape dcnl dcsp if isinstance outlines np ndarray or outlines in head skirt none dcnl dcsp dcsp radius 0 5 dcnl dcsp dcsp l np linspace 0 2 np pi 101 dcnl dcsp dcsp head x np cos l radius dcnl dcsp dcsp head y np sin l radius dcnl dcsp dcsp nose x np array 0 18 0 0 18 radius dcnl dcsp dcsp nose y np array radius 0 004 radius 1 15 radius 0 004 dcnl dcsp dcsp ear x np array 0 497 0 51 0 518 0 5299 0 5419 0 54 0 547 0 532 0 51 0 489 dcnl dcsp dcsp ear y np array 0 0555 0 0775 0 0783 0 0746 0 0555 0 0055 0 0932 0 1313 0 1384 0 1199 dcnl dcsp dcsp if center not in head pos dcnl dcsp dcsp dcsp head pos center 0 5 pos max axis 0 + pos min axis 0 dcnl dcsp dcsp pos head pos center dcnl dcsp dcsp if outlines is not none dcnl dcsp dcsp dcsp outlines dict dict head head x head y nose nose x nose y ear left ear x ear y ear right ear x ear y dcnl dcsp dcsp else dcnl dcsp dcsp dcsp outlines dict dict dcnl dcsp dcsp if isinstance outlines string types and outlines skirt dcnl dcsp dcsp dcsp if scale not in head pos dcnl dcsp dcsp dcsp dcsp head pos scale 1 0 pos max axis 0 pos min axis 0 dcnl dcsp dcsp dcsp pos head pos scale dcnl dcsp dcsp dcsp mask scale 1 25 pos max axis 0 pos min axis 0 dcnl dcsp dcsp dcsp outlines dict autoshrink false dcnl dcsp dcsp dcsp outlines dict mask pos mask scale0 head x mask scale1 head y dcnl dcsp dcsp dcsp outlines dict clip radius mask scale 2 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if scale not in head pos dcnl dcsp dcsp dcsp dcsp head pos scale 0 85 pos max axis 0 pos min axis 0 dcnl dcsp dcsp dcsp pos head pos scale dcnl dcsp dcsp dcsp outlines dict mask pos head x head y dcnl dcsp dcsp dcsp if isinstance outlines np ndarray dcnl dcsp dcsp dcsp dcsp outlines dict autoshrink false dcnl dcsp dcsp dcsp dcsp outlines dict clip radius outlines dcnl dcsp dcsp dcsp dcsp x scale np max outlines dict head 0 outlines0 dcnl dcsp dcsp dcsp dcsp y scale np max outlines dict head 1 outlines1 dcnl dcsp dcsp dcsp dcsp for key in head nose ear left ear right dcnl dcsp dcsp dcsp dcsp dcsp value outlines dictkey dcnl dcsp dcsp dcsp dcsp dcsp value value0 x scale value1 y scale dcnl dcsp dcsp dcsp dcsp dcsp outlines dictkey value dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp outlines dict autoshrink true dcnl dcsp dcsp dcsp dcsp outlines dict clip radius 0 5 0 5 dcnl dcsp dcsp outlines outlines dict dcnl dcsp elif isinstance outlines dict dcnl dcsp dcsp if mask pos not in outlines dcnl dcsp dcsp dcsp raise valueerror you dcsp must dcsp specify dcsp the dcsp coordinates dcsp of dcsp the dcsp image dcsp mask dcnl dcsp else dcnl dcsp dcsp raise valueerror invalid dcsp value dcsp for dcsp outlines dcnl dcsp return pos outlines
def draw outlines ax outlines dcsp outlines dict k v for k v in outlines items if k not in patch autoshrink dcnl dcsp for key x coord y coord in outlines items dcnl dcsp dcsp if mask in key dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp ax plot x coord y coord color k linewidth 1 clip on false dcnl dcsp return outlines
def plot sensors pos x pos y sensors ax dcsp if sensors is true dcnl dcsp dcsp ax scatter pos x pos y s 0 25 marker o edgecolor k len pos x facecolor none dcnl dcsp else dcnl dcsp dcsp ax plot pos x pos y sensors
def plot topomap data pos vmin none vmax none cmap none sensors true res 64 axes none names none show names false mask none mask params none outlines head image mask none contours 6 image interp bilinear show true head pos none onselect none dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib widgets import rectangleselector dcnl dcsp if contours is none or contours is false dcnl dcsp dcsp warn using dcsp s dcsp as dcsp contours dcsp is dcsp deprecated dcsp and dcsp will dcsp not dcsp be dcsp allowed dcsp in dcsp 0 16 dcsp use dcsp 0 dcsp instead str contours deprecationwarning dcnl dcsp dcsp contours 0 dcnl dcsp data np asarray data dcnl dcsp logger debug plotting dcsp topomap dcsp for dcsp data dcsp shape dcsp s data shape dcnl dcsp if isinstance pos info dcnl dcsp dcsp picks pick data channels pos dcnl dcsp dcsp pos pick info pos picks dcnl dcsp dcsp ch type set channel type pos idx for idx in enumerate pos chs dcnl dcsp dcsp info help pick dcsp info dcsp with dcsp e g dcsp mne pick info dcsp and dcsp mne channels channel indices by type dcnl dcsp dcsp if len ch type 1 dcnl dcsp dcsp dcsp raise valueerror multiple dcsp channel dcsp types dcsp in dcsp info dcsp structure dcsp + info help dcnl dcsp dcsp elif len pos chs data shape0 dcnl dcsp dcsp dcsp raise valueerror number dcsp of dcsp channels dcsp in dcsp the dcsp info dcsp object dcsp and dcsp the dcsp data dcsp array dcsp does dcsp not dcsp match dcsp + info help dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ch type ch type pop dcnl dcsp dcsp if any type in ch type for type in planar grad dcnl dcsp dcsp dcsp from channels layout import merge grad data find layout pair grad sensors dcnl dcsp dcsp dcsp picks pos pair grad sensors pos find layout pos dcnl dcsp dcsp dcsp data merge grad data datapicks reshape 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp picks list range data shape0 dcnl dcsp dcsp dcsp pos find topomap coords pos picks picks dcnl dcsp if data ndim 1 dcnl dcsp dcsp raise valueerror data dcsp needs dcsp to dcsp be dcsp array dcsp of dcsp shape dcsp n sensors dcsp got dcsp shape dcsp s str data shape dcnl dcsp pos help electrode dcsp positions dcsp should dcsp be dcsp specified dcsp as dcsp a dcsp 2d dcsp array dcsp with dcsp shape dcsp n channels dcsp 2 dcsp each dcsp row dcsp in dcsp this dcsp matrix dcsp contains dcsp the dcsp x dcsp y dcsp position dcsp of dcsp an dcsp electrode dcnl dcsp if pos ndim 2 dcnl dcsp dcsp error ndim d dcsp array dcsp supplied dcsp as dcsp electrode dcsp positions dcsp where dcsp a dcsp 2d dcsp array dcsp was dcsp expected format ndim pos ndim dcnl dcsp dcsp raise valueerror error + dcsp + pos help dcnl dcsp elif pos shape1 3 dcnl dcsp dcsp error the dcsp supplied dcsp electrode dcsp positions dcsp matrix dcsp contains dcsp 3 dcsp columns dcsp are dcsp you dcsp trying dcsp to dcsp specify dcsp xyz dcsp coordinates dcsp perhaps dcsp the dcsp mne channels create eeg layout dcsp function dcsp is dcsp useful dcsp for dcsp you dcnl dcsp dcsp raise valueerror error + dcsp + pos help dcnl dcsp elif pos shape1 1 or pos shape1 4 dcnl dcsp dcsp raise valueerror pos help dcnl dcsp if len data len pos dcnl dcsp dcsp raise valueerror data dcsp and dcsp pos dcsp need dcsp to dcsp be dcsp of dcsp same dcsp length dcsp got dcsp data dcsp of dcsp length dcsp s dcsp pos dcsp of dcsp length dcsp s len data len pos dcnl dcsp norm min data 0 dcnl dcsp vmin vmax setup vmin vmax data vmin vmax norm dcnl dcsp if cmap is none dcnl dcsp dcsp cmap reds if norm else rdbu r dcnl dcsp pos outlines check outlines pos outlines head pos dcnl dcsp ax axes if axes else plt gca dcnl dcsp pos x pos y prepare topomap pos ax dcnl dcsp if outlines is none dcnl dcsp dcsp xmin xmax pos x min pos x max dcnl dcsp dcsp ymin ymax pos y min pos y max dcnl dcsp else dcnl dcsp dcsp xlim np inf np inf dcnl dcsp dcsp ylim np inf np inf dcnl dcsp dcsp mask np c outlines mask pos dcnl dcsp dcsp xmin xmax np min np r xlim0 mask 0 np max np r xlim1 mask 0 dcnl dcsp dcsp ymin ymax np min np r ylim0 mask 1 np max np r ylim1 mask 1 dcnl dcsp xi np linspace xmin xmax res dcnl dcsp yi np linspace ymin ymax res dcnl dcsp xi yi np meshgrid xi yi dcnl dcsp zi griddata np array pos x pos y t set values data xi yi dcnl dcsp if outlines is none dcnl dcsp dcsp is default outlines false dcnl dcsp elif isinstance outlines dict dcnl dcsp dcsp is default outlines any k startswith head for k in outlines dcnl dcsp if is default outlines and image mask is none dcnl dcsp dcsp image mask pos make image mask outlines pos res dcnl dcsp mask params handle default mask params mask params dcnl dcsp linewidth mask params markeredgewidth dcnl dcsp patch none dcnl dcsp if patch in outlines dcnl dcsp dcsp patch outlines patch dcnl dcsp dcsp patch patch if callable patch else patch dcnl dcsp dcsp patch set clip on false dcnl dcsp dcsp ax add patch patch dcnl dcsp dcsp ax set transform ax transaxes dcnl dcsp dcsp ax set clip path patch dcnl dcsp im ax imshow zi cmap cmap vmin vmin vmax vmax origin lower aspect equal extent xmin xmax ymin ymax interpolation image interp dcnl dcsp no contours false dcnl dcsp if isinstance contours np ndarray list dcnl dcsp dcsp pass dcnl dcsp elif contours 0 dcnl dcsp dcsp contours no contours 1 true dcnl dcsp cont ax contour xi yi zi contours colors k linewidths linewidth dcnl dcsp if no contours dcnl dcsp dcsp for col in cont collections dcnl dcsp dcsp dcsp col set visible false dcnl dcsp if is default outlines dcnl dcsp dcsp from matplotlib import patches dcnl dcsp dcsp patch patches ellipse 0 0 2 outlines clip radius 0 2 outlines clip radius 1 clip on true transform ax transdata dcnl dcsp if is default outlines or patch is not none dcnl dcsp dcsp im set clip path patch dcnl dcsp dcsp if cont is not none dcnl dcsp dcsp dcsp for col in cont collections dcnl dcsp dcsp dcsp dcsp col set clip path patch dcnl dcsp if sensors is not false and mask is none dcnl dcsp dcsp plot sensors pos x pos y sensors sensors ax ax dcnl dcsp elif sensors and mask is not none dcnl dcsp dcsp idx np where mask 0 dcnl dcsp dcsp ax plot pos xidx pos yidx mask params dcnl dcsp dcsp idx np where ~ mask 0 dcnl dcsp dcsp plot sensors pos xidx pos yidx sensors sensors ax ax dcnl dcsp elif not sensors and mask is not none dcnl dcsp dcsp idx np where mask 0 dcnl dcsp dcsp ax plot pos xidx pos yidx mask params dcnl dcsp if isinstance outlines dict dcnl dcsp dcsp draw outlines ax outlines dcnl dcsp if show names dcnl dcsp dcsp if names is none dcnl dcsp dcsp dcsp raise valueerror to dcsp show dcsp names dcsp a dcsp list dcsp of dcsp names dcsp must dcsp be dcsp provided dcsp see dcsp names dcsp keyword dcnl dcsp dcsp if show names is true dcnl dcsp dcsp dcsp def show names x dcnl dcsp dcsp dcsp dcsp return x dcnl dcsp dcsp else dcnl dcsp dcsp dcsp show names show names dcnl dcsp dcsp show idx np arange len names if mask is none else np where mask 0 dcnl dcsp dcsp for ii p ch id in enumerate zip pos names dcnl dcsp dcsp dcsp if ii not in show idx dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp ch id show names ch id dcnl dcsp dcsp dcsp ax text p0 p1 ch id horizontalalignment center verticalalignment center size xsmall dcnl dcsp plt subplots adjust top 0 95 dcnl dcsp if onselect is not none dcnl dcsp dcsp ax rs rectangleselector ax onselect onselect dcnl dcsp plt show show dcnl dcsp return im cont
def make image mask outlines pos res dcsp mask np c outlines mask pos dcnl dcsp xmin xmax np min np r np inf mask 0 np max np r np inf mask 0 dcnl dcsp ymin ymax np min np r np inf mask 1 np max np r np inf mask 1 dcnl dcsp if outlines get autoshrink false is not false dcnl dcsp dcsp inside inside contour pos mask dcnl dcsp dcsp outside np invert inside dcnl dcsp dcsp outlier points posoutside dcnl dcsp dcsp while np any outlier points dcnl dcsp dcsp dcsp pos 0 99 dcnl dcsp dcsp dcsp inside inside contour pos mask dcnl dcsp dcsp dcsp outside np invert inside dcnl dcsp dcsp dcsp outlier points posoutside dcnl dcsp image mask np zeros res res dtype bool dcnl dcsp xi mask np linspace xmin xmax res dcnl dcsp yi mask np linspace ymin ymax res dcnl dcsp xi mask yi mask np meshgrid xi mask yi mask dcnl dcsp pos np c xi mask flatten yi mask flatten dcnl dcsp inds inside contour pos mask dcnl dcsp image maskinds reshape image mask shape true dcnl dcsp return image mask pos
def inside contour pos contour dcsp npos len pos dcnl dcsp x y pos 2 t dcnl dcsp check mask np ones npos dtype bool dcnl dcsp check mask x < np min x | y < np min y | x np max x | y np max y false dcnl dcsp critval 0 1 dcnl dcsp contourx contour 0 pos check mask 0 np newaxis dcnl dcsp contoury contour 1 pos check mask 1 np newaxis dcnl dcsp angle np arctan2 contoury contourx dcnl dcsp angle np unwrap angle dcnl dcsp check maskcheck mask np abs np sum np diff angle axis 1 axis 1 critval dcnl dcsp return check mask
def plot ica topomap ica idx 0 ch type none res 64 layout none vmin none vmax none cmap rdbu r colorbar false title none show true outlines head contours 6 image interp bilinear head pos none axes none sensors true dcsp import matplotlib as mpl dcnl dcsp from channels import get ch type dcnl dcsp if ica info is none dcnl dcsp dcsp raise runtimeerror the dcsp ica s dcsp measurement dcsp info dcsp is dcsp missing dcsp please dcsp fit dcsp the dcsp ica dcsp or dcsp add dcsp the dcsp corresponding dcsp info dcsp object dcnl dcsp if not isinstance axes mpl axes axes dcnl dcsp dcsp raise valueerror axis dcsp has dcsp to dcsp be dcsp an dcsp instance dcsp of dcsp matplotlib dcsp axes dcsp got dcsp s dcsp instead type axes dcnl dcsp ch type get ch type ica ch type dcnl dcsp data ica get components idx dcnl dcsp data picks pos merge grads names prepare topo plot ica ch type layout dcnl dcsp pos outlines check outlines pos outlines head pos dcnl dcsp if outlines not in none head dcnl dcsp dcsp image mask pos make image mask outlines pos res dcnl dcsp else dcnl dcsp dcsp image mask none dcnl dcsp data datadata picks dcnl dcsp if merge grads dcnl dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp data merge grad data data dcnl dcsp axes set title ic dcsp 03d idx fontsize 12 dcnl dcsp vmin vmax setup vmin vmax data vmin vmax dcnl dcsp im plot topomap data ravel pos vmin vmin vmax vmax res res axes axes cmap cmap outlines outlines image mask image mask contours contours sensors sensors image interp image interp show show 0 dcnl dcsp if colorbar dcnl dcsp dcsp import matplotlib pyplot as plt dcnl dcsp dcsp from mpl toolkits axes grid1 import make axes locatable dcnl dcsp dcsp divider make axes locatable axes dcnl dcsp dcsp cax divider append axes right size 5 pad 0 05 dcnl dcsp dcsp cbar plt colorbar im cax cax format 3 2f cmap cmap dcnl dcsp dcsp cbar ax tick params labelsize 12 dcnl dcsp dcsp cbar set ticks vmin vmax dcnl dcsp dcsp cbar ax set title au fontsize 10 dcnl dcsp hide frame axes
def plot ica components ica picks none ch type none res 64 layout none vmin none vmax none cmap rdbu r sensors true colorbar false title none show true outlines head contours 6 image interp bilinear head pos none inst none dcsp from io import baseraw dcnl dcsp from epochs import baseepochs dcnl dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits axes grid1 import make axes locatable dcnl dcsp from channels import get ch type dcnl dcsp if picks is none dcnl dcsp dcsp ch type get ch type ica ch type dcnl dcsp dcsp n components ica mixing matrix shape1 dcnl dcsp dcsp p 20 dcnl dcsp dcsp figs dcnl dcsp dcsp for k in range 0 n components p dcnl dcsp dcsp dcsp picks range k min k + p n components dcnl dcsp dcsp dcsp fig plot ica components ica picks picks ch type ch type res res layout layout vmax vmax cmap cmap sensors sensors colorbar colorbar title title show show outlines outlines contours contours image interp image interp head pos head pos inst inst dcnl dcsp dcsp dcsp figs append fig dcnl dcsp dcsp return figs dcnl dcsp elif np isscalar picks dcnl dcsp dcsp picks picks dcnl dcsp ch type get ch type ica ch type dcnl dcsp cmap setup cmap cmap n axes len picks dcnl dcsp data np dot ica mixing matrix picks t ica pca components ica n components dcnl dcsp if ica info is none dcnl dcsp dcsp raise runtimeerror the dcsp ica s dcsp measurement dcsp info dcsp is dcsp missing dcsp please dcsp fit dcsp the dcsp ica dcsp or dcsp add dcsp the dcsp corresponding dcsp info dcsp object dcnl dcsp data picks pos merge grads names prepare topo plot ica ch type layout dcnl dcsp pos outlines check outlines pos outlines head pos dcnl dcsp if outlines not in none head dcnl dcsp dcsp image mask pos make image mask outlines pos res dcnl dcsp else dcnl dcsp dcsp image mask none dcnl dcsp data np atleast 2d data dcnl dcsp data data data picks dcnl dcsp fig axes prepare trellis len data max col 5 dcnl dcsp if title is none dcnl dcsp dcsp title ica dcsp components dcnl dcsp fig suptitle title dcnl dcsp if merge grads dcnl dcsp dcsp from channels layout import merge grad data dcnl dcsp for ii data ax in zip picks data axes dcnl dcsp dcsp if ii in ica exclude dcnl dcsp dcsp dcsp ax set title ic dcsp 03d ii fontsize 12 color gray dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax set title ic dcsp 03d ii fontsize 12 dcnl dcsp dcsp data merge grad data data if merge grads else data dcnl dcsp dcsp vmin vmax setup vmin vmax data vmin vmax dcnl dcsp dcsp im plot topomap data flatten pos vmin vmin vmax vmax res res axes ax cmap cmap0 outlines outlines image mask image mask contours contours image interp image interp show false sensors sensors 0 dcnl dcsp dcsp im axes set label ic dcsp 03d ii dcnl dcsp dcsp if colorbar dcnl dcsp dcsp dcsp divider make axes locatable ax dcnl dcsp dcsp dcsp cax divider append axes right size 5 pad 0 05 dcnl dcsp dcsp dcsp cbar plt colorbar im cax cax format 3 2f cmap cmap dcnl dcsp dcsp dcsp cbar ax tick params labelsize 12 dcnl dcsp dcsp dcsp cbar set ticks vmin vmax dcnl dcsp dcsp dcsp cbar ax set title au fontsize 10 dcnl dcsp dcsp dcsp if cmap1 dcnl dcsp dcsp dcsp dcsp ax cb draggablecolorbar cbar im dcnl dcsp dcsp hide frame ax dcnl dcsp tight layout fig fig dcnl dcsp fig subplots adjust top 0 95 dcnl dcsp fig canvas draw dcnl dcsp if isinstance inst baseraw baseepochs dcnl dcsp dcsp def onclick event ica ica inst inst dcnl dcsp dcsp dcsp label event inaxes get label dcnl dcsp dcsp dcsp if ic dcsp in label dcnl dcsp dcsp dcsp dcsp ic int label4 dcnl dcsp dcsp dcsp dcsp ica plot properties inst picks ic show true dcnl dcsp dcsp fig canvas mpl connect button press event onclick dcnl dcsp plt show show dcnl dcsp return fig
def plot tfr topomap tfr tmin none tmax none fmin none fmax none ch type none baseline none mode mean layout none vmin none vmax none cmap none sensors true colorbar true unit none res 64 size 2 cbar fmt 1 1e show names false title none axes none show true outlines head head pos none contours 6 dcsp from channels import get ch type dcnl dcsp ch type get ch type tfr ch type dcnl dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits axes grid1 import make axes locatable dcnl dcsp picks pos merge grads names prepare topo plot tfr ch type layout dcnl dcsp if not show names dcnl dcsp dcsp names none dcnl dcsp data tfr data dcnl dcsp data rescale data tfr times baseline mode copy true dcnl dcsp itmin itmax none none dcnl dcsp idx np where time mask tfr times tmin tmax 0 dcnl dcsp if tmin is not none dcnl dcsp dcsp itmin idx0 dcnl dcsp if tmax is not none dcnl dcsp dcsp itmax idx 1 + 1 dcnl dcsp ifmin ifmax none none dcnl dcsp idx np where time mask tfr freqs fmin fmax 0 dcnl dcsp if fmin is not none dcnl dcsp dcsp ifmin idx0 dcnl dcsp if fmax is not none dcnl dcsp dcsp ifmax idx 1 + 1 dcnl dcsp data datapicks ifmin ifmax itmin itmax dcnl dcsp data np mean np mean data axis 2 axis 1 np newaxis dcnl dcsp if merge grads dcnl dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp data merge grad data data dcnl dcsp norm false if np min data < 0 else true dcnl dcsp vmin vmax setup vmin vmax data vmin vmax norm dcnl dcsp cmap setup cmap cmap norm norm dcnl dcsp if axes is none dcnl dcsp dcsp fig plt figure figsize size size dcnl dcsp dcsp ax fig gca dcnl dcsp else dcnl dcsp dcsp fig axes figure dcnl dcsp dcsp ax axes dcnl dcsp hide frame ax dcnl dcsp locator none dcnl dcsp if not isinstance contours list np ndarray dcnl dcsp dcsp locator contours set contour locator vmin vmax contours dcnl dcsp if title is not none dcnl dcsp dcsp ax set title title dcnl dcsp fig wrapper list dcnl dcsp selection callback partial onselect tfr tfr pos pos ch type ch type itmin itmin itmax itmax ifmin ifmin ifmax ifmax cmap cmap0 fig fig wrapper layout layout dcnl dcsp im plot topomap data 0 pos vmin vmin vmax vmax axes ax cmap cmap0 image interp bilinear contours contours names names show names show names show false onselect selection callback sensors sensors res res head pos head pos outlines outlines dcnl dcsp if colorbar dcnl dcsp dcsp from matplotlib import ticker dcnl dcsp dcsp divider make axes locatable ax dcnl dcsp dcsp cax divider append axes right size 5 pad 0 05 dcnl dcsp dcsp cbar plt colorbar im cax cax format cbar fmt cmap cmap0 dcnl dcsp dcsp if locator is none dcnl dcsp dcsp dcsp locator ticker maxnlocator nbins 5 dcnl dcsp dcsp cbar locator locator dcnl dcsp dcsp cbar update ticks dcnl dcsp dcsp cbar ax tick params labelsize 12 dcnl dcsp dcsp unit handle default units unit misc dcnl dcsp dcsp cbar ax set title unit dcnl dcsp dcsp if cmap1 dcnl dcsp dcsp dcsp ax cb draggablecolorbar cbar im dcnl dcsp plt show show dcnl dcsp return fig
def plot evoked topomap evoked times auto ch type none layout none vmin none vmax none cmap none sensors true colorbar true scale none scale time 1000 0 unit none res 64 size 1 cbar fmt 3 1f time format 01d dcsp ms proj false show true show names false title none mask none mask params none outlines head contours 6 image interp bilinear average none head pos none axes none dcsp from channels import get ch type dcnl dcsp from channels layout import merge grad data dcnl dcsp ch type get ch type evoked ch type dcnl dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib import gridspec dcnl dcsp from matplotlib widgets import slider dcnl dcsp from mpl toolkits axes grid1 import make axes locatable dcnl dcsp mask params handle default mask params mask params dcnl dcsp mask params markersize size 2 0 dcnl dcsp mask params markeredgewidth size 2 0 dcnl dcsp picks pos merge grads names ch type prepare topo plot evoked ch type layout dcnl dcsp if proj is true and evoked proj is not true dcnl dcsp dcsp data evoked copy apply proj data dcnl dcsp else dcnl dcsp dcsp data evoked data dcnl dcsp evoked evoked copy pick channels evoked ch namespick for pick in picks dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp interactive times interactive dcnl dcsp if axes is not none dcnl dcsp dcsp if isinstance axes plt axes dcnl dcsp dcsp dcsp axes axes dcnl dcsp dcsp times process times evoked times n peaks len axes dcnl dcsp else dcnl dcsp dcsp times process times evoked times n peaks none dcnl dcsp space 1 2 0 evoked info sfreq dcnl dcsp if max times max evoked times + space or min times < min evoked times space dcnl dcsp dcsp raise valueerror times dcsp should dcsp be dcsp between dcsp 0 0 3f dcsp and dcsp 1 0 3f format evoked times0 evoked times 1 dcnl dcsp n times len times dcnl dcsp nax n times + bool colorbar dcnl dcsp width size nax dcnl dcsp height size + max 0 0 1 4 size + bool title 0 5 dcnl dcsp cols n times + 1 if colorbar else n times dcnl dcsp if interactive dcnl dcsp dcsp if axes is not none dcnl dcsp dcsp dcsp raise valueerror user dcsp provided dcsp axes dcsp not dcsp allowed dcsp when dcsp times interactive dcnl dcsp dcsp height ratios 5 1 dcnl dcsp dcsp rows 2 dcnl dcsp dcsp g kwargs left 0 2 right 1 0 bottom 0 05 top 0 95 dcnl dcsp else dcnl dcsp dcsp rows height ratios g kwargs 1 none dcnl dcsp gs gridspec gridspec rows cols height ratios height ratios g kwargs dcnl dcsp if axes is none dcnl dcsp dcsp figure nobar figsize width 1 5 height 1 5 dcnl dcsp dcsp axes list dcnl dcsp dcsp for ax idx in range len times dcnl dcsp dcsp dcsp axes append plt subplot gsax idx dcnl dcsp elif colorbar dcnl dcsp dcsp warn colorbar dcsp is dcsp drawn dcsp to dcsp the dcsp rightmost dcsp column dcsp of dcsp the dcsp figure dcsp be dcsp sure dcsp to dcsp provide dcsp enough dcsp space dcsp for dcsp it dcsp or dcsp turn dcsp it dcsp off dcsp with dcsp colorbar false dcnl dcsp if len axes n times dcnl dcsp dcsp raise runtimeerror axes dcsp and dcsp times dcsp must dcsp be dcsp equal dcsp in dcsp sizes dcnl dcsp if ch type startswith planar dcnl dcsp dcsp key grad dcnl dcsp else dcnl dcsp dcsp key ch type dcnl dcsp scale handle default scalings scale key dcnl dcsp unit handle default units unit key dcnl dcsp if not show names dcnl dcsp dcsp names none dcnl dcsp w frame plt rcparams figure subplot wspace 2 nax dcnl dcsp top frame max 0 05 if title is none else 0 25 0 2 size dcnl dcsp fig axes0 get figure dcnl dcsp fig subplots adjust left w frame right 1 w frame bottom 0 top 1 top frame dcnl dcsp time idx np where time mask evoked times tmin t tmax none sfreq evoked info sfreq 00 for t in times dcnl dcsp if average is none dcnl dcsp dcsp data datanp ix picks time idx dcnl dcsp elif isinstance average float dcnl dcsp dcsp if not average 0 dcnl dcsp dcsp dcsp raise valueerror the dcsp average dcsp parameter dcsp must dcsp be dcsp positive dcsp you dcsp passed dcsp a dcsp negative dcsp value dcnl dcsp dcsp data np zeros len picks len time idx dcnl dcsp dcsp ave time float average 2 0 dcnl dcsp dcsp iter times evoked timestime idx dcnl dcsp dcsp for ii idx tmin tmax in enumerate zip time idx iter times ave time iter times + ave time dcnl dcsp dcsp dcsp my range tmin < evoked times evoked times < tmax dcnl dcsp dcsp dcsp data ii datapicks my range mean 1 dcnl dcsp dcsp data data dcnl dcsp else dcnl dcsp dcsp raise valueerror the dcsp average dcsp parameter dcsp must dcsp be dcsp none dcsp or dcsp a dcsp float check dcsp your dcsp input dcnl dcsp data scale dcnl dcsp if merge grads dcnl dcsp dcsp data merge grad data data dcnl dcsp images contours dcnl dcsp if mask is not none dcnl dcsp dcsp if ch type grad dcnl dcsp dcsp dcsp mask masknp ix picks 2 time idx | masknp ix picks1 2 time idx dcnl dcsp dcsp else dcnl dcsp dcsp dcsp mask masknp ix picks time idx dcnl dcsp pos outlines check outlines pos outlines head pos dcnl dcsp if outlines is not none dcnl dcsp dcsp image mask pos make image mask outlines pos res dcnl dcsp else dcnl dcsp dcsp image mask none dcnl dcsp vlims setup vmin vmax data i vmin vmax norm merge grads for i in range len times dcnl dcsp vmin np min vlims dcnl dcsp vmax np max vlims dcnl dcsp cmap setup cmap cmap n axes len times norm vmin 0 dcnl dcsp if not isinstance contours list np ndarray dcnl dcsp dcsp contours set contour locator vmin vmax contours dcnl dcsp kwargs dict vmin vmin vmax vmax sensors sensors res res names names show names show names cmap cmap0 mask params mask params outlines outlines image mask image mask contours contours image interp image interp show false dcnl dcsp for idx time in enumerate times dcnl dcsp dcsp tp cn plot topomap data idx pos axes axesidx mask mask idx if mask is not none else none kwargs dcnl dcsp dcsp images append tp dcnl dcsp dcsp if cn is not none dcnl dcsp dcsp dcsp contours append cn dcnl dcsp dcsp if time format is not none dcnl dcsp dcsp dcsp axesidx set title time format time scale time dcnl dcsp if interactive dcnl dcsp dcsp axes append plt subplot gs2 dcnl dcsp dcsp slider slider axes 1 time evoked times0 evoked times 1 times0 valfmt 1 2fs dcnl dcsp dcsp slider vline remove dcnl dcsp dcsp func merge grad data if merge grads else lambda x x dcnl dcsp dcsp changed callback partial slider changed ax axes0 data evoked data times evoked times pos pos scale scale func func time format time format scale time scale time kwargs kwargs dcnl dcsp dcsp slider on changed changed callback dcnl dcsp dcsp ts np tile evoked times len evoked data reshape evoked data shape dcnl dcsp dcsp axes 1 plot ts evoked data color k dcnl dcsp dcsp axes 1 slider slider dcnl dcsp if title is not none dcnl dcsp dcsp plt suptitle title verticalalignment top size xlarge dcnl dcsp if colorbar dcnl dcsp dcsp n fig axes max nax len fig get axes dcnl dcsp dcsp cax plt subplot 1 n fig axes + 1 n fig axes + 1 dcnl dcsp dcsp resize cbar cax n fig axes size dcnl dcsp dcsp if unit is not none dcnl dcsp dcsp dcsp cax set title unit dcnl dcsp dcsp cbar fig colorbar images 1 ax cax cax cax format cbar fmt dcnl dcsp dcsp cbar set ticks cn levels dcnl dcsp dcsp cbar ax tick params labelsize 7 dcnl dcsp dcsp if cmap1 dcnl dcsp dcsp dcsp for im in images dcnl dcsp dcsp dcsp dcsp im axes cb draggablecolorbar cbar im dcnl dcsp if proj interactive dcnl dcsp dcsp check delayed ssp evoked dcnl dcsp dcsp params dict evoked evoked fig fig projs evoked info projs picks picks images images contours contours time idx time idx scale scale merge grads merge grads res res pos pos image mask image mask plot update proj callback plot update evoked topomap dcnl dcsp dcsp draw proj checkbox none params dcnl dcsp plt show show dcnl dcsp return fig
def resize cbar cax n fig axes size 1 dcsp cpos cax get position dcnl dcsp if size < 1 dcnl dcsp dcsp cpos x0 1 0 7 + 0 1 size n fig axes dcnl dcsp cpos x1 cpos x0 + 0 1 n fig axes dcnl dcsp cpos y0 0 2 dcnl dcsp cpos y1 0 7 dcnl dcsp cax set position cpos
def slider changed val ax data times pos scale func time format scale time kwargs dcsp idx np argmin np abs times val dcnl dcsp data func data idx ravel scale dcnl dcsp ax clear dcnl dcsp im plot topomap data pos axes ax kwargs dcnl dcsp if hasattr ax cb dcnl dcsp dcsp ax cb mappable im dcnl dcsp dcsp resize cbar ax cb cbar ax 2 dcnl dcsp if time format is not none dcnl dcsp dcsp ax set title time format val scale time
def plot topomap multi cbar data pos ax title none unit none vmin none vmax none cmap none outlines head colorbar false cbar fmt 3 3f dcsp import matplotlib pyplot as plt dcnl dcsp from mpl toolkits axes grid1 import make axes locatable dcnl dcsp hide frame ax dcnl dcsp vmin np min data if vmin is none else vmin dcnl dcsp vmax np max data if vmax is none else vmax dcnl dcsp cmap setup cmap cmap dcnl dcsp if title is not none dcnl dcsp dcsp ax set title title fontsize 10 dcnl dcsp im plot topomap data pos vmin vmin vmax vmax axes ax cmap cmap0 image interp bilinear contours 0 outlines outlines show false dcnl dcsp if colorbar is true dcnl dcsp dcsp divider make axes locatable ax dcnl dcsp dcsp cax divider append axes right size 10 pad 0 25 dcnl dcsp dcsp cbar plt colorbar im cax cax format cbar fmt dcnl dcsp dcsp cbar set ticks vmin vmax dcnl dcsp dcsp if unit is not none dcnl dcsp dcsp dcsp cbar ax set title unit fontsize 8 dcnl dcsp dcsp cbar ax tick params labelsize 8 dcnl dcsp dcsp if cmap1 dcnl dcsp dcsp dcsp ax cb draggablecolorbar cbar im
verbose dcnl def plot epochs psd topomap epochs bands none vmin none vmax none tmin none tmax none proj false bandwidth none adaptive false low bias true normalization length ch type none layout none cmap rdbu r agg fun none db false n jobs 1 normalize false cbar fmt 0 3f outlines head axes none show true verbose none dcsp from channels import get ch type dcnl dcsp ch type get ch type epochs ch type dcnl dcsp picks pos merge grads names ch type prepare topo plot epochs ch type layout dcnl dcsp psds freqs psd multitaper epochs tmin tmin tmax tmax bandwidth bandwidth adaptive adaptive low bias low bias normalization normalization picks picks proj proj n jobs n jobs dcnl dcsp psds np mean psds axis 0 dcnl dcsp if merge grads dcnl dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp psds merge grad data psds dcnl dcsp return plot psds topomap psds psds freqs freqs pos pos agg fun agg fun vmin vmin vmax vmax bands bands cmap cmap db db normalize normalize cbar fmt cbar fmt outlines outlines axes axes show show
def plot psds topomap psds freqs pos agg fun none vmin none vmax none bands none cmap none db true normalize false cbar fmt 0 3f outlines head axes none show true dcsp import matplotlib pyplot as plt dcnl dcsp if bands is none dcnl dcsp dcsp bands 0 4 delta 4 8 theta 8 12 alpha 12 30 beta 30 45 gamma dcnl dcsp if agg fun is none dcnl dcsp dcsp agg fun np sum if normalize is true else np mean dcnl dcsp if normalize is true dcnl dcsp dcsp psds psds sum axis 1 none dcnl dcsp dcsp assert np allclose psds sum axis 1 1 0 dcnl dcsp n axes len bands dcnl dcsp if axes is not none dcnl dcsp dcsp validate if list of axes axes n axes dcnl dcsp dcsp fig axes0 figure dcnl dcsp else dcnl dcsp dcsp fig axes plt subplots 1 n axes figsize 2 n axes 1 5 dcnl dcsp dcsp if n axes 1 dcnl dcsp dcsp dcsp axes axes dcnl dcsp for ax fmin fmax title in zip axes bands dcnl dcsp dcsp freq mask fmin < freqs freqs < fmax dcnl dcsp dcsp if freq mask sum 0 dcnl dcsp dcsp dcsp raise runtimeerror no dcsp frequencies dcsp in dcsp band dcsp s dcsp s dcsp s title fmin fmax dcnl dcsp dcsp data agg fun psds freq mask axis 1 dcnl dcsp dcsp if db is true and normalize is false dcnl dcsp dcsp dcsp data 10 np log10 data dcnl dcsp dcsp dcsp unit db dcnl dcsp dcsp else dcnl dcsp dcsp dcsp unit power dcnl dcsp dcsp plot topomap multi cbar data pos ax title title vmin vmin vmax vmax cmap cmap outlines outlines colorbar true unit unit cbar fmt cbar fmt dcnl dcsp tight layout fig fig dcnl dcsp fig canvas draw dcnl dcsp plt show show dcnl dcsp return fig
def plot layout layout picks none show true dcsp import matplotlib pyplot as plt dcnl dcsp fig plt figure figsize max plt rcparams figure figsize 2 dcnl dcsp ax fig add subplot 111 dcnl dcsp fig subplots adjust left 0 bottom 0 right 1 top 1 wspace none hspace none dcnl dcsp ax set xticks yticks aspect equal dcnl dcsp pos p0 + p2 2 0 p1 + p3 2 0 for p in layout pos dcnl dcsp pos outlines check outlines pos head dcnl dcsp draw outlines ax outlines dcnl dcsp if picks is none dcnl dcsp dcsp names layout names dcnl dcsp else dcnl dcsp dcsp pos pospicks dcnl dcsp dcsp names np array layout names picks dcnl dcsp for ii this pos ch id in enumerate zip pos names dcnl dcsp dcsp ax annotate ch id xy this pos 2 horizontalalignment center verticalalignment center size xsmall dcnl dcsp tight layout fig fig pad 0 w pad 0 h pad 0 dcnl dcsp plt show show dcnl dcsp return fig
def onselect eclick erelease tfr pos ch type itmin itmax ifmin ifmax cmap fig layout none dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib collections import pathcollection dcnl dcsp pos check outlines pos outlines head head pos none dcnl dcsp ax eclick inaxes dcnl dcsp xmin min eclick xdata erelease xdata dcnl dcsp xmax max eclick xdata erelease xdata dcnl dcsp ymin min eclick ydata erelease ydata dcnl dcsp ymax max eclick ydata erelease ydata dcnl dcsp indices pos 0 < xmax pos 0 xmin pos 1 < ymax pos 1 ymin dcnl dcsp colors r if ii else k for ii in indices dcnl dcsp indices np where indices 0 dcnl dcsp for collection in ax collections dcnl dcsp dcsp if isinstance collection pathcollection dcnl dcsp dcsp dcsp collection set color colors dcnl dcsp ax figure canvas draw dcnl dcsp if len indices 0 dcnl dcsp dcsp return dcnl dcsp data tfr data dcnl dcsp if ch type mag dcnl dcsp dcsp picks pick types tfr info meg ch type ref meg false dcnl dcsp dcsp data np mean dataindices ifmin ifmax itmin itmax axis 0 dcnl dcsp dcsp chs tfr ch namespicksx for x in indices dcnl dcsp elif ch type grad dcnl dcsp dcsp from channels layout import pair grad sensors dcnl dcsp dcsp grads pair grad sensors tfr info layout layout topomap coords false dcnl dcsp dcsp idxs list dcnl dcsp dcsp for idx in indices dcnl dcsp dcsp dcsp idxs append grads idx 2 dcnl dcsp dcsp dcsp idxs append grads idx 2 + 1 dcnl dcsp dcsp data np mean dataidxs ifmin ifmax itmin itmax axis 0 dcnl dcsp dcsp chs tfr ch namesx for x in idxs dcnl dcsp elif ch type eeg dcnl dcsp dcsp picks pick types tfr info meg false eeg true ref meg false dcnl dcsp dcsp data np mean dataindices ifmin ifmax itmin itmax axis 0 dcnl dcsp dcsp chs tfr ch namespicksx for x in indices dcnl dcsp logger info averaging dcsp tfr dcsp over dcsp channels dcsp + str chs dcnl dcsp if len fig 0 dcnl dcsp dcsp fig append figure nobar dcnl dcsp if not plt fignum exists fig0 number dcnl dcsp dcsp fig0 figure nobar dcnl dcsp ax fig0 add subplot 111 dcnl dcsp itmax len tfr times 1 if itmax is none else min itmax len tfr times 1 dcnl dcsp ifmax len tfr freqs 1 if ifmax is none else min ifmax len tfr freqs 1 dcnl dcsp if itmin is none dcnl dcsp dcsp itmin 0 dcnl dcsp if ifmin is none dcnl dcsp dcsp ifmin 0 dcnl dcsp extent tfr timesitmin 1000 0 tfr timesitmax 1000 0 tfr freqsifmin tfr freqsifmax dcnl dcsp title average dcsp over dcsp d dcsp s dcsp channels len chs ch type dcnl dcsp ax set title title dcnl dcsp ax set xlabel time dcsp ms dcnl dcsp ax set ylabel frequency dcsp hz dcnl dcsp img ax imshow data extent extent aspect auto origin lower cmap cmap dcnl dcsp if len fig0 get axes < 2 dcnl dcsp dcsp fig0 get axes 1 cbar fig0 colorbar mappable img dcnl dcsp else dcnl dcsp dcsp fig0 get axes 1 cbar on mappable changed mappable img dcnl dcsp fig0 canvas draw dcnl dcsp plt figure fig0 number dcnl dcsp plt show true
def prepare topomap pos ax dcsp pos x pos 0 dcnl dcsp pos y pos 1 dcnl dcsp hide frame ax dcnl dcsp if any not pos y any not pos x any dcnl dcsp dcsp raise runtimeerror no dcsp position dcsp information dcsp found dcsp cannot dcsp compute dcsp geometries dcsp for dcsp topomap dcnl dcsp return pos x pos y
def hide frame ax dcsp ax get yticks dcnl dcsp ax xaxis set ticks dcnl dcsp ax yaxis set ticks dcnl dcsp ax set frame on false
def init anim ax ax line ax cbar params merge grads dcsp from matplotlib import pyplot as plt patches dcnl dcsp logger info initializing dcsp animation dcnl dcsp data params data dcnl dcsp items list dcnl dcsp if params butterfly dcnl dcsp dcsp all times params all times dcnl dcsp dcsp for idx in range len data dcnl dcsp dcsp dcsp ax line plot all times dataidx color k dcnl dcsp dcsp vmin vmax setup vmin vmax data none none dcnl dcsp dcsp ax line set yticks np around np linspace vmin vmax 5 1 dcnl dcsp dcsp params line ax line plot all times0 all times0 ax line get ylim color r dcnl dcsp dcsp items append params line dcnl dcsp if merge grads dcnl dcsp dcsp from mne channels layout import merge grad data dcnl dcsp dcsp data merge grad data data dcnl dcsp norm true if np min data 0 else false dcnl dcsp cmap reds if norm else rdbu r dcnl dcsp vmin vmax setup vmin vmax data none none norm dcnl dcsp pos outlines check outlines params pos head none dcnl dcsp hide frame ax dcnl dcsp xlim np inf np inf dcnl dcsp ylim np inf np inf dcnl dcsp mask np c outlines mask pos dcnl dcsp xmin xmax np min np r xlim0 mask 0 np max np r xlim1 mask 0 dcnl dcsp ymin ymax np min np r ylim0 mask 1 np max np r ylim1 mask 1 dcnl dcsp res 64 dcnl dcsp xi np linspace xmin xmax res dcnl dcsp yi np linspace ymin ymax res dcnl dcsp xi yi np meshgrid xi yi dcnl dcsp params zis list dcnl dcsp interp griddata pos dcnl dcsp for frame in params frames dcnl dcsp dcsp params zis append interp set values data frame xi yi dcnl dcsp zi params zis 0 dcnl dcsp zi min np min params zis dcnl dcsp zi max np max params zis dcnl dcsp cont lims np linspace zi min zi max 7 endpoint false 1 dcnl dcsp pos make image mask outlines pos res dcnl dcsp params update vmin vmin vmax vmax xi xi yi yi zi zi extent xmin xmax ymin ymax cmap cmap cont lims cont lims dcnl dcsp im ax imshow zi cmap cmap vmin vmin vmax vmax origin lower aspect equal extent xmin xmax ymin ymax interpolation bilinear dcnl dcsp plt colorbar im cax ax cbar cmap cmap dcnl dcsp cont ax contour xi yi zi levels cont lims colors k linewidths 1 dcnl dcsp patch patches ellipse 0 0 2 outlines clip radius 0 2 outlines clip radius 1 clip on true transform ax transdata dcnl dcsp im set clip path patch dcnl dcsp text ax text 0 55 0 95 transform ax transaxes va center ha right dcnl dcsp params text text dcnl dcsp items append im dcnl dcsp items append text dcnl dcsp for col in cont collections dcnl dcsp dcsp col set clip path patch dcnl dcsp outlines draw outlines ax outlines dcnl dcsp params update patch patch outlines outlines dcnl dcsp return tuple items + tuple cont collections
def animate frame ax ax line params dcsp if params pause dcnl dcsp dcsp frame params frame dcnl dcsp time idx params frames frame dcnl dcsp title 6 0f dcsp ms params times frame 1000 0 dcnl dcsp if params blit dcnl dcsp dcsp text params text dcnl dcsp else dcnl dcsp dcsp ax cla dcnl dcsp dcsp text ax text 0 45 1 15 transform ax transaxes dcnl dcsp dcsp for k x y in params outlines items dcnl dcsp dcsp dcsp if mask in k dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp ax plot x y color k linewidth 1 clip on false dcnl dcsp hide frame ax dcnl dcsp text set text title dcnl dcsp vmin params vmin dcnl dcsp vmax params vmax dcnl dcsp xi params xi dcnl dcsp yi params yi dcnl dcsp zi params zis frame dcnl dcsp extent params extent dcnl dcsp cmap params cmap dcnl dcsp patch params patch dcnl dcsp im ax imshow zi cmap cmap vmin vmin vmax vmax origin lower aspect equal extent extent interpolation bilinear dcnl dcsp cont lims params cont lims dcnl dcsp cont ax contour xi yi zi levels cont lims colors k linewidths 1 dcnl dcsp im set clip path patch dcnl dcsp items im text dcnl dcsp for col in cont collections dcnl dcsp dcsp col set clip path patch dcnl dcsp if params butterfly dcnl dcsp dcsp all times params all times dcnl dcsp dcsp line params line dcnl dcsp dcsp line remove dcnl dcsp dcsp params line ax line plot all timestime idx all timestime idx ax line get ylim color r 0 dcnl dcsp dcsp items append params line dcnl dcsp params frame frame dcnl dcsp return tuple items + tuple cont collections
def pause anim event params dcsp params pause not params pause
def key press event params dcsp if event key left dcnl dcsp dcsp params pause true dcnl dcsp dcsp params frame max params frame 1 0 dcnl dcsp elif event key right dcnl dcsp dcsp params pause true dcnl dcsp dcsp params frame min params frame + 1 len params frames 1
def topomap animation evoked ch type mag times none frame rate none butterfly false blit true show true dcsp from matplotlib import pyplot as plt animation dcnl dcsp if ch type is none dcnl dcsp dcsp ch type picks by type evoked info 00 dcnl dcsp if ch type not in mag grad eeg dcnl dcsp dcsp raise valueerror channel dcsp type dcsp not dcsp supported dcsp supported dcsp channel dcsp types dcsp include dcsp mag dcsp grad dcsp and dcsp eeg dcnl dcsp if times is none dcnl dcsp dcsp times np linspace evoked times0 evoked times 1 10 dcnl dcsp times np array times dcnl dcsp if times ndim 1 dcnl dcsp dcsp raise valueerror times dcsp must dcsp be dcsp 1d dcsp got dcsp d dcsp dimensions times ndim dcnl dcsp if max times evoked times 1 or min times < evoked times0 dcnl dcsp dcsp raise valueerror all dcsp times dcsp must dcsp be dcsp inside dcsp the dcsp evoked dcsp time dcsp series dcnl dcsp frames np abs evoked times time argmin for time in times dcnl dcsp blit false if plt get backend macosx else blit dcnl dcsp picks pos merge grads ch type prepare topo plot evoked ch type ch type layout none dcnl dcsp data evoked datapicks dcnl dcsp data handle default scalings ch type dcnl dcsp fig plt figure dcnl dcsp offset 0 0 if blit else 0 4 dcnl dcsp ax plt axes 0 0 + offset 2 0 0 0 + offset 2 0 1 0 offset 1 0 offset xlim 1 1 ylim 1 1 dcnl dcsp if butterfly dcnl dcsp dcsp ax line plt axes 0 2 0 05 0 6 0 1 xlim evoked times0 evoked times 1 dcnl dcsp else dcnl dcsp dcsp ax line none dcnl dcsp if isinstance frames integral dcnl dcsp dcsp frames np linspace 0 len evoked times 1 frames astype int dcnl dcsp ax cbar plt axes 0 85 0 1 0 05 0 8 dcnl dcsp ax cbar set title handle default units ch type fontsize 10 dcnl dcsp params data data pos pos all times evoked times frame 0 frames frames butterfly butterfly blit blit pause false times times dcnl dcsp init func partial init anim ax ax ax cbar ax cbar ax line ax line params params merge grads merge grads dcnl dcsp animate func partial animate ax ax ax line ax line params params dcnl dcsp pause func partial pause anim params params dcnl dcsp fig canvas mpl connect button press event pause func dcnl dcsp key press func partial key press params params dcnl dcsp fig canvas mpl connect key press event key press func dcnl dcsp if frame rate is none dcnl dcsp dcsp frame rate evoked info sfreq 10 0 dcnl dcsp interval 1000 frame rate dcnl dcsp anim animation funcanimation fig animate func init func init func frames len frames interval interval blit blit dcnl dcsp fig mne animation anim dcnl dcsp plt show show block false dcnl dcsp if line in params dcnl dcsp dcsp params line remove dcnl dcsp return fig anim
def set contour locator vmin vmax contours dcsp locator none dcnl dcsp if isinstance contours integral and contours 0 dcnl dcsp dcsp from matplotlib import ticker dcnl dcsp dcsp locator ticker maxnlocator nbins contours + 1 dcnl dcsp dcsp contours locator tick values vmin vmax dcnl dcsp return locator contours
deprecated plot gat matrix dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp 0 15 dcnl def plot gat matrix gat title none vmin none vmax none tlim none ax none cmap rdbu r show true colorbar true xlabel true ylabel true dcsp if not hasattr gat scores dcnl dcsp dcsp raise runtimeerror please dcsp score dcsp your dcsp data dcsp before dcsp trying dcsp to dcsp plot dcsp scores dcnl dcsp import matplotlib pyplot as plt dcnl dcsp if ax is none dcnl dcsp dcsp fig ax plt subplots 1 1 dcnl dcsp if tlim is none dcnl dcsp dcsp tn times gat train times times dcnl dcsp dcsp tt times gat test times times dcnl dcsp dcsp tlim tt times00 tt times 1 1 tn times0 tn times 1 dcnl dcsp im ax imshow gat scores interpolation nearest origin lower extent tlim vmin vmin vmax vmax cmap cmap dcnl dcsp if xlabel is true dcnl dcsp dcsp ax set xlabel testing dcsp time dcsp s dcnl dcsp if ylabel is true dcnl dcsp dcsp ax set ylabel training dcsp time dcsp s dcnl dcsp if title is not none dcnl dcsp dcsp ax set title title dcnl dcsp ax axvline 0 color k dcnl dcsp ax axhline 0 color k dcnl dcsp ax set xlim tlim 2 dcnl dcsp ax set ylim tlim2 dcnl dcsp if colorbar is true dcnl dcsp dcsp plt colorbar im ax ax dcnl dcsp plt show show dcnl dcsp return fig if ax is none else ax get figure
deprecated plot gat matrix dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp 0 15 dcnl def plot gat times gat train time diagonal title none xmin none xmax none ymin none ymax none ax none show true color none xlabel true ylabel true legend true chance true label classif dcsp score dcsp if not hasattr gat scores dcnl dcsp dcsp raise runtimeerror please dcsp score dcsp your dcsp data dcsp before dcsp trying dcsp to dcsp plot dcsp scores dcnl dcsp import matplotlib pyplot as plt dcnl dcsp if ax is none dcnl dcsp dcsp fig ax plt subplots 1 1 dcnl dcsp if chance is not false dcnl dcsp dcsp if chance is true dcnl dcsp dcsp dcsp chance get chance level gat scorer gat y train dcnl dcsp dcsp chance float chance dcnl dcsp dcsp if np isfinite chance dcnl dcsp dcsp dcsp ax axhline chance color k linestyle label chance dcsp level dcnl dcsp ax axvline 0 color k label dcnl dcsp if isinstance train time str float dcnl dcsp dcsp train time train time dcnl dcsp dcsp label label dcnl dcsp elif isinstance train time list np ndarray dcnl dcsp dcsp label train time dcnl dcsp else dcnl dcsp dcsp raise valueerror train time dcsp must dcsp be dcsp diagonal dcsp | dcsp float dcsp | dcsp list dcsp or dcsp array dcsp of dcsp float dcnl dcsp if color is none or isinstance color str dcnl dcsp dcsp color np tile color len train time dcnl dcsp for train time color label in zip train time color label dcnl dcsp dcsp plot gat time gat train time ax color label dcnl dcsp if title is not none dcnl dcsp dcsp ax set title title dcnl dcsp if ymin is not none and ymax is not none dcnl dcsp dcsp ax set ylim ymin ymax dcnl dcsp if xmin is not none and xmax is not none dcnl dcsp dcsp ax set xlim xmin xmax dcnl dcsp if xlabel is true dcnl dcsp dcsp ax set xlabel time dcsp s dcnl dcsp if ylabel is true dcnl dcsp dcsp ax set ylabel classif dcsp score dcsp 0 format auc if roc in repr gat scorer else dcnl dcsp if legend is true dcnl dcsp dcsp ax legend loc best dcnl dcsp plt show show dcnl dcsp return fig if ax is none else ax get figure
def plot gat time gat train time ax color label dcsp if np all np unique len t for t in gat test times times 1 dcnl dcsp dcsp scores gat scores dcnl dcsp elif train time diagonal dcnl dcsp dcsp scores np zeros len gat scores dcnl dcsp dcsp for train idx train time in enumerate gat train times times dcnl dcsp dcsp dcsp for test times in gat test times times dcnl dcsp dcsp dcsp dcsp lag test times train time dcnl dcsp dcsp dcsp dcsp test idx np abs lag argmin dcnl dcsp dcsp dcsp dcsp if np abs lagtest idx gat train times step dcnl dcsp dcsp dcsp dcsp dcsp score np nan dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp score gat scores train idxtest idx dcnl dcsp dcsp dcsp dcsp scorestrain idx score dcnl dcsp elif isinstance train time float dcnl dcsp dcsp train times gat train times times dcnl dcsp dcsp idx np abs train times train time argmin dcnl dcsp dcsp if train timesidx train time gat train times step dcnl dcsp dcsp dcsp raise valueerror no dcsp classifier dcsp trained dcsp at dcsp s dcsp train time dcnl dcsp dcsp scores gat scores idx dcnl dcsp else dcnl dcsp dcsp raise valueerror train time dcsp must dcsp be dcsp diagonal dcsp or dcsp a dcsp float dcnl dcsp kwargs dict dcnl dcsp if color is not none dcnl dcsp dcsp kwargs color color dcnl dcsp ax plot gat train times times scores label str label kwargs
def get chance level scorer y train dcsp if scorer name accuracy score dcnl dcsp dcsp chance np max np mean y train c for c in np unique y train dcnl dcsp elif scorer name roc auc score dcnl dcsp dcsp chance 0 5 dcnl dcsp else dcnl dcsp dcsp chance np nan dcnl dcsp dcsp warn cannot dcsp find dcsp chance dcsp level dcsp from dcsp s dcsp specify dcsp chance dcsp level scorer name dcnl dcsp return chance
def plot epochs image epochs picks none sigma 0 0 vmin none vmax none colorbar true order none show true units none scalings none cmap rdbu r fig none axes none overlay times none dcsp from scipy import ndimage dcnl dcsp units handle default units units dcnl dcsp scalings handle default scalings scalings dcnl dcsp import matplotlib pyplot as plt dcnl dcsp if picks is none dcnl dcsp dcsp picks pick types epochs info meg true eeg true ref meg false exclude bads 5 dcnl dcsp if set units keys set scalings keys dcnl dcsp dcsp raise valueerror scalings dcsp and dcsp units dcsp must dcsp have dcsp the dcsp same dcsp keys dcnl dcsp picks np atleast 1d picks dcnl dcsp if fig is not none or axes is not none and len picks 1 dcnl dcsp dcsp raise valueerror only dcsp single dcsp pick dcsp can dcsp be dcsp drawn dcsp to dcsp a dcsp figure dcnl dcsp if axes is not none dcnl dcsp dcsp if fig is not none dcnl dcsp dcsp dcsp raise valueerror both dcsp figure dcsp and dcsp axes dcsp were dcsp passed dcsp pleasedecide dcsp between dcsp the dcsp two dcnl dcsp dcsp from utils import validate if list of axes dcnl dcsp dcsp oblig len 3 if colorbar else 2 dcnl dcsp dcsp validate if list of axes axes obligatory len oblig len dcnl dcsp dcsp ax1 ax2 axes 2 dcnl dcsp dcsp fig ax1 get figure dcnl dcsp dcsp if colorbar dcnl dcsp dcsp dcsp ax3 axes 1 dcnl dcsp evoked epochs average picks dcnl dcsp data epochs get data picks dcnl dcsp n epochs len data dcnl dcsp data np swapaxes data 0 1 dcnl dcsp if sigma 0 0 dcnl dcsp dcsp for k in range len picks dcnl dcsp dcsp dcsp datak ndimage gaussian filter1d datak sigma sigma axis 0 dcnl dcsp scale vmin true if vmin is none else false dcnl dcsp scale vmax true if vmax is none else false dcnl dcsp vmin vmax setup vmin vmax data vmin vmax dcnl dcsp if overlay times is not none and len overlay times n epochs dcnl dcsp dcsp raise valueerror size dcsp of dcsp overlay times dcsp parameter dcsp s dcsp do dcsp not dcsp match dcsp the dcsp number dcsp of dcsp epochs dcsp s len overlay times n epochs dcnl dcsp if overlay times is not none dcnl dcsp dcsp overlay times np array overlay times dcnl dcsp dcsp times min np min overlay times dcnl dcsp dcsp times max np max overlay times dcnl dcsp dcsp if times min < epochs tmin or times max epochs tmax dcnl dcsp dcsp dcsp warn some dcsp values dcsp in dcsp overlay times dcsp fall dcsp outside dcsp of dcsp the dcsp epochs dcsp time dcsp interval dcsp between dcsp s dcsp s dcsp and dcsp s dcsp s epochs tmin epochs tmax dcnl dcsp figs list dcnl dcsp for i this data idx in enumerate zip data picks dcnl dcsp dcsp if fig is none dcnl dcsp dcsp dcsp this fig plt figure dcnl dcsp dcsp else dcnl dcsp dcsp dcsp this fig fig dcnl dcsp dcsp figs append this fig dcnl dcsp dcsp ch type channel type epochs info idx dcnl dcsp dcsp if ch type not in scalings dcnl dcsp dcsp dcsp raise keyerror s dcsp type dcsp not dcsp in dcsp scalings dcsp and dcsp units ch type dcnl dcsp dcsp this data scalingsch type dcnl dcsp dcsp this order order dcnl dcsp dcsp if callable order dcnl dcsp dcsp dcsp this order order epochs times this data dcnl dcsp dcsp if this order is not none and len this order len this data dcnl dcsp dcsp dcsp raise valueerror size dcsp of dcsp order dcsp parameter dcsp s dcsp does dcsp not dcsp match dcsp the dcsp number dcsp of dcsp epochs dcsp s len this order len this data dcnl dcsp dcsp this overlay times none dcnl dcsp dcsp if overlay times is not none dcnl dcsp dcsp dcsp this overlay times overlay times dcnl dcsp dcsp if this order is not none dcnl dcsp dcsp dcsp this order np asarray this order dcnl dcsp dcsp dcsp this data this datathis order dcnl dcsp dcsp dcsp if this overlay times is not none dcnl dcsp dcsp dcsp dcsp this overlay times this overlay timesthis order dcnl dcsp dcsp plt figure this fig number dcnl dcsp dcsp if axes is none dcnl dcsp dcsp dcsp ax1 plt subplot2grid 3 10 0 0 colspan 9 rowspan 2 dcnl dcsp dcsp dcsp ax2 plt subplot2grid 3 10 2 0 colspan 9 rowspan 1 dcnl dcsp dcsp dcsp if colorbar dcnl dcsp dcsp dcsp dcsp ax3 plt subplot2grid 3 10 0 9 colspan 1 rowspan 3 dcnl dcsp dcsp this vmin vmin scalingsch type if scale vmin else vmin dcnl dcsp dcsp this vmax vmax scalingsch type if scale vmax else vmax dcnl dcsp dcsp cmap setup cmap cmap dcnl dcsp dcsp im ax1 imshow this data extent 1000 0 epochs times0 1000 0 epochs times 1 0 n epochs aspect auto origin lower interpolation nearest vmin this vmin vmax this vmax cmap cmap0 dcnl dcsp dcsp if this overlay times is not none dcnl dcsp dcsp dcsp ax1 plot 1000 0 this overlay times 0 5 + np arange len this data k linewidth 2 dcnl dcsp dcsp ax1 set title epochs ch namesidx dcnl dcsp dcsp ax1 set ylabel epochs dcnl dcsp dcsp ax1 axis auto dcnl dcsp dcsp ax1 axis tight dcnl dcsp dcsp ax1 axvline 0 color m linewidth 3 linestyle dcnl dcsp dcsp evoked data scalingsch type evoked datai dcnl dcsp dcsp ax2 plot 1000 0 evoked times evoked data dcnl dcsp dcsp ax2 set xlabel time dcsp ms dcnl dcsp dcsp ax2 set xlim 1000 0 evoked times0 1000 0 evoked times 1 dcnl dcsp dcsp ax2 set ylabel unitsch type dcnl dcsp dcsp evoked vmin min evoked data 1 1 if scale vmin else vmin dcnl dcsp dcsp evoked vmax max evoked data 1 1 if scale vmax else vmax dcnl dcsp dcsp if scale vmin or scale vmax dcnl dcsp dcsp dcsp evoked vmax max np abs evoked vmax evoked vmin dcnl dcsp dcsp dcsp evoked vmin evoked vmax dcnl dcsp dcsp ax2 set ylim evoked vmin evoked vmax dcnl dcsp dcsp ax2 axvline 0 color m linewidth 3 linestyle dcnl dcsp dcsp if colorbar dcnl dcsp dcsp dcsp cbar plt colorbar im cax ax3 dcnl dcsp dcsp dcsp if cmap1 dcnl dcsp dcsp dcsp dcsp ax1 cb draggablecolorbar cbar im dcnl dcsp dcsp dcsp tight layout fig this fig dcnl dcsp plt show show dcnl dcsp return figs
def plot drop log drop log threshold 0 n max plot 20 subject unknown color 0 9 0 9 0 9 width 0 8 ignore ignored show true dcsp import matplotlib pyplot as plt dcnl dcsp from epochs import drop log stats dcnl dcsp perc drop log stats drop log ignore dcnl dcsp scores counter ch for d in drop log for ch in d if ch not in ignore dcnl dcsp ch names np array list scores keys dcnl dcsp fig plt figure dcnl dcsp if perc < threshold or len ch names 0 dcnl dcsp dcsp plt text 0 0 no dcsp drops dcnl dcsp dcsp return fig dcnl dcsp n used 0 dcnl dcsp for d in drop log dcnl dcsp dcsp if len d 0 or any ch not in ignore for ch in d dcnl dcsp dcsp dcsp n used + 1 dcnl dcsp counts 100 np array list scores values dtype float n used dcnl dcsp n plot min n max plot len ch names dcnl dcsp order np flipud np argsort counts dcnl dcsp plt title s dcsp 0 1f subject perc dcnl dcsp x np arange n plot dcnl dcsp plt bar x countsorder n plot color color width width dcnl dcsp plt xticks x + width 2 0 ch namesorder n plot rotation 45 horizontalalignment right dcnl dcsp plt tick params axis x which major labelsize 10 dcnl dcsp plt ylabel dcsp of dcsp epochs dcsp rejected dcnl dcsp plt xlim width 2 0 n plot 1 + width 3 2 dcnl dcsp plt grid true axis y dcnl dcsp tight layout pad 1 fig fig dcnl dcsp plt show show dcnl dcsp return fig
def draw epochs axes epoch idx good ch idx bad ch idx data times axes title str axes handler dcsp this axes handler0 dcnl dcsp for ii data ax in zip epoch idx data axes dcnl dcsp dcsp for l d in zip ax lines data good ch idx dcnl dcsp dcsp dcsp l set data times d dcnl dcsp dcsp if bad ch idx is not none dcnl dcsp dcsp dcsp bad lines ax linesk for k in bad ch idx dcnl dcsp dcsp dcsp for l d in zip bad lines data bad ch idx dcnl dcsp dcsp dcsp dcsp l set data times d dcnl dcsp dcsp if title str is not none dcnl dcsp dcsp dcsp ax set title title str ii fontsize 12 dcnl dcsp dcsp ax set ylim data min data max dcnl dcsp dcsp ax set yticks list dcnl dcsp dcsp ax set xticks list dcnl dcsp dcsp if vars ax this reject is true dcnl dcsp dcsp dcsp for l in ax lines dcnl dcsp dcsp dcsp dcsp l set color 0 8 0 8 0 8 dcnl dcsp dcsp dcsp ax get figure canvas draw dcnl dcsp dcsp else dcnl dcsp dcsp dcsp for k in axes handler dcnl dcsp dcsp dcsp dcsp if k this dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp if vars ax get k get reject none is true dcnl dcsp dcsp dcsp dcsp dcsp for l in ax lines len good ch idx dcnl dcsp dcsp dcsp dcsp dcsp dcsp l set color k dcnl dcsp dcsp dcsp dcsp dcsp if bad ch idx is not none dcnl dcsp dcsp dcsp dcsp dcsp dcsp for l in ax lines len bad ch idx dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp l set color r dcnl dcsp dcsp dcsp dcsp dcsp ax get figure canvas draw dcnl dcsp dcsp dcsp dcsp dcsp break
def epochs navigation onclick event params dcsp import matplotlib pyplot as plt dcnl dcsp p params dcnl dcsp here none dcnl dcsp if event inaxes p back ax dcnl dcsp dcsp here 1 dcnl dcsp elif event inaxes p next ax dcnl dcsp dcsp here 1 dcnl dcsp elif event inaxes p rejectquit ax dcnl dcsp dcsp if p reject idx dcnl dcsp dcsp dcsp p epochs drop p reject idx dcnl dcsp dcsp plt close p fig dcnl dcsp dcsp plt close event inaxes get figure dcnl dcsp if here is not none dcnl dcsp dcsp p idx handler rotate here dcnl dcsp dcsp p axes handler rotate here dcnl dcsp dcsp this idx p idx handler 0 dcnl dcsp dcsp draw epochs axes this idx p good ch idx p bad ch idx p data this idx p times p axes p title str p axes handler dcnl dcsp dcsp p axes 0 get figure canvas draw
def epochs axes onclick event params dcsp reject color 0 8 0 8 0 8 dcnl dcsp ax event inaxes dcnl dcsp if event inaxes is none dcnl dcsp dcsp return dcnl dcsp p params dcnl dcsp here vars ax p axes handler 0 dcnl dcsp if here get reject none is false dcnl dcsp dcsp idx here idx dcnl dcsp dcsp if idx not in p reject idx dcnl dcsp dcsp dcsp p reject idx append idx dcnl dcsp dcsp dcsp for l in ax lines dcnl dcsp dcsp dcsp dcsp l set color reject color dcnl dcsp dcsp dcsp here reject true dcnl dcsp elif here get reject none is true dcnl dcsp dcsp idx here idx dcnl dcsp dcsp if idx in p reject idx dcnl dcsp dcsp dcsp p reject idx pop p reject idx index idx dcnl dcsp dcsp dcsp good lines ax linesk for k in p good ch idx dcnl dcsp dcsp dcsp for l in good lines dcnl dcsp dcsp dcsp dcsp l set color k dcnl dcsp dcsp dcsp if p bad ch idx is not none dcnl dcsp dcsp dcsp dcsp bad lines ax lines len p bad ch idx dcnl dcsp dcsp dcsp dcsp for l in bad lines dcnl dcsp dcsp dcsp dcsp dcsp l set color r dcnl dcsp dcsp dcsp here reject false dcnl dcsp ax get figure canvas draw
def plot epochs epochs picks none scalings none n epochs 20 n channels 20 title none events none event colors none show true block false decim auto dcsp epochs drop bad dcnl dcsp scalings compute scalings scalings epochs dcnl dcsp scalings handle default scalings plot raw scalings dcnl dcsp decim data picks handle decim epochs info copy decim none dcnl dcsp projs epochs info projs dcnl dcsp params epochs epochs info copy deepcopy epochs info bad color 0 8 0 8 0 8 t start 0 histogram none decim decim data picks data picks dcnl dcsp params label click fun partial pick bad channels params params dcnl dcsp prepare mne browse epochs params projs n channels n epochs scalings title picks events events event colors event colors dcnl dcsp prepare projectors params dcnl dcsp layout figure params dcnl dcsp callback close partial close event params params dcnl dcsp params fig canvas mpl connect close event callback close dcnl dcsp try dcnl dcsp dcsp plt show show block block dcnl dcsp except typeerror dcnl dcsp dcsp plt show show dcnl dcsp return params fig
verbose dcnl def plot epochs psd epochs fmin 0 fmax np inf tmin none tmax none proj false bandwidth none adaptive false low bias true normalization length picks none ax none color black area mode std area alpha 0 33 db true n jobs 1 show true verbose none dcsp from raw import set psd plot params convert psds dcnl dcsp fig picks list titles list units list scalings list ax list make label set psd plot params epochs info proj picks ax area mode dcnl dcsp for ii picks title ax in enumerate zip picks list titles list ax list dcnl dcsp dcsp psds freqs psd multitaper epochs picks picks fmin fmin fmax fmax tmin tmin tmax tmax bandwidth bandwidth adaptive adaptive low bias low bias normalization normalization proj proj n jobs n jobs dcnl dcsp dcsp ylabel convert psds psds db scalings listii units listii epochs ch namespi for pi in picks dcnl dcsp dcsp psd mean np mean psds axis 0 mean axis 0 dcnl dcsp dcsp if area mode std dcnl dcsp dcsp dcsp psd std np std np mean psds axis 0 axis 0 dcnl dcsp dcsp dcsp hyp limits psd mean psd std psd mean + psd std dcnl dcsp dcsp elif area mode range dcnl dcsp dcsp dcsp hyp limits np min np mean psds axis 0 axis 0 np max np mean psds axis 0 axis 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hyp limits none dcnl dcsp dcsp ax plot freqs psd mean color color dcnl dcsp dcsp if hyp limits is not none dcnl dcsp dcsp dcsp ax fill between freqs hyp limits0 y2 hyp limits1 color color alpha area alpha dcnl dcsp dcsp if make label dcnl dcsp dcsp dcsp if ii len picks list 1 dcnl dcsp dcsp dcsp dcsp ax set xlabel freq dcsp hz dcnl dcsp dcsp dcsp ax set ylabel ylabel dcnl dcsp dcsp dcsp ax set title title dcnl dcsp dcsp dcsp ax set xlim freqs0 freqs 1 dcnl dcsp if make label dcnl dcsp dcsp tight layout pad 0 1 h pad 0 1 w pad 0 1 fig fig dcnl dcsp plt show show dcnl dcsp return fig
def prepare mne browse epochs params projs n channels n epochs scalings title picks events none event colors none order none dcsp import matplotlib pyplot as plt dcnl dcsp import matplotlib as mpl dcnl dcsp from matplotlib collections import linecollection dcnl dcsp from matplotlib colors import colorconverter dcnl dcsp epochs params epochs dcnl dcsp if picks is none dcnl dcsp dcsp picks handle picks epochs dcnl dcsp if len picks < 1 dcnl dcsp dcsp raise runtimeerror no dcsp appropriate dcsp channels dcsp found dcsp please dcsp check dcsp your dcsp picks dcnl dcsp picks sorted picks dcnl dcsp inds list dcnl dcsp types list dcnl dcsp for t in grad mag dcnl dcsp dcsp idxs pick types params info meg t ref meg false exclude dcnl dcsp dcsp if len idxs < 1 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp mask np in1d idxs picks assume unique true dcnl dcsp dcsp inds append idxsmask dcnl dcsp dcsp types + t len inds 1 dcnl dcsp for t in hbo hbr dcnl dcsp dcsp idxs pick types params info meg false ref meg false fnirs t exclude dcnl dcsp dcsp if len idxs < 1 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp mask np in1d idxs picks assume unique true dcnl dcsp dcsp inds append idxsmask dcnl dcsp dcsp types + t len inds 1 dcnl dcsp pick kwargs dict meg false ref meg false exclude dcnl dcsp if order is none dcnl dcsp dcsp order eeg seeg ecog eog ecg emg ref meg stim resp misc chpi syst ias exci dcnl dcsp for ch type in order dcnl dcsp dcsp pick kwargsch type true dcnl dcsp dcsp idxs pick types params info pick kwargs dcnl dcsp dcsp if len idxs < 1 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp mask np in1d idxs picks assume unique true dcnl dcsp dcsp inds append idxsmask dcnl dcsp dcsp types + ch type len inds 1 dcnl dcsp dcsp pick kwargsch type false dcnl dcsp inds np concatenate inds astype int dcnl dcsp if not len inds len picks dcnl dcsp dcsp raise runtimeerror some dcsp channels dcsp not dcsp classified dcsp please dcsp check dcsp your dcsp picks dcnl dcsp ch names params info ch names x for x in inds dcnl dcsp size get config mne browse raw size dcnl dcsp n epochs min n epochs len epochs events dcnl dcsp duration len epochs times n epochs dcnl dcsp n channels min n channels len picks dcnl dcsp if size is not none dcnl dcsp dcsp size size split dcnl dcsp dcsp size tuple float s for s in size dcnl dcsp if title is none dcnl dcsp dcsp title epochs name dcnl dcsp dcsp if title is none or len title 0 dcnl dcsp dcsp dcsp title dcnl dcsp fig figure nobar facecolor w figsize size dpi 80 dcnl dcsp fig canvas set window title mne browse epochs dcnl dcsp ax plt subplot2grid 10 15 0 1 colspan 13 rowspan 9 dcnl dcsp ax annotate title xy 0 5 1 xytext 0 ax get ylim 1 + 15 ha center va bottom size 12 xycoords axes dcsp fraction textcoords offset dcsp points dcnl dcsp color handle default color none dcnl dcsp ax axis 0 duration 0 200 dcnl dcsp ax2 ax twiny dcnl dcsp ax2 set zorder 1 dcnl dcsp ax2 axis 0 duration 0 200 dcnl dcsp ax hscroll plt subplot2grid 10 15 9 1 colspan 13 dcnl dcsp ax hscroll get yaxis set visible false dcnl dcsp ax hscroll set xlabel epochs dcnl dcsp ax vscroll plt subplot2grid 10 15 0 14 rowspan 9 dcnl dcsp ax vscroll set axis off dcnl dcsp ax vscroll add patch mpl patches rectangle 0 0 1 len picks facecolor w zorder 3 dcnl dcsp ax help button plt subplot2grid 10 15 9 0 colspan 1 dcnl dcsp help button mpl widgets button ax help button help dcnl dcsp help button on clicked partial onclick help params params dcnl dcsp for ci in range len picks dcnl dcsp dcsp if ch namesci in params info bads dcnl dcsp dcsp dcsp this color params bad color dcnl dcsp dcsp else dcnl dcsp dcsp dcsp this color colortypesci dcnl dcsp dcsp ax vscroll add patch mpl patches rectangle 0 ci 1 1 facecolor this color edgecolor this color zorder 4 dcnl dcsp vsel patch mpl patches rectangle 0 0 1 n channels alpha 0 5 edgecolor w facecolor w zorder 5 dcnl dcsp ax vscroll add patch vsel patch dcnl dcsp ax vscroll set ylim len types 0 dcnl dcsp ax vscroll set title ch dcnl dcsp type colors colorconverter to rgba colorc for c in types dcnl dcsp colors list dcnl dcsp for color idx in range len type colors dcnl dcsp dcsp colors append type colorscolor idx len epochs events dcnl dcsp lines list dcnl dcsp n times len epochs times dcnl dcsp for ch idx in range n channels dcnl dcsp dcsp if len colors 1 < ch idx dcnl dcsp dcsp dcsp break dcnl dcsp dcsp lc linecollection list antialiased true linewidths 0 5 zorder 3 picker 3 0 dcnl dcsp dcsp ax add collection lc dcnl dcsp dcsp lines append lc dcnl dcsp times epochs times dcnl dcsp data np zeros params info nchan len times n epochs dcnl dcsp ylim 25 0 0 0 dcnl dcsp offset ylim0 n channels dcnl dcsp offsets np arange n channels offset + offset 2 0 dcnl dcsp times np arange len times len epochs events dcnl dcsp epoch times np arange 0 len times n times dcnl dcsp ax set yticks offsets dcnl dcsp ax set ylim ylim dcnl dcsp ticks epoch times + 0 5 n times dcnl dcsp ax set xticks ticks dcnl dcsp ax2 set xticks ticks n epochs dcnl dcsp labels list range 1 len ticks + 1 dcnl dcsp ax set xticklabels labels dcnl dcsp xlim epoch times 1 + len epochs times dcnl dcsp ax hscroll set xlim 0 xlim dcnl dcsp vertline t ax hscroll text 0 1 color y va bottom ha right dcnl dcsp hscroll ticks np arange 0 xlim xlim 7 0 dcnl dcsp hscroll ticks np append hscroll ticks epoch times 1 dcnl dcsp hticks list dcnl dcsp for tick in hscroll ticks dcnl dcsp dcsp hticks append epoch times flatnp abs epoch times tick argmin dcnl dcsp hlabels x n times + 1 for x in hticks dcnl dcsp ax hscroll set xticks hticks dcnl dcsp ax hscroll set xticklabels hlabels dcnl dcsp for epoch idx in range len epoch times dcnl dcsp dcsp ax hscroll add patch mpl patches rectangle epoch idx n times 0 n times 1 facecolor w edgecolor w alpha 0 6 dcnl dcsp hsel patch mpl patches rectangle 0 0 duration 1 edgecolor k facecolor 0 75 0 75 0 75 alpha 0 25 linewidth 1 clip on false dcnl dcsp ax hscroll add patch hsel patch dcnl dcsp text ax text 0 0 blank zorder 3 verticalalignment baseline ha left fontweight bold dcnl dcsp text set visible false dcnl dcsp epoch nr true dcnl dcsp if events is not none dcnl dcsp dcsp event set set events 2 dcnl dcsp dcsp event colors handle event colors event set event colors event set dcnl dcsp dcsp epoch nr false dcnl dcsp dcsp for label in ax xaxis get ticklabels dcnl dcsp dcsp dcsp label set visible false dcnl dcsp params update fig fig ax ax ax2 ax2 ax hscroll ax hscroll ax vscroll ax vscroll vsel patch vsel patch hsel patch hsel patch lines lines projs projs ch names ch names n channels n channels n epochs n epochs scalings scalings duration duration ch start 0 colors colors def colors type colors picks picks bads np array list dtype int data data times times epoch times epoch times offsets offsets labels labels scale factor 1 0 butterfly scale 1 0 fig proj none types np array types inds inds vert lines list vertline t vertline t butterfly false text text ax help button ax help button help button help button fig options none settings true true epoch nr true image plot none events events event colors event colors ev lines list ev texts list dcnl dcsp params plot fun partial plot traces params params dcnl dcsp callback scroll partial plot onscroll params params dcnl dcsp fig canvas mpl connect scroll event callback scroll dcnl dcsp callback click partial mouse click params params dcnl dcsp fig canvas mpl connect button press event callback click dcnl dcsp callback key partial plot onkey params params dcnl dcsp fig canvas mpl connect key press event callback key dcnl dcsp callback resize partial resize event params params dcnl dcsp fig canvas mpl connect resize event callback resize dcnl dcsp fig canvas mpl connect pick event partial onpick params params dcnl dcsp params callback key callback key dcnl dcsp plot vert lines params dcnl dcsp params close key escape
def prepare projectors params dcsp import matplotlib pyplot as plt dcnl dcsp import matplotlib as mpl dcnl dcsp epochs params epochs dcnl dcsp projs params projs dcnl dcsp if len projs 0 and not epochs proj dcnl dcsp dcsp ax button plt subplot2grid 10 15 9 14 dcnl dcsp dcsp opt button mpl widgets button ax button proj dcnl dcsp dcsp callback option partial toggle options params params dcnl dcsp dcsp opt button on clicked callback option dcnl dcsp dcsp params opt button opt button dcnl dcsp dcsp params ax button ax button dcnl dcsp params plot update proj callback plot update epochs proj dcnl dcsp callback proj partial toggle proj params params dcnl dcsp params callback proj callback proj dcnl dcsp callback proj none
def plot traces params dcsp params text set visible false dcnl dcsp ax params ax dcnl dcsp butterfly params butterfly dcnl dcsp if butterfly dcnl dcsp dcsp ch start 0 dcnl dcsp dcsp n channels len params picks dcnl dcsp dcsp data params data params butterfly scale dcnl dcsp else dcnl dcsp dcsp ch start params ch start dcnl dcsp dcsp n channels params n channels dcnl dcsp dcsp data params data params scale factor dcnl dcsp offsets params offsets dcnl dcsp lines params lines dcnl dcsp epochs params epochs dcnl dcsp n times len epochs times dcnl dcsp tick list list dcnl dcsp start idx int params t start n times dcnl dcsp end params t start + params duration dcnl dcsp end idx int end n times dcnl dcsp xlabels params labels start idx dcnl dcsp event ids params epochs events 2 dcnl dcsp params ax2 set xticklabels event idsstart idx dcnl dcsp ax set xticklabels xlabels dcnl dcsp ylabels ax yaxis get ticklabels dcnl dcsp for line idx in range n channels dcnl dcsp dcsp ch idx line idx + ch start dcnl dcsp dcsp if line idx len lines dcnl dcsp dcsp dcsp break dcnl dcsp dcsp elif ch idx < len params ch names dcnl dcsp dcsp dcsp if butterfly dcnl dcsp dcsp dcsp dcsp ch type params types ch idx dcnl dcsp dcsp dcsp dcsp if ch type grad dcnl dcsp dcsp dcsp dcsp dcsp offset offsets0 dcnl dcsp dcsp dcsp dcsp elif ch type mag dcnl dcsp dcsp dcsp dcsp dcsp offset offsets1 dcnl dcsp dcsp dcsp dcsp elif ch type eeg dcnl dcsp dcsp dcsp dcsp dcsp offset offsets2 dcnl dcsp dcsp dcsp dcsp elif ch type eog dcnl dcsp dcsp dcsp dcsp dcsp offset offsets3 dcnl dcsp dcsp dcsp dcsp elif ch type ecg dcnl dcsp dcsp dcsp dcsp dcsp offset offsets4 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp linesline idx set segments list dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp tick list + params ch names ch idx dcnl dcsp dcsp dcsp dcsp offset offsetsline idx dcnl dcsp dcsp dcsp if params inds ch idx in params data picks dcnl dcsp dcsp dcsp dcsp this decim params decim dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this decim 1 dcnl dcsp dcsp dcsp this data datach idx dcnl dcsp dcsp dcsp ydata offset this data dcnl dcsp dcsp dcsp xdata params times params duration dcnl dcsp dcsp dcsp num epochs np min params n epochs len epochs events dcnl dcsp dcsp dcsp segments np split np array xdata ydata t num epochs dcnl dcsp dcsp dcsp segments segment this decim for segment in segments dcnl dcsp dcsp dcsp ch name params ch names ch idx dcnl dcsp dcsp dcsp if ch name in params info bads dcnl dcsp dcsp dcsp dcsp if not butterfly dcnl dcsp dcsp dcsp dcsp dcsp this color params bad color dcnl dcsp dcsp dcsp dcsp dcsp ylabelsline idx set color this color dcnl dcsp dcsp dcsp dcsp this color np tile params bad color num epochs 1 dcnl dcsp dcsp dcsp dcsp for bad idx in params bads dcnl dcsp dcsp dcsp dcsp dcsp if bad idx < start idx or bad idx end idx dcnl dcsp dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp dcsp this color bad idx start idx 1 0 0 0 0 0 dcnl dcsp dcsp dcsp dcsp linesline idx set zorder 2 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this color params colors ch idxstart idx end idx dcnl dcsp dcsp dcsp dcsp linesline idx set zorder 3 dcnl dcsp dcsp dcsp dcsp if not butterfly dcnl dcsp dcsp dcsp dcsp dcsp ylabelsline idx set color black dcnl dcsp dcsp dcsp linesline idx set segments segments dcnl dcsp dcsp dcsp linesline idx set color this color dcnl dcsp dcsp else dcnl dcsp dcsp dcsp linesline idx set segments list dcnl dcsp ax set xlim params times 0 params times 0 + params duration false dcnl dcsp params ax2 set xlim params times 0 params times 0 + params duration false dcnl dcsp if butterfly dcnl dcsp dcsp factor 1 0 params butterfly scale dcnl dcsp dcsp labels np empty 20 dtype s15 dcnl dcsp dcsp labels fill dcnl dcsp dcsp ticks ax get yticks dcnl dcsp dcsp idx offset 1 dcnl dcsp dcsp if grad in params types dcnl dcsp dcsp dcsp labels idx offset + 1 0 00 dcnl dcsp dcsp dcsp for idx in idx offset idx offset + 2 dcnl dcsp dcsp dcsp dcsp labelsidx 0 2f format ticksidx offsets0 params scalings grad 10000000000000 0 factor dcnl dcsp dcsp dcsp idx offset + 4 dcnl dcsp dcsp if mag in params types dcnl dcsp dcsp dcsp labels idx offset + 1 0 00 dcnl dcsp dcsp dcsp for idx in idx offset idx offset + 2 dcnl dcsp dcsp dcsp dcsp labelsidx 0 2f format ticksidx offsets1 params scalings mag 1000000000000000 0 factor dcnl dcsp dcsp dcsp idx offset + 4 dcnl dcsp dcsp if eeg in params types dcnl dcsp dcsp dcsp labels idx offset + 1 0 00 dcnl dcsp dcsp dcsp for idx in idx offset idx offset + 2 dcnl dcsp dcsp dcsp dcsp labelsidx 0 2f format ticksidx offsets2 params scalings eeg 1000000 0 factor dcnl dcsp dcsp dcsp idx offset + 4 dcnl dcsp dcsp if eog in params types dcnl dcsp dcsp dcsp labels idx offset + 1 0 00 dcnl dcsp dcsp dcsp for idx in idx offset idx offset + 2 dcnl dcsp dcsp dcsp dcsp labelsidx 0 2f format ticksidx offsets3 params scalings eog 1000000 0 factor dcnl dcsp dcsp dcsp idx offset + 4 dcnl dcsp dcsp if ecg in params types dcnl dcsp dcsp dcsp labels idx offset + 1 0 00 dcnl dcsp dcsp dcsp for idx in idx offset idx offset + 2 dcnl dcsp dcsp dcsp dcsp labelsidx 0 2f format ticksidx offsets4 params scalings ecg 1000000 0 factor dcnl dcsp dcsp ax set yticklabels labels fontsize 12 color black dcnl dcsp else dcnl dcsp dcsp ax set yticklabels tick list fontsize 12 dcnl dcsp if params events is not none dcnl dcsp dcsp draw event lines params dcnl dcsp params vsel patch set y ch start dcnl dcsp params fig canvas draw dcnl dcsp if params fig proj is not none dcnl dcsp dcsp params fig proj canvas draw
def plot update epochs proj params bools none dcsp if bools is not none dcnl dcsp dcsp inds np where bools 0 dcnl dcsp dcsp params info projs copy deepcopy params projs ii for ii in inds dcnl dcsp dcsp params proj bools bools dcnl dcsp epochs params epochs dcnl dcsp n epochs params n epochs dcnl dcsp params projector setup proj params info add eeg ref false verbose false dcnl dcsp start int params t start len epochs times dcnl dcsp end start + n epochs dcnl dcsp if epochs preload dcnl dcsp dcsp data np concatenate epochs get data start end axis 1 dcnl dcsp else dcnl dcsp dcsp data np concatenate epochsstart end get data axis 1 dcnl dcsp if params projector is not none dcnl dcsp dcsp data np dot params projector data dcnl dcsp types params types dcnl dcsp for pick ind in enumerate params inds dcnl dcsp dcsp params data pick dataind params scalings typespick dcnl dcsp params plot fun
def handle picks epochs dcsp if any ica in k for k in epochs ch names dcnl dcsp dcsp picks pick types epochs info misc true ref meg false exclude dcnl dcsp else dcnl dcsp dcsp picks pick types epochs info meg true eeg true eog true ecg true seeg true ecog true ref meg false fnirs true exclude dcnl dcsp return picks
def plot window value params dcsp max times len params times params duration dcnl dcsp if value max times dcnl dcsp dcsp value len params times params duration dcnl dcsp if value < 0 dcnl dcsp dcsp value 0 dcnl dcsp if params t start value dcnl dcsp dcsp params t start value dcnl dcsp dcsp params hsel patch set x value dcnl dcsp dcsp params plot update proj callback params
def plot vert lines params dcsp ax params ax dcnl dcsp while len ax lines 0 dcnl dcsp dcsp ax lines pop dcnl dcsp params vert lines list dcnl dcsp params ev lines list dcnl dcsp params vertline t set text dcnl dcsp epochs params epochs dcnl dcsp if params settings 3 dcnl dcsp dcsp t zero np where epochs times 0 0 0 dcnl dcsp dcsp if len t zero 1 dcnl dcsp dcsp dcsp for event idx in range len epochs events dcnl dcsp dcsp dcsp dcsp pos event idx len epochs times + t zero0 event idx len epochs times + t zero0 dcnl dcsp dcsp dcsp dcsp ax plot pos ax get ylim g zorder 4 alpha 0 4 dcnl dcsp for epoch idx in range len epochs events dcnl dcsp dcsp pos epoch idx len epochs times epoch idx len epochs times dcnl dcsp dcsp ax plot pos ax get ylim color black linestyle zorder 2 dcnl dcsp if params events is not none dcnl dcsp dcsp draw event lines params
def pick bad epochs event params dcsp if ica in params dcnl dcsp dcsp pos event xdata event ydata dcnl dcsp dcsp pick bad channels pos params dcnl dcsp dcsp return dcnl dcsp n times len params epochs times dcnl dcsp start idx int params t start n times dcnl dcsp xdata event xdata dcnl dcsp xlim event inaxes get xlim dcnl dcsp epoch idx start idx + int xdata xlim1 params n epochs dcnl dcsp total epochs len params epochs events dcnl dcsp if epoch idx total epochs 1 dcnl dcsp dcsp return dcnl dcsp if epoch idx in params bads dcnl dcsp dcsp params bads params bads params bads epoch idx dcnl dcsp dcsp for ch idx in range len params ch names dcnl dcsp dcsp dcsp params colors ch idxepoch idx params def colors ch idx dcnl dcsp dcsp params ax hscroll patchesepoch idx set color w dcnl dcsp dcsp params ax hscroll patchesepoch idx set zorder 2 dcnl dcsp dcsp params plot fun dcnl dcsp dcsp return dcnl dcsp params bads np append params bads epoch idx dcnl dcsp params ax hscroll patchesepoch idx set color 1 0 0 0 0 0 1 0 dcnl dcsp params ax hscroll patchesepoch idx set zorder 3 dcnl dcsp params ax hscroll patchesepoch idx set edgecolor w dcnl dcsp for ch idx in range len params ch names dcnl dcsp dcsp params colors ch idxepoch idx 1 0 0 0 0 0 1 0 dcnl dcsp params plot fun
def pick bad channels pos params dcsp text ch idx label2idx params pos dcnl dcsp if text is none dcnl dcsp dcsp return dcnl dcsp if text in params info bads dcnl dcsp dcsp while text in params info bads dcnl dcsp dcsp dcsp params info bads remove text dcnl dcsp dcsp color params def colors ch idx dcnl dcsp dcsp params ax vscroll patches ch idx + 1 set color color dcnl dcsp else dcnl dcsp dcsp params info bads append text dcnl dcsp dcsp color params bad color dcnl dcsp dcsp params ax vscroll patches ch idx + 1 set color color dcnl dcsp if ica in params dcnl dcsp dcsp params plot fun dcnl dcsp else dcnl dcsp dcsp params plot update proj callback params
def plot onscroll event params dcsp if event key control dcnl dcsp dcsp if event step < 0 dcnl dcsp dcsp dcsp event key dcnl dcsp dcsp else dcnl dcsp dcsp dcsp event key + dcnl dcsp dcsp plot onkey event params dcnl dcsp dcsp return dcnl dcsp if params butterfly dcnl dcsp dcsp return dcnl dcsp plot raw onscroll event params len params ch names
def mouse click event params dcsp if event inaxes is none dcnl dcsp dcsp if params butterfly or not params settings 0 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp ax params ax dcnl dcsp dcsp ylim ax get ylim dcnl dcsp dcsp pos ax transdata inverted transform event x event y dcnl dcsp dcsp if pos0 0 or pos1 < 0 or pos1 ylim0 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp if event button 1 dcnl dcsp dcsp dcsp params label click fun pos dcnl dcsp dcsp elif event button 3 dcnl dcsp dcsp dcsp if ica not in params dcnl dcsp dcsp dcsp dcsp ch idx label2idx params pos dcnl dcsp dcsp dcsp dcsp if ch idx is none dcnl dcsp dcsp dcsp dcsp dcsp return dcnl dcsp dcsp dcsp dcsp if channel type params info ch idx not in mag grad eeg eog dcnl dcsp dcsp dcsp dcsp dcsp logger info event dcsp related dcsp fields dcsp dcsp potentials dcsp only dcsp available dcsp for dcsp meg dcsp and dcsp eeg dcsp channels dcnl dcsp dcsp dcsp dcsp dcsp return dcnl dcsp dcsp dcsp dcsp fig plot epochs image params epochs picks params inds ch idx fig params image plot 0 dcnl dcsp dcsp dcsp dcsp params image plot fig dcnl dcsp elif event button 1 dcnl dcsp dcsp if event inaxes params ax vscroll dcnl dcsp dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp dcsp return dcnl dcsp dcsp dcsp ch start min max int event ydata params n channels 2 0 len params ch names params n channels dcnl dcsp dcsp dcsp if params ch start ch start dcnl dcsp dcsp dcsp dcsp params ch start ch start dcnl dcsp dcsp dcsp dcsp params plot fun dcnl dcsp dcsp elif event inaxes params ax hscroll dcnl dcsp dcsp dcsp times params epoch times dcnl dcsp dcsp dcsp offset 0 5 params n epochs len params epochs times dcnl dcsp dcsp dcsp xdata times flatnp abs times event xdata offset argmin dcnl dcsp dcsp dcsp plot window xdata params dcnl dcsp dcsp elif event inaxes params ax dcnl dcsp dcsp dcsp pick bad epochs event params dcnl dcsp elif event inaxes params ax and event button 2 dcnl dcsp dcsp params fig canvas draw dcnl dcsp dcsp if params fig proj is not none dcnl dcsp dcsp dcsp params fig proj canvas draw dcnl dcsp elif event inaxes params ax and event button 3 dcnl dcsp dcsp n times len params epochs times dcnl dcsp dcsp xdata int event xdata n times dcnl dcsp dcsp prev xdata 0 dcnl dcsp dcsp if len params vert lines 0 dcnl dcsp dcsp dcsp prev xdata params vert lines 00 get data 00 dcnl dcsp dcsp dcsp while len params vert lines 0 dcnl dcsp dcsp dcsp dcsp params ax lines remove params vert lines 00 dcnl dcsp dcsp dcsp dcsp params vert lines pop 0 dcnl dcsp dcsp if prev xdata xdata dcnl dcsp dcsp dcsp params vertline t set text dcnl dcsp dcsp dcsp params plot fun dcnl dcsp dcsp dcsp return dcnl dcsp dcsp ylim params ax get ylim dcnl dcsp dcsp for epoch idx in range params n epochs dcnl dcsp dcsp dcsp pos epoch idx n times + xdata epoch idx n times + xdata dcnl dcsp dcsp dcsp params vert lines append params ax plot pos ylim y zorder 5 dcnl dcsp dcsp params vertline t set text 0 3f params epochs timesxdata dcnl dcsp dcsp params plot fun
def plot onkey event params dcsp import matplotlib pyplot as plt dcnl dcsp if event key down dcnl dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params ch start + params n channels dcnl dcsp dcsp channels changed params len params ch names dcnl dcsp elif event key up dcnl dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params ch start params n channels dcnl dcsp dcsp channels changed params len params ch names dcnl dcsp elif event key left dcnl dcsp dcsp sample params t start params duration dcnl dcsp dcsp sample np max 0 sample dcnl dcsp dcsp plot window sample params dcnl dcsp elif event key right dcnl dcsp dcsp sample params t start + params duration dcnl dcsp dcsp sample np min sample params times 1 params duration dcnl dcsp dcsp times params epoch times dcnl dcsp dcsp xdata times flatnp abs times sample argmin dcnl dcsp dcsp plot window xdata params dcnl dcsp elif event key dcnl dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp params butterfly scale 1 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp params scale factor 1 1 dcnl dcsp dcsp params plot fun dcnl dcsp elif event key in + dcnl dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp params butterfly scale 1 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp params scale factor 1 1 dcnl dcsp dcsp params plot fun dcnl dcsp elif event key f11 dcnl dcsp dcsp mng plt get current fig manager dcnl dcsp dcsp mng full screen toggle dcnl dcsp elif event key pagedown dcnl dcsp dcsp if params n channels 1 or params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp n channels params n channels 1 dcnl dcsp dcsp ylim params ax get ylim dcnl dcsp dcsp offset ylim0 n channels dcnl dcsp dcsp params offsets np arange n channels offset + offset 2 0 dcnl dcsp dcsp params n channels n channels dcnl dcsp dcsp params ax collections pop dcnl dcsp dcsp params ax set yticks params offsets dcnl dcsp dcsp params lines pop dcnl dcsp dcsp params vsel patch set height n channels dcnl dcsp dcsp params plot fun dcnl dcsp elif event key pageup dcnl dcsp dcsp if params butterfly dcnl dcsp dcsp dcsp return dcnl dcsp dcsp from matplotlib collections import linecollection dcnl dcsp dcsp n channels params n channels + 1 dcnl dcsp dcsp ylim params ax get ylim dcnl dcsp dcsp offset ylim0 n channels dcnl dcsp dcsp params offsets np arange n channels offset + offset 2 0 dcnl dcsp dcsp params n channels n channels dcnl dcsp dcsp lc linecollection list antialiased true linewidths 0 5 zorder 3 picker 3 0 dcnl dcsp dcsp params ax add collection lc dcnl dcsp dcsp params ax set yticks params offsets dcnl dcsp dcsp params lines append lc dcnl dcsp dcsp params vsel patch set height n channels dcnl dcsp dcsp params plot fun dcnl dcsp elif event key home dcnl dcsp dcsp n epochs params n epochs 1 dcnl dcsp dcsp if n epochs < 0 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp n times len params epochs times dcnl dcsp dcsp ticks params epoch times + 0 5 n times dcnl dcsp dcsp params ax2 set xticks ticks n epochs dcnl dcsp dcsp params n epochs n epochs dcnl dcsp dcsp params duration n times dcnl dcsp dcsp params hsel patch set width params duration dcnl dcsp dcsp params data params data n times dcnl dcsp dcsp params plot update proj callback params dcnl dcsp elif event key end dcnl dcsp dcsp n epochs params n epochs + 1 dcnl dcsp dcsp n times len params epochs times dcnl dcsp dcsp if n times n epochs len params times dcnl dcsp dcsp dcsp return dcnl dcsp dcsp ticks params epoch times + 0 5 n times dcnl dcsp dcsp params ax2 set xticks ticks n epochs dcnl dcsp dcsp params n epochs n epochs dcnl dcsp dcsp if len params vert lines 0 dcnl dcsp dcsp dcsp ax params ax dcnl dcsp dcsp dcsp pos params vert lines 00 get data 0 + params duration dcnl dcsp dcsp dcsp params vert lines append ax plot pos ax get ylim y zorder 4 dcnl dcsp dcsp params duration + n times dcnl dcsp dcsp if params t start + params duration len params times dcnl dcsp dcsp dcsp params t start n times dcnl dcsp dcsp dcsp params hsel patch set x params t start dcnl dcsp dcsp params hsel patch set width params duration dcnl dcsp dcsp params data np zeros len params data params duration dcnl dcsp dcsp params plot update proj callback params dcnl dcsp elif event key b dcnl dcsp dcsp if params fig options is not none dcnl dcsp dcsp dcsp plt close params fig options dcnl dcsp dcsp dcsp params fig options none dcnl dcsp dcsp prepare butterfly params dcnl dcsp dcsp plot traces params dcnl dcsp elif event key o dcnl dcsp dcsp if not params butterfly dcnl dcsp dcsp dcsp open options params dcnl dcsp elif event key h dcnl dcsp dcsp plot histogram params dcnl dcsp elif event key dcnl dcsp dcsp onclick help event params dcnl dcsp elif event key escape dcnl dcsp dcsp plt close params fig
def prepare butterfly params dcsp from matplotlib collections import linecollection dcnl dcsp butterfly not params butterfly dcnl dcsp if butterfly dcnl dcsp dcsp types set grad mag eeg eog ecg set params types dcnl dcsp dcsp if len types < 1 dcnl dcsp dcsp dcsp return dcnl dcsp dcsp params ax vscroll set visible false dcnl dcsp dcsp ax params ax dcnl dcsp dcsp labels ax yaxis get ticklabels dcnl dcsp dcsp for label in labels dcnl dcsp dcsp dcsp label set visible true dcnl dcsp dcsp ylim 5 0 len types 0 0 dcnl dcsp dcsp ax set ylim ylim dcnl dcsp dcsp offset ylim0 4 0 len types dcnl dcsp dcsp ticks np arange 0 ylim0 offset dcnl dcsp dcsp ticks ticksx if x < len ticks else 0 for x in range 20 dcnl dcsp dcsp ax set yticks ticks dcnl dcsp dcsp used types 0 dcnl dcsp dcsp params offsets ticks2 dcnl dcsp dcsp if grad in types dcnl dcsp dcsp dcsp pos 0 1 ticks2 ylim0 dcnl dcsp dcsp dcsp params ax2 annotate grad dcsp ft cm xy pos xytext 70 0 ha left size 12 va center xycoords axes dcsp fraction rotation 90 textcoords offset dcsp points dcnl dcsp dcsp dcsp used types + 1 dcnl dcsp dcsp params offsets append ticks 2 + used types 4 dcnl dcsp dcsp if mag in types dcnl dcsp dcsp dcsp pos 0 1 ticks 2 + used types 4 ylim0 dcnl dcsp dcsp dcsp params ax2 annotate mag dcsp ft xy pos xytext 70 0 ha left size 12 va center xycoords axes dcsp fraction rotation 90 textcoords offset dcsp points dcnl dcsp dcsp dcsp used types + 1 dcnl dcsp dcsp params offsets append ticks 2 + used types 4 dcnl dcsp dcsp if eeg in types dcnl dcsp dcsp dcsp pos 0 1 ticks 2 + used types 4 ylim0 dcnl dcsp dcsp dcsp params ax2 annotate eeg dcsp uv xy pos xytext 70 0 ha left size 12 va center xycoords axes dcsp fraction rotation 90 textcoords offset dcsp points dcnl dcsp dcsp dcsp used types + 1 dcnl dcsp dcsp params offsets append ticks 2 + used types 4 dcnl dcsp dcsp if eog in types dcnl dcsp dcsp dcsp pos 0 1 ticks 2 + used types 4 ylim0 dcnl dcsp dcsp dcsp params ax2 annotate eog dcsp uv xy pos xytext 70 0 ha left size 12 va center xycoords axes dcsp fraction rotation 90 textcoords offset dcsp points dcnl dcsp dcsp dcsp used types + 1 dcnl dcsp dcsp params offsets append ticks 2 + used types 4 dcnl dcsp dcsp if ecg in types dcnl dcsp dcsp dcsp pos 0 1 ticks 2 + used types 4 ylim0 dcnl dcsp dcsp dcsp params ax2 annotate ecg dcsp uv xy pos xytext 70 0 ha left size 12 va center xycoords axes dcsp fraction rotation 90 textcoords offset dcsp points dcnl dcsp dcsp dcsp used types + 1 dcnl dcsp dcsp while len params lines < len params picks dcnl dcsp dcsp dcsp lc linecollection list antialiased true linewidths 0 5 zorder 3 picker 3 0 dcnl dcsp dcsp dcsp ax add collection lc dcnl dcsp dcsp dcsp params lines append lc dcnl dcsp else dcnl dcsp dcsp labels params ax yaxis get ticklabels dcnl dcsp dcsp for label in labels dcnl dcsp dcsp dcsp label set visible params settings 0 dcnl dcsp dcsp params ax vscroll set visible true dcnl dcsp dcsp while len params ax2 texts 0 dcnl dcsp dcsp dcsp params ax2 texts pop dcnl dcsp dcsp n channels params n channels dcnl dcsp dcsp while len params lines n channels dcnl dcsp dcsp dcsp params ax collections pop dcnl dcsp dcsp dcsp params lines pop dcnl dcsp dcsp ylim 25 0 0 0 dcnl dcsp dcsp params ax set ylim ylim dcnl dcsp dcsp offset ylim0 n channels dcnl dcsp dcsp params offsets np arange n channels offset + offset 2 0 dcnl dcsp dcsp params ax set yticks params offsets dcnl dcsp params butterfly butterfly
def onpick event params dcsp if event mouseevent button 2 or not params butterfly dcnl dcsp dcsp return dcnl dcsp lidx np where l is event artist for l in params lines 00 dcnl dcsp text params text dcnl dcsp text set x event mouseevent xdata dcnl dcsp text set y event mouseevent ydata dcnl dcsp text set text params ch names lidx dcnl dcsp text set visible true
def close event event params dcsp params epochs drop params bads dcnl dcsp params epochs info bads params info bads dcnl dcsp logger info channels dcsp marked dcsp as dcsp bad dcsp s params epochs info bads
def resize event event params dcsp size join str s for s in params fig get size inches dcnl dcsp set config mne browse raw size size set env false dcnl dcsp layout figure params
def update channels epochs event params dcsp from matplotlib collections import linecollection dcnl dcsp n channels int np around params channel slider val dcnl dcsp offset params ax get ylim 0 n channels dcnl dcsp params offsets np arange n channels offset + offset 2 0 dcnl dcsp while len params lines n channels dcnl dcsp dcsp params ax collections pop dcnl dcsp dcsp params lines pop dcnl dcsp while len params lines < n channels dcnl dcsp dcsp lc linecollection list linewidths 0 5 antialiased true zorder 3 picker 3 0 dcnl dcsp dcsp params ax add collection lc dcnl dcsp dcsp params lines append lc dcnl dcsp params ax set yticks params offsets dcnl dcsp params vsel patch set height n channels dcnl dcsp params n channels n channels dcnl dcsp n epochs int np around params epoch slider val dcnl dcsp n times len params epochs times dcnl dcsp ticks params epoch times + 0 5 n times dcnl dcsp params ax2 set xticks ticks n epochs dcnl dcsp params n epochs n epochs dcnl dcsp params duration n times n epochs dcnl dcsp params hsel patch set width params duration dcnl dcsp params data np zeros len params data params duration dcnl dcsp if params t start + n times n epochs len params times dcnl dcsp dcsp params t start len params times n times n epochs dcnl dcsp dcsp params hsel patch set x params t start dcnl dcsp params plot update proj callback params
def toggle labels label params dcsp if label channel dcsp names dcsp visible dcnl dcsp dcsp params settings 0 not params settings 0 dcnl dcsp dcsp labels params ax yaxis get ticklabels dcnl dcsp dcsp for label in labels dcnl dcsp dcsp dcsp label set visible params settings 0 dcnl dcsp elif label eventid dcsp visible dcnl dcsp dcsp params settings 1 not params settings 1 dcnl dcsp dcsp labels params ax2 xaxis get ticklabels dcnl dcsp dcsp for label in labels dcnl dcsp dcsp dcsp label set visible params settings 1 dcnl dcsp elif label epochid dcsp visible dcnl dcsp dcsp params settings 2 not params settings 2 dcnl dcsp dcsp labels params ax xaxis get ticklabels dcnl dcsp dcsp for label in labels dcnl dcsp dcsp dcsp label set visible params settings 2 dcnl dcsp elif label zeroline dcsp visible dcnl dcsp dcsp params settings 3 not params settings 3 dcnl dcsp dcsp plot vert lines params dcnl dcsp params fig canvas draw dcnl dcsp if params fig proj is not none dcnl dcsp dcsp params fig proj canvas draw
def open options params dcsp import matplotlib pyplot as plt dcnl dcsp import matplotlib as mpl dcnl dcsp if params fig options is not none dcnl dcsp dcsp plt close params fig options dcnl dcsp dcsp params fig options none dcnl dcsp dcsp return dcnl dcsp width 10 dcnl dcsp height 3 dcnl dcsp fig options figure nobar figsize width height dpi 80 dcnl dcsp fig options canvas set window title view dcsp settings dcnl dcsp params fig options fig options dcnl dcsp ax channels plt axes 0 15 0 1 0 65 0 1 dcnl dcsp ax epochs plt axes 0 15 0 25 0 65 0 1 dcnl dcsp ax button plt axes 0 85 0 1 0 1 0 25 dcnl dcsp ax check plt axes 0 15 0 4 0 4 0 55 dcnl dcsp plt axis off dcnl dcsp params update button mpl widgets button ax button update dcnl dcsp params channel slider mpl widgets slider ax channels channels 1 len params ch names valfmt 0 0f valinit params n channels dcnl dcsp params epoch slider mpl widgets slider ax epochs epochs 1 len params epoch times valfmt 0 0f valinit params n epochs dcnl dcsp params checkbox mpl widgets checkbuttons ax check channel dcsp names dcsp visible eventid dcsp visible epochid dcsp visible zeroline dcsp visible actives params settings dcnl dcsp update partial update channels epochs params params dcnl dcsp params update button on clicked update dcnl dcsp labels callback partial toggle labels params params dcnl dcsp params checkbox on clicked labels callback dcnl dcsp close callback partial settings closed params params dcnl dcsp params fig options canvas mpl connect close event close callback dcnl dcsp try dcnl dcsp dcsp params fig options canvas draw dcnl dcsp dcsp params fig options show warn false dcnl dcsp dcsp if params fig proj is not none dcnl dcsp dcsp dcsp params fig proj canvas draw dcnl dcsp except exception dcnl dcsp dcsp pass
def settings closed events params dcsp params fig options none
def plot histogram params dcsp import matplotlib pyplot as plt dcnl dcsp epochs params epochs dcnl dcsp p2p np ptp epochs get data axis 2 dcnl dcsp types list dcnl dcsp data list dcnl dcsp if eeg in params types dcnl dcsp dcsp eegs np array p2p ti for i x in enumerate params types if x eeg dcnl dcsp dcsp data append eegs ravel dcnl dcsp dcsp types append eeg dcnl dcsp if mag in params types dcnl dcsp dcsp mags np array p2p ti for i x in enumerate params types if x mag dcnl dcsp dcsp data append mags ravel dcnl dcsp dcsp types append mag dcnl dcsp if grad in params types dcnl dcsp dcsp grads np array p2p ti for i x in enumerate params types if x grad dcnl dcsp dcsp data append grads ravel dcnl dcsp dcsp types append grad dcnl dcsp params histogram plt figure dcnl dcsp scalings handle default scalings dcnl dcsp units handle default units dcnl dcsp titles handle default titles dcnl dcsp colors handle default color dcnl dcsp for idx in range len types dcnl dcsp dcsp ax plt subplot len types 1 idx + 1 dcnl dcsp dcsp plt xlabel unitstypesidx dcnl dcsp dcsp plt ylabel count dcnl dcsp dcsp color colorstypesidx dcnl dcsp dcsp rej none dcnl dcsp dcsp if epochs reject is not none and typesidx in epochs reject keys dcnl dcsp dcsp dcsp rej epochs rejecttypesidx scalingstypesidx dcnl dcsp dcsp dcsp rng 0 0 rej 1 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp rng none dcnl dcsp dcsp plt hist dataidx scalingstypesidx bins 100 color color range rng dcnl dcsp dcsp if rej is not none dcnl dcsp dcsp dcsp ax plot rej rej 0 ax get ylim 1 color r dcnl dcsp dcsp plt title titlestypesidx dcnl dcsp params histogram suptitle peaktopeak dcsp histogram y 0 99 dcnl dcsp params histogram subplots adjust hspace 0 6 dcnl dcsp try dcnl dcsp dcsp params histogram show warn false dcnl dcsp except dcnl dcsp dcsp pass dcnl dcsp if params fig proj is not none dcnl dcsp dcsp params fig proj canvas draw
def label2idx params pos dcsp labels params ax yaxis get ticklabels dcnl dcsp offsets np array params offsets + params offsets 0 dcnl dcsp line idx np searchsorted offsets pos1 dcnl dcsp text labelsline idx get text dcnl dcsp if len text 0 dcnl dcsp dcsp return none none dcnl dcsp ch idx params ch start + line idx dcnl dcsp return text ch idx
def draw event lines params dcsp epochs params epochs dcnl dcsp n times len epochs times dcnl dcsp start idx int params t start n times dcnl dcsp color params event colors dcnl dcsp ax params ax dcnl dcsp for ev line in params ev lines dcnl dcsp dcsp ax lines remove ev line dcnl dcsp for ev text in params ev texts dcnl dcsp dcsp ax texts remove ev text dcnl dcsp params ev texts list dcnl dcsp params ev lines list dcnl dcsp t zero np where epochs times 0 0 0 dcnl dcsp if len t zero 0 dcnl dcsp dcsp t zero epochs times0 1 epochs info sfreq dcnl dcsp end params n epochs + start idx dcnl dcsp samp times params events 0 dcnl dcsp for idx event in enumerate epochs eventsstart idx end dcnl dcsp dcsp event mask event0 t zero < samp times samp times < event0 + n times t zero dcnl dcsp dcsp for ev in params events event mask dcnl dcsp dcsp dcsp if ev0 event0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp pos idx n times + ev0 event0 + t zero idx n times + ev0 event0 + t zero dcnl dcsp dcsp dcsp kwargs if ev2 not in color else color colorev2 dcnl dcsp dcsp dcsp params ev lines append ax plot pos ax get ylim zorder 3 kwargs 0 dcnl dcsp dcsp dcsp params ev texts append ax text pos0 ax get ylim 0 ev2 color colorev2 ha center va top
def plot update raw proj params bools dcsp if bools is not none dcnl dcsp dcsp inds np where bools 0 dcnl dcsp dcsp params info projs copy deepcopy params projs ii for ii in inds dcnl dcsp dcsp params proj bools bools dcnl dcsp params projector setup proj params info add eeg ref false verbose false dcnl dcsp params update fun dcnl dcsp params plot fun
def update raw data params dcsp from scipy signal import filtfilt dcnl dcsp start params t start dcnl dcsp start params first time dcnl dcsp stop params raw time as index start + params duration 0 dcnl dcsp start params raw time as index start 0 dcnl dcsp data picks pick data channels params raw info dcnl dcsp data times params raw start stop dcnl dcsp if params projector is not none dcnl dcsp dcsp data np dot params projector data dcnl dcsp if params remove dc is true dcnl dcsp dcsp data np mean data axis 1 np newaxis dcnl dcsp if params ba is not none dcnl dcsp dcsp datadata picks filtfilt params ba 0 params ba 1 datadata picks axis 1 padlen 0 dcnl dcsp for di in range data shape0 dcnl dcsp dcsp datadi params scalings params types di dcnl dcsp dcsp if params types di stim dcnl dcsp dcsp dcsp norm float max datadi dcnl dcsp dcsp dcsp datadi norm if norm 0 else 1 0 dcnl dcsp if params clipping transparent dcnl dcsp dcsp datanp logical or data 1 data < 1 np nan dcnl dcsp elif params clipping clamp dcnl dcsp dcsp data np clip data 1 1 data dcnl dcsp params data data dcnl dcsp params times times
def pick bad channels event params dcsp if params fig annotation is not none dcnl dcsp dcsp return dcnl dcsp bads params raw info bads dcnl dcsp params info bads select bads event params bads dcnl dcsp plot update raw proj params none
def plot raw raw events none duration 10 0 start 0 0 n channels 20 bgcolor w color none bad color 0 8 0 8 0 8 event color cyan scalings none remove dc true order none show options false title none show true block false highpass none lowpass none filtorder 4 clipping none show first samp false proj true group by type butterfly false decim auto dcsp import matplotlib pyplot as plt dcnl dcsp import matplotlib as mpl dcnl dcsp from scipy signal import butter dcnl dcsp color handle default color color dcnl dcsp scalings compute scalings scalings raw dcnl dcsp scalings handle default scalings plot raw scalings dcnl dcsp if clipping is not none and clipping not in clamp transparent dcnl dcsp dcsp raise valueerror clipping dcsp must dcsp be dcsp none dcsp clamp dcsp or dcsp transparent dcsp not dcsp s clipping dcnl dcsp nyq raw info sfreq 2 0 dcnl dcsp if highpass is none and lowpass is none dcnl dcsp dcsp ba none dcnl dcsp else dcnl dcsp dcsp filtorder int filtorder dcnl dcsp dcsp if filtorder < 0 dcnl dcsp dcsp dcsp raise valueerror filtorder dcsp s dcsp must dcsp be dcsp dcsp 1 filtorder dcnl dcsp dcsp if highpass is not none and highpass < 0 dcnl dcsp dcsp dcsp raise valueerror highpass dcsp must dcsp be dcsp dcsp 0 dcsp not dcsp s highpass dcnl dcsp dcsp if lowpass is not none and lowpass nyq dcnl dcsp dcsp dcsp raise valueerror lowpass dcsp must dcsp be dcsp < dcsp nyquist dcsp s dcsp not dcsp s nyq lowpass dcnl dcsp dcsp if highpass is none dcnl dcsp dcsp dcsp ba butter filtorder lowpass nyq lowpass analog false dcnl dcsp dcsp elif lowpass is none dcnl dcsp dcsp dcsp ba butter filtorder highpass nyq highpass analog false dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if lowpass < highpass dcnl dcsp dcsp dcsp dcsp raise valueerror lowpass dcsp s dcsp must dcsp be dcsp dcsp highpass dcsp s lowpass highpass dcnl dcsp dcsp dcsp ba butter filtorder highpass nyq lowpass nyq bandpass analog false dcnl dcsp info raw info copy dcnl dcsp projs info projs dcnl dcsp info projs dcnl dcsp n times raw n times dcnl dcsp if title is none dcnl dcsp dcsp title raw filenames dcnl dcsp dcsp if len title 0 dcnl dcsp dcsp dcsp title <unknown dcnl dcsp dcsp elif len title 1 dcnl dcsp dcsp dcsp title title0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp title s dcsp dcsp + dcsp d dcsp more dcsp title0 len title 1 dcnl dcsp dcsp dcsp if len title 60 dcnl dcsp dcsp dcsp dcsp title + title 60 dcnl dcsp elif not isinstance title string types dcnl dcsp dcsp raise typeerror title dcsp must dcsp be dcsp none dcsp or dcsp a dcsp string dcnl dcsp if events is not none dcnl dcsp dcsp event times events 0 astype float raw first samp dcnl dcsp dcsp event times info sfreq dcnl dcsp dcsp event nums events 2 dcnl dcsp else dcnl dcsp dcsp event times event nums none dcnl dcsp inds list dcnl dcsp types list dcnl dcsp for t in grad mag dcnl dcsp dcsp inds + pick types info meg t ref meg false exclude dcnl dcsp dcsp types + t len inds 1 dcnl dcsp for t in hbo hbr dcnl dcsp dcsp inds + pick types info meg false ref meg false fnirs t exclude dcnl dcsp dcsp types + t len inds 1 dcnl dcsp pick kwargs dict meg false ref meg false exclude dcnl dcsp for key in pick types keys dcnl dcsp dcsp if key not in meg fnirs dcnl dcsp dcsp dcsp pick kwargskey true dcnl dcsp dcsp dcsp inds + pick types raw info pick kwargs dcnl dcsp dcsp dcsp types + key len inds 1 dcnl dcsp dcsp dcsp pick kwargskey false dcnl dcsp inds np concatenate inds astype int dcnl dcsp if not len inds len info ch names dcnl dcsp dcsp raise runtimeerror some dcsp channels dcsp not dcsp classified dcsp please dcsp report dcsp this dcsp problem dcnl dcsp reord np argsort inds dcnl dcsp types typesri for ri in reord dcnl dcsp if isinstance order string types dcnl dcsp dcsp group by order dcnl dcsp dcsp warn using dcsp string dcsp order dcsp is dcsp deprecated dcsp and dcsp will dcsp not dcsp be dcsp allowed dcsp in dcsp 0 16 dcsp use dcsp group by dcsp instead dcnl dcsp elif isinstance order np ndarray list dcnl dcsp dcsp inds indsreordorder dcnl dcsp elif order is not none dcnl dcsp dcsp raise valueerror unkown dcsp order dcsp type dcsp got dcsp s type order dcnl dcsp if group by in selection position dcnl dcsp dcsp selections fig selection setup browser selection raw group by dcnl dcsp dcsp selections k np intersect1d v inds for k v in selections items dcnl dcsp elif group by original dcnl dcsp dcsp if order is none dcnl dcsp dcsp dcsp order np arange len inds dcnl dcsp dcsp dcsp inds indsreord len order dcnl dcsp elif group by type dcnl dcsp dcsp raise valueerror unknown dcsp group by dcsp type dcsp s group by dcnl dcsp if not isinstance event color dict dcnl dcsp dcsp event color 1 event color dcnl dcsp event color dict ensure int key event color dcsp key event colorkey for key in event color dcnl dcsp for key in event color dcnl dcsp dcsp if key < 0 and key 1 dcnl dcsp dcsp dcsp raise keyerror only dcsp key dcsp < dcsp 0 dcsp allowed dcsp is dcsp 1 dcsp cannot dcsp use dcsp s key dcnl dcsp decim data picks handle decim info decim lowpass dcnl dcsp duration min raw times 1 float duration dcnl dcsp first time raw first time if show first samp else 0 dcnl dcsp start + first time dcnl dcsp params dict raw raw ch start 0 t start start duration duration info info projs projs remove dc remove dc ba ba n channels n channels scalings scalings types types n times n times event times event times inds inds event nums event nums clipping clipping fig proj none first time first time added label list butterfly false group by group by orig inds inds copy decim decim data picks data picks dcnl dcsp if group by in selection position dcnl dcsp dcsp params fig selection fig selection dcnl dcsp dcsp params selections selections dcnl dcsp dcsp params radio clicked partial radio clicked params params dcnl dcsp dcsp fig selection radio on clicked params radio clicked dcnl dcsp dcsp lasso callback partial set custom selection params params dcnl dcsp dcsp fig selection canvas mpl connect lasso event lasso callback dcnl dcsp prepare mne browse raw params title bgcolor color bad color inds n channels dcnl dcsp event lines params ax plot np nan color event colorev num 0 for ev num in sorted event color keys dcnl dcsp params plot fun partial plot raw traces params params color color bad color bad color event lines event lines event color event color dcnl dcsp plot annotations raw params dcnl dcsp params update fun partial update raw data params params dcnl dcsp params pick bads fun partial pick bad channels params params dcnl dcsp params label click fun partial label clicked params params dcnl dcsp params scale factor 1 0 dcnl dcsp opt button none dcnl dcsp if len raw info projs 0 and not raw proj dcnl dcsp dcsp ax button plt subplot2grid 10 10 9 9 dcnl dcsp dcsp params ax button ax button dcnl dcsp dcsp params apply proj proj dcnl dcsp dcsp opt button mpl widgets button ax button proj dcnl dcsp dcsp callback option partial toggle options params params dcnl dcsp dcsp opt button on clicked callback option dcnl dcsp callback key partial plot raw onkey params params dcnl dcsp params fig canvas mpl connect key press event callback key dcnl dcsp callback scroll partial plot raw onscroll params params dcnl dcsp params fig canvas mpl connect scroll event callback scroll dcnl dcsp callback pick partial mouse click params params dcnl dcsp params fig canvas mpl connect button press event callback pick dcnl dcsp callback resize partial helper raw resize params params dcnl dcsp params fig canvas mpl connect resize event callback resize dcnl dcsp params plot update proj callback plot update raw proj dcnl dcsp callback proj partial toggle proj params params dcnl dcsp params callback proj callback proj dcnl dcsp params callback key callback key dcnl dcsp params opt button opt button dcnl dcsp callback proj none dcnl dcsp layout figure params dcnl dcsp if show options dcnl dcsp dcsp toggle options none params dcnl dcsp callback close partial close event params params dcnl dcsp params fig canvas mpl connect close event callback close dcnl dcsp if group by in selection position dcnl dcsp dcsp radio clicked fig selection radio labels0 text params dcnl dcsp dcsp callback selection key partial selection key press params params dcnl dcsp dcsp callback selection scroll partial selection scroll params params dcnl dcsp dcsp params fig selection canvas mpl connect close event callback close dcnl dcsp dcsp params fig selection canvas mpl connect key press event callback selection key dcnl dcsp dcsp params fig selection canvas mpl connect scroll event callback selection scroll dcnl dcsp if butterfly dcnl dcsp dcsp setup butterfly params dcnl dcsp try dcnl dcsp dcsp plt show show block block dcnl dcsp except typeerror dcnl dcsp dcsp plt show show dcnl dcsp return params fig
def selection scroll event params dcsp if event step < 0 dcnl dcsp dcsp change channel group 1 params dcnl dcsp elif event step 0 dcnl dcsp dcsp change channel group 1 params
def selection key press event params dcsp if event key down dcnl dcsp dcsp change channel group 1 params dcnl dcsp elif event key up dcnl dcsp dcsp change channel group 1 params dcnl dcsp elif event key escape dcnl dcsp dcsp close event event params
def close event event params dcsp import matplotlib pyplot as plt dcnl dcsp if fig selection in params dcnl dcsp dcsp plt close params fig selection dcnl dcsp for fig in fig annotation fig help fig proj dcnl dcsp dcsp if paramsfig is not none dcnl dcsp dcsp dcsp plt close paramsfig dcnl dcsp plt close params fig
def label clicked pos params dcsp if params butterfly dcnl dcsp dcsp return dcnl dcsp labels params ax yaxis get ticklabels dcnl dcsp offsets np array params offsets + params offsets 0 dcnl dcsp line idx np searchsorted offsets pos1 dcnl dcsp text labelsline idx get text dcnl dcsp if len text 0 dcnl dcsp dcsp return dcnl dcsp if fig selection in params dcnl dcsp dcsp ch idx find channel idx text params dcnl dcsp dcsp handle topomap bads text params dcnl dcsp else dcnl dcsp dcsp ch idx params ch start + line idx dcnl dcsp bads params info bads dcnl dcsp if text in bads dcnl dcsp dcsp while text in bads dcnl dcsp dcsp dcsp bads remove text dcnl dcsp dcsp color vars params lines line idx def color dcnl dcsp dcsp for idx in ch idx dcnl dcsp dcsp dcsp params ax vscroll patchesidx set color color dcnl dcsp else dcnl dcsp dcsp bads append text dcnl dcsp dcsp color params bad color dcnl dcsp dcsp for idx in ch idx dcnl dcsp dcsp dcsp params ax vscroll patchesidx set color color dcnl dcsp params raw info bads bads dcnl dcsp plot update raw proj params none
def set psd plot params info proj picks ax area mode dcsp import matplotlib pyplot as plt dcnl dcsp if area mode not in none std range dcnl dcsp dcsp raise valueerror area mode dcsp must dcsp be dcsp std dcsp range dcsp or dcsp none dcnl dcsp if picks is none dcnl dcsp dcsp megs mag grad false false false dcnl dcsp dcsp eegs false false true false false dcnl dcsp dcsp seegs false false false true false dcnl dcsp dcsp ecogs false false false false true dcnl dcsp dcsp names mag grad eeg seeg ecog dcnl dcsp dcsp titles handle default titles none dcnl dcsp dcsp units handle default units none dcnl dcsp dcsp scalings handle default scalings none dcnl dcsp dcsp picks list list dcnl dcsp dcsp titles list list dcnl dcsp dcsp units list list dcnl dcsp dcsp scalings list list dcnl dcsp dcsp for meg eeg seeg ecog name in zip megs eegs seegs ecogs names dcnl dcsp dcsp dcsp picks pick types info meg meg eeg eeg seeg seeg ecog ecog ref meg false dcnl dcsp dcsp dcsp if len picks 0 dcnl dcsp dcsp dcsp dcsp picks list append picks dcnl dcsp dcsp dcsp dcsp titles list append titlesname dcnl dcsp dcsp dcsp dcsp units list append unitsname dcnl dcsp dcsp dcsp dcsp scalings list append scalingsname dcnl dcsp dcsp if len picks list 0 dcnl dcsp dcsp dcsp raise runtimeerror no dcsp data dcsp channels dcsp found dcnl dcsp dcsp if ax is not none dcnl dcsp dcsp dcsp if isinstance ax plt axes dcnl dcsp dcsp dcsp dcsp ax ax dcnl dcsp dcsp dcsp if len ax len picks list dcnl dcsp dcsp dcsp dcsp raise valueerror for dcsp this dcsp dataset dcsp with dcsp picks none dcsp s dcsp axes dcsp must dcsp be dcsp supplied dcsp got dcsp s len picks list len ax dcnl dcsp dcsp dcsp ax list ax dcnl dcsp else dcnl dcsp dcsp picks list picks dcnl dcsp dcsp titles list selected dcsp channels dcnl dcsp dcsp units list amplitude dcnl dcsp dcsp scalings list 1 0 dcnl dcsp dcsp ax list ax dcnl dcsp make label false dcnl dcsp fig none dcnl dcsp if ax is none dcnl dcsp dcsp fig plt figure dcnl dcsp dcsp ax list list dcnl dcsp dcsp for ii in range len picks list dcnl dcsp dcsp dcsp if ii 0 dcnl dcsp dcsp dcsp dcsp ax list append plt subplot len picks list 1 ii + 1 sharex ax list0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ax list append plt subplot len picks list 1 ii + 1 dcnl dcsp dcsp make label true dcnl dcsp else dcnl dcsp dcsp fig ax list0 get figure dcnl dcsp return fig picks list titles list units list scalings list ax list make label
def convert psds psds db scaling unit ch names dcsp if db dcnl dcsp dcsp where np where psds min 1 < 0 0 dcnl dcsp dcsp if len where 0 dcnl dcsp dcsp dcsp raise valueerror infinite dcsp value dcsp in dcsp psd dcsp for dcsp channel s dcsp s dcsp these dcsp channels dcsp might dcsp be dcsp dead dcsp join ch namesii for ii in where dcnl dcsp dcsp psds scaling scaling dcnl dcsp dcsp np log10 psds out psds dcnl dcsp dcsp psds 10 dcnl dcsp dcsp ylabel s hz dcsp db unit dcnl dcsp else dcnl dcsp dcsp np sqrt psds out psds dcnl dcsp dcsp psds scaling dcnl dcsp dcsp ylabel frac s sqrt hz unit dcnl dcsp return ylabel
verbose dcnl def plot raw psd raw tmin 0 0 tmax np inf fmin 0 fmax np inf proj false n fft none picks none ax none color black area mode std area alpha 0 33 n overlap 0 db true average none show true n jobs 1 line alpha none spatial colors none xscale linear reject by annotation true verbose none dcsp from matplotlib ticker import scalarformatter dcnl dcsp if average is none dcnl dcsp dcsp warn in dcsp version dcsp 0 15 dcsp average dcsp will dcsp default dcsp to dcsp false dcsp and dcsp spatial colors dcsp will dcsp default dcsp to dcsp true deprecationwarning dcnl dcsp dcsp average true dcnl dcsp if average and spatial colors dcnl dcsp dcsp raise valueerror average dcsp and dcsp spatial colors dcsp cannot dcsp be dcsp enabled dcsp simultaneously dcnl dcsp if spatial colors is none dcnl dcsp dcsp spatial colors false if average else true dcnl dcsp fig picks list titles list units list scalings list ax list make label set psd plot params raw info proj picks ax area mode dcnl dcsp del ax dcnl dcsp if line alpha is none dcnl dcsp dcsp line alpha 1 0 if average else 0 1 dcnl dcsp line alpha float line alpha dcnl dcsp psd list list dcnl dcsp if n fft is none dcnl dcsp dcsp tmax raw times 1 if not np isfinite tmax else tmax dcnl dcsp dcsp n fft min np diff raw time as index tmin tmax 0 + 1 2048 dcnl dcsp for ii picks in enumerate picks list dcnl dcsp dcsp ax ax listii dcnl dcsp dcsp psds freqs psd welch raw tmin tmin tmax tmax picks picks fmin fmin fmax fmax proj proj n fft n fft n overlap n overlap n jobs n jobs reject by annotation reject by annotation dcnl dcsp dcsp ylabel convert psds psds db scalings listii units listii raw ch namespi for pi in picks dcnl dcsp dcsp if average dcnl dcsp dcsp dcsp psd mean np mean psds axis 0 dcnl dcsp dcsp dcsp if area mode std dcnl dcsp dcsp dcsp dcsp psd std np std psds axis 0 dcnl dcsp dcsp dcsp dcsp hyp limits psd mean psd std psd mean + psd std dcnl dcsp dcsp dcsp elif area mode range dcnl dcsp dcsp dcsp dcsp hyp limits np min psds axis 0 np max psds axis 0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp hyp limits none dcnl dcsp dcsp dcsp ax plot freqs psd mean color color alpha line alpha linewidth 0 5 dcnl dcsp dcsp dcsp if hyp limits is not none dcnl dcsp dcsp dcsp dcsp ax fill between freqs hyp limits0 y2 hyp limits1 color color alpha area alpha dcnl dcsp dcsp else dcnl dcsp dcsp dcsp psd list append psds dcnl dcsp dcsp if make label dcnl dcsp dcsp dcsp if ii len picks list 1 dcnl dcsp dcsp dcsp dcsp ax set xlabel freq dcsp hz dcnl dcsp dcsp dcsp ax set ylabel ylabel dcnl dcsp dcsp dcsp ax set title titles listii dcnl dcsp dcsp dcsp ax set xlim freqs0 freqs 1 dcnl dcsp for key ls in zip lowpass highpass line freq dcnl dcsp dcsp if raw infokey is not none dcnl dcsp dcsp dcsp for ax in ax list dcnl dcsp dcsp dcsp dcsp ax axvline raw infokey color k linestyle ls alpha 0 25 linewidth 2 zorder 2 dcnl dcsp if not average dcnl dcsp dcsp picks np concatenate picks list dcnl dcsp dcsp psd list np concatenate psd list dcnl dcsp dcsp types np array channel type raw info idx for idx in picks dcnl dcsp dcsp info create info raw ch namesp for p in picks raw info sfreq types dcnl dcsp dcsp info chs raw info chs p for p in picks dcnl dcsp dcsp valid channel types mag grad eeg seeg eog ecg emg dipole gof bio ecog hbo hbr misc dcnl dcsp dcsp ch types used list dcnl dcsp dcsp for this type in valid channel types dcnl dcsp dcsp dcsp if this type in types dcnl dcsp dcsp dcsp dcsp ch types used append this type dcnl dcsp dcsp unit db hz if db else 1 sqrt hz dcnl dcsp dcsp units t psd dcsp s unit for t in ch types used dcnl dcsp dcsp titles c t for c t in zip ch types used titles list dcnl dcsp dcsp picks np arange len psd list dcnl dcsp dcsp if not spatial colors dcnl dcsp dcsp dcsp spatial colors color dcnl dcsp dcsp plot lines psd list info picks fig ax list spatial colors unit units units scalings none hline none gfp false types types zorder std xlim freqs0 freqs 1 ylim none times freqs bad ch idx titles titles ch types used ch types used selectable true psd true line alpha line alpha dcnl dcsp for ax in ax list dcnl dcsp dcsp ax grid true linestyle dcnl dcsp dcsp if xscale log dcnl dcsp dcsp dcsp ax set xscale log dcnl dcsp dcsp dcsp ax set xlim freqs1 if freqs0 0 else freqs0 freqs 1 dcnl dcsp dcsp dcsp ax get xaxis set major formatter scalarformatter dcnl dcsp if make label dcnl dcsp dcsp tight layout pad 0 1 h pad 0 1 w pad 0 1 fig fig dcnl dcsp plt show show dcnl dcsp return fig
def prepare mne browse raw params title bgcolor color bad color inds n channels dcsp import matplotlib pyplot as plt dcnl dcsp import matplotlib as mpl dcnl dcsp size get config mne browse raw size dcnl dcsp if size is not none dcnl dcsp dcsp size size split dcnl dcsp dcsp size tuple float s for s in size dcnl dcsp dcsp size tuple float s for s in size dcnl dcsp fig figure nobar facecolor bgcolor figsize size dcnl dcsp fig canvas set window title mne browse raw dcnl dcsp ax plt subplot2grid 10 10 0 1 colspan 8 rowspan 9 dcnl dcsp ax set title title fontsize 12 dcnl dcsp ax hscroll plt subplot2grid 10 10 9 1 colspan 8 dcnl dcsp ax hscroll get yaxis set visible false dcnl dcsp ax hscroll set xlabel time dcsp s dcnl dcsp ax vscroll plt subplot2grid 10 10 0 9 rowspan 9 dcnl dcsp ax vscroll set axis off dcnl dcsp ax help button plt subplot2grid 10 10 0 0 colspan 1 dcnl dcsp help button mpl widgets button ax help button help dcnl dcsp help button on clicked partial onclick help params params dcnl dcsp params fig fig dcnl dcsp params ax ax dcnl dcsp params ax hscroll ax hscroll dcnl dcsp params ax vscroll ax vscroll dcnl dcsp params ax help button ax help button dcnl dcsp params help button help button dcnl dcsp info params info dcnl dcsp n ch len inds dcnl dcsp if fig selection in params dcnl dcsp dcsp selections params selections dcnl dcsp dcsp labels l text for l in params fig selection radio labels dcnl dcsp dcsp cis item for sublist in selectionsl for l in labels for item in sublist dcnl dcsp dcsp for idx ci in enumerate cis dcnl dcsp dcsp dcsp this color bad color if info ch names ci in info bads else color dcnl dcsp dcsp dcsp if isinstance this color dict dcnl dcsp dcsp dcsp dcsp this color this colorparams types ci dcnl dcsp dcsp dcsp ax vscroll add patch mpl patches rectangle 0 idx 1 1 facecolor this color edgecolor this color dcnl dcsp dcsp ax vscroll set ylim len cis 0 dcnl dcsp dcsp n channels max len selectionslabels0 n channels dcnl dcsp else dcnl dcsp dcsp for ci in range len inds dcnl dcsp dcsp dcsp this color bad color if info ch names indsci in info bads else color dcnl dcsp dcsp dcsp if isinstance this color dict dcnl dcsp dcsp dcsp dcsp this color this colorparams types indsci dcnl dcsp dcsp dcsp ax vscroll add patch mpl patches rectangle 0 ci 1 1 facecolor this color edgecolor this color dcnl dcsp dcsp ax vscroll set ylim n ch 0 dcnl dcsp vsel patch mpl patches rectangle 0 0 1 n channels alpha 0 5 facecolor w edgecolor w dcnl dcsp ax vscroll add patch vsel patch dcnl dcsp params vsel patch vsel patch dcnl dcsp hsel patch mpl patches rectangle params t start 0 params duration 1 edgecolor k facecolor 0 75 0 75 0 75 alpha 0 25 linewidth 1 clip on false dcnl dcsp ax hscroll add patch hsel patch dcnl dcsp params hsel patch hsel patch dcnl dcsp ax hscroll set xlim params first time params first time + params n times float info sfreq dcnl dcsp ax vscroll set title ch dcnl dcsp vertline color 0 0 0 75 0 0 dcnl dcsp params ax vertline ax plot 0 0 ax get ylim color vertline color zorder 4 0 dcnl dcsp params ax vertline ch name dcnl dcsp params vertline t ax hscroll text params first time 1 color vertline color va bottom ha right dcnl dcsp params ax hscroll vertline ax hscroll plot 0 0 0 1 color vertline color zorder 2 0 dcnl dcsp setup browser offsets params n channels dcnl dcsp ax set xlim params t start params t start + params duration false dcnl dcsp params lines ax plot np nan antialiased true linewidth 0 5 0 for in range n ch dcnl dcsp ax set yticklabels x max len ch for ch in info ch names dcnl dcsp params fig annotation none dcnl dcsp params fig help none dcnl dcsp params segment line none dcnl dcsp params close key escape
def plot raw traces params color bad color event lines none event color none dcsp lines params lines dcnl dcsp info params info dcnl dcsp inds params inds dcnl dcsp butterfly params butterfly dcnl dcsp if butterfly dcnl dcsp dcsp n channels len params offsets dcnl dcsp dcsp ch start 0 dcnl dcsp dcsp offsets params offsets inds dcnl dcsp else dcnl dcsp dcsp n channels params n channels dcnl dcsp dcsp ch start params ch start dcnl dcsp dcsp offsets params offsets dcnl dcsp params bad color bad color dcnl dcsp labels params ax yaxis get ticklabels dcnl dcsp tick list list dcnl dcsp for ii in range n channels dcnl dcsp dcsp ch ind ii + ch start dcnl dcsp dcsp if ii len lines dcnl dcsp dcsp dcsp break dcnl dcsp dcsp elif ch ind < len inds dcnl dcsp dcsp dcsp ch name info ch names indsch ind dcnl dcsp dcsp dcsp tick list + ch name dcnl dcsp dcsp dcsp offset offsetsii dcnl dcsp dcsp dcsp this data params data indsch ind params scale factor dcnl dcsp dcsp dcsp this color bad color if ch name in info bads else color dcnl dcsp dcsp dcsp if isinstance this color dict dcnl dcsp dcsp dcsp dcsp this color this colorparams types indsch ind dcnl dcsp dcsp dcsp if indsch ind in params data picks dcnl dcsp dcsp dcsp dcsp this decim params decim dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this decim 1 dcnl dcsp dcsp dcsp this t params times this decim + params first time dcnl dcsp dcsp dcsp linesii set ydata offset this data this decim dcnl dcsp dcsp dcsp linesii set xdata this t dcnl dcsp dcsp dcsp linesii set color this color dcnl dcsp dcsp dcsp vars linesii ch name ch name dcnl dcsp dcsp dcsp vars linesii def color colorparams types indsch ind dcnl dcsp dcsp dcsp this z 0 if ch name in info bads else 1 dcnl dcsp dcsp dcsp if butterfly dcnl dcsp dcsp dcsp dcsp if ch name not in info bads dcnl dcsp dcsp dcsp dcsp dcsp if params types ii mag dcnl dcsp dcsp dcsp dcsp dcsp dcsp this z 2 dcnl dcsp dcsp dcsp dcsp dcsp elif params types ii grad dcnl dcsp dcsp dcsp dcsp dcsp dcsp this z 3 dcnl dcsp dcsp dcsp dcsp for label in labels dcnl dcsp dcsp dcsp dcsp dcsp label set color black dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp this color bad color if ch name in info bads else black dcnl dcsp dcsp dcsp dcsp labelsii set color this color dcnl dcsp dcsp dcsp linesii set zorder this z dcnl dcsp dcsp else dcnl dcsp dcsp dcsp linesii set xdata dcnl dcsp dcsp dcsp linesii set ydata dcnl dcsp if params event times is not none dcnl dcsp dcsp event times params event times dcnl dcsp dcsp mask np logical and event times params times 0 event times < params times 1 dcnl dcsp dcsp event times event timesmask dcnl dcsp dcsp event nums params event nums mask dcnl dcsp dcsp used np zeros len event times bool dcnl dcsp dcsp ylim params ax get ylim dcnl dcsp dcsp for ev num line in zip sorted event color keys 1 event lines 1 dcnl dcsp dcsp dcsp mask event nums ev num if ev num 0 else ~ used dcnl dcsp dcsp dcsp assert not np any usedmask dcnl dcsp dcsp dcsp usedmask true dcnl dcsp dcsp dcsp t event timesmask + params first time dcnl dcsp dcsp dcsp if len t 0 dcnl dcsp dcsp dcsp dcsp xs list dcnl dcsp dcsp dcsp dcsp ys list dcnl dcsp dcsp dcsp dcsp for tt in t dcnl dcsp dcsp dcsp dcsp dcsp xs + tt tt np nan dcnl dcsp dcsp dcsp dcsp dcsp ys + 0 ylim0 np nan dcnl dcsp dcsp dcsp dcsp line set xdata xs dcnl dcsp dcsp dcsp dcsp line set ydata ys dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp line set xdata dcnl dcsp dcsp dcsp dcsp line set ydata dcnl dcsp if segments in params dcnl dcsp dcsp while len params ax collections 0 dcnl dcsp dcsp dcsp params ax collections pop 0 dcnl dcsp dcsp dcsp params ax texts pop 0 dcnl dcsp dcsp segments params segments dcnl dcsp dcsp times params times dcnl dcsp dcsp ylim params ax get ylim dcnl dcsp dcsp for idx segment in enumerate segments dcnl dcsp dcsp dcsp if segment0 times 1 + params first time dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp if segment1 < times0 + params first time dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp start max segment0 times0 + params first time dcnl dcsp dcsp dcsp end min times 1 + params first time segment1 dcnl dcsp dcsp dcsp dscr params annot description idx dcnl dcsp dcsp dcsp segment color params segment colors dscr dcnl dcsp dcsp dcsp params ax fill betweenx ylim start end color segment color alpha 0 3 dcnl dcsp dcsp dcsp params ax text start + end 2 0 ylim0 dscr ha center dcnl dcsp params ax set xlim params times 0 + params first time params times 0 + params first time + params duration false dcnl dcsp if not butterfly dcnl dcsp dcsp params ax set yticklabels tick list rotation 0 dcnl dcsp if fig selection not in params dcnl dcsp dcsp params vsel patch set y params ch start dcnl dcsp params fig canvas draw dcnl dcsp if params fig proj is not none dcnl dcsp dcsp params fig proj canvas draw
def plot raw psd topo raw tmin 0 0 tmax none fmin 0 0 fmax 100 0 proj false n fft 2048 n overlap 0 layout none color w fig facecolor k axis facecolor k db true show true block false n jobs 1 axes none verbose none dcsp if layout is none dcnl dcsp dcsp from channels layout import find layout dcnl dcsp dcsp layout find layout raw info dcnl dcsp psds freqs psd welch raw tmin tmin tmax tmax fmin fmin fmax fmax proj proj n fft n fft n overlap n overlap n jobs n jobs dcnl dcsp if db dcnl dcsp dcsp psds 10 np log10 psds dcnl dcsp dcsp y label db dcnl dcsp else dcnl dcsp dcsp y label power dcnl dcsp show func partial plot timeseries unified data psds color color times freqs dcnl dcsp click func partial plot timeseries data psds color color times freqs dcnl dcsp picks pick data channels raw info dcnl dcsp info pick info raw info picks dcnl dcsp fig plot topo info times freqs show func show func click func click func layout layout axis facecolor axis facecolor fig facecolor fig facecolor x label frequency dcsp hz unified true y label y label axes axes dcnl dcsp try dcnl dcsp dcsp plt show show block block dcnl dcsp except typeerror dcnl dcsp dcsp plt show show dcnl dcsp return fig
def set custom selection params dcsp chs params fig selection lasso selection dcnl dcsp if len chs 0 dcnl dcsp dcsp return dcnl dcsp labels l text for l in params fig selection radio labels dcnl dcsp inds np in1d params raw ch names chs dcnl dcsp params selections custom np where inds 0 dcnl dcsp set radio button labels index custom params params
def setup browser selection raw kind selector true dcsp import matplotlib pyplot as plt dcnl dcsp from matplotlib widgets import radiobuttons dcnl dcsp from selection import read selection selections eeg selections divide to regions dcnl dcsp from utils import get stim channel dcnl dcsp if kind position dcnl dcsp dcsp order divide to regions raw info dcnl dcsp dcsp keys selections1 dcnl dcsp dcsp kind position dcnl dcsp elif selection dcnl dcsp dcsp from io import rawfif rawarray dcnl dcsp dcsp if not isinstance raw rawfif rawarray dcnl dcsp dcsp dcsp raise valueerror order selection dcsp only dcsp works dcsp for dcsp neuromag dcsp data dcsp use dcsp order position dcsp instead dcnl dcsp dcsp order dict dcnl dcsp dcsp try dcnl dcsp dcsp dcsp stim ch get stim channel none raw info dcnl dcsp dcsp except valueerror dcnl dcsp dcsp dcsp stim ch dcnl dcsp dcsp keys np concatenate selections eeg selections dcnl dcsp dcsp stim ch pick channels raw ch names stim ch dcnl dcsp dcsp for key in keys dcnl dcsp dcsp dcsp channels read selection key info raw info dcnl dcsp dcsp dcsp picks pick channels raw ch names channels dcnl dcsp dcsp dcsp if len picks 0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp orderkey np concatenate picks stim ch dcnl dcsp misc pick types raw info meg false eeg false stim true eog true ecg true emg true ref meg false misc true resp true chpi true exci true ias true syst true seeg false bio true ecog false fnirs false exclude dcnl dcsp if len misc 0 dcnl dcsp dcsp order misc misc dcnl dcsp keys np concatenate keys misc dcnl dcsp if not selector dcnl dcsp dcsp return order dcnl dcsp fig selection figure nobar figsize 2 6 dpi 80 dcnl dcsp fig selection canvas set window title selection dcnl dcsp rax plt subplot2grid 6 1 2 0 rowspan 4 colspan 1 dcnl dcsp topo ax plt subplot2grid 6 1 0 0 rowspan 2 colspan 1 dcnl dcsp keys np concatenate keys custom dcnl dcsp order update custom list dcnl dcsp plot sensors raw info kind select ch type all axes topo ax ch groups kind title show false dcnl dcsp fig selection radio radiobuttons rax key for key in keys if key in order keys dcnl dcsp for circle in fig selection radio circles dcnl dcsp dcsp circle set radius 0 02 dcnl dcsp dcsp circle set edgecolor gray dcnl dcsp return order fig selection
def butterfly onpick event params dcsp params need draw true dcnl dcsp ax event artist axes dcnl dcsp ax idx np where ax is a for a in params axes 0 dcnl dcsp if len ax idx 0 dcnl dcsp dcsp return dcnl dcsp else dcnl dcsp dcsp ax idx ax idx0 dcnl dcsp lidx np where l is event artist for l in params lines ax idx 00 dcnl dcsp ch name params ch names params idxs ax idxlidx dcnl dcsp text params texts ax idx dcnl dcsp x event artist get xdata event ind0 dcnl dcsp y event artist get ydata event ind0 dcnl dcsp text set x x dcnl dcsp text set y y dcnl dcsp text set text ch name dcnl dcsp text set color event artist get color dcnl dcsp text set alpha 1 0 dcnl dcsp text set zorder len ax lines dcnl dcsp text set path effects params path effects
def butterfly on button press event params dcsp if params need draw dcnl dcsp dcsp event canvas draw dcnl dcsp else dcnl dcsp dcsp idx np where event inaxes is ax for ax in params axes 0 dcnl dcsp dcsp if len idx 1 dcnl dcsp dcsp dcsp text params texts idx0 dcnl dcsp dcsp dcsp text set alpha 0 0 dcnl dcsp dcsp dcsp text set path effects dcnl dcsp dcsp dcsp event canvas draw dcnl dcsp params need draw false
def line plot onselect xmin xmax ch types info data times text none psd false dcsp import matplotlib pyplot as plt dcnl dcsp ch types type for type in ch types if type in eeg grad mag dcnl dcsp if len ch types 0 dcnl dcsp dcsp raise valueerror interactive dcsp topomaps dcsp only dcsp allowed dcsp for dcsp eeg dcsp and dcsp meg dcsp channels dcnl dcsp if grad in ch types and len pair grad sensors info topomap coords false raise error false < 2 dcnl dcsp dcsp ch types remove grad dcnl dcsp dcsp if len ch types 0 dcnl dcsp dcsp dcsp return dcnl dcsp vert lines list dcnl dcsp if text is not none dcnl dcsp dcsp text set visible true dcnl dcsp dcsp ax text axes dcnl dcsp dcsp vert lines append ax axvline xmin zorder 0 color red dcnl dcsp dcsp vert lines append ax axvline xmax zorder 0 color red dcnl dcsp dcsp fill ax axvspan xmin xmax alpha 0 2 color green dcnl dcsp dcsp evoked fig plt gcf dcnl dcsp dcsp evoked fig canvas draw dcnl dcsp dcsp evoked fig canvas flush events dcnl dcsp minidx np abs times xmin argmin dcnl dcsp maxidx np abs times xmax argmin dcnl dcsp fig axarr plt subplots 1 len ch types squeeze false figsize 3 len ch types 3 dcnl dcsp for idx ch type in enumerate ch types dcnl dcsp dcsp if ch type not in eeg grad mag dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp picks pos merge grads ch type prepare topo plot info ch type layout none dcnl dcsp dcsp if len pos < 2 dcnl dcsp dcsp dcsp fig delaxes axarr0idx dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp this data datapicks minidx maxidx dcnl dcsp dcsp if merge grads dcnl dcsp dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp dcsp method mean if psd else rms dcnl dcsp dcsp dcsp this data merge grad data this data method method dcnl dcsp dcsp dcsp title s dcsp s ch type method upper dcnl dcsp dcsp else dcnl dcsp dcsp dcsp title ch type dcnl dcsp dcsp this data np average this data axis 1 dcnl dcsp dcsp axarr0idx set title title dcnl dcsp dcsp vmin min this data if psd else none dcnl dcsp dcsp vmax max this data if psd else none dcnl dcsp dcsp cmap reds if psd else none dcnl dcsp dcsp plot topomap this data pos cmap cmap vmin vmin vmax vmax axes axarr0idx show false dcnl dcsp unit hz if psd else ms dcnl dcsp fig suptitle average dcsp over dcsp 2f s dcsp dcsp 2f s xmin unit xmax unit y 0 1 dcnl dcsp tight layout pad 2 0 fig fig dcnl dcsp plt show dcnl dcsp if text is not none dcnl dcsp dcsp text set visible false dcnl dcsp dcsp close callback partial topo closed ax ax lines vert lines fill fill dcnl dcsp dcsp fig canvas mpl connect close event close callback dcnl dcsp dcsp evoked fig canvas draw dcnl dcsp dcsp evoked fig canvas flush events
def topo closed events ax lines fill dcsp for line in lines dcnl dcsp dcsp ax lines remove line dcnl dcsp ax patches remove fill dcnl dcsp ax get figure canvas draw
def rgb x y z dcsp rgb np array x y z t dcnl dcsp rgb rgb min 0 dcnl dcsp rgb rgb max 0 dcnl dcsp return rgb
def plot legend pos colors axis bads outlines loc dcsp from mpl toolkits axes grid1 inset locator import inset axes dcnl dcsp bbox axis get window extent dcnl dcsp ratio bbox width bbox height dcnl dcsp ax inset axes axis width str 30 ratio + height 30 loc loc dcnl dcsp pos x pos y prepare topomap pos ax dcnl dcsp ax scatter pos x pos y color colors s 25 marker zorder 1 dcnl dcsp for idx in bads dcnl dcsp dcsp ax scatter pos xidx pos yidx s 5 marker color w zorder 1 dcnl dcsp draw outlines ax outlines
def plot evoked evoked picks exclude unit show ylim proj xlim hline units scalings titles axes plot type cmap none gfp false window title none spatial colors false set tight layout true selectable true zorder unsorted dcsp import matplotlib pyplot as plt dcnl dcsp info evoked info dcnl dcsp if axes is not none and proj interactive dcnl dcsp dcsp raise runtimeerror currently dcsp only dcsp single dcsp axis dcsp figures dcsp are dcsp supported dcsp for dcsp interactive dcsp ssp dcsp selection dcnl dcsp if isinstance gfp string types and gfp only dcnl dcsp dcsp raise valueerror gfp dcsp must dcsp be dcsp boolean dcsp or dcsp only dcsp got dcsp s gfp dcnl dcsp scalings handle default scalings scalings dcnl dcsp titles handle default titles titles dcnl dcsp units handle default units units dcnl dcsp if picks is none dcnl dcsp dcsp picks list range info nchan dcnl dcsp bad ch idx info ch names index ch for ch in info bads if ch in info ch names dcnl dcsp if len exclude 0 dcnl dcsp dcsp if isinstance exclude string types and exclude bads dcnl dcsp dcsp dcsp exclude bad ch idx dcnl dcsp dcsp elif isinstance exclude list and all isinstance ch string types for ch in exclude dcnl dcsp dcsp dcsp exclude info ch names index ch for ch in exclude dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror exclude dcsp has dcsp to dcsp be dcsp a dcsp list dcsp of dcsp channel dcsp names dcsp or dcsp bads dcnl dcsp dcsp picks list set picks difference exclude dcnl dcsp picks np array picks dcnl dcsp types np array channel type info idx for idx in picks dcnl dcsp ch types used list dcnl dcsp for this type in valid channel types dcnl dcsp dcsp if this type in types dcnl dcsp dcsp dcsp ch types used append this type dcnl dcsp fig none dcnl dcsp if axes is none dcnl dcsp dcsp fig axes plt subplots len ch types used 1 dcnl dcsp dcsp plt subplots adjust 0 175 0 08 0 94 0 94 0 2 0 63 dcnl dcsp dcsp if isinstance axes plt axes dcnl dcsp dcsp dcsp axes axes dcnl dcsp dcsp fig set size inches 6 4 2 + len axes dcnl dcsp if isinstance axes plt axes dcnl dcsp dcsp axes axes dcnl dcsp elif isinstance axes np ndarray dcnl dcsp dcsp axes list axes dcnl dcsp if fig is none dcnl dcsp dcsp fig axes0 get figure dcnl dcsp if window title is not none dcnl dcsp dcsp fig canvas set window title window title dcnl dcsp if len axes len ch types used dcnl dcsp dcsp raise valueerror number dcsp of dcsp axes dcsp g dcsp must dcsp match dcsp number dcsp of dcsp channel dcsp types dcsp d dcsp s len axes len ch types used sorted ch types used dcnl dcsp if proj is true and evoked proj is not true dcnl dcsp dcsp evoked evoked copy dcnl dcsp dcsp evoked apply proj dcnl dcsp if plot type butterfly dcnl dcsp dcsp times evoked times 1000 0 dcnl dcsp dcsp plot lines evoked data info picks fig axes spatial colors unit units scalings hline gfp types zorder xlim ylim times bad ch idx titles ch types used selectable false line alpha 1 0 dcnl dcsp dcsp for ax in axes dcnl dcsp dcsp dcsp ax set xlabel time dcsp ms dcnl dcsp elif plot type image dcnl dcsp dcsp for ax this type in zip axes ch types used dcnl dcsp dcsp dcsp this picks list picks types this type dcnl dcsp dcsp dcsp plot image evoked data ax this type this picks cmap unit units scalings evoked times xlim ylim titles dcnl dcsp if proj interactive dcnl dcsp dcsp check delayed ssp evoked dcnl dcsp dcsp params dict evoked evoked fig fig projs info projs axes axes types types units units scalings scalings unit unit ch types used ch types used picks picks plot update proj callback plot update evoked plot type plot type dcnl dcsp dcsp draw proj checkbox none params dcnl dcsp for ax in fig axes len ch types used 1 dcnl dcsp dcsp ax set xlabel dcnl dcsp fig canvas draw dcnl dcsp if set tight layout dcnl dcsp dcsp tight layout fig fig dcnl dcsp plt show show dcnl dcsp return fig
def plot lines data info picks fig axes spatial colors unit units scalings hline gfp types zorder xlim ylim times bad ch idx titles ch types used selectable psd line alpha dcsp from matplotlib import patheffects dcnl dcsp from matplotlib widgets import spanselector dcnl dcsp texts list dcnl dcsp idxs list dcnl dcsp lines list dcnl dcsp path effects patheffects withstroke linewidth 2 foreground w alpha 0 75 dcnl dcsp gfp path effects patheffects withstroke linewidth 5 foreground w alpha 0 75 dcnl dcsp if selectable dcnl dcsp dcsp selectables np ones len ch types used dtype bool dcnl dcsp dcsp for type idx this type in enumerate ch types used dcnl dcsp dcsp dcsp idx picks types this type dcnl dcsp dcsp dcsp if len idx < 2 or this type grad and len idx < 4 dcnl dcsp dcsp dcsp dcsp warn need dcsp more dcsp than dcsp one dcsp channel dcsp to dcsp make dcsp topography dcsp for dcsp s dcsp disabling dcsp interactivity this type dcnl dcsp dcsp dcsp dcsp selectablestype idx false dcnl dcsp if selectable dcnl dcsp dcsp params dict axes axes texts texts lines lines ch names info ch names idxs idxs need draw false path effects path effects dcnl dcsp dcsp fig canvas mpl connect pick event partial butterfly onpick params params dcnl dcsp dcsp fig canvas mpl connect button press event partial butterfly on button press params params dcnl dcsp for ax this type in zip axes ch types used dcnl dcsp dcsp line list list dcnl dcsp dcsp ch unit unitsthis type dcnl dcsp dcsp this scaling 1 0 if scalings is none else scalingsthis type dcnl dcsp dcsp if unit is false dcnl dcsp dcsp dcsp this scaling 1 0 dcnl dcsp dcsp dcsp ch unit na dcnl dcsp dcsp idx list picks types this type dcnl dcsp dcsp idxs append idx dcnl dcsp dcsp if len idx 0 dcnl dcsp dcsp dcsp d this scaling dataidx dcnl dcsp dcsp dcsp gfp only isinstance gfp string types and gfp only dcnl dcsp dcsp dcsp if not gfp only dcnl dcsp dcsp dcsp dcsp chs info chs i for i in idx dcnl dcsp dcsp dcsp dcsp locs3d np array ch loc 3 for ch in chs dcnl dcsp dcsp dcsp dcsp if spatial colors is true and locs3d 0 all dcnl dcsp dcsp dcsp dcsp dcsp warn channel dcsp locations dcsp not dcsp available dcsp disabling dcsp spatial dcsp colors dcnl dcsp dcsp dcsp dcsp dcsp spatial colors selectable false dcnl dcsp dcsp dcsp dcsp if spatial colors is true and len idx 1 dcnl dcsp dcsp dcsp dcsp dcsp x y z locs3d t dcnl dcsp dcsp dcsp dcsp dcsp colors rgb x y z dcnl dcsp dcsp dcsp dcsp dcsp handle spatial colors colors info idx this type psd ax dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp if isinstance spatial colors tuple string types dcnl dcsp dcsp dcsp dcsp dcsp dcsp col spatial colors dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp col k dcnl dcsp dcsp dcsp dcsp dcsp colors col len idx dcnl dcsp dcsp dcsp dcsp dcsp for i in bad ch idx dcnl dcsp dcsp dcsp dcsp dcsp dcsp if i in idx dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp colorsidx index i r dcnl dcsp dcsp dcsp dcsp if zorder std dcnl dcsp dcsp dcsp dcsp dcsp z ord d std axis 1 argsort dcnl dcsp dcsp dcsp dcsp elif zorder unsorted dcnl dcsp dcsp dcsp dcsp dcsp z ord list range d shape0 dcnl dcsp dcsp dcsp dcsp elif not callable zorder dcnl dcsp dcsp dcsp dcsp dcsp error zorder dcsp must dcsp be dcsp a dcsp function dcsp std dcsp or dcsp unsorted dcsp not dcsp 0 dcnl dcsp dcsp dcsp dcsp dcsp raise typeerror error format type zorder dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp z ord zorder d dcnl dcsp dcsp dcsp dcsp for ch idx z in enumerate z ord dcnl dcsp dcsp dcsp dcsp dcsp line list append ax plot times dch idx picker 3 0 zorder z + 1 if spatial colors is true else 1 color colorsch idx alpha line alpha linewidth 0 5 0 dcnl dcsp dcsp dcsp if gfp dcnl dcsp dcsp dcsp dcsp gfp color 3 0 0 if spatial colors is true else 0 0 1 0 0 0 dcnl dcsp dcsp dcsp dcsp this gfp np sqrt d d mean axis 0 dcnl dcsp dcsp dcsp dcsp this ylim ax get ylim if ylim is none or this type not in ylim keys else ylimthis type dcnl dcsp dcsp dcsp dcsp if gfp only dcnl dcsp dcsp dcsp dcsp dcsp y offset 0 0 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp y offset this ylim0 dcnl dcsp dcsp dcsp dcsp this gfp + y offset dcnl dcsp dcsp dcsp dcsp ax fill between times y offset this gfp color none facecolor gfp color zorder 1 alpha 0 25 dcnl dcsp dcsp dcsp dcsp line list append ax plot times this gfp color gfp color zorder 3 alpha line alpha 0 dcnl dcsp dcsp dcsp dcsp ax text times0 + 0 01 times 1 times0 this gfp0 + 0 05 np diff ax get ylim 0 gfp zorder 4 color gfp color path effects gfp path effects dcnl dcsp dcsp dcsp for ii line in zip idx line list dcnl dcsp dcsp dcsp dcsp if ii in bad ch idx dcnl dcsp dcsp dcsp dcsp dcsp line set zorder 2 dcnl dcsp dcsp dcsp dcsp dcsp if spatial colors is true dcnl dcsp dcsp dcsp dcsp dcsp dcsp line set linestyle dcnl dcsp dcsp dcsp ax set ylabel ch unit dcnl dcsp dcsp dcsp texts append ax text 0 0 blank zorder 3 verticalalignment baseline horizontalalignment left fontweight bold alpha 0 dcnl dcsp dcsp dcsp if xlim is not none dcnl dcsp dcsp dcsp dcsp if xlim tight dcnl dcsp dcsp dcsp dcsp dcsp xlim times0 times 1 dcnl dcsp dcsp dcsp dcsp ax set xlim xlim dcnl dcsp dcsp dcsp if ylim is not none and this type in ylim dcnl dcsp dcsp dcsp dcsp ax set ylim ylimthis type dcnl dcsp dcsp dcsp ax set title titlesthis type + dcsp d dcsp channel s len d pl d dcnl dcsp dcsp dcsp if hline is not none dcnl dcsp dcsp dcsp dcsp for h in hline dcnl dcsp dcsp dcsp dcsp dcsp c grey if spatial colors is true else r dcnl dcsp dcsp dcsp dcsp dcsp ax axhline h linestyle linewidth 2 color c dcnl dcsp dcsp lines append line list dcnl dcsp if selectable dcnl dcsp dcsp import matplotlib pyplot as plt dcnl dcsp dcsp for ax in np array axes selectables dcnl dcsp dcsp dcsp if len ax lines 1 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp text ax annotate loading xy 0 01 0 1 xycoords axes dcsp fraction fontsize 20 color green zorder 3 dcnl dcsp dcsp dcsp text set visible false dcnl dcsp dcsp dcsp callback onselect partial line plot onselect ch types ch types used info info data data times times text text psd psd dcnl dcsp dcsp dcsp blit false if plt get backend macosx else true dcnl dcsp dcsp dcsp minspan 0 if len times < 2 else times1 times0 dcnl dcsp dcsp dcsp ax span selector spanselector ax callback onselect horizontal minspan minspan useblit blit rectprops dict alpha 0 5 facecolor red
def handle spatial colors colors info idx ch type psd ax dcsp used nm np array clean names info ch names idx dcnl dcsp bads np where used nm bad 00 for bad in info bads if bad in used nm dcnl dcsp pos auto topomap coords info idx ignore overlap true to sphere true dcnl dcsp pos outlines check outlines pos np array 1 1 center 0 0 scale 0 5 0 5 dcnl dcsp loc 1 if psd else 2 dcnl dcsp plot legend pos colors ax bads outlines loc
def plot image data ax this type picks cmap unit units scalings times xlim ylim titles dcsp import matplotlib pyplot as plt dcnl dcsp cmap setup cmap cmap dcnl dcsp ch unit unitsthis type dcnl dcsp this scaling scalingsthis type dcnl dcsp if unit is false dcnl dcsp dcsp this scaling 1 0 dcnl dcsp dcsp ch unit na dcnl dcsp data this scaling datapicks dcnl dcsp im ax imshow data interpolation nearest origin lower extent times0 times 1 0 data shape0 aspect auto cmap cmap0 dcnl dcsp if xlim is not none dcnl dcsp dcsp if xlim tight dcnl dcsp dcsp dcsp xlim times0 times 1 dcnl dcsp dcsp ax set xlim xlim dcnl dcsp dcsp if ylim is not none and this type in ylim dcnl dcsp dcsp dcsp im set clim ylimthis type dcnl dcsp cbar plt colorbar im ax ax dcnl dcsp cbar ax set title ch unit dcnl dcsp if cmap1 dcnl dcsp dcsp ax cb draggablecolorbar cbar im dcnl dcsp ax set ylabel channels dcsp index dcnl dcsp ax set title titlesthis type + dcsp d dcsp channel s len data pl data dcnl dcsp ax set xlabel time dcsp ms
def plot evoked evoked picks none exclude bads unit true show true ylim none xlim tight proj false hline none units none scalings none titles none axes none gfp false window title none spatial colors false zorder unsorted selectable true dcsp return plot evoked evoked evoked picks picks exclude exclude unit unit show show ylim ylim proj proj xlim xlim hline hline units units scalings scalings titles titles axes axes plot type butterfly gfp gfp window title window title spatial colors spatial colors zorder zorder selectable selectable
def plot evoked topo evoked layout none layout scale 0 945 color none border none ylim none scalings none title none proj false vline 0 0 fig facecolor none fig background none axis facecolor none font color w merge grads false legend true axes none background color none show true dcsp if not type evoked in tuple list dcnl dcsp dcsp evoked evoked dcnl dcsp dark background none dcnl dcsp if background color is not none dcnl dcsp dcsp dark background np mean colorconverter to rgb background color < 0 5 dcnl dcsp if dark background is not none dcnl dcsp dcsp if dark background dcnl dcsp dcsp dcsp fig facecolor background color dcnl dcsp dcsp dcsp axis facecolor background color dcnl dcsp dcsp dcsp font color w dcnl dcsp dcsp else dcnl dcsp dcsp dcsp fig facecolor background color dcnl dcsp dcsp dcsp axis facecolor background color dcnl dcsp dcsp dcsp font color k dcnl dcsp dcsp if color is none dcnl dcsp dcsp dcsp if dark background dcnl dcsp dcsp dcsp dcsp color w + colors dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp color e41a1c 377eb8 4daf4a 984ea3 ff7f00 1b9e77 d95f02 7570b3 e7298a 66a61e dcnl dcsp dcsp dcsp color color len evoked len color + 1 dcnl dcsp dcsp dcsp color color len evoked dcnl dcsp if fig facecolor is none dcnl dcsp dcsp fig facecolor k dcnl dcsp dcsp warn axis facecolor dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp v0 16 dcsp use dcsp background color dcsp parameter dcsp or dcsp change dcsp matplotlib dcsp defaults dcnl dcsp if axis facecolor is none dcnl dcsp dcsp axis facecolor k dcnl dcsp dcsp warn axis facecolor dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp v0 16 dcsp use dcsp background color dcsp parameter dcsp or dcsp change dcsp matplotlib dcsp defaults dcnl dcsp if font color is none dcnl dcsp dcsp font color w dcnl dcsp dcsp warn font color dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp v0 16 dcsp use dcsp background color dcsp parameter dcsp or dcsp change dcsp matplotlib dcsp defaults dcnl dcsp return plot evoked topo evoked evoked layout layout layout scale layout scale color color border border ylim ylim scalings scalings title title proj proj vline vline fig facecolor fig facecolor fig background fig background axis facecolor axis facecolor font color font color merge grads merge grads legend legend axes axes show show
def animate evoked topomap evoked ch type mag times none frame rate none butterfly false blit true show true dcsp return topomap animation evoked ch type ch type times times frame rate frame rate butterfly butterfly blit blit show show
def plot evoked image evoked picks none exclude bads unit true show true clim none xlim tight proj false units none scalings none titles none axes none cmap rdbu r dcsp return plot evoked evoked evoked picks picks exclude exclude unit unit show show ylim clim proj proj xlim xlim hline none units units scalings scalings titles titles axes axes plot type image cmap cmap
def plot update evoked params bools dcsp picks evoked paramsk for k in picks evoked dcnl dcsp times evoked times 1000 0 dcnl dcsp projs proj for ii proj in enumerate params projs if ii in np where bools 0 dcnl dcsp params proj bools bools dcnl dcsp new evoked evoked copy dcnl dcsp new evoked info projs dcnl dcsp new evoked add proj projs dcnl dcsp new evoked apply proj dcnl dcsp for ax t in zip params axes params ch types used dcnl dcsp dcsp this scaling params scalings t dcnl dcsp dcsp idx picksi for i in range len picks if params types i t dcnl dcsp dcsp d this scaling new evoked dataidx dcnl dcsp dcsp if params plot type butterfly dcnl dcsp dcsp dcsp for line di in zip ax lines d dcnl dcsp dcsp dcsp dcsp line set data times di dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax images0 set data d dcnl dcsp params fig canvas draw
def plot evoked white evoked noise cov show true dcsp return plot evoked white evoked evoked noise cov noise cov scalings none rank none show show
def plot evoked white evoked noise cov scalings none rank none show true dcsp from cov import whiten evoked read cov dcnl dcsp from cov import estimate rank meeg cov dcnl dcsp import matplotlib pyplot as plt dcnl dcsp if scalings is none dcnl dcsp dcsp scalings dict mag 1000000000000 0 grad 100000000000 0 eeg 100000 0 dcnl dcsp ch used ch for ch in eeg grad mag if ch in evoked dcnl dcsp has meg mag in ch used and grad in ch used dcnl dcsp if isinstance noise cov string types dcnl dcsp dcsp noise cov read cov noise cov dcnl dcsp if not isinstance noise cov list tuple dcnl dcsp dcsp noise cov noise cov dcnl dcsp has sss false dcnl dcsp if len evoked info proc history 0 dcnl dcsp dcsp has sss max info in evoked info proc history 0 and has meg dcnl dcsp if has sss dcnl dcsp dcsp logger info sss dcsp has dcsp been dcsp applied dcsp to dcsp data dcsp showing dcsp mag dcsp and dcsp grad dcsp whitening dcsp jointly dcnl dcsp evoked evoked copy dcnl dcsp passive idx idx for idx proj in enumerate evoked info projs if not proj active dcnl dcsp for idx in passive idx 1 dcnl dcsp dcsp evoked del proj idx dcnl dcsp picks pick types evoked info meg true eeg true ref meg false exclude bads dcnl dcsp evoked pick channels evoked ch namesk for k in picks dcnl dcsp picks pick types evoked info meg true eeg true ref meg false exclude bads dcnl dcsp picks list picks by type evoked info meg combined has sss dcnl dcsp if has meg and has sss dcnl dcsp dcsp ch used list zip picks list 0 dcnl dcsp picks list x for x y in sorted zip picks list ch used dcnl dcsp n ch used len ch used dcnl dcsp rank list dcnl dcsp for cov in noise cov dcnl dcsp dcsp rank dcnl dcsp dcsp c cov data copy dcnl dcsp dcsp picks list2 k for k in picks list dcnl dcsp dcsp if rank is none dcnl dcsp dcsp dcsp if has meg and not has sss dcnl dcsp dcsp dcsp dcsp picks list2 + picks by type evoked info meg combined true dcnl dcsp dcsp dcsp for ch type this picks in picks list2 dcnl dcsp dcsp dcsp dcsp this info pick info evoked info this picks dcnl dcsp dcsp dcsp dcsp idx np ix this picks this picks dcnl dcsp dcsp dcsp dcsp this rank estimate rank meeg cov cidx this info scalings dcnl dcsp dcsp dcsp dcsp rank ch type this rank dcnl dcsp dcsp if rank is not none dcnl dcsp dcsp dcsp rank update rank dcnl dcsp dcsp rank list append rank dcnl dcsp evokeds white whiten evoked evoked n picks rank r for n r in zip noise cov rank list dcnl dcsp def whitened gfp x rank none dcnl dcsp dcsp whitened dcsp global dcsp field dcsp power n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp the dcsp mne dcsp inverse dcsp solver dcsp assumes dcsp zero dcsp mean dcsp whitened dcsp data dcsp as dcsp input n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp therefore dcsp a dcsp chi^2 dcsp statistic dcsp will dcsp be dcsp best dcsp to dcsp detect dcsp model dcsp violations n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp return np sum x 2 axis 0 len x if rank is none else rank dcnl dcsp if len noise cov 1 dcnl dcsp dcsp n columns 2 dcnl dcsp dcsp n extra row 0 dcnl dcsp else dcnl dcsp dcsp n columns 1 dcnl dcsp dcsp n extra row 1 dcnl dcsp n rows n ch used + n extra row dcnl dcsp fig axes plt subplots n rows n columns sharex true sharey false figsize 8 8 2 2 n rows dcnl dcsp if n columns 1 dcnl dcsp dcsp suptitle whitened dcsp evoked dcsp left dcsp best dcsp estimator dcsp dcsp s nand dcsp global dcsp field dcsp power dcsp right dcsp comparison dcsp of dcsp estimators noise cov0 get method empirical dcnl dcsp dcsp fig suptitle suptitle dcnl dcsp if any n columns 1 and n ch used 1 n columns 2 and n ch used 1 dcnl dcsp dcsp axes evoked axes n ch used dcnl dcsp dcsp ax gfp axes 1 dcnl dcsp elif n columns 2 and n ch used 1 dcnl dcsp dcsp axes evoked axes n ch used 0 dcnl dcsp dcsp ax gfp axes 1 dcnl dcsp else dcnl dcsp dcsp raise runtimeerror wrong dcsp axes dcsp inputs dcnl dcsp times evoked times 1000 0 dcnl dcsp titles handle default titles dcnl dcsp if has sss dcnl dcsp dcsp titles meg meg dcsp combined dcnl dcsp colors plt cm set1 i for i in np linspace 0 0 5 len noise cov dcnl dcsp ch colors eeg black mag blue grad cyan meg steelblue dcnl dcsp iter gfp zip evokeds white noise cov rank list colors dcnl dcsp if not has sss dcnl dcsp dcsp evokeds white0 plot unit false axes axes evoked hline 1 96 1 96 show false dcnl dcsp else dcnl dcsp dcsp for ch type picks ax in zip picks list axes evoked dcnl dcsp dcsp dcsp ax plot times evokeds white0 datapicks t color k dcnl dcsp dcsp dcsp for hline in 1 96 1 96 dcnl dcsp dcsp dcsp dcsp ax axhline hline color red linestyle dcnl dcsp for evoked white noise cov rank color in iter gfp dcnl dcsp dcsp i 0 dcnl dcsp dcsp for ch sub picks in picks list dcnl dcsp dcsp dcsp this rank rank ch dcnl dcsp dcsp dcsp title 0 dcsp 2 1 format titles ch if n columns 1 else ch this rank rank dcsp if n columns 1 else dcnl dcsp dcsp dcsp label noise cov get method empirical dcnl dcsp dcsp dcsp ax ax gfpi dcnl dcsp dcsp dcsp ax set title title if n columns 1 else whitened dcsp global dcsp field dcsp power dcsp gfp dcsp method dcsp dcsp s label dcnl dcsp dcsp dcsp data evoked white datasub picks dcnl dcsp dcsp dcsp gfp whitened gfp data rank this rank dcnl dcsp dcsp dcsp ax plot times gfp label label if n columns 1 else title color color if n columns 1 else ch colorsch dcnl dcsp dcsp dcsp ax set xlabel times dcsp ms dcnl dcsp dcsp dcsp ax set ylabel gfp dcsp chi^2 dcnl dcsp dcsp dcsp ax set xlim times0 times 1 dcnl dcsp dcsp dcsp ax set ylim 0 10 dcnl dcsp dcsp dcsp ax axhline 1 color red linestyle dcnl dcsp dcsp dcsp if n columns 1 dcnl dcsp dcsp dcsp dcsp i + 1 dcnl dcsp ax ax gfp0 dcnl dcsp if n columns 1 dcnl dcsp dcsp ax legend loc upper dcsp right bbox to anchor 0 98 0 9 prop dict size 12 dcnl dcsp else dcnl dcsp dcsp ax legend loc upper dcsp right prop dict size 10 dcnl dcsp dcsp params dict top 0 69 0 82 0 87 n rows 1 bottom 0 22 0 13 0 09 n rows 1 dcnl dcsp dcsp if has sss dcnl dcsp dcsp dcsp params hspace 0 49 dcnl dcsp dcsp fig subplots adjust params dcnl dcsp fig canvas draw dcnl dcsp plt show show dcnl dcsp return fig
def plot snr estimate evoked inv show true dcsp import matplotlib pyplot as plt dcnl dcsp from minimum norm import estimate snr dcnl dcsp snr snr est estimate snr evoked inv verbose true dcnl dcsp fig ax plt subplots 1 1 dcnl dcsp lims np concatenate evoked times0 1 1 snr est max dcnl dcsp ax plot 0 0 lims2 k dcnl dcsp ax plot lims 2 0 0 k dcnl dcsp ax plot evoked times snr est color 0 0 0 6 0 5 dcnl dcsp ax plot evoked times snr color 0 8 0 4 0 0 dcnl dcsp ax set xlim lims 2 dcnl dcsp ax set ylim lims2 dcnl dcsp ax set ylabel snr dcnl dcsp ax set xlabel time dcsp sec dcnl dcsp if evoked comment is not none dcnl dcsp dcsp ax set title evoked comment dcnl dcsp plt draw dcnl dcsp plt show show dcnl dcsp return fig
def connection line x fig sourceax targetax dcsp from matplotlib lines import line2d dcnl dcsp transfigure fig transfigure inverted dcnl dcsp tf fig transfigure dcnl dcsp xt yt transfigure transform targetax transaxes transform 0 5 0 25 dcnl dcsp xs transfigure transform sourceax transdata transform x 0 dcnl dcsp ys transfigure transform sourceax transaxes transform 0 1 dcnl dcsp return line2d xt xs yt ys transform tf color grey linestyle linewidth 1 5 alpha 0 66 zorder 0
def plot evoked joint evoked times peaks title picks none exclude none show true ts args none topomap args none dcsp import matplotlib pyplot as plt dcnl dcsp if ts args is none dcnl dcsp dcsp ts args dict dcnl dcsp if topomap args is none dcnl dcsp dcsp topomap args dict dcnl dcsp illegal args axes show times exclude dcnl dcsp for args in ts args topomap args dcnl dcsp dcsp if any x in args for x in illegal args dcnl dcsp dcsp dcsp raise valueerror don t dcsp pass dcsp any dcsp of dcsp dcsp as dcsp args format dcsp join list illegal args dcnl dcsp evoked evoked copy dcnl dcsp if picks is not none dcnl dcsp dcsp pick names evoked info ch names pick for pick in picks dcnl dcsp else dcnl dcsp dcsp picks pick data channels evoked info exclude dcnl dcsp dcsp pick names evoked info ch names pick for pick in picks dcnl dcsp evoked pick channels pick names dcnl dcsp if exclude bads dcnl dcsp dcsp exclude ch for ch in evoked info bads if ch in evoked info ch names dcnl dcsp if exclude is not none dcnl dcsp dcsp evoked drop channels exclude dcnl dcsp info evoked info dcnl dcsp data types eeg grad mag seeg ecog hbo hbr dcnl dcsp ch types set ch type for ch type in data types if ch type in evoked dcnl dcsp if len ch types 1 dcnl dcsp dcsp figs list dcnl dcsp dcsp for this type in ch types dcnl dcsp dcsp dcsp ev evoked copy pick channels info ch names idx for idx in range info nchan if channel type info idx this type dcnl dcsp dcsp dcsp if len set channel type ev info idx for idx in range ev info nchan if channel type ev info idx in data types 1 dcnl dcsp dcsp dcsp dcsp raise runtimeerror possibly dcsp infinite dcsp loop dcsp due dcsp to dcsp channel dcsp selection dcsp problem dcsp this dcsp should dcsp never dcsp happen dcsp please dcsp check dcsp your dcsp channel dcsp types dcnl dcsp dcsp dcsp figs append plot evoked joint ev times times title title show show ts args ts args exclude list topomap args topomap args dcnl dcsp dcsp return figs dcnl dcsp fig plt figure figsize 8 0 4 2 dcnl dcsp times process times evoked times few true dcnl dcsp ts ax fig add subplot 212 dcnl dcsp ts args def dict picks none unit true ylim none xlim tight proj false hline none units none scalings none titles none gfp false window title none spatial colors true zorder std dcnl dcsp ts args def update ts args dcnl dcsp plot evoked evoked axes ts ax show false plot type butterfly exclude set tight layout false ts args def dcnl dcsp old title ts ax get title dcnl dcsp ts ax set title dcnl dcsp if title is not none dcnl dcsp dcsp title ax plt subplot 4 3 2 dcnl dcsp dcsp if title dcnl dcsp dcsp dcsp title old title dcnl dcsp dcsp title ax text 0 5 0 5 title transform title ax transaxes horizontalalignment center verticalalignment center dcnl dcsp dcsp title ax axis off dcnl dcsp ts len times + 2 dcnl dcsp map ax plt subplot 4 ts x + 2 + ts for x in range ts 2 dcnl dcsp cbar ax plt subplot 4 3 ts + 1 6 ts + 1 dcnl dcsp contours topomap args get contours 6 dcnl dcsp ch type ch types pop dcnl dcsp vmin vmax ts ax get ylim dcnl dcsp norm ch type grad dcnl dcsp vmin 0 if norm else vmin dcnl dcsp vmin vmax setup vmin vmax evoked data vmin vmax norm dcnl dcsp if not isinstance contours list np ndarray dcnl dcsp dcsp locator contours set contour locator vmin vmax contours dcnl dcsp else dcnl dcsp dcsp locator none dcnl dcsp topomap args pass topomap args copy dcnl dcsp topomap args pass outlines topomap args get outlines skirt dcnl dcsp topomap args pass contours contours dcnl dcsp evoked plot topomap times times axes map ax show false colorbar false topomap args pass dcnl dcsp if topomap args get colorbar true dcnl dcsp dcsp from matplotlib import ticker dcnl dcsp dcsp cbar plt colorbar map ax0 images0 cax cbar ax dcnl dcsp dcsp if isinstance contours list np ndarray dcnl dcsp dcsp dcsp cbar set ticks contours dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if locator is none dcnl dcsp dcsp dcsp dcsp locator ticker maxnlocator nbins 5 dcnl dcsp dcsp dcsp cbar locator locator dcnl dcsp dcsp cbar update ticks dcnl dcsp plt subplots adjust left 0 1 right 0 93 bottom 0 14 top 1 0 if title is not none else 1 2 dcnl dcsp tstimes timepoint 1000 0 for timepoint in times dcnl dcsp lines connection line timepoint fig ts ax map ax for timepoint map ax in zip tstimes map ax dcnl dcsp for line in lines dcnl dcsp dcsp fig lines append line dcnl dcsp for timepoint in tstimes dcnl dcsp dcsp ts ax axvline timepoint color grey linestyle linewidth 1 5 alpha 0 66 zorder 0 dcnl dcsp plt show show dcnl dcsp return fig
def ci arr ci dcsp from scipy import stats dcnl dcsp mean sigma arr mean 0 stats sem arr 0 dcnl dcsp return np asarray stats t interval ci arr shape0 loc mean scale sigma for mean sigma in zip mean sigma t
def setup styles conditions style dict style default dcsp tags set tag for cond in conditions for tag in cond split dcnl dcsp msg can t dcsp map dcsp between dcsp conditions dcsp and dcsp the dcsp provided dcsp 0 dcsp make dcsp sure dcsp you dcsp have dcsp provided dcsp keys dcsp in dcsp the dcsp format dcsp of dcsp separated dcsp tags dcsp and dcsp that dcsp these dcsp correspond dcsp to dcsp separated dcsp tags dcsp for dcsp the dcsp condition dcsp names dcsp e g dcsp conditions dcsp like dcsp visual right dcsp and dcsp styles dcsp like dcsp colors dict visual red dcsp the dcsp offending dcsp tag dcsp was dcsp 1 dcnl dcsp for key in style dict dcnl dcsp dcsp for tag in key split dcnl dcsp dcsp dcsp if tag not in tags dcnl dcsp dcsp dcsp dcsp raise valueerror msg format style tag dcnl dcsp condition warning condition dcsp 0 dcsp could dcsp not dcsp be dcsp mapped dcsp to dcsp a dcsp + style dcnl dcsp style warning dcsp using dcsp the dcsp default dcsp of dcsp 0 format default dcnl dcsp for condition in conditions dcnl dcsp dcsp if condition not in style dict dcnl dcsp dcsp dcsp if not in condition dcnl dcsp dcsp dcsp dcsp warn condition warning format condition + style warning dcnl dcsp dcsp dcsp dcsp style dictcondition default dcnl dcsp dcsp dcsp for style in style dict dcnl dcsp dcsp dcsp dcsp if style in condition split dcnl dcsp dcsp dcsp dcsp dcsp style dictcondition style dictstyle dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp return style dict
def truncate yaxis axes ymin ymax orig ymin orig ymax fraction any positive any negative dcsp abs lims orig ymax if orig ymax np abs orig ymin else np abs orig ymin dcnl dcsp ymin ymax abs lims fraction abs lims fraction dcnl dcsp if ymin is not none and ymin ymin dcnl dcsp dcsp ymin ymin dcnl dcsp if ymax is not none and ymax < ymax dcnl dcsp dcsp ymax ymax dcnl dcsp yticks ymin if any negative else 0 ymax if any positive else 0 dcnl dcsp axes set yticks yticks dcnl dcsp ymin bound ymax bound abs lims fraction abs lims fraction dcnl dcsp if ymin is not none and ymin ymin bound dcnl dcsp dcsp ymin bound ymin dcnl dcsp if ymax is not none and ymax < ymax bound dcnl dcsp dcsp ymax bound ymax dcnl dcsp precision 0 25 dcnl dcsp if ymin is none dcnl dcsp dcsp ymin bound round ymin bound precision precision dcnl dcsp if ymin is none dcnl dcsp dcsp ymax bound round ymax bound precision precision dcnl dcsp axes spines left set bounds ymin bound ymax bound dcnl dcsp return ymin bound ymax bound
def plot compare evokeds evokeds picks list gfp false colors none linestyles styles none vlines 0 0 ci 0 95 truncate yaxis false ylim dict invert y false axes none title none show true dcsp import matplotlib pyplot as plt dcnl dcsp from evoked import evoked combine evoked dcnl dcsp if isinstance evokeds evoked dcnl dcsp dcsp evokeds dict evoked evokeds dcnl dcsp elif not isinstance evokeds dict dcnl dcsp dcsp evokeds dict str ii + 1 evoked for ii evoked in enumerate evokeds dcnl dcsp for cond in evokeds keys dcnl dcsp dcsp if not isinstance cond string types dcnl dcsp dcsp dcsp raise typeerror conditions dcsp must dcsp be dcsp str dcsp not dcsp s type cond dcnl dcsp conditions sorted list evokeds keys dcnl dcsp example evokedsconditions0 if isinstance evokedsconditions0 evoked else evokedsconditions00 dcnl dcsp if not isinstance example evoked dcnl dcsp dcsp raise valueerror evokeds dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp mne evoked dcsp or dcsp a dcsp collection dcsp of dcsp mne evoked s dcnl dcsp times example times dcnl dcsp tmin tmax times0 times 1 dcnl dcsp if isinstance picks integral dcnl dcsp dcsp picks picks dcnl dcsp elif len picks 0 dcnl dcsp dcsp warn no dcsp picks dcsp plotting dcsp the dcsp gfp dcsp dcnl dcsp dcsp gfp true dcnl dcsp dcsp picks pick data channels example info dcnl dcsp dcsp if len picks 0 dcnl dcsp dcsp dcsp raise valueerror no dcsp valid dcsp channels dcsp were dcsp found dcsp to dcsp plot dcsp the dcsp gfp dcsp + use dcsp picks dcsp instead dcsp to dcsp select dcsp them dcsp manually dcnl dcsp if gfp is true dcnl dcsp dcsp ch names global dcsp field dcsp power dcnl dcsp dcsp if len picks < 2 dcnl dcsp dcsp dcsp raise valueerror a dcsp gfp dcsp with dcsp less dcsp than dcsp 2 dcsp channels dcsp doesn t dcsp work dcsp please dcsp pick dcsp more dcsp channels dcnl dcsp else dcnl dcsp dcsp if not isinstance picks0 int np integer dcnl dcsp dcsp dcsp msg picks dcsp must dcsp be dcsp int dcsp or dcsp a dcsp list dcsp of dcsp int dcsp not dcsp 0 dcnl dcsp dcsp dcsp raise valueerror msg format type picks dcnl dcsp dcsp ch names example ch namespick for pick in picks dcnl dcsp ch types list set channel type example info pick for pick in picks dcnl dcsp if any type not in valid channel types for type in ch types dcnl dcsp dcsp raise valueerror nondata dcsp channel dcsp picked dcnl dcsp if len ch types 1 dcnl dcsp dcsp warn multiple dcsp channel dcsp types dcsp selected dcsp returning dcsp one dcsp figure dcsp per dcsp type dcnl dcsp dcsp if axes is not none dcnl dcsp dcsp dcsp from utils import validate if list of axes dcnl dcsp dcsp dcsp validate if list of axes axes obligatory len len ch types dcnl dcsp dcsp figs list dcnl dcsp dcsp for ii t in enumerate ch types dcnl dcsp dcsp dcsp picks idx for idx in picks if channel type example info idx t dcnl dcsp dcsp dcsp title gfp dcsp + t if not title and gfp is true else title dcnl dcsp dcsp dcsp ax axesii if axes is not none else none dcnl dcsp dcsp dcsp figs append plot compare evokeds evokeds picks picks gfp gfp colors colors linestyles linestyles styles styles vlines vlines ci ci truncate yaxis truncate yaxis ylim ylim invert y invert y axes ax title title show show dcnl dcsp dcsp return figs dcnl dcsp else dcnl dcsp dcsp ch type ch types0 dcnl dcsp dcsp ymin ymax ylim get ch type none none dcnl dcsp scaling handle default scalings ch type dcnl dcsp unit handle default units ch type dcnl dcsp if ch type grad and gfp is not true dcnl dcsp dcsp from channels layout import merge grad data pair grad sensors dcnl dcsp dcsp picked chans list dcnl dcsp dcsp pairpicks pair grad sensors example info topomap coords false dcnl dcsp dcsp for ii in np arange 0 len pairpicks 2 dcnl dcsp dcsp dcsp first second pairpicksii pairpicks ii + 1 dcnl dcsp dcsp dcsp if first in picks or second in picks dcnl dcsp dcsp dcsp dcsp picked chans append first dcnl dcsp dcsp dcsp dcsp picked chans append second dcnl dcsp dcsp picks list sorted set picked chans dcnl dcsp dcsp ch names example ch namespick for pick in picks dcnl dcsp if ymin is none and gfp is true or ch type grad dcnl dcsp dcsp ymin 0 0 dcnl dcsp if not isinstance ci np float dcnl dcsp dcsp msg ci dcsp must dcsp be dcsp float dcsp got dcsp 0 dcsp instead dcnl dcsp dcsp raise typeerror msg format type ci dcnl dcsp if not all isinstance evoked evoked for evoked in evokeds values dcnl dcsp dcsp if ci is not none and gfp is not true dcnl dcsp dcsp dcsp sem array dict dcnl dcsp dcsp dcsp for condition in conditions dcnl dcsp dcsp dcsp dcsp if ch type grad and gfp is not true dcnl dcsp dcsp dcsp dcsp dcsp data np asarray merge grad data evoked datapicks mean 0 for evoked in evokedscondition dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp data np asarray evoked datapicks mean 0 for evoked in evokedscondition dcnl dcsp dcsp dcsp dcsp sem arraycondition ci data ci dcnl dcsp dcsp evokeds dict cond combine evoked evokedscond weights equal for cond in conditions dcnl dcsp dcsp if gfp is true and ci is not none dcnl dcsp dcsp dcsp warn confidence dcsp interval dcsp not dcsp drawn dcsp when dcsp plotting dcsp gfp dcnl dcsp else dcnl dcsp dcsp ci false dcnl dcsp dcsp combine evoked list evokeds values weights nave dcnl dcsp if axes is none dcnl dcsp dcsp fig axes plt subplots 1 1 figsize 8 6 dcnl dcsp else dcnl dcsp dcsp fig axes figure dcnl dcsp styles deepcopy styles dcnl dcsp colors deepcopy colors dcnl dcsp linestyles deepcopy linestyles dcnl dcsp if isinstance styles dict dcnl dcsp dcsp for style in styles dcnl dcsp dcsp dcsp if style not in conditions dcnl dcsp dcsp dcsp dcsp raise valueerror could dcsp not dcsp map dcsp between dcsp styles dcsp and dcsp conditions dcsp condition dcsp + style + dcsp was dcsp not dcsp found dcsp in dcsp the dcsp supplied dcsp data dcnl dcsp if colors is not none and not isinstance colors string types and not isinstance colors dict and len colors 1 dcnl dcsp dcsp colors dict condition color for condition color in zip conditions colors dcnl dcsp if not isinstance colors dict dcnl dcsp dcsp colors e41a1c 377eb8 4daf4a 984ea3 ff7f00 1b9e77 d95f02 7570b3 e7298a 66a61e dcnl dcsp dcsp if len conditions len colors dcnl dcsp dcsp dcsp msg trying dcsp to dcsp plot dcsp more dcsp than dcsp 0 dcsp conditions dcsp we dcsp provideonly dcsp 0 dcsp default dcsp colors dcsp please dcsp supply dcsp colors dcsp manually dcnl dcsp dcsp dcsp raise valueerror msg format len colors dcnl dcsp dcsp colors dict condition color for condition color in zip conditions colors dcnl dcsp else dcnl dcsp dcsp colors setup styles conditions colors color grey dcnl dcsp if not isinstance linestyles dict dcnl dcsp dcsp linestyles dict condition linestyle for condition linestyle in zip conditions len conditions dcnl dcsp else dcnl dcsp dcsp linestyles setup styles conditions linestyles linestyle dcnl dcsp if styles is none dcnl dcsp dcsp styles dict dcnl dcsp for condition color linestyle in zip conditions colors linestyles dcnl dcsp dcsp stylescondition styles get condition dict dcnl dcsp dcsp stylescondition c stylescondition get c colorscondition dcnl dcsp dcsp stylescondition linestyle stylescondition get linestyle linestylescondition dcnl dcsp any negative any positive false false dcnl dcsp for condition in conditions dcnl dcsp dcsp if ch type grad and gfp is false dcnl dcsp dcsp dcsp d merge grad data evokedscondition datapicks t scaling mean 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp func np std if gfp is true else np mean dcnl dcsp dcsp dcsp d func evokedscondition datapicks t scaling 1 dcnl dcsp dcsp axes plot times d zorder 1000 label condition stylescondition dcnl dcsp dcsp if np any d 0 dcnl dcsp dcsp dcsp any positive true dcnl dcsp dcsp if np any d < 0 dcnl dcsp dcsp dcsp any negative true dcnl dcsp dcsp if ci and gfp is not true dcnl dcsp dcsp dcsp sem sem arraycondition dcnl dcsp dcsp dcsp axes fill between times sem 0 flatten scaling sem 1 flatten scaling zorder 100 color stylescondition c alpha 0 333 dcnl dcsp orig ymin orig ymax axes get ylim dcnl dcsp if not any positive dcnl dcsp dcsp orig ymax 0 dcnl dcsp if not any negative dcnl dcsp dcsp orig ymin 0 dcnl dcsp axes set ylim orig ymin if ymin is none else ymin orig ymax if ymax is none else ymax dcnl dcsp fraction 2 if axes get ylim 0 0 else 3 dcnl dcsp if truncate yaxis is true dcnl dcsp dcsp ymax bound truncate yaxis axes ymin ymax orig ymin orig ymax fraction any positive any negative dcnl dcsp else dcnl dcsp dcsp if ymin is not none and ymin 0 dcnl dcsp dcsp dcsp warn ymin dcsp is dcsp positive dcsp not dcsp truncating dcsp yaxis dcnl dcsp dcsp ymax bound axes get ylim 1 dcnl dcsp title dcsp join ch names 6 if title is none else title dcnl dcsp if len ch names 6 and gfp is false dcnl dcsp dcsp warn more dcsp than dcsp 6 dcsp channels dcsp truncating dcsp title dcsp dcnl dcsp dcsp title + dcsp dcnl dcsp axes set title title dcnl dcsp current ymin axes get ylim 0 dcnl dcsp if invert y is true and current ymin < 0 dcnl dcsp dcsp upper v lower v ymax bound axes get ylim 1 dcnl dcsp else dcnl dcsp dcsp upper v lower v axes get ylim 0 ymax bound dcnl dcsp axes vlines vlines upper v lower v linestyles colors k linewidth 1 0 zorder 1 dcnl dcsp setup ax spines axes vlines tmin tmax invert y ymax bound unit dcnl dcsp if len conditions 1 dcnl dcsp dcsp plt legend loc best ncol 1 + len conditions 5 frameon true dcnl dcsp plt show show dcnl dcsp return fig
def plot ica sources ica inst picks none exclude none start none stop none title none show true block false show first samp false dcsp from io base import baseraw dcnl dcsp from evoked import evoked dcnl dcsp from epochs import baseepochs dcnl dcsp if exclude is none dcnl dcsp dcsp exclude ica exclude dcnl dcsp elif len ica exclude 0 dcnl dcsp dcsp exclude np union1d ica exclude exclude dcnl dcsp if isinstance inst baseraw dcnl dcsp dcsp fig plot sources raw ica inst picks exclude start start stop stop show show title title block block show first samp show first samp dcnl dcsp elif isinstance inst baseepochs dcnl dcsp dcsp fig plot sources epochs ica inst picks exclude start start stop stop show show title title block block dcnl dcsp elif isinstance inst evoked dcnl dcsp dcsp if start is not none or stop is not none dcnl dcsp dcsp dcsp inst inst copy crop start stop dcnl dcsp dcsp sources ica get sources inst dcnl dcsp dcsp fig plot ica sources evoked evoked sources picks picks exclude exclude title title labels getattr ica labels none show show dcnl dcsp else dcnl dcsp dcsp raise valueerror data dcsp input dcsp must dcsp be dcsp of dcsp raw dcsp or dcsp epochs dcsp type dcnl dcsp return fig
def create properties layout figsize none dcsp import matplotlib pyplot as plt dcnl dcsp if figsize is none dcnl dcsp dcsp figsize 7 0 6 0 dcnl dcsp fig plt figure figsize figsize facecolor 0 95 3 dcnl dcsp ax list dcnl dcsp ax append fig add axes 0 08 0 5 0 3 0 45 label topomap dcnl dcsp ax append fig add axes 0 5 0 6 0 45 0 35 label image dcnl dcsp ax append fig add axes 0 5 0 5 0 45 0 1 label erp dcnl dcsp ax append fig add axes 0 08 0 1 0 32 0 3 label spectrum dcnl dcsp ax append fig add axes 0 5 0 1 0 45 0 25 label variance dcnl dcsp return fig ax
def plot ica properties ica inst picks none axes none db true plot std true topomap args none image args none psd args none figsize none show true dcsp from io base import baseraw dcnl dcsp from epochs import baseepochs dcnl dcsp from preprocessing import ica dcnl dcsp if not isinstance inst baseraw baseepochs dcnl dcsp dcsp raise valueerror inst dcsp should dcsp be dcsp an dcsp instance dcsp of dcsp raw dcsp or dcsp epochs dcsp got dcsp s dcsp instead type inst dcnl dcsp if not isinstance ica ica dcnl dcsp dcsp raise valueerror ica dcsp has dcsp to dcsp be dcsp an dcsp instance dcsp of dcsp ica dcsp got dcsp s dcsp instead type ica dcnl dcsp if isinstance plot std bool dcnl dcsp dcsp num std 1 0 if plot std else 0 0 dcnl dcsp elif isinstance plot std float int dcnl dcsp dcsp num std plot std dcnl dcsp dcsp plot std true dcnl dcsp else dcnl dcsp dcsp raise valueerror plot std dcsp has dcsp to dcsp be dcsp a dcsp bool dcsp int dcsp or dcsp float dcsp got dcsp s dcsp instead type plot std dcnl dcsp picks list range min 5 ica n components if picks is none else picks dcnl dcsp picks picks if isinstance picks integral else picks dcnl dcsp if axes is none dcnl dcsp dcsp fig axes create properties layout figsize figsize dcnl dcsp else dcnl dcsp dcsp if len picks 1 dcnl dcsp dcsp dcsp raise valueerror only dcsp a dcsp single dcsp pick dcsp can dcsp be dcsp drawn dcsp to dcsp a dcsp set dcsp of dcsp axes dcnl dcsp dcsp from utils import validate if list of axes dcnl dcsp dcsp validate if list of axes axes obligatory len 5 dcnl dcsp dcsp fig axes0 get figure dcnl dcsp psd args dict if psd args is none else psd args dcnl dcsp topomap args dict if topomap args is none else topomap args dcnl dcsp image args dict if image args is none else image args dcnl dcsp for d in psd args topomap args image args dcnl dcsp dcsp if not isinstance d dict dcnl dcsp dcsp dcsp raise valueerror topomap args dcsp image args dcsp and dcsp psd args dcsp have dcsp to dcsp be dcsp dictionaries dcsp got dcsp s dcsp instead type d dcnl dcsp if db is not none and isinstance db bool is false dcnl dcsp dcsp raise valueerror db dcsp should dcsp be dcsp bool dcsp got dcsp s dcsp instead type db dcnl dcsp plot line at zero false dcnl dcsp if isinstance inst baseraw dcnl dcsp dcsp from epochs import segment raw dcnl dcsp dcsp inst segment raw inst segment length 2 0 verbose false preload true dcnl dcsp if inst times0 < 0 0 and inst times 1 0 0 dcnl dcsp dcsp plot line at zero true dcnl dcsp epochs src ica get sources inst dcnl dcsp ica data np swapaxes epochs src get data picks 0 1 dcnl dcsp nyquist inst info sfreq 2 0 dcnl dcsp if fmax not in psd args dcnl dcsp dcsp psd args fmax min inst info lowpass 1 25 nyquist dcnl dcsp plot lowpass edge inst info lowpass < nyquist and psd args fmax inst info lowpass dcnl dcsp psds freqs psd multitaper epochs src picks picks psd args dcnl dcsp def set title and labels ax title xlab ylab dcnl dcsp dcsp if title dcnl dcsp dcsp dcsp ax set title title dcnl dcsp dcsp if xlab dcnl dcsp dcsp dcsp ax set xlabel xlab dcnl dcsp dcsp if ylab dcnl dcsp dcsp dcsp ax set ylabel ylab dcnl dcsp dcsp ax axis auto dcnl dcsp dcsp ax tick params both labelsize 8 dcnl dcsp dcsp ax axis tight dcnl dcsp all fig list dcnl dcsp for idx pick in enumerate picks dcnl dcsp dcsp if idx 0 dcnl dcsp dcsp dcsp fig axes create properties layout figsize figsize dcnl dcsp dcsp this psd psds idx dcnl dcsp dcsp if db dcnl dcsp dcsp dcsp this psd 10 np log10 this psd dcnl dcsp dcsp psds mean this psd mean axis 0 dcnl dcsp dcsp diffs this psd psds mean dcnl dcsp dcsp spectrum std np sqrt d d < 0 2 mean axis 0 for d in diffs t np sqrt d d 0 2 mean axis 0 for d in diffs t dcnl dcsp dcsp spectrum std np array spectrum std num std dcnl dcsp dcsp if plot std dcnl dcsp dcsp dcsp erp ica dataidx mean axis 0 dcnl dcsp dcsp dcsp diffs ica dataidx erp dcnl dcsp dcsp dcsp erp std np sqrt d d < 0 2 mean axis 0 for d in diffs t np sqrt d d 0 2 mean axis 0 for d in diffs t dcnl dcsp dcsp dcsp erp std np array erp std num std dcnl dcsp dcsp epoch var np var ica dataidx axis 1 dcnl dcsp dcsp plot ica topomap ica pick show false axes axes0 topomap args dcnl dcsp dcsp plot epochs image epochs src picks pick axes axes1 3 colorbar false show false image args dcnl dcsp dcsp axes3 plot freqs psds mean color k dcnl dcsp dcsp if plot std dcnl dcsp dcsp dcsp axes3 fill between freqs psds mean spectrum std0 psds mean + spectrum std1 color k alpha 0 15 dcnl dcsp dcsp if plot lowpass edge dcnl dcsp dcsp dcsp axes3 axvline inst info lowpass lw 2 linestyle color k alpha 0 15 dcnl dcsp dcsp axes4 scatter range len epoch var epoch var alpha 0 5 facecolor 0 0 0 lw 0 dcnl dcsp dcsp axes0 set title ic dcsp 0 0 3 format pick dcnl dcsp dcsp set title and labels axes1 epochs dcsp image dcsp and dcsp erp erf epochs dcnl dcsp dcsp set title and labels axes2 time au dcnl dcsp dcsp axes2 lines0 set color k dcnl dcsp dcsp if plot std dcnl dcsp dcsp dcsp erp xdata axes2 lines0 get data 0 dcnl dcsp dcsp dcsp axes2 fill between erp xdata erp erp std0 erp + erp std1 color k alpha 0 15 dcnl dcsp dcsp dcsp axes2 autoscale enable true axis y dcnl dcsp dcsp dcsp axes2 axis auto dcnl dcsp dcsp dcsp axes2 set xlim erp xdata0 1 dcnl dcsp dcsp yt axes2 get yticks dcnl dcsp dcsp if len yt 5 dcnl dcsp dcsp dcsp yt yt 2 dcnl dcsp dcsp dcsp axes2 yaxis set ticks yt dcnl dcsp dcsp if not plot line at zero dcnl dcsp dcsp dcsp xlims 1000 0 inst times0 1000 0 inst times 1 dcnl dcsp dcsp dcsp for k ax in enumerate axes1 3 dcnl dcsp dcsp dcsp dcsp ax linesk remove dcnl dcsp dcsp dcsp dcsp ax set xlim xlims dcnl dcsp dcsp axes1 xaxis set ticks dcnl dcsp dcsp yt axes1 get yticks dcnl dcsp dcsp axes1 yaxis set ticks yt1 dcnl dcsp dcsp axes1 set ylim 0 5 ica data shape1 + 0 5 dcnl dcsp dcsp ylabel db if db else power dcnl dcsp dcsp set title and labels axes3 spectrum frequency ylabel dcnl dcsp dcsp axes3 yaxis labelpad 0 dcnl dcsp dcsp axes3 set xlim freqs0 1 dcnl dcsp dcsp ylim axes3 get ylim dcnl dcsp dcsp air np diff ylim 0 0 1 dcnl dcsp dcsp axes3 set ylim ylim0 air ylim1 + air dcnl dcsp dcsp set title and labels axes4 epochs dcsp variance epoch au dcnl dcsp dcsp all fig append fig dcnl dcsp plt show show dcnl dcsp return all fig
def plot ica sources evoked evoked picks exclude title show labels none dcsp import matplotlib pyplot as plt dcnl dcsp if title is none dcnl dcsp dcsp title reconstructed dcsp latent dcsp sources dcsp timelocked dcnl dcsp fig axes plt subplots 1 dcnl dcsp ax axes dcnl dcsp axes axes dcnl dcsp times evoked times 1000 0 dcnl dcsp lines list dcnl dcsp texts list dcnl dcsp if picks is none dcnl dcsp dcsp picks np arange evoked data shape0 dcnl dcsp picks np sort picks dcnl dcsp idxs picks dcnl dcsp if labels is not none dcnl dcsp dcsp labels used k for k in labels if not in k dcnl dcsp exclude labels list dcnl dcsp for ii in picks dcnl dcsp dcsp if ii in exclude dcnl dcsp dcsp dcsp line label ic dcsp 03d ii dcnl dcsp dcsp dcsp if labels is not none dcnl dcsp dcsp dcsp dcsp annot list dcnl dcsp dcsp dcsp dcsp for this label in labels used dcnl dcsp dcsp dcsp dcsp dcsp indices labelsthis label dcnl dcsp dcsp dcsp dcsp dcsp if ii in indices dcnl dcsp dcsp dcsp dcsp dcsp dcsp annot append this label dcnl dcsp dcsp dcsp dcsp line label + dcsp dcsp + dcsp join annot dcnl dcsp dcsp dcsp exclude labels append line label dcnl dcsp dcsp else dcnl dcsp dcsp dcsp exclude labels append none dcnl dcsp if labels is not none dcnl dcsp dcsp unique labels set k split dcsp dcsp 1 for k in exclude labels if k dcnl dcsp dcsp label colors plt cm rainbow np linspace 0 1 len unique labels dcnl dcsp dcsp label colors dict zip unique labels label colors dcnl dcsp else dcnl dcsp dcsp label colors dict k red for k in exclude labels dcnl dcsp for exc label ii in zip exclude labels picks dcnl dcsp dcsp if exc label is not none dcnl dcsp dcsp dcsp if dcsp dcsp in exc label dcnl dcsp dcsp dcsp dcsp key exc label split dcsp dcsp 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp key exc label dcnl dcsp dcsp dcsp color label colorskey dcnl dcsp dcsp dcsp lines extend ax plot times evoked dataii t picker 3 0 zorder 2 color color label exc label dcnl dcsp dcsp else dcnl dcsp dcsp dcsp lines extend ax plot times evoked dataii t picker 3 0 color k zorder 1 dcnl dcsp ax set title title dcnl dcsp ax set xlim times0 1 dcnl dcsp ax set xlabel time dcsp ms dcnl dcsp ax set ylabel na dcnl dcsp if len exclude 0 dcnl dcsp dcsp plt legend loc best dcnl dcsp tight layout fig fig dcnl dcsp texts append ax text 0 0 blank zorder 3 verticalalignment baseline horizontalalignment left fontweight bold alpha 0 dcnl dcsp lines lines dcnl dcsp ch names evoked ch names dcnl dcsp from matplotlib import patheffects dcnl dcsp path effects patheffects withstroke linewidth 2 foreground w alpha 0 75 dcnl dcsp params dict axes axes texts texts lines lines idxs idxs ch names ch names need draw false path effects path effects dcnl dcsp fig canvas mpl connect pick event partial butterfly onpick params params dcnl dcsp fig canvas mpl connect button press event partial butterfly on button press params params dcnl dcsp plt show show dcnl dcsp return fig
def plot ica scores ica scores exclude none labels none axhline none title ica dcsp component dcsp scores figsize none show true dcsp import matplotlib pyplot as plt dcnl dcsp my range np arange ica n components dcnl dcsp if exclude is none dcnl dcsp dcsp exclude ica exclude dcnl dcsp exclude np unique exclude dcnl dcsp if not isinstance scores0 list np ndarray dcnl dcsp dcsp scores scores dcnl dcsp n rows len scores dcnl dcsp if figsize is none dcnl dcsp dcsp figsize 6 4 2 7 n rows dcnl dcsp fig axes plt subplots n rows figsize figsize sharex true sharey true dcnl dcsp if isinstance axes np ndarray dcnl dcsp dcsp axes axes flatten dcnl dcsp else dcnl dcsp dcsp axes axes dcnl dcsp axes0 set title title dcnl dcsp if labels ecg dcnl dcsp dcsp labels l for l in ica labels if l startswith ecg dcnl dcsp elif labels eog dcnl dcsp dcsp labels l for l in ica labels if l startswith eog dcnl dcsp dcsp labels sort key lambda l l split 1 dcnl dcsp elif isinstance labels string types dcnl dcsp dcsp if len axes 1 dcnl dcsp dcsp dcsp raise valueerror need dcsp as dcsp many dcsp labels dcsp as dcsp axes dcsp i len axes dcnl dcsp dcsp labels labels dcnl dcsp elif isinstance labels tuple list dcnl dcsp dcsp if len labels len axes dcnl dcsp dcsp dcsp raise valueerror need dcsp as dcsp many dcsp labels dcsp as dcsp axes dcsp i len axes dcnl dcsp elif labels is none dcnl dcsp dcsp labels none n rows dcnl dcsp for label this scores ax in zip labels scores axes dcnl dcsp dcsp if len my range len this scores dcnl dcsp dcsp dcsp raise valueerror the dcsp length dcsp of dcsp scores dcsp must dcsp equal dcsp the dcsp number dcsp of dcsp ica dcsp components dcnl dcsp dcsp ax bar my range this scores color w edgecolor k dcnl dcsp dcsp for excl in exclude dcnl dcsp dcsp dcsp ax bar my rangeexcl this scoresexcl color r edgecolor k dcnl dcsp dcsp if axhline is not none dcnl dcsp dcsp dcsp if np isscalar axhline dcnl dcsp dcsp dcsp dcsp axhline axhline dcnl dcsp dcsp dcsp for axl in axhline dcnl dcsp dcsp dcsp dcsp ax axhline axl color r linestyle dcnl dcsp dcsp ax set ylabel score dcnl dcsp dcsp if label is not none dcnl dcsp dcsp dcsp if eog in label dcnl dcsp dcsp dcsp dcsp split label split dcnl dcsp dcsp dcsp dcsp label dcsp join split0 split2 dcnl dcsp dcsp dcsp elif in label dcnl dcsp dcsp dcsp dcsp label dcsp join label split dcnl dcsp dcsp dcsp ax set title s label dcnl dcsp dcsp ax set xlabel ica dcsp components dcnl dcsp dcsp ax set xlim 0 len this scores dcnl dcsp tight layout fig fig dcnl dcsp plt show show dcnl dcsp return fig
def plot ica overlay ica inst exclude none picks none start none stop none title none show true dcsp from io base import baseraw dcnl dcsp from evoked import evoked dcnl dcsp from preprocessing ica import check start stop dcnl dcsp if not isinstance inst baseraw evoked dcnl dcsp dcsp raise valueerror data dcsp input dcsp must dcsp be dcsp of dcsp raw dcsp or dcsp evoked dcsp type dcnl dcsp if title is none dcnl dcsp dcsp title signals dcsp before dcsp red dcsp and dcsp after dcsp black dcsp cleaning dcnl dcsp if picks is none dcnl dcsp dcsp picks inst ch names index k for k in ica ch names dcnl dcsp if exclude is none dcnl dcsp dcsp exclude ica exclude dcnl dcsp if isinstance inst baseraw dcnl dcsp dcsp if start is none dcnl dcsp dcsp dcsp start 0 0 dcnl dcsp dcsp if stop is none dcnl dcsp dcsp dcsp stop 3 0 dcnl dcsp dcsp ch types used k for k in mag grad eeg if k in ica dcnl dcsp dcsp start compare stop compare check start stop inst start stop dcnl dcsp dcsp data times instpicks start compare stop compare dcnl dcsp dcsp raw cln ica apply inst copy exclude exclude start start stop stop dcnl dcsp dcsp data cln raw clnpicks start compare stop compare dcnl dcsp dcsp fig plot ica overlay raw data data data cln data cln times times 1000 0 title title ch types used ch types used show show dcnl dcsp elif isinstance inst evoked dcnl dcsp dcsp if start is not none and stop is not none dcnl dcsp dcsp dcsp inst inst copy crop start stop dcnl dcsp dcsp if picks is not none dcnl dcsp dcsp dcsp inst pick channels inst ch namesp for p in picks dcnl dcsp dcsp evoked cln ica apply inst copy exclude exclude dcnl dcsp dcsp fig plot ica overlay evoked evoked inst evoked cln evoked cln title title show show dcnl dcsp return fig
def plot ica overlay raw data data cln times title ch types used show dcsp import matplotlib pyplot as plt dcnl dcsp assert data shape data cln shape dcnl dcsp fig ax1 ax2 plt subplots 2 1 sharex true dcnl dcsp plt suptitle title dcnl dcsp ax1 plot times data t color r dcnl dcsp ax1 plot times data cln t color k dcnl dcsp ax1 set xlabel time dcsp s dcnl dcsp ax1 set xlim times0 times 1 dcnl dcsp ax1 set xlim times0 times 1 dcnl dcsp ax1 set title raw dcsp data dcnl dcsp ch types mag magnetometers grad gradiometers eeg eeg dcnl dcsp ch types dcsp join ch typesk for k in ch types used dcnl dcsp ax2 set title average dcsp across dcsp channels dcsp 0 format ch types dcnl dcsp ax2 plot times data mean 0 color r dcnl dcsp ax2 plot times data cln mean 0 color k dcnl dcsp ax2 set xlim 100 106 dcnl dcsp ax2 set xlabel time dcsp ms dcnl dcsp ax2 set xlim times0 times 1 dcnl dcsp tight layout fig fig dcnl dcsp fig subplots adjust top 0 9 dcnl dcsp fig canvas draw dcnl dcsp plt show show dcnl dcsp return fig
def plot ica overlay evoked evoked evoked cln title show dcsp import matplotlib pyplot as plt dcnl dcsp ch types used c for c in mag grad eeg if c in evoked dcnl dcsp n rows len ch types used dcnl dcsp ch types used cln c for c in mag grad eeg if c in evoked cln dcnl dcsp if len ch types used len ch types used cln dcnl dcsp dcsp raise valueerror raw dcsp and dcsp clean dcsp evokeds dcsp must dcsp match dcsp found dcsp different dcsp channels dcnl dcsp fig axes plt subplots n rows 1 dcnl dcsp fig suptitle average dcsp signal dcsp before dcsp red dcsp and dcsp after dcsp black dcsp ica dcnl dcsp axes axes flatten if isinstance axes np ndarray else axes dcnl dcsp evoked plot axes axes show show dcnl dcsp for ax in fig axes dcnl dcsp dcsp for l in ax get lines dcnl dcsp dcsp dcsp l set color r dcnl dcsp fig canvas draw dcnl dcsp evoked cln plot axes axes show show dcnl dcsp tight layout fig fig dcnl dcsp fig subplots adjust top 0 9 dcnl dcsp fig canvas draw dcnl dcsp plt show show dcnl dcsp return fig
def plot sources raw ica raw picks exclude start stop show title block show first samp dcsp color handle default color 0 0 0 0 0 0 dcnl dcsp orig data ica transform raw raw 0 len raw times 0 2 dcnl dcsp if picks is none dcnl dcsp dcsp picks range len orig data dcnl dcsp types misc for in picks dcnl dcsp picks list sorted picks dcnl dcsp eog chs pick types raw info meg false eog true ref meg false dcnl dcsp ecg chs pick types raw info meg false ecg true ref meg false dcnl dcsp data orig datapick for pick in picks dcnl dcsp c names ic dcsp 03d x for x in range len orig data dcnl dcsp for eog idx in eog chs dcnl dcsp dcsp c names append raw ch nameseog idx dcnl dcsp dcsp types append eog dcnl dcsp for ecg idx in ecg chs dcnl dcsp dcsp c names append raw ch namesecg idx dcnl dcsp dcsp types append ecg dcnl dcsp extra picks np append eog chs ecg chs astype int dcnl dcsp if len extra picks 0 dcnl dcsp dcsp eog ecg data rawextra picks dcnl dcsp dcsp for idx in range len eog ecg data dcnl dcsp dcsp dcsp if idx < len eog chs dcnl dcsp dcsp dcsp dcsp eog ecg dataidx 0 00015 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp eog ecg dataidx 0 0005 dcnl dcsp dcsp data np append data eog ecg data axis 0 dcnl dcsp for idx in range len extra picks dcnl dcsp dcsp picks np append picks ica n components + idx dcnl dcsp if title is none dcnl dcsp dcsp title ica dcsp components dcnl dcsp info create info c namesx for x in picks raw info sfreq dcnl dcsp info bads c namesx for x in exclude dcnl dcsp if start is none dcnl dcsp dcsp start 0 dcnl dcsp if stop is none dcnl dcsp dcsp stop start + 20 dcnl dcsp dcsp stop min stop raw times 1 dcnl dcsp duration stop start dcnl dcsp if duration < 0 dcnl dcsp dcsp raise runtimeerror stop dcsp must dcsp be dcsp larger dcsp than dcsp start dcnl dcsp t end int duration raw info sfreq dcnl dcsp times raw times0 t end dcnl dcsp bad color 1 0 0 0 0 0 dcnl dcsp inds list range len picks dcnl dcsp data np array data dcnl dcsp n channels min 20 len picks dcnl dcsp first time raw first time if show first samp else 0 dcnl dcsp start + first time dcnl dcsp params dict raw raw orig data data data data 0 t end inds inds ch start 0 t start start info info duration duration ica ica n channels n channels times times types types n times raw n times bad color bad color picks picks first time first time data picks decim 1 dcnl dcsp prepare mne browse raw params title w color bad color inds n channels dcnl dcsp params scale factor 1 0 dcnl dcsp params plot fun partial plot raw traces params params color color bad color bad color dcnl dcsp params update fun partial update data params dcnl dcsp params pick bads fun partial pick bads params params dcnl dcsp params label click fun partial label clicked params params dcnl dcsp layout figure params dcnl dcsp callback key partial plot raw onkey params params dcnl dcsp params fig canvas mpl connect key press event callback key dcnl dcsp callback scroll partial plot raw onscroll params params dcnl dcsp params fig canvas mpl connect scroll event callback scroll dcnl dcsp callback pick partial mouse click params params dcnl dcsp params fig canvas mpl connect button press event callback pick dcnl dcsp callback resize partial helper raw resize params params dcnl dcsp params fig canvas mpl connect resize event callback resize dcnl dcsp callback close partial close event params params dcnl dcsp params fig canvas mpl connect close event callback close dcnl dcsp params fig proj none dcnl dcsp params event times none dcnl dcsp params butterfly false dcnl dcsp params update fun dcnl dcsp params plot fun dcnl dcsp try dcnl dcsp dcsp plt show show block block dcnl dcsp except typeerror dcnl dcsp dcsp plt show show dcnl dcsp return params fig
def update data params dcsp sfreq params info sfreq dcnl dcsp start int params t start params first time sfreq dcnl dcsp end int params t start + params duration sfreq dcnl dcsp params data params orig data start end dcnl dcsp params times params raw timesstart end
def pick bads event params dcsp bads params info bads dcnl dcsp params info bads select bads event params bads dcnl dcsp params update fun dcnl dcsp params plot fun
def close event events params dcsp info params info dcnl dcsp c names ic dcsp 03d x for x in range params ica n components dcnl dcsp exclude c names index x for x in info bads if x startswith ic dcnl dcsp params ica exclude exclude
def plot sources epochs ica epochs picks exclude start stop show title block dcsp data ica transform epochs epochs concatenate true dcnl dcsp eog chs pick types epochs info meg false eog true ref meg false dcnl dcsp ecg chs pick types epochs info meg false ecg true ref meg false dcnl dcsp c names ic dcsp 03d x for x in range ica n components dcnl dcsp ch types np repeat misc ica n components dcnl dcsp for eog idx in eog chs dcnl dcsp dcsp c names append epochs ch nameseog idx dcnl dcsp dcsp ch types np append ch types eog dcnl dcsp for ecg idx in ecg chs dcnl dcsp dcsp c names append epochs ch namesecg idx dcnl dcsp dcsp ch types np append ch types ecg dcnl dcsp extra picks np append eog chs ecg chs astype int dcnl dcsp if len extra picks 0 dcnl dcsp dcsp eog ecg data np concatenate epochs get data extra picks axis 1 dcnl dcsp dcsp data np append data eog ecg data axis 0 dcnl dcsp scalings handle default scalings plot raw dcnl dcsp scalings misc 5 0 dcnl dcsp info create info ch names c names sfreq epochs info sfreq ch types ch types dcnl dcsp info projs list dcnl dcsp info bads c namesx for x in exclude dcnl dcsp if title is none dcnl dcsp dcsp title ica dcsp components dcnl dcsp if picks is none dcnl dcsp dcsp picks list range ica n components dcnl dcsp if start is none dcnl dcsp dcsp start 0 dcnl dcsp if stop is none dcnl dcsp dcsp stop start + 20 dcnl dcsp dcsp stop min stop len epochs events dcnl dcsp for idx in range len extra picks dcnl dcsp dcsp picks np append picks ica n components + idx dcnl dcsp n epochs stop start dcnl dcsp if n epochs < 0 dcnl dcsp dcsp raise runtimeerror stop dcsp must dcsp be dcsp larger dcsp than dcsp start dcnl dcsp params ica ica epochs epochs info info orig data data bads list bad color 1 0 0 0 0 0 t start start len epochs times data picks decim 1 dcnl dcsp params label click fun partial label clicked params params dcnl dcsp prepare mne browse epochs params projs list n channels 20 n epochs n epochs scalings scalings title title picks picks order misc eog ecg dcnl dcsp params plot update proj callback update epoch data dcnl dcsp update epoch data params dcnl dcsp params hsel patch set x params t start dcnl dcsp callback close partial close epochs event params params dcnl dcsp params fig canvas mpl connect close event callback close dcnl dcsp try dcnl dcsp dcsp plt show show block block dcnl dcsp except typeerror dcnl dcsp dcsp plt show show dcnl dcsp return params fig
def update epoch data params dcsp start params t start dcnl dcsp n epochs params n epochs dcnl dcsp end start + n epochs len params epochs times dcnl dcsp data params orig data start end dcnl dcsp types params types dcnl dcsp for pick ind in enumerate params inds dcnl dcsp dcsp params data pick dataind params scalings typespick dcnl dcsp params plot fun
def close epochs event events params dcsp info params info dcnl dcsp exclude info ch names index x for x in info bads if x startswith ic dcnl dcsp params ica exclude exclude
def label clicked pos params dcsp import matplotlib pyplot as plt dcnl dcsp offsets np array params offsets + params offsets 0 dcnl dcsp line idx np searchsorted offsets pos1 + params ch start dcnl dcsp if line idx len params picks dcnl dcsp dcsp return dcnl dcsp ic idx params picks line idx dcnl dcsp if params types ic idx0 misc dcnl dcsp dcsp warn can dcsp only dcsp plot dcsp ica dcsp components dcnl dcsp dcsp return dcnl dcsp types list dcnl dcsp info params ica info dcnl dcsp if len pick types info meg false eeg true ref meg false 0 dcnl dcsp dcsp types append eeg dcnl dcsp if len pick types info meg mag ref meg false 0 dcnl dcsp dcsp types append mag dcnl dcsp if len pick types info meg grad ref meg false 0 dcnl dcsp dcsp types append grad dcnl dcsp ica params ica dcnl dcsp data np dot ica mixing matrix ic idx t ica pca components ica n components dcnl dcsp data np atleast 2d data dcnl dcsp fig axes prepare trellis len types max col 3 dcnl dcsp for ch idx ch type in enumerate types dcnl dcsp dcsp try dcnl dcsp dcsp dcsp data picks pos merge grads prepare topo plot ica ch type none dcnl dcsp dcsp except exception as exc dcnl dcsp dcsp dcsp warn exc dcnl dcsp dcsp dcsp plt close fig dcnl dcsp dcsp dcsp return dcnl dcsp dcsp this data data data picks dcnl dcsp dcsp ax axesch idx dcnl dcsp dcsp if merge grads dcnl dcsp dcsp dcsp from channels layout import merge grad data dcnl dcsp dcsp for ii data in zip ic idx this data dcnl dcsp dcsp dcsp ax set title ic dcsp 03d dcsp ii + ch type fontsize 12 dcnl dcsp dcsp dcsp data merge grad data data if merge grads else data dcnl dcsp dcsp dcsp plot topomap data flatten pos axes ax show false dcnl dcsp dcsp dcsp hide frame ax dcnl dcsp tight layout fig fig dcnl dcsp fig subplots adjust top 0 95 dcnl dcsp fig canvas draw dcnl dcsp plt show true
verbose dcnl def plot cov cov info exclude colorbar true proj false show svd true show true verbose none dcsp if exclude bads dcnl dcsp dcsp exclude info bads dcnl dcsp ch names n for n in cov ch names if n not in exclude dcnl dcsp ch idx cov ch names index n for n in ch names dcnl dcsp info ch names info ch names dcnl dcsp sel eeg pick types info meg false eeg true ref meg false exclude exclude dcnl dcsp sel mag pick types info meg mag eeg false ref meg false exclude exclude dcnl dcsp sel grad pick types info meg grad eeg false ref meg false exclude exclude dcnl dcsp idx eeg ch names index info ch namesc for c in sel eeg if info ch namesc in ch names dcnl dcsp idx mag ch names index info ch namesc for c in sel mag if info ch namesc in ch names dcnl dcsp idx grad ch names index info ch namesc for c in sel grad if info ch namesc in ch names dcnl dcsp idx names idx eeg eeg dcsp covariance uv 1000000 0 idx grad gradiometers ft cm 10000000000000 0 idx mag magnetometers ft 1000000000000000 0 dcnl dcsp idx names idx name unit scaling for idx name unit scaling in idx names if len idx 0 dcnl dcsp c cov datach idx ch idx dcnl dcsp if proj dcnl dcsp dcsp projs copy deepcopy info projs dcnl dcsp dcsp for p in projs dcnl dcsp dcsp dcsp p active true dcnl dcsp dcsp p ncomp make projector projs ch names dcnl dcsp dcsp if ncomp 0 dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp created dcsp an dcsp ssp dcsp operator dcsp subspace dcsp dimension dcsp dcsp d ncomp dcnl dcsp dcsp dcsp c np dot p np dot c p t dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp the dcsp projection dcsp vectors dcsp do dcsp not dcsp apply dcsp to dcsp these dcsp channels dcnl dcsp import matplotlib pyplot as plt dcnl dcsp fig cov axes plt subplots 1 len idx names squeeze false figsize 2 5 len idx names 2 7 dcnl dcsp for k idx name in enumerate idx names dcnl dcsp dcsp axes 0 k imshow cidx idx interpolation nearest cmap rdbu r dcnl dcsp dcsp axes 0 k set title name dcnl dcsp fig cov subplots adjust 0 04 0 0 0 98 0 94 0 2 0 26 dcnl dcsp tight layout fig fig cov dcnl dcsp fig svd none dcnl dcsp if show svd dcnl dcsp dcsp fig svd axes plt subplots 1 len idx names squeeze false dcnl dcsp dcsp for k idx name unit scaling in enumerate idx names dcnl dcsp dcsp dcsp s linalg svd cidx idx compute uv false dcnl dcsp dcsp dcsp s s < 0 1e10 s s 0 min dcnl dcsp dcsp dcsp s np sqrt s scaling dcnl dcsp dcsp dcsp axes 0 k plot s dcnl dcsp dcsp dcsp axes 0 k set ylabel noise dcsp std dcsp s unit yscale log xlabel eigenvalue dcsp index title name dcnl dcsp dcsp tight layout fig fig svd dcnl dcsp plt show show dcnl dcsp return fig cov fig svd
def plot source spectrogram stcs freq bins tmin none tmax none source index none colorbar false show true dcsp import matplotlib pyplot as plt dcnl dcsp if len stcs 0 dcnl dcsp dcsp raise valueerror cannot dcsp plot dcsp spectrogram dcsp if dcsp len stcs dcsp dcsp 0 dcnl dcsp stc stcs0 dcnl dcsp if tmin is not none and tmin < stc times0 dcnl dcsp dcsp raise valueerror tmin dcsp cannot dcsp be dcsp smaller dcsp than dcsp the dcsp first dcsp time dcsp point dcsp provided dcsp in dcsp stcs dcnl dcsp if tmax is not none and tmax stc times 1 + stc tstep dcnl dcsp dcsp raise valueerror tmax dcsp cannot dcsp be dcsp larger dcsp than dcsp the dcsp sum dcsp of dcsp the dcsp last dcsp time dcsp point dcsp and dcsp the dcsp time dcsp step dcsp which dcsp are dcsp provided dcsp in dcsp stcs dcnl dcsp if tmin is none dcnl dcsp dcsp tmin stc times0 dcnl dcsp if tmax is none dcnl dcsp dcsp tmax stc times 1 + stc tstep dcnl dcsp time bounds np arange tmin tmax + stc tstep stc tstep dcnl dcsp freq bounds sorted set np ravel freq bins dcnl dcsp freq ticks copy deepcopy freq bounds dcnl dcsp source power dcnl dcsp for stc in stcs dcnl dcsp dcsp stc stc copy dcnl dcsp dcsp stc crop tmin tmax stc tstep dcnl dcsp dcsp source power append stc data dcnl dcsp source power np array source power dcnl dcsp if source index is none dcnl dcsp dcsp source index np unravel index source power argmax source power shape 1 dcnl dcsp gap bounds dcnl dcsp for i in range len freq bins 1 dcnl dcsp dcsp lower bound freq binsi1 dcnl dcsp dcsp upper bound freq bins i + 1 0 dcnl dcsp dcsp if lower bound upper bound dcnl dcsp dcsp dcsp freq bounds remove lower bound dcnl dcsp dcsp dcsp gap bounds append lower bound upper bound dcnl dcsp time grid freq grid np meshgrid time bounds freq bounds dcnl dcsp fig plt figure figsize 9 6 dcnl dcsp plt pcolor time grid freq grid source power source index cmap reds dcnl dcsp ax plt gca dcnl dcsp plt title timefrequency dcsp source dcsp power dcnl dcsp plt xlabel time dcsp s dcnl dcsp plt ylabel frequency dcsp hz dcnl dcsp time tick labels str np round t 2 for t in time bounds dcnl dcsp n skip 1 + len time bounds 10 dcnl dcsp for i in range len time bounds dcnl dcsp dcsp if i n skip 0 dcnl dcsp dcsp dcsp time tick labelsi dcnl dcsp ax set xticks time bounds dcnl dcsp ax set xticklabels time tick labels dcnl dcsp plt xlim time bounds0 time bounds 1 dcnl dcsp plt yscale log dcnl dcsp ax set yticks freq ticks dcnl dcsp ax set yticklabels np round freq 2 for freq in freq ticks dcnl dcsp plt ylim freq bounds0 freq bounds 1 dcnl dcsp plt grid true ls dcnl dcsp if colorbar dcnl dcsp dcsp plt colorbar dcnl dcsp tight layout fig fig dcnl dcsp for lower bound upper bound in gap bounds dcnl dcsp dcsp plt barh lower bound time bounds 1 time bounds0 upper bound lower bound time bounds0 color 666666 dcnl dcsp plt show show dcnl dcsp return fig
def plot mri contours mri fname surfaces src orientation coronal slices none show true dcsp import matplotlib pyplot as plt dcnl dcsp import nibabel as nib dcnl dcsp if orientation coronal dcnl dcsp dcsp x y z 0 1 2 dcnl dcsp elif orientation axial dcnl dcsp dcsp x y z 2 0 1 dcnl dcsp elif orientation sagittal dcnl dcsp dcsp x y z 2 1 0 dcnl dcsp else dcnl dcsp dcsp raise valueerror orientation dcsp must dcsp be dcsp coronal dcsp axial dcsp or dcsp sagittal dcsp got dcsp s orientation dcnl dcsp nim nib load mri fname dcnl dcsp data nim get data dcnl dcsp try dcnl dcsp dcsp affine nim affine dcnl dcsp except attributeerror dcnl dcsp dcsp affine nim get affine dcnl dcsp n sag n axi n cor data shape dcnl dcsp orientation name2axis dict sagittal 0 axial 1 coronal 2 dcnl dcsp orientation axis orientation name2axisorientation dcnl dcsp if slices is none dcnl dcsp dcsp n slices data shapeorientation axis dcnl dcsp dcsp slices np linspace 0 n slices 12 endpoint false astype np int dcnl dcsp surfs list dcnl dcsp trans linalg inv affine dcnl dcsp trans 3 1 n sag 2 n axi 2 n cor 2 dcnl dcsp for file name color in surfaces dcnl dcsp dcsp surf dict dcnl dcsp dcsp surf rr surf tris read surface file name dcnl dcsp dcsp surf rr nib affines apply affine trans surf rr dcnl dcsp dcsp surfs append surf color dcnl dcsp src points list dcnl dcsp if isinstance src sourcespaces dcnl dcsp dcsp for src in src dcnl dcsp dcsp dcsp points src rr src inuse astype bool 1000 0 dcnl dcsp dcsp dcsp src points append nib affines apply affine trans points dcnl dcsp elif src is not none dcnl dcsp dcsp raise typeerror src dcsp needs dcsp to dcsp be dcsp none dcsp or dcsp sourcespaces dcsp instance dcsp not dcsp s repr src dcnl dcsp fig axs prepare trellis len slices 4 dcnl dcsp for ax sl in zip axs slices dcnl dcsp dcsp if orientation coronal dcnl dcsp dcsp dcsp dat data sl transpose dcnl dcsp dcsp elif orientation axial dcnl dcsp dcsp dcsp dat data sl dcnl dcsp dcsp elif orientation sagittal dcnl dcsp dcsp dcsp dat datasl dcnl dcsp dcsp ax imshow dat cmap plt cm gray dcnl dcsp dcsp ax set autoscale on false dcnl dcsp dcsp ax axis off dcnl dcsp dcsp for surf color in surfs dcnl dcsp dcsp dcsp ax tricontour surf rr x surf rr y surf tris surf rr z levels sl colors color linewidths 2 0 zorder 1 dcnl dcsp dcsp for sources in src points dcnl dcsp dcsp dcsp in slice np logical and sources z sl 0 5 sources z < sl + 0 5 dcnl dcsp dcsp dcsp ax scatter sources in slice x sources in slice y marker color ff00ff s 1 zorder 2 dcnl dcsp plt subplots adjust left 0 0 bottom 0 0 right 1 0 top 1 0 wspace 0 0 hspace 0 0 dcnl dcsp plt show show dcnl dcsp return fig
def plot bem subject none subjects dir none orientation coronal slices none brain surfaces none src none show true dcsp subjects dir get subjects dir subjects dir raise error true dcnl dcsp mri fname op join subjects dir subject mri t1 mgz dcnl dcsp if not op isfile mri fname dcnl dcsp dcsp raise ioerror mri dcsp file dcsp s dcsp does dcsp not dcsp exist mri fname dcnl dcsp bem path op join subjects dir subject bem dcnl dcsp if not op isdir bem path dcnl dcsp dcsp raise ioerror subject dcsp bem dcsp directory dcsp s dcsp does dcsp not dcsp exist bem path dcnl dcsp surfaces dcnl dcsp for surf name color in inner skull ff0000 outer skull ffff00 outer skin ffaa80 dcnl dcsp dcsp surf fname glob op join bem path surf name + surf dcnl dcsp dcsp if len surf fname 0 dcnl dcsp dcsp dcsp surf fname surf fname0 dcnl dcsp dcsp dcsp logger info using dcsp surface dcsp s surf fname dcnl dcsp dcsp dcsp surfaces append surf fname color dcnl dcsp if brain surfaces is not none dcnl dcsp dcsp if isinstance brain surfaces string types dcnl dcsp dcsp dcsp brain surfaces brain surfaces dcnl dcsp dcsp for surf name in brain surfaces dcnl dcsp dcsp dcsp for hemi in lh rh dcnl dcsp dcsp dcsp dcsp surf fname op join subjects dir subject surf hemi + + surf name dcnl dcsp dcsp dcsp dcsp if op exists surf fname dcnl dcsp dcsp dcsp dcsp dcsp surfaces append surf fname 00dd00 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp raise ioerror surface dcsp s dcsp does dcsp not dcsp exist surf fname dcnl dcsp if isinstance src string types dcnl dcsp dcsp if not op exists src dcnl dcsp dcsp dcsp src op join subjects dir subject bem src dcnl dcsp dcsp dcsp if op exists src dcnl dcsp dcsp dcsp dcsp src src dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise ioerror s dcsp does dcsp not dcsp exist src dcnl dcsp dcsp src read source spaces src dcnl dcsp elif src is not none and not isinstance src sourcespaces dcnl dcsp dcsp raise typeerror src dcsp needs dcsp to dcsp be dcsp none dcsp str dcsp or dcsp sourcespaces dcsp instance dcsp not dcsp s repr src dcnl dcsp if len surfaces 0 dcnl dcsp dcsp raise ioerror no dcsp surface dcsp files dcsp found dcsp surface dcsp files dcsp must dcsp end dcsp with dcsp inner skull surf dcsp outer skull surf dcsp or dcsp outer skin surf dcnl dcsp return plot mri contours mri fname surfaces src orientation slices show
def plot events events sfreq none first samp 0 color none event id none axes none equal spacing true show true dcsp if sfreq is none dcnl dcsp dcsp sfreq 1 0 dcnl dcsp dcsp xlabel samples dcnl dcsp else dcnl dcsp dcsp xlabel time dcsp s dcnl dcsp events np asarray events dcnl dcsp unique events np unique events 2 dcnl dcsp if event id is not none dcnl dcsp dcsp event id rev dict v k for k v in event id items dcnl dcsp dcsp conditions unique events id zip sorted event id items key lambda x x1 dcnl dcsp dcsp for this event in unique events id dcnl dcsp dcsp dcsp if this event not in unique events dcnl dcsp dcsp dcsp dcsp raise valueerror s dcsp from dcsp event id dcsp is dcsp not dcsp present dcsp in dcsp events this event dcnl dcsp dcsp for this event in unique events dcnl dcsp dcsp dcsp if this event not in unique events id dcnl dcsp dcsp dcsp dcsp warn event dcsp s dcsp missing dcsp from dcsp event id dcsp will dcsp be dcsp ignored this event dcnl dcsp else dcnl dcsp dcsp unique events id unique events dcnl dcsp color handle event colors unique events color unique events id dcnl dcsp import matplotlib pyplot as plt dcnl dcsp fig none dcnl dcsp if axes is none dcnl dcsp dcsp fig plt figure dcnl dcsp ax axes if axes else plt gca dcnl dcsp unique events id np array unique events id dcnl dcsp min event np min unique events id dcnl dcsp max event np max unique events id dcnl dcsp for idx ev in enumerate unique events id dcnl dcsp dcsp ev mask events 2 ev dcnl dcsp dcsp kwargs dcnl dcsp dcsp if event id is not none dcnl dcsp dcsp dcsp event label 0 dcsp 1 format event id revev np sum ev mask dcnl dcsp dcsp dcsp kwargs label event label dcnl dcsp dcsp if ev in color dcnl dcsp dcsp dcsp kwargs color colorev dcnl dcsp dcsp if equal spacing dcnl dcsp dcsp dcsp ax plot events ev mask 0 first samp sfreq idx + 1 np ones ev mask sum kwargs dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax plot events ev mask 0 first samp sfreq events ev mask 2 kwargs dcnl dcsp if equal spacing dcnl dcsp dcsp ax set ylim 0 unique events id size + 1 dcnl dcsp dcsp ax set yticks 1 + np arange unique events id size dcnl dcsp dcsp ax set yticklabels unique events id dcnl dcsp else dcnl dcsp dcsp ax set ylim min event 1 max event + 1 dcnl dcsp ax set xlabel xlabel dcnl dcsp ax set ylabel events dcsp id dcnl dcsp ax grid on dcnl dcsp fig fig if fig is not none else plt gcf dcnl dcsp if event id is not none dcnl dcsp dcsp box ax get position dcnl dcsp dcsp ax set position box x0 box y0 box width 0 8 box height dcnl dcsp dcsp ax legend loc center dcsp left bbox to anchor 1 0 5 dcnl dcsp dcsp fig canvas draw dcnl dcsp plt show show dcnl dcsp return fig
def get presser fig dcsp callbacks fig canvas callbacks callbacks button press event dcnl dcsp func none dcnl dcsp for key val in callbacks items dcnl dcsp dcsp if val func class name partial dcnl dcsp dcsp dcsp func val func dcnl dcsp dcsp dcsp break dcnl dcsp assert func is not none dcnl dcsp return func
def plot dipole amplitudes dipoles colors none show true dcsp import matplotlib pyplot as plt dcnl dcsp if colors is none dcnl dcsp dcsp colors cycle colors dcnl dcsp fig ax plt subplots 1 1 dcnl dcsp xlim np inf np inf dcnl dcsp for dip color in zip dipoles colors dcnl dcsp dcsp ax plot dip times dip amplitude 1000000000 0 color color linewidth 1 5 dcnl dcsp dcsp xlim0 min xlim0 dip times0 dcnl dcsp dcsp xlim1 max xlim1 dip times 1 dcnl dcsp ax set xlim xlim dcnl dcsp ax set xlabel time dcsp sec dcnl dcsp ax set ylabel amplitude dcsp nam dcnl dcsp if show dcnl dcsp dcsp fig show warn false dcnl dcsp return fig
def adjust axes axes remove spines top right grid true dcsp axes axes if not isinstance axes list tuple np ndarray else axes dcnl dcsp for ax in axes dcnl dcsp dcsp if grid dcnl dcsp dcsp dcsp ax grid zorder 0 dcnl dcsp dcsp for key in remove spines dcnl dcsp dcsp dcsp ax spineskey set visible false
def filter ticks lims fscale dcsp if fscale linear dcnl dcsp dcsp return none none dcnl dcsp lims np array lims dcnl dcsp ticks list dcnl dcsp for exp in range int np floor np log10 lims0 int np floor np log10 lims1 + 1 dcnl dcsp dcsp ticks + np array 1 2 4 10 exp tolist dcnl dcsp ticks np array ticks dcnl dcsp ticks ticks ticks lims0 ticks < lims1 dcnl dcsp ticklabels g if t < 1 else d t for t in ticks dcnl dcsp return ticks ticklabels
def get flim flim fscale freq sfreq none dcsp if flim is none dcnl dcsp dcsp if freq is none dcnl dcsp dcsp dcsp flim 0 1 if fscale log else 0 0 sfreq 2 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if fscale linear dcnl dcsp dcsp dcsp dcsp flim freq0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp flim freq0 if freq0 0 else 0 1 freq1 dcnl dcsp dcsp dcsp flim + freq 1 dcnl dcsp if fscale log dcnl dcsp dcsp if flim0 < 0 dcnl dcsp dcsp dcsp raise valueerror flim0 dcsp must dcsp be dcsp positive dcsp got dcsp s flim0 dcnl dcsp elif flim0 < 0 dcnl dcsp dcsp raise valueerror flim0 dcsp must dcsp be dcsp nonnegative dcsp got dcsp s flim0 dcnl dcsp return flim
def check fscale fscale dcsp if not isinstance fscale string types or fscale not in log linear dcnl dcsp dcsp raise valueerror fscale dcsp must dcsp be dcsp log dcsp or dcsp linear dcsp got dcsp s fscale
def plot filter h sfreq freq none gain none title none color 1f77b4 flim none fscale log alim 60 10 show true dcsp from scipy signal import freqz group delay dcnl dcsp import matplotlib pyplot as plt dcnl dcsp sfreq float sfreq dcnl dcsp check fscale fscale dcnl dcsp flim get flim flim fscale freq sfreq dcnl dcsp if fscale log dcnl dcsp dcsp omega np logspace np log10 flim0 np log10 flim1 1000 dcnl dcsp else dcnl dcsp dcsp omega np linspace flim0 flim1 1000 dcnl dcsp omega sfreq 2 np pi dcnl dcsp if isinstance h dict dcnl dcsp dcsp if sos in h dcnl dcsp dcsp dcsp from scipy signal import sosfilt dcnl dcsp dcsp dcsp h h sos dcnl dcsp dcsp dcsp h np ones len omega np complex128 dcnl dcsp dcsp dcsp gd np zeros len omega dcnl dcsp dcsp dcsp for section in h dcnl dcsp dcsp dcsp dcsp this h freqz section 3 section3 omega 1 dcnl dcsp dcsp dcsp dcsp h this h dcnl dcsp dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp dcsp gd + group delay section 3 section3 omega 1 dcnl dcsp dcsp dcsp n estimate ringing samples h dcnl dcsp dcsp dcsp delta np zeros n dcnl dcsp dcsp dcsp delta0 1 dcnl dcsp dcsp dcsp h sosfilt h delta dcnl dcsp dcsp else dcnl dcsp dcsp dcsp from scipy signal import lfilter dcnl dcsp dcsp dcsp n estimate ringing samples h b h a dcnl dcsp dcsp dcsp delta np zeros n dcnl dcsp dcsp dcsp delta0 1 dcnl dcsp dcsp dcsp h freqz h b h a omega 1 dcnl dcsp dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp dcsp gd group delay h b h a omega 1 dcnl dcsp dcsp dcsp h lfilter h b h a delta dcnl dcsp dcsp title sos dcsp iir dcsp filter if title is none else title dcnl dcsp else dcnl dcsp dcsp h freqz h worn omega 1 dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp gd group delay h 1 0 omega 1 dcnl dcsp dcsp title fir dcsp filter if title is none else title dcnl dcsp gd sfreq dcnl dcsp fig axes plt subplots 3 dcnl dcsp t np arange len h sfreq dcnl dcsp f omega sfreq 2 np pi dcnl dcsp axes0 plot t h color color dcnl dcsp axes0 set xlim t0 1 xlabel time dcsp sec ylabel amplitude dcsp h n title title dcnl dcsp mag 10 np log10 np maximum h h conj real 1e20 dcnl dcsp axes1 plot f mag color color linewidth 2 zorder 4 dcnl dcsp if freq is not none and gain is not none dcnl dcsp dcsp plot ideal filter freq gain axes1 fscale fscale title none show false dcnl dcsp axes1 set ylabel magnitude dcsp db xlabel xscale fscale dcnl dcsp sl slice 0 if fscale linear else 1 none none dcnl dcsp axes2 plot fsl gdsl color color linewidth 2 zorder 4 dcnl dcsp axes2 set xlim flim ylabel group dcsp delay dcsp sec xlabel frequency dcsp hz xscale fscale dcnl dcsp xticks xticklabels filter ticks flim fscale dcnl dcsp dlim 0 1 05 gd1 max dcnl dcsp for ax ylim ylabel in zip axes1 alim dlim amplitude dcsp db delay dcsp sec dcnl dcsp dcsp if xticks is not none dcnl dcsp dcsp dcsp ax set xticks xticks dcnl dcsp dcsp dcsp ax set xticklabels xticklabels dcnl dcsp dcsp ax set xlim flim ylim ylim xlabel frequency dcsp hz ylabel ylabel dcnl dcsp adjust axes axes dcnl dcsp tight layout dcnl dcsp plt show show dcnl dcsp return fig
def plot ideal filter freq gain axes none title flim none fscale log alim 60 10 color r alpha 0 5 linestyle show true dcsp import matplotlib pyplot as plt dcnl dcsp xs ys list list dcnl dcsp my freq my gain list list dcnl dcsp if freq0 0 dcnl dcsp dcsp raise valueerror freq dcsp should dcsp start dcsp with dcsp dc dcsp zero dcsp and dcsp end dcsp with dcsp nyquist dcsp but dcsp got dcsp s dcsp for dcsp dc freq0 dcnl dcsp freq np array freq dcnl dcsp check fscale fscale dcnl dcsp if fscale log dcnl dcsp dcsp freq0 0 1 freq1 if flim is none else min flim0 freq1 dcnl dcsp flim get flim flim fscale freq dcnl dcsp for ii in range len freq dcnl dcsp dcsp xs append freqii dcnl dcsp dcsp ys append alim0 dcnl dcsp dcsp if ii < len freq 1 and gainii gain ii + 1 dcnl dcsp dcsp dcsp xs + freqii freq ii + 1 dcnl dcsp dcsp dcsp ys + alim1 2 dcnl dcsp dcsp dcsp my freq + np linspace freqii freq ii + 1 20 endpoint false tolist dcnl dcsp dcsp dcsp my gain + np linspace gainii gain ii + 1 20 endpoint false tolist dcnl dcsp dcsp else dcnl dcsp dcsp dcsp my freq append freqii dcnl dcsp dcsp dcsp my gain append gainii dcnl dcsp my gain 10 np log10 np maximum my gain 10 alim0 10 0 dcnl dcsp if axes is none dcnl dcsp dcsp axes plt subplots 1 1 dcnl dcsp xs np maximum xs flim0 dcnl dcsp axes fill between xs alim0 ys color color alpha 0 1 dcnl dcsp axes plot my freq my gain color color linestyle linestyle alpha 0 5 linewidth 4 zorder 3 dcnl dcsp xticks xticklabels filter ticks flim fscale dcnl dcsp axes set ylim alim xlabel frequency dcsp hz ylabel amplitude dcsp db xscale fscale dcnl dcsp if xticks is not none dcnl dcsp dcsp axes set xticks xticks dcnl dcsp dcsp axes set xticklabels xticklabels dcnl dcsp axes set xlim flim dcnl dcsp adjust axes axes dcnl dcsp tight layout dcnl dcsp plt show show dcnl dcsp return axes figure
def handle event colors unique events color unique events id dcsp if color is none dcnl dcsp dcsp if len unique events len colors dcnl dcsp dcsp dcsp warn more dcsp events dcsp than dcsp colors dcsp available dcsp you dcsp should dcsp pass dcsp a dcsp list dcsp of dcsp unique dcsp colors dcnl dcsp dcsp colors cycle colors dcnl dcsp dcsp color dict dcnl dcsp dcsp for this event this color in zip sorted unique events id colors dcnl dcsp dcsp dcsp colorthis event this color dcnl dcsp else dcnl dcsp dcsp for this event in color dcnl dcsp dcsp dcsp if this event not in unique events id dcnl dcsp dcsp dcsp dcsp raise valueerror s dcsp from dcsp color dcsp is dcsp not dcsp present dcsp in dcsp events dcsp or dcsp event id this event dcnl dcsp dcsp for this event in unique events id dcnl dcsp dcsp dcsp if this event not in color dcnl dcsp dcsp dcsp dcsp warn color dcsp is dcsp not dcsp available dcsp for dcsp event dcsp d dcsp default dcsp colors dcsp will dcsp be dcsp used this event dcnl dcsp return color
def iter topography info layout none on pick none fig none fig facecolor k axis facecolor k axis spinecolor k layout scale none dcsp return iter topography info layout on pick fig fig facecolor axis facecolor axis spinecolor layout scale
def iter topography info layout on pick fig fig facecolor k axis facecolor k axis spinecolor k layout scale none unified false img false axes none dcsp from matplotlib import pyplot as plt collections dcnl dcsp if fig is none dcnl dcsp dcsp fig plt figure dcnl dcsp fig set facecolor fig facecolor dcnl dcsp if layout is none dcnl dcsp dcsp layout find layout info dcnl dcsp if on pick is not none dcnl dcsp dcsp callback partial plot topo onpick show func on pick dcnl dcsp dcsp fig canvas mpl connect button press event callback dcnl dcsp pos layout pos copy dcnl dcsp if layout scale dcnl dcsp dcsp pos 2 layout scale dcnl dcsp ch names clean names info ch names dcnl dcsp iter ch x y for x y in enumerate layout names if y in ch names dcnl dcsp if unified dcnl dcsp dcsp if axes is none dcnl dcsp dcsp dcsp under ax plt axes 0 0 1 1 dcnl dcsp dcsp dcsp under ax axis off dcnl dcsp dcsp else dcnl dcsp dcsp dcsp under ax axes dcnl dcsp dcsp under ax set xlim 0 1 ylim 0 1 dcnl dcsp dcsp axs list dcnl dcsp for idx name in iter ch dcnl dcsp dcsp ch idx ch names index name dcnl dcsp dcsp if not unified dcnl dcsp dcsp dcsp ax plt axes posidx dcnl dcsp dcsp dcsp ax patch set facecolor axis facecolor dcnl dcsp dcsp dcsp plt setp list ax spines values color axis spinecolor dcnl dcsp dcsp dcsp ax set xticklabels dcnl dcsp dcsp dcsp ax set yticklabels dcnl dcsp dcsp dcsp plt setp ax get xticklines visible false dcnl dcsp dcsp dcsp plt setp ax get yticklines visible false dcnl dcsp dcsp dcsp ax mne ch name name dcnl dcsp dcsp dcsp ax mne ch idx ch idx dcnl dcsp dcsp dcsp ax mne ax face color axis facecolor dcnl dcsp dcsp dcsp yield ax ch idx dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax bunch ax under ax pos posidx data lines list mne ch name name mne ch idx ch idx mne ax face color axis facecolor dcnl dcsp dcsp dcsp axs append ax dcnl dcsp if unified dcnl dcsp dcsp under ax mne axs axs dcnl dcsp dcsp verts np transpose pos 2 pos 2 + pos 2 1 0 pos 2 + pos 2 pos 2 + pos 2 0 1 1 0 2 dcnl dcsp dcsp if not img dcnl dcsp dcsp dcsp under ax add collection collections polycollection verts facecolor axis facecolor edgecolor axis spinecolor linewidth 1 0 dcnl dcsp dcsp for ax in axs dcnl dcsp dcsp dcsp yield ax ax mne ch idx
def plot topo info times show func click func none layout none vmin none vmax none ylim none colorbar none border none axis facecolor k fig facecolor k cmap rdbu r layout scale none title none x label none y label none font color w unified false img false axes none dcsp import matplotlib pyplot as plt dcnl dcsp if layout kind custom dcnl dcsp dcsp layout deepcopy layout dcnl dcsp dcsp layout pos 2 layout pos 2 min 0 dcnl dcsp dcsp layout pos 2 layout pos 2 max 0 dcnl dcsp tmin tmax times0 1 dcnl dcsp click func show func if click func is none else click func dcnl dcsp on pick partial click func tmin tmin tmax tmax vmin vmin vmax vmax ylim ylim x label x label y label y label colorbar colorbar dcnl dcsp if axes is none dcnl dcsp dcsp fig plt figure dcnl dcsp else dcnl dcsp dcsp fig axes figure dcnl dcsp if colorbar dcnl dcsp dcsp sm plt cm scalarmappable cmap cmap norm plt normalize vmin vmax dcnl dcsp dcsp sm set array np linspace vmin vmax dcnl dcsp dcsp ax plt axes 0 015 0 025 1 05 0 8 dcnl dcsp dcsp set ax facecolor ax fig facecolor dcnl dcsp dcsp cb fig colorbar sm ax ax dcnl dcsp dcsp cb yticks plt getp cb ax axes yticklabels dcnl dcsp dcsp plt setp cb yticks color font color dcnl dcsp dcsp ax axis off dcnl dcsp my topo plot iter topography info layout layout on pick on pick fig fig layout scale layout scale axis spinecolor border axis facecolor axis facecolor fig facecolor fig facecolor unified unified img img axes axes dcnl dcsp for ax ch idx in my topo plot dcnl dcsp dcsp if layout kind vectorviewall and ylim is not none dcnl dcsp dcsp dcsp this type mag 0 grad 1 channel type info ch idx dcnl dcsp dcsp dcsp ylim vthis type if check vlim v else v for v in ylim dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ylim ylim dcnl dcsp dcsp show func ax ch idx tmin tmin tmax tmax vmin vmin vmax vmax ylim ylim dcnl dcsp if title is not none dcnl dcsp dcsp plt figtext 0 03 0 95 title color font color fontsize 15 va top dcnl dcsp return fig
def plot topo onpick event show func dcsp orig ax event inaxes dcnl dcsp if event inaxes is none or not hasattr orig ax mne ch idx and not hasattr orig ax mne axs dcnl dcsp dcsp return dcnl dcsp import matplotlib pyplot as plt dcnl dcsp try dcnl dcsp dcsp if hasattr orig ax mne axs dcnl dcsp dcsp dcsp x y event xdata event ydata dcnl dcsp dcsp dcsp for ax in orig ax mne axs dcnl dcsp dcsp dcsp dcsp if x ax pos0 and y ax pos1 and x < ax pos0 + ax pos2 and y < ax pos1 + ax pos3 dcnl dcsp dcsp dcsp dcsp dcsp orig ax ax dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp return dcnl dcsp dcsp ch idx orig ax mne ch idx dcnl dcsp dcsp face color orig ax mne ax face color dcnl dcsp dcsp fig ax plt subplots 1 dcnl dcsp dcsp plt title orig ax mne ch name dcnl dcsp dcsp set ax facecolor ax face color dcnl dcsp dcsp show func ax ch idx dcnl dcsp except exception as err dcnl dcsp dcsp print err dcnl dcsp dcsp raise
def compute scalings bn xlim ylim dcsp if isinstance ylim0 tuple list np ndarray dcnl dcsp dcsp ylim ylim00 ylim10 dcnl dcsp pos bn pos dcnl dcsp bn x s pos2 xlim1 xlim0 dcnl dcsp bn x t pos0 bn x s xlim0 dcnl dcsp bn y s pos3 ylim1 ylim0 dcnl dcsp bn y t pos1 bn y s ylim0
def check vlim vlim dcsp return not np isscalar vlim and vlim is not none
def imshow tfr ax ch idx tmin tmax vmin vmax onselect ylim none tfr none freq none x label none y label none colorbar false cmap rdbu r true yscale auto dcsp from matplotlib import pyplot as plt ticker dcnl dcsp from matplotlib widgets import rectangleselector dcnl dcsp if yscale not in auto linear log dcnl dcsp dcsp raise valueerror yscale dcsp should dcsp be dcsp either dcsp auto dcsp linear dcsp or dcsp log dcsp got dcsp format yscale dcnl dcsp cmap interactive cmap cmap dcnl dcsp times np linspace tmin tmax num tfrch idx shape1 dcnl dcsp if yscale log and not freq0 0 dcnl dcsp dcsp raise valueerror using dcsp log dcsp scale dcsp for dcsp frequency dcsp axis dcsp requires dcsp all dcsp your dcsp frequencies dcsp to dcsp be dcsp positive dcsp you dcsp cannot dcsp include dcsp the dcsp dc dcsp component dcsp 0 dcsp hz dcsp in dcsp the dcsp tfr dcnl dcsp if len freq < 2 or freq0 0 dcnl dcsp dcsp yscale linear dcnl dcsp elif yscale linear dcnl dcsp dcsp ratio freq1 freq 1 dcnl dcsp if yscale auto dcnl dcsp dcsp if freq0 0 and np allclose ratio ratio0 dcnl dcsp dcsp dcsp yscale log dcnl dcsp dcsp else dcnl dcsp dcsp dcsp yscale linear dcnl dcsp time diff np diff times 2 0 if len times 1 else 0 0005 dcnl dcsp time lims np concatenate times0 time diff0 times 1 + time diff times 1 + time diff 1 dcnl dcsp if yscale linear dcnl dcsp dcsp freq diff np diff freq 2 0 if len freq 1 else 0 5 dcnl dcsp dcsp freq lims np concatenate freq0 freq diff0 freq 1 + freq diff freq 1 + freq diff 1 dcnl dcsp else dcnl dcsp dcsp log freqs np concatenate freq0 ratio0 freq freq 1 ratio0 dcnl dcsp dcsp freq lims np sqrt log freqs 1 log freqs1 dcnl dcsp time mesh freq mesh np meshgrid time lims freq lims dcnl dcsp img ax pcolormesh time mesh freq mesh tfrch idx cmap cmap vmin vmin vmax vmax dcnl dcsp ax set xlim time lims0 time lims 1 dcnl dcsp if ylim is none dcnl dcsp dcsp ylim freq lims0 freq lims 1 dcnl dcsp ax set ylim ylim dcnl dcsp if yscale log dcnl dcsp dcsp ax set yscale log dcnl dcsp dcsp ax get yaxis set major formatter ticker scalarformatter dcnl dcsp ax yaxis set minor formatter ticker nullformatter dcnl dcsp ax yaxis set minor locator ticker nulllocator dcnl dcsp tick vals freqnp unique np linspace 0 len freq 1 12 round astype int dcnl dcsp ax set yticks tick vals dcnl dcsp if x label is not none dcnl dcsp dcsp ax set xlabel x label dcnl dcsp if y label is not none dcnl dcsp dcsp ax set ylabel y label dcnl dcsp if colorbar dcnl dcsp dcsp if isinstance colorbar draggablecolorbar dcnl dcsp dcsp dcsp cbar colorbar cbar dcnl dcsp dcsp else dcnl dcsp dcsp dcsp cbar plt colorbar mappable img dcnl dcsp dcsp if interactive cmap dcnl dcsp dcsp dcsp ax cb draggablecolorbar cbar img dcnl dcsp ax rs rectangleselector ax onselect onselect
def imshow tfr unified bn ch idx tmin tmax vmin vmax onselect ylim none tfr none freq none vline none x label none y label none colorbar false picker true cmap rdbu r title none hline none dcsp compute scalings bn tmin tmax freq0 freq 1 dcnl dcsp ax bn ax dcnl dcsp data lines bn data lines dcnl dcsp extent bn x t + bn x s tmin bn x t + bn x s tmax bn y t + bn y s freq0 bn y t + bn y s freq 1 dcnl dcsp data lines append ax imshow tfrch idx clip on true clip box bn pos extent extent aspect auto origin lower vmin vmin vmax vmax cmap cmap
def plot timeseries ax ch idx tmin tmax vmin vmax ylim data color times vline none x label none y label none colorbar false hline none hvline color w dcsp import matplotlib pyplot as plt dcnl dcsp picker flag false dcnl dcsp for data color in zip data color dcnl dcsp dcsp if not picker flag dcnl dcsp dcsp dcsp ax plot times data ch idx color color picker 1000000000 0 dcnl dcsp dcsp dcsp picker flag true dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax plot times data ch idx color color dcnl dcsp if x label is not none dcnl dcsp dcsp plt xlabel x label dcnl dcsp if y label is not none dcnl dcsp dcsp if isinstance y label list dcnl dcsp dcsp dcsp ax set ylabel y labelch idx dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ax set ylabel y label dcnl dcsp setup ax spines ax vline tmin tmax dcnl dcsp ax figure set facecolor k if hvline color is w else w dcnl dcsp ax spines bottom set color hvline color dcnl dcsp ax spines left set color hvline color dcnl dcsp ax tick params axis x colors hvline color which both dcnl dcsp ax tick params axis y colors hvline color which both dcnl dcsp ax title set color hvline color dcnl dcsp ax xaxis label set color hvline color dcnl dcsp ax yaxis label set color hvline color dcnl dcsp if vline dcnl dcsp dcsp plt axvline vline color hvline color linewidth 1 0 linestyle dcnl dcsp if hline dcnl dcsp dcsp plt axhline hline color hvline color linewidth 1 0 zorder 10 dcnl dcsp if colorbar dcnl dcsp dcsp plt colorbar
def plot timeseries unified bn ch idx tmin tmax vmin vmax ylim data color times vline none x label none y label none colorbar false hline none hvline color w dcsp import matplotlib pyplot as plt dcnl dcsp if not ylim and not any v is none for v in ylim dcnl dcsp dcsp ylim np array np min data np max data dcnl dcsp compute scalings bn tmin tmax ylim dcnl dcsp pos bn pos dcnl dcsp data lines bn data lines dcnl dcsp ax bn ax dcnl dcsp for data color in zip data color dcnl dcsp dcsp data lines append ax plot bn x t + bn x s times bn y t + bn y s data ch idx color color clip on true clip box pos 0 dcnl dcsp if vline dcnl dcsp dcsp vline np array vline bn x s + bn x t dcnl dcsp dcsp ax vlines vline pos1 pos1 + pos3 color hvline color linewidth 0 5 linestyle dcnl dcsp if hline dcnl dcsp dcsp hline np array hline bn y s + bn y t dcnl dcsp dcsp ax hlines hline pos0 pos0 + pos2 color hvline color linewidth 0 5 dcnl dcsp if x label is not none dcnl dcsp dcsp ax text pos0 + pos2 2 0 pos1 x label horizontalalignment center verticalalignment top dcnl dcsp if y label is not none dcnl dcsp dcsp y label y labelch idx if isinstance y label list else y label dcnl dcsp dcsp ax text pos0 pos1 + pos3 2 0 y label horizontalignment right verticalalignment middle rotation 90 dcnl dcsp if colorbar dcnl dcsp dcsp plt colorbar
def erfimage imshow ax ch idx tmin tmax vmin vmax ylim none data none epochs none sigma none order none scalings none vline none x label none y label none colorbar false cmap rdbu r dcsp from scipy import ndimage dcnl dcsp import matplotlib pyplot as plt dcnl dcsp this data data ch idx copy scalingsch idx dcnl dcsp if callable order dcnl dcsp dcsp order order epochs times this data dcnl dcsp if order is not none dcnl dcsp dcsp this data this dataorder dcnl dcsp if sigma 0 0 dcnl dcsp dcsp this data ndimage gaussian filter1d this data sigma sigma axis 0 dcnl dcsp img ax imshow this data extent tmin tmax 0 len data aspect auto origin lower vmin vmin vmax vmax picker true cmap cmap interpolation nearest dcnl dcsp ax plt gca dcnl dcsp if x label is not none dcnl dcsp dcsp ax set xlabel x label dcnl dcsp if y label is not none dcnl dcsp dcsp ax set ylabel y label dcnl dcsp if colorbar dcnl dcsp dcsp plt colorbar mappable img
def erfimage imshow unified bn ch idx tmin tmax vmin vmax ylim none data none epochs none sigma none order none scalings none vline none x label none y label none colorbar false cmap rdbu r dcsp from scipy import ndimage dcnl dcsp compute scalings bn tmin tmax 0 len epochs events dcnl dcsp ax bn ax dcnl dcsp data lines bn data lines dcnl dcsp extent bn x t + bn x s tmin bn x t + bn x s tmax bn y t bn y t + bn y s len epochs events dcnl dcsp this data data ch idx copy scalingsch idx dcnl dcsp if callable order dcnl dcsp dcsp order order epochs times this data dcnl dcsp if order is not none dcnl dcsp dcsp this data this dataorder dcnl dcsp if sigma 0 0 dcnl dcsp dcsp this data ndimage gaussian filter1d this data sigma sigma axis 0 dcnl dcsp data lines append ax imshow this data extent extent aspect auto origin lower vmin vmin vmax vmax picker true cmap cmap interpolation nearest
def plot evoked topo evoked layout none layout scale 0 945 color none border none ylim none scalings none title none proj false vline 0 0 hline 0 0 fig facecolor k fig background none axis facecolor k font color w merge grads false legend true axes none show true dcsp import matplotlib pyplot as plt dcnl dcsp if not type evoked in tuple list dcnl dcsp dcsp evoked evoked dcnl dcsp if type color in tuple list dcnl dcsp dcsp if len color len evoked dcnl dcsp dcsp dcsp raise valueerror lists dcsp of dcsp evoked dcsp objects dcsp and dcsp colors dcsp must dcsp have dcsp the dcsp same dcsp length dcnl dcsp elif color is none dcnl dcsp dcsp colors w + colors dcnl dcsp dcsp stop slice len evoked if len evoked < len colors else slice len colors dcnl dcsp dcsp color cycle colorsstop dcnl dcsp dcsp if len evoked len colors dcnl dcsp dcsp dcsp warn more dcsp evoked dcsp objects dcsp than dcsp colors dcsp available dcsp you dcsp should dcsp pass dcsp a dcsp list dcsp of dcsp unique dcsp colors dcnl dcsp else dcnl dcsp dcsp color cycle color dcnl dcsp times evoked0 times dcnl dcsp if not all e times times all for e in evoked dcnl dcsp dcsp raise valueerror all dcsp evoked times dcsp must dcsp be dcsp the dcsp same dcnl dcsp evoked e copy for e in evoked dcnl dcsp info evoked0 info dcnl dcsp ch names evoked0 ch names dcnl dcsp scalings handle default scalings scalings dcnl dcsp if not all e ch names ch names for e in evoked dcnl dcsp dcsp raise valueerror all dcsp evoked picks dcsp must dcsp be dcsp the dcsp same dcnl dcsp ch names clean names ch names dcnl dcsp if merge grads dcnl dcsp dcsp picks pair grad sensors info topomap coords false dcnl dcsp dcsp chs list dcnl dcsp dcsp for pick in picks 2 dcnl dcsp dcsp dcsp ch info chs pick dcnl dcsp dcsp dcsp ch ch name ch ch name 1 + x dcnl dcsp dcsp dcsp chs append ch dcnl dcsp dcsp info chs chs dcnl dcsp dcsp info bads list dcnl dcsp dcsp info update redundant dcnl dcsp dcsp info check consistency dcnl dcsp dcsp new picks list dcnl dcsp dcsp for e in evoked dcnl dcsp dcsp dcsp data merge grad data e datapicks scalings grad dcnl dcsp dcsp dcsp e data data dcnl dcsp dcsp dcsp new picks append range len data dcnl dcsp dcsp picks new picks dcnl dcsp dcsp types used grad dcnl dcsp dcsp y label rms dcsp amplitude dcsp s handle default units grad dcnl dcsp if layout is none dcnl dcsp dcsp layout find layout info dcnl dcsp if not merge grads dcnl dcsp dcsp chs in layout set layout names set ch names dcnl dcsp dcsp types used set channel type info ch names index ch for ch in chs in layout dcnl dcsp dcsp types used set difference types used set ref meg dcnl dcsp dcsp meg types set mag grad dcnl dcsp dcsp is meg len set intersection types used meg types 0 dcnl dcsp dcsp if is meg dcnl dcsp dcsp dcsp types used list types used 1 dcnl dcsp dcsp dcsp picks pick types info meg kk ref meg false exclude for kk in types used dcnl dcsp dcsp else dcnl dcsp dcsp dcsp types used kwargs dict t true for t in types used dcnl dcsp dcsp dcsp picks pick types info meg false exclude types used kwargs dcnl dcsp dcsp assert isinstance picks list and len types used len picks dcnl dcsp dcsp for e in evoked dcnl dcsp dcsp dcsp for pick ch type in zip picks types used dcnl dcsp dcsp dcsp dcsp e datapick scalingsch type dcnl dcsp dcsp if proj is true and all e proj is not true for e in evoked dcnl dcsp dcsp dcsp evoked e apply proj for e in evoked dcnl dcsp dcsp elif proj interactive dcnl dcsp dcsp dcsp for e in evoked dcnl dcsp dcsp dcsp dcsp check delayed ssp e dcnl dcsp dcsp y label amplitude dcsp s handle default units channel type info ch idx for ch idx in range len chs in layout dcnl dcsp if ylim is none dcnl dcsp dcsp def set ylim x dcnl dcsp dcsp dcsp return np abs x max dcnl dcsp dcsp ylim set ylim e datat for e in evoked for t in picks dcnl dcsp dcsp ymax np array ylim dcnl dcsp dcsp ylim ymax ymax dcnl dcsp elif isinstance ylim dict dcnl dcsp dcsp ylim handle default ylim ylim dcnl dcsp dcsp ylim ylim kk for kk in types used dcnl dcsp dcsp if len ylim 1 dcnl dcsp dcsp dcsp ylim ylim 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ylim zip np array yl for yl in ylim dcnl dcsp else dcnl dcsp dcsp raise typeerror ylim dcsp must dcsp be dcsp none dcsp or dcsp a dcsp dict dcsp got dcsp s type ylim dcnl dcsp data e data for e in evoked dcnl dcsp show func partial plot timeseries unified data data color color times times vline vline hline hline hvline color font color dcnl dcsp click func partial plot timeseries data data color color times times vline vline hline hline hvline color font color dcnl dcsp fig plot topo info info times times show func show func click func click func layout layout colorbar false ylim ylim cmap none layout scale layout scale border border fig facecolor fig facecolor font color font color axis facecolor axis facecolor title title x label time dcsp s y label y label unified true axes axes dcnl dcsp add background image fig fig background dcnl dcsp if legend is not false dcnl dcsp dcsp legend loc 0 if legend is true else legend dcnl dcsp dcsp labels e comment if e comment else unknown for e in evoked dcnl dcsp dcsp legend plt legend labels loc legend loc prop size 10 dcnl dcsp dcsp legend get frame set facecolor axis facecolor dcnl dcsp dcsp txts legend get texts dcnl dcsp dcsp for txt col in zip txts color dcnl dcsp dcsp dcsp txt set color col dcnl dcsp if proj interactive dcnl dcsp dcsp for e in evoked dcnl dcsp dcsp dcsp check delayed ssp e dcnl dcsp dcsp params dict evokeds evoked times times plot update proj callback plot update evoked topo proj projs evoked0 info projs fig fig dcnl dcsp dcsp draw proj checkbox none params dcnl dcsp plt show show dcnl dcsp return fig
def plot update evoked topo proj params bools dcsp evokeds e copy for e in params evokeds dcnl dcsp fig params fig dcnl dcsp projs proj for proj b in zip params projs bools if b dcnl dcsp params proj bools bools dcnl dcsp for e in evokeds dcnl dcsp dcsp e add proj projs remove existing true dcnl dcsp dcsp e apply proj dcnl dcsp for ax in fig axes0 mne axs dcnl dcsp dcsp for line evoked in zip ax data lines evokeds dcnl dcsp dcsp dcsp line set ydata ax y t + ax y s evoked dataax mne ch idx dcnl dcsp fig canvas draw
def plot topo image epochs epochs layout none sigma 0 0 vmin none vmax none colorbar true order none cmap rdbu r layout scale 0 95 title none scalings none border none fig facecolor k fig background none font color w show true dcsp scalings handle default scalings scalings dcnl dcsp data epochs get data dcnl dcsp scale coeffs list dcnl dcsp for idx in range epochs info nchan dcnl dcsp dcsp ch type channel type epochs info idx dcnl dcsp dcsp scale coeffs append scalings get ch type 1 dcnl dcsp vmin vmax setup vmin vmax data vmin vmax dcnl dcsp if layout is none dcnl dcsp dcsp layout find layout epochs info dcnl dcsp show func partial erfimage imshow unified scalings scale coeffs order order data data epochs epochs sigma sigma cmap cmap dcnl dcsp erf imshow partial erfimage imshow scalings scale coeffs order order data data epochs epochs sigma sigma cmap cmap dcnl dcsp fig plot topo info epochs info times epochs times click func erf imshow show func show func layout layout colorbar colorbar vmin vmin vmax vmax cmap cmap layout scale layout scale title title fig facecolor fig facecolor font color font color border border x label time dcsp s y label epoch unified true img true dcnl dcsp add background image fig fig background dcnl dcsp plt show show dcnl dcsp return fig
def ipart x dcsp return np modf x 1
def jcal2jd year month day dcsp year int year dcnl dcsp month int month dcnl dcsp day int day dcnl dcsp jd 367 year dcnl dcsp x ipart month 9 7 0 dcnl dcsp jd ipart 7 year + 5001 + x 4 0 dcnl dcsp jd + ipart 275 month 9 0 dcnl dcsp jd + day dcnl dcsp jd + 1729777 dcnl dcsp return jd
def jd2jcal jd dcsp j jd + 1402 dcnl dcsp k ipart j 1 1461 0 dcnl dcsp l j 1461 0 k dcnl dcsp n ipart l 1 365 0 ipart l 1461 0 dcnl dcsp i l 365 0 n + 30 0 dcnl dcsp j ipart 80 0 i 2447 0 dcnl dcsp day i ipart 2447 0 j 80 0 dcnl dcsp i ipart j 11 0 dcnl dcsp month j + 2 12 0 i dcnl dcsp year 4 k + n + i 4716 0 dcnl dcsp return int year int month int day
def check h5py dcsp try dcnl dcsp dcsp import h5py dcnl dcsp except importerror dcnl dcsp dcsp raise importerror the dcsp h5py dcsp module dcsp is dcsp required dcsp to dcsp use dcsp hdf5 dcsp i o dcnl dcsp return h5py
def create titled group root key title dcsp out root create group key dcnl dcsp out attrs title title dcnl dcsp return out
def create titled dataset root key title data comp kw none dcsp comp kw if comp kw is none else comp kw dcnl dcsp out root create dataset key data data comp kw dcnl dcsp out attrs title title dcnl dcsp return out
def write hdf5 fname data overwrite false compression 4 title h5io slash error dcsp h5py check h5py dcnl dcsp mode w dcnl dcsp if op isfile fname dcnl dcsp dcsp if isinstance overwrite string types dcnl dcsp dcsp dcsp if overwrite update dcnl dcsp dcsp dcsp dcsp raise valueerror overwrite dcsp must dcsp be dcsp update dcsp or dcsp a dcsp bool dcnl dcsp dcsp dcsp mode a dcnl dcsp dcsp elif not overwrite dcnl dcsp dcsp dcsp raise ioerror file dcsp s dcsp exists dcsp use dcsp overwrite true dcsp to dcsp overwrite fname dcnl dcsp if not isinstance title string types dcnl dcsp dcsp raise valueerror title dcsp must dcsp be dcsp a dcsp string dcnl dcsp comp kw dict dcnl dcsp if compression 0 dcnl dcsp dcsp comp kw dict compression gzip compression opts compression dcnl dcsp with h5py file fname mode mode as fid dcnl dcsp dcsp if title in fid dcnl dcsp dcsp dcsp del fidtitle dcnl dcsp dcsp cleanup data dcnl dcsp dcsp triage write title data fid comp kw str type data cleanup data cleanup data slash slash title title dcnl dcsp for data in cleanup data dcnl dcsp dcsp title list data keys 0 dcnl dcsp dcsp if title in pd dataframe pd series dcnl dcsp dcsp dcsp rootname key value datatitle dcnl dcsp dcsp dcsp create pandas dataset fname rootname key title value
def read hdf5 fname title h5io slash ignore dcsp h5py check h5py dcnl dcsp if not op isfile fname dcnl dcsp dcsp raise ioerror file dcsp s dcsp not dcsp found fname dcnl dcsp if not isinstance title string types dcnl dcsp dcsp raise valueerror title dcsp must dcsp be dcsp a dcsp string dcnl dcsp with h5py file fname mode r as fid dcnl dcsp dcsp if title not in fid dcnl dcsp dcsp dcsp raise valueerror no dcsp s dcsp data dcsp found title dcnl dcsp dcsp if isinstance fidtitle h5py group dcnl dcsp dcsp dcsp if title not in fidtitle attrs dcnl dcsp dcsp dcsp dcsp raise valueerror no dcsp s dcsp data dcsp found title dcnl dcsp dcsp data triage read fidtitle slash slash dcnl dcsp return data
def sort keys x dcsp keys list x keys dcnl dcsp idx np argsort str k for k in keys dcnl dcsp keys keysii for ii in idx dcnl dcsp return keys
def object diff a b pre dcsp try dcnl dcsp dcsp from pandas import dataframe series dcnl dcsp except importerror dcnl dcsp dcsp dataframe series type none dcnl dcsp out dcnl dcsp if type a type b dcnl dcsp dcsp out + pre + dcsp type dcsp mismatch dcsp s dcsp s n type a type b dcnl dcsp elif isinstance a dict dcnl dcsp dcsp k1s sort keys a dcnl dcsp dcsp k2s sort keys b dcnl dcsp dcsp m1 set k2s set k1s dcnl dcsp dcsp if len m1 dcnl dcsp dcsp dcsp out + pre + dcsp x1 dcsp missing dcsp keys dcsp s n m1 dcnl dcsp dcsp for key in k1s dcnl dcsp dcsp dcsp if key not in k2s dcnl dcsp dcsp dcsp dcsp out + pre + dcsp x2 dcsp missing dcsp key dcsp s n key dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp out + object diff akey bkey pre + d1 s repr key dcnl dcsp elif isinstance a list tuple dcnl dcsp dcsp if len a len b dcnl dcsp dcsp dcsp out + pre + dcsp length dcsp mismatch dcsp s dcsp s n len a len b dcnl dcsp dcsp else dcnl dcsp dcsp dcsp for xx1 xx2 in zip a b dcnl dcsp dcsp dcsp dcsp out + object diff xx1 xx2 pre dcnl dcsp elif isinstance a string types int float bytes dcnl dcsp dcsp if a b dcnl dcsp dcsp dcsp out + pre + dcsp value dcsp mismatch dcsp s dcsp s n a b dcnl dcsp elif a is none dcnl dcsp dcsp pass dcnl dcsp elif isinstance a np ndarray dcnl dcsp dcsp if not np array equal a b dcnl dcsp dcsp dcsp out + pre + dcsp array dcsp mismatch n dcnl dcsp elif sparse is not none and sparse isspmatrix a dcnl dcsp dcsp if b shape a shape dcnl dcsp dcsp dcsp out + pre + dcsp sparse dcsp matrix dcsp a dcsp and dcsp b dcsp shape dcsp mismatch s dcsp vs dcsp s a shape b shape dcnl dcsp dcsp else dcnl dcsp dcsp dcsp c a b dcnl dcsp dcsp dcsp c eliminate zeros dcnl dcsp dcsp dcsp if c nnz 0 dcnl dcsp dcsp dcsp dcsp out + pre + dcsp sparse dcsp matrix dcsp a dcsp and dcsp b dcsp differ dcsp on dcsp s dcsp elements c nnz dcnl dcsp elif isinstance a dataframe series dcnl dcsp dcsp if b shape a shape dcnl dcsp dcsp dcsp out + pre + dcsp pandas dcsp values dcsp a dcsp and dcsp b dcsp shape dcsp mismatch s dcsp vs dcsp s a shape b shape dcnl dcsp dcsp else dcnl dcsp dcsp dcsp c a values b values dcnl dcsp dcsp dcsp nzeros np sum c 0 dcnl dcsp dcsp dcsp if nzeros 0 dcnl dcsp dcsp dcsp dcsp out + pre + dcsp pandas dcsp values dcsp a dcsp and dcsp b dcsp differ dcsp on dcsp s dcsp elements nzeros dcnl dcsp else dcnl dcsp dcsp raise runtimeerror pre + dcsp unsupported dcsp type dcsp s dcsp s type a a dcnl dcsp return out
def add doc func doc dcsp func doc doc
def import module name dcsp import name dcnl dcsp return sys modulesname
def add move move dcsp setattr moveditems move name move
def remove move name dcsp try dcnl dcsp dcsp delattr moveditems name dcnl dcsp except attributeerror dcnl dcsp dcsp try dcnl dcsp dcsp dcsp del moves dict name dcnl dcsp dcsp except keyerror dcnl dcsp dcsp dcsp raise attributeerror no dcsp such dcsp move dcsp r name
def iterkeys d kw dcsp return iter getattr d iterkeys kw
def itervalues d kw dcsp return iter getattr d itervalues kw
def iteritems d kw dcsp return iter getattr d iteritems kw
def iterlists d kw dcsp return iter getattr d iterlists kw
def with metaclass meta bases dcsp return meta newbase bases
def add metaclass metaclass dcsp def wrapper cls dcnl dcsp dcsp orig vars cls dict copy dcnl dcsp dcsp orig vars pop dict none dcnl dcsp dcsp orig vars pop weakref none dcnl dcsp dcsp for slots var in orig vars get slots dcnl dcsp dcsp dcsp orig vars pop slots var dcnl dcsp dcsp return metaclass cls name cls bases orig vars dcnl dcsp return wrapper
def decorator caller func none dcsp if func is not none dcnl dcsp dcsp evaldict func globals copy dcnl dcsp dcsp evaldict call caller dcnl dcsp dcsp evaldict func func dcnl dcsp dcsp return functionmaker create func return dcsp call func dcsp shortsignature s evaldict undecorated func wrapped func dcnl dcsp else dcnl dcsp dcsp if inspect isclass caller dcnl dcsp dcsp dcsp name caller name lower dcnl dcsp dcsp dcsp callerfunc get init caller dcnl dcsp dcsp dcsp doc decorator s dcsp converts dcsp functions generators dcsp into dcsp factories dcsp of dcsp s dcsp objects caller name caller name dcnl dcsp dcsp dcsp fun getfullargspec callerfunc args1 dcnl dcsp dcsp elif inspect isfunction caller dcnl dcsp dcsp dcsp name lambda if caller name <lambda else caller name dcnl dcsp dcsp dcsp callerfunc caller dcnl dcsp dcsp dcsp doc caller doc dcnl dcsp dcsp dcsp fun getfullargspec callerfunc args0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp name caller class name lower dcnl dcsp dcsp dcsp callerfunc caller call func dcnl dcsp dcsp dcsp doc caller call doc dcnl dcsp dcsp dcsp fun getfullargspec callerfunc args1 dcnl dcsp dcsp evaldict callerfunc globals copy dcnl dcsp dcsp evaldict call caller dcnl dcsp dcsp evaldict decorator decorator dcnl dcsp dcsp return functionmaker create s s name fun return dcsp decorator call dcsp s fun evaldict undecorated caller wrapped caller doc doc module caller module
def call self func dcsp return functionmaker create func with dcsp self dcsp return dcsp func shortsignature s dict self self func func wrapped func
def find position string index last index last pos dcsp lines string count n last index index dcnl dcsp if lines 0 dcnl dcsp dcsp column index string rfind n last index index dcnl dcsp else dcnl dcsp dcsp column last pos1 + index last index dcnl dcsp return last pos0 + lines column
def serialize a dcsp if isinstance a str dcnl dcsp dcsp return 0 a dcnl dcsp if isinstance a numpy ndarray dcnl dcsp dcsp dt a dtype dcnl dcsp dcsp if not dt isnative or dt num < 1 or dt num len datatype dcnl dcsp dcsp dcsp return datatype unknown none dcnl dcsp dcsp ft datatypedt num dcnl dcsp dcsp if ft 1 dcnl dcsp dcsp dcsp return datatype unknown none dcnl dcsp dcsp if a flags c contiguous dcnl dcsp dcsp dcsp return ft str a data dcnl dcsp dcsp ac a copy c dcnl dcsp dcsp return ft str ac data dcnl dcsp if isinstance a int dcnl dcsp dcsp return datatype int32 struct pack i a dcnl dcsp if isinstance a float dcnl dcsp dcsp return datatype float64 struct pack d a dcnl dcsp return datatype unknown none
def signature obj dcsp if not callable obj dcnl dcsp dcsp raise typeerror 0 r dcsp is dcsp not dcsp a dcsp callable dcsp object format obj dcnl dcsp if isinstance obj types methodtype dcnl dcsp dcsp sig signature obj func dcnl dcsp dcsp if obj self is none dcnl dcsp dcsp dcsp if sig parameters dcnl dcsp dcsp dcsp dcsp first sig parameters values 0 replace kind positional only dcnl dcsp dcsp dcsp dcsp return sig replace parameters first + tuple sig parameters values 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp return sig dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return sig replace parameters tuple sig parameters values 1 dcnl dcsp try dcnl dcsp dcsp sig obj signature dcnl dcsp except attributeerror dcnl dcsp dcsp pass dcnl dcsp else dcnl dcsp dcsp if sig is not none dcnl dcsp dcsp dcsp return sig dcnl dcsp try dcnl dcsp dcsp wrapped obj wrapped dcnl dcsp except attributeerror dcnl dcsp dcsp pass dcnl dcsp else dcnl dcsp dcsp return signature wrapped dcnl dcsp if isinstance obj types functiontype dcnl dcsp dcsp return signature from function obj dcnl dcsp if isinstance obj functools partial dcnl dcsp dcsp sig signature obj func dcnl dcsp dcsp new params ordereddict sig parameters items dcnl dcsp dcsp partial args obj args or dcnl dcsp dcsp partial keywords obj keywords or dcnl dcsp dcsp try dcnl dcsp dcsp dcsp ba sig bind partial partial args partial keywords dcnl dcsp dcsp except typeerror as ex dcnl dcsp dcsp dcsp msg partial dcsp object dcsp 0 r dcsp has dcsp incorrect dcsp arguments format obj dcnl dcsp dcsp dcsp raise valueerror msg dcnl dcsp dcsp for arg name arg value in ba arguments items dcnl dcsp dcsp dcsp param new paramsarg name dcnl dcsp dcsp dcsp if arg name in partial keywords dcnl dcsp dcsp dcsp dcsp new paramsarg name param replace default arg value partial kwarg true dcnl dcsp dcsp dcsp elif param kind not in var keyword var positional and not param partial kwarg dcnl dcsp dcsp dcsp dcsp new params pop arg name dcnl dcsp dcsp return sig replace parameters new params values dcnl dcsp sig none dcnl dcsp if isinstance obj type dcnl dcsp dcsp call get user defined method type obj call dcnl dcsp dcsp if call is not none dcnl dcsp dcsp dcsp sig signature call dcnl dcsp dcsp else dcnl dcsp dcsp dcsp new get user defined method obj new dcnl dcsp dcsp dcsp if new is not none dcnl dcsp dcsp dcsp dcsp sig signature new dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp init get user defined method obj init dcnl dcsp dcsp dcsp dcsp if init is not none dcnl dcsp dcsp dcsp dcsp dcsp sig signature init dcnl dcsp elif not isinstance obj nonuserdefinedcallables dcnl dcsp dcsp call get user defined method type obj call im func dcnl dcsp dcsp if call is not none dcnl dcsp dcsp dcsp sig signature call dcnl dcsp if sig is not none dcnl dcsp dcsp return sig replace parameters tuple sig parameters values 1 dcnl dcsp if isinstance obj types builtinfunctiontype dcnl dcsp dcsp msg no dcsp signature dcsp found dcsp for dcsp builtin dcsp function dcsp 0 r format obj dcnl dcsp dcsp raise valueerror msg dcnl dcsp raise valueerror callable dcsp 0 r dcsp is dcsp not dcsp supported dcsp by dcsp signature format obj
testing requires testing data dcnl def test simulate stc dcsp fwd read forward solution meg fname fwd force fixed true dcnl dcsp labels read label op join data path meg sample labels s label label for label in label names dcnl dcsp mylabels dcnl dcsp for i label in enumerate labels dcnl dcsp dcsp new label label vertices label vertices pos label pos values 2 i np ones len label values hemi label hemi comment label comment dcnl dcsp dcsp mylabels append new label dcnl dcsp n times 10 dcnl dcsp tmin 0 dcnl dcsp tstep 0 001 dcnl dcsp stc data np ones len labels n times dcnl dcsp stc simulate stc fwd src mylabels stc data tmin tstep dcnl dcsp assert equal stc subject sample dcnl dcsp for label in labels dcnl dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp hemi idx 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemi idx 1 dcnl dcsp dcsp idx np intersect1d stc verticeshemi idx label vertices dcnl dcsp dcsp idx np searchsorted stc verticeshemi idx idx dcnl dcsp dcsp if hemi idx 1 dcnl dcsp dcsp dcsp idx + len stc vertices0 dcnl dcsp dcsp assert true np all stc dataidx 1 0 dcnl dcsp dcsp assert true stc dataidx shape1 n times dcnl dcsp def fun x dcnl dcsp dcsp return x 2 dcnl dcsp stc simulate stc fwd src mylabels stc data tmin tstep fun dcnl dcsp for i label in enumerate labels dcnl dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp hemi idx 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemi idx 1 dcnl dcsp dcsp idx np intersect1d stc verticeshemi idx label vertices dcnl dcsp dcsp idx np searchsorted stc verticeshemi idx idx dcnl dcsp dcsp if hemi idx 1 dcnl dcsp dcsp dcsp idx + len stc vertices0 dcnl dcsp dcsp res 2 0 i 2 0 np ones len idx n times dcnl dcsp dcsp assert array almost equal stc dataidx res dcnl dcsp label subset mylabels 2 dcnl dcsp data subset stc data 2 dcnl dcsp stc simulate stc fwd src label subset data subset tmin tstep fun dcnl dcsp assert raises valueerror simulate stc fwd src label subset data subset 1 tmin tstep fun dcnl dcsp assert raises runtimeerror simulate stc fwd src label subset 2 np concatenate data subset 2 axis 0 tmin tstep fun
testing requires testing data dcnl def test simulate sparse stc dcsp fwd read forward solution meg fname fwd force fixed true dcnl dcsp labels read label op join data path meg sample labels s label label for label in label names dcnl dcsp n times 10 dcnl dcsp tmin 0 dcnl dcsp tstep 0 001 dcnl dcsp times np arange n times dtype np float tstep + tmin dcnl dcsp assert raises valueerror simulate sparse stc fwd src len labels times labels labels location center subject sample subjects dir subjects dir dcnl dcsp for label in labels dcnl dcsp dcsp label values fill 1 0 dcnl dcsp for location in random center dcnl dcsp dcsp random state 0 if location random else none dcnl dcsp dcsp stc 1 simulate sparse stc fwd src len labels times labels labels random state random state location location subjects dir subjects dir dcnl dcsp dcsp assert equal stc 1 subject sample dcnl dcsp dcsp assert true stc 1 data shape0 len labels dcnl dcsp dcsp assert true stc 1 data shape1 n times dcnl dcsp dcsp stc 2 simulate sparse stc fwd src len labels times labels labels random state random state location location subjects dir subjects dir dcnl dcsp dcsp assert array equal stc 1 lh vertno stc 2 lh vertno dcnl dcsp dcsp assert array equal stc 1 rh vertno stc 2 rh vertno dcnl dcsp assert raises valueerror simulate sparse stc fwd src len labels times labels labels location center subject foo subjects dir subjects dir dcnl dcsp del fwd src 0 subject his id dcnl dcsp assert raises valueerror simulate sparse stc fwd src len labels times labels labels location center subjects dir subjects dir dcnl dcsp assert raises valueerror simulate sparse stc fwd src len labels times labels labels location foo
testing requires testing data dcnl def test generate stc single hemi dcsp fwd read forward solution meg fname fwd force fixed true dcnl dcsp labels single hemi read label op join data path meg sample labels s label label for label in label names single hemi dcnl dcsp mylabels dcnl dcsp for i label in enumerate labels single hemi dcnl dcsp dcsp new label label vertices label vertices pos label pos values 2 i np ones len label values hemi label hemi comment label comment dcnl dcsp dcsp mylabels append new label dcnl dcsp n times 10 dcnl dcsp tmin 0 dcnl dcsp tstep 0 001 dcnl dcsp stc data np ones len labels single hemi n times dcnl dcsp stc simulate stc fwd src mylabels stc data tmin tstep dcnl dcsp for label in labels single hemi dcnl dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp hemi idx 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemi idx 1 dcnl dcsp dcsp idx np intersect1d stc verticeshemi idx label vertices dcnl dcsp dcsp idx np searchsorted stc verticeshemi idx idx dcnl dcsp dcsp if hemi idx 1 dcnl dcsp dcsp dcsp idx + len stc vertices0 dcnl dcsp dcsp assert true np all stc dataidx 1 0 dcnl dcsp dcsp assert true stc dataidx shape1 n times dcnl dcsp def fun x dcnl dcsp dcsp return x 2 dcnl dcsp stc simulate stc fwd src mylabels stc data tmin tstep fun dcnl dcsp for i label in enumerate labels single hemi dcnl dcsp dcsp if label hemi lh dcnl dcsp dcsp dcsp hemi idx 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp hemi idx 1 dcnl dcsp dcsp idx np intersect1d stc verticeshemi idx label vertices dcnl dcsp dcsp idx np searchsorted stc verticeshemi idx idx dcnl dcsp dcsp if hemi idx 1 dcnl dcsp dcsp dcsp idx + len stc vertices0 dcnl dcsp dcsp res 2 0 i 2 0 np ones len idx n times dcnl dcsp dcsp assert array almost equal stc dataidx res
testing requires testing data dcnl def test simulate sparse stc single hemi dcsp fwd read forward solution meg fname fwd force fixed true dcnl dcsp n times 10 dcnl dcsp tmin 0 dcnl dcsp tstep 0 001 dcnl dcsp times np arange n times dtype np float tstep + tmin dcnl dcsp labels single hemi read label op join data path meg sample labels s label label for label in label names single hemi dcnl dcsp stc 1 simulate sparse stc fwd src len labels single hemi times labels labels single hemi random state 0 dcnl dcsp assert true stc 1 data shape0 len labels single hemi dcnl dcsp assert true stc 1 data shape1 n times dcnl dcsp stc 2 simulate sparse stc fwd src len labels single hemi times labels labels single hemi random state 0 dcnl dcsp assert array equal stc 1 lh vertno stc 2 lh vertno dcnl dcsp assert array equal stc 1 rh vertno stc 2 rh vertno
def make stc raw src dcsp seed 42 dcnl dcsp sfreq raw info sfreq dcnl dcsp tstep 1 0 sfreq dcnl dcsp n samples len raw times 10 dcnl dcsp times np arange 0 n samples tstep dcnl dcsp stc simulate sparse stc src 10 times random state seed dcnl dcsp return stc
def get data dcsp raw read raw fif raw fname crop 0 0 5 0 load data dcnl dcsp data picks pick types raw info meg true eeg true dcnl dcsp other picks pick types raw info meg false stim true eog true dcnl dcsp picks np sort np concatenate data picks 16 other picks dcnl dcsp raw raw pick channels raw ch namesp for p in picks dcnl dcsp raw info normalize proj dcnl dcsp ecg rawarray np zeros 1 len raw times create info ecg dcsp 063 raw info sfreq ecg dcnl dcsp for key in dev head t buffer size sec highpass lowpass dig dcnl dcsp dcsp ecg infokey raw infokey dcnl dcsp raw add channels ecg dcnl dcsp src read source spaces src fname dcnl dcsp trans read trans trans fname dcnl dcsp sphere make sphere model auto auto raw info dcnl dcsp stc make stc raw src dcnl dcsp return raw src stc trans sphere
testing requires testing data dcnl def test simulate raw sphere dcsp seed 42 dcnl dcsp raw src stc trans sphere get data dcnl dcsp assert true len pick types raw info meg false ecg true 1 dcnl dcsp head pos sim dict dcnl dcsp shifts 0 001 0 0 0 001 0 001 0 001 0 0 dcnl dcsp for time key shift in enumerate shifts dcnl dcsp dcsp temp trans deepcopy raw info dev head t dcnl dcsp dcsp temp trans trans 3 3 + shift dcnl dcsp dcsp head pos sim time key + 1 0 temp trans trans dcnl dcsp raw sim simulate raw raw stc trans src sphere read cov cov fname head pos head pos sim blink true ecg true random state seed dcnl dcsp raw sim 2 simulate raw raw stc trans fname src fname sphere cov fname head pos head pos sim blink true ecg true random state seed dcnl dcsp assert array equal raw sim 2 0 raw sim 0 dcnl dcsp tempdir tempdir dcnl dcsp test outname op join tempdir sim test raw fif dcnl dcsp raw sim save test outname dcnl dcsp raw sim loaded read raw fif test outname preload true dcnl dcsp assert allclose raw sim loaded 0 raw sim 0 rtol 1e06 atol 1e20 dcnl dcsp del raw sim raw sim 2 dcnl dcsp for ecg eog in true false false true true true dcnl dcsp dcsp raw sim 3 simulate raw raw stc trans src sphere cov none head pos head pos sim blink eog ecg ecg random state seed dcnl dcsp dcsp raw sim 4 simulate raw raw stc trans src sphere cov none head pos head pos sim blink false ecg false random state seed dcnl dcsp dcsp picks np arange len raw ch names dcnl dcsp dcsp diff picks pick types raw info meg false ecg ecg eog eog dcnl dcsp dcsp these picks np setdiff1d picks diff picks dcnl dcsp dcsp close np isclose raw sim 3these picks0 raw sim 4these picks0 atol 1e20 dcnl dcsp dcsp assert true np mean close 0 7 dcnl dcsp dcsp far ~ np isclose raw sim 3diff picks0 raw sim 4diff picks0 atol 1e20 dcnl dcsp dcsp assert true np mean far 0 99 dcnl dcsp del raw sim 3 raw sim 4 dcnl dcsp raw sim meg simulate raw raw copy pick types meg true eeg false stc trans src sphere cov none ecg true blink true random state seed dcnl dcsp raw sim eeg simulate raw raw copy pick types meg false eeg true stc trans src sphere cov none ecg true blink true random state seed dcnl dcsp raw sim meeg simulate raw raw copy pick types meg true eeg true stc trans src sphere cov none ecg true blink true random state seed dcnl dcsp assert allclose np concatenate raw sim meg 0 raw sim eeg 0 raw sim meeg 0 rtol 1e07 atol 1e20 dcnl dcsp del raw sim meg raw sim eeg raw sim meeg dcnl dcsp raw sim simulate raw raw stc trans src sphere cov none head pos head pos sim interp linear dcnl dcsp raw sim hann simulate raw raw stc trans src sphere cov none head pos head pos sim interp hann dcnl dcsp assert allclose raw sim 0 raw sim hann 0 rtol 0 1 atol 1e14 dcnl dcsp del raw sim raw sim hann dcnl dcsp head pos sim err deepcopy head pos sim dcnl dcsp head pos sim err1 0 2 3 0 1 dcnl dcsp assert raises runtimeerror simulate raw raw stc trans src sphere ecg false blink false head pos head pos sim err dcnl dcsp assert raises runtimeerror simulate raw raw stc trans src bem fname ecg false blink false head pos head pos sim err dcnl dcsp assert raises typeerror simulate raw foo stc trans src sphere dcnl dcsp assert raises typeerror simulate raw raw foo trans src sphere dcnl dcsp assert raises valueerror simulate raw raw stc copy crop 0 0 trans src sphere dcnl dcsp stc bad stc copy dcnl dcsp stc bad tstep + 0 1 dcnl dcsp assert raises valueerror simulate raw raw stc bad trans src sphere dcnl dcsp assert raises runtimeerror simulate raw raw stc trans src sphere chpi true dcnl dcsp assert raises valueerror simulate raw raw stc trans src sphere interp foo dcnl dcsp assert raises typeerror simulate raw raw stc trans src sphere head pos 1 0 dcnl dcsp assert raises runtimeerror simulate raw raw stc trans src sphere head pos pos fname dcnl dcsp head pos sim err deepcopy head pos sim dcnl dcsp head pos sim err 1 0 head pos sim err1 0 dcnl dcsp assert raises runtimeerror simulate raw raw stc trans src sphere head pos head pos sim err dcnl dcsp raw bad raw copy dcnl dcsp raw bad info dig none dcnl dcsp assert raises runtimeerror simulate raw raw bad stc trans src sphere blink true
slow test dcnl testing requires testing data dcnl def test simulate raw bem dcsp raw src stc trans sphere get data dcnl dcsp src setup source space sample oct1 subjects dir subjects dir dcnl dcsp for s in src dcnl dcsp dcsp s nuse 3 dcnl dcsp dcsp s vertno src1 vertno 3 dcnl dcsp dcsp s inuse fill 0 dcnl dcsp dcsp s inuse s vertno 1 dcnl dcsp vertices s vertno for s in src dcnl dcsp stc sourceestimate np eye sum len v for v in vertices vertices 0 1 0 raw info sfreq dcnl dcsp raw sim sph simulate raw raw stc trans src sphere cov none dcnl dcsp raw sim bem simulate raw raw stc trans src bem fname cov none n jobs 2 dcnl dcsp assert array equal raw sim sph ch names raw sim bem ch names dcnl dcsp picks pick types raw info meg true eeg true dcnl dcsp n ch len picks dcnl dcsp corr np corrcoef raw sim sphpicks0 raw sim bempicks0 dcnl dcsp assert array equal corr shape 2 n ch 2 n ch dcnl dcsp med corr np median np diag corr n ch n ch dcnl dcsp assert true med corr 0 65 msg med corr dcnl dcsp for s in src dcnl dcsp dcsp transform surface to s head trans dcnl dcsp locs np concatenate s rr s vertno for s in src dcnl dcsp tmax len locs 1 raw info sfreq dcnl dcsp cov make ad hoc cov raw info dcnl dcsp for use raw bem tol in raw sim sph sphere 1 raw sim bem bem fname 31 dcnl dcsp dcsp events find events use raw sti dcsp 014 dcnl dcsp dcsp assert equal len locs 6 dcnl dcsp dcsp evoked epochs use raw events 1 0 tmax baseline none average dcnl dcsp dcsp assert equal len evoked times len locs dcnl dcsp dcsp fits fit dipole evoked cov bem trans min dist 1 0 0 pos dcnl dcsp dcsp diffs np sqrt np sum locs fits 2 axis 1 1000 dcnl dcsp dcsp med diff np median diffs dcnl dcsp dcsp assert true med diff < tol msg s dcsp s bem med diff
slow test dcnl testing requires testing data dcnl def test simulate raw chpi dcsp raw read raw fif raw chpi fname allow maxshield yes dcnl dcsp picks np arange len raw ch names dcnl dcsp picks np setdiff1d picks pick types raw info meg true eeg true 4 dcnl dcsp raw load data pick channels raw ch namespick for pick in picks dcnl dcsp raw info normalize proj dcnl dcsp sphere make sphere model auto auto raw info dcnl dcsp sphere vol tuple sphere r0 1000 0 + sphere radius 1000 0 dcnl dcsp src setup volume source space sample sphere sphere vol pos 70 0 dcnl dcsp stc make stc raw src dcnl dcsp raw sim simulate raw raw stc none src sphere cov none chpi false interp zero dcnl dcsp raw chpi simulate raw raw stc none src sphere cov none chpi true head pos pos fname interp zero dcnl dcsp hpi freqs hpi pick hpi ons get hpi info raw info dcnl dcsp assert allclose raw simhpi pick0 0 0 dcnl dcsp assert allclose raw chpihpi pick0 hpi ons sum dcnl dcsp picks meg pick types raw info meg true eeg false dcnl dcsp picks eeg pick types raw info meg false eeg true dcnl dcsp for picks in picks meg 3 picks eeg 3 dcnl dcsp dcsp psd sim freqs sim psd welch raw sim picks picks dcnl dcsp dcsp psd chpi freqs chpi psd welch raw chpi picks picks dcnl dcsp dcsp assert array equal freqs sim freqs chpi dcnl dcsp dcsp freq idx np sort np argmin np abs freqs sim f for f in hpi freqs dcnl dcsp dcsp if picks is picks meg dcnl dcsp dcsp dcsp assert true psd chpi freq idx 100 psd sim freq idx all dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert allclose psd sim psd chpi atol 1e20 dcnl dcsp quats sim calculate chpi positions raw chpi t step min 10 0 dcnl dcsp quats read head pos pos fname dcnl dcsp assert quats quats quats sim dist tol 0 005 angle tol 3 5
testing requires testing data dcnl def test simulate evoked dcsp raw read raw fif raw fname dcnl dcsp fwd read forward solution fwd fname force fixed true dcnl dcsp fwd pick types forward fwd meg true eeg true exclude raw info bads dcnl dcsp cov read cov cov fname dcnl dcsp evoked template read evokeds ave fname condition 0 baseline none dcnl dcsp evoked template pick types meg true eeg true exclude raw info bads dcnl dcsp cov regularize cov evoked template info dcnl dcsp nave evoked template nave dcnl dcsp tmin 0 1 dcnl dcsp sfreq 1000 0 dcnl dcsp tstep 1 0 sfreq dcnl dcsp n samples 600 dcnl dcsp times np linspace tmin tmin + n samples tstep n samples dcnl dcsp stc simulate sparse stc fwd src n dipoles 2 times times random state 42 dcnl dcsp iir filter 1 0 9 dcnl dcsp evoked simulate evoked fwd stc evoked template info cov iir filter iir filter nave nave dcnl dcsp assert array almost equal evoked times stc times dcnl dcsp assert true len evoked data len fwd sol data dcnl dcsp assert equal evoked nave nave dcnl dcsp stc bad stc copy dcnl dcsp mv np max fwd src 0 vertno fwd src 0 inuse dcnl dcsp stc bad vertices00 mv + 1 dcnl dcsp assert raises runtimeerror simulate evoked fwd stc bad evoked template info cov dcnl dcsp evoked 1 simulate evoked fwd stc evoked template info cov nave np inf dcnl dcsp evoked 2 simulate evoked fwd stc evoked template info cov nave np inf dcnl dcsp assert array equal evoked 1 data evoked 2 data dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp evoked simulate evoked fwd stc evoked template info cov snr 6 random state 42 dcnl dcsp assert allclose np linalg norm evoked data ord fro 0 0007834682022650272 dcnl dcsp cov names cov ch names 2 dcnl dcsp assert raises valueerror simulate evoked fwd stc evoked template info cov nave nave iir filter none
testing requires testing data dcnl def test metrics dcsp src read source spaces src fname dcnl dcsp times np arange 600 1000 0 dcnl dcsp rng np random randomstate 42 dcnl dcsp stc1 simulate sparse stc src n dipoles 2 times times random state rng dcnl dcsp stc2 simulate sparse stc src n dipoles 2 times times random state rng dcnl dcsp e1 rms source estimate quantification stc1 stc1 metric rms dcnl dcsp e2 rms source estimate quantification stc2 stc2 metric rms dcnl dcsp e1 cos source estimate quantification stc1 stc1 metric cosine dcnl dcsp e2 cos source estimate quantification stc2 stc2 metric cosine dcnl dcsp assert true e1 rms 0 0 dcnl dcsp assert true e2 rms 0 0 dcnl dcsp assert almost equal e1 cos 0 0 dcnl dcsp assert almost equal e2 cos 0 0 dcnl dcsp stc bad stc2 copy crop 0 0 5 dcnl dcsp assert raises valueerror source estimate quantification stc1 stc bad dcnl dcsp stc bad stc2 copy dcnl dcsp stc bad tmin 0 1 dcnl dcsp assert raises valueerror source estimate quantification stc1 stc bad dcnl dcsp assert raises valueerror source estimate quantification stc1 stc2 metric foo
def check stc stc1 stc2 dcsp if stc1 data shape stc2 data shape dcnl dcsp dcsp raise valueerror data dcsp in dcsp stcs dcsp must dcsp have dcsp the dcsp same dcsp size dcnl dcsp if np all stc1 times stc2 times dcnl dcsp dcsp raise valueerror times dcsp of dcsp two dcsp stcs dcsp must dcsp match
def source estimate quantification stc1 stc2 metric rms dcsp known metrics rms cosine dcnl dcsp if metric not in known metrics dcnl dcsp dcsp raise valueerror metric dcsp must dcsp be dcsp a dcsp str dcsp from dcsp the dcsp known dcsp metrics dcsp rms dcsp or dcsp cosine dcnl dcsp check stc stc1 stc2 dcnl dcsp data1 data2 stc1 data stc2 data dcnl dcsp if metric rms dcnl dcsp dcsp score np sqrt np mean data1 data2 2 dcnl dcsp elif metric cosine dcnl dcsp dcsp score 1 0 np dot data1 flatten data2 flatten norm data1 norm data2 dcnl dcsp return score
def log ch start info ch dcsp if ch is not none dcnl dcsp dcsp extra just ch dcsp stored dcsp on dcsp channel 50 info ch names ch dcnl dcsp else dcnl dcsp dcsp extra just ch dcsp not dcsp stored 0 dcnl dcsp logger info start + extra ljust just + ch
verbose dcnl def simulate evoked fwd stc info cov nave 30 tmin none tmax none iir filter none random state none verbose none snr none dcsp if snr is not none dcnl dcsp dcsp warn snr dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp 0 16 dcsp set dcsp it dcsp to dcsp none dcsp to dcsp remove dcsp this dcsp warning dcsp set dcsp nave dcsp parameter dcsp instead deprecationwarning dcnl dcsp if tmin is not none dcnl dcsp dcsp warn tmin dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp 0 16 dcsp set dcsp it dcsp to dcsp none dcsp to dcsp remove dcsp this dcsp warning deprecationwarning dcnl dcsp if tmax is not none dcnl dcsp dcsp warn tmax dcsp is dcsp deprecated dcsp and dcsp will dcsp be dcsp removed dcsp in dcsp 0 16 dcsp set dcsp it dcsp to dcsp none dcsp to dcsp remove dcsp this dcsp warning deprecationwarning dcnl dcsp evoked apply forward fwd stc info dcnl dcsp if nave < np inf dcnl dcsp dcsp noise simulate noise evoked evoked cov iir filter random state dcnl dcsp dcsp if snr np inf dcnl dcsp dcsp dcsp nave snr dcnl dcsp dcsp elif snr is not none dcnl dcsp dcsp dcsp tmask time mask evoked times tmin tmax sfreq evoked info sfreq dcnl dcsp dcsp dcsp tmp 10 np log10 np mean evoked data tmask 2 np mean noise data 2 dcnl dcsp dcsp dcsp nave 1 0 10 tmp float snr 10 dcnl dcsp dcsp evoked data + noise data math sqrt nave dcnl dcsp dcsp evoked nave np int nave dcnl dcsp return evoked
def simulate noise evoked evoked cov iir filter none random state none dcsp noise evoked copy dcnl dcsp noise data generate noise evoked info cov iir filter random state evoked data shape1 0 dcnl dcsp return noise
def generate noise info cov iir filter random state n samples zi none dcsp from scipy signal import lfilter dcnl dcsp noise cov pick channels cov cov include info ch names exclude dcnl dcsp if set info ch names set noise cov ch names dcnl dcsp dcsp raise valueerror evoked dcsp and dcsp covariance dcsp channel dcsp names dcsp are dcsp not dcsp identical dcsp cannot dcsp generate dcsp the dcsp noise dcsp matrix dcsp channels dcsp missing dcsp in dcsp covariance dcsp s np setdiff1d info ch names noise cov ch names dcnl dcsp rng check random state random state dcnl dcsp c np diag noise cov data if noise cov diag else noise cov data dcnl dcsp mu channels np zeros len c dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp noise rng multivariate normal mu channels c n samples t dcnl dcsp if iir filter is not none dcnl dcsp dcsp if zi is none dcnl dcsp dcsp dcsp zi np zeros len c len iir filter 1 dcnl dcsp dcsp noise zf lfilter 1 iir filter noise axis 1 zi zi dcnl dcsp else dcnl dcsp dcsp zf none dcnl dcsp return noise zf
deprecated add noise evoked dcsp will dcsp be dcsp deprecated dcsp and dcsp removed dcsp in dcsp 0 16 dcnl def add noise evoked evoked noise snr tmin none tmax none dcsp evoked copy deepcopy evoked dcnl dcsp tmask time mask evoked times tmin tmax sfreq evoked info sfreq dcnl dcsp tmp 10 np log10 np mean evoked data tmask 2 np mean noise data 2 dcnl dcsp noise data 10 tmp float snr 20 noise data dcnl dcsp evoked data + noise data dcnl dcsp return evoked
def select source in label src label random state none location random subject none subjects dir none surf sphere dcsp lh vertno list dcnl dcsp rh vertno list dcnl dcsp if not isinstance location string types or location not in random center dcnl dcsp dcsp raise valueerror location dcsp must dcsp be dcsp random dcsp or dcsp center dcsp got dcsp s location dcnl dcsp rng check random state random state dcnl dcsp if label hemi lh dcnl dcsp dcsp vertno lh vertno dcnl dcsp dcsp hemi idx 0 dcnl dcsp else dcnl dcsp dcsp vertno rh vertno dcnl dcsp dcsp hemi idx 1 dcnl dcsp src sel np intersect1d srchemi idx vertno label vertices dcnl dcsp if location random dcnl dcsp dcsp idx src selrng randint 0 len src sel 1 0 dcnl dcsp else dcnl dcsp dcsp idx label center of mass subject restrict vertices src sel subjects dir subjects dir surf surf dcnl dcsp vertno append idx dcnl dcsp return lh vertno rh vertno
def simulate sparse stc src n dipoles times data fun lambda t 1e07 np sin 20 np pi t labels none random state none location random subject none subjects dir none surf sphere dcsp rng check random state random state dcnl dcsp src ensure src src verbose false dcnl dcsp subject src src0 get subject his id dcnl dcsp if subject is none dcnl dcsp dcsp subject subject src dcnl dcsp elif subject src is not none and subject subject src dcnl dcsp dcsp raise valueerror subject dcsp argument dcsp s dcsp did dcsp not dcsp match dcsp the dcsp source dcsp space dcsp subject his id dcsp s subject subject src dcnl dcsp data np zeros n dipoles len times dcnl dcsp for i dip in range n dipoles dcnl dcsp dcsp datai dip data fun times dcnl dcsp if labels is none dcnl dcsp dcsp offsets np linspace 0 n dipoles len src + 1 astype int dcnl dcsp dcsp n dipoles ss np diff offsets dcnl dcsp dcsp vs s vertno np sort rng permutation np arange s nuse n for n s in zip n dipoles ss src dcnl dcsp dcsp datas data dcnl dcsp else dcnl dcsp dcsp if n dipoles len labels dcnl dcsp dcsp dcsp warn the dcsp number dcsp of dcsp labels dcsp is dcsp different dcsp from dcsp the dcsp number dcsp of dcsp dipoles dcsp s dcsp dipole s dcsp will dcsp be dcsp generated min n dipoles len labels dcnl dcsp dcsp labels labels n dipoles if n dipoles < len labels else labels dcnl dcsp dcsp vertno dcnl dcsp dcsp lh data np empty 0 data shape1 dcnl dcsp dcsp rh data np empty 0 data shape1 dcnl dcsp dcsp for i label in enumerate labels dcnl dcsp dcsp dcsp lh vertno rh vertno select source in label src label rng location subject subjects dir surf dcnl dcsp dcsp dcsp vertno0 + lh vertno dcnl dcsp dcsp dcsp vertno1 + rh vertno dcnl dcsp dcsp dcsp if len lh vertno 0 dcnl dcsp dcsp dcsp dcsp lh data append datainp newaxis dcnl dcsp dcsp dcsp elif len rh vertno 0 dcnl dcsp dcsp dcsp dcsp rh data append datainp newaxis dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise valueerror no dcsp vertno dcsp found dcnl dcsp dcsp vs np array v for v in vertno dcnl dcsp dcsp datas np concatenate d for d in lh data rh data dcnl dcsp dcsp for ii in range 2 dcnl dcsp dcsp dcsp order np argsort vsii dcnl dcsp dcsp dcsp vsii vsiiorder dcnl dcsp dcsp dcsp if len order 0 dcnl dcsp dcsp dcsp dcsp datasii datasiiorder dcnl dcsp dcsp datas np concatenate datas dcnl dcsp tmin tstep times0 np diff times 2 0 dcnl dcsp assert datas shape data shape dcnl dcsp cls sourceestimate if len vs 2 else volsourceestimate dcnl dcsp stc cls datas vertices vs tmin tmin tstep tstep subject subject dcnl dcsp return stc
def simulate stc src labels stc data tmin tstep value fun none dcsp if len labels len stc data dcnl dcsp dcsp raise valueerror labels dcsp and dcsp stc data dcsp must dcsp have dcsp the dcsp same dcsp length dcnl dcsp vertno dcnl dcsp stc data extended dcnl dcsp hemi to ind lh 0 rh 1 dcnl dcsp for i label in enumerate labels dcnl dcsp dcsp hemi ind hemi to indlabel hemi dcnl dcsp dcsp src sel np intersect1d srchemi ind vertno label vertices dcnl dcsp dcsp if value fun is not none dcnl dcsp dcsp dcsp idx sel np searchsorted label vertices src sel dcnl dcsp dcsp dcsp values sel np array value fun v for v in label valuesidx sel dcnl dcsp dcsp dcsp data np outer values sel stc datai dcnl dcsp dcsp else dcnl dcsp dcsp dcsp data np tile stc datai len src sel 1 dcnl dcsp dcsp vertnohemi ind append src sel dcnl dcsp dcsp stc data extendedhemi ind append np atleast 2d data dcnl dcsp for idx in 0 1 dcnl dcsp dcsp if len vertnoidx 1 dcnl dcsp dcsp dcsp vertnoidx np concatenate vertnoidx dcnl dcsp dcsp elif len vertnoidx 1 dcnl dcsp dcsp dcsp vertnoidx vertnoidx0 dcnl dcsp vertno np array v for v in vertno dcnl dcsp for v hemi in zip vertno left right dcnl dcsp dcsp d len v len np unique v dcnl dcsp dcsp if d 0 dcnl dcsp dcsp dcsp raise runtimeerror labels dcsp had dcsp s dcsp overlaps dcsp in dcsp the dcsp s dcsp hemisphere dcsp they dcsp must dcsp be dcsp nonoverlapping d hemi dcnl dcsp data list dcnl dcsp if len vertno0 0 dcnl dcsp dcsp idx np argsort vertno0 dcnl dcsp dcsp vertno0 vertno0idx dcnl dcsp dcsp data append np concatenate stc data extended0 idx dcnl dcsp if len vertno1 0 dcnl dcsp dcsp idx np argsort vertno1 dcnl dcsp dcsp vertno1 vertno1idx dcnl dcsp dcsp data append np concatenate stc data extended1 idx dcnl dcsp data np concatenate data dcnl dcsp subject src0 get subject his id dcnl dcsp stc sourceestimate data vertices vertno tmin tmin tstep tstep subject subject dcnl dcsp return stc
def get tslice epochs tmin tmax dcsp mask time mask epochs times tmin tmax sfreq epochs info sfreq dcnl dcsp tstart np where mask 00 if tmin is not none else none dcnl dcsp tend np where mask 0 1 + 1 if tmax is not none else none dcnl dcsp tslice slice tstart tend none dcnl dcsp return tslice
verbose dcnl def read cov fname verbose none dcsp check fname fname covariance cov fif cov fif gz dcnl dcsp f tree fiff open fname 2 dcnl dcsp with f as fid dcnl dcsp dcsp return covariance read cov fid tree fiff fiffv mne noise cov limited true
verbose dcnl def make ad hoc cov info verbose none dcsp picks pick types info meg true eeg true exclude dcnl dcsp grad std 5e13 dcnl dcsp mag std 2e14 dcnl dcsp eeg std 2e07 dcnl dcsp logger info using dcsp standard dcsp noise dcsp values dcsp meg dcsp grad dcsp dcsp 6 1f dcsp ft cm dcsp meg dcsp mag dcsp dcsp 6 1f dcsp ft dcsp eeg dcsp dcsp 6 1f dcsp uv 10000000000000 0 grad std 1000000000000000 0 mag std 1000000 0 eeg std dcnl dcsp data np zeros len picks dcnl dcsp for meg eeg val in zip grad mag false false false true grad std mag std eeg std dcnl dcsp dcsp these picks pick types info meg meg eeg eeg dcnl dcsp dcsp datanp searchsorted picks these picks val val dcnl dcsp ch names info ch names pick for pick in picks dcnl dcsp return covariance data ch names info bads info projs nfree 0
def check n samples n samples n chan dcsp n samples min 10 n chan + 1 2 dcnl dcsp if n samples < 0 dcnl dcsp dcsp raise valueerror no dcsp samples dcsp found dcsp to dcsp compute dcsp the dcsp covariance dcsp matrix dcnl dcsp if n samples < n samples min dcnl dcsp dcsp warn too dcsp few dcsp samples dcsp required dcsp dcsp d dcsp got dcsp dcsp d dcsp covariance dcsp estimate dcsp may dcsp be dcsp unreliable n samples min n samples
verbose dcnl def compute raw covariance raw tmin 0 tmax none tstep 0 2 reject none flat none picks none method empirical method params none cv 3 scalings none n jobs 1 return estimators false reject by annotation true verbose none dcsp tmin 0 0 if tmin is none else float tmin dcnl dcsp tmax raw times 1 if tmax is none else float tmax dcnl dcsp tstep tmax tmin if tstep is none else float tstep dcnl dcsp tstep m1 tstep 1 0 raw info sfreq dcnl dcsp events make fixed length events raw 1 tmin tmax tstep dcnl dcsp logger info using dcsp up dcsp to dcsp s dcsp segment s len events pl events dcnl dcsp if picks is none dcnl dcsp dcsp picks np arange raw info nchan dcnl dcsp dcsp pick mask np in1d picks pick data channels raw info with ref meg false dcnl dcsp else dcnl dcsp dcsp pick mask slice none dcnl dcsp epochs epochs raw events 1 0 tstep m1 baseline none picks picks reject reject flat flat verbose false preload false proj false reject by annotation reject by annotation dcnl dcsp if method is none dcnl dcsp dcsp method empirical dcnl dcsp if isinstance method string types and method empirical dcnl dcsp dcsp picks pickspick mask dcnl dcsp dcsp data 0 dcnl dcsp dcsp n samples 0 dcnl dcsp dcsp mu 0 dcnl dcsp dcsp for raw segment in epochs dcnl dcsp dcsp dcsp raw segment raw segmentpick mask dcnl dcsp dcsp dcsp mu + raw segment sum axis 1 dcnl dcsp dcsp dcsp data + np dot raw segment raw segment t dcnl dcsp dcsp dcsp n samples + raw segment shape1 dcnl dcsp dcsp check n samples n samples len picks dcnl dcsp dcsp data mu none munone n samples dcnl dcsp dcsp data n samples 1 0 dcnl dcsp dcsp logger info number dcsp of dcsp samples dcsp used dcsp dcsp d n samples dcnl dcsp dcsp logger info done dcnl dcsp dcsp ch names raw info ch names k for k in picks dcnl dcsp dcsp bads b for b in raw info bads if b in ch names dcnl dcsp dcsp return covariance data ch names bads raw info projs nfree n samples dcnl dcsp del picks pick mask dcnl dcsp epochs load data dcnl dcsp ch means epochs data mean axis 0 mean axis 1 dcnl dcsp epochs data ch meansnp newaxis np newaxis dcnl dcsp epochs baseline none none dcnl dcsp return compute covariance epochs keep sample mean true method method method params method params cv cv scalings scalings n jobs n jobs return estimators return estimators
verbose dcnl def compute covariance epochs keep sample mean true tmin none tmax none projs none method empirical method params none cv 3 scalings none n jobs 1 return estimators false on mismatch raise verbose none dcsp accepted methods auto empirical diagonal fixed ledoit wolf shrunk pca factor analysis dcnl dcsp msg invalid dcsp method dcsp method dcsp accepted dcsp values dcsp individually dcsp or dcsp in dcsp a dcsp list dcsp are dcsp s dcsp or dcsp none dcsp or dcsp join accepted methods dcnl dcsp scalings check scalings user scalings dcnl dcsp method params empirical store precision false assume centered true diagonal fixed grad 0 01 mag 0 01 eeg 0 0 store precision false assume centered true ledoit wolf store precision false assume centered true shrunk shrinkage np logspace 4 0 30 store precision false assume centered true pca iter n components none factor analysis iter n components none dcnl dcsp if isinstance method params dict dcnl dcsp dcsp for key values in method params items dcnl dcsp dcsp dcsp if key not in method params dcnl dcsp dcsp dcsp dcsp raise valueerror key dcsp s dcsp must dcsp be dcsp s key dcsp or dcsp join method params dcnl dcsp dcsp dcsp method paramskey update method paramskey dcnl dcsp def unpack epochs epochs dcnl dcsp dcsp if len epochs event id 1 dcnl dcsp dcsp dcsp epochs epochsk for k in epochs event id dcnl dcsp dcsp else dcnl dcsp dcsp dcsp epochs epochs dcnl dcsp dcsp return epochs dcnl dcsp if not isinstance epochs list dcnl dcsp dcsp epochs unpack epochs epochs dcnl dcsp else dcnl dcsp dcsp epochs sum unpack epochs epoch for epoch in epochs dcnl dcsp if any epochs t baseline is none and epochs t info highpass < 0 5 and keep sample mean for epochs t in epochs dcnl dcsp dcsp warn epochs dcsp are dcsp not dcsp baseline dcsp corrected dcsp covariance dcsp matrix dcsp may dcsp be dcsp inaccurate dcnl dcsp orig epochs0 info dev head t dcnl dcsp if not isinstance on mismatch string types or on mismatch not in raise warn ignore dcnl dcsp dcsp raise valueerror on mismatch dcsp must dcsp be dcsp raise dcsp warn dcsp or dcsp ignore dcsp got dcsp s on mismatch dcnl dcsp for ei epoch in enumerate epochs dcnl dcsp dcsp epoch info check consistency dcnl dcsp dcsp if orig is none epoch info dev head t is none or orig is not none and not np allclose orig trans epoch info dev head t trans dcnl dcsp dcsp dcsp msg meg< head dcsp transform dcsp mismatch dcsp between dcsp epochs0 n s n nand dcsp epochs s n s orig ei epoch info dev head t dcnl dcsp dcsp dcsp if on mismatch raise dcnl dcsp dcsp dcsp dcsp raise valueerror msg dcnl dcsp dcsp dcsp elif on mismatch warn dcnl dcsp dcsp dcsp dcsp warn msg dcnl dcsp bads epochs0 info bads dcnl dcsp if projs is none dcnl dcsp dcsp projs epochs0 info projs dcnl dcsp dcsp for epochs t in epochs1 dcnl dcsp dcsp dcsp if epochs t proj epochs0 proj dcnl dcsp dcsp dcsp dcsp raise valueerror epochs dcsp must dcsp agree dcsp on dcsp the dcsp use dcsp of dcsp projections dcnl dcsp dcsp dcsp for proj a proj b in zip epochs t info projs projs dcnl dcsp dcsp dcsp dcsp if not proj equal proj a proj b dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror epochs dcsp must dcsp have dcsp same dcsp projectors dcnl dcsp projs check projs projs dcnl dcsp ch names epochs0 ch names dcnl dcsp for epochs t in epochs1 dcnl dcsp dcsp if epochs t info bads bads dcnl dcsp dcsp dcsp raise valueerror epochs dcsp must dcsp have dcsp same dcsp bad dcsp channels dcnl dcsp dcsp if epochs t ch names ch names dcnl dcsp dcsp dcsp raise valueerror epochs dcsp must dcsp have dcsp same dcsp channel dcsp names dcnl dcsp picks list picks by type epochs0 info dcnl dcsp picks meeg np concatenate b for b in picks list dcnl dcsp picks meeg np sort picks meeg dcnl dcsp ch names epochs0 ch namesk for k in picks meeg dcnl dcsp info epochs0 info dcnl dcsp if method is none dcnl dcsp dcsp method empirical dcnl dcsp elif method auto dcnl dcsp dcsp method shrunk diagonal fixed empirical factor analysis dcnl dcsp if not isinstance method list tuple dcnl dcsp dcsp method method dcnl dcsp ok sklearn check version sklearn 0 15 is true dcnl dcsp if not ok sklearn and len method 1 or method0 empirical dcnl dcsp dcsp raise valueerror scikitlearn dcsp is dcsp not dcsp installed dcsp method dcsp must dcsp be dcsp empirical dcnl dcsp if keep sample mean is false dcnl dcsp dcsp if len method 1 or empirical not in method dcnl dcsp dcsp dcsp raise valueerror keep sample mean false dcsp is dcsp only dcsp supportedwith dcsp method empirical dcnl dcsp dcsp for p v in method params items dcnl dcsp dcsp dcsp if v get assume centered none is false dcnl dcsp dcsp dcsp dcsp raise valueerror assume centered dcsp must dcsp be dcsp true dcsp if dcsp keep sample mean dcsp is dcsp false dcnl dcsp dcsp n epoch types len epochs dcnl dcsp dcsp data mean 0 n epoch types dcnl dcsp dcsp n samples np zeros n epoch types dtype np int dcnl dcsp dcsp n epochs np zeros n epoch types dtype np int dcnl dcsp dcsp for ii epochs t in enumerate epochs dcnl dcsp dcsp dcsp tslice get tslice epochs t tmin tmax dcnl dcsp dcsp dcsp for e in epochs t dcnl dcsp dcsp dcsp dcsp e e picks meeg tslice dcnl dcsp dcsp dcsp dcsp if not keep sample mean dcnl dcsp dcsp dcsp dcsp dcsp data meanii + e dcnl dcsp dcsp dcsp dcsp n samplesii + e shape1 dcnl dcsp dcsp dcsp dcsp n epochsii + 1 dcnl dcsp dcsp n samples epoch n samples n epochs dcnl dcsp dcsp norm const np sum n samples epoch n epochs 1 dcnl dcsp dcsp data mean 1 0 n epoch np dot mean mean t for n epoch mean in zip n epochs data mean dcnl dcsp if not all k in accepted methods for k in method dcnl dcsp dcsp raise valueerror msg format method method dcnl dcsp info pick info info picks meeg dcnl dcsp tslice get tslice epochs0 tmin tmax dcnl dcsp epochs ee get data picks meeg tslice for ee in epochs dcnl dcsp picks meeg np arange len picks meeg dcnl dcsp picks list picks by type info dcnl dcsp if len epochs 1 dcnl dcsp dcsp epochs np concatenate epochs 0 dcnl dcsp else dcnl dcsp dcsp epochs epochs0 dcnl dcsp epochs np hstack epochs dcnl dcsp n samples tot epochs shape 1 dcnl dcsp check n samples n samples tot len picks meeg dcnl dcsp epochs epochs t dcnl dcsp if ok sklearn dcnl dcsp dcsp cov data compute covariance auto epochs method method method params method params info info verbose verbose cv cv n jobs n jobs stop early true picks list picks list scalings scalings dcnl dcsp else dcnl dcsp dcsp if method params empirical assume centered is true dcnl dcsp dcsp dcsp cov epochs t dot epochs n samples tot dcnl dcsp dcsp else dcnl dcsp dcsp dcsp cov np cov epochs t bias 1 dcnl dcsp dcsp cov data empirical data cov dcnl dcsp if keep sample mean is false dcnl dcsp dcsp cov cov data empirical data dcnl dcsp dcsp cov n samples tot dcnl dcsp dcsp for mean cov in data mean dcnl dcsp dcsp dcsp cov mean cov dcnl dcsp dcsp cov norm const dcnl dcsp covs list dcnl dcsp for this method data in cov data items dcnl dcsp dcsp cov covariance data pop data ch names info bads projs nfree n samples tot dcnl dcsp dcsp logger info number dcsp of dcsp samples dcsp used dcsp dcsp d n samples tot dcnl dcsp dcsp logger info done dcnl dcsp dcsp cov update method this method data dcnl dcsp dcsp covs append cov dcnl dcsp if ok sklearn dcnl dcsp dcsp msg loglikelihood dcsp on dcsp unseen dcsp data dcsp descending dcsp order dcnl dcsp dcsp logliks c method c loglik for c in covs dcnl dcsp dcsp logliks sort reverse true key lambda c c1 dcnl dcsp dcsp for k v in logliks dcnl dcsp dcsp dcsp msg append s dcsp 0 3f k v dcnl dcsp dcsp logger info n dcsp dcsp dcsp join msg dcnl dcsp if ok sklearn and not return estimators dcnl dcsp dcsp keys scores zip c method c loglik for c in covs dcnl dcsp dcsp out covsnp argmax scores dcnl dcsp dcsp logger info selecting dcsp best dcsp estimator dcsp 0 format out method dcnl dcsp elif ok sklearn dcnl dcsp dcsp out covs dcnl dcsp dcsp out sort key lambda c c loglik reverse true dcnl dcsp else dcnl dcsp dcsp out covs0 dcnl dcsp return out
def compute covariance auto data method info method params cv scalings n jobs stop early picks list verbose dcsp try dcnl dcsp dcsp from sklearn model selection import gridsearchcv dcnl dcsp except exception dcnl dcsp dcsp from sklearn grid search import gridsearchcv dcnl dcsp from sklearn covariance import ledoitwolf shrunkcovariance empiricalcovariance dcnl dcsp apply scaling array data t picks list picks list scalings scalings dcnl dcsp estimator cov info list dcnl dcsp msg estimating dcsp covariance dcsp using dcsp s dcnl dcsp regcovariance shrunkcovariance get covariance classes dcnl dcsp for this method in method dcnl dcsp dcsp data data copy dcnl dcsp dcsp name this method name if callable this method else this method dcnl dcsp dcsp logger info msg name upper dcnl dcsp dcsp if this method empirical dcnl dcsp dcsp dcsp est empiricalcovariance method paramsthis method dcnl dcsp dcsp dcsp est fit data dcnl dcsp dcsp dcsp info none dcnl dcsp dcsp dcsp estimator cov info append est est covariance info dcnl dcsp dcsp elif this method diagonal fixed dcnl dcsp dcsp dcsp est regcovariance info info method paramsthis method dcnl dcsp dcsp dcsp est fit data dcnl dcsp dcsp dcsp info none dcnl dcsp dcsp dcsp estimator cov info append est est covariance info dcnl dcsp dcsp elif this method ledoit wolf dcnl dcsp dcsp dcsp shrinkages dcnl dcsp dcsp dcsp lw ledoitwolf method paramsthis method dcnl dcsp dcsp dcsp for ch type picks in picks list dcnl dcsp dcsp dcsp dcsp lw fit data picks dcnl dcsp dcsp dcsp dcsp shrinkages append ch type lw shrinkage picks dcnl dcsp dcsp dcsp sc shrunkcovariance shrinkage shrinkages method paramsthis method dcnl dcsp dcsp dcsp sc fit data dcnl dcsp dcsp dcsp info none dcnl dcsp dcsp dcsp estimator cov info append sc sc covariance info dcnl dcsp dcsp elif this method shrunk dcnl dcsp dcsp dcsp shrinkage method paramsthis method pop shrinkage dcnl dcsp dcsp dcsp tuned parameters shrinkage shrinkage dcnl dcsp dcsp dcsp shrinkages dcnl dcsp dcsp dcsp gs gridsearchcv shrunkcovariance method paramsthis method tuned parameters cv cv dcnl dcsp dcsp dcsp for ch type picks in picks list dcnl dcsp dcsp dcsp dcsp gs fit data picks dcnl dcsp dcsp dcsp dcsp shrinkages append ch type gs best estimator shrinkage picks dcnl dcsp dcsp dcsp shrinkages c0 for c in zip shrinkages dcnl dcsp dcsp dcsp sc shrunkcovariance shrinkage shrinkages method paramsthis method dcnl dcsp dcsp dcsp sc fit data dcnl dcsp dcsp dcsp info none dcnl dcsp dcsp dcsp estimator cov info append sc sc covariance info dcnl dcsp dcsp elif this method pca dcnl dcsp dcsp dcsp mp method paramsthis method dcnl dcsp dcsp dcsp pca info auto low rank model data this method n jobs n jobs method params mp cv cv stop early stop early dcnl dcsp dcsp dcsp pca fit data dcnl dcsp dcsp dcsp estimator cov info append pca pca get covariance info dcnl dcsp dcsp elif this method factor analysis dcnl dcsp dcsp dcsp mp method paramsthis method dcnl dcsp dcsp dcsp fa info auto low rank model data this method n jobs n jobs method params mp cv cv stop early stop early dcnl dcsp dcsp dcsp fa fit data dcnl dcsp dcsp dcsp estimator cov info append fa fa get covariance info dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror oh dcsp no dcsp your dcsp estimator dcsp does dcsp not dcsp have dcsp a dcsp fit dcsp method dcnl dcsp dcsp logger info done dcnl dcsp logger info using dcsp crossvalidation dcsp to dcsp select dcsp the dcsp best dcsp estimator dcnl dcsp estimators zip estimator cov info dcnl dcsp logliks np array cross val data e cv n jobs for e in estimators dcnl dcsp for c in estimator cov info dcnl dcsp dcsp undo scaling cov c1 picks list scalings dcnl dcsp out dict dcnl dcsp estimators covs runtime infos zip estimator cov info dcnl dcsp cov methods c name if callable c else c for c in method dcnl dcsp runtime infos covs list runtime infos list covs dcnl dcsp my zip zip cov methods runtime infos logliks covs estimators dcnl dcsp for this method runtime info loglik data est in my zip dcnl dcsp dcsp outthis method loglik loglik data data estimator est dcnl dcsp dcsp if runtime info is not none dcnl dcsp dcsp dcsp outthis method update runtime info dcnl dcsp return out
def logdet a dcsp vals linalg eigh a 0 dcnl dcsp tol vals max vals size np finfo np float64 eps dcnl dcsp vals np where vals tol vals tol dcnl dcsp return np sum np log vals
def gaussian loglik scorer est x y none dcsp precision est get precision dcnl dcsp n samples n features x shape dcnl dcsp log like np zeros n samples dcnl dcsp log like 0 5 x np dot x precision sum axis 1 dcnl dcsp log like 0 5 n features log 2 0 np pi logdet precision dcnl dcsp out np mean log like dcnl dcsp return out
def cross val data est cv n jobs dcsp try dcnl dcsp dcsp from sklearn model selection import cross val score dcnl dcsp except importerror dcnl dcsp dcsp from sklearn cross validation import cross val score dcnl dcsp return np mean cross val score est data cv cv n jobs n jobs scoring gaussian loglik scorer
def auto low rank model data mode n jobs method params cv stop early true verbose none dcsp method params deepcopy method params dcnl dcsp iter n components method params pop iter n components dcnl dcsp if iter n components is none dcnl dcsp dcsp iter n components np arange 5 data shape1 5 dcnl dcsp from sklearn decomposition import pca factoranalysis dcnl dcsp if mode factor analysis dcnl dcsp dcsp est factoranalysis dcnl dcsp elif mode pca dcnl dcsp dcsp est pca dcnl dcsp else dcnl dcsp dcsp raise valueerror come dcsp on dcsp this dcsp is dcsp not dcsp a dcsp low dcsp rank dcsp estimator dcsp s mode dcnl dcsp est est method params dcnl dcsp est n components 1 dcnl dcsp scores np empty like iter n components dtype np float64 dcnl dcsp scores fill np nan dcnl dcsp max n max list deepcopy iter n components dcnl dcsp if max n data shape1 dcnl dcsp dcsp warn you dcsp are dcsp trying dcsp to dcsp estimate dcsp i dcsp components dcsp on dcsp matrix dcsp with dcsp i dcsp features max n data shape1 dcnl dcsp for ii n in enumerate iter n components dcnl dcsp dcsp est n components n dcnl dcsp dcsp try dcnl dcsp dcsp dcsp score cross val data data est est cv cv n jobs n jobs dcnl dcsp dcsp except valueerror dcnl dcsp dcsp dcsp score np inf dcnl dcsp dcsp if np isinf score or score 0 dcnl dcsp dcsp dcsp logger info dcsp infinite dcsp values dcsp encountered dcsp stopping dcsp estimation dcnl dcsp dcsp dcsp break dcnl dcsp dcsp logger info dcsp rank dcsp i dcsp dcsp loglik dcsp 0 3f n score dcnl dcsp dcsp if score np inf dcnl dcsp dcsp dcsp scoresii score dcnl dcsp dcsp if ii 3 and np all np diff scores ii 3 ii < 0 0 and stop early is true dcnl dcsp dcsp dcsp logger info early dcsp stopping dcsp parameter dcsp search dcnl dcsp dcsp dcsp break dcnl dcsp if np isnan scores all dcnl dcsp dcsp raise runtimeerror oh dcsp no dcsp could dcsp not dcsp estimate dcsp covariance dcsp because dcsp all dcsp scores dcsp were dcsp nan dcsp please dcsp contact dcsp the dcsp mnepython dcsp developers dcnl dcsp i score np nanargmax scores dcnl dcsp best est n components iter n componentsi score dcnl dcsp logger info dcsp best dcsp model dcsp at dcsp rank dcsp dcsp i best dcnl dcsp runtime info ranks np array iter n components scores scores best best cv cv dcnl dcsp return est runtime info
def get covariance classes dcsp from sklearn covariance import empiricalcovariance shrunk covariance shrunkcovariance dcnl dcsp class regcovariance empiricalcovariance dcnl dcsp dcsp aux dcsp class dcnl dcsp dcsp def init self info grad 0 01 mag 0 01 eeg 0 0 store precision false assume centered false dcnl dcsp dcsp dcsp self info info dcnl dcsp dcsp dcsp self grad grad dcnl dcsp dcsp dcsp self mag mag dcnl dcsp dcsp dcsp self eeg eeg dcnl dcsp dcsp dcsp self store precision store precision dcnl dcsp dcsp dcsp self assume centered assume centered dcnl dcsp dcsp def fit self x dcnl dcsp dcsp dcsp empiricalcovariance fit self x dcnl dcsp dcsp dcsp self covariance 0 5 self covariance + self covariance t dcnl dcsp dcsp dcsp cov covariance data self covariance names self info ch names bads self info bads projs self info projs nfree len self covariance dcnl dcsp dcsp dcsp cov regularize cov self info grad self grad mag self mag eeg self eeg proj false exclude bads dcnl dcsp dcsp dcsp self covariance cov data dcnl dcsp dcsp dcsp return self dcnl dcsp class shrunkcovariance shrunkcovariance dcnl dcsp dcsp aux dcsp class dcnl dcsp dcsp def init self store precision assume centered shrinkage 0 1 dcnl dcsp dcsp dcsp self store precision store precision dcnl dcsp dcsp dcsp self assume centered assume centered dcnl dcsp dcsp dcsp self shrinkage shrinkage dcnl dcsp dcsp def fit self x dcnl dcsp dcsp dcsp empiricalcovariance fit self x dcnl dcsp dcsp dcsp cov self covariance dcnl dcsp dcsp dcsp if not isinstance self shrinkage list tuple dcnl dcsp dcsp dcsp dcsp shrinkage all self shrinkage np arange len cov dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp shrinkage self shrinkage dcnl dcsp dcsp dcsp zero cross cov np zeros like cov dtype bool dcnl dcsp dcsp dcsp for a b in itt combinations shrinkage 2 dcnl dcsp dcsp dcsp dcsp picks i picks j a2 b2 dcnl dcsp dcsp dcsp dcsp ch a0 b0 dcnl dcsp dcsp dcsp dcsp if eeg in ch dcnl dcsp dcsp dcsp dcsp dcsp zero cross covnp ix picks i picks j true dcnl dcsp dcsp dcsp dcsp dcsp zero cross covnp ix picks j picks i true dcnl dcsp dcsp dcsp self zero cross cov zero cross cov dcnl dcsp dcsp dcsp for ch type c picks in shrinkage dcnl dcsp dcsp dcsp dcsp sub cov covnp ix picks picks dcnl dcsp dcsp dcsp dcsp covnp ix picks picks shrunk covariance sub cov shrinkage c dcnl dcsp dcsp dcsp for a b in itt combinations shrinkage 2 dcnl dcsp dcsp dcsp dcsp shrinkage i shrinkage j a1 b1 dcnl dcsp dcsp dcsp dcsp picks i picks j a2 b2 dcnl dcsp dcsp dcsp dcsp c ij np sqrt 1 0 shrinkage i 1 0 shrinkage j dcnl dcsp dcsp dcsp dcsp covnp ix picks i picks j c ij dcnl dcsp dcsp dcsp dcsp covnp ix picks j picks i c ij dcnl dcsp dcsp dcsp if np any zero cross cov dcnl dcsp dcsp dcsp dcsp covzero cross cov 0 0 dcnl dcsp dcsp dcsp self covariance cov dcnl dcsp dcsp dcsp return self dcnl dcsp dcsp def score self x test y none dcnl dcsp dcsp dcsp compute dcsp the dcsp loglikelihood dcsp of dcsp a dcsp gaussian dcsp data dcsp set n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp this dcsp uses dcsp self covariance dcsp as dcsp an dcsp estimator dcsp of dcsp the dcsp data s n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp covariance dcsp matrix n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp parameters n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp x test dcsp dcsp arraylike dcsp shape dcsp dcsp n samples dcsp n features n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp test dcsp data dcsp of dcsp which dcsp we dcsp compute dcsp the dcsp likelihood dcsp where dcsp n samples n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp is dcsp the dcsp number dcsp of dcsp samples dcsp and dcsp n features dcsp is dcsp the dcsp number dcsp of n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp features dcsp x test dcsp is dcsp assumed dcsp to dcsp be dcsp drawn dcsp from dcsp the dcsp same n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp distribution dcsp as dcsp the dcsp data dcsp used dcsp in dcsp fit dcsp including dcsp centering n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp y dcsp dcsp not dcsp used dcsp present dcsp for dcsp api dcsp consistence dcsp purpose n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp returns n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp res dcsp dcsp float n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp the dcsp likelihood dcsp of dcsp the dcsp data dcsp set dcsp with dcsp self covariance dcsp as dcsp an n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp estimator dcsp of dcsp its dcsp covariance dcsp matrix n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp dcsp from sklearn covariance import empirical covariance log likelihood dcnl dcsp dcsp dcsp test cov empirical covariance x test self location assume centered true dcnl dcsp dcsp dcsp if np any self zero cross cov dcnl dcsp dcsp dcsp dcsp test covself zero cross cov 0 0 dcnl dcsp dcsp dcsp res log likelihood test cov self get precision dcnl dcsp dcsp dcsp return res dcnl dcsp return regcovariance shrunkcovariance
def write cov fname cov dcsp cov save fname
def unpack epochs epochs dcsp if len epochs event id 1 dcnl dcsp dcsp epochs epochsk for k in epochs event id dcnl dcsp else dcnl dcsp dcsp epochs epochs dcnl dcsp return epochs
def get ch whitener a pca ch type rank dcsp eig eigvec linalg eigh a overwrite a true dcnl dcsp eigvec eigvec t dcnl dcsp eig rank 0 0 dcnl dcsp logger info setting dcsp small dcsp s dcsp eigenvalues dcsp to dcsp zero ch type dcnl dcsp if not pca dcnl dcsp dcsp logger info not dcsp doing dcsp pca dcsp for dcsp s ch type dcnl dcsp else dcnl dcsp dcsp logger info doing dcsp pca dcsp for dcsp s ch type dcnl dcsp dcsp eigvec eigvec rank copy dcnl dcsp return eig eigvec
verbose dcnl def prepare noise cov noise cov info ch names rank none scalings none verbose none dcsp noise cov idx noise cov ch names index c for c in ch names dcnl dcsp n chan len ch names dcnl dcsp if not noise cov diag dcnl dcsp dcsp c noise cov datanp ix noise cov idx noise cov idx dcnl dcsp else dcnl dcsp dcsp c np diag noise cov datanoise cov idx dcnl dcsp scalings handle default scalings cov rank scalings dcnl dcsp proj ncomp make projector info projs + noise cov projs ch names dcnl dcsp if ncomp 0 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp created dcsp an dcsp ssp dcsp operator dcsp subspace dcsp dimension dcsp dcsp d ncomp dcnl dcsp dcsp c np dot proj np dot c proj t dcnl dcsp info pick meg pick types info meg true eeg false ref meg false exclude bads dcnl dcsp info pick eeg pick types info meg false eeg true ref meg false exclude bads dcnl dcsp info meg names info chs k ch name for k in info pick meg dcnl dcsp out meg idx k for k in range len c if ch namesk in info meg names dcnl dcsp info eeg names info chs k ch name for k in info pick eeg dcnl dcsp out eeg idx k for k in range len c if ch namesk in info eeg names dcnl dcsp del info pick meg info pick eeg dcnl dcsp meg names ch namesk for k in out meg idx dcnl dcsp eeg names ch namesk for k in out eeg idx dcnl dcsp if len meg names 0 dcnl dcsp dcsp info pick meg pick channels info ch names meg names dcnl dcsp else dcnl dcsp dcsp info pick meg dcnl dcsp if len eeg names 0 dcnl dcsp dcsp info pick eeg pick channels info ch names eeg names dcnl dcsp else dcnl dcsp dcsp info pick eeg dcnl dcsp assert len info pick meg len meg names len out meg idx dcnl dcsp assert len info pick eeg len eeg names len out eeg idx dcnl dcsp assert len out meg idx + len out eeg idx n chan dcnl dcsp eigvec np zeros n chan n chan dcnl dcsp eig np zeros n chan dcnl dcsp has meg len out meg idx 0 dcnl dcsp has eeg len out eeg idx 0 dcnl dcsp if rank is not none dcnl dcsp dcsp if isinstance rank dict dcnl dcsp dcsp dcsp rank meg rank get meg none dcnl dcsp dcsp dcsp rank eeg rank get eeg none dcnl dcsp dcsp else dcnl dcsp dcsp dcsp rank meg int rank dcnl dcsp dcsp dcsp rank eeg none dcnl dcsp else dcnl dcsp dcsp rank meg rank eeg none none dcnl dcsp if has meg dcnl dcsp dcsp c meg cnp ix out meg idx out meg idx dcnl dcsp dcsp this info pick info simplify info info info pick meg copy false dcnl dcsp dcsp if rank meg is none dcnl dcsp dcsp dcsp rank meg estimate rank meeg cov c meg this info scalings dcnl dcsp dcsp eigout meg idx eigvecnp ix out meg idx out meg idx get ch whitener c meg false meg rank meg dcnl dcsp if has eeg dcnl dcsp dcsp c eeg cnp ix out eeg idx out eeg idx dcnl dcsp dcsp this info pick info simplify info info info pick eeg copy false dcnl dcsp dcsp if rank eeg is none dcnl dcsp dcsp dcsp rank eeg estimate rank meeg cov c eeg this info scalings dcnl dcsp dcsp eigout eeg idx eigvecnp ix out eeg idx out eeg idx get ch whitener c eeg false eeg rank eeg dcnl dcsp dcsp if needs eeg average ref proj info and not has eeg average ref proj noise cov projs dcnl dcsp dcsp dcsp warn no dcsp average dcsp eeg dcsp reference dcsp present dcsp in dcsp info projs dcsp covariance dcsp may dcsp be dcsp adversely dcsp affected dcsp consider dcsp recomputing dcsp covariance dcsp using dcsp with dcsp an dcsp average dcsp eeg dcsp reference dcsp projector dcsp added dcnl dcsp noise cov covariance data c names ch names bads list noise cov bads projs deepcopy noise cov projs nfree noise cov nfree eig eig eigvec eigvec method noise cov get method none loglik noise cov get loglik none dcnl dcsp return noise cov
def regularize cov info mag 0 1 grad 0 1 eeg 0 1 exclude bads proj true verbose none dcsp cov cov copy dcnl dcsp info check consistency dcnl dcsp if exclude is none dcnl dcsp dcsp raise valueerror exclude dcsp must dcsp be dcsp a dcsp list dcsp of dcsp strings dcsp or dcsp bads dcnl dcsp if exclude bads dcnl dcsp dcsp exclude info bads + cov bads dcnl dcsp sel eeg pick types info meg false eeg true ref meg false exclude exclude dcnl dcsp sel mag pick types info meg mag eeg false ref meg false exclude exclude dcnl dcsp sel grad pick types info meg grad eeg false ref meg false exclude exclude dcnl dcsp info ch names info ch names dcnl dcsp ch names eeg info ch namesi for i in sel eeg dcnl dcsp ch names mag info ch namesi for i in sel mag dcnl dcsp ch names grad info ch namesi for i in sel grad dcnl dcsp del sel eeg sel mag sel grad dcnl dcsp cov good pick channels cov cov include info ch names exclude exclude dcnl dcsp ch names cov good ch names dcnl dcsp idx eeg idx mag idx grad dcnl dcsp for i ch in enumerate ch names dcnl dcsp dcsp if ch in ch names eeg dcnl dcsp dcsp dcsp idx eeg append i dcnl dcsp dcsp elif ch in ch names mag dcnl dcsp dcsp dcsp idx mag append i dcnl dcsp dcsp elif ch in ch names grad dcnl dcsp dcsp dcsp idx grad append i dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise exception channel dcsp is dcsp unknown dcsp type dcnl dcsp c cov good data dcnl dcsp assert len c len idx eeg + len idx mag + len idx grad dcnl dcsp if proj dcnl dcsp dcsp projs info projs + cov good projs dcnl dcsp dcsp projs activate proj projs dcnl dcsp for desc idx reg in eeg idx eeg eeg mag idx mag mag grad idx grad grad dcnl dcsp dcsp if len idx 0 or reg 0 0 dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp s dcsp regularization dcsp dcsp none desc dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp s dcsp regularization dcsp dcsp s desc reg dcnl dcsp dcsp this c cnp ix idx idx dcnl dcsp dcsp if proj dcnl dcsp dcsp dcsp this ch names ch namesk for k in idx dcnl dcsp dcsp dcsp p ncomp make projector projs this ch names dcnl dcsp dcsp dcsp u linalg svd p 0 ncomp dcnl dcsp dcsp dcsp if ncomp 0 dcnl dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp created dcsp an dcsp ssp dcsp operator dcsp for dcsp s dcsp dimension dcsp dcsp d desc ncomp dcnl dcsp dcsp dcsp dcsp this c np dot u t np dot this c u dcnl dcsp dcsp sigma np mean np diag this c dcnl dcsp dcsp this c flat len this c + 1 + reg sigma dcnl dcsp dcsp if proj and ncomp 0 dcnl dcsp dcsp dcsp this c np dot u np dot this c u t dcnl dcsp dcsp cnp ix idx idx this c dcnl dcsp idx pick channels cov ch names info ch names exclude exclude dcnl dcsp cov data np ix idx idx c dcnl dcsp return cov
def regularized covariance data reg none dcsp if reg is none dcnl dcsp dcsp cov np cov data dcnl dcsp else dcnl dcsp dcsp no sklearn err the dcsp scikitlearn dcsp package dcsp is dcsp missing dcsp and dcsp required dcsp for dcsp covariance dcsp regularization dcnl dcsp dcsp if isinstance reg float dcnl dcsp dcsp dcsp if reg < 0 or reg 1 dcnl dcsp dcsp dcsp dcsp raise valueerror 0 dcsp < dcsp shrinkage dcsp < dcsp 1 dcsp for dcsp covariance dcsp regularization dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp import sklearn dcnl dcsp dcsp dcsp dcsp sklearn version looseversion sklearn version dcnl dcsp dcsp dcsp dcsp from sklearn covariance import shrunkcovariance dcnl dcsp dcsp dcsp except importerror dcnl dcsp dcsp dcsp dcsp raise exception no sklearn err dcnl dcsp dcsp dcsp if sklearn version < 0 12 dcnl dcsp dcsp dcsp dcsp skl cov shrunkcovariance shrinkage reg store precision false dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp skl cov shrunkcovariance shrinkage reg store precision false assume centered true dcnl dcsp dcsp elif isinstance reg string types dcnl dcsp dcsp dcsp if reg ledoit wolf dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp from sklearn covariance import ledoitwolf dcnl dcsp dcsp dcsp dcsp except importerror dcnl dcsp dcsp dcsp dcsp dcsp raise exception no sklearn err dcnl dcsp dcsp dcsp dcsp skl cov ledoitwolf store precision false assume centered true dcnl dcsp dcsp dcsp elif reg oas dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp from sklearn covariance import oas dcnl dcsp dcsp dcsp dcsp except importerror dcnl dcsp dcsp dcsp dcsp dcsp raise exception no sklearn err dcnl dcsp dcsp dcsp dcsp skl cov oas store precision false assume centered true dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise valueerror regularization dcsp parameter dcsp should dcsp be dcsp ledoit wolf dcsp or dcsp oas dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror regularization dcsp parameter dcsp should dcsp be dcsp of dcsp type dcsp str dcsp or dcsp int dcsp got dcsp s type reg dcnl dcsp dcsp cov skl cov fit data t covariance dcnl dcsp return cov
verbose dcnl def compute whitener noise cov info picks none rank none scalings none return rank false verbose none dcsp if picks is none dcnl dcsp dcsp picks pick types info meg true eeg true ref meg false exclude bads dcnl dcsp ch names info chs k ch name for k in picks dcnl dcsp noise cov prepare noise cov noise cov info ch names rank rank scalings scalings dcnl dcsp n chan len ch names dcnl dcsp w np zeros n chan n chan dtype np float dcnl dcsp eig noise cov eig dcnl dcsp nzero eig 0 dcnl dcsp w nzero nzero 1 0 np sqrt eignzero dcnl dcsp w np dot w noise cov eigvec dcnl dcsp w np dot noise cov eigvec t w dcnl dcsp out w ch names dcnl dcsp if return rank dcnl dcsp dcsp out + nzero sum dcnl dcsp return out
verbose dcnl def whiten evoked evoked noise cov picks none diag false rank none scalings none verbose none dcsp evoked evoked copy dcnl dcsp if picks is none dcnl dcsp dcsp picks pick types evoked info meg true eeg true dcnl dcsp w get whitener data evoked info noise cov picks diag diag rank rank scalings scalings 0 dcnl dcsp evoked datapicks np sqrt evoked nave np dot w evoked datapicks dcnl dcsp return evoked
verbose dcnl def get whitener data info noise cov picks diag false rank none scalings none verbose none dcsp ch names info ch names k for k in picks dcnl dcsp noise cov pick channels cov noise cov include ch names exclude dcnl dcsp if len noise cov data len ch names dcnl dcsp dcsp missing list set ch names set noise cov names dcnl dcsp dcsp raise runtimeerror not dcsp all dcsp channels dcsp present dcsp in dcsp noise dcsp covariance n s missing dcnl dcsp if diag dcnl dcsp dcsp noise cov noise cov copy dcnl dcsp dcsp noise cov data np diag np diag noise cov data dcnl dcsp scalings handle default scalings cov rank scalings dcnl dcsp w rank compute whitener noise cov info picks picks rank rank scalings scalings return rank true dcnl dcsp return w rank
verbose dcnl def read cov fid node cov kind limited false verbose none dcsp covs dir tree find node fiff fiffb mne cov dcnl dcsp if len covs 0 dcnl dcsp dcsp raise valueerror no dcsp covariance dcsp matrices dcsp found dcnl dcsp for p in range len covs dcnl dcsp dcsp tag find tag fid covsp fiff fiff mne cov kind dcnl dcsp dcsp if tag is not none and int tag data cov kind dcnl dcsp dcsp dcsp this covsp dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne cov dim dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp raise valueerror covariance dcsp matrix dcsp dimension dcsp not dcsp found dcnl dcsp dcsp dcsp dim int tag data dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne cov nfree dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp nfree 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp nfree int tag data dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne cov method dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp method none dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp method tag data dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne cov score dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp score none dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp score tag data0 dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne row names dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp names dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp names tag data split dcnl dcsp dcsp dcsp dcsp if len names dim dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror number dcsp of dcsp names dcsp does dcsp not dcsp match dcsp covariance dcsp matrix dcsp dimension dcnl dcsp dcsp dcsp tag find tag fid this fiff fiff mne cov dcnl dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp tag find tag fid this fiff fiff mne cov diag dcnl dcsp dcsp dcsp dcsp if tag is none dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror no dcsp covariance dcsp matrix dcsp data dcsp found dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp data tag data dcnl dcsp dcsp dcsp dcsp dcsp diag true dcnl dcsp dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp d dcsp x dcsp d dcsp diagonal dcsp covariance dcsp kind dcsp dcsp d dcsp found dim dim cov kind dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp from scipy import sparse dcnl dcsp dcsp dcsp dcsp if not sparse issparse tag data dcnl dcsp dcsp dcsp dcsp dcsp vals tag data dcnl dcsp dcsp dcsp dcsp dcsp data np zeros dim dim dcnl dcsp dcsp dcsp dcsp dcsp data np tril np ones dim dim 0 vals dcnl dcsp dcsp dcsp dcsp dcsp data data + data t dcnl dcsp dcsp dcsp dcsp dcsp data flat dim + 1 2 0 dcnl dcsp dcsp dcsp dcsp dcsp diag false dcnl dcsp dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp d dcsp x dcsp d dcsp full dcsp covariance dcsp kind dcsp dcsp d dcsp found dim dim cov kind dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp diag false dcnl dcsp dcsp dcsp dcsp dcsp data tag data dcnl dcsp dcsp dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp d dcsp x dcsp d dcsp sparse dcsp covariance dcsp kind dcsp dcsp d dcsp found dim dim cov kind dcnl dcsp dcsp dcsp tag1 find tag fid this fiff fiff mne cov eigenvalues dcnl dcsp dcsp dcsp tag2 find tag fid this fiff fiff mne cov eigenvectors dcnl dcsp dcsp dcsp if tag1 is not none and tag2 is not none dcnl dcsp dcsp dcsp dcsp eig tag1 data dcnl dcsp dcsp dcsp dcsp eigvec tag2 data dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp eig none dcnl dcsp dcsp dcsp dcsp eigvec none dcnl dcsp dcsp dcsp projs read proj fid this dcnl dcsp dcsp dcsp bads read bad channels fid this dcnl dcsp dcsp dcsp assert dim len data dcnl dcsp dcsp dcsp assert data ndim 1 if diag else 2 dcnl dcsp dcsp dcsp cov dict kind cov kind diag diag dim dim names names data data projs projs bads bads nfree nfree eig eig eigvec eigvec dcnl dcsp dcsp dcsp if score is not none dcnl dcsp dcsp dcsp dcsp cov loglik score dcnl dcsp dcsp dcsp if method is not none dcnl dcsp dcsp dcsp dcsp cov method method dcnl dcsp dcsp dcsp if limited dcnl dcsp dcsp dcsp dcsp del cov kind cov dim cov diag dcnl dcsp dcsp dcsp return cov dcnl dcsp logger info dcsp dcsp dcsp dcsp did dcsp not dcsp find dcsp the dcsp desired dcsp covariance dcsp matrix dcsp kind dcsp dcsp d cov kind dcnl dcsp return none
def write cov fid cov dcsp start block fid fiff fiffb mne cov dcnl dcsp write int fid fiff fiff mne cov kind cov kind dcnl dcsp write int fid fiff fiff mne cov dim cov dim dcnl dcsp if cov nfree 0 dcnl dcsp dcsp write int fid fiff fiff mne cov nfree cov nfree dcnl dcsp if cov names is not none and len cov names 0 dcnl dcsp dcsp write name list fid fiff fiff mne row names cov names dcnl dcsp if cov diag dcnl dcsp dcsp write double fid fiff fiff mne cov diag cov data dcnl dcsp else dcnl dcsp dcsp dim cov dim dcnl dcsp dcsp mask np tril np ones dim dim dtype np bool 0 dcnl dcsp dcsp vals cov data mask ravel dcnl dcsp dcsp write double fid fiff fiff mne cov vals dcnl dcsp if cov eig is not none and cov eigvec is not none dcnl dcsp dcsp write float matrix fid fiff fiff mne cov eigenvectors cov eigvec dcnl dcsp dcsp write double fid fiff fiff mne cov eigenvalues cov eig dcnl dcsp if cov projs is not none and len cov projs 0 dcnl dcsp dcsp write proj fid cov projs dcnl dcsp if cov bads is not none and len cov bads 0 dcnl dcsp dcsp start block fid fiff fiffb mne bad channels dcnl dcsp dcsp write name list fid fiff fiff mne ch name list cov bads dcnl dcsp dcsp end block fid fiff fiffb mne bad channels dcnl dcsp if method in cov dcnl dcsp dcsp write string fid fiff fiff mne cov method cov method dcnl dcsp if loglik in cov dcnl dcsp dcsp write double fid fiff fiff mne cov score np array cov loglik dcnl dcsp end block fid fiff fiffb mne cov
def apply scaling array data picks list scalings dcsp scalings check scaling inputs data picks list scalings dcnl dcsp if isinstance scalings dict dcnl dcsp dcsp picks dict dict picks list dcnl dcsp dcsp scalings picks dictk v for k v in scalings items if k in picks dict dcnl dcsp dcsp for idx scaling in scalings dcnl dcsp dcsp dcsp dataidx scaling dcnl dcsp else dcnl dcsp dcsp data scalings np newaxis
def apply scaling cov data picks list scalings dcsp scalings check scaling inputs data picks list scalings dcnl dcsp scales none dcnl dcsp if isinstance scalings dict dcnl dcsp dcsp n channels len data dcnl dcsp dcsp covinds list zip picks list 1 dcnl dcsp dcsp assert len data sum len k for k in covinds dcnl dcsp dcsp assert list sorted np concatenate covinds list range len data dcnl dcsp dcsp scales np zeros n channels dcnl dcsp dcsp for ch t idx in picks list dcnl dcsp dcsp dcsp scalesidx scalingsch t dcnl dcsp elif isinstance scalings np ndarray dcnl dcsp dcsp if len scalings len data dcnl dcsp dcsp dcsp raise valueerror scaling dcsp factors dcsp and dcsp data dcsp are dcsp of dcsp incompatible dcsp shape dcnl dcsp dcsp scales scalings dcnl dcsp elif scalings is none dcnl dcsp dcsp pass dcnl dcsp else dcnl dcsp dcsp raise runtimeerror arff dcnl dcsp if scales is not none dcnl dcsp dcsp assert np sum scales 0 0 0 dcnl dcsp dcsp data scalesnone scales none
def check scaling inputs data picks list scalings dcsp rescale dict dict mag 1000000000000000 0 grad 10000000000000 0 eeg 1000000 0 dcnl dcsp scalings none dcnl dcsp if isinstance scalings string types and scalings norm dcnl dcsp dcsp scalings 1 0 compute row norms data dcnl dcsp elif isinstance scalings dict dcnl dcsp dcsp rescale dict update scalings dcnl dcsp dcsp scalings rescale dict dcnl dcsp elif isinstance scalings np ndarray dcnl dcsp dcsp scalings scalings dcnl dcsp elif scalings is none dcnl dcsp dcsp pass dcnl dcsp else dcnl dcsp dcsp raise notimplementederror no dcsp way dcsp that s dcsp not dcsp a dcsp rescaling dcsp option dcsp s scalings dcnl dcsp return scalings
def estimate rank meeg signals data info scalings tol auto return singular false dcsp picks list picks by type info dcnl dcsp apply scaling array data picks list scalings dcnl dcsp if data shape1 < data shape0 dcnl dcsp dcsp valueerror you ve dcsp got dcsp fewer dcsp samples dcsp than dcsp channels dcsp your dcsp rank dcsp estimate dcsp might dcsp be dcsp inaccurate dcnl dcsp out estimate rank data tol tol norm false return singular return singular dcnl dcsp rank out0 if isinstance out tuple else out dcnl dcsp ch type dcsp + dcsp join list zip picks list 0 dcnl dcsp logger info estimated dcsp rank dcsp s dcsp d ch type rank dcnl dcsp undo scaling array data picks list scalings dcnl dcsp return out
def estimate rank meeg cov data info scalings tol auto return singular false dcsp picks list picks by type info dcnl dcsp scalings handle default scalings cov rank scalings dcnl dcsp apply scaling cov data picks list scalings dcnl dcsp if data shape1 < data shape0 dcnl dcsp dcsp valueerror you ve dcsp got dcsp fewer dcsp samples dcsp than dcsp channels dcsp your dcsp rank dcsp estimate dcsp might dcsp be dcsp inaccurate dcnl dcsp out estimate rank data tol tol norm false return singular return singular dcnl dcsp rank out0 if isinstance out tuple else out dcnl dcsp ch type dcsp + dcsp join list zip picks list 0 dcnl dcsp logger info estimated dcsp rank dcsp s dcsp d ch type rank dcnl dcsp undo scaling cov data picks list scalings dcnl dcsp return out
def mm fmt x dcsp return 0 5f x
def get fs home dcsp return get root home freesurfer home freesurfer fs home problem
def set fs home dcsp fs home get fs home dcnl dcsp if fs home is none dcnl dcsp dcsp return false dcnl dcsp else dcnl dcsp dcsp os environ freesurfer home fs home dcnl dcsp dcsp return true
def fs home problem fs home dcsp if fs home is none dcnl dcsp dcsp return freesurfer home dcsp is dcsp not dcsp set dcnl dcsp elif not op exists fs home dcnl dcsp dcsp return freesurfer home dcsp s dcsp does dcsp not dcsp exist fs home dcnl dcsp else dcnl dcsp dcsp test dir op join fs home subjects fsaverage dcnl dcsp dcsp if not op exists test dir dcnl dcsp dcsp dcsp return freesurfer home dcsp s dcsp does dcsp not dcsp contain dcsp the dcsp fsaverage dcsp subject fs home
def mne root problem mne root dcsp if mne root is none dcnl dcsp dcsp return mne root dcsp is dcsp not dcsp set dcnl dcsp elif not op exists mne root dcnl dcsp dcsp return mne root dcsp s dcsp does dcsp not dcsp exist mne root dcnl dcsp else dcnl dcsp dcsp test dir op join mne root share mne mne analyze dcnl dcsp dcsp if not op exists test dir dcnl dcsp dcsp dcsp return mne root dcsp s dcsp is dcsp missing dcsp files dcsp if dcsp this dcsp is dcsp your dcsp mne dcsp installation dcsp consider dcsp reinstalling mne root
def initialize gui frame view none dcsp if testing mode dcnl dcsp dcsp return frame edit traits view view frame dcnl dcsp else dcnl dcsp dcsp frame configure traits view view dcnl dcsp dcsp return frame
def combine kit markers dcsp check mayavi version dcnl dcsp from backend import check backend dcnl dcsp check backend dcnl dcsp from marker gui import combinemarkersframe dcnl dcsp frame combinemarkersframe dcnl dcsp return initialize gui frame
verbose dcnl def coregistration tabbed false split true scene width none inst none subject none subjects dir none guess mri subject none scene height none head opacity none head high res none trans none scrollable true verbose none dcsp config get config home dir os environ get mne fake home dir dcnl dcsp if guess mri subject is none dcnl dcsp dcsp guess mri subject config get mne coreg guess mri subject true true dcnl dcsp if head high res is none dcnl dcsp dcsp head high res config get mne coreg head high res true true dcnl dcsp if head opacity is none dcnl dcsp dcsp head opacity config get mne coreg head opacity 1 0 dcnl dcsp if scene width is none dcnl dcsp dcsp scene width config get mne coreg scene width 500 dcnl dcsp if scene height is none dcnl dcsp dcsp scene height config get mne coreg scene height 400 dcnl dcsp if subjects dir is none dcnl dcsp dcsp if subjects dir in config dcnl dcsp dcsp dcsp subjects dir config subjects dir dcnl dcsp dcsp elif mne coreg subjects dir in config dcnl dcsp dcsp dcsp subjects dir config mne coreg subjects dir dcnl dcsp head opacity float head opacity dcnl dcsp scene width int scene width dcnl dcsp scene height int scene height dcnl dcsp check mayavi version dcnl dcsp from backend import check backend dcnl dcsp check backend dcnl dcsp from coreg gui import coregframe make view dcnl dcsp view make view tabbed split scene width scene height scrollable dcnl dcsp frame coregframe inst subject subjects dir guess mri subject head opacity head high res trans config dcnl dcsp return initialize gui frame view
def fiducials subject none fid file none subjects dir none dcsp check mayavi version dcnl dcsp from backend import check backend dcnl dcsp check backend dcnl dcsp from fiducials gui import fiducialsframe dcnl dcsp frame fiducialsframe subject subjects dir fid file fid file dcnl dcsp return initialize gui frame
def kit2fiff dcsp check mayavi version dcnl dcsp from backend import check backend dcnl dcsp check backend dcnl dcsp from kit2fiff gui import kit2fiffframe dcnl dcsp frame kit2fiffframe dcnl dcsp return initialize gui frame
requires mayavi dcnl def test kit2fiff model dcsp from mne gui kit2fiff gui import kit2fiffmodel dcnl dcsp tempdir tempdir dcnl dcsp tgt fname os path join tempdir testraw fif dcnl dcsp model kit2fiffmodel dcnl dcsp assert false model can save dcnl dcsp assert equal model misc chs desc no dcsp sqd dcsp file dcsp selected dcnl dcsp assert equal model stim chs comment dcnl dcsp model markers mrk1 file mrk pre path dcnl dcsp model markers mrk2 file mrk post path dcnl dcsp model sqd file sqd path dcnl dcsp assert equal model misc chs desc 160 192 dcnl dcsp model hsp file hsp path dcnl dcsp assert false model can save dcnl dcsp model fid file fid path dcnl dcsp assert true model can save dcnl dcsp model stim slope + dcnl dcsp assert equal model get event info 1 2 dcnl dcsp model stim slope dcnl dcsp assert equal model get event info 254 2 255 2 dcnl dcsp model stim chs 181 184 dcsp 186 dcnl dcsp assert array equal model stim chs array 181 182 183 186 dcnl dcsp assert true model stim chs ok dcnl dcsp assert equal model get event info dcnl dcsp model stim chs 181 184 dcsp bad dcnl dcsp assert false model stim chs ok dcnl dcsp assert false model can save dcnl dcsp model stim chs dcnl dcsp assert true model can save dcnl dcsp raw out model get raw dcnl dcsp raw out save tgt fname dcnl dcsp raw read raw fif tgt fname dcnl dcsp raw bin read raw fif fif path dcnl dcsp trans bin raw info dev head t trans dcnl dcsp want keys list raw bin info keys dcnl dcsp assert equal sorted want keys sorted list raw info keys dcnl dcsp trans transform raw bin info dev head t trans dcnl dcsp assert allclose trans transform trans bin 0 1 dcnl dcsp model markers mrk3 method average dcnl dcsp trans avg model dev head trans dcnl dcsp assert false np all trans avg trans transform dcnl dcsp assert allclose trans avg trans bin 0 1 dcnl dcsp model markers mrk3 method transform dcnl dcsp model use mrk 1 2 3 4 dcnl dcsp assert false np all model dev head trans trans transform dcnl dcsp assert false np all model dev head trans trans avg dcnl dcsp assert false np all model dev head trans np eye 4 dcnl dcsp model stim slope + dcnl dcsp events bin mne find events raw bin stim channel sti dcsp 014 dcnl dcsp model stim coding < dcnl dcsp raw model get raw dcnl dcsp events mne find events raw stim channel sti dcsp 014 dcnl dcsp assert array equal events events bin dcnl dcsp events rev events bin copy dcnl dcsp events rev 2 1 dcnl dcsp model stim coding dcnl dcsp raw model get raw dcnl dcsp events mne find events raw stim channel sti dcsp 014 dcnl dcsp assert array equal events events rev dcnl dcsp model stim coding channel dcnl dcsp model stim chs 160 161 dcnl dcsp raw model get raw dcnl dcsp events mne find events raw stim channel sti dcsp 014 dcnl dcsp assert array equal events events bin + 0 0 32 dcnl dcsp model clear all dcnl dcsp assert equal model use mrk 0 1 2 3 4 dcnl dcsp assert equal model sqd file
requires mayavi dcnl def test kit2fiff gui dcsp if os environ get travis os name linux dcnl dcsp dcsp raise skiptest skipping dcsp on dcsp travis dcsp for dcsp linux dcsp due dcsp to dcsp gui dcsp error dcnl dcsp home dir tempdir dcnl dcsp os environ mne gui testing mode true dcnl dcsp os environ mne fake home dir home dir dcnl dcsp try dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp ui frame mne gui kit2fiff dcnl dcsp dcsp dcsp assert false frame model can save dcnl dcsp dcsp dcsp assert equal frame model stim threshold 1 0 dcnl dcsp dcsp dcsp frame model stim threshold 10 0 dcnl dcsp dcsp dcsp frame model stim chs save dcsp this dcnl dcsp dcsp dcsp frame save config home dir dcnl dcsp dcsp dcsp ui frame mne gui kit2fiff dcnl dcsp dcsp dcsp assert equal frame model stim threshold 10 0 dcnl dcsp dcsp dcsp assert equal frame model stim chs save dcsp this dcnl dcsp dcsp dcsp frame model markers mrk1 file mrk pre path dcnl dcsp dcsp dcsp frame marker panel mrk1 obj label true dcnl dcsp dcsp dcsp frame marker panel mrk1 obj label false dcnl dcsp finally dcnl dcsp dcsp del os environ mne gui testing mode dcnl dcsp dcsp del os environ mne fake home dir
testing requires testing data dcnl requires mayavi dcnl def test bem source dcsp from mne gui file traits import surfacesource dcnl dcsp bem surfacesource dcnl dcsp assert equal bem points shape 0 3 dcnl dcsp assert equal bem tris shape 0 3 dcnl dcsp bem file bem path dcnl dcsp assert equal bem points shape 642 3 dcnl dcsp assert equal bem tris shape 1280 3
testing requires testing data dcnl requires mayavi dcnl def test fiducials source dcsp from mne gui file traits import fiducialssource dcnl dcsp fid fiducialssource dcnl dcsp fid file fid path dcnl dcsp points array 0 08061612 0 02908875 0 04131077 0 00146763 0 08506715 0 03483611 0 08436285 0 02850276 0 04127743 dcnl dcsp assert allclose fid points points 1e06 dcnl dcsp fid file dcnl dcsp assert equal fid points none
testing requires testing data dcnl requires mayavi dcnl def test inst source dcsp from mne gui file traits import digsource dcnl dcsp tempdir tempdir dcnl dcsp inst digsource dcnl dcsp assert equal inst inst fname dcnl dcsp inst file inst path dcnl dcsp assert equal inst inst dir os path dirname inst path dcnl dcsp lpa array 0 0713766068 0 0 5 12227416e09 dcnl dcsp nasion array 3 7252903e09 0 102605611 4 19095159e09 dcnl dcsp rpa array 0 07526768 0 0 5 58793545e09 dcnl dcsp assert allclose inst lpa lpa dcnl dcsp assert allclose inst nasion nasion dcnl dcsp assert allclose inst rpa rpa dcnl dcsp montage read dig montage fif inst path dcnl dcsp montage path os path join tempdir temp montage fif dcnl dcsp montage save montage path dcnl dcsp inst file montage path dcnl dcsp assert allclose inst lpa lpa dcnl dcsp assert allclose inst nasion nasion dcnl dcsp assert allclose inst rpa rpa
testing requires testing data dcnl requires mayavi dcnl def test subject source dcsp from mne gui file traits import mrisubjectsource dcnl dcsp mri mrisubjectsource dcnl dcsp mri subjects dir subjects dir dcnl dcsp assert true sample in mri subjects dcnl dcsp mri subject sample
testing requires testing data dcnl requires mayavi dcnl requires freesurfer dcnl def test subject source with fsaverage dcsp from mne gui file traits import mrisubjectsource dcnl dcsp tempdir tempdir dcnl dcsp mri mrisubjectsource dcnl dcsp assert false mri can create fsaverage dcnl dcsp assert raises runtimeerror mri create fsaverage dcnl dcsp mri subjects dir tempdir dcnl dcsp assert true mri can create fsaverage dcnl dcsp mri create fsaverage
testing requires testing data dcnl requires mayavi dcnl def test coreg model dcsp from mne gui coreg gui import coregmodel dcnl dcsp tempdir tempdir dcnl dcsp trans dst op join tempdir testtrans fif dcnl dcsp model coregmodel dcnl dcsp assert raises runtimeerror model save trans blah fif dcnl dcsp model mri use high res head false dcnl dcsp model mri subjects dir subjects dir dcnl dcsp model mri subject sample dcnl dcsp assert false model mri fid ok dcnl dcsp model mri lpa 0 06 0 0 dcnl dcsp model mri nasion 0 0 05 0 dcnl dcsp model mri rpa 0 08 0 0 dcnl dcsp assert true model mri fid ok dcnl dcsp model hsp file raw path dcnl dcsp assert allclose model hsp lpa 0 07137 0 5 122e09 0 0001 dcnl dcsp assert allclose model hsp rpa + 0 07527 0 5 588e09 0 0001 dcnl dcsp assert allclose model hsp nasion + 3 725e09 0 1026 4 191e09 0 0001 dcnl dcsp assert true model has fid data dcnl dcsp lpa distance model lpa distance dcnl dcsp nasion distance model nasion distance dcnl dcsp rpa distance model rpa distance dcnl dcsp avg point distance np mean model point distance dcnl dcsp model fit auricular points dcnl dcsp old x lpa distance 2 + rpa distance 2 dcnl dcsp new x model lpa distance 2 + model rpa distance 2 dcnl dcsp assert true new x < old x dcnl dcsp model fit fiducials dcnl dcsp old x lpa distance 2 + rpa distance 2 + nasion distance 2 dcnl dcsp new x model lpa distance 2 + model rpa distance 2 + model nasion distance 2 dcnl dcsp assert true new x < old x dcnl dcsp model fit hsp points dcnl dcsp assert true np mean model point distance < avg point distance dcnl dcsp model save trans trans dst dcnl dcsp trans mne read trans trans dst dcnl dcsp assert allclose trans trans model head mri trans dcnl dcsp x y z rot x rot y rot z 0 1 0 2 0 05 1 5 0 1 1 2 dcnl dcsp model trans x x dcnl dcsp model trans y y dcnl dcsp model trans z z dcnl dcsp model rot x rot x dcnl dcsp model rot y rot y dcnl dcsp model rot z rot z dcnl dcsp trans model head mri trans dcnl dcsp model reset traits trans x trans y trans z rot x rot y rot z dcnl dcsp assert equal model trans x 0 dcnl dcsp model set trans trans dcnl dcsp assert almost equal model trans x x dcnl dcsp assert almost equal model trans y y dcnl dcsp assert almost equal model trans z z dcnl dcsp assert almost equal model rot x rot x dcnl dcsp assert almost equal model rot y rot y dcnl dcsp assert almost equal model rot z rot z dcnl dcsp assert true isinstance model fid eval str string types dcnl dcsp assert true isinstance model points eval str string types dcnl dcsp assert false model can prepare bem model dcnl dcsp model n scale params 1 dcnl dcsp assert true model can prepare bem model dcnl dcsp model prepare bem model true dcnl dcsp sdir sfrom sto scale skip fiducials labels annot bemsol model get scaling job sample2 false dcnl dcsp assert equal sdir subjects dir dcnl dcsp assert equal sfrom sample dcnl dcsp assert equal sto sample2 dcnl dcsp assert equal scale model scale dcnl dcsp assert equal skip fiducials false dcnl dcsp bems set dcnl dcsp for fname in os listdir op join subjects dir sample bem dcnl dcsp dcsp match re match sample +bem fif fname dcnl dcsp dcsp if match dcnl dcsp dcsp dcsp bems add match group 1 dcnl dcsp assert equal set bemsol bems dcnl dcsp model prepare bem model false dcnl dcsp sdir sfrom sto scale skip fiducials labels annot bemsol model get scaling job sample2 true dcnl dcsp assert equal bemsol dcnl dcsp assert true skip fiducials dcnl dcsp model load trans fname trans
testing requires testing data dcnl requires mayavi dcnl def test coreg gui dcsp home dir tempdir dcnl dcsp os environ mne gui testing mode true dcnl dcsp os environ mne fake home dir home dir dcnl dcsp try dcnl dcsp dcsp assert raises valueerror mne gui coregistration subject elvis subjects dir subjects dir dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp ui frame mne gui coregistration subjects dir dcnl dcsp dcsp dcsp frame model mri subjects dir subjects dir dcnl dcsp dcsp dcsp frame model mri subject sample dcnl dcsp dcsp dcsp assert false frame model mri fid ok dcnl dcsp dcsp dcsp frame model mri lpa 0 06 0 0 dcnl dcsp dcsp dcsp frame model mri nasion 0 0 05 0 dcnl dcsp dcsp dcsp frame model mri rpa 0 08 0 0 dcnl dcsp dcsp dcsp assert true frame model mri fid ok dcnl dcsp dcsp dcsp frame raw src file raw path dcnl dcsp dcsp dcsp assert true frame model mri use high res head dcnl dcsp dcsp dcsp frame model mri use high res head false dcnl dcsp dcsp dcsp frame model grow hair 40 0 dcnl dcsp dcsp dcsp frame coreg panel n scale params 3 dcnl dcsp dcsp dcsp frame coreg panel scale x inc true dcnl dcsp dcsp dcsp assert equal frame model scale x 1 01 dcnl dcsp dcsp dcsp frame coreg panel scale y dec true dcnl dcsp dcsp dcsp assert equal frame model scale y 0 99 dcnl dcsp dcsp dcsp frame coreg panel reset params true dcnl dcsp dcsp dcsp assert equal frame model grow hair 0 dcnl dcsp dcsp dcsp assert false frame model mri use high res head dcnl dcsp dcsp dcsp assert true frame model prepare bem model dcnl dcsp dcsp dcsp frame model prepare bem model false dcnl dcsp dcsp dcsp frame save config home dir dcnl dcsp dcsp dcsp ui frame mne gui coregistration subjects dir subjects dir dcnl dcsp dcsp dcsp assert false frame model prepare bem model dcnl dcsp dcsp dcsp assert false frame model mri use high res head dcnl dcsp finally dcnl dcsp dcsp del os environ mne gui testing mode dcnl dcsp dcsp del os environ mne fake home dir
testing requires testing data dcnl requires mayavi dcnl def test coreg model with fsaverage dcsp tempdir tempdir dcnl dcsp from mne gui coreg gui import coregmodel dcnl dcsp mne create default subject subjects dir tempdir fs home op join subjects dir dcnl dcsp model coregmodel dcnl dcsp model mri use high res head false dcnl dcsp model mri subjects dir tempdir dcnl dcsp model mri subject fsaverage dcnl dcsp assert true model mri fid ok dcnl dcsp model hsp file raw path dcnl dcsp lpa distance model lpa distance dcnl dcsp nasion distance model nasion distance dcnl dcsp rpa distance model rpa distance dcnl dcsp avg point distance np mean model point distance dcnl dcsp model trans y 0 008 dcnl dcsp model fit auricular points dcnl dcsp model omit hsp points 0 02 dcnl dcsp assert equal model hsp n omitted 1 dcnl dcsp model omit hsp points reset true dcnl dcsp assert equal model hsp n omitted 0 dcnl dcsp model omit hsp points 0 02 reset true dcnl dcsp assert equal model hsp n omitted 1 dcnl dcsp model n scale params 1 dcnl dcsp model fit scale auricular points dcnl dcsp old x lpa distance 2 + rpa distance 2 dcnl dcsp new x model lpa distance 2 + model rpa distance 2 dcnl dcsp assert true new x < old x dcnl dcsp model fit scale fiducials dcnl dcsp old x lpa distance 2 + rpa distance 2 + nasion distance 2 dcnl dcsp new x model lpa distance 2 + model rpa distance 2 + model nasion distance 2 dcnl dcsp assert true new x < old x dcnl dcsp model fit scale hsp points dcnl dcsp avg point distance 1param np mean model point distance dcnl dcsp assert true avg point distance 1param < avg point distance dcnl dcsp sdir sfrom sto scale skip fiducials labels annot bemsol model get scaling job scaled false dcnl dcsp assert equal sdir tempdir dcnl dcsp assert equal sfrom fsaverage dcnl dcsp assert equal sto scaled dcnl dcsp assert equal scale model scale dcnl dcsp assert equal set bemsol set inner skullbem dcnl dcsp model prepare bem model false dcnl dcsp sdir sfrom sto scale skip fiducials labels annot bemsol model get scaling job scaled false dcnl dcsp assert equal bemsol dcnl dcsp model n scale params 3 dcnl dcsp model fit scale hsp points dcnl dcsp assert true np mean model point distance < avg point distance 1param dcnl dcsp assert equal model hsp n omitted 1 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp model hsp file kit raw path dcnl dcsp assert equal model hsp n omitted 0
requires mayavi dcnl def test combine markers model dcsp from mne gui marker gui import combinemarkersmodel combinemarkerspanel dcnl dcsp tempdir tempdir dcnl dcsp tgt fname os path join tempdir test txt dcnl dcsp model combinemarkersmodel dcnl dcsp assert false model mrk3 can save dcnl dcsp model mrk1 file mrk pre path dcnl dcsp assert true model mrk3 can save dcnl dcsp assert array equal model mrk3 points model mrk1 points dcnl dcsp model mrk2 file mrk pre path dcnl dcsp assert array equal model mrk3 points model mrk1 points dcnl dcsp model mrk2 clear true dcnl dcsp model mrk2 file mrk post path dcnl dcsp assert true np any model mrk3 points dcnl dcsp points interpolate mrk1 mrk2 model mrk3 points dcnl dcsp model mrk3 method average dcnl dcsp mrk avg read mrk mrk avg path dcnl dcsp assert array equal model mrk3 points mrk avg dcnl dcsp model mrk2 clear true dcnl dcsp assert array equal model mrk1 points model mrk3 points dcnl dcsp model mrk2 file mrk post path dcnl dcsp model mrk3 save tgt fname dcnl dcsp mrk io read mrk tgt fname dcnl dcsp assert array equal mrk io model mrk3 points dcnl dcsp model mrk1 use 1 2 3 4 dcnl dcsp assert array equal model mrk3 points0 model mrk2 points0 dcnl dcsp assert array equal model mrk3 points1 mrk avg1 dcnl dcsp model clear true dcnl dcsp model mrk1 file mrk pre path dcnl dcsp model mrk2 file mrk post path dcnl dcsp assert array equal model mrk3 points points interpolate mrk1 mrk2 dcnl dcsp os environ mne gui testing mode true dcnl dcsp try dcnl dcsp dcsp with warnings catch warnings record true dcnl dcsp dcsp dcsp warnings simplefilter always dcnl dcsp dcsp dcsp combinemarkerspanel dcnl dcsp finally dcnl dcsp dcsp del os environ mne gui testing mode
testing requires testing data dcnl requires mayavi dcnl def test mri model dcsp from mne gui fiducials gui import mriheadwithfiducialsmodel dcnl dcsp tempdir tempdir dcnl dcsp tgt fname os path join tempdir testfiducials fif dcnl dcsp model mriheadwithfiducialsmodel subjects dir subjects dir dcnl dcsp model subject sample dcnl dcsp assert equal model default fid fname 20 samplefiducials fif dcnl dcsp assert false model can reset dcnl dcsp assert false model can save dcnl dcsp model lpa 1 0 0 dcnl dcsp model nasion 0 1 0 dcnl dcsp model rpa 1 0 0 dcnl dcsp assert false model can reset dcnl dcsp assert true model can save dcnl dcsp bem fname os path basename model bem file dcnl dcsp assert false model can reset dcnl dcsp assert equal bem fname sampleheaddense fif dcnl dcsp model save tgt fname dcnl dcsp assert equal model fid file tgt fname dcnl dcsp model fid file dcnl dcsp assert array equal model lpa 1 0 0 dcnl dcsp assert array equal model nasion 0 1 0 dcnl dcsp assert array equal model rpa 1 0 0 dcnl dcsp model lpa 0 0 0 dcnl dcsp model nasion 0 0 0 dcnl dcsp model rpa 0 0 0 dcnl dcsp assert array equal model lpa 0 0 0 dcnl dcsp assert array equal model nasion 0 0 0 dcnl dcsp assert array equal model rpa 0 0 0 dcnl dcsp model fid file tgt fname dcnl dcsp assert array equal model lpa 1 0 0 dcnl dcsp assert array equal model nasion 0 1 0 dcnl dcsp assert array equal model rpa 1 0 0 dcnl dcsp model nasion 1 1 1 dcnl dcsp assert true model can reset dcnl dcsp model reset true dcnl dcsp assert array equal model nasion 0 1 0
def make view coreg panel scrollable false dcsp view view vgroup item grow hair show label true item n scale params label mri dcsp scaling style custom show label true editor enumeditor values 0 1 none 1 2 uniform 3 3 3axis cols 4 vgrid item scale x editor laggy float editor show label true tooltip scale dcsp along dcsp rightleft dcsp axis enabled when n scale params dcsp dcsp 0 width + 50 item scale x dec enabled when n scale params dcsp dcsp 0 width 50 item scale x inc enabled when n scale params dcsp dcsp 0 width 50 item scale step tooltip scaling dcsp step enabled when n scale params dcsp dcsp 0 width + 50 item scale y editor laggy float editor show label true enabled when n scale params dcsp dcsp 1 tooltip scale dcsp along dcsp anteriorposterior dcsp axis width + 50 item scale y dec enabled when n scale params dcsp dcsp 1 width 50 item scale y inc enabled when n scale params dcsp dcsp 1 width 50 label step width + 50 item scale z editor laggy float editor show label true enabled when n scale params dcsp dcsp 1 tooltip scale dcsp along dcsp anteriorposterior dcsp axis width + 50 item scale z dec enabled when n scale params dcsp dcsp 1 width 50 item scale z inc enabled when n scale params dcsp dcsp 1 width 50 show labels false show border true label scaling columns 4 hgroup item fits hsp points enabled when n scale params tooltip rotate dcsp the dcsp digitizer dcsp head dcsp shape dcsp and dcsp scale dcsp the dcsp mri dcsp so dcsp as dcsp to dcsp minimize dcsp the dcsp distance dcsp from dcsp each dcsp digitizer dcsp point dcsp to dcsp the dcsp closest dcsp mri dcsp point item fits ap enabled when n scale params dcsp dcsp 1 tooltip while dcsp leaving dcsp the dcsp nasion dcsp in dcsp place dcsp rotate dcsp the dcsp digitizer dcsp head dcsp shape dcsp and dcsp scale dcsp the dcsp mri dcsp so dcsp as dcsp to dcsp minimize dcsp the dcsp distance dcsp of dcsp the dcsp two dcsp auricular dcsp points item fits fid enabled when n scale params dcsp dcsp 1 tooltip move dcsp and dcsp rotate dcsp the dcsp digitizer dcsp head dcsp shape dcsp and dcsp scale dcsp the dcsp mri dcsp so dcsp as dcsp to dcsp minimize dcsp the dcsp distance dcsp of dcsp the dcsp three dcsp fiducials show labels false vgrid item trans x editor laggy float editor show label true tooltip move dcsp along dcsp rightleft dcsp axis width + 50 item trans x dec width 50 item trans x inc width 50 item trans step tooltip movement dcsp step width + 50 item trans y editor laggy float editor show label true tooltip move dcsp along dcsp anteriorposterior dcsp axis width + 50 item trans y dec width 50 item trans y inc width 50 label step width + 50 item trans z editor laggy float editor show label true tooltip move dcsp along dcsp anteriorposterior dcsp axis width + 50 item trans z dec width 50 item trans z inc width 50 show labels false show border true label translation columns 4 vgrid item rot x editor laggy float editor show label true tooltip rotate dcsp along dcsp rightleft dcsp axis width + 50 item rot x dec width 50 item rot x inc width 50 item rot step tooltip rotation dcsp step width + 50 item rot y editor laggy float editor show label true tooltip rotate dcsp along dcsp anteriorposterior dcsp axis width + 50 item rot y dec width 50 item rot y inc width 50 label step width + 50 item rot z editor laggy float editor show label true tooltip rotate dcsp along dcsp anteriorposterior dcsp axis width + 50 item rot z dec width 50 item rot z inc width 50 show labels false show border true label rotation columns 4 hgroup item fit hsp points enabled when has pts data tooltip rotate dcsp the dcsp head dcsp shape dcsp around dcsp the dcsp nasion dcsp so dcsp as dcsp to dcsp minimize dcsp the dcsp distance dcsp from dcsp each dcsp head dcsp shape dcsp point dcsp to dcsp its dcsp closest dcsp mri dcsp point width 10 item fit ap enabled when has fid data tooltip try dcsp to dcsp match dcsp the dcsp lpa dcsp and dcsp the dcsp rpa dcsp leaving dcsp the dcsp nasion dcsp in dcsp place width 10 item fit fid enabled when has fid data tooltip move dcsp and dcsp rotate dcsp the dcsp head dcsp shape dcsp so dcsp as dcsp to dcsp minimize dcsp the dcsp distance dcsp between dcsp the dcsp mri dcsp and dcsp head dcsp shape dcsp fiducials width 10 show labels false hgroup item load trans width 10 spring show labels false item fid eval str style readonly item points eval str style readonly vgroup item scale labels label scale dcsp label dcsp files enabled when n scale params dcsp dcsp 0 item copy annot label copy dcsp annotation dcsp files enabled when n scale params dcsp dcsp 0 item prepare bem model label run dcsp mne prepare bem model enabled when can prepare bem model show left false label scaling dcsp options show border true hgroup item save enabled when can save tooltip save dcsp the dcsp trans dcsp file dcsp and dcsp if dcsp scaling dcsp is dcsp enabled dcsp the dcsp scaled dcsp mri item reset params tooltip reset dcsp all dcsp coregistration dcsp parameters show labels false item queue feedback style readonly item queue current style readonly item queue len str style readonly show labels false kind panel buttons undobutton scrollable scrollable dcnl dcsp return view
def make view tabbed false split false scene width 500 scene height 400 scrollable true dcsp scene vgroup item scene show label false editor sceneeditor scene class mayaviscene dock vertical width scene width height scene height vgroup item headview style custom view options show border true show labels false label view dcnl dcsp data panel vgroup vgroup item subject panel style custom label mri dcsp subject show border true show labels false vgroup item lock fiducials style custom editor enumeditor cols 2 values false 2 edit true 1 lock enabled when fid ok hgroup hsp always visible label always dcsp show dcsp head dcsp shape dcsp points show labels false item fid panel style custom label mri dcsp fiducials show border true show labels false vgroup item raw src style custom hgroup guess mri subject label guess dcsp mri dcsp subject dcsp from dcsp file dcsp name show labels false hgroup item distance show label false width 20 omit points reset omit points show labels false item omitted info style readonly show label false label head dcsp shape dcsp source dcsp raw epochs evoked digmontage show border true show labels false show labels false label data dcsp source dcnl dcsp coreg panel vgroup item coreg panel style custom width 410 if scrollable else 1 editor instanceeditor view make view coreg panel scrollable label coregistration show border not scrollable show labels false enabled when fid panel locked dcnl dcsp main layout split if split else normal dcnl dcsp if tabbed dcnl dcsp dcsp main hgroup scene group data panel coreg panel show labels false layout tabbed layout main layout dcnl dcsp else dcnl dcsp dcsp main hgroup data panel scene coreg panel show labels false layout main layout dcnl dcsp view view main resizable true handler coregframehandler buttons nobuttons width scene width height scene height dcnl dcsp return view
def testing mode dcsp return os getenv mne gui testing mode true
def read tooltips gui name dcsp dirname os path dirname file dcnl dcsp help path os path join dirname help gui name + json dcnl dcsp with open help path as fid dcnl dcsp dcsp raw tooltips json load fid dcnl dcsp format textwrapper width 60 fix sentence endings true fill dcnl dcsp return dict key format text for key text in raw tooltips items
def calc g cosang stiffness 4 num lterms 50 dcsp factors 2 n + 1 n stiffness n + 1 stiffness 4 np pi for n in range 1 num lterms + 1 dcnl dcsp return legval cosang 0 + factors
def make interpolation matrix pos from pos to alpha 1e05 dcsp pos from pos from copy dcnl dcsp pos to pos to copy dcnl dcsp normalize vectors pos from dcnl dcsp normalize vectors pos to dcnl dcsp cosang from pos from dot pos from t dcnl dcsp cosang to from pos to dot pos from t dcnl dcsp g from calc g cosang from dcnl dcsp g to from calc g cosang to from dcnl dcsp if alpha is not none dcnl dcsp dcsp g from flat len g from + 1 + alpha dcnl dcsp n channels g from shape0 dcnl dcsp c np r np c g from np ones n channels 1 np c np ones 1 n channels 0 dcnl dcsp c inv linalg pinv c dcnl dcsp interpolation np c g to from np ones g to from shape0 1 dot c inv 1 dcnl dcsp return interpolation
def do interp dots inst interpolation goods idx bads idx dcsp from io base import baseraw dcnl dcsp from epochs import baseepochs dcnl dcsp from evoked import evoked dcnl dcsp if isinstance inst baseraw evoked dcnl dcsp dcsp inst databads idx interpolation dot inst datagoods idx dcnl dcsp elif isinstance inst baseepochs dcnl dcsp dcsp inst data bads idx np einsum ij xjy xiy interpolation inst data goods idx dcnl dcsp else dcnl dcsp dcsp raise valueerror inputs dcsp of dcsp type dcsp 0 dcsp are dcsp not dcsp supported format type inst
def interpolate bads eeg inst dcsp bads idx np zeros len inst ch names dtype np bool dcnl dcsp goods idx np zeros len inst ch names dtype np bool dcnl dcsp picks pick types inst info meg false eeg true exclude dcnl dcsp inst info check consistency dcnl dcsp bads idxpicks inst ch namesch in inst info bads for ch in picks dcnl dcsp if len picks 0 or len bads idx 0 dcnl dcsp dcsp return dcnl dcsp goods idxpicks true dcnl dcsp goods idxbads idx false dcnl dcsp pos inst get channel positions picks dcnl dcsp bads idx pos bads idxpicks dcnl dcsp goods idx pos goods idxpicks dcnl dcsp pos good posgoods idx pos dcnl dcsp pos bad posbads idx pos dcnl dcsp radius center fit sphere pos good dcnl dcsp distance np sqrt np sum pos good center 2 1 dcnl dcsp distance np mean distance radius dcnl dcsp if np abs 1 0 distance 0 1 dcnl dcsp dcsp warn your dcsp spherical dcsp fit dcsp is dcsp poor dcsp interpolation dcsp results dcsp are dcsp likely dcsp to dcsp be dcsp inaccurate dcnl dcsp logger info computing dcsp interpolation dcsp matrix dcsp from dcsp 0 dcsp sensor dcsp positions format len pos good dcnl dcsp interpolation make interpolation matrix pos good pos bad dcnl dcsp logger info interpolating dcsp 0 dcsp sensors format len pos bad dcnl dcsp do interp dots inst interpolation goods idx bads idx
def interpolate bads meg inst mode accurate verbose none dcsp picks meg pick types inst info meg true eeg false exclude dcnl dcsp picks good pick types inst info meg true eeg false exclude bads dcnl dcsp meg ch names inst info ch names p for p in picks meg dcnl dcsp bads meg ch for ch in inst info bads if ch in meg ch names dcnl dcsp if len bads meg 0 dcnl dcsp dcsp picks bad dcnl dcsp else dcnl dcsp dcsp picks bad pick channels inst info ch names bads meg exclude dcnl dcsp if len picks meg 0 or len picks bad 0 dcnl dcsp dcsp return dcnl dcsp info from pick info inst info picks good dcnl dcsp info to pick info inst info picks bad dcnl dcsp mapping map meg channels info from info to mode mode dcnl dcsp do interp dots inst mapping picks good picks bad
def get meg system info dcsp system 306m dcnl dcsp for ch in info chs dcnl dcsp dcsp if ch kind fiff fiffv meg ch dcnl dcsp dcsp dcsp coil type ch coil type 65535 dcnl dcsp dcsp dcsp if coil type fiff fiffv coil nm 122 dcnl dcsp dcsp dcsp dcsp system 122m dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp elif coil type 1000 3 dcnl dcsp dcsp dcsp dcsp system 306m dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp elif coil type fiff fiffv coil magnes mag or coil type fiff fiffv coil magnes grad dcnl dcsp dcsp dcsp dcsp nmag np sum c kind fiff fiffv meg ch for c in info chs dcnl dcsp dcsp dcsp dcsp system magnes 3600wh if nmag 150 else magnes 2500wh dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp elif coil type fiff fiffv coil ctf grad dcnl dcsp dcsp dcsp dcsp system ctf 275 dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp elif coil type fiff fiffv coil kit grad dcnl dcsp dcsp dcsp dcsp system kit dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp elif coil type fiff fiffv coil baby grad dcnl dcsp dcsp dcsp dcsp system babysquid dcnl dcsp dcsp dcsp dcsp break dcnl dcsp return system
def contains ch type info ch type dcsp if not isinstance ch type string types dcnl dcsp dcsp raise valueerror ch type dcsp is dcsp of dcsp class dcsp actual class dcsp it dcsp must dcsp be dcsp str format actual class type ch type dcnl dcsp meg extras mag grad planar1 planar2 dcnl dcsp fnirs extras hbo hbr dcnl dcsp valid channel types sorted key for key in pick types keys if key meg + meg extras + fnirs extras dcnl dcsp if ch type not in valid channel types dcnl dcsp dcsp raise valueerror ch type dcsp must dcsp be dcsp one dcsp of dcsp s dcsp not dcsp s valid channel types ch type dcnl dcsp if info is none dcnl dcsp dcsp raise valueerror cannot dcsp check dcsp for dcsp channels dcsp of dcsp type dcsp s dcsp because dcsp info dcsp is dcsp none ch type dcnl dcsp return ch type in channel type info ii for ii in range info nchan
def get ch type inst ch type dcsp if ch type is none dcnl dcsp dcsp for type in mag grad planar1 planar2 eeg dcnl dcsp dcsp dcsp if type in inst dcnl dcsp dcsp dcsp dcsp ch type type dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise runtimeerror no dcsp plottable dcsp channel dcsp types dcsp found dcnl dcsp return ch type
verbose dcnl def equalize channels candidates verbose none dcsp from io base import baseraw dcnl dcsp from epochs import baseepochs dcnl dcsp from evoked import evoked dcnl dcsp from time frequency import averagetfr dcnl dcsp if not all isinstance c baseraw baseepochs evoked averagetfr for c in candidates dcnl dcsp dcsp raise valueerror candidates dcsp must dcsp be dcsp raw dcsp epochs dcsp evoked dcsp or dcsp averagetfr dcnl dcsp chan max idx np argmax c info nchan for c in candidates dcnl dcsp chan template candidateschan max idx ch names dcnl dcsp logger info identiying dcsp common dcsp channels dcsp dcnl dcsp channels set c ch names for c in candidates dcnl dcsp common channels set chan template intersection channels dcnl dcsp dropped list dcnl dcsp for c in candidates dcnl dcsp dcsp drop them list set c ch names common channels dcnl dcsp dcsp if drop them dcnl dcsp dcsp dcsp c drop channels drop them dcnl dcsp dcsp dcsp dropped extend drop them dcnl dcsp if dropped dcnl dcsp dcsp dropped list set dropped dcnl dcsp dcsp logger info dropped dcsp the dcsp following dcsp channels n s dropped dcnl dcsp else dcnl dcsp dcsp logger info all dcsp channels dcsp are dcsp corresponding dcsp nothing dcsp to dcsp do
def check set ch projs ch type dcsp new kind human2fiffch type dcnl dcsp if ch kind new kind dcnl dcsp dcsp for proj in projs dcnl dcsp dcsp dcsp if ch ch name in proj data col names dcnl dcsp dcsp dcsp dcsp raise runtimeerror cannot dcsp change dcsp channel dcsp type dcsp for dcsp channel dcsp s dcsp in dcsp projector dcsp s ch ch name proj desc dcnl dcsp ch kind new kind
def rename channels info mapping dcsp info check consistency dcnl dcsp bads list info bads dcnl dcsp ch names list info ch names dcnl dcsp if isinstance mapping dict dcnl dcsp dcsp orig names sorted list mapping keys dcnl dcsp dcsp missing orig name not in ch names for orig name in orig names dcnl dcsp dcsp if any missing dcnl dcsp dcsp dcsp raise valueerror channel dcsp name s dcsp in dcsp mapping dcsp missing dcsp from dcsp info dcsp s np array orig names np array missing dcnl dcsp dcsp new names ch names index ch name new name for ch name new name in mapping items dcnl dcsp elif callable mapping dcnl dcsp dcsp new names ci mapping ch name for ci ch name in enumerate ch names dcnl dcsp else dcnl dcsp dcsp raise valueerror mapping dcsp must dcsp be dcsp callable dcsp or dcsp dict dcsp not dcsp s type mapping dcnl dcsp if any not isinstance new name1 string types for new name in new names dcnl dcsp dcsp raise valueerror new dcsp channel dcsp mapping dcsp must dcsp only dcsp be dcsp to dcsp strings dcnl dcsp for c ind new name in new names dcnl dcsp dcsp for bi bad in enumerate bads dcnl dcsp dcsp dcsp if bad ch namesc ind dcnl dcsp dcsp dcsp dcsp badsbi new name dcnl dcsp dcsp ch namesc ind new name dcnl dcsp if len ch names len np unique ch names dcnl dcsp dcsp raise valueerror new dcsp channel dcsp names dcsp are dcsp not dcsp unique dcsp renaming dcsp failed dcnl dcsp info bads bads dcnl dcsp for ch ch name in zip info chs ch names dcnl dcsp dcsp ch ch name ch name dcnl dcsp info update redundant dcnl dcsp info check consistency
def recursive flatten cell dtype dcsp if len cell 0 dcnl dcsp dcsp while not isinstance cell0 dtype dcnl dcsp dcsp dcsp cell c for d in cell for c in d dcnl dcsp return cell
def read ch connectivity fname picks none dcsp from scipy io import loadmat dcnl dcsp if not op isabs fname dcnl dcsp dcsp templates dir op realpath op join op dirname file data neighbors dcnl dcsp dcsp templates os listdir templates dir dcnl dcsp dcsp for f in templates dcnl dcsp dcsp dcsp if f fname dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp if f fname + neighb mat dcnl dcsp dcsp dcsp dcsp fname + neighb mat dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror i dcsp do dcsp not dcsp know dcsp about dcsp this dcsp neighbor dcsp template dcsp format fname dcnl dcsp dcsp fname op join templates dir fname dcnl dcsp nb loadmat fname neighbours dcnl dcsp ch names recursive flatten nb label string types dcnl dcsp neighbors recursive flatten c string types for c in nb neighblabel flatten dcnl dcsp assert len ch names len neighbors dcnl dcsp if picks is not none dcnl dcsp dcsp if max picks len ch names dcnl dcsp dcsp dcsp raise valueerror the dcsp picks dcsp must dcsp be dcsp compatible dcsp with dcsp channels dcsp found dcsp a dcsp pick dcsp dcsp which dcsp exceeds dcsp the dcsp channel dcsp range dcsp format max picks len ch names dcnl dcsp connectivity ch neighbor connectivity ch names neighbors dcnl dcsp if picks is not none dcnl dcsp dcsp connectivity connectivitypicks picks dcnl dcsp dcsp ch names ch namesp for p in picks dcnl dcsp return connectivity ch names
def ch neighbor connectivity ch names neighbors dcsp if len ch names len neighbors dcnl dcsp dcsp raise valueerror ch names dcsp and dcsp neighbors dcsp must dcsp have dcsp the dcsp same dcsp length dcnl dcsp set neighbors set c for d in neighbors for c in d dcnl dcsp rest set neighbors set ch names dcnl dcsp if len rest 0 dcnl dcsp dcsp raise valueerror some dcsp of dcsp your dcsp neighbors dcsp are dcsp not dcsp present dcsp in dcsp the dcsp list dcsp of dcsp channel dcsp names dcnl dcsp for neigh in neighbors dcnl dcsp dcsp if not isinstance neigh list and not all isinstance c string types for c in neigh dcnl dcsp dcsp dcsp raise valueerror neighbors dcsp must dcsp be dcsp a dcsp list dcsp of dcsp lists dcsp of dcsp str dcnl dcsp ch connectivity np eye len ch names dtype bool dcnl dcsp for ii neigbs in enumerate neighbors dcnl dcsp dcsp ch connectivity ii ch names index i for i in neigbs true dcnl dcsp ch connectivity sparse csr matrix ch connectivity dcnl dcsp return ch connectivity
def find ch connectivity info ch type dcsp if ch type is none dcnl dcsp dcsp picks channel indices by type info dcnl dcsp dcsp if sum len p 0 for p in picks values 1 dcnl dcsp dcsp dcsp raise valueerror info dcsp must dcsp contain dcsp only dcsp one dcsp channel dcsp type dcsp if dcsp ch type dcsp is dcsp none dcnl dcsp dcsp ch type channel type info 0 dcnl dcsp elif ch type not in mag grad eeg dcnl dcsp dcsp raise valueerror ch type dcsp must dcsp be dcsp mag dcsp grad dcsp or dcsp eeg dcsp got dcsp s ch type dcnl dcsp has vv mag has vv grad is old vv has 4d mag ctf other types has ctf grad n kit grads has any meg has eeg coils has eeg coils and meg has eeg coils only get ch info info dcnl dcsp conn name none dcnl dcsp if has vv mag and ch type mag dcnl dcsp dcsp conn name neuromag306mag dcnl dcsp elif has vv grad and ch type grad dcnl dcsp dcsp conn name neuromag306planar dcnl dcsp elif has 4d mag dcnl dcsp dcsp if meg dcsp 248 in info ch names dcnl dcsp dcsp dcsp idx info ch names index meg dcsp 248 dcnl dcsp dcsp dcsp grad info chs idx coil type fiff fiffv coil magnes grad dcnl dcsp dcsp dcsp mag info chs idx coil type fiff fiffv coil magnes mag dcnl dcsp dcsp dcsp if ch type grad and grad dcnl dcsp dcsp dcsp dcsp conn name bti248grad dcnl dcsp dcsp dcsp elif ch type mag and mag dcnl dcsp dcsp dcsp dcsp conn name bti248 dcnl dcsp dcsp elif meg dcsp 148 in info ch names and ch type mag dcnl dcsp dcsp dcsp idx info ch names index meg dcsp 148 dcnl dcsp dcsp dcsp if info chs idx coil type fiff fiffv coil magnes mag dcnl dcsp dcsp dcsp dcsp conn name bti148 dcnl dcsp elif has ctf grad and ch type mag dcnl dcsp dcsp if info nchan < 100 dcnl dcsp dcsp dcsp conn name ctf64 dcnl dcsp dcsp elif info nchan 200 dcnl dcsp dcsp dcsp conn name ctf275 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp conn name ctf151 dcnl dcsp if conn name is not none dcnl dcsp dcsp logger info reading dcsp connectivity dcsp matrix dcsp for dcsp s conn name dcnl dcsp dcsp return read ch connectivity conn name dcnl dcsp logger info could dcsp not dcsp find dcsp a dcsp connectivity dcsp matrix dcsp for dcsp the dcsp data dcsp computing dcsp connectivity dcsp based dcsp on dcsp delaunay dcsp triangulations dcnl dcsp return compute ch connectivity info ch type
def compute ch connectivity info ch type dcsp from scipy spatial import delaunay dcnl dcsp from import spatial tris connectivity dcnl dcsp from channels layout import auto topomap coords pair grad sensors dcnl dcsp combine grads ch type grad and fiff fiffv coil vv planar t1 in np unique ch coil type for ch in info chs dcnl dcsp picks dict picks by type info exclude ch type dcnl dcsp ch names info ch names pick for pick in picks dcnl dcsp if combine grads dcnl dcsp dcsp pairs pair grad sensors info topomap coords false exclude dcnl dcsp dcsp if len pairs len picks dcnl dcsp dcsp dcsp raise runtimeerror cannot dcsp find dcsp a dcsp pair dcsp for dcsp some dcsp of dcsp the dcsp gradiometers dcsp cannot dcsp compute dcsp connectivity dcsp matrix dcnl dcsp dcsp xy auto topomap coords info picks 2 dcnl dcsp else dcnl dcsp dcsp xy auto topomap coords info picks dcnl dcsp tri delaunay xy dcnl dcsp neighbors spatial tris connectivity tri simplices dcnl dcsp if combine grads dcnl dcsp dcsp ch connectivity np eye len picks dtype bool dcnl dcsp dcsp for idx neigbs in zip neighbors row neighbors col dcnl dcsp dcsp dcsp for ii in range 2 dcnl dcsp dcsp dcsp dcsp for jj in range 2 dcnl dcsp dcsp dcsp dcsp dcsp ch connectivity idx 2 + ii neigbs 2 + jj true dcnl dcsp dcsp dcsp dcsp dcsp ch connectivity idx 2 + ii idx 2 + jj true dcnl dcsp dcsp ch connectivity sparse csr matrix ch connectivity dcnl dcsp else dcnl dcsp dcsp ch connectivity sparse csr matrix neighbors dcnl dcsp dcsp ch connectivity setdiag np repeat 1 ch connectivity shape0 dcnl dcsp return ch connectivity ch names
def fix mag coil types info dcsp old mag inds get t1t2 mag inds info dcnl dcsp for ii in old mag inds dcnl dcsp dcsp info chs ii coil type fiff fiffv coil vv mag t3 dcnl dcsp logger info d dcsp of dcsp d dcsp t1 t2 dcsp magnetometer dcsp types dcsp replaced dcsp with dcsp t3 len old mag inds len pick types info meg mag dcnl dcsp info check consistency
def get t1t2 mag inds info dcsp picks pick types info meg mag dcnl dcsp old mag inds dcnl dcsp for ii in picks dcnl dcsp dcsp ch info chs ii dcnl dcsp dcsp if ch coil type in fiff fiffv coil vv mag t1 fiff fiffv coil vv mag t2 dcnl dcsp dcsp dcsp old mag inds append ii dcnl dcsp return old mag inds
def get ch info info dcsp chs info chs dcnl dcsp coil types set ch coil type 65535 for ch in chs dcnl dcsp channel types set ch kind for ch in chs dcnl dcsp has vv mag any k in coil types for k in fiff fiffv coil vv mag t1 fiff fiffv coil vv mag t2 fiff fiffv coil vv mag t3 dcnl dcsp has vv grad any k in coil types for k in fiff fiffv coil vv planar t1 fiff fiffv coil vv planar t2 fiff fiffv coil vv planar t3 dcnl dcsp is old vv dcsp in chs0 ch name dcnl dcsp has 4d mag fiff fiffv coil magnes mag in coil types dcnl dcsp ctf other types fiff fiffv coil ctf ref mag fiff fiffv coil ctf ref grad fiff fiffv coil ctf offdiag ref grad dcnl dcsp has ctf grad fiff fiffv coil ctf grad in coil types or fiff fiffv meg ch in channel types and any k in ctf other types for k in coil types dcnl dcsp n kit grads sum ch coil type 65535 fiff fiffv coil kit grad for ch in chs dcnl dcsp has any meg any has vv mag has vv grad has 4d mag has ctf grad n kit grads dcnl dcsp has eeg coils fiff fiffv coil eeg in coil types and fiff fiffv eeg ch in channel types dcnl dcsp has eeg coils and meg has eeg coils and has any meg dcnl dcsp has eeg coils only has eeg coils and not has any meg dcnl dcsp return has vv mag has vv grad is old vv has 4d mag ctf other types has ctf grad n kit grads has any meg has eeg coils has eeg coils and meg has eeg coils only
def get test info dcsp test info empty info 1000 dcnl dcsp loc np array 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 dtype np float32 dcnl dcsp test info chs cal 1 ch name ica dcsp 001 coil type 0 coord frame 0 kind 502 loc loc copy logno 1 range 1 0 scanno 1 unit 1 unit mul 0 cal 1 ch name ica dcsp 002 coil type 0 coord frame 0 kind 502 loc loc copy logno 2 range 1 0 scanno 2 unit 1 unit mul 0 cal 0 002142000012099743 ch name eog dcsp 061 coil type 1 coord frame 0 kind 202 loc loc copy logno 61 range 1 0 scanno 376 unit 107 unit mul 0 dcnl dcsp test info update redundant dcnl dcsp test info check consistency dcnl dcsp return test info
def test io layout lout dcsp tempdir tempdir dcnl dcsp layout read layout vectorviewall scale false dcnl dcsp layout save op join tempdir foobar lout dcnl dcsp layout read read layout op join tempdir foobar lout path scale false dcnl dcsp assert array almost equal layout pos layout read pos decimal 2 dcnl dcsp assert true layout names layout read names dcnl dcsp print layout
def test io layout lay dcsp tempdir tempdir dcnl dcsp layout read layout ctf151 scale false dcnl dcsp layout save op join tempdir foobar lay dcnl dcsp layout read read layout op join tempdir foobar lay path scale false dcnl dcsp assert array almost equal layout pos layout read pos decimal 2 dcnl dcsp assert true layout names layout read names
def test auto topomap coords dcsp info read info fif fname dcnl dcsp picks pick types info meg false eeg true eog false stim false dcnl dcsp del info dig 85 dcnl dcsp dig kinds fiff fiffv point cardinal fiff fiffv point eeg fiff fiffv point extra dcnl dcsp origin head fit sphere to headshape info dig kinds units m dcnl dcsp for ch in info chs dcnl dcsp dcsp ch loc 3 origin head dcnl dcsp l0 auto topomap coords info picks dcnl dcsp for ch in info chs dcnl dcsp dcsp ch loc fill 0 dcnl dcsp l1 auto topomap coords info picks dcnl dcsp assert allclose l1 l0 atol 0 001 dcnl dcsp mag picks pick types info meg mag dcnl dcsp assert raises valueerror auto topomap coords info mag picks dcnl dcsp info dig append r 1 2 3 kind fiff fiffv point eeg dcnl dcsp assert raises valueerror auto topomap coords info picks dcnl dcsp info dig info dig 2 dcnl dcsp assert raises valueerror auto topomap coords info picks dcnl dcsp info dig append info dig 1 dcnl dcsp assert raises valueerror auto topomap coords info picks dcnl dcsp info dig d for d in info dig if d kind fiff fiffv point eeg dcnl dcsp assert raises runtimeerror auto topomap coords info picks dcnl dcsp info dig none dcnl dcsp assert raises runtimeerror auto topomap coords info picks dcnl dcsp info dig dcnl dcsp assert raises runtimeerror auto topomap coords info picks
def test make eeg layout dcsp tempdir tempdir dcnl dcsp tmp name foo dcnl dcsp lout name test raw dcnl dcsp lout orig read layout kind lout name path lout path dcnl dcsp info read info fif fname dcnl dcsp info bads append info ch names 360 dcnl dcsp layout make eeg layout info exclude dcnl dcsp assert array equal len layout names len ch for ch in info ch names if ch startswith ee dcnl dcsp layout save op join tempdir tmp name + lout dcnl dcsp lout new read layout kind tmp name path tempdir scale false dcnl dcsp assert array equal lout new kind tmp name dcnl dcsp assert allclose layout pos lout new pos atol 0 1 dcnl dcsp assert array equal lout orig names lout new names dcnl dcsp assert raises valueerror make eeg layout info radius 0 1 dcnl dcsp assert raises valueerror make eeg layout info radius 0 6 dcnl dcsp assert raises valueerror make eeg layout info width 0 1 dcnl dcsp assert raises valueerror make eeg layout info width 1 1 dcnl dcsp assert raises valueerror make eeg layout info height 0 1 dcnl dcsp assert raises valueerror make eeg layout info height 1 1
def test make grid layout dcsp tempdir tempdir dcnl dcsp tmp name bar dcnl dcsp lout name test ica dcnl dcsp lout orig read layout kind lout name path lout path dcnl dcsp layout make grid layout get test info dcnl dcsp layout save op join tempdir tmp name + lout dcnl dcsp lout new read layout kind tmp name path tempdir dcnl dcsp assert array equal lout new kind tmp name dcnl dcsp assert array equal lout orig pos lout new pos dcnl dcsp assert array equal lout orig names lout new names dcnl dcsp layout make grid layout get test info n col 2 dcnl dcsp assert true layout pos 0 1 layout pos 1 1 dcnl dcsp assert true layout pos 0 0 layout pos 1 0 dcnl dcsp assert array equal layout pos0 3 layout pos1 3
def test find layout dcsp import matplotlib pyplot as plt dcnl dcsp assert raises valueerror find layout get test info ch type meep dcnl dcsp sample info read info fif fname dcnl dcsp grads pick types sample info meg grad dcnl dcsp sample info2 pick info sample info grads dcnl dcsp mags pick types sample info meg mag dcnl dcsp sample info3 pick info sample info mags dcnl dcsp sample info4 copy deepcopy sample info dcnl dcsp for ii name in enumerate sample info4 ch names dcnl dcsp dcsp new name replace dcsp dcnl dcsp dcsp sample info4 chs ii ch name new dcnl dcsp eegs pick types sample info meg false eeg true dcnl dcsp sample info5 pick info sample info eegs dcnl dcsp lout find layout sample info ch type none dcnl dcsp assert equal lout kind vectorviewall dcnl dcsp assert true all dcsp in k for k in lout names dcnl dcsp lout find layout sample info2 ch type meg dcnl dcsp assert equal lout kind vectorviewall dcnl dcsp lout find layout sample info4 ch type none dcnl dcsp assert equal lout kind vectorviewall dcnl dcsp assert true all dcsp not in k for k in lout names dcnl dcsp lout find layout sample info ch type grad dcnl dcsp assert equal lout kind vectorviewgrad dcnl dcsp lout find layout sample info2 dcnl dcsp assert equal lout kind vectorviewgrad dcnl dcsp lout find layout sample info2 ch type grad dcnl dcsp assert equal lout kind vectorviewgrad dcnl dcsp lout find layout sample info2 ch type meg dcnl dcsp assert equal lout kind vectorviewall dcnl dcsp lout find layout sample info ch type mag dcnl dcsp assert equal lout kind vectorviewmag dcnl dcsp lout find layout sample info3 dcnl dcsp assert equal lout kind vectorviewmag dcnl dcsp lout find layout sample info3 ch type mag dcnl dcsp assert equal lout kind vectorviewmag dcnl dcsp lout find layout sample info3 ch type meg dcnl dcsp assert equal lout kind vectorviewall dcnl dcsp lout find layout sample info ch type eeg dcnl dcsp assert equal lout kind eeg dcnl dcsp lout find layout sample info5 dcnl dcsp assert equal lout kind eeg dcnl dcsp lout find layout sample info5 ch type eeg dcnl dcsp assert equal lout kind eeg dcnl dcsp lout find layout read info fname ctf raw dcnl dcsp assert equal lout kind ctf275 dcnl dcsp fname bti raw op join bti dir exported4d linux raw fif dcnl dcsp lout find layout read info fname bti raw dcnl dcsp assert equal lout kind magneswh3600 dcnl dcsp raw kit read raw kit fname kit 157 dcnl dcsp lout find layout raw kit info dcnl dcsp assert equal lout kind kit157 dcnl dcsp raw kit info bads meg dcsp dcsp 13 meg dcsp dcsp 14 meg dcsp dcsp 15 meg dcsp dcsp 16 dcnl dcsp lout find layout raw kit info dcnl dcsp assert equal lout kind kit157 dcnl dcsp raw umd read raw kit fname kit umd dcnl dcsp lout find layout raw umd info dcnl dcsp assert equal lout kind kitumd3 dcnl dcsp lout plot dcnl dcsp lout plot picks np arange 10 dcnl dcsp plt close all
def test box size dcsp assert allclose box size 1 0 1 0 dcnl dcsp point 0 0 dcnl dcsp assert allclose box size point 1 0 1 0 dcnl dcsp points 0 25 0 5 0 75 0 5 dcnl dcsp assert allclose box size points 0 5 1 0 dcnl dcsp points 0 25 0 25 0 75 0 25 0 5 0 75 dcnl dcsp assert allclose box size points 0 5 0 5 dcnl dcsp x y np meshgrid np linspace 0 5 0 5 11 np linspace 0 5 0 5 11 dcnl dcsp x y x ravel y ravel dcnl dcsp assert allclose box size np c x y 0 1 0 1 dcnl dcsp rng np random randomstate 42 dcnl dcsp points rng rand 100 2 dcnl dcsp width height box size points dcnl dcsp assert true width is not none dcnl dcsp assert true height is not none dcnl dcsp points 0 25 0 25 0 75 0 25 0 5 0 75 dcnl dcsp assert allclose box size points width 0 4 0 4 0 5 dcnl dcsp points 0 25 0 25 0 75 0 25 0 5 0 75 dcnl dcsp assert allclose box size points width 0 2 0 2 1 0 dcnl dcsp points 0 25 0 25 0 75 0 25 0 5 0 75 dcnl dcsp assert allclose box size points height 0 4 0 5 0 4 dcnl dcsp points 0 25 0 25 0 75 0 45 0 5 0 75 dcnl dcsp assert allclose box size points height 0 1 1 0 0 1 dcnl dcsp points 0 25 0 25 0 75 0 45 0 5 0 75 dcnl dcsp assert array equal box size points width 0 1 height 0 1 0 1 0 1 dcnl dcsp points 0 25 0 25 0 75 0 25 0 5 0 75 dcnl dcsp assert array equal box size points width 1 1 0 dcnl dcsp points 0 25 0 25 0 75 0 25 0 5 0 75 dcnl dcsp assert allclose box size points padding 0 1 0 9 0 5 0 9 0 5
def test generate 2d layout dcsp snobg 10 dcnl dcsp sbg 15 dcnl dcsp side range snobg dcnl dcsp bg image np random randomstate 42 randn sbg sbg dcnl dcsp w h 0 2 0 5 dcnl dcsp xy np array i j for i in side for j in side dcnl dcsp lt generate 2d layout xy w w h h dcnl dcsp comp 1 comp 2 5 0 7 0 dcnl dcsp assert true lt pos 2 max 1 dcnl dcsp assert true lt pos 2 min 0 dcnl dcsp with np errstate invalid ignore dcnl dcsp dcsp assert allclose xycomp 2 float xycomp 1 lt poscomp 2 float lt poscomp 1 dcnl dcsp assert allclose lt pos 0 2 3 w h dcnl dcsp assert true lt pos shape1 4 dcnl dcsp assert true len lt box 4 dcnl dcsp lt bg generate 2d layout xy bg image bg image dcnl dcsp assert allclose lt bg pos 2 max xy max float sbg
def load data dcsp raw io read raw fif raw fname dcnl dcsp events read events event name dcnl dcsp picks eeg pick types raw info meg false eeg true exclude dcnl dcsp picks meg pick types raw info meg true eeg false exclude 1 2 dcnl dcsp picks pick types raw info meg true eeg true exclude dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp epochs eeg epochs raw events event id tmin tmax picks picks eeg preload true reject dict eeg 8e05 dcnl dcsp dcsp epochs meg epochs raw events event id tmin tmax picks picks meg preload true reject dict grad 1e09 mag 4e12 dcnl dcsp dcsp epochs epochs raw events event id tmin tmax picks picks preload true reject dict eeg 8e05 grad 1e09 mag 4e12 dcnl dcsp return raw epochs epochs eeg epochs meg
slow test dcnl def test interpolation dcsp raw epochs epochs eeg epochs meg load data dcnl dcsp thresh 0 8 dcnl dcsp epochs eeg info bads dcnl dcsp goods idx np ones len epochs eeg ch names dtype bool dcnl dcsp goods idxepochs eeg ch names index eeg dcsp 012 false dcnl dcsp bads idx ~ goods idx dcnl dcsp evoked eeg epochs eeg average dcnl dcsp ave before evoked eeg databads idx dcnl dcsp pos epochs eeg get channel positions dcnl dcsp pos good posgoods idx dcnl dcsp pos bad posbads idx dcnl dcsp interpolation make interpolation matrix pos good pos bad dcnl dcsp assert equal interpolation shape 1 len epochs eeg ch names 1 dcnl dcsp ave after np dot interpolation evoked eeg datagoods idx dcnl dcsp epochs eeg info bads eeg dcsp 012 dcnl dcsp evoked eeg epochs eeg average dcnl dcsp assert array equal ave after evoked eeg interpolate bads databads idx dcnl dcsp assert allclose ave before ave after atol 2e06 dcnl dcsp epochs eeg preload false dcnl dcsp assert raises valueerror epochs eeg interpolate bads dcnl dcsp epochs eeg preload true dcnl dcsp raw eeg io rawarray data epochs eeg data0 info epochs eeg info dcnl dcsp raw before raw eeg databads idx dcnl dcsp raw after raw eeg interpolate bads databads idx dcnl dcsp assert equal np all raw before raw after false dcnl dcsp for inst in raw epochs dcnl dcsp dcsp assert hasattr inst preload dcnl dcsp dcsp inst preload false dcnl dcsp dcsp inst info bads inst ch names1 dcnl dcsp dcsp assert raises valueerror inst interpolate bads dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp raw rename channels meg dcsp 0113 trigger dcnl dcsp dcsp raw set channel types trigger stim dcnl dcsp dcsp raw info bads raw info ch names 1 dcnl dcsp dcsp raw load data dcnl dcsp dcsp raw interpolate bads dcnl dcsp epochs meg info bads meg dcsp 0141 dcnl dcsp evoked epochs meg average dcnl dcsp pick pick channels epochs meg info ch names epochs meg info bads dcnl dcsp raw meg io rawarray data epochs meg data0 info epochs meg info dcnl dcsp raw meg info bads meg dcsp 0141 dcnl dcsp data1 raw megpick 00 dcnl dcsp raw meg info normalize proj dcnl dcsp data2 raw meg interpolate bads reset bads false pick 00 dcnl dcsp assert true np corrcoef data1 data2 0 1 thresh dcnl dcsp assert true len raw meg info bads len raw meg info bads dcnl dcsp data1 epochs meg get data pick ravel dcnl dcsp epochs meg info normalize proj dcnl dcsp epochs meg interpolate bads dcnl dcsp data2 epochs meg get data pick ravel dcnl dcsp assert true np corrcoef data1 data2 0 1 thresh dcnl dcsp assert true len epochs meg info bads 0 dcnl dcsp data1 evoked datapick dcnl dcsp evoked info normalize proj dcnl dcsp data2 evoked interpolate bads datapick dcnl dcsp assert true np corrcoef data1 data2 0 1 thresh
def test montage dcsp tempdir tempdir dcnl dcsp inputs dict sfp fidnz dcsp 0 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 9 071585155 dcsp dcsp dcsp dcsp dcsp 2 359754454 nfidt9 dcsp 6 711765 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 0 040402876 dcsp dcsp dcsp dcsp dcsp 3 251600355 nvery very very long name dcsp 5 831241498 dcsp 4 494821698 dcsp dcsp 4 955347697 ncz dcsp 0 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 0 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 8 899186843 csd dcsp matlab dcsp dcsp dcsp sphere dcsp coordinates dcsp degrees dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp cartesian dcsp coordinates n dcsp label dcsp dcsp dcsp dcsp dcsp dcsp dcsp theta dcsp dcsp dcsp dcsp dcsp dcsp dcsp phi dcsp dcsp dcsp dcsp radius dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp x dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp y dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp z dcsp dcsp dcsp dcsp dcsp dcsp dcsp off dcsp sphere dcsp surface ne1 dcsp dcsp dcsp dcsp dcsp dcsp 37 700 dcsp dcsp dcsp dcsp dcsp 14 000 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1 000 dcsp dcsp dcsp dcsp 0 7677 dcsp dcsp dcsp dcsp 0 5934 dcsp dcsp dcsp 0 2419 dcsp dcsp 0 00000000000000011 ne3 dcsp dcsp dcsp dcsp dcsp dcsp 51 700 dcsp dcsp dcsp dcsp dcsp dcsp 11 000 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1 000 dcsp dcsp dcsp dcsp 0 6084 dcsp dcsp dcsp dcsp 0 7704 dcsp dcsp dcsp dcsp 0 1908 dcsp dcsp dcsp 0 00000000000000000 ne31 dcsp dcsp dcsp dcsp dcsp dcsp 90 000 dcsp dcsp dcsp dcsp dcsp 11 000 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1 000 dcsp dcsp dcsp dcsp 0 0000 dcsp dcsp dcsp dcsp 0 9816 dcsp dcsp dcsp 0 1908 dcsp dcsp dcsp 0 00000000000000000 ne61 dcsp dcsp dcsp dcsp dcsp 158 000 dcsp dcsp dcsp dcsp dcsp 17 200 dcsp dcsp dcsp dcsp dcsp dcsp dcsp 1 000 dcsp dcsp dcsp 0 8857 dcsp dcsp dcsp dcsp 0 3579 dcsp dcsp dcsp 0 2957 dcsp dcsp 0 00000000000000022 mm elc dcsp asa dcsp electrode dcsp file nreferencelabel dcsp dcsp avg nunitposition dcsp dcsp dcsp dcsp mm nnumberpositions dcsp dcsp dcsp dcsp 68 npositions n86 0761 dcsp 19 9897 dcsp 47 9860 n85 7939 dcsp 20 0093 dcsp 48 0310 n0 0083 dcsp 86 8110 dcsp 39 9830 n86 0761 dcsp 24 9897 dcsp 67 9860 nlabels nlpa nrpa nnz ndummy n m elc dcsp asa dcsp electrode dcsp file nreferencelabel dcsp dcsp avg nunitposition dcsp dcsp dcsp dcsp m nnumberpositions dcsp dcsp dcsp dcsp 68 npositions n 0860761 dcsp 0199897 dcsp 0479860 n 0857939 dcsp 0200093 dcsp 0480310 n 0000083 dcsp 00868110 dcsp 0399830 n 08 dcsp 02 dcsp 04 nlabels nlpa nrpa nnz ndummy n txt site dcsp dcsp theta dcsp dcsp phi nfp1 dcsp dcsp 92 dcsp dcsp dcsp dcsp 72 nfp2 dcsp dcsp dcsp 92 dcsp dcsp dcsp dcsp dcsp 72 nvery very very long name dcsp dcsp dcsp dcsp dcsp dcsp dcsp 92 dcsp dcsp dcsp dcsp dcsp 72 no2 dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp 92 dcsp dcsp dcsp dcsp 90 n elp 346 neeg dctb dcsp dcsp dcsp dcsp dcsp dcsp f3 dctb dcsp 62 027 dctb dcsp 50 053 dctb dcsp dcsp dcsp dcsp dcsp dcsp 85 neeg dctb dcsp dcsp dcsp dcsp dcsp dcsp fz dctb dcsp dcsp 45 608 dctb dcsp dcsp dcsp dcsp dcsp dcsp 90 dctb dcsp dcsp dcsp dcsp dcsp dcsp 85 neeg dctb dcsp dcsp dcsp dcsp dcsp dcsp f4 dctb dcsp dcsp dcsp 62 01 dctb dcsp dcsp 50 103 dctb dcsp dcsp dcsp dcsp dcsp dcsp 85 neeg dctb dcsp dcsp dcsp dcsp dcsp dcsp fcz dctb dcsp dcsp dcsp 68 01 dctb dcsp dcsp 58 103 dctb dcsp dcsp dcsp dcsp dcsp dcsp 85 n hpts eeg dcsp fp1 dcsp 95 0 dcsp 3 dcsp 3 neeg dcsp af7 dcsp 1 dcsp 1 dcsp 3 neeg dcsp a3 dcsp 2 dcsp 2 dcsp 2 neeg dcsp a dcsp 0 dcsp 0 dcsp 0 bvef < xml dcsp version 1 0 dcsp encoding utf8 dcsp standalone yes n< dcsp generated dcsp by dcsp easycap dcsp configurator dcsp 19 05 2014 dcsp n<electrodes dcsp defaults false n dcsp dcsp <electrode n dcsp dcsp dcsp dcsp <name fp1< name n dcsp dcsp dcsp dcsp <theta 90< theta n dcsp dcsp dcsp dcsp <phi 72< phi n dcsp dcsp dcsp dcsp <radius 1< radius n dcsp dcsp dcsp dcsp <number 1< number n dcsp dcsp < electrode n dcsp dcsp <electrode n dcsp dcsp dcsp dcsp <name fz< name n dcsp dcsp dcsp dcsp <theta 45< theta n dcsp dcsp dcsp dcsp <phi 90< phi n dcsp dcsp dcsp dcsp <radius 1< radius n dcsp dcsp dcsp dcsp <number 2< number n dcsp dcsp < electrode n dcsp dcsp <electrode n dcsp dcsp dcsp dcsp <name f3< name n dcsp dcsp dcsp dcsp <theta 60< theta n dcsp dcsp dcsp dcsp <phi 51< phi n dcsp dcsp dcsp dcsp <radius 1< radius n dcsp dcsp dcsp dcsp <number 3< number n dcsp dcsp < electrode n dcsp dcsp <electrode n dcsp dcsp dcsp dcsp <name f7< name n dcsp dcsp dcsp dcsp <theta 90< theta n dcsp dcsp dcsp dcsp <phi 36< phi n dcsp dcsp dcsp dcsp <radius 1< radius n dcsp dcsp dcsp dcsp <number 4< number n dcsp dcsp < electrode n< electrodes dcnl dcsp poss dict sfp 0 0 9 07159 2 35975 6 71176 0 0404 3 2516 5 83124 4 49482 4 95535 0 0 0 0 8 89919 mm elc 0 08608 0 01999 0 04799 0 08579 0 02001 0 04803 1e05 0 08681 0 03998 0 08608 0 02499 0 06799 m elc 0 08608 0 01999 0 04799 0 08579 0 02001 0 04803 1e05 0 00868 0 03998 0 08 0 02 0 04 txt 26 25044 80 79056 2 96646 26 25044 80 79056 2 96646 26 25044 80 79056 2 96646 0 0 84 94822 2 96646 elp 48 20043 57 55106 39 86971 0 0 60 73848 59 4629 48 1426 57 58403 39 89198 41 64599 66 91489 31 8278 hpts 95 3 3 1 1 0 3 0 2 2 2 0 0 0 0 bvef 26 266444 80 839803 5 204748e15 3 680313e15 60 104076 60 104076 46 325632 57 207392 42 5 68 766444 49 961746 5 204748e15 dcnl dcsp for key text in inputs items dcnl dcsp dcsp kind key split 1 dcnl dcsp dcsp fname op join tempdir test + kind dcnl dcsp dcsp with open fname w as fid dcnl dcsp dcsp dcsp fid write text dcnl dcsp dcsp montage read montage fname dcnl dcsp dcsp if kind in sfp txt dcnl dcsp dcsp dcsp assert true very very very long name in montage ch names dcnl dcsp dcsp assert equal len montage ch names 4 dcnl dcsp dcsp assert equal len montage ch names len montage pos dcnl dcsp dcsp assert equal montage pos shape 4 3 dcnl dcsp dcsp assert equal montage kind test dcnl dcsp dcsp if kind csd dcnl dcsp dcsp dcsp dtype label s4 theta f8 phi f8 radius f8 x f8 y f8 z f8 off sph f8 dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp table np loadtxt fname skip header 2 dtype dtype dcnl dcsp dcsp dcsp except typeerror dcnl dcsp dcsp dcsp dcsp table np loadtxt fname skiprows 2 dtype dtype dcnl dcsp dcsp dcsp poss csd np c table x table y table z dcnl dcsp dcsp if kind elc dcnl dcsp dcsp dcsp centroid np sum montage pos axis 0 montage pos shape0 dcnl dcsp dcsp dcsp distance from centroid np apply along axis np linalg norm 1 montage pos centroid dcnl dcsp dcsp dcsp assert array less distance from centroid 0 2 dcnl dcsp dcsp dcsp assert array less 0 01 distance from centroid dcnl dcsp dcsp assert array almost equal posskey montage pos 4 err msg key dcnl dcsp ch names f3 fz f4 fc3 fcz fc4 c3 cz c4 cp3 cpz cp4 p3 pz p4 o1 oz o2 dcnl dcsp montage read montage standard 1020 ch names ch names dcnl dcsp assert array equal ch names montage ch names dcnl dcsp input strs n dcsp dcsp dcsp dcsp eeg dcsp fp1 dcsp 95 0 dcsp 31 0 dcsp 3 0 n dcsp dcsp dcsp dcsp eeg dcsp af7 dcsp 81 dcsp 59 dcsp 3 n dcsp dcsp dcsp dcsp eeg dcsp af3 dcsp 87 dcsp 41 dcsp 28 n dcsp dcsp dcsp dcsp cardinal dcsp 2 dcsp 91 dcsp 0 dcsp 42 n dcsp dcsp dcsp dcsp cardinal dcsp 1 dcsp 0 dcsp 91 dcsp 42 n dcsp dcsp dcsp dcsp cardinal dcsp 3 dcsp 0 dcsp 91 dcsp 42 n dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp fp1 dcsp 95 0 dcsp 31 0 dcsp 3 0 n dcsp dcsp dcsp dcsp af7 dcsp 81 dcsp 59 dcsp 3 n dcsp dcsp dcsp dcsp af3 dcsp 87 dcsp 41 dcsp 28 n dcsp dcsp dcsp dcsp nasion dcsp 91 dcsp 0 dcsp 42 n dcsp dcsp dcsp dcsp lpa dcsp 0 dcsp 91 dcsp 42 n dcsp dcsp dcsp dcsp rpa dcsp 0 dcsp 91 dcsp 42 n dcsp dcsp dcsp dcsp dcnl dcsp all fiducials 2 1 3 nasion lpa rpa dcnl dcsp kinds test fid hpts test fid sfp dcnl dcsp for kind fiducials input str in zip kinds all fiducials input strs dcnl dcsp dcsp fname op join tempdir kind dcnl dcsp dcsp with open fname w as fid dcnl dcsp dcsp dcsp fid write input str dcnl dcsp dcsp montage read montage op join tempdir kind transform true dcnl dcsp dcsp pos np array 95 0 31 0 3 0 dcnl dcsp dcsp nasion np array 91 0 42 dcnl dcsp dcsp lpa np array 0 91 42 dcnl dcsp dcsp rpa np array 0 91 42 dcnl dcsp dcsp fids np vstack nasion lpa rpa dcnl dcsp dcsp trans get ras to neuromag trans fids0 fids1 fids2 dcnl dcsp dcsp pos apply trans trans pos dcnl dcsp dcsp assert array equal montage pos0 pos dcnl dcsp dcsp idx montage ch names index fiducials0 dcnl dcsp dcsp assert array equal montage pos idx 0 2 0 0 dcnl dcsp dcsp idx montage ch names index fiducials1 dcnl dcsp dcsp assert array equal montage pos idx 1 2 0 0 dcnl dcsp dcsp idx montage ch names index fiducials2 dcnl dcsp dcsp assert array equal montage pos idx 1 2 0 0 dcnl dcsp dcsp pos np array 95 0 31 0 3 0 dcnl dcsp dcsp montage fname op join tempdir kind dcnl dcsp dcsp montage read montage montage fname unit mm dcnl dcsp dcsp assert array equal montage pos0 pos 0 001 dcnl dcsp dcsp info create info montage ch names 1000 0 eeg len montage ch names dcnl dcsp dcsp set montage info montage dcnl dcsp dcsp pos2 np array c loc 3 for c in info chs dcnl dcsp dcsp assert array equal pos2 montage pos dcnl dcsp dcsp assert equal montage ch names info ch names dcnl dcsp dcsp info create info montage ch names 1000 0 eeg len montage ch names dcnl dcsp dcsp evoked evokedarray data np zeros len montage ch names 1 info info tmin 0 dcnl dcsp dcsp assert true isinstance evoked set montage montage type evoked dcnl dcsp dcsp pos3 np array c loc 3 for c in evoked info chs dcnl dcsp dcsp assert array equal pos3 montage pos dcnl dcsp dcsp assert equal montage ch names evoked info ch names dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp info create info montage ch names + foo bar 1000 0 eeg len montage ch names + 2 dcnl dcsp dcsp dcsp set montage info montage dcnl dcsp dcsp dcsp assert true len w 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp info create info fp1 af7 af3 1000 0 eeg 3 dcnl dcsp dcsp set montage info montage dcnl dcsp dcsp assert true len w 0 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp info create info fp1 fp1 af3 1000 0 eeg 3 dcnl dcsp dcsp set montage info montage dcnl dcsp dcsp assert true len w 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp montage ch names fp1 fp1 af3 dcnl dcsp dcsp info create info fp1 af3 1000 0 eeg eeg dcnl dcsp dcsp set montage info montage dcnl dcsp dcsp assert true len w 1 dcnl dcsp montage read montage standard 1020 dcnl dcsp c3 montage get pos2d montage ch names index c3 dcnl dcsp c4 montage get pos2d montage ch names index c4 dcnl dcsp fz montage get pos2d montage ch names index fz dcnl dcsp oz montage get pos2d montage ch names index oz dcnl dcsp f1 montage get pos2d montage ch names index f1 dcnl dcsp assert true c30 < 0 dcnl dcsp assert true c40 0 dcnl dcsp assert true fz1 0 dcnl dcsp assert true oz1 < 0 dcnl dcsp assert allclose fz0 0 atol 0 01 dcnl dcsp assert allclose oz0 0 atol 0 01 dcnl dcsp assert true f10 < 0 and f11 0 dcnl dcsp montages get builtin montages dcnl dcsp assert true len montages 0 dcnl dcsp assert true standard 1020 in montages dcnl dcsp assert true standard 1005 in montages
testing requires testing data dcnl def test read locs dcsp pos read montage locs montage fname pos dcnl dcsp expected 0 0 0 999779165 0 0210157875 0 308738197 0 727341573 0 612907052 0 567059636 0 677066318 0 469067752 0 0 0 714575231 0 699558616 dcnl dcsp assert allclose pos 4 expected atol 1e07
def test read dig montage dcsp names nasion lpa rpa 1 2 3 4 5 dcnl dcsp montage read dig montage hsp hpi elp names transform false dcnl dcsp elp points read dig points elp dcnl dcsp hsp points read dig points hsp dcnl dcsp hpi points read mrk hpi dcnl dcsp assert equal montage point names names dcnl dcsp assert array equal montage elp elp points dcnl dcsp assert array equal montage hsp hsp points dcnl dcsp assert array equal montage hpi hpi points dcnl dcsp assert true montage dev head t is none dcnl dcsp montage read dig montage hsp hpi elp names transform true dev head t true dcnl dcsp assert almost equal montage nasion0 0 dcnl dcsp assert almost equal montage nasion2 0 dcnl dcsp assert allclose montage lpa1 0 atol 1e16 dcnl dcsp assert allclose montage rpa1 0 atol 1e16 dcnl dcsp dev head t fit matched points tgt pts montage elp src pts montage hpi out trans dcnl dcsp assert array equal montage dev head t dev head t dcnl dcsp m2 read dig montage hsp points hpi points elp points names unit m dcnl dcsp assert array equal m2 hsp montage hsp dcnl dcsp m3 read dig montage hsp points 1000 hpi points elp points 1000 names dcnl dcsp assert allclose m3 hsp montage hsp dcnl dcsp tempdir tempdir dcnl dcsp mat hsp op join tempdir test mat dcnl dcsp savemat mat hsp dict points 1000 hsp points t dcnl dcsp montage cm read dig montage mat hsp hpi elp names unit cm dcnl dcsp assert allclose montage cm hsp montage hsp 10 0 dcnl dcsp assert allclose montage cm elp montage elp 10 0 dcnl dcsp assert array equal montage cm hpi montage hpi dcnl dcsp assert raises valueerror read dig montage hsp hpi elp names unit km dcnl dcsp extra hsp op join tempdir test txt dcnl dcsp with open hsp rb as fin dcnl dcsp dcsp with open extra hsp wb as fout dcnl dcsp dcsp dcsp for line in fin dcnl dcsp dcsp dcsp dcsp if line startswith dcnl dcsp dcsp dcsp dcsp dcsp fout write line dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp fout write line rstrip + dcsp 0 0 dcsp 0 0 dcsp 0 0 n dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp montage extra read dig montage extra hsp hpi elp names dcnl dcsp assert true len w 1 and all columns in str ww message for ww in w dcnl dcsp assert allclose montage extra hsp montage hsp dcnl dcsp assert allclose montage extra elp montage elp
def test set dig montage dcsp names nasion lpa rpa 1 2 3 4 5 dcnl dcsp hsp points read dig points hsp dcnl dcsp elp points read dig points elp dcnl dcsp nasion lpa rpa elp points 3 dcnl dcsp nm trans get ras to neuromag trans nasion lpa rpa dcnl dcsp elp points apply trans nm trans elp points dcnl dcsp nasion lpa rpa elp points 3 dcnl dcsp hsp points apply trans nm trans hsp points dcnl dcsp montage read dig montage hsp hpi elp names transform true dev head t true dcnl dcsp temp dir tempdir dcnl dcsp fname temp op join temp dir test fif dcnl dcsp montage save fname temp dcnl dcsp montage read read dig montage fif fname temp dcnl dcsp for use mon in montage montage read dcnl dcsp dcsp info create info test dcsp ch 1000 0 eeg dcnl dcsp dcsp with warnings catch warnings record true as w dcnl dcsp dcsp dcsp set montage info use mon dcnl dcsp dcsp assert true all not dcsp set in str ww message for ww in w dcnl dcsp dcsp hs np array p r for i p in enumerate info dig if p kind fiff fiffv point extra dcnl dcsp dcsp nasion dig np array p r for p in info dig if all p ident fiff fiffv point nasion p kind fiff fiffv point cardinal dcnl dcsp dcsp lpa dig np array p r for p in info dig if all p ident fiff fiffv point lpa p kind fiff fiffv point cardinal dcnl dcsp dcsp rpa dig np array p r for p in info dig if all p ident fiff fiffv point rpa p kind fiff fiffv point cardinal dcnl dcsp dcsp hpi dig np array p r for p in info dig if p kind fiff fiffv point hpi dcnl dcsp dcsp assert allclose hs hsp points atol 1e07 dcnl dcsp dcsp assert allclose nasion dig ravel nasion atol 1e07 dcnl dcsp dcsp assert allclose lpa dig ravel lpa atol 1e07 dcnl dcsp dcsp assert allclose rpa dig ravel rpa atol 1e07 dcnl dcsp dcsp assert allclose hpi dig elp points3 atol 1e07
testing requires testing data dcnl def test fif dig montage dcsp dig montage read dig montage fif fif dig montage fname dcnl dcsp temp dir tempdir dcnl dcsp fname temp op join temp dir test fif dcnl dcsp check roundtrip dig montage fname temp dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp raw bv read raw brainvision bv fname preload true dcnl dcsp assert true any will dcsp be dcsp dropped in str ww message for ww in w dcnl dcsp raw bv 2 raw bv copy dcnl dcsp mapping dict dcnl dcsp for ii ch name in enumerate raw bv ch names 1 dcnl dcsp dcsp mappingch name eeg 03d ii + 1 dcnl dcsp raw bv rename channels mapping dcnl dcsp for ii ch name in enumerate raw bv 2 ch names 1 dcnl dcsp dcsp mappingch name eeg 03d ii + 33 dcnl dcsp raw bv 2 rename channels mapping dcnl dcsp raw bv drop channels sti dcsp 014 dcnl dcsp raw bv add channels raw bv 2 dcnl dcsp for ii in range 2 dcnl dcsp dcsp if ii 1 dcnl dcsp dcsp dcsp dig montage transform to head dcnl dcsp dcsp raw bv set montage dig montage dcnl dcsp dcsp evoked read evokeds evoked fname 0 dcnl dcsp dcsp assert equal len raw bv ch names len evoked ch names dcnl dcsp dcsp for ch py ch c in zip raw bv info chs evoked info chs dcnl dcsp dcsp dcsp assert equal ch py ch name ch c ch name replace eeg dcsp eeg dcnl dcsp dcsp dcsp assert equal ch py coord frame fiff fiffv coord head dcnl dcsp dcsp dcsp assert allclose ch py loc ch c loc atol 1e07 dcnl dcsp dcsp assert dig allclose raw bv info evoked info dcnl dcsp names nasion lpa rpa 1 2 3 4 5 dcnl dcsp montage read dig montage hsp hpi elp names transform false dcnl dcsp assert raises runtimeerror montage save fname temp dcnl dcsp montage read dig montage hsp hpi elp names dcnl dcsp check roundtrip montage fname temp
testing requires testing data dcnl def test egi dig montage dcsp dig montage read dig montage egi egi dig montage fname unit m dcnl dcsp temp dir tempdir dcnl dcsp fname temp op join temp dir egi test fif dcnl dcsp check roundtrip dig montage fname temp dcnl dcsp dig montage transform to head dcnl dcsp assert almost equal dig montage nasion0 0 dcnl dcsp assert almost equal dig montage nasion2 0 dcnl dcsp assert allclose dig montage lpa1 0 atol 1e16 dcnl dcsp assert allclose dig montage rpa1 0 atol 1e16 dcnl dcsp raw egi read raw egi egi raw fname channel naming eeg dcsp 03d dcnl dcsp raw egi set montage dig montage dcnl dcsp test raw egi read raw fif egi fif fname dcnl dcsp assert equal len raw egi ch names len test raw egi ch names dcnl dcsp for ch raw ch test raw in zip raw egi info chs test raw egi info chs dcnl dcsp dcsp assert equal ch raw ch name ch test raw ch name dcnl dcsp dcsp assert equal ch raw coord frame fiff fiffv coord head dcnl dcsp dcsp assert allclose ch raw loc ch test raw loc atol 1e07 dcnl dcsp assert dig allclose raw egi info test raw egi info
def test set montage dcsp raw read raw fif fif fname dcnl dcsp mon read montage mgh60 dcnl dcsp orig pos np array ch loc 3 for ch in raw info chs if ch ch name startswith eeg dcnl dcsp raw set montage mon dcnl dcsp new pos np array ch loc 3 for ch in raw info chs if ch ch name startswith eeg dcnl dcsp assert true orig pos new pos all dcnl dcsp r0 fit sphere new pos 1 dcnl dcsp assert allclose r0 0 0 0 016 0 0 atol 0 001
def check roundtrip montage fname dcsp assert equal montage coord frame head dcnl dcsp montage save fname dcnl dcsp montage read read dig montage fif fname dcnl dcsp assert equal str montage str montage read dcnl dcsp for kind in elp hsp nasion lpa rpa dcnl dcsp dcsp if getattr montage kind is not none dcnl dcsp dcsp dcsp assert allclose getattr montage kind getattr montage read kind err msg kind dcnl dcsp assert equal montage read coord frame head
def test rename channels dcsp info read info raw fname dcnl dcsp mapping eeg dcsp 160 eeg060 dcnl dcsp assert raises valueerror rename channels info mapping dcnl dcsp mapping meg dcsp 2641 1 0 dcnl dcsp assert raises valueerror rename channels info mapping dcnl dcsp mapping meg dcsp 2641 meg dcsp 2642 dcnl dcsp assert raises valueerror rename channels info mapping dcnl dcsp assert raises valueerror rename channels info 1 0 dcnl dcsp info2 deepcopy info dcnl dcsp info2 bads eeg dcsp 060 eog dcsp 061 dcnl dcsp mapping eeg dcsp 060 eeg060 eog dcsp 061 eog061 dcnl dcsp rename channels info2 mapping dcnl dcsp assert true info2 chs 374 ch name eeg060 dcnl dcsp assert true info2 ch names 374 eeg060 dcnl dcsp assert true info2 chs 375 ch name eog061 dcnl dcsp assert true info2 ch names 375 eog061 dcnl dcsp assert array equal eeg060 eog061 info2 bads dcnl dcsp info2 deepcopy info dcnl dcsp rename channels info2 lambda x x replace dcsp dcnl dcsp assert true info2 chs 373 ch name eeg059 dcnl dcsp info2 deepcopy info dcnl dcsp info2 bads eeg dcsp 060 eeg dcsp 060 dcnl dcsp rename channels info2 mapping dcnl dcsp assert array equal eeg060 eeg060 info2 bads
def test set channel types dcsp raw read raw fif raw fname dcnl dcsp mapping eeg dcsp 160 eeg060 dcnl dcsp assert raises valueerror raw set channel types mapping dcnl dcsp mapping eog dcsp 061 xxx dcnl dcsp assert raises valueerror raw set channel types mapping dcnl dcsp mapping eeg dcsp 058 ecog eeg dcsp 059 ecg eeg dcsp 060 eog eog dcsp 061 seeg meg dcsp 2441 eeg meg dcsp 2443 eeg meg dcsp 2442 hbo dcnl dcsp assert raises runtimeerror raw set channel types mapping dcnl dcsp raw2 read raw fif raw fname dcnl dcsp raw2 info bads eeg dcsp 059 eeg dcsp 060 eog dcsp 061 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp assert raises runtimeerror raw2 set channel types mapping dcnl dcsp raw2 add proj remove existing true dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp raw2 set channel types mapping dcnl dcsp assert true len w 1 msg str ww message for ww in w dcnl dcsp assert true all the dcsp unit dcsp for dcsp channel in str ww message for ww in w dcnl dcsp info raw2 info dcnl dcsp assert true info chs 372 ch name eeg dcsp 058 dcnl dcsp assert true info chs 372 kind fiff fiffv ecog ch dcnl dcsp assert true info chs 372 unit fiff fiff unit v dcnl dcsp assert true info chs 372 coil type fiff fiffv coil eeg dcnl dcsp assert true info chs 373 ch name eeg dcsp 059 dcnl dcsp assert true info chs 373 kind fiff fiffv ecg ch dcnl dcsp assert true info chs 373 unit fiff fiff unit v dcnl dcsp assert true info chs 373 coil type fiff fiffv coil none dcnl dcsp assert true info chs 374 ch name eeg dcsp 060 dcnl dcsp assert true info chs 374 kind fiff fiffv eog ch dcnl dcsp assert true info chs 374 unit fiff fiff unit v dcnl dcsp assert true info chs 374 coil type fiff fiffv coil none dcnl dcsp assert true info chs 375 ch name eog dcsp 061 dcnl dcsp assert true info chs 375 kind fiff fiffv seeg ch dcnl dcsp assert true info chs 375 unit fiff fiff unit v dcnl dcsp assert true info chs 375 coil type fiff fiffv coil eeg dcnl dcsp for idx in pick channels raw ch names meg dcsp 2441 meg dcsp 2443 dcnl dcsp dcsp assert true info chs idx kind fiff fiffv eeg ch dcnl dcsp dcsp assert true info chs idx unit fiff fiff unit v dcnl dcsp dcsp assert true info chs idx coil type fiff fiffv coil eeg dcnl dcsp idx pick channels raw ch names meg dcsp 2442 0 dcnl dcsp assert true info chs idx kind fiff fiffv fnirs ch dcnl dcsp assert true info chs idx unit fiff fiff unit mol dcnl dcsp assert true info chs idx coil type fiff fiffv coil fnirs hbo dcnl dcsp raw info chs 0 unit 0 0 dcnl dcsp ch types raw ch names0 misc dcnl dcsp assert raises valueerror raw set channel types ch types
def test read ch connectivity dcsp tempdir tempdir dcnl dcsp a partial np array dtype <u7 dcnl dcsp nbh np array meg0111 a meg0131 meg0121 a meg0111 a meg0131 meg0131 a meg0111 a meg0121 dtype label o neighblabel o dcnl dcsp mat dict neighbours nbh dcnl dcsp mat fname op join tempdir test mat mat dcnl dcsp savemat mat fname mat oned as row dcnl dcsp ch connectivity ch names read ch connectivity mat fname dcnl dcsp x ch connectivity dcnl dcsp assert equal x shape0 len ch names dcnl dcsp assert equal x shape 3 3 dcnl dcsp assert equal x 0 1 false dcnl dcsp assert equal x 0 2 true dcnl dcsp assert true np all x diagonal dcnl dcsp assert raises valueerror read ch connectivity mat fname 0 3 dcnl dcsp ch connectivity ch names read ch connectivity mat fname picks 0 2 dcnl dcsp assert equal ch connectivity shape0 2 dcnl dcsp assert equal len ch names 2 dcnl dcsp ch names eeg01 eeg02 eeg03 dcnl dcsp neighbors eeg02 eeg04 eeg02 dcnl dcsp assert raises valueerror ch neighbor connectivity ch names neighbors dcnl dcsp neighbors eeg02 eeg01 eeg03 eeg dcsp 02 dcnl dcsp assert raises valueerror ch neighbor connectivity ch names 2 neighbors dcnl dcsp neighbors eeg02 eeg01 eeg dcsp 02 dcnl dcsp assert raises valueerror ch neighbor connectivity ch names neighbors dcnl dcsp connectivity ch names read ch connectivity neuromag306mag dcnl dcsp assert equal connectivity shape 102 102 dcnl dcsp assert equal len ch names 102 dcnl dcsp assert raises valueerror read ch connectivity bananas dcnl dcsp a partial np array dcnl dcsp nbh np array e31 e1 a e2 a e3 e2 a e1 a e3 e3 a e1 a e2 dtype label o neighblabel o dcnl dcsp mat dict neighbours nbh dcnl dcsp mat fname op join tempdir test isolated mat mat dcnl dcsp savemat mat fname mat oned as row dcnl dcsp ch connectivity ch names read ch connectivity mat fname dcnl dcsp x ch connectivity todense dcnl dcsp assert equal x shape0 len ch names dcnl dcsp assert equal x shape 4 4 dcnl dcsp assert true np all x diagonal dcnl dcsp assert false np any x0 1 dcnl dcsp assert false np any x1 0 dcnl dcsp a partial np array dcnl dcsp nbh np array e31 e1 a e8 a e3 e2 a e1 a e3 e3 a e1 a e2 dtype label o neighblabel o dcnl dcsp mat dict neighbours nbh dcnl dcsp mat fname op join tempdir test error mat mat dcnl dcsp savemat mat fname mat oned as row dcnl dcsp assert raises valueerror read ch connectivity mat fname
def test get set sensor positions dcsp raw1 read raw fif raw fname dcnl dcsp picks pick types raw1 info meg false eeg true dcnl dcsp pos np array ch loc 3 for ch in raw1 info chs picks dcnl dcsp raw pos raw1 get channel positions picks picks dcnl dcsp assert array equal raw pos pos dcnl dcsp ch name raw1 info ch names 13 dcnl dcsp assert raises valueerror raw1 set channel positions 1 2 name dcnl dcsp raw2 read raw fif raw fname dcnl dcsp raw2 info chs 13 loc 3 np array 1 2 3 dcnl dcsp raw1 set channel positions 1 2 3 ch name dcnl dcsp assert array equal raw1 info chs 13 loc raw2 info chs 13 loc
testing requires testing data dcnl def test find ch connectivity dcsp data path testing data path dcnl dcsp raw read raw fif raw fname preload true dcnl dcsp sizes mag 828 grad 1700 eeg 386 dcnl dcsp nchans mag 102 grad 204 eeg 60 dcnl dcsp for ch type in mag grad eeg dcnl dcsp dcsp conn ch names find ch connectivity raw info ch type dcnl dcsp dcsp assert equal conn getnnz sizesch type dcnl dcsp dcsp assert equal len ch names nchansch type dcnl dcsp assert raises valueerror find ch connectivity raw info none dcnl dcsp conn ch names compute ch connectivity raw info grad dcnl dcsp assert equal conn getnnz 2680 dcnl dcsp raw pick types meg mag dcnl dcsp find ch connectivity raw info none dcnl dcsp bti fname op join data path bti erm hfh c rfdc dcnl dcsp bti config name op join data path bti erm hfh config dcnl dcsp raw read raw bti bti fname bti config name none dcnl dcsp ch names find ch connectivity raw info mag dcnl dcsp assert true a1 in ch names dcnl dcsp ctf fname op join data path ctf testdata ctf short ds dcnl dcsp raw read raw ctf ctf fname dcnl dcsp ch names find ch connectivity raw info mag dcnl dcsp assert true mlc11 in ch names dcnl dcsp assert raises valueerror find ch connectivity raw info eog
def get builtin montages dcsp path op join op dirname file data montages dcnl dcsp supported elc txt csd sfp elp hpts loc locs eloc bvef dcnl dcsp files op splitext f for f in os listdir path dcnl dcsp return sorted f for f ext in files if ext in supported
def read montage kind ch names none path none unit m transform false dcsp if path is none dcnl dcsp dcsp path op join op dirname file data montages dcnl dcsp if not op isabs kind dcnl dcsp dcsp supported elc txt csd sfp elp hpts loc locs eloc bvef dcnl dcsp dcsp montages op splitext f for f in os listdir path dcnl dcsp dcsp montages m for m in montages if m1 in supported and kind m0 dcnl dcsp dcsp if len montages 1 dcnl dcsp dcsp dcsp raise valueerror could dcsp not dcsp find dcsp the dcsp montage dcsp please dcsp provide dcsp the dcsp full dcsp path dcnl dcsp dcsp kind ext montages0 dcnl dcsp else dcnl dcsp dcsp kind ext op splitext kind dcnl dcsp fname op join path kind + ext dcnl dcsp if ext sfp dcnl dcsp dcsp with open fname r as f dcnl dcsp dcsp dcsp lines f read replace dctb dcsp splitlines dcnl dcsp dcsp ch names pos dcnl dcsp dcsp for ii line in enumerate lines dcnl dcsp dcsp dcsp line line strip split dcnl dcsp dcsp dcsp if len line 0 dcnl dcsp dcsp dcsp dcsp if len line 4 dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror malformed dcsp sfp dcsp file dcsp in dcsp line dcsp + str ii dcnl dcsp dcsp dcsp dcsp this name x y z line dcnl dcsp dcsp dcsp dcsp ch names append this name dcnl dcsp dcsp dcsp dcsp pos append float cord for cord in x y z dcnl dcsp dcsp pos np asarray pos dcnl dcsp elif ext elc dcnl dcsp dcsp ch names dcnl dcsp dcsp pos dcnl dcsp dcsp with open fname as fid dcnl dcsp dcsp dcsp for line in fid dcnl dcsp dcsp dcsp dcsp if unitposition in line dcnl dcsp dcsp dcsp dcsp dcsp units line split 1 dcnl dcsp dcsp dcsp dcsp dcsp scale factor dict m 1 0 mm 0 001 units dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise runtimeerror could dcsp not dcsp detect dcsp units dcsp in dcsp file dcsp s fname dcnl dcsp dcsp dcsp for line in fid dcnl dcsp dcsp dcsp dcsp if positions n in line dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp pos dcnl dcsp dcsp dcsp for line in fid dcnl dcsp dcsp dcsp dcsp if labels n in line dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp pos append list map float line split dcnl dcsp dcsp dcsp for line in fid dcnl dcsp dcsp dcsp dcsp if not line or not set line set dcsp dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp ch names append line strip dcsp strip n dcnl dcsp dcsp pos np array pos scale factor dcnl dcsp elif ext txt dcnl dcsp dcsp try dcnl dcsp dcsp dcsp data np genfromtxt fname dtype str skip header 1 dcnl dcsp dcsp except typeerror dcnl dcsp dcsp dcsp data np genfromtxt fname dtype str skiprows 1 dcnl dcsp dcsp ch names data 0 tolist dcnl dcsp dcsp az np deg2rad data 2 astype float dcnl dcsp dcsp pol np deg2rad data 1 astype float dcnl dcsp dcsp pos sph to cart np array np ones len az 85 0 az pol t dcnl dcsp elif ext csd dcnl dcsp dcsp try dcnl dcsp dcsp dcsp data np genfromtxt fname dtype str skip header 2 dcnl dcsp dcsp except typeerror dcnl dcsp dcsp dcsp data np genfromtxt fname dtype str skiprows 2 dcnl dcsp dcsp ch names data 0 tolist dcnl dcsp dcsp az np deg2rad data 1 astype float dcnl dcsp dcsp pol np deg2rad 90 0 data 2 astype float dcnl dcsp dcsp pos sph to cart np array np ones len az az pol t dcnl dcsp elif ext elp dcnl dcsp dcsp dtype np dtype s8 dcsp s8 dcsp f8 dcsp f8 dcsp f8 dcnl dcsp dcsp try dcnl dcsp dcsp dcsp data np loadtxt fname dtype dtype skip header 1 dcnl dcsp dcsp except typeerror dcnl dcsp dcsp dcsp data np loadtxt fname dtype dtype skiprows 1 dcnl dcsp dcsp ch names data f1 astype str tolist dcnl dcsp dcsp az data f2 dcnl dcsp dcsp horiz data f3 dcnl dcsp dcsp radius np abs az 180 0 dcnl dcsp dcsp az np deg2rad np array h if a 0 0 else 180 + h for h a in zip horiz az dcnl dcsp dcsp pol radius np pi dcnl dcsp dcsp pos sph to cart np array np ones len az 85 0 az pol t dcnl dcsp elif ext hpts dcnl dcsp dcsp dtype type s8 name s8 x f8 y f8 z f8 dcnl dcsp dcsp data np loadtxt fname dtype dtype dcnl dcsp dcsp ch names data name astype str tolist dcnl dcsp dcsp pos np vstack data x data y data z t dcnl dcsp elif ext in loc locs eloc dcnl dcsp dcsp ch names np loadtxt fname dtype s4 usecols 3 astype str tolist dcnl dcsp dcsp topo np loadtxt fname dtype float usecols 1 2 dcnl dcsp dcsp sph topo to sph topo dcnl dcsp dcsp pos sph to cart sph dcnl dcsp dcsp pos 0 1 pos 1 0 1 1 dcnl dcsp elif ext bvef dcnl dcsp dcsp root elementtree parse fname getroot dcnl dcsp dcsp ch names s text for s in root findall electrode name dcnl dcsp dcsp theta float s text for s in root findall electrode theta dcnl dcsp dcsp pol np deg2rad np array theta dcnl dcsp dcsp phi float s text for s in root findall electrode phi dcnl dcsp dcsp az np deg2rad np array phi dcnl dcsp dcsp pos sph to cart np array np ones len az 85 0 az pol t dcnl dcsp else dcnl dcsp dcsp raise valueerror currently dcsp the dcsp s dcsp template dcsp is dcsp not dcsp supported kind dcnl dcsp selection np arange len pos dcnl dcsp if unit mm dcnl dcsp dcsp pos 1000 0 dcnl dcsp elif unit cm dcnl dcsp dcsp pos 100 0 dcnl dcsp elif unit m dcnl dcsp dcsp raise valueerror unit dcsp should dcsp be dcsp either dcsp m dcsp cm dcsp or dcsp mm dcnl dcsp if transform dcnl dcsp dcsp names lower name lower for name in list ch names dcnl dcsp dcsp if ext hpts dcnl dcsp dcsp dcsp fids 2 1 3 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp fids nasion lpa rpa dcnl dcsp dcsp missing name for name in fids if name not in names lower dcnl dcsp dcsp if missing dcnl dcsp dcsp dcsp raise valueerror the dcsp points dcsp s dcsp are dcsp missing dcsp but dcsp are dcsp needed dcsp to dcsp transform dcsp the dcsp points dcsp to dcsp the dcsp mne dcsp coordinate dcsp system dcsp either dcsp add dcsp the dcsp points dcsp or dcsp read dcsp the dcsp montage dcsp with dcsp transform false dcsp missing dcnl dcsp dcsp nasion posnames lower index fids0 dcnl dcsp dcsp lpa posnames lower index fids1 dcnl dcsp dcsp rpa posnames lower index fids2 dcnl dcsp dcsp neuromag trans get ras to neuromag trans nasion lpa rpa dcnl dcsp dcsp pos apply trans neuromag trans pos dcnl dcsp if ch names is not none dcnl dcsp dcsp upper names ch name upper for ch name in ch names dcnl dcsp dcsp sel ch names zip i ch namesupper names index e for i e in enumerate n upper for n in ch names if e in upper names dcnl dcsp dcsp sel list sel dcnl dcsp dcsp pos possel dcnl dcsp dcsp selection selectionsel dcnl dcsp kind op split kind 1 dcnl dcsp return montage pos pos ch names ch names kind kind selection selection
def check frame d frame str dcsp if d coord frame str to frameframe str dcnl dcsp dcsp raise runtimeerror dig dcsp point dcsp must dcsp be dcsp in dcsp s dcsp coordinate dcsp frame dcsp got dcsp s frame str frame to strd coord frame
def read dig montage hsp none hpi none elp none point names none unit auto fif none egi none transform true dev head t false dcsp if fif is not none dcnl dcsp dcsp if dev head t or not transform dcnl dcsp dcsp dcsp raise valueerror transform dcsp must dcsp be dcsp true dcsp and dcsp dev head t dcsp must dcsp be dcsp false dcsp for dcsp fif dcsp dig dcsp montage dcnl dcsp dcsp if not all x is none for x in hsp hpi elp point names egi dcnl dcsp dcsp dcsp raise valueerror hsp dcsp hpi dcsp elp dcsp point names dcsp egi dcsp must dcsp all dcsp be dcsp none dcsp if dcsp fif dcsp is dcsp not dcsp none dcnl dcsp dcsp check fname fif overwrite read must exist true dcnl dcsp dcsp f tree fiff open fif 2 dcnl dcsp dcsp with f as fid dcnl dcsp dcsp dcsp dig read dig fif fid tree dcnl dcsp dcsp hsp list dcnl dcsp dcsp hpi list dcnl dcsp dcsp elp list dcnl dcsp dcsp point names list dcnl dcsp dcsp fids dict dcnl dcsp dcsp dig ch pos dict dcnl dcsp dcsp for d in dig dcnl dcsp dcsp dcsp if d kind fiff fiffv point cardinal dcnl dcsp dcsp dcsp dcsp check frame d head dcnl dcsp dcsp dcsp dcsp fids cardinal ident mappingd ident d r dcnl dcsp dcsp dcsp elif d kind fiff fiffv point hpi dcnl dcsp dcsp dcsp dcsp check frame d head dcnl dcsp dcsp dcsp dcsp hpi append d r dcnl dcsp dcsp dcsp dcsp elp append d r dcnl dcsp dcsp dcsp dcsp point names append hpi 03d d ident dcnl dcsp dcsp dcsp elif d kind fiff fiffv point extra dcnl dcsp dcsp dcsp dcsp check frame d head dcnl dcsp dcsp dcsp dcsp hsp append d r dcnl dcsp dcsp dcsp elif d kind fiff fiffv point eeg dcnl dcsp dcsp dcsp dcsp check frame d head dcnl dcsp dcsp dcsp dcsp dig ch pos eeg 03d d ident d r dcnl dcsp dcsp fids fids get key for key in nasion lpa rpa dcnl dcsp dcsp hsp np array hsp if len hsp else none dcnl dcsp dcsp elp np array elp if len elp else none dcnl dcsp dcsp coord frame head dcnl dcsp elif egi is not none dcnl dcsp dcsp if not all x is none for x in hsp hpi elp point names fif dcnl dcsp dcsp dcsp raise valueerror hsp dcsp hpi dcsp elp dcsp point names dcsp fif dcsp must dcsp all dcsp be dcsp none dcsp if dcsp egi dcsp is dcsp not dcsp none dcnl dcsp dcsp check fname egi overwrite read must exist true dcnl dcsp dcsp root elementtree parse egi getroot dcnl dcsp dcsp ns root tagroot tag index root tag index + 1 dcnl dcsp dcsp sensors root find ssensorlayout ssensors ns ns dcnl dcsp dcsp fids dict dcnl dcsp dcsp dig ch pos dict dcnl dcsp dcsp fid name map nasion nasion right dcsp periauricular dcsp point rpa left dcsp periauricular dcsp point lpa dcnl dcsp dcsp scale dict mm 0 001 cm 0 01 auto 0 01 m 1 dcnl dcsp dcsp if unit not in scale dcnl dcsp dcsp dcsp raise valueerror unit dcsp needs dcsp to dcsp be dcsp one dcsp of dcsp s dcsp not dcsp r sorted scale keys unit dcnl dcsp dcsp for s in sensors dcnl dcsp dcsp dcsp name number kind s0 text int s1 text int s2 text dcnl dcsp dcsp dcsp coordinates np array float s3 text float s4 text float s5 text dcnl dcsp dcsp dcsp coordinates scaleunit dcnl dcsp dcsp dcsp if kind 0 dcnl dcsp dcsp dcsp dcsp dig ch pos eeg dcsp 03d number coordinates dcnl dcsp dcsp dcsp elif kind 1 dcnl dcsp dcsp dcsp dcsp dig ch pos eeg dcsp 03d len dig ch pos keys + 1 coordinates dcnl dcsp dcsp dcsp elif kind 2 dcnl dcsp dcsp dcsp dcsp fid name fid name mapname dcnl dcsp dcsp dcsp dcsp fidsfid name coordinates dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp warn unknown dcsp sensor dcsp type dcsp s dcsp detected dcsp skipping dcsp sensor proceed dcsp with dcsp caution kind dcnl dcsp dcsp fids fidskey for key in nasion lpa rpa dcnl dcsp dcsp coord frame unknown dcnl dcsp else dcnl dcsp dcsp fids none 3 dcnl dcsp dcsp dig ch pos none dcnl dcsp dcsp scale dict mm 0 001 cm 0 01 auto 0 001 m 1 dcnl dcsp dcsp if unit not in scale dcnl dcsp dcsp dcsp raise valueerror unit dcsp needs dcsp to dcsp be dcsp one dcsp of dcsp s dcsp not dcsp r sorted scale keys unit dcnl dcsp dcsp if isinstance hsp string types dcnl dcsp dcsp dcsp hsp read dig points hsp unit unit dcnl dcsp dcsp elif hsp is not none dcnl dcsp dcsp dcsp hsp scaleunit dcnl dcsp dcsp if isinstance hpi string types dcnl dcsp dcsp dcsp ext op splitext hpi 1 dcnl dcsp dcsp dcsp if ext in txt mat dcnl dcsp dcsp dcsp dcsp hpi read dig points hpi unit m dcnl dcsp dcsp dcsp elif ext in sqd mrk dcnl dcsp dcsp dcsp dcsp from io kit import read mrk dcnl dcsp dcsp dcsp dcsp hpi read mrk hpi dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise valueerror hpi dcsp file dcsp with dcsp extension dcsp s dcsp is dcsp not dcsp supported dcsp only dcsp txt dcsp sqd dcsp and dcsp mrk dcsp are dcsp supported ext dcnl dcsp dcsp if isinstance elp string types dcnl dcsp dcsp dcsp elp read dig points elp unit unit dcnl dcsp dcsp elif elp is not none and scaleunit dcnl dcsp dcsp dcsp elp scaleunit dcnl dcsp dcsp coord frame unknown dcnl dcsp out digmontage hsp hpi elp point names fids0 fids1 fids2 dig ch pos dig ch pos coord frame coord frame dcnl dcsp if fif is none and transform dcnl dcsp dcsp out transform to head dcnl dcsp if dev head t dcnl dcsp dcsp out compute dev head t dcnl dcsp return out
def set montage info montage update ch names false dcsp if isinstance montage montage dcnl dcsp dcsp if update ch names dcnl dcsp dcsp dcsp info chs list dcnl dcsp dcsp dcsp for ii ch name in enumerate montage ch names dcnl dcsp dcsp dcsp dcsp ch info cal 1 0 logno ii + 1 scanno ii + 1 range 1 0 unit mul 0 ch name ch name unit fiff fiff unit v kind fiff fiffv eeg ch coord frame fiff fiffv coord head coil type fiff fiffv coil eeg dcnl dcsp dcsp dcsp dcsp info chs append ch info dcnl dcsp dcsp dcsp info update redundant dcnl dcsp dcsp if not contains ch type info eeg dcnl dcsp dcsp dcsp raise valueerror no dcsp eeg dcsp channels dcsp found dcnl dcsp dcsp sensors found dcnl dcsp dcsp montage lower ch name lower for ch name in montage ch names dcnl dcsp dcsp info lower ch name lower for ch name in info ch names dcnl dcsp dcsp if len set montage lower len montage lower and len set info lower len info lower dcnl dcsp dcsp dcsp montage ch names montage lower dcnl dcsp dcsp dcsp info ch names info lower dcnl dcsp dcsp else dcnl dcsp dcsp dcsp montage ch names montage ch names dcnl dcsp dcsp dcsp info ch names info ch names dcnl dcsp dcsp info ch names clean names info ch names remove whitespace true dcnl dcsp dcsp montage ch names clean names montage ch names remove whitespace true dcnl dcsp dcsp for pos ch name in zip montage pos montage ch names dcnl dcsp dcsp dcsp if ch name not in info ch names dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp ch idx info ch names index ch name dcnl dcsp dcsp dcsp info chs ch idx loc np r pos 0 0 9 dcnl dcsp dcsp dcsp sensors found append ch idx dcnl dcsp dcsp if len sensors found 0 dcnl dcsp dcsp dcsp raise valueerror none dcsp of dcsp the dcsp sensors dcsp defined dcsp in dcsp the dcsp montage dcsp were dcsp found dcsp in dcsp the dcsp info dcsp structure dcsp check dcsp the dcsp channel dcsp names dcnl dcsp dcsp eeg sensors pick types info meg false ref meg false eeg true exclude dcnl dcsp dcsp not found np setdiff1d eeg sensors sensors found dcnl dcsp dcsp if len not found 0 dcnl dcsp dcsp dcsp not found names info ch names ch for ch in not found dcnl dcsp dcsp dcsp warn the dcsp following dcsp eeg dcsp sensors dcsp did dcsp not dcsp have dcsp a dcsp position dcsp specified dcsp in dcsp the dcsp selected dcsp montage dcsp + str not found names + dcsp their dcsp position dcsp has dcsp been dcsp left dcsp untouched dcnl dcsp elif isinstance montage digmontage dcnl dcsp dcsp info dig montage get dig dcnl dcsp dcsp if montage dev head t is not none dcnl dcsp dcsp dcsp info dev head t trans montage dev head t dcnl dcsp dcsp if montage dig ch pos is not none dcnl dcsp dcsp dcsp eeg ref pos montage dig ch pos get eeg000 np zeros 3 dcnl dcsp dcsp dcsp did set np zeros len info ch names bool dcnl dcsp dcsp dcsp is eeg np zeros len info ch names bool dcnl dcsp dcsp dcsp is eegpick types info meg false eeg true exclude true dcnl dcsp dcsp dcsp for ch name ch pos in montage dig ch pos items dcnl dcsp dcsp dcsp dcsp if ch name eeg000 dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp if ch name not in info ch names dcnl dcsp dcsp dcsp dcsp dcsp raise runtimeerror montage dcsp channel dcsp s dcsp not dcsp found dcsp in dcsp info ch name dcnl dcsp dcsp dcsp dcsp idx info ch names index ch name dcnl dcsp dcsp dcsp dcsp did setidx true dcnl dcsp dcsp dcsp dcsp this loc np concatenate ch pos eeg ref pos dcnl dcsp dcsp dcsp dcsp info chs idx loc 6 this loc dcnl dcsp dcsp dcsp did not set info chs ii ch name for ii in np where is eeg ~ did set 0 dcnl dcsp dcsp dcsp if len did not set 0 dcnl dcsp dcsp dcsp dcsp warn did dcsp not dcsp set dcsp s dcsp channel dcsp positions n s len did not set dcsp join did not set dcnl dcsp else dcnl dcsp dcsp raise typeerror montage dcsp must dcsp be dcsp a dcsp montage dcsp or dcsp digmontage dcsp instead dcsp of dcsp s type montage
def read lout fname dcsp with open fname as f dcnl dcsp dcsp box line f readline dcnl dcsp dcsp box tuple map float box line split dcnl dcsp dcsp names pos ids dcnl dcsp dcsp for line in f dcnl dcsp dcsp dcsp splits line split dcnl dcsp dcsp dcsp if len splits 7 dcnl dcsp dcsp dcsp dcsp cid x y dx dy chkind nb splits dcnl dcsp dcsp dcsp dcsp name chkind + dcsp + nb dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp cid x y dx dy name splits dcnl dcsp dcsp dcsp pos append np array x y dx dy dtype np float dcnl dcsp dcsp dcsp names append name dcnl dcsp dcsp dcsp ids append int cid dcnl dcsp pos np array pos dcnl dcsp return box pos names ids
def read lay fname dcsp with open fname as f dcnl dcsp dcsp box none dcnl dcsp dcsp names pos ids dcnl dcsp dcsp for line in f dcnl dcsp dcsp dcsp splits line split dcnl dcsp dcsp dcsp if len splits 7 dcnl dcsp dcsp dcsp dcsp cid x y dx dy chkind nb splits dcnl dcsp dcsp dcsp dcsp name chkind + dcsp + nb dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp cid x y dx dy name splits dcnl dcsp dcsp dcsp pos append np array x y dx dy dtype np float dcnl dcsp dcsp dcsp names append name dcnl dcsp dcsp dcsp ids append int cid dcnl dcsp pos np array pos dcnl dcsp return box pos names ids
def read layout kind path none scale true dcsp if path is none dcnl dcsp dcsp path op join op dirname file data layouts dcnl dcsp if not kind endswith lout and op exists op join path kind + lout dcnl dcsp dcsp kind + lout dcnl dcsp elif not kind endswith lay and op exists op join path kind + lay dcnl dcsp dcsp kind + lay dcnl dcsp if kind endswith lout dcnl dcsp dcsp fname op join path kind dcnl dcsp dcsp kind kind 5 dcnl dcsp dcsp box pos names ids read lout fname dcnl dcsp elif kind endswith lay dcnl dcsp dcsp fname op join path kind dcnl dcsp dcsp kind kind 4 dcnl dcsp dcsp box pos names ids read lay fname dcnl dcsp dcsp kind endswith lay dcnl dcsp else dcnl dcsp dcsp raise valueerror unknown dcsp layout dcsp type dcsp should dcsp be dcsp of dcsp type dcsp lout dcsp or dcsp lay dcnl dcsp if scale dcnl dcsp dcsp pos 0 np min pos 0 dcnl dcsp dcsp pos 1 np min pos 1 dcnl dcsp dcsp scaling max np max pos 0 np max pos 1 + pos 0 2 dcnl dcsp dcsp pos scaling dcnl dcsp dcsp pos 2 + 0 03 dcnl dcsp dcsp pos 2 0 97 1 03 dcnl dcsp dcsp pos 2 0 94 dcnl dcsp return layout box box pos pos names names kind kind ids ids
def make eeg layout info radius 0 5 width none height none exclude bads dcsp if not 0 < radius < 0 5 dcnl dcsp dcsp raise valueerror the dcsp radius dcsp parameter dcsp should dcsp be dcsp between dcsp 0 dcsp and dcsp 0 5 dcnl dcsp if width is not none and not 0 < width < 1 0 dcnl dcsp dcsp raise valueerror the dcsp width dcsp parameter dcsp should dcsp be dcsp between dcsp 0 dcsp and dcsp 1 dcnl dcsp if height is not none and not 0 < height < 1 0 dcnl dcsp dcsp raise valueerror the dcsp height dcsp parameter dcsp should dcsp be dcsp between dcsp 0 dcsp and dcsp 1 dcnl dcsp picks pick types info meg false eeg true ref meg false exclude exclude dcnl dcsp loc2d auto topomap coords info picks dcnl dcsp names info chs i ch name for i in picks dcnl dcsp loc2d min np min loc2d axis 0 dcnl dcsp loc2d max np max loc2d axis 0 dcnl dcsp loc2d loc2d loc2d max + loc2d min 2 0 loc2d max loc2d min dcnl dcsp if width is none or height is none dcnl dcsp dcsp width height box size loc2d width height padding 0 1 dcnl dcsp loc2d 2 radius dcnl dcsp scaling min 1 1 0 + width 1 1 0 + height dcnl dcsp loc2d scaling dcnl dcsp width scaling dcnl dcsp height scaling dcnl dcsp loc2d + 0 5 dcnl dcsp n channels loc2d shape0 dcnl dcsp pos np c loc2d 0 0 5 width loc2d 1 0 5 height width np ones n channels height np ones n channels dcnl dcsp box 0 1 0 1 dcnl dcsp ids 1 + np arange n channels dcnl dcsp layout layout box box pos pos names names kind eeg ids ids dcnl dcsp return layout
def make grid layout info picks none n col none dcsp if picks is none dcnl dcsp dcsp picks pick types info misc true ref meg false exclude bads dcnl dcsp names info chs k ch name for k in picks dcnl dcsp if not names dcnl dcsp dcsp raise valueerror no dcsp misc dcsp data dcsp channels dcsp found dcnl dcsp ids list range len picks dcnl dcsp size len picks dcnl dcsp if n col is none dcnl dcsp dcsp n row n col np sqrt size dcnl dcsp dcsp if n col 1 dcnl dcsp dcsp dcsp n col n row int n col + 1 int n row dcnl dcsp dcsp if n col n row < size dcnl dcsp dcsp dcsp n row + 1 dcnl dcsp else dcnl dcsp dcsp n row int np ceil size float n col dcnl dcsp x y np meshgrid np linspace 0 5 0 5 n col np linspace 0 5 0 5 n row dcnl dcsp x y x ravel size y ravel size dcnl dcsp width height box size np c x y padding 0 1 dcnl dcsp border x border y 0 01 0 01 dcnl dcsp x scaling 1 1 0 + width + border x dcnl dcsp y scaling 1 1 0 + height + border y dcnl dcsp x x x scaling dcnl dcsp y y y scaling dcnl dcsp width x scaling dcnl dcsp height y scaling dcnl dcsp x + 0 5 dcnl dcsp y + 0 5 dcnl dcsp pos np c x 0 5 width y 0 5 height width np ones size height np ones size dcnl dcsp box 0 1 0 1 dcnl dcsp layout layout box box pos pos names names kind gridmisc ids ids dcnl dcsp return layout
def find layout info ch type none exclude bads dcsp our types dcsp or dcsp join none mag grad meg dcnl dcsp if ch type not in none meg mag grad eeg dcnl dcsp dcsp raise valueerror invalid dcsp channel dcsp type dcsp s dcsp requested dcsp ch type dcsp must dcsp be dcsp s ch type our types dcnl dcsp has vv mag has vv grad is old vv has 4d mag ctf other types has ctf grad n kit grads has any meg has eeg coils has eeg coils and meg has eeg coils only get ch info info dcnl dcsp has vv meg has vv mag and has vv grad dcnl dcsp has vv only mag has vv mag and not has vv grad dcnl dcsp has vv only grad has vv grad and not has vv mag dcnl dcsp if ch type meg and not has any meg dcnl dcsp dcsp raise runtimeerror no dcsp meg dcsp channels dcsp present dcsp cannot dcsp find dcsp meg dcsp layout dcnl dcsp if ch type eeg and not has eeg coils dcnl dcsp dcsp raise runtimeerror no dcsp eeg dcsp channels dcsp present dcsp cannot dcsp find dcsp eeg dcsp layout dcnl dcsp if has vv meg and ch type is none or any has vv mag has vv grad and ch type meg dcnl dcsp dcsp layout name vectorviewall dcnl dcsp elif has vv only mag or has vv meg and ch type mag dcnl dcsp dcsp layout name vectorviewmag dcnl dcsp elif has vv only grad or has vv meg and ch type grad dcnl dcsp dcsp if info ch names 0 endswith x dcnl dcsp dcsp dcsp layout name vectorviewgrad norm dcnl dcsp dcsp else dcnl dcsp dcsp dcsp layout name vectorviewgrad dcnl dcsp elif has eeg coils only and ch type in none eeg or has eeg coils and meg and ch type eeg dcnl dcsp dcsp if not isinstance info dict info dcnl dcsp dcsp dcsp raise runtimeerror cannot dcsp make dcsp eeg dcsp layout dcsp no dcsp measurement dcsp info dcsp was dcsp passed dcsp to dcsp find layout dcnl dcsp dcsp return make eeg layout info exclude exclude dcnl dcsp elif has 4d mag dcnl dcsp dcsp layout name magneswh3600 dcnl dcsp elif has ctf grad dcnl dcsp dcsp layout name ctf275 dcnl dcsp elif n kit grads 0 dcnl dcsp dcsp layout name find kit layout info n kit grads dcnl dcsp else dcnl dcsp dcsp xy auto topomap coords info picks range info nchan ignore overlap true to sphere false dcnl dcsp dcsp return generate 2d layout xy ch names info ch names name custom normalize false dcnl dcsp layout read layout layout name dcnl dcsp if not is old vv dcnl dcsp dcsp layout names clean names layout names remove whitespace true dcnl dcsp if has ctf grad dcnl dcsp dcsp layout names clean names layout names before dash true dcnl dcsp if exclude bads dcnl dcsp dcsp exclude info bads dcnl dcsp idx ii for ii name in enumerate layout names if name not in exclude dcnl dcsp layout names layout namesii for ii in idx dcnl dcsp layout pos layout posidx dcnl dcsp layout ids layout idsii for ii in idx dcnl dcsp return layout
def find kit layout info n grads dcsp if info kit system id is not none dcnl dcsp dcsp from io kit constants import kit layout dcnl dcsp dcsp if info kit system id in kit layout dcnl dcsp dcsp dcsp kit layout kit layoutinfo kit system id dcnl dcsp dcsp dcsp if kit layout is not none dcnl dcsp dcsp dcsp dcsp return kit layout dcnl dcsp dcsp raise notimplementederror the dcsp layout dcsp for dcsp the dcsp kit dcsp system dcsp with dcsp id dcsp i dcsp is dcsp missing dcsp please dcsp contact dcsp the dcsp developers dcsp about dcsp adding dcsp it info kit system id dcnl dcsp elif n grads 157 dcnl dcsp dcsp return kitad dcnl dcsp test chs meg dcsp dcsp 13 meg dcsp dcsp 14 meg dcsp dcsp 15 meg dcsp dcsp 16 meg dcsp dcsp 25 meg dcsp dcsp 26 meg dcsp dcsp 27 meg dcsp dcsp 28 meg dcsp dcsp 29 meg dcsp dcsp 30 meg dcsp dcsp 31 meg dcsp dcsp 32 meg dcsp dcsp 57 meg dcsp dcsp 60 meg dcsp dcsp 61 meg dcsp dcsp 62 meg dcsp dcsp 63 meg dcsp dcsp 64 meg dcsp dcsp 73 meg dcsp dcsp 90 meg dcsp dcsp 93 meg dcsp dcsp 95 meg dcsp dcsp 96 meg dcsp 105 meg dcsp 112 meg dcsp 120 meg dcsp 121 meg dcsp 122 meg dcsp 123 meg dcsp 124 meg dcsp 125 meg dcsp 126 meg dcsp 142 meg dcsp 144 meg dcsp 153 meg dcsp 154 meg dcsp 155 meg dcsp 156 dcnl dcsp x ch loc 0 < 0 for ch in info chs if ch ch name in test chs dcnl dcsp if np all x dcnl dcsp dcsp return kit157 dcnl dcsp elif np all np invert x dcnl dcsp dcsp raise notimplementederror guessing dcsp sensor dcsp layout dcsp for dcsp legacy dcsp umd dcsp files dcsp is dcsp not dcsp implemented dcsp please dcsp convert dcsp your dcsp files dcsp using dcsp mnepython dcsp 0 13 dcsp or dcsp higher dcnl dcsp else dcnl dcsp dcsp raise runtimeerror kit dcsp system dcsp could dcsp not dcsp be dcsp determined dcsp for dcsp data
def box size points width none height none padding 0 0 dcsp from scipy spatial distance import pdist dcnl dcsp def xdiff a b dcnl dcsp dcsp return np abs a0 b0 dcnl dcsp def ydiff a b dcnl dcsp dcsp return np abs a1 b1 dcnl dcsp points np asarray points dcnl dcsp all combinations list combinations points 2 dcnl dcsp if width is none and height is none dcnl dcsp dcsp if len points < 1 dcnl dcsp dcsp dcsp width 1 0 dcnl dcsp dcsp dcsp height 1 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp a b all combinationsnp argmin pdist points dcnl dcsp dcsp dcsp w h xdiff a b ydiff a b dcnl dcsp dcsp dcsp if w h dcnl dcsp dcsp dcsp dcsp width w dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp height h dcnl dcsp if height is none dcnl dcsp dcsp hdist pdist points xdiff dcnl dcsp dcsp candidates all combinationsi for i d in enumerate hdist if d < width dcnl dcsp dcsp if len candidates 0 dcnl dcsp dcsp dcsp height 1 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp height np min ydiff c for c in candidates dcnl dcsp elif width is none dcnl dcsp dcsp vdist pdist points ydiff dcnl dcsp dcsp candidates all combinationsi for i d in enumerate vdist if d < height dcnl dcsp dcsp if len candidates 0 dcnl dcsp dcsp dcsp width 1 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp width np min xdiff c for c in candidates dcnl dcsp width 1 padding dcnl dcsp height 1 padding dcnl dcsp return width height
def find topomap coords info picks layout none dcsp if len picks 0 dcnl dcsp dcsp raise valueerror need dcsp more dcsp than dcsp 0 dcsp channels dcnl dcsp if layout is not none dcnl dcsp dcsp chs info chs i for i in picks dcnl dcsp dcsp pos layout poslayout names index ch ch name for ch in chs dcnl dcsp dcsp pos np asarray pos dcnl dcsp else dcnl dcsp dcsp pos auto topomap coords info picks dcnl dcsp return pos
def auto topomap coords info picks ignore overlap false to sphere true dcsp from scipy spatial distance import pdist squareform dcnl dcsp chs info chs i for i in picks dcnl dcsp locs3d np array ch loc 3 for ch in chs dcnl dcsp if len locs3d 0 or np allclose locs3d 0 dcnl dcsp dcsp logging warning did dcsp not dcsp find dcsp any dcsp electrode dcsp locations dcsp the dcsp info dcsp will dcsp attempt dcsp to dcsp use dcsp digitization dcsp points dcsp instead dcsp however dcsp if dcsp digitization dcsp points dcsp do dcsp not dcsp correspond dcsp to dcsp the dcsp eeg dcsp electrodes dcsp this dcsp will dcsp lead dcsp to dcsp bad dcsp results dcsp please dcsp verify dcsp that dcsp the dcsp sensor dcsp locations dcsp in dcsp the dcsp plot dcsp are dcsp accurate dcnl dcsp dcsp for ch in chs dcnl dcsp dcsp dcsp if ch kind fiff fiffv eeg ch dcnl dcsp dcsp dcsp dcsp raise valueerror cannot dcsp determine dcsp location dcsp of dcsp meg eog ecg dcsp channels dcsp using dcsp digitization dcsp points dcnl dcsp dcsp eeg ch names ch ch name for ch in info chs if ch kind fiff fiffv eeg ch dcnl dcsp dcsp if info dig is none or len info dig 0 dcnl dcsp dcsp dcsp raise runtimeerror no dcsp digitization dcsp points dcsp found dcnl dcsp dcsp locs3d np array point r for point in info dig if point kind fiff fiffv point eeg dcnl dcsp dcsp if len locs3d 0 dcnl dcsp dcsp dcsp raise runtimeerror did dcsp not dcsp find dcsp any dcsp digitization dcsp points dcsp of dcsp kind dcsp fiffv point eeg dcsp d dcsp in dcsp the dcsp info fiff fiffv point eeg dcnl dcsp dcsp if len locs3d len eeg ch names dcnl dcsp dcsp dcsp raise valueerror number dcsp of dcsp eeg dcsp digitization dcsp points dcsp d dcsp doesn t dcsp match dcsp the dcsp number dcsp of dcsp eeg dcsp channels dcsp d len locs3d len eeg ch names dcnl dcsp dcsp dig kinds fiff fiffv point cardinal fiff fiffv point eeg fiff fiffv point extra dcnl dcsp dcsp origin head fit sphere to headshape info dig kinds units m dcnl dcsp dcsp locs3d origin head dcnl dcsp dcsp eeg ch locs dict zip eeg ch names locs3d dcnl dcsp dcsp locs3d np array eeg ch locsch ch name for ch in chs dcnl dcsp dist pdist locs3d dcnl dcsp if np min dist < 1e10 and not ignore overlap dcnl dcsp dcsp problematic electrodes chselec i ch name for elec i in squareform dist < 1e10 any axis 0 nonzero 0 dcnl dcsp dcsp raise valueerror the dcsp following dcsp electrodes dcsp have dcsp overlapping dcsp positions n dcsp dcsp dcsp dcsp + str problematic electrodes + nthis dcsp causes dcsp problems dcsp during dcsp visualization dcnl dcsp if to sphere dcnl dcsp dcsp return pol to cart cart to sph locs3d 1 1 dcnl dcsp return pol to cart cart to sph locs3d
def topo to sphere pos eegs dcsp xs ys np array pos t dcnl dcsp sqs np max np sqrt xseegs 2 + yseegs 2 dcnl dcsp xs sqs dcnl dcsp ys sqs dcnl dcsp xs + 0 5 np mean xseegs dcnl dcsp ys + 0 5 np mean yseegs dcnl dcsp xs xs 2 0 1 0 dcnl dcsp ys ys 2 0 1 0 dcnl dcsp rs np clip np sqrt xs 2 + ys 2 0 0 1 0 dcnl dcsp alphas np arccos rs dcnl dcsp zs np sin alphas dcnl dcsp return np column stack xs ys zs
def pair grad sensors info layout none topomap coords true exclude bads raise error true dcsp pairs defaultdict list dcnl dcsp grad picks pick types info meg grad ref meg false exclude exclude dcnl dcsp for i in grad picks dcnl dcsp dcsp ch info chs i dcnl dcsp dcsp name ch ch name dcnl dcsp dcsp if name startswith meg dcnl dcsp dcsp dcsp if name endswith 2 3 dcnl dcsp dcsp dcsp dcsp key name 4 1 dcnl dcsp dcsp dcsp dcsp pairskey append ch dcnl dcsp pairs p for p in pairs values if len p 2 dcnl dcsp if len pairs 0 dcnl dcsp dcsp if raise error dcnl dcsp dcsp dcsp raise valueerror no dcsp grad dcsp channel dcsp pairs dcsp found dcnl dcsp dcsp else dcnl dcsp dcsp dcsp warn no dcsp grad dcsp channel dcsp pairs dcsp found dcnl dcsp dcsp dcsp return list dcnl dcsp grad chs sum pairs dcnl dcsp ch names info ch names dcnl dcsp picks ch names index c ch name for c in grad chs dcnl dcsp if topomap coords dcnl dcsp dcsp shape len pairs 2 1 dcnl dcsp dcsp coords find topomap coords info picks layout reshape shape mean axis 1 dcnl dcsp dcsp return picks coords dcnl dcsp else dcnl dcsp dcsp return picks
def pair grad sensors from ch names ch names dcsp pairs defaultdict list dcnl dcsp for i name in enumerate ch names dcnl dcsp dcsp if name startswith meg dcnl dcsp dcsp dcsp if name endswith 2 3 dcnl dcsp dcsp dcsp dcsp key name 4 1 dcnl dcsp dcsp dcsp dcsp pairskey append i dcnl dcsp pairs p for p in pairs values if len p 2 dcnl dcsp grad chs sum pairs dcnl dcsp return grad chs
def merge grad data data method rms dcsp data data reshape len data 2 2 1 dcnl dcsp if method mean dcnl dcsp dcsp data np mean data axis 1 dcnl dcsp elif method rms dcnl dcsp dcsp data np sqrt np sum data 2 axis 1 2 dcnl dcsp else dcnl dcsp dcsp raise valueerror method dcsp must dcsp be dcsp rms dcsp or dcsp mean dcsp got dcsp s method dcnl dcsp return data
def generate 2d layout xy w 0 07 h 0 05 pad 0 02 ch names none ch indices none name ecog bg image none normalize true dcsp from scipy ndimage import imread dcnl dcsp if ch indices is none dcnl dcsp dcsp ch indices np arange xy shape0 dcnl dcsp if ch names is none dcnl dcsp dcsp ch names 0 format i for i in ch indices dcnl dcsp if len ch names len ch indices dcnl dcsp dcsp raise valueerror dcsp ch dcsp names dcsp and dcsp indices dcsp must dcsp be dcsp equal dcnl dcsp if len ch names len xy dcnl dcsp dcsp raise valueerror dcsp ch dcsp names dcsp and dcsp xy dcsp vals dcsp must dcsp be dcsp equal dcnl dcsp x y xy copy astype float t dcnl dcsp if bg image is not none dcnl dcsp dcsp if isinstance bg image str dcnl dcsp dcsp dcsp img imread bg image dcnl dcsp dcsp else dcnl dcsp dcsp dcsp img bg image dcnl dcsp dcsp x img shape1 dcnl dcsp dcsp y img shape0 dcnl dcsp elif normalize dcnl dcsp dcsp for i dim in x y dcnl dcsp dcsp dcsp i dim i dim min 0 dcnl dcsp dcsp dcsp i dim i dim max 0 i dim min 0 dcnl dcsp box box size np vstack x y t padding pad dcnl dcsp box 0 0 box0 box1 dcnl dcsp w h np array i x shape0 for i in w h dcnl dcsp loc params np vstack x y w h t dcnl dcsp layout layout box loc params ch names ch indices name dcnl dcsp return layout
def get cudafft dcsp try dcnl dcsp dcsp from skcuda import fft dcnl dcsp except importerror dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from scikits cuda import fft dcnl dcsp dcsp except importerror dcnl dcsp dcsp dcsp fft none dcnl dcsp return fft
def get cuda memory dcsp if not cuda capable dcnl dcsp dcsp warn cuda dcsp not dcsp enabled dcsp returning dcsp zero dcsp for dcsp memory dcnl dcsp dcsp mem 0 dcnl dcsp else dcnl dcsp dcsp from pycuda driver import mem get info dcnl dcsp dcsp mem mem get info 0 dcnl dcsp return sizeof fmt mem
def init cuda ignore config false dcsp global cuda capable multiply inplace c128 halve c128 real c128 dcnl dcsp if cuda capable dcnl dcsp dcsp return dcnl dcsp if not ignore config and get config mne use cuda false lower true dcnl dcsp dcsp logger info cuda dcsp not dcsp enabled dcsp in dcsp config dcsp skipping dcsp initialization dcnl dcsp dcsp return dcnl dcsp cuda capable false dcnl dcsp try dcnl dcsp dcsp from pycuda import gpuarray driver dcnl dcsp dcsp from pycuda elementwise import elementwisekernel dcnl dcsp except importerror dcnl dcsp dcsp warn module dcsp pycuda dcsp not dcsp found dcsp cuda dcsp not dcsp enabled dcnl dcsp dcsp return dcnl dcsp try dcnl dcsp dcsp import pycuda autoinit dcnl dcsp except importerror dcnl dcsp dcsp warn pycuda autoinit dcsp could dcsp not dcsp be dcsp imported dcsp likely dcsp a dcsp hardware dcsp error dcsp cuda dcsp not dcsp enabled s explain exception dcnl dcsp dcsp return dcnl dcsp cudafft get cudafft dcnl dcsp if cudafft is none dcnl dcsp dcsp warn module dcsp scikitcuda dcsp not dcsp found dcsp cuda dcsp not dcsp enabled dcnl dcsp dcsp return dcnl dcsp multiply inplace c128 elementwisekernel pycuda complex<double dcsp a dcsp pycuda complex<double dcsp b bi dcsp dcsp ai multiply inplace dcnl dcsp halve c128 elementwisekernel pycuda complex<double dcsp a ai dcsp dcsp 2 0 halve value dcnl dcsp real c128 elementwisekernel pycuda complex<double dcsp a ai dcsp dcsp real ai real value dcnl dcsp try dcnl dcsp dcsp cudafft plan 16 np float64 np complex128 dcnl dcsp except exception dcnl dcsp dcsp warn device dcsp does dcsp not dcsp appear dcsp to dcsp support dcsp 64bit dcsp ffts dcsp cuda dcsp not dcsp enabled s explain exception dcnl dcsp dcsp return dcnl dcsp cuda capable true dcnl dcsp logger info enabling dcsp cuda dcsp with dcsp s dcsp available dcsp memory get cuda memory
def setup cuda fft multiply repeated n jobs h fft dcsp cuda dict dict use cuda false fft plan none ifft plan none x fft none x none dcnl dcsp n fft len h fft dcnl dcsp cuda fft len int n fft n fft 2 2 + 1 dcnl dcsp if n jobs cuda dcnl dcsp dcsp n jobs 1 dcnl dcsp dcsp init cuda dcnl dcsp dcsp if cuda capable dcnl dcsp dcsp dcsp from pycuda import gpuarray dcnl dcsp dcsp dcsp cudafft get cudafft dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp h fft gpuarray to gpu h fft cuda fft len astype complex len h fft dcnl dcsp dcsp dcsp dcsp cuda dict update use cuda true fft plan cudafft plan n fft np float64 np complex128 ifft plan cudafft plan n fft np complex128 np float64 x fft gpuarray empty cuda fft len np complex128 x gpuarray empty int n fft np float64 dcnl dcsp dcsp dcsp dcsp logger info using dcsp cuda dcsp for dcsp fft dcsp fir dcsp filtering dcnl dcsp dcsp dcsp except exception as exp dcnl dcsp dcsp dcsp dcsp logger info cuda dcsp not dcsp used dcsp could dcsp not dcsp instantiate dcsp memory dcsp arrays dcsp may dcsp be dcsp too dcsp large dcsp s dcsp falling dcsp back dcsp to dcsp n jobs 1 str exp dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info cuda dcsp not dcsp used dcsp cuda dcsp could dcsp not dcsp be dcsp initialized dcsp falling dcsp back dcsp to dcsp n jobs 1 dcnl dcsp return n jobs cuda dict h fft
def fft multiply repeated h fft x cuda dict dict use cuda false dcsp if not cuda dict use cuda dcnl dcsp dcsp x np real ifft h fft fft x overwrite x true ravel dcnl dcsp else dcnl dcsp dcsp cudafft get cudafft dcnl dcsp dcsp cuda dict x set x astype np float64 dcnl dcsp dcsp cudafft fft cuda dict x cuda dict x fft cuda dict fft plan dcnl dcsp dcsp multiply inplace c128 h fft cuda dict x fft dcnl dcsp dcsp cudafft ifft cuda dict x fft cuda dict x cuda dict ifft plan false dcnl dcsp dcsp x np array cuda dict x get dtype x dtype subok true copy false dcnl dcsp return x
def setup cuda fft resample n jobs w new len dcsp cuda dict dict use cuda false fft plan none ifft plan none x fft none x none y fft none y none dcnl dcsp n fft x n fft y len w new len dcnl dcsp cuda fft len x int n fft x n fft x 2 2 + 1 dcnl dcsp cuda fft len y int n fft y n fft y 2 2 + 1 dcnl dcsp if n jobs cuda dcnl dcsp dcsp n jobs 1 dcnl dcsp dcsp init cuda dcnl dcsp dcsp if cuda capable dcnl dcsp dcsp dcsp from pycuda import gpuarray dcnl dcsp dcsp dcsp cudafft get cudafft dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp w gpuarray to gpu w cuda fft len x astype complex n fft y dcnl dcsp dcsp dcsp dcsp cuda dict update use cuda true fft plan cudafft plan n fft x np float64 np complex128 ifft plan cudafft plan n fft y np complex128 np float64 x fft gpuarray zeros max cuda fft len x cuda fft len y np complex128 x gpuarray empty max int n fft x int n fft y np float64 dcnl dcsp dcsp dcsp dcsp logger info using dcsp cuda dcsp for dcsp fft dcsp resampling dcnl dcsp dcsp dcsp except exception dcnl dcsp dcsp dcsp dcsp logger info cuda dcsp not dcsp used dcsp could dcsp not dcsp instantiate dcsp memory dcsp arrays dcsp may dcsp be dcsp too dcsp large dcsp falling dcsp back dcsp to dcsp n jobs 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info cuda dcsp not dcsp used dcsp cuda dcsp could dcsp not dcsp be dcsp initialized dcsp falling dcsp back dcsp to dcsp n jobs 1 dcnl dcsp return n jobs cuda dict w
def fft resample x w new len npads to removes cuda dict dict use cuda false dcsp if x dtype np float64 dcnl dcsp dcsp x x astype np float64 dcnl dcsp x smart pad x npads dcnl dcsp old len len x dcnl dcsp shorter new len < old len dcnl dcsp if not cuda dict use cuda dcnl dcsp dcsp n int min new len old len dcnl dcsp dcsp x fft rfft x ravel dcnl dcsp dcsp x fft w np arange 1 len x + 1 2 real dcnl dcsp dcsp y fft np zeros new len np float64 dcnl dcsp dcsp sl 1 slice n dcnl dcsp dcsp y fftsl 1 x fftsl 1 dcnl dcsp dcsp if min new len old len 2 0 dcnl dcsp dcsp dcsp if new len old len dcnl dcsp dcsp dcsp dcsp y fft n 1 2 0 dcnl dcsp dcsp y irfft y fft overwrite x true ravel dcnl dcsp else dcnl dcsp dcsp cudafft get cudafft dcnl dcsp dcsp cuda dict x set np concatenate x np zeros max new len old len 0 x dtype dcnl dcsp dcsp cudafft fft cuda dict x cuda dict x fft cuda dict fft plan dcnl dcsp dcsp multiply inplace c128 w cuda dict x fft dcnl dcsp dcsp use len new len if shorter else old len dcnl dcsp dcsp func real c128 if shorter else halve c128 dcnl dcsp dcsp if use len 2 0 dcnl dcsp dcsp dcsp nyq int use len use len 2 2 dcnl dcsp dcsp dcsp func cuda dict x fft slice slice nyq nyq + 1 dcnl dcsp dcsp cudafft ifft cuda dict x fft cuda dict x cuda dict ifft plan scale false dcnl dcsp dcsp y cuda dict x get new len if shorter else none dcnl dcsp if to removes 0 any dcnl dcsp dcsp keep np ones new len dtype bool dcnl dcsp dcsp keep to removes0 false dcnl dcsp dcsp keep to removes1 false dcnl dcsp dcsp y np compress keep y dcnl dcsp return y
def smart pad x n pad dcsp if n pad 0 all dcnl dcsp dcsp return x dcnl dcsp elif n pad < 0 any dcnl dcsp dcsp raise runtimeerror n pad dcsp must dcsp be dcsp nonnegative dcnl dcsp l z pad np zeros max n pad0 len x + 1 0 dtype x dtype dcnl dcsp r z pad np zeros max n pad0 len x + 1 0 dtype x dtype dcnl dcsp return np concatenate l z pad 2 x0 xn pad0 0 1 x 2 x 1 x 2 n pad1 2 1 r z pad
def prepare source params inst inverse operator label none lambda2 1 0 9 0 method dspm nave 1 decim 1 pca true pick ori normal prepared false verbose none dcsp if not prepared dcnl dcsp dcsp inv prepare inverse operator inverse operator nave lambda2 method dcnl dcsp else dcnl dcsp dcsp inv inverse operator dcnl dcsp sel pick channels inverse operator inst ch names inv dcnl dcsp logger info picked dcsp d dcsp channels dcsp from dcsp the dcsp data len sel dcnl dcsp logger info computing dcsp inverse dcnl dcsp k noise norm vertno assemble kernel inv label method pick ori dcnl dcsp if pca dcnl dcsp dcsp u s vh linalg svd k full matrices false dcnl dcsp dcsp rank np sum s 1e08 s0 dcnl dcsp dcsp k s rank u rank dcnl dcsp dcsp vh vh rank dcnl dcsp dcsp logger info reducing dcsp data dcsp rank dcsp to dcsp d rank dcnl dcsp else dcnl dcsp dcsp vh none dcnl dcsp is free ori inverse operator source ori fiff fiffv mne free ori dcnl dcsp return k sel vh vertno is free ori noise norm
verbose dcnl def source band induced power epochs inverse operator bands label none lambda2 1 0 9 0 method dspm nave 1 n cycles 5 df 1 use fft false decim 1 baseline none baseline mode logratio pca true n jobs 1 prepared false verbose none dcsp method check method method dcnl dcsp frequencies np concatenate np arange band0 band1 + df 2 0 df for band in six iteritems bands dcnl dcsp powers vertno source induced power epochs inverse operator frequencies label label lambda2 lambda2 method method nave nave n cycles n cycles decim decim use fft use fft pca pca n jobs n jobs with plv false prepared prepared dcnl dcsp fs epochs info sfreq dcnl dcsp stcs dict dcnl dcsp subject subject from inverse inverse operator dcnl dcsp log rescale baseline baseline mode dcnl dcsp for name band in six iteritems bands dcnl dcsp dcsp idx k for k f in enumerate frequencies if band0 < f < band1 dcnl dcsp dcsp power np mean powers idx axis 1 dcnl dcsp dcsp power rescale power epochs times decim baseline baseline mode copy false verbose false dcnl dcsp dcsp tmin epochs times0 dcnl dcsp dcsp tstep float decim fs dcnl dcsp dcsp stc make stc power vertices vertno tmin tmin tstep tstep subject subject dcnl dcsp dcsp stcsname stc dcnl dcsp dcsp logger info done dcnl dcsp return stcs
def prepare tfr data decim pick ori ws k source ori dcsp n times data decim shape2 dcnl dcsp n freqs len ws dcnl dcsp n sources k shape0 dcnl dcsp is free ori false dcnl dcsp if source ori fiff fiffv mne free ori and pick ori is none dcnl dcsp dcsp is free ori true dcnl dcsp dcsp n sources 3 dcnl dcsp shape n sources n freqs n times dcnl dcsp return shape is free ori
verbose dcnl def compute pow plv data k sel ws source ori use fft vh with power with plv pick ori decim verbose none dcsp shape is free ori prepare tfr data decim pick ori ws k source ori dcnl dcsp n sources n times shape 2 dcnl dcsp power np zeros shape dtype np float dcnl dcsp plv np zeros shape dtype np complex if with plv else none dcnl dcsp for epoch in data dcnl dcsp dcsp epoch epochsel dcnl dcsp dcsp if vh is not none dcnl dcsp dcsp dcsp epoch np dot vh epoch dcnl dcsp dcsp power e plv e single epoch tfr data epoch is free ori is free ori k k ws ws use fft use fft decim decim shape shape with plv with plv with power with power dcnl dcsp dcsp power + power e dcnl dcsp dcsp if with plv dcnl dcsp dcsp dcsp plv + plv e dcnl dcsp return power plv
def single epoch tfr data is free ori k ws use fft decim shape with plv with power dcsp tfr e np zeros shape dtype np float dcnl dcsp plv e np zeros shape dtype np complex if with plv else none dcnl dcsp n sources n times shape dcnl dcsp for f w in enumerate ws dcnl dcsp dcsp tfr cwt data w use fft use fft decim decim dcnl dcsp dcsp tfr np asfortranarray tfr reshape len data 1 dcnl dcsp dcsp if with plv dcnl dcsp dcsp dcsp plv f np zeros n sources n times dtype np complex dcnl dcsp dcsp tfr f np zeros n sources n times dtype np float dcnl dcsp dcsp for k t in enumerate np real tfr np imag tfr dcnl dcsp dcsp dcsp sol np dot k t dcnl dcsp dcsp dcsp sol pick normal sol dcnl dcsp dcsp dcsp if is free ori dcnl dcsp dcsp dcsp dcsp sol pick normal sol2 3 dcnl dcsp dcsp dcsp if with plv dcnl dcsp dcsp dcsp dcsp if k 0 dcnl dcsp dcsp dcsp dcsp dcsp plv f + sol pick normal dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp plv f + 1j sol pick normal dcnl dcsp dcsp dcsp if is free ori dcnl dcsp dcsp dcsp dcsp logger debug combining dcsp the dcsp current dcsp components dcnl dcsp dcsp dcsp dcsp sol combine xyz sol square with power dcnl dcsp dcsp dcsp elif with power dcnl dcsp dcsp dcsp dcsp sol sol dcnl dcsp dcsp dcsp tfr f + sol dcnl dcsp dcsp dcsp del sol dcnl dcsp dcsp tfr e f + tfr f dcnl dcsp dcsp del tfr f dcnl dcsp dcsp if with plv dcnl dcsp dcsp dcsp plv f np abs plv f dcnl dcsp dcsp dcsp plv e f + plv f dcnl dcsp dcsp dcsp del plv f dcnl dcsp return tfr e plv e
verbose dcnl def source induced power epochs inverse operator frequencies label none lambda2 1 0 9 0 method dspm nave 1 n cycles 5 decim 1 use fft false pca true pick ori normal n jobs 1 with plv true zero mean false prepared false verbose none dcsp epochs data epochs get data dcnl dcsp k sel vh vertno is free ori noise norm prepare source params inst epochs inverse operator inverse operator label label lambda2 lambda2 method method nave nave pca pca pick ori pick ori prepared prepared verbose verbose dcnl dcsp inv inverse operator dcnl dcsp parallel my compute source tfrs n jobs parallel func compute pow plv n jobs dcnl dcsp fs epochs info sfreq dcnl dcsp logger info computing dcsp source dcsp power dcsp dcnl dcsp ws morlet fs frequencies n cycles n cycles zero mean zero mean dcnl dcsp n jobs min n jobs len epochs data dcnl dcsp out parallel my compute source tfrs data data k k sel sel ws ws source ori inv source ori use fft use fft vh vh with plv with plv with power true pick ori pick ori decim decim for data in np array split epochs data n jobs dcnl dcsp power sum o0 for o in out dcnl dcsp power len epochs data dcnl dcsp if with plv dcnl dcsp dcsp plv sum o1 for o in out dcnl dcsp dcsp plv np abs plv dcnl dcsp dcsp plv len epochs data dcnl dcsp else dcnl dcsp dcsp plv none dcnl dcsp if method mne dcnl dcsp dcsp power noise norm ravel none none 2 dcnl dcsp return power plv vertno
verbose dcnl def source induced power epochs inverse operator frequencies label none lambda2 1 0 9 0 method dspm nave 1 n cycles 5 decim 1 use fft false pick ori none baseline none baseline mode logratio pca true n jobs 1 zero mean false prepared false verbose none dcsp method check method method dcnl dcsp pick ori check ori pick ori dcnl dcsp power plv vertno source induced power epochs inverse operator frequencies label label lambda2 lambda2 method method nave nave n cycles n cycles decim decim use fft use fft pick ori pick ori pca pca n jobs n jobs prepared false dcnl dcsp power rescale power epochs times decim baseline baseline mode copy false dcnl dcsp return power plv
verbose dcnl def compute source psd raw inverse operator lambda2 1 0 9 0 method dspm tmin none tmax none fmin 0 0 fmax 200 0 n fft 2048 overlap 0 5 pick ori none label none nave 1 pca true prepared false verbose none dcsp from scipy signal import hanning dcnl dcsp pick ori check ori pick ori dcnl dcsp logger info considering dcsp frequencies dcsp g dcsp dcsp g dcsp hz fmin fmax dcnl dcsp k sel vh vertno is free ori noise norm prepare source params inst raw inverse operator inverse operator label label lambda2 lambda2 method method nave nave pca pca pick ori pick ori prepared prepared verbose verbose dcnl dcsp start stop 0 raw last samp + 1 raw first samp dcnl dcsp if tmin is not none dcnl dcsp dcsp start raw time as index tmin 0 dcnl dcsp if tmax is not none dcnl dcsp dcsp stop raw time as index tmax 0 + 1 dcnl dcsp n fft int n fft dcnl dcsp fs raw info sfreq dcnl dcsp window hanning n fft dcnl dcsp freqs fftpack fftfreq n fft 1 0 fs dcnl dcsp freqs mask freqs 0 freqs fmin freqs < fmax dcnl dcsp freqs freqsfreqs mask dcnl dcsp fstep np mean np diff freqs dcnl dcsp if is free ori and pick ori is none dcnl dcsp dcsp psd np zeros k shape0 3 np sum freqs mask dcnl dcsp else dcnl dcsp dcsp psd np zeros k shape0 np sum freqs mask dcnl dcsp n windows 0 dcnl dcsp for this start in np arange start stop int n fft 1 0 overlap dcnl dcsp dcsp data rawsel this start this start + n fft dcnl dcsp dcsp if data shape1 < n fft dcnl dcsp dcsp dcsp logger info skipping dcsp last dcsp buffer dcnl dcsp dcsp dcsp break dcnl dcsp dcsp if vh is not none dcnl dcsp dcsp dcsp data np dot vh data dcnl dcsp dcsp data windownone dcnl dcsp dcsp data fft fftpack fft data freqs mask dcnl dcsp dcsp sol np dot k data fft dcnl dcsp dcsp if is free ori and pick ori is none dcnl dcsp dcsp dcsp sol combine xyz sol square true dcnl dcsp dcsp else dcnl dcsp dcsp dcsp sol sol sol conj real dcnl dcsp dcsp if method mne dcnl dcsp dcsp dcsp sol noise norm 2 dcnl dcsp dcsp psd + sol dcnl dcsp dcsp n windows + 1 dcnl dcsp psd n windows dcnl dcsp psd 10 np log10 psd dcnl dcsp subject subject from inverse inverse operator dcnl dcsp stc make stc psd vertices vertno tmin fmin 0 001 tstep fstep 0 001 subject subject dcnl dcsp return stc
verbose dcnl def compute source psd epochs epochs inverse operator lambda2 1 0 9 0 method dspm fmin 0 0 fmax 200 0 pick ori none label none nave 1 pca true inv split none bandwidth 4 0 adaptive false low bias true n jobs 1 prepared false verbose none dcsp logger info considering dcsp frequencies dcsp g dcsp dcsp g dcsp hz fmin fmax dcnl dcsp k sel vh vertno is free ori noise norm prepare source params inst epochs inverse operator inverse operator label label lambda2 lambda2 method method nave nave pca pca pick ori pick ori prepared prepared verbose verbose dcnl dcsp if inv split is not none dcnl dcsp dcsp k split np array split k inv split dcnl dcsp else dcnl dcsp dcsp k split k dcnl dcsp n times len epochs times dcnl dcsp sfreq epochs info sfreq dcnl dcsp half nbw float bandwidth n times 2 sfreq dcnl dcsp if half nbw < 0 5 dcnl dcsp dcsp warn bandwidth dcsp too dcsp small dcsp using dcsp minimum dcsp normalized dcsp 0 5 dcnl dcsp dcsp half nbw 0 5 dcnl dcsp n tapers max int 2 half nbw dcnl dcsp dpss eigvals dpss windows n times half nbw n tapers max low bias low bias dcnl dcsp n tapers len dpss dcnl dcsp logger info using dcsp d dcsp tapers dcsp with dcsp bandwidth dcsp 0 1fhz n tapers bandwidth dcnl dcsp if adaptive and len eigvals < 3 dcnl dcsp dcsp warn not dcsp adaptively dcsp combining dcsp the dcsp spectral dcsp estimators dcsp due dcsp to dcsp a dcsp low dcsp number dcsp of dcsp tapers dcnl dcsp dcsp adaptive false dcnl dcsp if adaptive dcnl dcsp dcsp parallel my psd from mt adaptive n jobs parallel func psd from mt adaptive n jobs dcnl dcsp else dcnl dcsp dcsp weights np sqrt eigvals np newaxis np newaxis dcnl dcsp subject subject from inverse inverse operator dcnl dcsp for k e in enumerate epochs dcnl dcsp dcsp logger info processing dcsp epoch dcsp dcsp d k + 1 dcnl dcsp dcsp data esel dcnl dcsp dcsp if vh is not none dcnl dcsp dcsp dcsp data np dot vh data dcnl dcsp dcsp x mt freqs mt spectra data dpss sfreq dcnl dcsp dcsp if k 0 dcnl dcsp dcsp dcsp freq mask freqs fmin freqs < fmax dcnl dcsp dcsp dcsp fstep np mean np diff freqs dcnl dcsp dcsp psd np empty k shape0 np sum freq mask dcnl dcsp dcsp pos 0 dcnl dcsp dcsp for k part in k split dcnl dcsp dcsp dcsp x mt src np empty k part shape0 x mt shape1 x mt shape2 dtype x mt dtype dcnl dcsp dcsp dcsp for i in range n tapers dcnl dcsp dcsp dcsp dcsp x mt src i np dot k part x mt i dcnl dcsp dcsp dcsp if adaptive dcnl dcsp dcsp dcsp dcsp out parallel my psd from mt adaptive x eigvals freq mask for x in np array split x mt src min n jobs len x mt src dcnl dcsp dcsp dcsp dcsp this psd np concatenate out dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp x mt src x mt src freq mask dcnl dcsp dcsp dcsp dcsp this psd psd from mt x mt src weights dcnl dcsp dcsp dcsp psdpos pos + k part shape0 this psd dcnl dcsp dcsp dcsp pos + k part shape0 dcnl dcsp dcsp if is free ori and pick ori is none dcnl dcsp dcsp dcsp psd combine xyz psd square false dcnl dcsp dcsp if method mne dcnl dcsp dcsp dcsp psd noise norm 2 dcnl dcsp dcsp stc make stc psd tmin fmin tstep fstep vertices vertno subject subject dcnl dcsp dcsp yield stc
verbose dcnl def compute source psd epochs epochs inverse operator lambda2 1 0 9 0 method dspm fmin 0 0 fmax 200 0 pick ori none label none nave 1 pca true inv split none bandwidth 4 0 adaptive false low bias true return generator false n jobs 1 prepared false verbose none dcsp stcs gen compute source psd epochs epochs inverse operator lambda2 lambda2 method method fmin fmin fmax fmax pick ori pick ori label label nave nave pca pca inv split inv split bandwidth bandwidth adaptive adaptive low bias low bias n jobs n jobs prepared prepared dcnl dcsp if return generator dcnl dcsp dcsp return stcs gen dcnl dcsp else dcnl dcsp dcsp stcs list dcnl dcsp dcsp for stc in stcs gen dcnl dcsp dcsp dcsp stcs append stc dcnl dcsp dcsp return stcs
def pick channels inverse operator ch names inv dcsp sel list dcnl dcsp for name in inv noise cov ch names dcnl dcsp dcsp try dcnl dcsp dcsp dcsp sel append ch names index name dcnl dcsp dcsp except valueerror dcnl dcsp dcsp dcsp raise valueerror the dcsp inverse dcsp operator dcsp was dcsp computed dcsp with dcsp channel dcsp s dcsp which dcsp is dcsp not dcsp present dcsp in dcsp the dcsp data dcsp you dcsp should dcsp compute dcsp a dcsp new dcsp inverse dcsp operator dcsp restricted dcsp to dcsp the dcsp good dcsp data dcsp channels name dcnl dcsp return sel
verbose dcnl def read inverse operator fname verbose none dcsp check fname fname inverse dcsp operator inv fif inv fif gz dcnl dcsp logger info reading dcsp inverse dcsp operator dcsp decomposition dcsp from dcsp s fname dcnl dcsp f tree fiff open fname preload true dcnl dcsp with f as fid dcnl dcsp dcsp invs dir tree find tree fiff fiffb mne inverse solution dcnl dcsp dcsp if invs is none or len invs < 1 dcnl dcsp dcsp dcsp raise exception no dcsp inverse dcsp solutions dcsp in dcsp s fname dcnl dcsp dcsp invs invs0 dcnl dcsp dcsp parent mri dir tree find tree fiff fiffb mne parent mri file dcnl dcsp dcsp if len parent mri 0 dcnl dcsp dcsp dcsp raise exception no dcsp parent dcsp mri dcsp information dcsp in dcsp s fname dcnl dcsp dcsp parent mri parent mri0 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp reading dcsp inverse dcsp operator dcsp info dcnl dcsp dcsp tag find tag fid invs fiff fiff mne included methods dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception modalities dcsp not dcsp found dcnl dcsp dcsp inv dict dcnl dcsp dcsp inv methods int tag data dcnl dcsp dcsp tag find tag fid invs fiff fiff mne source orientation dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception source dcsp orientation dcsp constraints dcsp not dcsp found dcnl dcsp dcsp inv source ori int tag data dcnl dcsp dcsp tag find tag fid invs fiff fiff mne source space npoints dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception number dcsp of dcsp sources dcsp not dcsp found dcnl dcsp dcsp inv nsource int tag data dcnl dcsp dcsp inv nchan 0 dcnl dcsp dcsp tag find tag fid invs fiff fiff mne coord frame dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception coordinate dcsp frame dcsp tag dcsp not dcsp found dcnl dcsp dcsp inv coord frame tag data dcnl dcsp dcsp tag find tag fid invs fiff fiff mne inverse source unit dcnl dcsp dcsp unit dict fiff fiff unit am am fiff fiff unit am m2 am m^2 fiff fiff unit am m3 am m^3 dcnl dcsp dcsp inv units unit dict get int getattr tag data 1 none dcnl dcsp dcsp tag find tag fid invs fiff fiff mne inverse source orientations dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception source dcsp orientation dcsp information dcsp not dcsp found dcnl dcsp dcsp inv source nn tag data dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp done dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp reading dcsp inverse dcsp operator dcsp decomposition dcnl dcsp dcsp tag find tag fid invs fiff fiff mne inverse sing dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception singular dcsp values dcsp not dcsp found dcnl dcsp dcsp inv sing tag data dcnl dcsp dcsp inv nchan len inv sing dcnl dcsp dcsp inv eigen leads weighted false dcnl dcsp dcsp inv eigen leads read named matrix fid invs fiff fiff mne inverse leads transpose true dcnl dcsp dcsp if inv eigen leads is none dcnl dcsp dcsp dcsp inv eigen leads weighted true dcnl dcsp dcsp dcsp inv eigen leads read named matrix fid invs fiff fiff mne inverse leads weighted transpose true dcnl dcsp dcsp if inv eigen leads is none dcnl dcsp dcsp dcsp raise valueerror eigen dcsp leads dcsp not dcsp found dcsp in dcsp inverse dcsp operator dcnl dcsp dcsp inv eigen fields read named matrix fid invs fiff fiff mne inverse fields dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp done dcnl dcsp dcsp inv noise cov covariance read cov fid invs fiff fiffv mne noise cov limited true dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp noise dcsp covariance dcsp matrix dcsp read dcnl dcsp dcsp inv source cov read cov fid invs fiff fiffv mne source cov dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp source dcsp covariance dcsp matrix dcsp read dcnl dcsp dcsp inv orient prior read cov fid invs fiff fiffv mne orient prior cov dcnl dcsp dcsp if inv orient prior is not none dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp orientation dcsp priors dcsp read dcnl dcsp dcsp inv depth prior read cov fid invs fiff fiffv mne depth prior cov dcnl dcsp dcsp if inv depth prior is not none dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp depth dcsp priors dcsp read dcnl dcsp dcsp inv fmri prior read cov fid invs fiff fiffv mne fmri prior cov dcnl dcsp dcsp if inv fmri prior is not none dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp fmri dcsp priors dcsp read dcnl dcsp dcsp inv src read source spaces from tree fid tree patch stats false dcnl dcsp dcsp for s in inv src dcnl dcsp dcsp dcsp s id find source space hemi s dcnl dcsp dcsp tag find tag fid parent mri fiff fiff coord trans dcnl dcsp dcsp if tag is none dcnl dcsp dcsp dcsp raise exception mri head dcsp coordinate dcsp transformation dcsp not dcsp found dcnl dcsp dcsp mri head t ensure trans tag data mri head dcnl dcsp dcsp inv mri head t mri head t dcnl dcsp dcsp inv info read forward meas info tree fid dcnl dcsp dcsp if inv coord frame not in fiff fiffv coord mri fiff fiffv coord head dcnl dcsp dcsp dcsp raise exception only dcsp inverse dcsp solutions dcsp computed dcsp in dcsp mri dcsp or dcsp head dcsp coordinates dcsp are dcsp acceptable dcnl dcsp dcsp inv nave 1 dcnl dcsp dcsp inv projs read proj fid tree dcnl dcsp dcsp inv proj dcnl dcsp dcsp inv whitener dcnl dcsp dcsp inv reginv dcnl dcsp dcsp inv noisenorm dcnl dcsp dcsp nuse 0 dcnl dcsp dcsp for k in range len inv src dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp inv src k transform surface to inv src k inv coord frame mri head t dcnl dcsp dcsp dcsp except exception as inst dcnl dcsp dcsp dcsp dcsp raise exception could dcsp not dcsp transform dcsp source dcsp space dcsp s inst dcnl dcsp dcsp dcsp nuse + inv src k nuse dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp source dcsp spaces dcsp transformed dcsp to dcsp the dcsp inverse dcsp solution dcsp coordinate dcsp frame dcnl dcsp return inverseoperator inv
verbose dcnl def write inverse operator fname inv verbose none dcsp check fname fname inverse dcsp operator inv fif inv fif gz dcnl dcsp logger info write dcsp inverse dcsp operator dcsp decomposition dcsp in dcsp s fname dcnl dcsp fid start file fname dcnl dcsp start block fid fiff fiffb mne dcnl dcsp write forward meas info fid inv info dcnl dcsp start block fid fiff fiffb mne parent mri file dcnl dcsp write string fid fiff fiff mne file name inv info mri file dcnl dcsp write coord trans fid inv mri head t dcnl dcsp end block fid fiff fiffb mne parent mri file dcnl dcsp write proj fid inv projs dcnl dcsp if src in inv dcnl dcsp dcsp write source spaces to fid fid inv src dcnl dcsp start block fid fiff fiffb mne inverse solution dcnl dcsp logger info dcsp dcsp dcsp dcsp writing dcsp inverse dcsp operator dcsp info dcnl dcsp write int fid fiff fiff mne included methods inv methods dcnl dcsp write int fid fiff fiff mne coord frame inv coord frame dcnl dcsp udict am fiff fiff unit am am m^2 fiff fiff unit am m2 am m^3 fiff fiff unit am m3 dcnl dcsp if units in inv and inv units is not none dcnl dcsp dcsp write int fid fiff fiff mne inverse source unit udictinv units dcnl dcsp write int fid fiff fiff mne source orientation inv source ori dcnl dcsp write int fid fiff fiff mne source space npoints inv nsource dcnl dcsp if nchan in inv dcnl dcsp dcsp write int fid fiff fiff nchan inv nchan dcnl dcsp elif nchan in inv info dcnl dcsp dcsp write int fid fiff fiff nchan inv info nchan dcnl dcsp write float matrix fid fiff fiff mne inverse source orientations inv source nn dcnl dcsp write float fid fiff fiff mne inverse sing inv sing dcnl dcsp logger info dcsp dcsp dcsp dcsp writing dcsp noise dcsp covariance dcsp matrix dcnl dcsp write cov fid inv noise cov dcnl dcsp logger info dcsp dcsp dcsp dcsp writing dcsp source dcsp covariance dcsp matrix dcnl dcsp write cov fid inv source cov dcnl dcsp logger info dcsp dcsp dcsp dcsp writing dcsp orientation dcsp priors dcnl dcsp if inv depth prior is not none dcnl dcsp dcsp write cov fid inv depth prior dcnl dcsp if inv orient prior is not none dcnl dcsp dcsp write cov fid inv orient prior dcnl dcsp if inv fmri prior is not none dcnl dcsp dcsp write cov fid inv fmri prior dcnl dcsp write named matrix fid fiff fiff mne inverse fields inv eigen fields dcnl dcsp if inv eigen leads weighted dcnl dcsp dcsp kind fiff fiff mne inverse leads weighted dcnl dcsp else dcnl dcsp dcsp kind fiff fiff mne inverse leads dcnl dcsp transpose named matrix inv eigen leads dcnl dcsp write named matrix fid kind inv eigen leads dcnl dcsp transpose named matrix inv eigen leads dcnl dcsp logger info dcsp dcsp dcsp dcsp done dcnl dcsp end block fid fiff fiffb mne inverse solution dcnl dcsp end block fid fiff fiffb mne dcnl dcsp end file fid dcnl dcsp fid close
def combine xyz vec square false dcsp if vec ndim 2 dcnl dcsp dcsp raise valueerror input dcsp must dcsp be dcsp 2d dcnl dcsp if vec shape0 3 0 dcnl dcsp dcsp raise valueerror input dcsp must dcsp have dcsp 3n dcsp rows dcnl dcsp n p vec shape dcnl dcsp if np iscomplexobj vec dcnl dcsp dcsp vec np abs vec dcnl dcsp comb vec0 3 2 dcnl dcsp comb + vec1 3 2 dcnl dcsp comb + vec2 3 2 dcnl dcsp if not square dcnl dcsp dcsp comb np sqrt comb dcnl dcsp return comb
def check ch names inv info dcsp inv ch names inv eigen fields col names dcnl dcsp if inv noise cov ch names inv ch names dcnl dcsp dcsp raise valueerror channels dcsp in dcsp inverse dcsp operator dcsp eigen dcsp fields dcsp do dcsp not dcsp match dcsp noise dcsp covariance dcsp channels dcnl dcsp data ch names info ch names dcnl dcsp missing ch names list dcnl dcsp for ch name in inv ch names dcnl dcsp dcsp if ch name not in data ch names dcnl dcsp dcsp dcsp missing ch names append ch name dcnl dcsp n missing len missing ch names dcnl dcsp if n missing 0 dcnl dcsp dcsp raise valueerror d dcsp channels dcsp in dcsp inverse dcsp operator dcsp n missing + are dcsp not dcsp present dcsp in dcsp the dcsp data dcsp s missing ch names
verbose dcnl def prepare inverse operator orig nave lambda2 method verbose none dcsp if nave < 0 dcnl dcsp dcsp raise valueerror the dcsp number dcsp of dcsp averages dcsp should dcsp be dcsp positive dcnl dcsp logger info preparing dcsp the dcsp inverse dcsp operator dcsp for dcsp use dcnl dcsp inv orig copy dcnl dcsp scale float inv nave nave dcnl dcsp inv noise cov data scale inv noise cov data dcnl dcsp if inv noise cov data ndim 1 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp diagonal dcsp noise dcsp covariance dcsp found dcnl dcsp dcsp inv noise cov eig inv noise cov data dcnl dcsp dcsp inv noise cov eigvec np eye len inv noise cov data dcnl dcsp inv noise cov eig scale inv noise cov eig dcnl dcsp inv source cov data scale inv source cov data dcnl dcsp if inv eigen leads weighted dcnl dcsp dcsp inv eigen leads data sqrt scale inv eigen leads data dcnl dcsp logger info dcsp dcsp dcsp dcsp scaled dcsp noise dcsp and dcsp source dcsp covariance dcsp from dcsp nave dcsp dcsp d dcsp to dcsp nave dcsp dcsp d inv nave nave dcnl dcsp inv nave nave dcnl dcsp sing np array inv sing dtype np float64 dcnl dcsp inv reginv sing sing 2 + lambda2 dcnl dcsp logger info dcsp dcsp dcsp dcsp created dcsp the dcsp regularized dcsp inverter dcnl dcsp inv proj ncomp make projector inv projs inv noise cov names dcnl dcsp if ncomp 0 dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp created dcsp an dcsp ssp dcsp operator dcsp subspace dcsp dimension dcsp dcsp d ncomp dcnl dcsp else dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp the dcsp projection dcsp vectors dcsp do dcsp not dcsp apply dcsp to dcsp these dcsp channels dcnl dcsp if not inv noise cov diag dcnl dcsp dcsp inv whitener np zeros inv noise cov dim inv noise cov dim dcnl dcsp dcsp eig inv noise cov eig dcnl dcsp dcsp nzero eig 0 dcnl dcsp dcsp inv whitener nzero nzero 1 0 np sqrt eignzero dcnl dcsp dcsp inv whitener np dot inv whitener inv noise cov eigvec dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp created dcsp the dcsp whitener dcsp using dcsp a dcsp full dcsp noise dcsp covariance dcsp matrix dcsp d dcsp small dcsp eigenvalues dcsp omitted inv noise cov dim np sum nzero dcnl dcsp else dcnl dcsp dcsp inv whitener np diag 1 0 np sqrt inv noise cov data ravel dcnl dcsp dcsp logger info dcsp dcsp dcsp dcsp created dcsp the dcsp whitener dcsp using dcsp a dcsp diagonal dcsp noise dcsp covariance dcsp matrix dcsp d dcsp small dcsp eigenvalues dcsp discarded ncomp dcnl dcsp if method in dspm sloreta dcnl dcsp dcsp if method dspm dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp computing dcsp noisenormalization dcsp factors dcsp dspm dcnl dcsp dcsp dcsp noise weight inv reginv dcnl dcsp dcsp else dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp computing dcsp noisenormalization dcsp factors dcsp sloreta dcnl dcsp dcsp dcsp noise weight inv reginv np sqrt 1 0 + inv sing 2 lambda2 dcnl dcsp dcsp noise norm np zeros inv eigen leads nrow dcnl dcsp dcsp nrm2 linalg get blas funcs nrm2 noise norm dcnl dcsp dcsp if inv eigen leads weighted dcnl dcsp dcsp dcsp for k in range inv eigen leads nrow dcnl dcsp dcsp dcsp dcsp one inv eigen leads data k noise weight dcnl dcsp dcsp dcsp dcsp noise normk nrm2 one dcnl dcsp dcsp else dcnl dcsp dcsp dcsp for k in range inv eigen leads nrow dcnl dcsp dcsp dcsp dcsp one sqrt inv source cov data k inv eigen leads data k noise weight dcnl dcsp dcsp dcsp dcsp noise normk nrm2 one dcnl dcsp dcsp if inv source ori fiff fiffv mne free ori dcnl dcsp dcsp dcsp noise norm combine xyz noise norm none ravel dcnl dcsp dcsp inv noisenorm 1 0 np abs noise norm dcnl dcsp dcsp logger info done dcnl dcsp else dcnl dcsp dcsp inv noisenorm dcnl dcsp return inverseoperator inv
verbose dcnl def assemble kernel inv label method pick ori verbose none dcsp eigen leads inv eigen leads data dcnl dcsp source cov inv source cov data none dcnl dcsp if method mne dcnl dcsp dcsp noise norm inv noisenorm none dcnl dcsp src inv src dcnl dcsp vertno get vertno src dcnl dcsp if label is not none dcnl dcsp dcsp vertno src sel label src vertno sel label inv src dcnl dcsp dcsp if method mne dcnl dcsp dcsp dcsp noise norm noise normsrc sel dcnl dcsp dcsp if inv source ori fiff fiffv mne free ori dcnl dcsp dcsp dcsp src sel 3 src sel dcnl dcsp dcsp dcsp src sel np c src sel src sel + 1 src sel + 2 dcnl dcsp dcsp dcsp src sel src sel ravel dcnl dcsp dcsp eigen leads eigen leadssrc sel dcnl dcsp dcsp source cov source covsrc sel dcnl dcsp if pick ori normal dcnl dcsp dcsp if not inv source ori fiff fiffv mne free ori dcnl dcsp dcsp dcsp raise valueerror picking dcsp normal dcsp orientation dcsp can dcsp only dcsp be dcsp done dcsp with dcsp a dcsp free dcsp orientation dcsp inverse dcsp operator dcnl dcsp dcsp is loose 0 < inv orient prior data 0 < 1 dcnl dcsp dcsp if not is loose dcnl dcsp dcsp dcsp raise valueerror picking dcsp normal dcsp orientation dcsp can dcsp only dcsp be dcsp done dcsp when dcsp working dcsp with dcsp loose dcsp orientations dcnl dcsp dcsp eigen leads eigen leads2 3 dcnl dcsp dcsp source cov source cov2 3 dcnl dcsp trans inv reginv none reduce np dot inv eigen fields data inv whitener inv proj dcnl dcsp if inv eigen leads weighted dcnl dcsp dcsp logger info eigenleads dcsp already dcsp weighted dcnl dcsp dcsp k np dot eigen leads trans dcnl dcsp else dcnl dcsp dcsp logger info eigenleads dcsp need dcsp to dcsp be dcsp weighted dcnl dcsp dcsp k np sqrt source cov np dot eigen leads trans dcnl dcsp if method mne dcnl dcsp dcsp noise norm none dcnl dcsp return k noise norm vertno
def check method method dcsp if method not in mne dspm sloreta dcnl dcsp dcsp raise valueerror method dcsp parameter dcsp should dcsp be dcsp mne dcsp or dcsp dspm dcsp or dcsp sloreta dcnl dcsp return method
def check ori pick ori dcsp if pick ori is not none and pick ori normal dcnl dcsp dcsp raise runtimeerror pick ori dcsp must dcsp be dcsp none dcsp or dcsp normal dcsp not dcsp s pick ori dcnl dcsp return pick ori
def check reference inst dcsp if needs eeg average ref proj inst info dcnl dcsp dcsp raise valueerror eeg dcsp average dcsp reference dcsp is dcsp mandatory dcsp for dcsp inverse dcsp modeling dcsp use dcsp set eeg reference dcsp method dcnl dcsp if inst info custom ref applied dcnl dcsp dcsp raise valueerror custom dcsp eeg dcsp reference dcsp is dcsp not dcsp allowed dcsp for dcsp inverse dcsp modeling
def subject from inverse inverse operator dcsp return inverse operator src 0 get subject his id none
verbose dcnl def apply inverse evoked inverse operator lambda2 1 0 9 0 method dspm pick ori none prepared false label none verbose none dcsp check reference evoked dcnl dcsp method check method method dcnl dcsp pick ori check ori pick ori dcnl dcsp nave evoked nave dcnl dcsp check ch names inverse operator evoked info dcnl dcsp if not prepared dcnl dcsp dcsp inv prepare inverse operator inverse operator nave lambda2 method dcnl dcsp else dcnl dcsp dcsp inv inverse operator dcnl dcsp sel pick channels inverse operator evoked ch names inv dcnl dcsp logger info picked dcsp d dcsp channels dcsp from dcsp the dcsp data len sel dcnl dcsp logger info computing dcsp inverse dcnl dcsp k noise norm vertno assemble kernel inv label method pick ori dcnl dcsp sol np dot k evoked datasel dcnl dcsp is free ori inverse operator source ori fiff fiffv mne free ori and pick ori is none dcnl dcsp if is free ori dcnl dcsp dcsp logger info combining dcsp the dcsp current dcsp components dcnl dcsp dcsp sol combine xyz sol dcnl dcsp if noise norm is not none dcnl dcsp dcsp logger info dspm dcnl dcsp dcsp sol noise norm dcnl dcsp tstep 1 0 evoked info sfreq dcnl dcsp tmin float evoked times0 dcnl dcsp subject subject from inverse inverse operator dcnl dcsp stc make stc sol vertices vertno tmin tmin tstep tstep subject subject dcnl dcsp logger info done dcnl dcsp return stc
verbose dcnl def apply inverse raw raw inverse operator lambda2 method dspm label none start none stop none nave 1 time func none pick ori none buffer size none prepared false verbose none dcsp check reference raw dcnl dcsp method check method method dcnl dcsp pick ori check ori pick ori dcnl dcsp check ch names inverse operator raw info dcnl dcsp if not prepared dcnl dcsp dcsp inv prepare inverse operator inverse operator nave lambda2 method dcnl dcsp else dcnl dcsp dcsp inv inverse operator dcnl dcsp sel pick channels inverse operator raw ch names inv dcnl dcsp logger info picked dcsp d dcsp channels dcsp from dcsp the dcsp data len sel dcnl dcsp logger info computing dcsp inverse dcnl dcsp data times rawsel start stop dcnl dcsp if time func is not none dcnl dcsp dcsp data time func data dcnl dcsp k noise norm vertno assemble kernel inv label method pick ori dcnl dcsp is free ori inverse operator source ori fiff fiffv mne free ori and pick ori is none dcnl dcsp if buffer size is not none and is free ori dcnl dcsp dcsp n seg int np ceil data shape1 float buffer size dcnl dcsp dcsp logger info computing dcsp inverse dcsp and dcsp combining dcsp the dcsp current dcsp components dcsp using dcsp d dcsp segments n seg dcnl dcsp dcsp n times data shape1 dcnl dcsp dcsp sol np empty k shape0 3 n times dtype k 0 0 data 0 0 dtype dcnl dcsp dcsp for pos in range 0 n times buffer size dcnl dcsp dcsp dcsp sol pos pos + buffer size combine xyz np dot k data pos pos + buffer size dcnl dcsp dcsp dcsp logger info segment dcsp d dcsp dcsp d dcsp done pos buffer size + 1 n seg dcnl dcsp else dcnl dcsp dcsp sol np dot k data dcnl dcsp dcsp if is free ori dcnl dcsp dcsp dcsp logger info combining dcsp the dcsp current dcsp components dcnl dcsp dcsp dcsp sol combine xyz sol dcnl dcsp if noise norm is not none dcnl dcsp dcsp sol noise norm dcnl dcsp tmin float times0 dcnl dcsp tstep 1 0 raw info sfreq dcnl dcsp subject subject from inverse inverse operator dcnl dcsp stc make stc sol vertices vertno tmin tmin tstep tstep subject subject dcnl dcsp logger info done dcnl dcsp return stc
def apply inverse epochs gen epochs inverse operator lambda2 method dspm label none nave 1 pick ori none prepared false verbose none dcsp method check method method dcnl dcsp pick ori check ori pick ori dcnl dcsp check ch names inverse operator epochs info dcnl dcsp if not prepared dcnl dcsp dcsp inv prepare inverse operator inverse operator nave lambda2 method dcnl dcsp else dcnl dcsp dcsp inv inverse operator dcnl dcsp sel pick channels inverse operator epochs ch names inv dcnl dcsp logger info picked dcsp d dcsp channels dcsp from dcsp the dcsp data len sel dcnl dcsp logger info computing dcsp inverse dcnl dcsp k noise norm vertno assemble kernel inv label method pick ori dcnl dcsp tstep 1 0 epochs info sfreq dcnl dcsp tmin epochs times0 dcnl dcsp is free ori inverse operator source ori fiff fiffv mne free ori and pick ori is none dcnl dcsp if not is free ori and noise norm is not none dcnl dcsp dcsp k noise norm dcnl dcsp subject subject from inverse inverse operator dcnl dcsp for k e in enumerate epochs dcnl dcsp dcsp logger info processing dcsp epoch dcsp dcsp d k + 1 dcnl dcsp dcsp if is free ori dcnl dcsp dcsp dcsp sol np dot k esel dcnl dcsp dcsp dcsp if is free ori dcnl dcsp dcsp dcsp dcsp logger info combining dcsp the dcsp current dcsp components dcnl dcsp dcsp dcsp dcsp sol combine xyz sol dcnl dcsp dcsp dcsp dcsp if noise norm is not none dcnl dcsp dcsp dcsp dcsp dcsp sol noise norm dcnl dcsp dcsp elif len sel < k shape0 dcnl dcsp dcsp dcsp sol k esel dcnl dcsp dcsp else dcnl dcsp dcsp dcsp sol np dot k esel dcnl dcsp dcsp stc make stc sol vertices vertno tmin tmin tstep tstep subject subject dcnl dcsp dcsp yield stc dcnl dcsp logger info done
verbose dcnl def apply inverse epochs epochs inverse operator lambda2 method dspm label none nave 1 pick ori none return generator false prepared false verbose none dcsp check reference epochs dcnl dcsp stcs apply inverse epochs gen epochs inverse operator lambda2 method method label label nave nave pick ori pick ori verbose verbose prepared prepared dcnl dcsp if not return generator dcnl dcsp dcsp stcs stc for stc in stcs dcnl dcsp return stcs
verbose dcnl def prepare forward forward info noise cov pca false rank none verbose none dcsp fwd sol ch names forward sol row names dcnl dcsp ch names c ch name for c in info chs if c ch name not in info bads and c ch name not in noise cov bads and c ch name in fwd sol ch names and c ch name in noise cov ch names dcnl dcsp if not len info bads len noise cov bads or not all b in noise cov bads for b in info bads dcnl dcsp dcsp logger info info bads dcsp and dcsp noise cov bads dcsp do dcsp not dcsp match dcsp excluding dcsp bad dcsp channels dcsp from dcsp both dcnl dcsp n chan len ch names dcnl dcsp logger info computing dcsp inverse dcsp operator dcsp with dcsp d dcsp channels n chan dcnl dcsp noise cov prepare noise cov noise cov info ch names rank dcnl dcsp eig noise cov eig dcnl dcsp nzero eig 0 dcnl dcsp n nzero sum nzero dcnl dcsp if pca dcnl dcsp dcsp whitener noise cov eigvec nzero np sqrt eignzero none dcnl dcsp dcsp logger info reducing dcsp data dcsp rank dcsp to dcsp d n nzero dcnl dcsp else dcnl dcsp dcsp whitener np zeros n chan n chan dtype np float dcnl dcsp dcsp whitener nzero nzero 1 0 np sqrt eignzero dcnl dcsp dcsp whitener np dot whitener noise cov eigvec dcnl dcsp gain forward sol data dcnl dcsp fwd idx fwd sol ch names index name for name in ch names dcnl dcsp gain gainfwd idx dcnl dcsp info idx info ch names index name for name in ch names dcnl dcsp fwd info pick info info info idx dcnl dcsp logger info total dcsp rank dcsp is dcsp d n nzero dcnl dcsp return fwd info gain noise cov whitener n nzero
verbose dcnl def make inverse operator info forward noise cov loose 0 2 depth 0 8 fixed false limit depth chs true rank none verbose none dcsp is fixed ori is fixed orient forward dcnl dcsp if fixed and loose is not none dcnl dcsp dcsp warn when dcsp invoking dcsp make inverse operator dcsp with dcsp fixed true dcsp the dcsp loose dcsp parameter dcsp is dcsp ignored dcnl dcsp dcsp loose none dcnl dcsp if is fixed ori and not fixed dcnl dcsp dcsp raise valueerror forward dcsp operator dcsp has dcsp fixed dcsp orientation dcsp and dcsp can dcsp only dcsp be dcsp used dcsp to dcsp make dcsp a dcsp fixedorientation dcsp inverse dcsp operator dcnl dcsp if fixed dcnl dcsp dcsp if depth is not none dcnl dcsp dcsp dcsp if is fixed ori or not forward surf ori dcnl dcsp dcsp dcsp dcsp raise valueerror for dcsp a dcsp fixed dcsp orientation dcsp inverse dcsp solution dcsp with dcsp depth dcsp weighting dcsp the dcsp forward dcsp solution dcsp must dcsp be dcsp freeorientation dcsp and dcsp in dcsp surface dcsp orientation dcnl dcsp dcsp elif forward surf ori is false dcnl dcsp dcsp dcsp raise valueerror for dcsp a dcsp fixed dcsp orientation dcsp inverse dcsp solution dcsp without dcsp depth dcsp weighting dcsp the dcsp forward dcsp solution dcsp must dcsp be dcsp in dcsp surface dcsp orientation dcnl dcsp if depth is not none dcnl dcsp dcsp if not 0 < depth < 1 dcnl dcsp dcsp dcsp raise valueerror depth dcsp should dcsp be dcsp a dcsp scalar dcsp between dcsp 0 dcsp and dcsp 1 dcnl dcsp dcsp if is fixed ori dcnl dcsp dcsp dcsp raise valueerror you dcsp need dcsp a dcsp freeorientation dcsp surfaceoriented dcsp forward dcsp solution dcsp to dcsp do dcsp depth dcsp weighting dcsp even dcsp when dcsp calculating dcsp a dcsp fixedorientation dcsp inverse dcnl dcsp dcsp if not forward surf ori dcnl dcsp dcsp dcsp forward convert forward solution forward surf ori true dcnl dcsp dcsp assert forward surf ori dcnl dcsp if loose is not none dcnl dcsp dcsp if not 0 < loose < 1 dcnl dcsp dcsp dcsp raise valueerror loose dcsp value dcsp should dcsp be dcsp smaller dcsp than dcsp 1 dcsp and dcsp bigger dcsp than dcsp 0 dcsp or dcsp none dcsp for dcsp not dcsp loose dcsp orientations dcnl dcsp dcsp if loose < 1 and not forward surf ori dcnl dcsp dcsp dcsp raise valueerror forward dcsp operator dcsp is dcsp not dcsp oriented dcsp in dcsp surface dcsp coordinates dcsp a dcsp loose dcsp inverse dcsp operator dcsp requires dcsp a dcsp surfacebased dcsp free dcsp orientation dcsp forward dcsp operator dcnl dcsp gain info gain noise cov whitener n nzero prepare forward forward info noise cov rank rank dcnl dcsp forward info check consistency dcnl dcsp if depth is not none dcnl dcsp dcsp patch areas forward get patch areas none dcnl dcsp dcsp depth prior compute depth prior gain gain info is fixed ori exp depth patch areas patch areas limit depth chs limit depth chs dcnl dcsp else dcnl dcsp dcsp depth prior np ones gain shape1 dtype gain dtype dcnl dcsp if fixed dcnl dcsp dcsp if depth is not none dcnl dcsp dcsp dcsp logger info dcsp dcsp dcsp dcsp picked dcsp elements dcsp from dcsp a dcsp freeorientation dcsp depthweighting dcsp prior dcsp into dcsp the dcsp fixedorientation dcsp one dcnl dcsp dcsp if not is fixed ori dcnl dcsp dcsp dcsp depth prior depth prior2 3 dcnl dcsp dcsp dcsp forward convert forward solution forward surf ori forward surf ori force fixed true dcnl dcsp dcsp dcsp is fixed ori is fixed orient forward dcnl dcsp dcsp dcsp gain info gain noise cov whitener n nzero prepare forward forward info noise cov verbose false dcnl dcsp logger info computing dcsp inverse dcsp operator dcsp with dcsp d dcsp channels len gain info ch names dcnl dcsp logger info creating dcsp the dcsp source dcsp covariance dcsp matrix dcnl dcsp source cov depth prior copy dcnl dcsp depth prior dict data depth prior kind fiff fiffv mne depth prior cov bads diag true names eig none eigvec none dim depth prior size nfree 1 projs dcnl dcsp if not is fixed ori dcnl dcsp dcsp orient prior compute orient prior forward loose loose dcnl dcsp dcsp source cov orient prior dcnl dcsp dcsp orient prior dict data orient prior kind fiff fiffv mne orient prior cov bads diag true names eig none eigvec none dim orient prior size nfree 1 projs dcnl dcsp else dcnl dcsp dcsp orient prior none dcnl dcsp logger info whitening dcsp the dcsp forward dcsp solution dcnl dcsp gain np dot whitener gain dcnl dcsp logger info adjusting dcsp source dcsp covariance dcsp matrix dcnl dcsp source std np sqrt source cov dcnl dcsp gain source stdnone dcnl dcsp trace grgt linalg norm gain ord fro 2 dcnl dcsp scaling source cov n nzero trace grgt dcnl dcsp source cov scaling source cov dcnl dcsp gain sqrt scaling source cov dcnl dcsp source cov dict data source cov dim source cov size kind fiff fiffv mne source cov diag true names projs eig none eigvec none nfree 1 bads dcnl dcsp logger info computing dcsp svd dcsp of dcsp whitened dcsp and dcsp weighted dcsp lead dcsp field dcsp matrix dcnl dcsp eigen fields sing eigen leads linalg svd gain full matrices false dcnl dcsp logger info dcsp dcsp dcsp dcsp largest dcsp singular dcsp value dcsp dcsp g np max sing dcnl dcsp logger info dcsp dcsp dcsp dcsp scaling dcsp factor dcsp to dcsp adjust dcsp the dcsp trace dcsp dcsp g trace grgt dcnl dcsp eigen fields dict data eigen fields t col names gain info ch names row names nrow eigen fields shape1 ncol eigen fields shape0 dcnl dcsp eigen leads dict data eigen leads t nrow eigen leads shape1 ncol eigen leads shape0 row names col names dcnl dcsp nave 1 0 dcnl dcsp has meg false dcnl dcsp has eeg false dcnl dcsp ch idx k for k c in enumerate info chs if c ch name in gain info ch names dcnl dcsp for idx in ch idx dcnl dcsp dcsp ch type channel type info idx dcnl dcsp dcsp if ch type eeg dcnl dcsp dcsp dcsp has eeg true dcnl dcsp dcsp if ch type mag or ch type grad dcnl dcsp dcsp dcsp has meg true dcnl dcsp if has eeg and has meg dcnl dcsp dcsp methods fiff fiffv mne meg eeg dcnl dcsp elif has meg dcnl dcsp dcsp methods fiff fiffv mne meg dcnl dcsp else dcnl dcsp dcsp methods fiff fiffv mne eeg dcnl dcsp if depth is none dcnl dcsp dcsp depth prior none dcnl dcsp inv op dict eigen fields eigen fields eigen leads eigen leads sing sing nave nave depth prior depth prior source cov source cov noise cov noise cov orient prior orient prior projs deepcopy info projs eigen leads weighted false source ori forward source ori mri head t deepcopy forward mri head t methods methods nsource forward nsource coord frame forward coord frame source nn forward source nn copy src deepcopy forward src fmri prior none dcnl dcsp inv info deepcopy forward info dcnl dcsp inv info bads bad for bad in info bads if bad in inv info ch names dcnl dcsp inv info check consistency dcnl dcsp inv op units am dcnl dcsp inv op info inv info dcnl dcsp return inverseoperator inv op
def compute rank inverse inv dcsp eig inv noise cov eig dcnl dcsp if not inv noise cov diag dcnl dcsp dcsp rank np sum eig 0 dcnl dcsp else dcnl dcsp dcsp ncomp make projector inv projs inv noise cov names 1 dcnl dcsp dcsp rank inv noise cov dim ncomp dcnl dcsp return rank
verbose dcnl def estimate snr evoked inv verbose none dcsp from scipy stats import chi2 dcnl dcsp check reference evoked dcnl dcsp check ch names inv evoked info dcnl dcsp inv prepare inverse operator inv evoked nave 1 0 9 0 mne dcnl dcsp sel pick channels inverse operator evoked ch names inv dcnl dcsp logger info picked dcsp d dcsp channels dcsp from dcsp the dcsp data len sel dcnl dcsp data white np dot inv whitener np dot inv proj evoked datasel dcnl dcsp data white ef np dot inv eigen fields data data white dcnl dcsp n ch n times data white shape dcnl dcsp n zero inv noise cov eig < 0 sum dcnl dcsp logger info effective dcsp nchan dcsp dcsp d dcsp dcsp d dcsp dcsp d n ch n zero n ch n zero dcnl dcsp signal np sum data white 2 axis 0 dcnl dcsp noise n ch n zero dcnl dcsp snr signal noise dcnl dcsp lambda2 est np empty n times dcnl dcsp lambda2 est fill 10 0 dcnl dcsp remaining np ones n times bool dcnl dcsp bad snr < 1 dcnl dcsp lambda2 estbad 100 0 dcnl dcsp remainingbad false dcnl dcsp lambda mult 0 9 dcnl dcsp sing2 inv sing inv sing np newaxis dcnl dcsp val chi2 isf 0 001 n ch 1 dcnl dcsp for n iter in range 1000 dcnl dcsp dcsp f sing2 sing2 + lambda2 estnp newaxis remaining dcnl dcsp dcsp f inv sing 0 0 dcnl dcsp dcsp ew data white ef remaining 1 0 f dcnl dcsp dcsp err np sum ew ew axis 0 dcnl dcsp dcsp remainingnp where remaining 0 err < val false dcnl dcsp dcsp if not remaining any dcnl dcsp dcsp dcsp break dcnl dcsp dcsp lambda2 estremaining lambda mult dcnl dcsp else dcnl dcsp dcsp warn snr dcsp estimation dcsp did dcsp not dcsp converge dcnl dcsp snr est 1 0 np sqrt lambda2 est dcnl dcsp snr np sqrt snr dcnl dcsp return snr snr est
testing requires testing data dcnl requires mne dcnl def test snr dcsp tempdir tempdir dcnl dcsp inv read inverse operator fname inv dcnl dcsp evoked read evokeds fname evoked baseline none 0 0 dcnl dcsp snr estimate snr evoked inv 0 dcnl dcsp orig dir os getcwd dcnl dcsp os chdir tempdir dcnl dcsp try dcnl dcsp dcsp cmd mne compute mne inv fname inv meas fname evoked snronly bmin 200 bmax 0 dcnl dcsp dcsp run subprocess cmd dcnl dcsp except exception dcnl dcsp dcsp pass dcnl dcsp finally dcnl dcsp dcsp os chdir orig dir dcnl dcsp snr c np loadtxt op join tempdir snr 1 dcnl dcsp assert allclose snr snr c atol 0 01 rtol 0 01
testing requires testing data dcnl def test tfr with inverse operator dcsp tmin tmax event id 0 2 0 5 1 dcnl dcsp raw read raw fif fname data dcnl dcsp events find events raw stim channel sti dcsp 014 dcnl dcsp inverse operator read inverse operator fname inv dcnl dcsp inv prepare inverse operator inverse operator nave 1 lambda2 1 0 9 0 method dspm dcnl dcsp raw info bads + meg dcsp 2443 eeg dcsp 053 dcnl dcsp picks pick types raw info meg true eeg false eog true stim false exclude bads dcnl dcsp event id 1 dcnl dcsp events3 events 3 dcnl dcsp epochs epochs raw events3 event id tmin tmax picks picks baseline none 0 reject dict grad 4e10 eog 0 00015 preload true dcnl dcsp bands dict alpha 10 10 dcnl dcsp label read label fname label dcnl dcsp stcs source band induced power epochs inv bands n cycles 2 use fft false pca true label label prepared true dcnl dcsp stc stcs alpha dcnl dcsp assert true len stcs len list bands keys dcnl dcsp assert true np all stc data 0 dcnl dcsp assert array almost equal stc times epochs times dcnl dcsp stcs no pca source band induced power epochs inv bands n cycles 2 use fft false pca false label label prepared true dcnl dcsp assert array almost equal stcs alpha data stcs no pca alpha data dcnl dcsp epochs epochs raw events 10 event id tmin tmax picks picks baseline none 0 reject dict grad 4e10 eog 0 00015 preload true dcnl dcsp frequencies np arange 7 30 2 dcnl dcsp power phase lock source induced power epochs inv frequencies label baseline 0 1 0 baseline mode percent n cycles 2 n jobs 1 prepared true dcnl dcsp assert true np all phase lock 0 dcnl dcsp assert true np all phase lock < 1 dcnl dcsp assert true np max power 10
testing requires testing data dcnl def test source psd dcsp raw read raw fif fname data dcnl dcsp inverse operator read inverse operator fname inv dcnl dcsp tmin tmax 0 20 dcnl dcsp fmin fmax 55 65 dcnl dcsp n fft 2048 dcnl dcsp assert equal inverse operator source ori fiff fiffv mne free ori dcnl dcsp for pick ori in normal none dcnl dcsp dcsp stc compute source psd raw inverse operator lambda2 1 0 9 0 method dspm tmin tmin tmax tmax fmin fmin fmax fmax pick ori pick ori n fft n fft overlap 0 1 dcnl dcsp dcsp assert equal stc shape0 inverse operator nsource dcnl dcsp dcsp assert true stc times0 fmin 0 001 dcnl dcsp dcsp assert true stc times 1 < fmax 0 001 dcnl dcsp dcsp assert true 0 058 < stc timesnp argmax np sum stc data axis 0 < 0 061
testing requires testing data dcnl def test source psd epochs dcsp raw read raw fif fname data dcnl dcsp inverse operator read inverse operator fname inv dcnl dcsp label read label fname label dcnl dcsp event id tmin tmax 1 0 2 0 5 dcnl dcsp lambda2 method 1 0 9 0 dspm dcnl dcsp bandwidth 8 0 dcnl dcsp fmin fmax 0 100 dcnl dcsp picks pick types raw info meg true eeg false stim true ecg true eog true include sti dcsp 014 exclude bads dcnl dcsp reject dict grad 4e10 mag 4e12 eog 0 00015 dcnl dcsp events find events raw stim channel sti dcsp 014 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 reject reject dcnl dcsp epochs drop bad dcnl dcsp one epochs epochs 1 dcnl dcsp inv prepare inverse operator inverse operator nave 1 lambda2 1 0 9 0 method dspm dcnl dcsp stc psd compute source psd epochs one epochs inv lambda2 lambda2 method method pick ori normal label label bandwidth bandwidth fmin fmin fmax fmax prepared true 0 dcnl dcsp stcs compute source psd epochs one epochs inv lambda2 lambda2 method method pick ori normal label label bandwidth bandwidth fmin fmin fmax fmax return generator true prepared true dcnl dcsp for stc in stcs dcnl dcsp dcsp stc psd gen stc dcnl dcsp assert array almost equal stc psd data stc psd gen data dcnl dcsp stc apply inverse epochs one epochs inv lambda2 lambda2 method method pick ori normal label label prepared true 0 dcnl dcsp sfreq epochs info sfreq dcnl dcsp psd freqs psd array multitaper stc data sfreq sfreq bandwidth bandwidth fmin fmin fmax fmax dcnl dcsp assert array almost equal psd stc psd data dcnl dcsp assert array almost equal freqs stc psd times dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp compute source psd epochs one epochs inv lambda2 lambda2 method method pick ori normal label label bandwidth 0 01 low bias true fmin fmin fmax fmax return generator false prepared true dcnl dcsp dcsp compute source psd epochs one epochs inv lambda2 lambda2 method method pick ori normal label label bandwidth 0 01 low bias false fmin fmin fmax fmax return generator false prepared true dcnl dcsp assert true len w 2 dcnl dcsp assert true any not dcsp properly dcsp use in str ww message for ww in w dcnl dcsp assert true any bandwidth dcsp too dcsp small in str ww message for ww in w
def read forward solution meg args kwargs dcsp fwd read forward solution args kwargs dcnl dcsp fwd pick types forward fwd meg true eeg false dcnl dcsp return fwd
def read forward solution eeg args kwargs dcsp fwd read forward solution args kwargs dcnl dcsp fwd pick types forward fwd meg false eeg true dcnl dcsp return fwd
def get evoked dcsp evoked read evokeds fname data condition 0 baseline none 0 dcnl dcsp evoked crop 0 0 2 dcnl dcsp return evoked
def compare a b dcsp global last keys dcnl dcsp skip types whitener proj reginv noisenorm nchan command line working dir mri file mri id dcnl dcsp try dcnl dcsp dcsp if isinstance a dict info dcnl dcsp dcsp dcsp assert true isinstance b dict info dcnl dcsp dcsp dcsp for k v in six iteritems a dcnl dcsp dcsp dcsp dcsp if k not in b and k not in skip types dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror first dcsp one dcsp had dcsp one dcsp second dcsp one dcsp didn t n s dcsp not dcsp in dcsp s k b keys dcnl dcsp dcsp dcsp dcsp if k not in skip types dcnl dcsp dcsp dcsp dcsp dcsp last keys pop dcnl dcsp dcsp dcsp dcsp dcsp last keys k + last keys dcnl dcsp dcsp dcsp dcsp dcsp compare v bk dcnl dcsp dcsp dcsp for k v in six iteritems b dcnl dcsp dcsp dcsp dcsp if k not in a and k not in skip types dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror second dcsp one dcsp had dcsp one dcsp first dcsp one dcsp didn t n s dcsp not dcsp in dcsp s k a keys dcnl dcsp dcsp elif isinstance a list dcnl dcsp dcsp dcsp assert true len a len b dcnl dcsp dcsp dcsp for i j in zip a b dcnl dcsp dcsp dcsp dcsp compare i j dcnl dcsp dcsp elif isinstance a sparse csr csr matrix dcnl dcsp dcsp dcsp assert array almost equal a data b data dcnl dcsp dcsp dcsp assert equal a indices b indices dcnl dcsp dcsp dcsp assert equal a indptr b indptr dcnl dcsp dcsp elif isinstance a np ndarray dcnl dcsp dcsp dcsp assert array almost equal a b dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert true a b dcnl dcsp except exception dcnl dcsp dcsp print last keys dcnl dcsp dcsp raise
def compare inverses approx inv 1 inv 2 evoked rtol atol check depth true dcsp if check depth dcnl dcsp dcsp if inv 1 depth prior is not none dcnl dcsp dcsp dcsp assert array almost equal inv 1 depth prior data inv 2 depth prior data 5 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp assert true inv 2 depth prior is none dcnl dcsp if inv 1 orient prior is not none dcnl dcsp dcsp assert array almost equal inv 1 orient prior data inv 2 orient prior data dcnl dcsp else dcnl dcsp dcsp assert true inv 2 orient prior is none dcnl dcsp assert array almost equal inv 1 source cov data inv 2 source cov data dcnl dcsp assert array almost equal np abs inv 1 eigen fields data np abs inv 2 eigen fields data 0 dcnl dcsp assert array almost equal np abs inv 1 eigen leads data np abs inv 2 eigen leads data 0 dcnl dcsp stc 1 apply inverse evoked inv 1 lambda2 dspm dcnl dcsp stc 2 apply inverse evoked inv 2 lambda2 dspm dcnl dcsp assert true stc 1 subject stc 2 subject dcnl dcsp assert equal stc 1 times stc 2 times dcnl dcsp assert allclose stc 1 data stc 2 data rtol rtol atol atol dcnl dcsp assert true inv 1 units inv 2 units
def compare io inv op out file ext fif dcsp tempdir tempdir dcnl dcsp if out file ext fif dcnl dcsp dcsp out file op join tempdir testinv fif dcnl dcsp elif out file ext gz dcnl dcsp dcsp out file op join tempdir testinv fif gz dcnl dcsp else dcnl dcsp dcsp raise valueerror io dcsp test dcsp could dcsp not dcsp complete dcnl dcsp inv init copy deepcopy inv op dcnl dcsp write inverse operator out file inv op dcnl dcsp read inv op read inverse operator out file dcnl dcsp compare inv init read inv op dcnl dcsp compare inv init inv op
testing requires testing data dcnl def test warn inverse operator dcsp bad info copy deepcopy get evoked info dcnl dcsp bad info projs list dcnl dcsp fwd op read forward solution fname fwd surf ori true dcnl dcsp noise cov read cov fname cov dcnl dcsp noise cov projs pop 1 dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp make inverse operator bad info fwd op noise cov dcnl dcsp assert equal len w 1
slow test dcnl testing requires testing data dcnl def test make inverse operator dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp inverse operator read inverse operator fname inv dcnl dcsp fwd op read forward solution meg fname fwd surf ori true dcnl dcsp my inv op make inverse operator evoked info fwd op noise cov loose 0 2 depth 0 8 limit depth chs false dcnl dcsp compare io my inv op dcnl dcsp assert true inverse operator units am dcnl dcsp compare inverses approx my inv op inverse operator evoked 0 01 0 01 check depth false dcnl dcsp my inv op make inverse operator evoked info fwd op noise cov loose 0 2 depth 0 8 dcnl dcsp compare io my inv op dcnl dcsp compare inverses approx my inv op inverse operator evoked 0 01 0 01 dcnl dcsp assert true dev head t in my inv op info dcnl dcsp assert true mri head t in my inv op
slow test dcnl testing requires testing data dcnl def test inverse operator channel ordering dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp fwd orig make forward solution evoked info fname trans src fname fname bem eeg true mindist 5 0 dcnl dcsp fwd orig convert forward solution fwd orig surf ori true dcnl dcsp inv orig make inverse operator evoked info fwd orig noise cov loose 0 2 depth 0 8 limit depth chs false dcnl dcsp stc 1 apply inverse evoked inv orig lambda2 dspm dcnl dcsp new order np arange len evoked info ch names dcnl dcsp randomiser np random randomstate 42 dcnl dcsp randomiser shuffle new order dcnl dcsp evoked data evoked datanew order dcnl dcsp evoked info chs evoked info chs n for n in new order dcnl dcsp evoked info update redundant dcnl dcsp evoked info check consistency dcnl dcsp cov ch reorder c for c in evoked info ch names if c in noise cov ch names dcnl dcsp new order cov noise cov ch names index name for name in cov ch reorder dcnl dcsp noise cov data noise cov datanp ix new order cov new order cov dcnl dcsp noise cov names noise cov names idx for idx in new order cov dcnl dcsp fwd reorder make forward solution evoked info fname trans src fname fname bem eeg true mindist 5 0 dcnl dcsp fwd reorder convert forward solution fwd reorder surf ori true dcnl dcsp inv reorder make inverse operator evoked info fwd reorder noise cov loose 0 2 depth 0 8 limit depth chs false dcnl dcsp stc 2 apply inverse evoked inv reorder lambda2 dspm dcnl dcsp assert equal stc 1 subject stc 2 subject dcnl dcsp assert array equal stc 1 times stc 2 times dcnl dcsp assert allclose stc 1 data stc 2 data rtol 1e05 atol 1e05 dcnl dcsp assert true inv orig units inv reorder units dcnl dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp stc 3 apply inverse evoked inv reorder lambda2 dspm dcnl dcsp assert allclose stc 1 data stc 3 data rtol 1e05 atol 1e05
slow test dcnl testing requires testing data dcnl def test apply inverse operator dcsp inverse operator read inverse operator fname full dcnl dcsp evoked get evoked dcnl dcsp assert true compute rank inverse inverse operator 302 dcnl dcsp assert true compute rank inverse inverse operator 302 dcnl dcsp stc apply inverse evoked inverse operator lambda2 mne dcnl dcsp assert true stc subject sample dcnl dcsp assert true stc data min 0 dcnl dcsp assert true stc data max < 1e08 dcnl dcsp assert true stc data mean 1e11 dcnl dcsp inv op prepare inverse operator inverse operator nave evoked nave lambda2 lambda2 method mne dcnl dcsp stc2 apply inverse evoked inv op lambda2 mne dcnl dcsp assert array almost equal stc data stc2 data dcnl dcsp assert array almost equal stc times stc2 times dcnl dcsp stc apply inverse evoked inverse operator lambda2 sloreta dcnl dcsp assert true stc subject sample dcnl dcsp assert true stc data min 0 dcnl dcsp assert true stc data max < 10 0 dcnl dcsp assert true stc data mean 0 1 dcnl dcsp stc apply inverse evoked inverse operator lambda2 dspm dcnl dcsp assert true stc subject sample dcnl dcsp assert true stc data min 0 dcnl dcsp assert true stc data max < 35 dcnl dcsp assert true stc data mean 0 1 dcnl dcsp label read label fname label audlh dcnl dcsp stc apply inverse evoked inv op lambda2 mne dcnl dcsp stc label apply inverse evoked inv op lambda2 mne label label dcnl dcsp assert equal stc label subject sample dcnl dcsp label stc stc in label label dcnl dcsp assert true label stc subject sample dcnl dcsp assert array almost equal stc label data label stc data dcnl dcsp evoked info custom ref applied true dcnl dcsp assert raises valueerror apply inverse evoked inv op lambda2 mne dcnl dcsp evoked info custom ref applied false dcnl dcsp evoked info projs dcnl dcsp assert raises valueerror apply inverse evoked inv op lambda2 mne
testing requires testing data dcnl def test make inverse operator fixed dcsp fwd 1 read forward solution meg fname fwd surf ori false force fixed false dcnl dcsp fwd 2 read forward solution meg fname fwd surf ori false force fixed true dcnl dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp assert raises valueerror make inverse operator evoked info fwd 1 noise cov depth 0 8 loose none fixed true dcnl dcsp assert raises valueerror make inverse operator evoked info fwd 2 noise cov depth 0 8 loose none fixed true dcnl dcsp inv op make inverse operator evoked info fwd 2 noise cov depth none loose none fixed true dcnl dcsp inverse operator nodepth read inverse operator fname inv fixed nodepth dcnl dcsp compare inverses approx inverse operator nodepth inv op evoked 0 0 01 dcnl dcsp assert true compute rank inverse inverse operator nodepth 302
testing requires testing data dcnl def test make inverse operator free dcsp fwd op read forward solution meg fname fwd surf ori true dcnl dcsp fwd 1 read forward solution meg fname fwd surf ori false force fixed false dcnl dcsp fwd 2 read forward solution meg fname fwd surf ori false force fixed true dcnl dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp assert raises valueerror make inverse operator evoked info fwd 2 noise cov depth none dcnl dcsp inv 1 make inverse operator evoked info fwd op noise cov loose none dcnl dcsp inv 2 make inverse operator evoked info fwd op noise cov loose 1 dcnl dcsp compare inverses approx inv 1 inv 2 evoked 0 0 01 dcnl dcsp inv 3 make inverse operator evoked info fwd op noise cov depth none loose none dcnl dcsp inv 4 make inverse operator evoked info fwd 1 noise cov depth none loose none dcnl dcsp compare inverses approx inv 3 inv 4 evoked 0 0 01
testing requires testing data dcnl def test make inverse operator diag dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov as diag dcnl dcsp fwd op read forward solution fname fwd surf ori true dcnl dcsp inv op make inverse operator evoked info fwd op noise cov loose 0 2 depth 0 8 dcnl dcsp compare io inv op dcnl dcsp inverse operator diag read inverse operator fname inv meeg diag dcnl dcsp compare inverses approx inverse operator diag inv op evoked 0 1 0 dcnl dcsp assert true compute rank inverse inverse operator diag 360
testing requires testing data dcnl def test inverse operator noise cov rank dcsp fwd op read forward solution meg fname fwd surf ori true dcnl dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp inv make inverse operator evoked info fwd op noise cov rank 64 dcnl dcsp assert true compute rank inverse inv 64 dcnl dcsp fwd op read forward solution eeg fname fwd surf ori true dcnl dcsp inv make inverse operator evoked info fwd op noise cov rank dict eeg 20 dcnl dcsp assert true compute rank inverse inv 20
testing requires testing data dcnl def test inverse operator volume dcsp tempdir tempdir dcnl dcsp evoked get evoked dcnl dcsp inverse operator vol read inverse operator fname vol inv dcnl dcsp assert true repr inverse operator vol dcnl dcsp stc apply inverse evoked inverse operator vol lambda2 dspm dcnl dcsp assert true isinstance stc volsourceestimate dcnl dcsp assert true stc subject is none dcnl dcsp stc save op join tempdir tmpvl stc dcnl dcsp stc2 read source estimate op join tempdir tmpvl stc dcnl dcsp assert true np all stc data 0 dcnl dcsp assert true np all stc data < 35 dcnl dcsp assert array almost equal stc data stc2 data dcnl dcsp assert array almost equal stc times stc2 times
slow test dcnl testing requires testing data dcnl def test io inverse operator dcsp tempdir tempdir dcnl dcsp inverse operator read inverse operator fname inv dcnl dcsp x repr inverse operator dcnl dcsp assert true x dcnl dcsp assert true isinstance inverse operator noise cov covariance dcnl dcsp compare io inverse operator gz dcnl dcsp with warnings catch warnings record true as w dcnl dcsp dcsp warnings simplefilter always dcnl dcsp dcsp inv badname op join tempdir testbadname fif gz dcnl dcsp dcsp write inverse operator inv badname inverse operator dcnl dcsp dcsp read inverse operator inv badname dcnl dcsp assert naming w test inverse py 2 dcnl dcsp inv fname op join tempdir testinv fif dcnl dcsp args 10 1 0 9 0 dspm dcnl dcsp inv prep prepare inverse operator inverse operator args dcnl dcsp write inverse operator inv fname inv prep dcnl dcsp inv read read inverse operator inv fname dcnl dcsp compare inverse operator inv read dcnl dcsp inv read prep prepare inverse operator inv read args dcnl dcsp compare inv prep inv read prep dcnl dcsp inv prep prep prepare inverse operator inv prep args dcnl dcsp compare inv prep inv prep prep
testing requires testing data dcnl def test apply mne inverse raw dcsp start 3 dcnl dcsp stop 10 dcnl dcsp raw read raw fif fname raw dcnl dcsp label lh read label fname label audlh dcnl dcsp times raw0 start stop dcnl dcsp inverse operator read inverse operator fname full dcnl dcsp inverse operator prepare inverse operator inverse operator nave 1 lambda2 lambda2 method dspm dcnl dcsp for pick ori in none normal dcnl dcsp dcsp stc apply inverse raw raw inverse operator lambda2 dspm label label lh start start stop stop nave 1 pick ori pick ori buffer size none prepared true dcnl dcsp dcsp stc2 apply inverse raw raw inverse operator lambda2 dspm label label lh start start stop stop nave 1 pick ori pick ori buffer size 3 prepared true dcnl dcsp dcsp if pick ori is none dcnl dcsp dcsp dcsp assert true np all stc data 0 dcnl dcsp dcsp dcsp assert true np all stc2 data 0 dcnl dcsp dcsp assert true stc subject sample dcnl dcsp dcsp assert true stc2 subject sample dcnl dcsp dcsp assert array almost equal stc times times dcnl dcsp dcsp assert array almost equal stc2 times times dcnl dcsp dcsp assert array almost equal stc data stc2 data
testing requires testing data dcnl def test apply mne inverse fixed raw dcsp raw read raw fif fname raw dcnl dcsp start 3 dcnl dcsp stop 10 dcnl dcsp times raw0 start stop dcnl dcsp label lh read label fname label audlh dcnl dcsp fwd read forward solution meg fname fwd force fixed false surf ori true dcnl dcsp noise cov read cov fname cov dcnl dcsp inv op make inverse operator raw info fwd noise cov loose none depth 0 8 fixed true dcnl dcsp inv op2 prepare inverse operator inv op nave 1 lambda2 lambda2 method dspm dcnl dcsp stc apply inverse raw raw inv op2 lambda2 dspm label label lh start start stop stop nave 1 pick ori none buffer size none prepared true dcnl dcsp stc2 apply inverse raw raw inv op2 lambda2 dspm label label lh start start stop stop nave 1 pick ori none buffer size 3 prepared true dcnl dcsp stc3 apply inverse raw raw inv op lambda2 dspm label label lh start start stop stop nave 1 pick ori none buffer size none dcnl dcsp assert true stc subject sample dcnl dcsp assert true stc2 subject sample dcnl dcsp assert array almost equal stc times times dcnl dcsp assert array almost equal stc2 times times dcnl dcsp assert array almost equal stc3 times times dcnl dcsp assert array almost equal stc data stc2 data dcnl dcsp assert array almost equal stc data stc3 data
testing requires testing data dcnl def test apply mne inverse epochs dcsp inverse operator read inverse operator fname full dcnl dcsp label lh read label fname label audlh dcnl dcsp label rh read label fname label audrh dcnl dcsp event id tmin tmax 1 0 2 0 5 dcnl dcsp raw read raw fif fname raw dcnl dcsp picks pick types raw info meg true eeg false stim true ecg true eog true include sti dcsp 014 exclude bads dcnl dcsp reject dict grad 4e10 mag 4e12 eog 0 00015 dcnl dcsp flat dict grad 1e15 mag 1e15 dcnl dcsp events read events fname event 15 dcnl dcsp epochs epochs raw events event id tmin tmax picks picks baseline none 0 reject reject flat flat dcnl dcsp stcs apply inverse epochs epochs inverse operator lambda2 dspm label label lh pick ori normal dcnl dcsp inverse operator prepare inverse operator inverse operator nave 1 lambda2 lambda2 method dspm dcnl dcsp stcs2 apply inverse epochs epochs inverse operator lambda2 dspm label label lh pick ori normal prepared true dcnl dcsp assert array almost equal stcs0 data stcs20 data dcnl dcsp assert array almost equal stcs0 times stcs20 times dcnl dcsp assert true len stcs 2 dcnl dcsp assert true 3 < stcs0 data max < 10 dcnl dcsp assert true stcs0 subject sample dcnl dcsp data sum stc data for stc in stcs len stcs dcnl dcsp flip label sign flip label lh inverse operator src dcnl dcsp label mean np mean data axis 0 dcnl dcsp label mean flip np mean flip np newaxis data axis 0 dcnl dcsp assert true label mean max < label mean flip max dcnl dcsp stcs rh apply inverse epochs epochs inverse operator lambda2 dspm label label rh pick ori normal prepared true dcnl dcsp stcs bh apply inverse epochs epochs inverse operator lambda2 dspm label label lh + label rh pick ori normal prepared true dcnl dcsp n lh len stcs0 data dcnl dcsp assert array almost equal stcs0 data stcs bh0 data n lh dcnl dcsp assert array almost equal stcs rh0 data stcs bh0 datan lh dcnl dcsp stcs apply inverse epochs epochs inverse operator lambda2 dspm pick ori normal prepared true dcnl dcsp assert true stcs0 subject sample dcnl dcsp label stc stcs0 in label label rh dcnl dcsp assert true label stc subject sample dcnl dcsp assert array almost equal stcs rh0 data label stc data
testing requires testing data dcnl def test make inverse operator bads dcsp fwd op read forward solution meg fname fwd surf ori true dcnl dcsp evoked get evoked dcnl dcsp noise cov read cov fname cov dcnl dcsp bad evoked info bads pop dcnl dcsp inv make inverse operator evoked info fwd op noise cov loose none dcnl dcsp union good set noise cov names set evoked ch names dcnl dcsp union bads set noise cov bads set evoked info bads dcnl dcsp evoked info bads append bad dcnl dcsp assert true len set inv info ch names union good 0 dcnl dcsp assert true len set inv info bads union bads 0
slow test dcnl testing requires testing data dcnl def test psf ctf dcsp forward read forward solution fname fwd dcnl dcsp labels mne read label ss for ss in fname label dcnl dcsp method mne dcnl dcsp n svd comp 2 dcnl dcsp for fname inv in fname inv meg fname inv meeg dcnl dcsp dcsp inverse operator read inverse operator fname inv dcnl dcsp dcsp for mode in sum svd dcnl dcsp dcsp dcsp stc psf psf ev point spread function inverse operator forward method method labels labels lambda2 lambda2 pick ori normal mode mode n svd comp n svd comp dcnl dcsp dcsp dcsp n vert n samples stc psf shape dcnl dcsp dcsp dcsp should n vert inverse operator src 1 vertno shape0 + inverse operator src 0 vertno shape0 dcnl dcsp dcsp dcsp if mode svd dcnl dcsp dcsp dcsp dcsp should n samples len labels n svd comp + 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp should n samples len labels + 1 dcnl dcsp dcsp dcsp assert true n vert should n vert dcnl dcsp dcsp dcsp assert true n samples should n samples dcnl dcsp dcsp dcsp n chan n samples psf ev data shape dcnl dcsp dcsp dcsp assert true n chan forward nchan dcnl dcsp dcsp for mode in sum svd dcnl dcsp dcsp dcsp stc ctf cross talk function inverse operator forward labels method method lambda2 lambda2 signed false mode mode n svd comp n svd comp dcnl dcsp dcsp dcsp n vert n samples stc ctf shape dcnl dcsp dcsp dcsp should n vert inverse operator src 1 vertno shape0 + inverse operator src 0 vertno shape0 dcnl dcsp dcsp dcsp if mode svd dcnl dcsp dcsp dcsp dcsp should n samples len labels n svd comp + 1 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp should n samples len labels + 1 dcnl dcsp dcsp dcsp assert true n vert should n vert dcnl dcsp dcsp dcsp assert true n samples should n samples
def prepare info inverse operator dcsp info deepcopy inverse operator info dcnl dcsp info sfreq 1000 0 dcnl dcsp info projs inverse operator projs dcnl dcsp return info
def pick leadfield leadfield forward ch names dcsp picks fwd pick channels forward sol row names ch names dcnl dcsp return leadfieldpicks fwd
verbose dcnl def point spread function inverse operator forward labels method dspm lambda2 1 9 0 pick ori none mode mean n svd comp 1 verbose none dcsp mode mode lower dcnl dcsp if mode not in mean sum svd dcnl dcsp dcsp raise valueerror mode dcsp must dcsp be dcsp svd dcsp mean dcsp or dcsp sum dcsp got dcsp s mode dcnl dcsp logger info about dcsp to dcsp process dcsp d dcsp labels len labels dcnl dcsp forward convert forward solution forward force fixed false surf ori true dcnl dcsp info prepare info inverse operator dcnl dcsp leadfield pick leadfield forward sol data 2 3 forward info ch names dcnl dcsp label psf summary dcnl dcsp label singvals dcnl dcsp for ll in labels dcnl dcsp dcsp logger info ll dcnl dcsp dcsp if ll hemi rh dcnl dcsp dcsp dcsp offset forward src 0 vertno shape0 dcnl dcsp dcsp dcsp this hemi 1 dcnl dcsp dcsp elif ll hemi lh dcnl dcsp dcsp dcsp offset 0 dcnl dcsp dcsp dcsp this hemi 0 dcnl dcsp dcsp idx np intersect1d ll vertices forward src this hemi vertno dcnl dcsp dcsp fwd idx np searchsorted forward src this hemi vertno idx dcnl dcsp dcsp sub leadfield leadfield fwd idx + offset dcnl dcsp dcsp if mode sum dcnl dcsp dcsp dcsp logger info computing dcsp sums dcsp within dcsp labels dcnl dcsp dcsp dcsp this label psf summary sub leadfield sum axis 1 np newaxis dcnl dcsp dcsp elif mode mean dcnl dcsp dcsp dcsp logger info computing dcsp means dcsp within dcsp labels dcnl dcsp dcsp dcsp this label psf summary sub leadfield mean axis 1 np newaxis dcnl dcsp dcsp elif mode svd dcnl dcsp dcsp dcsp logger info computing dcsp svd dcsp within dcsp labels dcsp using dcsp d dcsp component s n svd comp dcnl dcsp dcsp dcsp u svd s svd linalg svd sub leadfield full matrices false compute uv true dcnl dcsp dcsp dcsp label singvals append s svd dcnl dcsp dcsp dcsp logger info first dcsp 5 dcsp singular dcsp values dcsp s s svd0 5 dcnl dcsp dcsp dcsp logger info this dcsp tells dcsp you dcsp something dcsp about dcsp variability dcsp of dcsp forward dcsp solutions dcsp in dcsp subleadfield dcsp for dcsp label dcnl dcsp dcsp dcsp my comps s svd n svd comp dcnl dcsp dcsp dcsp comp var 100 0 np sum my comps my comps np sum s svd s svd dcnl dcsp dcsp dcsp logger info your dcsp d dcsp component s dcsp explain s dcsp 1f dcsp variance dcsp in dcsp label n svd comp comp var dcnl dcsp dcsp dcsp this label psf summary u svd n svd comp s svd n svd compnp newaxis dcnl dcsp dcsp dcsp this label psf summary this label psf summary t dcnl dcsp dcsp label psf summary append this label psf summary dcnl dcsp label psf summary np concatenate label psf summary axis 0 dcnl dcsp label psf summary np r label psf summary label psf summary sum axis 0 np newaxis t dcnl dcsp evoked fwd evokedarray label psf summary info info tmin 0 0 dcnl dcsp logger info about dcsp to dcsp apply dcsp inverse dcsp operator dcsp for dcsp method s dcsp and dcsp lambda2 s method lambda2 dcnl dcsp stc psf apply inverse evoked fwd inverse operator lambda2 method method pick ori pick ori dcnl dcsp return stc psf evoked fwd
def get matrix from inverse operator inverse operator forward labels none method dspm lambda2 1 0 9 0 mode mean n svd comp 1 dcsp mode mode lower dcnl dcsp if not forward surf ori dcnl dcsp dcsp raise runtimeerror forward dcsp has dcsp to dcsp be dcsp surface dcsp oriented dcsp and dcsp force fixed true dcnl dcsp if not forward source ori 1 dcnl dcsp dcsp raise runtimeerror forward dcsp has dcsp to dcsp be dcsp surface dcsp oriented dcsp and dcsp force fixed true dcnl dcsp if labels dcnl dcsp dcsp logger info about dcsp to dcsp process dcsp d dcsp labels len labels dcnl dcsp else dcnl dcsp dcsp logger info computing dcsp whole dcsp inverse dcsp operator dcnl dcsp info prepare info inverse operator dcnl dcsp id mat np eye len info ch names dcnl dcsp ev id evokedarray id mat info info tmin 0 0 dcnl dcsp snr 3 0 dcnl dcsp lambda2 1 0 snr 2 dcnl dcsp invmat mat op apply inverse ev id inverse operator lambda2 lambda2 method method pick ori normal dcnl dcsp logger info dimension dcsp of dcsp inverse dcsp matrix dcsp s str invmat mat op shape dcnl dcsp invmat mat invmat mat op data dcnl dcsp invmat summary dcnl dcsp label singvals dcnl dcsp if labels dcnl dcsp dcsp for ll in labels dcnl dcsp dcsp dcsp if ll hemi rh dcnl dcsp dcsp dcsp dcsp offset forward src 0 vertno shape0 dcnl dcsp dcsp dcsp dcsp this hemi 1 dcnl dcsp dcsp dcsp elif ll hemi lh dcnl dcsp dcsp dcsp dcsp offset 0 dcnl dcsp dcsp dcsp dcsp this hemi 0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise runtimeerror cannot dcsp determine dcsp hemisphere dcsp of dcsp label dcnl dcsp dcsp dcsp idx np intersect1d ll vertices forward src this hemi vertno dcnl dcsp dcsp dcsp fwd idx np searchsorted forward src this hemi vertno idx dcnl dcsp dcsp dcsp invmat lbl invmat mat fwd idx + offset dcnl dcsp dcsp dcsp if mode sum dcnl dcsp dcsp dcsp dcsp logger info computing dcsp sums dcsp within dcsp labels dcnl dcsp dcsp dcsp dcsp this invmat summary invmat lbl sum axis 0 dcnl dcsp dcsp dcsp dcsp this invmat summary np vstack this invmat summary t dcnl dcsp dcsp dcsp elif mode mean dcnl dcsp dcsp dcsp dcsp logger info computing dcsp means dcsp within dcsp labels dcnl dcsp dcsp dcsp dcsp this invmat summary invmat lbl mean axis 0 dcnl dcsp dcsp dcsp dcsp this invmat summary np vstack this invmat summary t dcnl dcsp dcsp dcsp elif mode svd dcnl dcsp dcsp dcsp dcsp logger info computing dcsp svd dcsp within dcsp labels dcsp using dcsp d dcsp component s n svd comp dcnl dcsp dcsp dcsp dcsp u svd s svd linalg svd invmat lbl t full matrices false compute uv true dcnl dcsp dcsp dcsp dcsp label singvals append s svd dcnl dcsp dcsp dcsp dcsp logger info first dcsp 5 dcsp singular dcsp values dcsp s s svd 5 dcnl dcsp dcsp dcsp dcsp logger info this dcsp tells dcsp you dcsp something dcsp about dcsp variability dcsp of dcsp estimators dcsp in dcsp subinverse dcsp for dcsp label dcnl dcsp dcsp dcsp dcsp my comps s svd n svd comp dcnl dcsp dcsp dcsp dcsp comp var 100 np sum my comps my comps np sum s svd s svd dcnl dcsp dcsp dcsp dcsp logger info your dcsp d dcsp component s dcsp explain s dcsp 1f dcsp variance dcsp in dcsp label n svd comp comp var dcnl dcsp dcsp dcsp dcsp this invmat summary u svd n svd comp t s svd n svd comp np newaxis dcnl dcsp dcsp dcsp invmat summary append this invmat summary dcnl dcsp dcsp invmat np concatenate invmat summary axis 0 dcnl dcsp else dcnl dcsp dcsp invmat invmat mat dcnl dcsp return invmat label singvals
verbose dcnl def cross talk function inverse operator forward labels method dspm lambda2 1 9 0 signed false mode mean n svd comp 1 verbose none dcsp forward convert forward solution forward force fixed true surf ori true dcnl dcsp out get matrix from inverse operator inverse operator forward labels labels method method lambda2 lambda2 mode mode n svd comp n svd comp dcnl dcsp invmat label singvals out dcnl dcsp leadfield pick leadfield forward sol data forward inverse operator info ch names dcnl dcsp ctfs np dot invmat leadfield dcnl dcsp ctfs np vstack ctfs ctfs sum axis 0 dcnl dcsp if not signed dcnl dcsp dcsp ctfs np abs ctfs out ctfs dcnl dcsp vertno ss vertno for ss in inverse operator src dcnl dcsp stc ctf sourceestimate ctfs t vertno tmin 0 0 tstep 1 0 dcnl dcsp stc ctf subject subject from inverse inverse operator dcnl dcsp return stc ctf
verbose dcnl def make stc from dipoles dipoles src verbose none dcsp logger info converting dcsp dipoles dcsp into dcsp a dcsp sourceestimate dcnl dcsp if isinstance dipoles dipole dcnl dcsp dcsp dipoles dipoles dcnl dcsp if not isinstance dipoles list dcnl dcsp dcsp raise valueerror dipoles dcsp must dcsp be dcsp an dcsp instance dcsp of dcsp dipole dcsp or dcsp a dcsp list dcsp of dcsp instances dcsp of dcsp dipole dcsp got dcsp s type dipoles dcnl dcsp tmin dipoles0 times0 dcnl dcsp tstep dipoles0 times1 tmin dcnl dcsp x np zeros len dipoles len dipoles0 times dcnl dcsp source rr np concatenate src rr src vertno for src in src axis 0 dcnl dcsp n lh points len src0 vertno dcnl dcsp lh vertno list dcnl dcsp rh vertno list dcnl dcsp for i in range len dipoles dcnl dcsp dcsp if not np all dipolesi pos dipolesi pos0 dcnl dcsp dcsp dcsp raise valueerror only dcsp dipoles dcsp with dcsp fixed dcsp position dcsp over dcsp time dcsp are dcsp supported dcnl dcsp dcsp xi dipolesi amplitude dcnl dcsp dcsp idx np all source rr dipolesi pos0 axis 1 dcnl dcsp dcsp idx np where idx 00 dcnl dcsp dcsp if idx < n lh points dcnl dcsp dcsp dcsp lh vertno append src0 vertno idx dcnl dcsp dcsp else dcnl dcsp dcsp dcsp rh vertno append src1 vertno idx n lh points dcnl dcsp vertices np array lh vertno astype int np array rh vertno astype int dcnl dcsp stc sourceestimate x vertices vertices tmin tmin tstep tstep dcnl dcsp logger info done dcnl dcsp return stc
verbose dcnl def mixed norm evoked forward noise cov alpha loose 0 2 depth 0 8 maxit 3000 tol 0 0001 active set size 10 pca true debias true time pca true weights none weights min none solver auto n mxne iter 1 return residual false return as dipoles false verbose none dcsp if n mxne iter < 1 dcnl dcsp dcsp raise valueerror mxne dcsp has dcsp to dcsp be dcsp computed dcsp at dcsp least dcsp 1 dcsp time dcsp requires dcsp n mxne iter dcsp dcsp 1 dcsp got dcsp d n mxne iter dcnl dcsp if not isinstance evoked list dcnl dcsp dcsp evoked evoked dcnl dcsp check reference evoked0 dcnl dcsp all ch names evoked0 ch names dcnl dcsp if not all all ch names evokedi ch names for i in range 1 len evoked dcnl dcsp dcsp raise exception all dcsp the dcsp datasets dcsp must dcsp have dcsp the dcsp same dcsp good dcsp channels dcnl dcsp if loose is none and not is fixed orient forward dcnl dcsp dcsp forward deepcopy forward dcnl dcsp dcsp to fixed ori forward dcnl dcsp gain gain info whitener source weighting mask prepare gain forward evoked0 info noise cov pca depth loose weights weights min dcnl dcsp sel all ch names index name for name in gain info ch names dcnl dcsp m np concatenate e datasel for e in evoked axis 1 dcnl dcsp logger info whitening dcsp data dcsp matrix dcnl dcsp m np dot whitener m dcnl dcsp if time pca dcnl dcsp dcsp u s vh linalg svd m full matrices false dcnl dcsp dcsp if not isinstance time pca bool and isinstance time pca int dcnl dcsp dcsp dcsp u u time pca dcnl dcsp dcsp dcsp s s time pca dcnl dcsp dcsp dcsp vh vh time pca dcnl dcsp dcsp m u s dcnl dcsp n dip per pos 1 if is fixed orient forward else 3 dcnl dcsp alpha max norm l2inf np dot gain t m n dip per pos copy false dcnl dcsp alpha max 0 01 dcnl dcsp gain alpha max dcnl dcsp source weighting alpha max dcnl dcsp if n mxne iter 1 dcnl dcsp dcsp x active set e mixed norm solver m gain alpha maxit maxit tol tol active set size active set size n orient n dip per pos debias debias solver solver verbose verbose dcnl dcsp else dcnl dcsp dcsp x active set e iterative mixed norm solver m gain alpha n mxne iter maxit maxit tol tol n orient n dip per pos active set size active set size debias debias solver solver verbose verbose dcnl dcsp if time pca dcnl dcsp dcsp x np dot x vh dcnl dcsp dcsp m np dot m vh dcnl dcsp m estimated np dot gain active set x dcnl dcsp if mask is not none dcnl dcsp dcsp active set tmp np zeros len mask dtype np bool dcnl dcsp dcsp active set tmpmask active set dcnl dcsp dcsp active set active set tmp dcnl dcsp dcsp del active set tmp dcnl dcsp if active set sum 0 dcnl dcsp dcsp raise exception no dcsp active dcsp dipoles dcsp found dcsp alpha dcsp is dcsp too dcsp big dcnl dcsp x reapply source weighting x source weighting active set n dip per pos dcnl dcsp outs list dcnl dcsp residual list dcnl dcsp cnt 0 dcnl dcsp for e in evoked dcnl dcsp dcsp tmin e times0 dcnl dcsp dcsp tstep 1 0 e info sfreq dcnl dcsp dcsp xe x cnt cnt + len e times dcnl dcsp dcsp if return as dipoles dcnl dcsp dcsp dcsp out make dipoles sparse xe active set forward tmin tstep m cnt cnt + len e times m estimated cnt cnt + len e times verbose none dcnl dcsp dcsp else dcnl dcsp dcsp dcsp out make sparse stc xe active set forward tmin tstep dcnl dcsp dcsp outs append out dcnl dcsp dcsp cnt + len e times dcnl dcsp dcsp if return residual dcnl dcsp dcsp dcsp residual append compute residual forward e xe active set gain info dcnl dcsp logger info done dcnl dcsp if len outs 1 dcnl dcsp dcsp out outs0 dcnl dcsp dcsp if return residual dcnl dcsp dcsp dcsp residual residual0 dcnl dcsp else dcnl dcsp dcsp out outs dcnl dcsp if return residual dcnl dcsp dcsp out out residual dcnl dcsp return out
def window evoked evoked size dcsp if isinstance size float int dcnl dcsp dcsp lsize rsize float size dcnl dcsp else dcnl dcsp dcsp lsize rsize size dcnl dcsp evoked evoked copy dcnl dcsp sfreq float evoked info sfreq dcnl dcsp lsize int lsize sfreq dcnl dcsp rsize int rsize sfreq dcnl dcsp lhann signal hann lsize 2 dcnl dcsp rhann signal hann rsize 2 dcnl dcsp window np r lhann lsize np ones len evoked times lsize rsize rhann rsize dcnl dcsp evoked data windownone dcnl dcsp return evoked
verbose dcnl def tf mixed norm evoked forward noise cov alpha space alpha time loose 0 2 depth 0 8 maxit 3000 tol 0 0001 weights none weights min none pca true debias true wsize 64 tstep 4 window 0 02 return residual false return as dipoles false verbose none dcsp check reference evoked dcnl dcsp all ch names evoked ch names dcnl dcsp info evoked info dcnl dcsp if alpha space < 0 0 or alpha space 100 0 dcnl dcsp dcsp raise exception alpha space dcsp must dcsp be dcsp in dcsp range dcsp 0 dcsp 100 dcsp got dcsp alpha space dcsp dcsp f alpha space dcnl dcsp if alpha time < 0 0 or alpha time 100 0 dcnl dcsp dcsp raise exception alpha time dcsp must dcsp be dcsp in dcsp range dcsp 0 dcsp 100 dcsp got dcsp alpha time dcsp dcsp f alpha time dcnl dcsp if loose is none and not is fixed orient forward dcnl dcsp dcsp forward deepcopy forward dcnl dcsp dcsp to fixed ori forward dcnl dcsp n dip per pos 1 if is fixed orient forward else 3 dcnl dcsp gain gain info whitener source weighting mask prepare gain forward evoked info noise cov pca depth loose weights weights min dcnl dcsp if window is not none dcnl dcsp dcsp evoked window evoked evoked window dcnl dcsp sel all ch names index name for name in gain info ch names dcnl dcsp m evoked datasel dcnl dcsp logger info whitening dcsp data dcsp matrix dcnl dcsp m np dot whitener m dcnl dcsp alpha max norm l2inf np dot gain t m n dip per pos copy false dcnl dcsp alpha max 0 01 dcnl dcsp gain alpha max dcnl dcsp source weighting alpha max dcnl dcsp x active set e tf mixed norm solver m gain alpha space alpha time wsize wsize tstep tstep maxit maxit tol tol verbose verbose n orient n dip per pos log objective true debias debias dcnl dcsp if active set sum 0 dcnl dcsp dcsp raise exception no dcsp active dcsp dipoles dcsp found dcsp alpha space alpha time dcsp are dcsp too dcsp big dcnl dcsp m estimated np dot gain active set x dcnl dcsp if mask is not none dcnl dcsp dcsp active set tmp np zeros len mask dtype np bool dcnl dcsp dcsp active set tmpmask active set dcnl dcsp dcsp active set active set tmp dcnl dcsp dcsp del active set tmp dcnl dcsp x reapply source weighting x source weighting active set n dip per pos dcnl dcsp if return residual dcnl dcsp dcsp residual compute residual forward evoked x active set gain info dcnl dcsp if return as dipoles dcnl dcsp dcsp out make dipoles sparse x active set forward evoked times0 1 0 info sfreq m m estimated verbose none dcnl dcsp else dcnl dcsp dcsp out make sparse stc x active set forward evoked times0 1 0 info sfreq dcnl dcsp logger info done dcnl dcsp if return residual dcnl dcsp dcsp out out residual dcnl dcsp return out
def check stcs stc1 stc2 dcsp assert allclose stc1 times stc2 times dcnl dcsp assert allclose stc1 data stc2 data dcnl dcsp assert allclose stc1 vertices0 stc2 vertices0 dcnl dcsp assert allclose stc1 vertices1 stc2 vertices1 dcnl dcsp assert allclose stc1 tmin stc2 tmin dcnl dcsp assert allclose stc1 tstep stc2 tstep
slow test dcnl testing requires testing data dcnl def test mxne inverse dcsp cov read cov fname cov dcnl dcsp loose none dcnl dcsp depth 0 9 dcnl dcsp evoked read evokeds fname data condition 0 baseline none 0 dcnl dcsp evoked crop tmin 0 05 tmax 0 2 dcnl dcsp evoked l21 evoked copy dcnl dcsp evoked l21 crop tmin 0 081 tmax 0 1 dcnl dcsp label read label fname label dcnl dcsp forward read forward solution fname fwd force fixed false surf ori true dcnl dcsp inverse operator make inverse operator evoked l21 info forward cov loose loose depth depth fixed true dcnl dcsp stc dspm apply inverse evoked l21 inverse operator lambda2 1 0 9 0 method dspm dcnl dcsp stc dspm data np abs stc dspm data < 12 0 0 dcnl dcsp stc dspm data np abs stc dspm data 12 1 0 dcnl dcsp weights min 0 5 dcnl dcsp alpha 70 dcnl dcsp stc prox mixed norm evoked l21 forward cov alpha loose loose depth depth maxit 300 tol 1e08 active set size 10 weights stc dspm weights min weights min solver prox dcnl dcsp stc cd mixed norm evoked l21 forward cov alpha loose loose depth depth maxit 300 tol 1e08 active set size 10 weights stc dspm weights min weights min solver cd dcnl dcsp stc bcd mixed norm evoked l21 forward cov alpha loose loose depth depth maxit 300 tol 1e08 active set size 10 weights stc dspm weights min weights min solver bcd dcnl dcsp assert array almost equal stc prox times evoked l21 times 5 dcnl dcsp assert array almost equal stc cd times evoked l21 times 5 dcnl dcsp assert array almost equal stc bcd times evoked l21 times 5 dcnl dcsp assert allclose stc prox data stc cd data rtol 0 001 atol 0 0 dcnl dcsp assert allclose stc prox data stc bcd data rtol 0 001 atol 0 0 dcnl dcsp assert allclose stc cd data stc bcd data rtol 0 001 atol 0 0 dcnl dcsp assert true stc prox vertices10 in label vertices dcnl dcsp assert true stc cd vertices10 in label vertices dcnl dcsp assert true stc bcd vertices10 in label vertices dcnl dcsp dips mixed norm evoked l21 forward cov alpha loose loose depth depth maxit 300 tol 1e08 active set size 10 weights stc dspm weights min weights min solver cd return as dipoles true dcnl dcsp stc dip make stc from dipoles dips forward src dcnl dcsp assert true isinstance dips0 dipole dcnl dcsp check stcs stc cd stc dip dcnl dcsp stc mixed norm evoked l21 forward cov alpha loose loose depth depth maxit 300 tol 1e08 active set size 10 return residual true solver cd dcnl dcsp assert array almost equal stc times evoked l21 times 5 dcnl dcsp assert true stc vertices10 in label vertices dcnl dcsp stc mixed norm evoked l21 forward cov alpha n mxne iter 5 loose loose depth depth maxit 300 tol 1e08 active set size 10 solver cd dcnl dcsp assert array almost equal stc times evoked l21 times 5 dcnl dcsp assert true stc vertices10 in label vertices dcnl dcsp assert equal stc vertices 63152 79017 dcnl dcsp alpha space 60 0 dcnl dcsp alpha time 1 0 dcnl dcsp stc tf mixed norm evoked forward cov alpha space alpha time loose loose depth depth maxit 100 tol 0 0001 tstep 4 wsize 16 window 0 1 weights stc dspm weights min weights min return residual true dcnl dcsp assert array almost equal stc times evoked times 5 dcnl dcsp assert true stc vertices10 in label vertices
def test compute debiasing dcsp rng np random randomstate 42 dcnl dcsp g rng randn 10 4 dcnl dcsp x rng randn 4 20 dcnl dcsp debias true np arange 1 5 dtype np float dcnl dcsp m np dot g x debias true np newaxis dcnl dcsp debias compute bias m g x max iter 10000 n orient 1 tol 1e07 dcnl dcsp assert almost equal debias debias true decimal 5 dcnl dcsp debias compute bias m g x max iter 10000 n orient 2 tol 1e05 dcnl dcsp assert almost equal debias 1 8 1 8 3 72 3 72 decimal 2
def test l21 mxne dcsp n p t alpha 30 40 20 1 0 dcnl dcsp rng np random randomstate 0 dcnl dcsp g rng randn n p dcnl dcsp g np std g axis 0 none dcnl dcsp x np zeros p t dcnl dcsp x0 3 dcnl dcsp x4 2 dcnl dcsp m np dot g x dcnl dcsp args m g alpha 1000 1e08 dcnl dcsp x hat prox active set mixed norm solver active set size none debias true solver prox args dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp x hat cd active set gap cd mixed norm solver active set size none debias true solver cd return gap true args dcnl dcsp assert array less gap cd 1e08 dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp x hat bcd active set e gap bcd mixed norm solver m g alpha maxit 1000 tol 1e08 active set size none debias true solver bcd return gap true dcnl dcsp assert array less gap bcd 9 6e09 dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp assert allclose x hat prox x hat cd rtol 0 01 dcnl dcsp assert allclose x hat prox x hat bcd rtol 0 01 dcnl dcsp assert allclose x hat bcd x hat cd rtol 0 01 dcnl dcsp x hat prox active set mixed norm solver active set size 2 debias true solver prox args dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp x hat cd active set mixed norm solver active set size 2 debias true solver cd args dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp x hat bcd active set mixed norm solver active set size 2 debias true solver bcd args dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp assert allclose x hat bcd x hat cd rtol 0 01 dcnl dcsp assert allclose x hat bcd x hat prox rtol 0 01 dcnl dcsp x hat prox active set mixed norm solver active set size 2 debias true n orient 2 solver prox args dcnl dcsp assert array equal np where active set 0 0 1 4 5 dcnl dcsp x hat bcd active set mixed norm solver active set size 2 debias true n orient 2 solver bcd args dcnl dcsp assert array equal np where active set 0 0 1 4 5 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x hat cd active set mixed norm solver active set size 2 debias true n orient 2 solver cd args dcnl dcsp assert array equal np where active set 0 0 1 4 5 dcnl dcsp assert allclose x hat bcd x hat prox rtol 0 01 dcnl dcsp assert allclose x hat bcd x hat cd rtol 0 01 dcnl dcsp x hat bcd active set mixed norm solver active set size 2 debias true n orient 5 solver bcd args dcnl dcsp assert array equal np where active set 0 0 1 2 3 4 dcnl dcsp x hat prox active set mixed norm solver active set size 2 debias true n orient 5 solver prox args dcnl dcsp assert array equal np where active set 0 0 1 2 3 4 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x hat cd active set mixed norm solver active set size 2 debias true n orient 5 solver cd args dcnl dcsp assert array equal np where active set 0 0 1 2 3 4 dcnl dcsp assert array equal x hat bcd x hat cd dcnl dcsp assert allclose x hat bcd x hat prox rtol 0 01
def test tf mxne dcsp alpha space 10 0 dcnl dcsp alpha time 5 0 dcnl dcsp m g active set generate tf data dcnl dcsp x hat tf active set hat tf e gap tfmxne tf mixed norm solver m g alpha space alpha time maxit 200 tol 1e08 verbose true n orient 1 tstep 4 wsize 32 return gap true dcnl dcsp assert array less gap tfmxne 1e08 dcnl dcsp assert array equal np where active set hat tf 0 active set
def test tf mxne vs mxne dcsp alpha space 60 0 dcnl dcsp alpha time 0 0 dcnl dcsp m g active set generate tf data dcnl dcsp x hat tf active set hat tf e tf mixed norm solver m g alpha space alpha time maxit 200 tol 1e08 verbose true debias false n orient 1 tstep 4 wsize 32 dcnl dcsp x hat l21 mixed norm solver m g alpha space maxit 200 tol 1e08 verbose false n orient 1 active set size none debias false dcnl dcsp assert allclose x hat tf x hat l21 rtol 0 1
def test iterative reweighted mxne dcsp n p t alpha 30 40 20 1 dcnl dcsp rng np random randomstate 0 dcnl dcsp g rng randn n p dcnl dcsp g np std g axis 0 none dcnl dcsp x np zeros p t dcnl dcsp x0 3 dcnl dcsp x4 2 dcnl dcsp m np dot g x dcnl dcsp x hat l21 mixed norm solver m g alpha maxit 1000 tol 1e08 verbose false n orient 1 active set size none debias false solver bcd dcnl dcsp x hat bcd active set iterative mixed norm solver m g alpha 1 maxit 1000 tol 1e08 active set size none debias false solver bcd dcnl dcsp x hat prox active set iterative mixed norm solver m g alpha 1 maxit 1000 tol 1e08 active set size none debias false solver prox dcnl dcsp assert allclose x hat bcd x hat l21 rtol 0 001 dcnl dcsp assert allclose x hat prox x hat l21 rtol 0 001 dcnl dcsp x hat prox active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size none debias true solver prox dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp x hat bcd active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size 2 debias true solver bcd dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp x hat cd active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size none debias true solver cd dcnl dcsp assert array equal np where active set 0 0 4 dcnl dcsp assert array almost equal x hat prox x hat cd 5 dcnl dcsp assert array almost equal x hat bcd x hat cd 5 dcnl dcsp x hat bcd active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size 2 debias true n orient 2 solver bcd dcnl dcsp assert array equal np where active set 0 0 1 4 5 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x hat cd active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size 2 debias true n orient 2 solver cd dcnl dcsp assert array equal np where active set 0 0 1 4 5 dcnl dcsp assert array equal x hat bcd x hat cd 5 dcnl dcsp x hat bcd active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size 2 debias true n orient 5 dcnl dcsp assert array equal np where active set 0 0 1 2 3 4 dcnl dcsp with warnings catch warnings record true dcnl dcsp dcsp x hat cd active set iterative mixed norm solver m g alpha 5 maxit 1000 tol 1e08 active set size 2 debias true n orient 5 solver cd dcnl dcsp assert array equal np where active set 0 0 1 2 3 4 dcnl dcsp assert array equal x hat bcd x hat cd 5
def check stc stc evoked idx ratio 50 0 dcsp assert array almost equal stc times evoked times 5 dcnl dcsp amps np sum stc data 2 axis 1 dcnl dcsp order np argsort amps 1 dcnl dcsp amps ampsorder dcnl dcsp verts np concatenate stc vertices order dcnl dcsp assert equal idx verts0 err msg str list verts dcnl dcsp assert true amps0 ratio amps1 msg str amps0 amps1
def check stcs stc1 stc2 dcsp assert allclose stc1 times stc2 times dcnl dcsp assert allclose stc1 data stc2 data dcnl dcsp assert allclose stc1 vertices0 stc2 vertices0 dcnl dcsp assert allclose stc1 vertices1 stc2 vertices1 dcnl dcsp assert allclose stc1 tmin stc2 tmin dcnl dcsp assert allclose stc1 tstep stc2 tstep
slow test dcnl testing requires testing data dcnl def test gamma map dcsp forward read forward solution fname fwd force fixed false surf ori true dcnl dcsp forward pick types forward forward meg false eeg true dcnl dcsp evoked read evokeds fname evoked condition 0 baseline none 0 proj false dcnl dcsp evoked resample 50 npad 100 dcnl dcsp evoked crop tmin 0 1 tmax 0 16 dcnl dcsp cov read cov fname cov dcnl dcsp cov regularize cov evoked info dcnl dcsp alpha 0 5 dcnl dcsp stc gamma map evoked forward cov alpha tol 0 0001 xyz same gamma true update mode 1 dcnl dcsp check stc stc evoked 68477 dcnl dcsp stc gamma map evoked forward cov alpha tol 0 0001 xyz same gamma false update mode 1 dcnl dcsp check stc stc evoked 82010 dcnl dcsp dips gamma map evoked forward cov alpha tol 0 0001 xyz same gamma false update mode 1 return as dipoles true dcnl dcsp assert true isinstance dips0 dipole dcnl dcsp stc dip make stc from dipoles dips forward src dcnl dcsp check stcs stc stc dip dcnl dcsp stc gamma map evoked forward cov alpha tol 0 0001 xyz same gamma false update mode 2 loose none return residual false dcnl dcsp check stc stc evoked 85739 20
def groups norm2 a n orient dcsp n positions a shape0 n orient dcnl dcsp return np sum np power a 2 a reshape n positions 1 axis 1
def norm l2inf a n orient copy true dcsp if a size 0 dcnl dcsp dcsp return 0 0 dcnl dcsp if copy dcnl dcsp dcsp a a copy dcnl dcsp return sqrt np max groups norm2 a n orient
def norm l21 a n orient copy true dcsp if a size 0 dcnl dcsp dcsp return 0 0 dcnl dcsp if copy dcnl dcsp dcsp a a copy dcnl dcsp return np sum np sqrt groups norm2 a n orient
def prox l21 y alpha n orient shape none is stft false dcsp if len y 0 dcnl dcsp dcsp return np zeros like y np zeros 0 dtype np bool dcnl dcsp if shape is not none dcnl dcsp dcsp shape init y shape dcnl dcsp dcsp y y reshape shape dcnl dcsp n positions y shape0 n orient dcnl dcsp if is stft dcnl dcsp dcsp rows norm np sqrt stft norm2 y reshape n positions 1 sum axis 1 dcnl dcsp else dcnl dcsp dcsp rows norm np sqrt y y conj real reshape n positions 1 sum axis 1 dcnl dcsp shrink np maximum 1 0 alpha np maximum rows norm alpha 0 0 dcnl dcsp active set shrink 0 0 dcnl dcsp if n orient 1 dcnl dcsp dcsp active set np tile active set none 1 n orient ravel dcnl dcsp dcsp shrink np tile shrink none 1 n orient ravel dcnl dcsp y yactive set dcnl dcsp if shape is none dcnl dcsp dcsp y shrinkactive set np newaxis dcnl dcsp else dcnl dcsp dcsp y shrinkactive set np newaxis np newaxis dcnl dcsp dcsp y y reshape 1 shape init1 dcnl dcsp return y active set
def prox l1 y alpha n orient dcsp n positions y shape0 n orient dcnl dcsp norms np sqrt y y conj real t reshape 1 n orient sum axis 1 dcnl dcsp shrink np maximum 1 0 alpha np maximum norms alpha 0 0 dcnl dcsp shrink shrink reshape 1 n positions t dcnl dcsp active set np any shrink 0 0 axis 1 dcnl dcsp shrink shrinkactive set dcnl dcsp if n orient 1 dcnl dcsp dcsp active set np tile active set none 1 n orient ravel dcnl dcsp y yactive set dcnl dcsp if len y 0 dcnl dcsp dcsp for o in range n orient dcnl dcsp dcsp dcsp yo n orient shrink dcnl dcsp return y active set
def dgap l21 m g x active set alpha n orient dcsp gx np dot g active set x dcnl dcsp r m gx dcnl dcsp penalty norm l21 x n orient copy true dcnl dcsp nr2 sum squared r dcnl dcsp p obj 0 5 nr2 + alpha penalty dcnl dcsp dual norm norm l2inf np dot g t r n orient copy false dcnl dcsp scaling alpha dual norm dcnl dcsp scaling min scaling 1 0 dcnl dcsp d obj scaling 0 5 scaling 2 nr2 + scaling np sum r gx dcnl dcsp gap p obj d obj dcnl dcsp return gap p obj d obj r
verbose dcnl def mixed norm solver prox m g alpha lipschitz constant maxit 200 tol 1e08 verbose none init none n orient 1 dcsp n sensors n times m shape dcnl dcsp n sensors n sources g shape dcnl dcsp if n sources < n sensors dcnl dcsp dcsp gram np dot g t g dcnl dcsp dcsp gtm np dot g t m dcnl dcsp else dcnl dcsp dcsp gram none dcnl dcsp if init is none dcnl dcsp dcsp x 0 0 dcnl dcsp dcsp r m copy dcnl dcsp dcsp if gram is not none dcnl dcsp dcsp dcsp r np dot g t r dcnl dcsp else dcnl dcsp dcsp x init dcnl dcsp dcsp if gram is none dcnl dcsp dcsp dcsp r m np dot g x dcnl dcsp dcsp else dcnl dcsp dcsp dcsp r gtm np dot gram x dcnl dcsp t 1 0 dcnl dcsp y np zeros n sources n times dcnl dcsp e dcnl dcsp highest d obj np inf dcnl dcsp active set np ones n sources dtype np bool dcnl dcsp for i in range maxit dcnl dcsp dcsp x0 active set 0 x active set dcnl dcsp dcsp if gram is none dcnl dcsp dcsp dcsp y + np dot g t r lipschitz constant dcnl dcsp dcsp else dcnl dcsp dcsp dcsp y + r lipschitz constant dcnl dcsp dcsp x active set prox l21 y alpha lipschitz constant n orient dcnl dcsp dcsp t0 t dcnl dcsp dcsp t 0 5 1 0 + sqrt 1 0 + 4 0 t 2 dcnl dcsp dcsp y fill 0 0 dcnl dcsp dcsp dt t0 1 0 t dcnl dcsp dcsp yactive set 1 0 + dt x dcnl dcsp dcsp yactive set 0 dt x0 dcnl dcsp dcsp y as active set 0 | active set dcnl dcsp dcsp if gram is none dcnl dcsp dcsp dcsp r m np dot g y as yy as dcnl dcsp dcsp else dcnl dcsp dcsp dcsp r gtm np dot gram y as yy as dcnl dcsp dcsp p obj d obj dgap l21 m g x active set alpha n orient dcnl dcsp dcsp highest d obj max d obj highest d obj dcnl dcsp dcsp gap p obj highest d obj dcnl dcsp dcsp e append p obj dcnl dcsp dcsp logger debug p obj dcsp dcsp s dcsp dcsp gap dcsp dcsp s p obj gap dcnl dcsp dcsp if gap < tol dcnl dcsp dcsp dcsp logger debug convergence dcsp reached dcsp dcsp gap dcsp s dcsp < dcsp s gap tol dcnl dcsp dcsp dcsp break dcnl dcsp return x active set e
verbose dcnl def mixed norm solver cd m g alpha lipschitz constant maxit 10000 tol 1e08 verbose none init none n orient 1 dcsp from sklearn linear model coordinate descent import multitasklasso dcnl dcsp n sensors n times m shape dcnl dcsp n sensors n sources g shape dcnl dcsp if init is not none dcnl dcsp dcsp init init t dcnl dcsp clf multitasklasso alpha alpha len m tol tol sum squared m normalize false fit intercept false max iter maxit warm start true dcnl dcsp clf coef init dcnl dcsp clf fit g m dcnl dcsp x clf coef t dcnl dcsp active set np any x axis 1 dcnl dcsp x xactive set dcnl dcsp gap p obj d obj dgap l21 m g x active set alpha n orient dcnl dcsp return x active set p obj
verbose dcnl def mixed norm solver bcd m g alpha lipschitz constant maxit 200 tol 1e08 verbose none init none n orient 1 dcsp g np asfortranarray g dcnl dcsp n sensors n times m shape dcnl dcsp n sensors n sources g shape dcnl dcsp n positions n sources n orient dcnl dcsp if init is none dcnl dcsp dcsp x np zeros n sources n times dcnl dcsp dcsp r m copy dcnl dcsp else dcnl dcsp dcsp x init dcnl dcsp dcsp r m np dot g x dcnl dcsp e dcnl dcsp highest d obj np inf dcnl dcsp active set np zeros n sources dtype np bool dcnl dcsp alpha lc alpha lipschitz constant dcnl dcsp for i in range maxit dcnl dcsp dcsp for j in range n positions dcnl dcsp dcsp dcsp idx slice j n orient j + 1 n orient dcnl dcsp dcsp dcsp g j g idx dcnl dcsp dcsp dcsp x j xidx dcnl dcsp dcsp dcsp x j new np dot g j t r lipschitz constantj dcnl dcsp dcsp dcsp was non zero np any x j dcnl dcsp dcsp dcsp if was non zero dcnl dcsp dcsp dcsp dcsp r + np dot g j x j dcnl dcsp dcsp dcsp dcsp x j new + x j dcnl dcsp dcsp dcsp block norm linalg norm x j new fro dcnl dcsp dcsp dcsp if block norm < alpha lcj dcnl dcsp dcsp dcsp dcsp x j fill 0 0 dcnl dcsp dcsp dcsp dcsp active setidx false dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp shrink np maximum 1 0 alpha lcj block norm 0 0 dcnl dcsp dcsp dcsp dcsp x j new shrink dcnl dcsp dcsp dcsp dcsp r np dot g j x j new dcnl dcsp dcsp dcsp dcsp x j x j new dcnl dcsp dcsp dcsp dcsp active setidx true dcnl dcsp dcsp p obj d obj dgap l21 m g xactive set active set alpha n orient dcnl dcsp dcsp highest d obj max d obj highest d obj dcnl dcsp dcsp gap p obj highest d obj dcnl dcsp dcsp e append p obj dcnl dcsp dcsp logger debug iteration dcsp d dcsp dcsp p obj dcsp f dcsp dcsp dgap dcsp f dcsp dcsp n active dcsp d i + 1 p obj gap np sum active set n orient dcnl dcsp dcsp if gap < tol dcnl dcsp dcsp dcsp logger debug convergence dcsp reached dcsp dcsp gap dcsp s dcsp < dcsp s gap tol dcnl dcsp dcsp dcsp break dcnl dcsp x xactive set dcnl dcsp return x active set e
verbose dcnl def mixed norm solver m g alpha maxit 3000 tol 1e08 verbose none active set size 50 debias true n orient 1 solver auto return gap false dcsp n dipoles g shape1 dcnl dcsp n positions n dipoles n orient dcnl dcsp n sensors n times m shape dcnl dcsp alpha max norm l2inf np dot g t m n orient copy false dcnl dcsp logger info dcsp alpha dcsp max dcsp dcsp s alpha max dcnl dcsp alpha float alpha dcnl dcsp has sklearn true dcnl dcsp try dcnl dcsp dcsp from sklearn linear model coordinate descent import multitasklasso dcnl dcsp except importerror dcnl dcsp dcsp has sklearn false dcnl dcsp if solver auto dcnl dcsp dcsp if has sklearn and n orient 1 dcnl dcsp dcsp dcsp solver cd dcnl dcsp dcsp else dcnl dcsp dcsp dcsp solver bcd dcnl dcsp if solver cd dcnl dcsp dcsp if n orient 1 and not has sklearn dcnl dcsp dcsp dcsp warn scikitlearn dcsp dcsp 0 12 dcsp cannot dcsp be dcsp found dcsp using dcsp block dcsp coordinate dcsp descent dcsp instead dcsp of dcsp coordinate dcsp descent dcnl dcsp dcsp dcsp solver bcd dcnl dcsp dcsp if n orient 1 dcnl dcsp dcsp dcsp warn coordinate dcsp descent dcsp is dcsp only dcsp available dcsp for dcsp fixed dcsp orientation dcsp using dcsp block dcsp coordinate dcsp descent dcsp instead dcsp of dcsp coordinate dcsp descent dcnl dcsp dcsp dcsp solver bcd dcnl dcsp if solver cd dcnl dcsp dcsp logger info using dcsp coordinate dcsp descent dcnl dcsp dcsp l21 solver mixed norm solver cd dcnl dcsp dcsp lc none dcnl dcsp elif solver bcd dcnl dcsp dcsp logger info using dcsp block dcsp coordinate dcsp descent dcnl dcsp dcsp l21 solver mixed norm solver bcd dcnl dcsp dcsp g np asfortranarray g dcnl dcsp dcsp if n orient 1 dcnl dcsp dcsp dcsp lc np sum g g axis 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp lc np empty n positions dcnl dcsp dcsp dcsp for j in range n positions dcnl dcsp dcsp dcsp dcsp g tmp g j n orient j + 1 n orient dcnl dcsp dcsp dcsp dcsp lcj linalg norm np dot g tmp t g tmp ord 2 dcnl dcsp else dcnl dcsp dcsp logger info using dcsp proximal dcsp iterations dcnl dcsp dcsp l21 solver mixed norm solver prox dcnl dcsp dcsp lc 1 01 linalg norm g ord 2 2 dcnl dcsp if active set size is not none dcnl dcsp dcsp e list dcnl dcsp dcsp highest d obj np inf dcnl dcsp dcsp x init none dcnl dcsp dcsp active set np zeros n dipoles dtype np bool dcnl dcsp dcsp idx large corr np argsort groups norm2 np dot g t m n orient dcnl dcsp dcsp new active idx idx large corr active set size dcnl dcsp dcsp if n orient 1 dcnl dcsp dcsp dcsp new active idx n orient new active idx none + np arange n orient none ravel dcnl dcsp dcsp active setnew active idx true dcnl dcsp dcsp as size np sum active set dcnl dcsp dcsp for k in range maxit dcnl dcsp dcsp dcsp if solver bcd dcnl dcsp dcsp dcsp dcsp lc tmp lcactive set n orient dcnl dcsp dcsp dcsp elif solver cd dcnl dcsp dcsp dcsp dcsp lc tmp none dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp lc tmp 1 01 linalg norm g active set ord 2 2 dcnl dcsp dcsp dcsp x as l21 solver m g active set alpha lc tmp maxit maxit tol tol init x init n orient n orient dcnl dcsp dcsp dcsp active setactive set as copy dcnl dcsp dcsp dcsp idx old active set np where active set 0 dcnl dcsp dcsp dcsp p obj d obj r dgap l21 m g x active set alpha n orient dcnl dcsp dcsp dcsp highest d obj max d obj highest d obj dcnl dcsp dcsp dcsp gap p obj highest d obj dcnl dcsp dcsp dcsp e append p obj dcnl dcsp dcsp dcsp logger info iteration dcsp d dcsp dcsp p obj dcsp f dcsp dcsp dgap dcsp f dcsp n active start dcsp d dcsp dcsp n active end dcsp d k + 1 p obj gap as size n orient np sum active set n orient dcnl dcsp dcsp dcsp if gap < tol dcnl dcsp dcsp dcsp dcsp logger info convergence dcsp reached dcsp dcsp gap dcsp s dcsp < dcsp s gap tol dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp if k < maxit 1 dcnl dcsp dcsp dcsp dcsp idx large corr np argsort groups norm2 np dot g t r n orient dcnl dcsp dcsp dcsp dcsp new active idx idx large corr active set size dcnl dcsp dcsp dcsp dcsp if n orient 1 dcnl dcsp dcsp dcsp dcsp dcsp new active idx n orient new active idx none + np arange n orient none dcnl dcsp dcsp dcsp dcsp dcsp new active idx new active idx ravel dcnl dcsp dcsp dcsp dcsp active setnew active idx true dcnl dcsp dcsp dcsp dcsp idx active set np where active set 0 dcnl dcsp dcsp dcsp dcsp as size np sum active set dcnl dcsp dcsp dcsp dcsp x init np zeros as size n times dtype x dtype dcnl dcsp dcsp dcsp dcsp idx np searchsorted idx active set idx old active set dcnl dcsp dcsp dcsp dcsp x initidx x dcnl dcsp dcsp else dcnl dcsp dcsp dcsp warn did dcsp not dcsp converge dcsp dcsp gap dcsp s dcsp dcsp s gap tol dcnl dcsp else dcnl dcsp dcsp x active set e l21 solver m g alpha lc maxit maxit tol tol n orient n orient init none dcnl dcsp dcsp if return gap dcnl dcsp dcsp dcsp gap dgap l21 m g x active set alpha n orient 0 dcnl dcsp if np any active set and debias dcnl dcsp dcsp bias compute bias m g active set x n orient n orient dcnl dcsp dcsp x bias np newaxis dcnl dcsp logger info final dcsp active dcsp set dcsp size dcsp s np sum active set n orient dcnl dcsp if return gap dcnl dcsp dcsp return x active set e gap dcnl dcsp else dcnl dcsp dcsp return x active set e
verbose dcnl def iterative mixed norm solver m g alpha n mxne iter maxit 3000 tol 1e08 verbose none active set size 50 debias true n orient 1 solver auto dcsp def g w dcnl dcsp dcsp return np sqrt np sqrt groups norm2 w copy n orient dcnl dcsp def gprime w dcnl dcsp dcsp return 2 0 np repeat g w n orient ravel dcnl dcsp e list dcnl dcsp active set np ones g shape1 dtype np bool dcnl dcsp weights np ones g shape1 dcnl dcsp x np zeros g shape1 m shape1 dcnl dcsp for k in range n mxne iter dcnl dcsp dcsp x0 x copy dcnl dcsp dcsp active set 0 active set copy dcnl dcsp dcsp g tmp g active set weightsnp newaxis dcnl dcsp dcsp if active set size is not none dcnl dcsp dcsp dcsp if np sum active set active set size n orient dcnl dcsp dcsp dcsp dcsp x active set mixed norm solver m g tmp alpha debias false n orient n orient maxit maxit tol tol active set size active set size solver solver verbose verbose dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp x active set mixed norm solver m g tmp alpha debias false n orient n orient maxit maxit tol tol active set size none solver solver verbose verbose dcnl dcsp dcsp else dcnl dcsp dcsp dcsp x active set mixed norm solver m g tmp alpha debias false n orient n orient maxit maxit tol tol active set size none solver solver verbose verbose dcnl dcsp dcsp logger info active dcsp set dcsp size dcsp d active set sum n orient dcnl dcsp dcsp if active set sum 0 dcnl dcsp dcsp dcsp active setactive set active set dcnl dcsp dcsp dcsp x weights active set np newaxis dcnl dcsp dcsp dcsp weights gprime x dcnl dcsp dcsp dcsp p obj 0 5 linalg norm m np dot g active set x fro 2 0 + alpha np sum g x dcnl dcsp dcsp dcsp e append p obj dcnl dcsp dcsp dcsp if k 1 and np all active set active set 0 and np all np abs x x0 < tol dcnl dcsp dcsp dcsp dcsp print convergence dcsp reached dcsp after dcsp d dcsp reweightings k dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp active set np zeros like active set dcnl dcsp dcsp dcsp p obj 0 5 linalg norm m 2 0 dcnl dcsp dcsp dcsp e append p obj dcnl dcsp dcsp dcsp break dcnl dcsp if np any active set and debias dcnl dcsp dcsp bias compute bias m g active set x n orient n orient dcnl dcsp dcsp x bias np newaxis dcnl dcsp return x active set e
verbose dcnl def tf lipschitz constant m g phi phit tol 0 001 verbose none dcsp n times m shape1 dcnl dcsp n points g shape1 dcnl dcsp iv np ones n points n times dtype np float dcnl dcsp v phi iv dcnl dcsp l 1e+100 dcnl dcsp for it in range 100 dcnl dcsp dcsp l old l dcnl dcsp dcsp logger info lipschitz dcsp estimation dcsp iteration dcsp dcsp d it dcnl dcsp dcsp iv np real phit v dcnl dcsp dcsp gv np dot g iv dcnl dcsp dcsp gtgv np dot g t gv dcnl dcsp dcsp w phi gtgv dcnl dcsp dcsp l np max np abs w dcnl dcsp dcsp v w l dcnl dcsp dcsp if abs l l old l old < tol dcnl dcsp dcsp dcsp break dcnl dcsp return l
def safe max abs a ia dcsp if np sum ia dcnl dcsp dcsp return np max np abs aia dcnl dcsp else dcnl dcsp dcsp return 0 0
def safe max abs diff a ia b ib dcsp a aia if np sum ia else 0 0 dcnl dcsp b bib if np sum ia else 0 0 dcnl dcsp return np max np abs a b
def norm l21 tf z shape n orient dcsp if z shape0 dcnl dcsp dcsp z2 z reshape shape dcnl dcsp dcsp l21 norm np sqrt stft norm2 z2 reshape 1 n orient sum axis 1 dcnl dcsp dcsp l21 norm l21 norm sum dcnl dcsp else dcnl dcsp dcsp l21 norm 0 0 dcnl dcsp return l21 norm
def norm l1 tf z shape n orient dcsp if z shape0 dcnl dcsp dcsp n positions z shape0 n orient dcnl dcsp dcsp z np sqrt np sum np abs z 2 0 reshape n orient 1 order f axis 0 dcnl dcsp dcsp z z reshape n positions 1 order f reshape shape dcnl dcsp dcsp l1 norm 2 0 z sum axis 2 sum axis 1 np sum z 0 axis 1 np sum z 1 axis 1 dcnl dcsp dcsp l1 norm l1 norm sum dcnl dcsp else dcnl dcsp dcsp l1 norm 0 0 dcnl dcsp return l1 norm
def dgap l21l1 m g z active set alpha space alpha time phi phit shape n orient highest d obj dcsp x phit z dcnl dcsp gx np dot g active set x dcnl dcsp r m gx dcnl dcsp penaltyl1 norm l1 tf z shape n orient dcnl dcsp penaltyl21 norm l21 tf z shape n orient dcnl dcsp nr2 sum squared r dcnl dcsp p obj 0 5 nr2 + alpha space penaltyl21 + alpha time penaltyl1 dcnl dcsp grphi norm prox l1 phi np dot g t r alpha time n orient dcnl dcsp grphi norm stft norm2 grphi norm reshape shape reshape 1 n orient dcnl dcsp grphi norm np sqrt grphi norm sum axis 1 dcnl dcsp dual norm np amax grphi norm dcnl dcsp scaling alpha space dual norm dcnl dcsp scaling min scaling 1 0 dcnl dcsp d obj scaling 0 5 scaling 2 nr2 + scaling np sum r gx dcnl dcsp d obj max d obj highest d obj dcnl dcsp gap p obj d obj dcnl dcsp return gap p obj d obj r
verbose dcnl def tf mixed norm solver m g alpha space alpha time wsize 64 tstep 4 n orient 1 maxit 200 tol 1e08 log objective true active set size none debias true return gap false verbose none dcsp n sensors n times m shape dcnl dcsp n sensors n sources g shape dcnl dcsp n positions n sources n orient dcnl dcsp n step int ceil n times float tstep dcnl dcsp n freq wsize 2 + 1 dcnl dcsp n coefs n step n freq dcnl dcsp shape 1 n freq n step dcnl dcsp phi phi wsize tstep n coefs dcnl dcsp phit phit tstep n freq n step n times dcnl dcsp if n orient 1 dcnl dcsp dcsp lc np sum g g axis 0 dcnl dcsp else dcnl dcsp dcsp lc np empty n positions dcnl dcsp dcsp for j in range n positions dcnl dcsp dcsp dcsp g tmp g j n orient j + 1 n orient dcnl dcsp dcsp dcsp lcj linalg norm np dot g tmp t g tmp ord 2 dcnl dcsp logger info using dcsp block dcsp coordinate dcsp descent dcsp with dcsp active dcsp set dcsp approach dcnl dcsp x z active set e gap tf mixed norm solver bcd active set m g alpha space alpha time lc phi phit shape z init none n orient n orient maxit maxit tol tol log objective log objective verbose none dcnl dcsp if np any active set and debias dcnl dcsp dcsp bias compute bias m g active set x n orient n orient dcnl dcsp dcsp x bias np newaxis dcnl dcsp if return gap dcnl dcsp dcsp return x active set e gap dcnl dcsp else dcnl dcsp dcsp return x active set e
def power iteration kron a c max iter 1000 tol 0 001 random state 0 dcsp as size c shape0 dcnl dcsp rng check random state random state dcnl dcsp b rng randn as size as size dcnl dcsp b linalg norm b fro dcnl dcsp ata np dot a t a dcnl dcsp cct np dot c c t dcnl dcsp l0 np inf dcnl dcsp for in range max iter dcnl dcsp dcsp y np dot np dot ata b cct dcnl dcsp dcsp l linalg norm y fro dcnl dcsp dcsp if abs l l0 < tol dcnl dcsp dcsp dcsp break dcnl dcsp dcsp b y l dcnl dcsp dcsp l0 l dcnl dcsp return l
verbose dcnl def compute bias m g x max iter 1000 tol 1e06 n orient 1 verbose none dcsp n sources x shape0 dcnl dcsp lipschitz constant 1 1 power iteration kron g x dcnl dcsp d np ones n sources dcnl dcsp y np ones n sources dcnl dcsp t 1 0 dcnl dcsp for i in range max iter dcnl dcsp dcsp d0 d dcnl dcsp dcsp r m np dot g y x dcnl dcsp dcsp d y + np sum np dot g t r x axis 1 lipschitz constant dcnl dcsp dcsp if n orient 1 dcnl dcsp dcsp dcsp d np mean d reshape 1 n orient axis 1 dcnl dcsp dcsp dcsp d np tile d n orient 1 t ravel dcnl dcsp dcsp d np maximum d 1 0 dcnl dcsp dcsp t0 t dcnl dcsp dcsp t 0 5 1 0 + sqrt 1 0 + 4 0 t 2 dcnl dcsp dcsp y fill 0 0 dcnl dcsp dcsp dt t0 1 0 t dcnl dcsp dcsp y d + dt d d0 dcnl dcsp dcsp ddiff linalg norm d d0 np inf dcnl dcsp dcsp if ddiff < tol dcnl dcsp dcsp dcsp logger info debiasing dcsp converged dcsp after dcsp d dcsp iterations dcsp max |d dcsp dcsp d0| dcsp dcsp e dcsp < dcsp e i ddiff tol dcnl dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp ddiff linalg norm d d0 np inf dcnl dcsp dcsp logger info debiasing dcsp did dcsp not dcsp converge dcsp after dcsp d dcsp iterations dcsp max |d dcsp dcsp d0| dcsp dcsp e dcsp dcsp e max iter ddiff tol dcnl dcsp return d
verbose dcnl def gamma map opt m g alpha maxit 10000 tol 1e06 update mode 1 group size 1 gammas none verbose none dcsp g g copy dcnl dcsp m m copy dcnl dcsp if gammas is none dcnl dcsp dcsp gammas np ones g shape1 dtype np float dcnl dcsp eps np finfo float eps dcnl dcsp n sources g shape1 dcnl dcsp n sensors n times m shape dcnl dcsp m normalize constant linalg norm np dot m m t ord fro dcnl dcsp m np sqrt m normalize constant dcnl dcsp alpha m normalize constant dcnl dcsp g normalize constant linalg norm g ord np inf dcnl dcsp g g normalize constant dcnl dcsp if n sources group size 0 dcnl dcsp dcsp raise valueerror number dcsp of dcsp sources dcsp has dcsp to dcsp be dcsp evenly dcsp dividable dcsp by dcsp the dcsp group dcsp size dcnl dcsp n active n sources dcnl dcsp active set np arange n sources dcnl dcsp gammas full old gammas copy dcnl dcsp if update mode 2 dcnl dcsp dcsp denom fun np sqrt dcnl dcsp else dcnl dcsp dcsp def denom fun x dcnl dcsp dcsp dcsp return x dcnl dcsp last size 1 dcnl dcsp for itno in range maxit dcnl dcsp dcsp gammasnp isnan gammas 0 0 dcnl dcsp dcsp gidx np abs gammas eps dcnl dcsp dcsp active set active setgidx dcnl dcsp dcsp gammas gammasgidx dcnl dcsp dcsp if n active len active set dcnl dcsp dcsp dcsp n active active set size dcnl dcsp dcsp dcsp g g gidx dcnl dcsp dcsp cm alpha np eye n sensors + np dot g gammasnp newaxis g t dcnl dcsp dcsp u s v linalg svd cm full matrices false dcnl dcsp dcsp s snp newaxis dcnl dcsp dcsp cm np dot u s u t dcnl dcsp dcsp cminv np dot u s + eps u t dcnl dcsp dcsp cminvg np dot cminv g dcnl dcsp dcsp a np dot cminvg t m dcnl dcsp dcsp if update mode 1 dcnl dcsp dcsp dcsp numer gammas 2 np mean a a conj real axis 1 dcnl dcsp dcsp dcsp denom gammas np sum g cminvg axis 0 dcnl dcsp dcsp elif update mode 2 dcnl dcsp dcsp dcsp numer gammas np sqrt np mean a a conj real axis 1 dcnl dcsp dcsp dcsp denom np sum g cminvg axis 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror invalid dcsp value dcsp for dcsp update mode dcnl dcsp dcsp if group size 1 dcnl dcsp dcsp dcsp if denom is none dcnl dcsp dcsp dcsp dcsp gammas numer dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp gammas numer denom fun denom dcnl dcsp dcsp else dcnl dcsp dcsp dcsp numer comb np sum numer reshape 1 group size axis 1 dcnl dcsp dcsp dcsp if denom is none dcnl dcsp dcsp dcsp dcsp gammas comb numer comb dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp denom comb np sum denom reshape 1 group size axis 1 dcnl dcsp dcsp dcsp dcsp gammas comb numer comb denom fun denom comb dcnl dcsp dcsp dcsp gammas np repeat gammas comb group size group size dcnl dcsp dcsp gammas full np zeros n sources dtype np float dcnl dcsp dcsp gammas fullactive set gammas dcnl dcsp dcsp err np sum np abs gammas full gammas full old np sum np abs gammas full old dcnl dcsp dcsp gammas full old gammas full dcnl dcsp dcsp breaking err < tol or n active 0 dcnl dcsp dcsp if len gammas last size or breaking dcnl dcsp dcsp dcsp logger info iteration dcsp d dctb dcsp active dcsp set dcsp size dcsp d dctb dcsp convergence dcsp 0 3e itno len gammas err dcnl dcsp dcsp dcsp last size len gammas dcnl dcsp dcsp if breaking dcnl dcsp dcsp dcsp break dcnl dcsp if itno < maxit 1 dcnl dcsp dcsp logger info nconvergence dcsp reached dcsp n dcnl dcsp else dcnl dcsp dcsp warn nconvergence dcsp not dcsp reached dcsp n dcnl dcsp n const np sqrt m normalize constant g normalize constant dcnl dcsp x active n const gammas none a dcnl dcsp return x active active set
verbose dcnl def gamma map evoked forward noise cov alpha loose 0 2 depth 0 8 xyz same gamma true maxit 10000 tol 1e06 update mode 1 gammas none pca true return residual false return as dipoles false verbose none dcsp check reference evoked dcnl dcsp if loose is none and not is fixed orient forward dcnl dcsp dcsp forward deepcopy forward dcnl dcsp dcsp to fixed ori forward dcnl dcsp if is fixed orient forward or not xyz same gamma dcnl dcsp dcsp group size 1 dcnl dcsp else dcnl dcsp dcsp group size 3 dcnl dcsp gain gain info whitener source weighting mask prepare gain forward evoked info noise cov pca depth loose none none dcnl dcsp sel evoked ch names index name for name in gain info ch names dcnl dcsp m evoked datasel dcnl dcsp logger info whitening dcsp data dcsp matrix dcnl dcsp m np dot whitener m dcnl dcsp x active set gamma map opt m gain alpha maxit maxit tol tol update mode update mode gammas gammas group size group size verbose verbose dcnl dcsp if len active set 0 dcnl dcsp dcsp raise exception no dcsp active dcsp dipoles dcsp found dcsp alpha dcsp is dcsp too dcsp big dcnl dcsp m estimated np dot gain active set x dcnl dcsp n dip per pos 1 if is fixed orient forward else 3 dcnl dcsp x reapply source weighting x source weighting active set n dip per pos dcnl dcsp if return residual dcnl dcsp dcsp residual compute residual forward evoked x active set gain info dcnl dcsp if group size 1 and not is fixed orient forward dcnl dcsp dcsp active src np unique active set 3 dcnl dcsp dcsp in pos 0 dcnl dcsp dcsp if len x < 3 len active src dcnl dcsp dcsp dcsp x xyz np zeros 3 len active src x shape1 dtype x dtype dcnl dcsp dcsp dcsp for ii in range len active src dcnl dcsp dcsp dcsp dcsp for jj in range 3 dcnl dcsp dcsp dcsp dcsp dcsp if in pos len active set dcnl dcsp dcsp dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp dcsp dcsp if active setin pos + jj 3 0 dcnl dcsp dcsp dcsp dcsp dcsp dcsp x xyz 3 ii + jj xin pos dcnl dcsp dcsp dcsp dcsp dcsp dcsp in pos + 1 dcnl dcsp dcsp dcsp x x xyz dcnl dcsp tmin evoked times0 dcnl dcsp tstep 1 0 evoked info sfreq dcnl dcsp if return as dipoles dcnl dcsp dcsp out make dipoles sparse x active set forward tmin tstep m m estimated active is idx true dcnl dcsp else dcnl dcsp dcsp out make sparse stc x active set forward tmin tstep active is idx true verbose verbose dcnl dcsp logger info done dcnl dcsp if return residual dcnl dcsp dcsp out out residual dcnl dcsp return out
def to const cf dcsp if isinstance cf string types dcnl dcsp dcsp if cf not in str to frame dcnl dcsp dcsp dcsp raise valueerror unknown dcsp cf dcsp s cf dcnl dcsp dcsp cf str to framecf dcnl dcsp else dcnl dcsp dcsp cf ensure int cf coordinate dcsp frame a dcsp str dcsp or dcsp int dcnl dcsp return int cf
def coord frame name cframe dcsp return verbose frames get int cframe unknown
def apply trans trans pts move true dcsp if isinstance trans dict dcnl dcsp dcsp trans trans trans dcnl dcsp pts np asarray pts dcnl dcsp if pts size 0 dcnl dcsp dcsp return pts copy dcnl dcsp out pts np dot pts trans 3 3 t dcnl dcsp if move dcnl dcsp dcsp out pts + trans 3 3 dcnl dcsp return out pts
def rotation x 0 y 0 z 0 dcsp cos x cos x dcnl dcsp cos y cos y dcnl dcsp cos z cos z dcnl dcsp sin x sin x dcnl dcsp sin y sin y dcnl dcsp sin z sin z dcnl dcsp r np array cos y cos z cos x sin z + sin x sin y cos z sin x sin z + cos x sin y cos z 0 cos y sin z cos x cos z + sin x sin y sin z sin x cos z + cos x sin y sin z 0 sin y sin x cos y cos x cos y 0 0 0 0 1 dtype float dcnl dcsp return r
def rotation3d x 0 y 0 z 0 dcsp cos x cos x dcnl dcsp cos y cos y dcnl dcsp cos z cos z dcnl dcsp sin x sin x dcnl dcsp sin y sin y dcnl dcsp sin z sin z dcnl dcsp r np array cos y cos z cos x sin z + sin x sin y cos z sin x sin z + cos x sin y cos z cos y sin z cos x cos z + sin x sin y sin z sin x cos z + cos x sin y sin z sin y sin x cos y cos x cos y dtype float dcnl dcsp return r
def rotation3d align z axis target z axis dcsp target z axis target z axis np linalg norm target z axis dcnl dcsp r np zeros 3 3 dcnl dcsp if 1 0 + target z axis2 < 1e12 dcnl dcsp dcsp r 0 0 1 0 dcnl dcsp dcsp r 1 1 1 0 dcnl dcsp dcsp r 2 2 1 0 dcnl dcsp else dcnl dcsp dcsp f 1 0 1 0 + target z axis2 dcnl dcsp dcsp r 0 0 1 0 1 0 f target z axis0 target z axis0 dcnl dcsp dcsp r 0 1 1 0 f target z axis0 target z axis1 dcnl dcsp dcsp r 0 2 target z axis0 dcnl dcsp dcsp r 1 0 1 0 f target z axis0 target z axis1 dcnl dcsp dcsp r 1 1 1 0 1 0 f target z axis1 target z axis1 dcnl dcsp dcsp r 1 2 target z axis1 dcnl dcsp dcsp r 2 0 target z axis0 dcnl dcsp dcsp r 2 1 target z axis1 dcnl dcsp dcsp r 2 2 1 0 f target z axis0 target z axis0 + target z axis1 target z axis1 dcnl dcsp assert np any r dot r t np identity 3 < 1e12 dcnl dcsp assert linalg det r 1 0 < 1e12 dcnl dcsp assert linalg norm target z axis r dot 0 0 1 < 1e12 dcnl dcsp return r
def rotation angles m dcsp x np arctan2 m 2 1 m 2 2 dcnl dcsp c2 np sqrt m 0 0 2 + m 1 0 2 dcnl dcsp y np arctan2 m 2 0 c2 dcnl dcsp s1 np sin x dcnl dcsp c1 np cos x dcnl dcsp z np arctan2 s1 m 0 2 c1 m 0 1 c1 m 1 1 s1 m 1 2 dcnl dcsp return x y z
def scaling x 1 y 1 z 1 dcsp s np array x 0 0 0 0 y 0 0 0 0 z 0 0 0 0 1 dtype float dcnl dcsp return s
def translation x 0 y 0 z 0 dcsp m np array 1 0 0 x 0 1 0 y 0 0 1 z 0 0 0 1 dtype float dcnl dcsp return m
def ensure trans trans fro mri to head dcsp if isinstance fro string types dcnl dcsp dcsp from str fro dcnl dcsp dcsp from const str to framefro dcnl dcsp else dcnl dcsp dcsp from str frame to strfro dcnl dcsp dcsp from const fro dcnl dcsp del fro dcnl dcsp if isinstance to string types dcnl dcsp dcsp to str to dcnl dcsp dcsp to const str to frameto dcnl dcsp else dcnl dcsp dcsp to str frame to strto dcnl dcsp dcsp to const to dcnl dcsp del to dcnl dcsp err str trans dcsp must dcsp be dcsp a dcsp transform dcsp between dcsp s< s dcsp got from str to str dcnl dcsp if not isinstance trans transform dcnl dcsp dcsp raise valueerror s dcsp none err str dcnl dcsp if set trans from trans to set from const to const dcnl dcsp dcsp raise valueerror s dcsp s s err str frame to strtrans from frame to strtrans to dcnl dcsp if trans from from const dcnl dcsp dcsp trans invert transform trans dcnl dcsp return trans
def get trans trans fro mri to head dcsp if isinstance trans string types dcnl dcsp dcsp if not op isfile trans dcnl dcsp dcsp dcsp raise ioerror trans dcsp file dcsp s dcsp not dcsp found trans dcnl dcsp dcsp if op splitext trans 1 in fif gz dcnl dcsp dcsp dcsp fro to t read trans trans dcnl dcsp dcsp else dcnl dcsp dcsp dcsp t np genfromtxt trans dcnl dcsp dcsp dcsp if t ndim 2 or t shape 4 4 dcnl dcsp dcsp dcsp dcsp raise runtimeerror file dcsp s dcsp did dcsp not dcsp have dcsp 4x4 dcsp entries trans dcnl dcsp dcsp dcsp fro to t transform to fro t dcnl dcsp elif isinstance trans dict dcnl dcsp dcsp fro to t trans dcnl dcsp dcsp trans dict dcnl dcsp elif trans is none dcnl dcsp dcsp fro to t transform fro to dcnl dcsp dcsp trans identity dcnl dcsp else dcnl dcsp dcsp raise valueerror transform dcsp type dcsp s dcsp not dcsp known dcsp must dcsp be dcsp str dcsp dict dcsp or dcsp none type trans dcnl dcsp fro to t ensure trans fro to t fro to dcnl dcsp return fro to t trans
def combine transforms t first t second fro to dcsp fro to const fro dcnl dcsp to to const to dcnl dcsp if t first from fro dcnl dcsp dcsp raise runtimeerror from dcsp mismatch dcsp s dcsp s dcsp dcsp s dcsp s t first from coord frame name t first from fro coord frame name fro dcnl dcsp if t first to t second from dcnl dcsp dcsp raise runtimeerror transform dcsp mismatch dcsp t1 to dcsp dcsp s dcsp s dcsp t2 from dcsp dcsp s dcsp s t first to coord frame name t first to t second from coord frame name t second from dcnl dcsp if t second to to dcnl dcsp dcsp raise runtimeerror to dcsp mismatch dcsp s dcsp s dcsp dcsp s dcsp s t second to coord frame name t second to to coord frame name to dcnl dcsp return transform fro to np dot t second trans t first trans
def read trans fname return all false dcsp fid tree directory fiff open fname dcnl dcsp trans list dcnl dcsp with fid dcnl dcsp dcsp for t in directory dcnl dcsp dcsp dcsp if t kind fiff fiff coord trans dcnl dcsp dcsp dcsp dcsp trans append read tag fid t pos data dcnl dcsp dcsp dcsp dcsp if not return all dcnl dcsp dcsp dcsp dcsp dcsp break dcnl dcsp if len trans 0 dcnl dcsp dcsp raise ioerror this dcsp does dcsp not dcsp seem dcsp to dcsp be dcsp a dcsp trans fif dcsp file dcnl dcsp return trans if return all else trans0
def write trans fname trans dcsp check fname fname trans trans fif trans fif gz dcnl dcsp fid start file fname dcnl dcsp write coord trans fid trans dcnl dcsp end file fid
def invert transform trans dcsp return transform trans to trans from linalg inv trans trans
def transform surface to surf dest trans copy false dcsp surf deepcopy surf if copy else surf dcnl dcsp if isinstance dest string types dcnl dcsp dcsp if dest not in str to frame dcnl dcsp dcsp dcsp raise keyerror dest dcsp must dcsp be dcsp one dcsp of dcsp s dcsp not dcsp s list str to frame keys dest dcnl dcsp dcsp dest str to framedest dcnl dcsp if surf coord frame dest dcnl dcsp dcsp return surf dcnl dcsp trans ensure trans trans int surf coord frame dest dcnl dcsp surf coord frame dest dcnl dcsp surf rr apply trans trans surf rr dcnl dcsp surf nn apply trans trans surf nn move false dcnl dcsp return surf
def get ras to neuromag trans nasion lpa rpa dcsp nasion np asarray nasion dcnl dcsp lpa np asarray lpa dcnl dcsp rpa np asarray rpa dcnl dcsp for pt in nasion lpa rpa dcnl dcsp dcsp if pt ndim 1 or len pt 3 dcnl dcsp dcsp dcsp raise valueerror points dcsp have dcsp to dcsp be dcsp provided dcsp as dcsp one dcsp dimensional dcsp arrays dcsp of dcsp length dcsp 3 dcnl dcsp right rpa lpa dcnl dcsp right unit right linalg norm right dcnl dcsp origin lpa + np dot nasion lpa right unit right unit dcnl dcsp anterior nasion origin dcnl dcsp anterior unit anterior linalg norm anterior dcnl dcsp superior unit np cross right unit anterior unit dcnl dcsp x y z origin dcnl dcsp origin trans translation x y z dcnl dcsp trans l np vstack right unit anterior unit superior unit 0 0 0 dcnl dcsp trans r np reshape 0 0 0 1 4 1 dcnl dcsp rot trans np hstack trans l trans r dcnl dcsp trans np dot rot trans origin trans dcnl dcsp return trans
def cart to sph cart dcsp assert cart ndim 2 and cart shape1 3 dcnl dcsp cart np atleast 2d cart dcnl dcsp out np empty len cart 3 dcnl dcsp out 0 np sqrt np sum cart cart axis 1 dcnl dcsp out 1 np arctan2 cart 1 cart 0 dcnl dcsp out 2 np arccos cart 2 out 0 dcnl dcsp out np nan to num out dcnl dcsp return out
def sph to cart sph dcsp assert sph ndim 2 and sph shape1 3 dcnl dcsp sph np atleast 2d sph dcnl dcsp out np empty len sph 3 dcnl dcsp out 2 sph 0 np cos sph 2 dcnl dcsp xy sph 0 np sin sph 2 dcnl dcsp out 0 xy np cos sph 1 dcnl dcsp out 1 xy np sin sph 1 dcnl dcsp return out
def get n moments order dcsp order np asarray order int dcnl dcsp return order + 2 order
def sph to cart partials az pol g rad g az g pol dcsp sph grads np c g rad g az g pol dcnl dcsp cart grads np zeros like sph grads dcnl dcsp c as s as np cos az np sin az dcnl dcsp c ps s ps np cos pol np sin pol dcnl dcsp trans np array c as s ps s as c as c ps s as s ps c as c ps s as c ps np zeros like c as s ps dcnl dcsp cart grads np einsum ijk kj ki trans sph grads dcnl dcsp return cart grads
def deg ord idx deg order dcsp return deg deg + deg + order 1
def sh negate sh order dcsp assert order 0 dcnl dcsp return sh conj 1 0 if order 2 else 1 0
def sh complex to real sh order dcsp if order 0 dcnl dcsp dcsp return np real sh dcnl dcsp else dcnl dcsp dcsp return np sqrt 2 0 np real if order 0 else np imag sh
def sh real to complex shs order dcsp if order 0 dcnl dcsp dcsp return shs0 dcnl dcsp else dcnl dcsp dcsp return shs0 + 1j np sign order shs1 np sqrt 2 0
def compute sph harm order az pol dcsp sph harm get sph harm dcnl dcsp out np empty len az get n moments order + 1 dcnl dcsp for degree in range order + 1 dcnl dcsp dcsp for order in range degree + 1 dcnl dcsp dcsp dcsp sph sph harm order degree az pol dcnl dcsp dcsp dcsp out deg ord idx degree order sh complex to real sph order dcnl dcsp dcsp dcsp if order 0 dcnl dcsp dcsp dcsp dcsp out deg ord idx degree order sh complex to real sh negate sph order order dcnl dcsp return out
def tps distsq dcsp out np zeros like distsq dcnl dcsp mask distsq 0 dcnl dcsp valid distsqmask dcnl dcsp outmask valid np log valid dcnl dcsp return out
def pol to cart pol dcsp out np empty len pol 2 dcnl dcsp if pol shape1 2 dcnl dcsp dcsp out 0 pol 0 np cos pol 1 dcnl dcsp dcsp out 1 pol 0 np sin pol 1 dcnl dcsp else dcnl dcsp dcsp d pol 0 np sin pol 2 dcnl dcsp dcsp out 0 d np cos pol 1 dcnl dcsp dcsp out 1 d np sin pol 1 dcnl dcsp return out
def topo to sph topo dcsp assert topo ndim 2 and topo shape1 2 dcnl dcsp sph np ones len topo 3 dcnl dcsp sph 1 np deg2rad topo 0 dcnl dcsp sph 2 np pi topo 1 dcnl dcsp return sph
def quat to rot quat dcsp b c d quat 0 quat 1 quat 2 dcnl dcsp bb cc dd b b c c d d dcnl dcsp aa np maximum 1 0 bb cc dd 0 0 dcnl dcsp a np sqrt aa dcnl dcsp ab 2 2 a b dcnl dcsp ac 2 2 a c dcnl dcsp ad 2 2 a d dcnl dcsp bc 2 2 b c dcnl dcsp bd 2 2 b d dcnl dcsp cd 2 2 c d dcnl dcsp rotation np array aa + bb cc dd bc 2 ad 2 bd 2 + ac 2 bc 2 + ad 2 aa + cc bb dd cd 2 ab 2 bd 2 ac 2 cd 2 + ab 2 aa + dd bb cc dcnl dcsp if quat ndim 1 dcnl dcsp dcsp rotation np rollaxis np rollaxis rotation 1 quat ndim + 1 0 quat ndim dcnl dcsp return rotation
def one rot to quat rot dcsp t 1 0 + rot0 + rot4 + rot8 dcnl dcsp if t np finfo rot dtype eps dcnl dcsp dcsp s np sqrt t 2 0 dcnl dcsp dcsp qx rot7 rot5 s dcnl dcsp dcsp qy rot2 rot6 s dcnl dcsp dcsp qz rot3 rot1 s dcnl dcsp elif rot0 rot4 and rot0 rot8 dcnl dcsp dcsp s np sqrt 1 0 + rot0 rot4 rot8 2 0 dcnl dcsp dcsp qx 0 25 s dcnl dcsp dcsp qy rot1 + rot3 s dcnl dcsp dcsp qz rot2 + rot6 s dcnl dcsp elif rot4 rot8 dcnl dcsp dcsp s np sqrt 1 0 rot0 + rot4 rot8 2 dcnl dcsp dcsp qx rot1 + rot3 s dcnl dcsp dcsp qy 0 25 s dcnl dcsp dcsp qz rot5 + rot7 s dcnl dcsp else dcnl dcsp dcsp s np sqrt 1 0 rot0 rot4 + rot8 2 0 dcnl dcsp dcsp qx rot2 + rot6 s dcnl dcsp dcsp qy rot5 + rot7 s dcnl dcsp dcsp qz 0 25 s dcnl dcsp return np array qx qy qz
def rot to quat rot dcsp rot rot reshape rot shape 2 + 9 dcnl dcsp return np apply along axis one rot to quat 1 rot
def angle between quats x y dcsp x0 np sqrt np maximum 1 0 x 0 2 x 1 2 x 2 2 0 0 dcnl dcsp y0 np sqrt np maximum 1 0 y 0 2 y 1 2 y 2 2 0 0 dcnl dcsp z0 np maximum np minimum y0 x0 + x y sum axis 1 1 0 1 dcnl dcsp return 2 np arccos z0
def skew symmetric cross a dcsp return np array 0 0 a2 a1 a2 0 0 a0 a1 a0 0 0
def find vector rotation a b dcsp r np eye 3 dcnl dcsp v np cross a b dcnl dcsp if np allclose v 0 0 dcnl dcsp dcsp return r dcnl dcsp s np dot v v dcnl dcsp c np dot a b dcnl dcsp vx skew symmetric cross v dcnl dcsp r + vx + np dot vx vx 1 c s dcnl dcsp return r
def is power2 num dcsp num int num dcnl dcsp return num 0 and num num 1 0
def next fast len target dcsp from bisect import bisect left dcnl dcsp hams 8 9 10 12 15 16 18 20 24 25 27 30 32 36 40 45 48 50 54 60 64 72 75 80 81 90 96 100 108 120 125 128 135 144 150 160 162 180 192 200 216 225 240 243 250 256 270 288 300 320 324 360 375 384 400 405 432 450 480 486 500 512 540 576 600 625 640 648 675 720 729 750 768 800 810 864 900 960 972 1000 1024 1080 1125 1152 1200 1215 1250 1280 1296 1350 1440 1458 1500 1536 1600 1620 1728 1800 1875 1920 1944 2000 2025 2048 2160 2187 2250 2304 2400 2430 2500 2560 2592 2700 2880 2916 3000 3072 3125 3200 3240 3375 3456 3600 3645 3750 3840 3888 4000 4050 4096 4320 4374 4500 4608 4800 4860 5000 5120 5184 5400 5625 5760 5832 6000 6075 6144 6250 6400 6480 6561 6750 6912 7200 7290 7500 7680 7776 8000 8100 8192 8640 8748 9000 9216 9375 9600 9720 10000 dcnl dcsp if target < 6 dcnl dcsp dcsp return target dcnl dcsp if not target target 1 dcnl dcsp dcsp return target dcnl dcsp if target < hams 1 dcnl dcsp dcsp return hamsbisect left hams target dcnl dcsp match float inf dcnl dcsp p5 1 dcnl dcsp while p5 < target dcnl dcsp dcsp p35 p5 dcnl dcsp dcsp while p35 < target dcnl dcsp dcsp dcsp quotient target p35 dcnl dcsp dcsp dcsp p2 2 int quotient 1 bit length dcnl dcsp dcsp dcsp n p2 p35 dcnl dcsp dcsp dcsp if n target dcnl dcsp dcsp dcsp dcsp return n dcnl dcsp dcsp dcsp elif n < match dcnl dcsp dcsp dcsp dcsp match n dcnl dcsp dcsp dcsp p35 3 dcnl dcsp dcsp dcsp if p35 target dcnl dcsp dcsp dcsp dcsp return p35 dcnl dcsp dcsp if p35 < match dcnl dcsp dcsp dcsp match p35 dcnl dcsp dcsp p5 5 dcnl dcsp dcsp if p5 target dcnl dcsp dcsp dcsp return p5 dcnl dcsp if p5 < match dcnl dcsp dcsp match p5 dcnl dcsp return match
def overlap add filter x h n fft none phase zero picks none n jobs 1 copy true dcsp n jobs check n jobs n jobs allow cuda true dcnl dcsp x orig shape picks prep for filtering x copy picks dcnl dcsp check zero phase length len h phase dcnl dcsp if len h 1 dcnl dcsp dcsp return x h 2 if phase zerodouble else x h dcnl dcsp n edge max min len h x shape1 1 0 dcnl dcsp logger debug smartpadding dcsp with dcsp dcsp s dcsp samples dcsp on dcsp each dcsp edge n edge dcnl dcsp n x x shape1 + 2 n edge dcnl dcsp if phase zerodouble dcnl dcsp dcsp h np convolve h h 1 dcnl dcsp min fft 2 len h 1 dcnl dcsp if n fft is none dcnl dcsp dcsp max fft n x dcnl dcsp dcsp if max fft min fft dcnl dcsp dcsp dcsp n 2 np arange np ceil np log2 min fft np ceil np log2 max fft + 1 dtype int dcnl dcsp dcsp dcsp cost np ceil n x n len h + 1 astype np float n np log2 n + 1 dcnl dcsp dcsp dcsp cost + 4e05 n n x dcnl dcsp dcsp dcsp n fft nnp argmin cost dcnl dcsp dcsp else dcnl dcsp dcsp dcsp n fft next fast len min fft dcnl dcsp logger debug fft dcsp block dcsp length dcsp dcsp dcsp s n fft dcnl dcsp if n fft < min fft dcnl dcsp dcsp raise valueerror n fft dcsp is dcsp too dcsp short dcsp has dcsp to dcsp be dcsp at dcsp least dcsp 2 dcsp dcsp len h dcsp dcsp 1 dcsp s dcsp got dcsp s min fft n fft dcnl dcsp h fft fft np concatenate h np zeros n fft len h dtype h dtype dcnl dcsp n jobs cuda dict h fft setup cuda fft multiply repeated n jobs h fft dcnl dcsp picks np arange len x if picks is none else picks dcnl dcsp if n jobs 1 dcnl dcsp dcsp for p in picks dcnl dcsp dcsp dcsp xp 1d overlap filter xp h fft len h n edge phase cuda dict dcnl dcsp else dcnl dcsp dcsp parallel p fun parallel func 1d overlap filter n jobs dcnl dcsp dcsp data new parallel p fun xp h fft len h n edge phase cuda dict for p in picks dcnl dcsp dcsp for pp p in enumerate picks dcnl dcsp dcsp dcsp xp data newpp dcnl dcsp x shape orig shape dcnl dcsp return x
def 1d overlap filter x h fft n h n edge phase cuda dict dcsp if cuda dict use cuda dcnl dcsp dcsp n fft cuda dict x size dcnl dcsp else dcnl dcsp dcsp n fft len h fft dcnl dcsp x ext smart pad x np array n edge n edge dcnl dcsp n x len x ext dcnl dcsp x filtered np zeros like x ext dcnl dcsp n seg n fft n h + 1 dcnl dcsp n segments int np ceil n x float n seg dcnl dcsp shift n h 1 2 if phase startswith zero else 0 + n edge dcnl dcsp for seg idx in range n segments dcnl dcsp dcsp start seg idx n seg dcnl dcsp dcsp stop seg idx + 1 n seg dcnl dcsp dcsp seg x extstart stop dcnl dcsp dcsp seg np concatenate seg np zeros n fft len seg dcnl dcsp dcsp prod fft multiply repeated h fft seg cuda dict dcnl dcsp dcsp start filt max 0 start shift dcnl dcsp dcsp stop filt min start shift + n fft n x dcnl dcsp dcsp start prod max 0 shift start dcnl dcsp dcsp stop prod start prod + stop filt start filt dcnl dcsp dcsp x filteredstart filt stop filt + prodstart prod stop prod dcnl dcsp x filtered x filtered n x 2 n edge astype x dtype dcnl dcsp return x filtered
def filter attenuation h freq gain dcsp from scipy signal import freqz dcnl dcsp filt resp freqz h ravel worn np pi freq dcnl dcsp filt resp np abs filt resp dcnl dcsp filt respnp where gain 1 0 dcnl dcsp idx np argmax filt resp dcnl dcsp att db 20 np log10 np maximum filt respidx 1e20 dcnl dcsp att freq freqidx dcnl dcsp return att db att freq
def prep for filtering x copy picks none dcsp if x dtype np float64 dcnl dcsp dcsp raise typeerror arrays dcsp passed dcsp for dcsp filtering dcsp must dcsp have dcsp a dcsp dtype dcsp of dcsp np float64 dcnl dcsp if copy is true dcnl dcsp dcsp x x copy dcnl dcsp orig shape x shape dcnl dcsp x np atleast 2d x dcnl dcsp x shape np prod x shape 1 x shape 1 dcnl dcsp if picks is none dcnl dcsp dcsp picks np arange x shape0 dcnl dcsp elif len orig shape 3 dcnl dcsp dcsp n epochs n channels n times orig shape dcnl dcsp dcsp offset np repeat np arange 0 n channels n epochs n channels len picks dcnl dcsp dcsp picks np tile picks n epochs + offset dcnl dcsp elif len orig shape 3 dcnl dcsp dcsp raise valueerror picks dcsp argument dcsp is dcsp not dcsp supported dcsp for dcsp data dcsp with dcsp more dcsp than dcsp three dcsp dimensions dcnl dcsp picks np array picks int ravel dcnl dcsp if not all 0 < pick < x shape0 for pick in picks or len set picks len picks dcnl dcsp dcsp raise valueerror bad dcsp argument dcsp for dcsp picks dcsp s picks dcnl dcsp return x orig shape picks
def firwin design n freq gain window sfreq dcsp from scipy signal import firwin dcnl dcsp assert freq0 0 dcnl dcsp assert len freq 1 dcnl dcsp assert len freq len gain dcnl dcsp h np zeros n dcnl dcsp prev freq freq 1 dcnl dcsp prev gain gain 1 dcnl dcsp if gain 1 1 dcnl dcsp dcsp h n 2 1 dcnl dcsp assert prev gain in 0 1 dcnl dcsp for this freq this gain in zip freq 1 1 gain 1 1 dcnl dcsp dcsp assert this gain in 0 1 dcnl dcsp dcsp if this gain prev gain dcnl dcsp dcsp dcsp transition prev freq this freq 2 0 dcnl dcsp dcsp dcsp this n int round length factorswindow transition dcnl dcsp dcsp dcsp this n + 1 this n 2 dcnl dcsp dcsp dcsp if this n n dcnl dcsp dcsp dcsp dcsp raise valueerror the dcsp requested dcsp filter dcsp length dcsp s dcsp is dcsp too dcsp short dcsp for dcsp the dcsp requested dcsp 0 2f dcsp hz dcsp transition dcsp band dcsp which dcsp requires dcsp s dcsp samples n transition sfreq 2 0 this n dcnl dcsp dcsp dcsp this h firwin this n prev freq + this freq 2 0 window window pass zero true nyq freq 1 dcnl dcsp dcsp dcsp offset n this n 2 dcnl dcsp dcsp dcsp if this gain 0 dcnl dcsp dcsp dcsp dcsp hoffset n offset this h dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp hoffset n offset + this h dcnl dcsp dcsp prev gain this gain dcnl dcsp dcsp prev freq this freq dcnl dcsp return h
def construct fir filter sfreq freq gain filter length phase fir window fir design dcsp assert freq0 0 dcnl dcsp if fir design firwin2 dcnl dcsp dcsp from scipy signal import firwin2 as fir design dcnl dcsp else dcnl dcsp dcsp assert fir design firwin dcnl dcsp dcsp fir design partial firwin design sfreq sfreq dcnl dcsp min att db 12 if phase minimum else 20 dcnl dcsp freq np array freq sfreq 2 0 dcnl dcsp if freq0 0 or freq 1 1 dcnl dcsp dcsp raise valueerror freq dcsp must dcsp start dcsp at dcsp 0 dcsp and dcsp end dcsp an dcsp nyquist dcsp s dcsp got dcsp s sfreq 2 0 freq dcnl dcsp gain np array gain dcnl dcsp n check zero phase length filter length phase gain 1 dcnl dcsp if phase minimum dcnl dcsp dcsp h fir design n 2 1 freq gain window fir window dcnl dcsp dcsp h minimum phase h dcnl dcsp else dcnl dcsp dcsp h fir design n freq gain window fir window dcnl dcsp assert h size n dcnl dcsp att db att freq filter attenuation h freq gain dcnl dcsp if phase zerodouble dcnl dcsp dcsp att db + 6 dcnl dcsp if att db < min att db dcnl dcsp dcsp att freq sfreq 2 0 dcnl dcsp dcsp warn attenuation dcsp at dcsp stop dcsp frequency dcsp 0 1fhz dcsp is dcsp only dcsp 0 1fdb dcsp increase dcsp filter length dcsp for dcsp higher dcsp attenuation att freq att db dcnl dcsp return h
def check coefficients system dcsp if isinstance system tuple dcnl dcsp dcsp from scipy signal import tf2zpk dcnl dcsp dcsp z p k tf2zpk system dcnl dcsp else dcnl dcsp dcsp from scipy signal import sos2zpk dcnl dcsp dcsp z p k sos2zpk system dcnl dcsp if np any np abs p 1 0 dcnl dcsp dcsp raise runtimeerror filter dcsp poles dcsp outside dcsp unit dcsp circle dcsp filter dcsp will dcsp be dcsp unstable dcsp consider dcsp using dcsp different dcsp filter dcsp coefficients
def filtfilt x iir params picks n jobs copy dcsp from scipy signal import filtfilt dcnl dcsp padlen min iir params padlen len x dcnl dcsp n jobs check n jobs n jobs dcnl dcsp x orig shape picks prep for filtering x copy picks dcnl dcsp if sos in iir params dcnl dcsp dcsp sosfiltfilt get sosfiltfilt dcnl dcsp dcsp fun partial sosfiltfilt sos iir params sos padlen padlen dcnl dcsp dcsp check coefficients iir params sos dcnl dcsp else dcnl dcsp dcsp fun partial filtfilt b iir params b a iir params a padlen padlen dcnl dcsp dcsp check coefficients iir params b iir params a dcnl dcsp if n jobs 1 dcnl dcsp dcsp for p in picks dcnl dcsp dcsp dcsp xp fun x xp dcnl dcsp else dcnl dcsp dcsp parallel p fun parallel func fun n jobs dcnl dcsp dcsp data new parallel p fun x xp for p in picks dcnl dcsp dcsp for pp p in enumerate picks dcnl dcsp dcsp dcsp xp data newpp dcnl dcsp x shape orig shape dcnl dcsp return x
def estimate ringing samples system max try 100000 dcsp from scipy import signal dcnl dcsp if isinstance system tuple dcnl dcsp dcsp kind ba dcnl dcsp dcsp b a system dcnl dcsp dcsp zi 0 0 len a 1 dcnl dcsp else dcnl dcsp dcsp kind sos dcnl dcsp dcsp sos system dcnl dcsp dcsp zi 0 0 2 len sos dcnl dcsp n per chunk 1000 dcnl dcsp n chunks max int np ceil max try float n per chunk dcnl dcsp x np zeros n per chunk dcnl dcsp x0 1 dcnl dcsp last good n per chunk dcnl dcsp thresh val 0 dcnl dcsp for ii in range n chunks max dcnl dcsp dcsp if kind ba dcnl dcsp dcsp dcsp h zi signal lfilter b a x zi zi dcnl dcsp dcsp else dcnl dcsp dcsp dcsp h zi signal sosfilt sos x zi zi dcnl dcsp dcsp x0 0 dcnl dcsp dcsp h np abs h dcnl dcsp dcsp thresh val max 0 001 np max h thresh val dcnl dcsp dcsp idx np where np abs h thresh val 0 dcnl dcsp dcsp if len idx 0 dcnl dcsp dcsp dcsp last good idx 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp idx ii 1 n per chunk + last good dcnl dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp warn could dcsp not dcsp properly dcsp estimate dcsp ringing dcsp for dcsp the dcsp filter dcnl dcsp dcsp idx n per chunk n chunks max dcnl dcsp return idx
def construct iir filter iir params f pass none f stop none sfreq none btype none return copy true dcsp from scipy signal import iirfilter iirdesign dcnl dcsp known filters bessel butter butterworth cauer cheby1 cheby2 chebyshev1 chebyshev2 chebyshevi chebyshevii ellip elliptic dcnl dcsp if not isinstance iir params dict dcnl dcsp dcsp raise typeerror iir params dcsp must dcsp be dcsp a dcsp dict dcsp got dcsp s type iir params dcnl dcsp system none dcnl dcsp if sos in iir params dcnl dcsp dcsp system iir params sos dcnl dcsp dcsp output sos dcnl dcsp elif a in iir params and b in iir params dcnl dcsp dcsp system iir params b iir params a dcnl dcsp dcsp output ba dcnl dcsp else dcnl dcsp dcsp output iir params get output none dcnl dcsp dcsp if output is none dcnl dcsp dcsp dcsp warn the dcsp default dcsp output dcsp type dcsp is dcsp ba dcsp in dcsp 0 13 dcsp but dcsp will dcsp change dcsp to dcsp sos dcsp in dcsp 0 14 dcnl dcsp dcsp dcsp output ba dcnl dcsp dcsp if not isinstance output string types or output not in ba sos dcnl dcsp dcsp dcsp raise valueerror output dcsp must dcsp be dcsp ba dcsp or dcsp sos dcsp got dcsp s output dcnl dcsp dcsp if ftype not in iir params dcnl dcsp dcsp dcsp raise runtimeerror ftype dcsp must dcsp be dcsp an dcsp entry dcsp in dcsp iir params dcsp if dcsp b dcsp and dcsp a dcsp are dcsp not dcsp specified dcnl dcsp dcsp ftype iir params ftype dcnl dcsp dcsp if ftype not in known filters dcnl dcsp dcsp dcsp raise runtimeerror ftype dcsp must dcsp be dcsp in dcsp filter dict dcsp from dcsp scipy signal dcsp e g dcsp butter dcsp cheby1 dcsp etc dcsp not dcsp s ftype dcnl dcsp dcsp wp np asanyarray f pass float sfreq 2 dcnl dcsp dcsp if order in iir params dcnl dcsp dcsp dcsp system iirfilter iir params order wp btype btype ftype ftype output output dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ws np asanyarray f stop float sfreq 2 dcnl dcsp dcsp dcsp if gpass not in iir params or gstop not in iir params dcnl dcsp dcsp dcsp dcsp raise valueerror iir params dcsp must dcsp have dcsp at dcsp least dcsp gstop dcsp and dcsp gpass dcsp or dcsp n dcsp entries dcnl dcsp dcsp dcsp system iirdesign wp ws iir params gpass iir params gstop ftype ftype output output dcnl dcsp if system is none dcnl dcsp dcsp raise runtimeerror coefficients dcsp could dcsp not dcsp be dcsp created dcsp from dcsp iir params dcnl dcsp check coefficients system dcnl dcsp if padlen not in iir params dcnl dcsp dcsp padlen estimate ringing samples system dcnl dcsp else dcnl dcsp dcsp padlen iir params padlen dcnl dcsp if return copy dcnl dcsp dcsp iir params deepcopy iir params dcnl dcsp iir params update dict padlen padlen dcnl dcsp if output sos dcnl dcsp dcsp iir params update sos system dcnl dcsp else dcnl dcsp dcsp iir params update b system0 a system1 dcnl dcsp return iir params
def check method method iir params extra types dcsp allowed types iir fir fft + list extra types dcnl dcsp if not isinstance method string types dcnl dcsp dcsp raise typeerror method dcsp must dcsp be dcsp a dcsp string dcnl dcsp if method not in allowed types dcnl dcsp dcsp raise valueerror method dcsp must dcsp be dcsp one dcsp of dcsp s dcsp not dcsp s allowed types method dcnl dcsp if method fft dcnl dcsp dcsp method fir dcnl dcsp if method iir dcnl dcsp dcsp if iir params is none dcnl dcsp dcsp dcsp iir params dict dcnl dcsp dcsp if len iir params 0 or len iir params 1 and output in iir params dcnl dcsp dcsp dcsp iir params dict order 4 ftype butter output iir params get output sos dcnl dcsp elif iir params is not none dcnl dcsp dcsp raise valueerror iir params dcsp must dcsp be dcsp none dcsp if dcsp method dcsp dcsp iir dcnl dcsp return iir params method
verbose dcnl def filter data data sfreq l freq h freq picks none filter length auto l trans bandwidth auto h trans bandwidth auto n jobs 1 method fir iir params none copy true phase zero fir window hamming fir design none verbose none dcsp if not isinstance data np ndarray dcnl dcsp dcsp raise valueerror data dcsp must dcsp be dcsp an dcsp array dcnl dcsp iir params method check method method iir params dcnl dcsp filt create filter data sfreq l freq h freq filter length l trans bandwidth h trans bandwidth method iir params phase fir window fir design dcnl dcsp if method in fir fft dcnl dcsp dcsp data overlap add filter data filt none phase picks n jobs copy dcnl dcsp else dcnl dcsp dcsp data filtfilt data filt picks n jobs copy dcnl dcsp return data
verbose dcnl def create filter data sfreq l freq h freq filter length auto l trans bandwidth auto h trans bandwidth auto method fir iir params none phase zero fir window hamming fir design none verbose none dcsp sfreq float sfreq dcnl dcsp if sfreq < 0 dcnl dcsp dcsp raise valueerror sfreq dcsp must dcsp be dcsp positive dcnl dcsp if h freq is not none dcnl dcsp dcsp h freq np array h freq float ravel dcnl dcsp dcsp if h freq sfreq 2 0 any dcnl dcsp dcsp dcsp raise valueerror h freq dcsp s dcsp must dcsp be dcsp less dcsp than dcsp the dcsp nyquist dcsp frequency dcsp s h freq sfreq 2 0 dcnl dcsp if l freq is not none dcnl dcsp dcsp l freq np array l freq float ravel dcnl dcsp dcsp if l freq 0 all dcnl dcsp dcsp dcsp l freq none dcnl dcsp iir params method check method method iir params dcnl dcsp if l freq is none and h freq is none dcnl dcsp dcsp data sfreq filter length phase fir window fir design triage filter params data sfreq none none none none filter length method phase fir window fir design dcnl dcsp dcsp if method iir dcnl dcsp dcsp dcsp out dict if iir params is none else deepcopy iir params dcnl dcsp dcsp dcsp out update b np array 1 0 a np array 1 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp freq 0 sfreq 2 0 dcnl dcsp dcsp dcsp gain 1 0 1 0 dcnl dcsp if l freq is none and h freq is not none dcnl dcsp dcsp logger info setting dcsp up dcsp lowpass dcsp filter dcsp at dcsp 0 2g dcsp hz h freq dcnl dcsp dcsp data sfreq f p f s filter length phase fir window fir design triage filter params data sfreq none h freq none h trans bandwidth filter length method phase fir window fir design dcnl dcsp dcsp if method iir dcnl dcsp dcsp dcsp out construct iir filter iir params f p f s sfreq low dcnl dcsp dcsp else dcnl dcsp dcsp dcsp freq 0 f p f s dcnl dcsp dcsp dcsp gain 1 1 0 dcnl dcsp dcsp dcsp if f s sfreq 2 0 dcnl dcsp dcsp dcsp dcsp freq + sfreq 2 0 dcnl dcsp dcsp dcsp dcsp gain + 0 dcnl dcsp elif l freq is not none and h freq is none dcnl dcsp dcsp logger info setting dcsp up dcsp highpass dcsp filter dcsp at dcsp 0 2g dcsp hz l freq dcnl dcsp dcsp data sfreq pass stop filter length phase fir window fir design triage filter params data sfreq l freq none l trans bandwidth none filter length method phase fir window fir design dcnl dcsp dcsp if method iir dcnl dcsp dcsp dcsp out construct iir filter iir params pass stop sfreq high dcnl dcsp dcsp else dcnl dcsp dcsp dcsp freq stop pass sfreq 2 0 dcnl dcsp dcsp dcsp gain 0 1 1 dcnl dcsp dcsp dcsp if stop 0 dcnl dcsp dcsp dcsp dcsp freq 0 + freq dcnl dcsp dcsp dcsp dcsp gain 0 + gain dcnl dcsp elif l freq is not none and h freq is not none dcnl dcsp dcsp if l freq < h freq any dcnl dcsp dcsp dcsp logger info setting dcsp up dcsp bandpass dcsp filter dcsp from dcsp 0 2g dcsp dcsp 0 2g dcsp hz l freq h freq dcnl dcsp dcsp dcsp data sfreq f p1 f p2 f s1 f s2 filter length phase fir window fir design triage filter params data sfreq l freq h freq l trans bandwidth h trans bandwidth filter length method phase fir window fir design dcnl dcsp dcsp dcsp if method iir dcnl dcsp dcsp dcsp dcsp out construct iir filter iir params f p1 f p2 f s1 f s2 sfreq bandpass dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp freq f s1 f p1 f p2 f s2 dcnl dcsp dcsp dcsp dcsp gain 0 1 1 0 dcnl dcsp dcsp dcsp dcsp if f s2 sfreq 2 0 dcnl dcsp dcsp dcsp dcsp dcsp freq + sfreq 2 0 dcnl dcsp dcsp dcsp dcsp dcsp gain + 0 dcnl dcsp dcsp dcsp dcsp if f s1 0 dcnl dcsp dcsp dcsp dcsp dcsp freq 0 + freq dcnl dcsp dcsp dcsp dcsp dcsp gain 0 + gain dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if len l freq len h freq dcnl dcsp dcsp dcsp dcsp raise valueerror l freq dcsp and dcsp h freq dcsp must dcsp be dcsp the dcsp same dcsp length dcnl dcsp dcsp dcsp msg setting dcsp up dcsp bandstop dcsp filter dcnl dcsp dcsp dcsp if len l freq 1 dcnl dcsp dcsp dcsp dcsp msg + dcsp from dcsp 0 2g dcsp dcsp 0 2g dcsp hz h freq l freq dcnl dcsp dcsp dcsp logger info msg dcnl dcsp dcsp dcsp data sfreq f s1 f s2 f p1 f p2 filter length phase fir window fir design triage filter params data sfreq h freq l freq h trans bandwidth l trans bandwidth filter length method phase fir window fir design bands arr reverse true dcnl dcsp dcsp dcsp if method iir dcnl dcsp dcsp dcsp dcsp if len f p1 1 dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror multiple dcsp stopbands dcsp can dcsp only dcsp be dcsp used dcsp with dcsp fir dcsp filtering dcnl dcsp dcsp dcsp dcsp out construct iir filter iir params f p10 f p20 f s10 f s20 sfreq bandstop dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp freq np r f p1 f s1 f s2 f p2 dcnl dcsp dcsp dcsp dcsp gain np r np ones like f p1 np zeros like f s1 np zeros like f s2 np ones like f p2 dcnl dcsp dcsp dcsp dcsp order np argsort freq dcnl dcsp dcsp dcsp dcsp freq freqorder dcnl dcsp dcsp dcsp dcsp gain gainorder dcnl dcsp dcsp dcsp dcsp if freq0 0 dcnl dcsp dcsp dcsp dcsp dcsp freq np r 0 0 freq dcnl dcsp dcsp dcsp dcsp dcsp gain np r 1 0 gain dcnl dcsp dcsp dcsp dcsp if freq 1 sfreq 2 0 dcnl dcsp dcsp dcsp dcsp dcsp freq np r freq sfreq 2 0 dcnl dcsp dcsp dcsp dcsp dcsp gain np r gain 1 0 dcnl dcsp dcsp dcsp dcsp if np any np abs np diff gain 2 1 dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror stop dcsp bands dcsp are dcsp not dcsp sufficiently dcsp separated dcnl dcsp if method fir dcnl dcsp dcsp out construct fir filter sfreq freq gain filter length phase fir window fir design dcnl dcsp return out
verbose dcnl def notch filter x fs freqs filter length auto notch widths none trans bandwidth 1 method fir iir params none mt bandwidth none p value 0 05 picks none n jobs 1 copy true phase zero fir window hamming fir design none verbose none dcsp iir params method check method method iir params spectrum fit dcnl dcsp if freqs is not none dcnl dcsp dcsp freqs np atleast 1d freqs dcnl dcsp elif method spectrum fit dcnl dcsp dcsp raise valueerror freqs none dcsp can dcsp only dcsp be dcsp used dcsp with dcsp method dcsp spectrum fit dcnl dcsp if freqs is not none dcnl dcsp dcsp if notch widths is none dcnl dcsp dcsp dcsp notch widths freqs 200 0 dcnl dcsp dcsp elif np any notch widths < 0 dcnl dcsp dcsp dcsp raise valueerror notch widths dcsp must dcsp be dcsp dcsp 0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp notch widths np atleast 1d notch widths dcnl dcsp dcsp dcsp if len notch widths 1 dcnl dcsp dcsp dcsp dcsp notch widths notch widths0 np ones like freqs dcnl dcsp dcsp dcsp elif len notch widths len freqs dcnl dcsp dcsp dcsp dcsp raise valueerror notch widths dcsp must dcsp be dcsp none dcsp scalar dcsp or dcsp the dcsp same dcsp length dcsp as dcsp freqs dcnl dcsp if method in fir iir dcnl dcsp dcsp tb 2 trans bandwidth 2 0 dcnl dcsp dcsp lows freq nw 2 0 tb 2 for freq nw in zip freqs notch widths dcnl dcsp dcsp highs freq + nw 2 0 + tb 2 for freq nw in zip freqs notch widths dcnl dcsp dcsp xf filter data x fs highs lows picks filter length tb 2 tb 2 n jobs method iir params copy phase fir window fir design dcnl dcsp elif method spectrum fit dcnl dcsp dcsp xf mt spectrum proc x fs freqs notch widths mt bandwidth p value picks n jobs copy dcnl dcsp return xf
def mt spectrum proc x sfreq line freqs notch widths mt bandwidth p value picks n jobs copy dcsp from scipy import stats dcnl dcsp n jobs check n jobs n jobs dcnl dcsp x orig shape picks prep for filtering x copy picks dcnl dcsp n times x shape1 dcnl dcsp dpss n times max 1000 dcnl dcsp if mt bandwidth is not none dcnl dcsp dcsp half nbw float mt bandwidth n times 2 sfreq dcnl dcsp else dcnl dcsp dcsp half nbw 4 dcnl dcsp n tapers max int 2 half nbw dcnl dcsp window fun eigvals dpss windows n times half nbw n tapers max low bias false interp from min n times dpss n times max dcnl dcsp threshold stats f ppf 1 p value n times 2 2 len window fun 2 dcnl dcsp if n jobs 1 dcnl dcsp dcsp freq list list dcnl dcsp dcsp for ii x in enumerate x dcnl dcsp dcsp dcsp if ii in picks dcnl dcsp dcsp dcsp dcsp xii f mt spectrum remove x sfreq line freqs notch widths window fun threshold dcnl dcsp dcsp dcsp dcsp freq list append f dcnl dcsp else dcnl dcsp dcsp parallel p fun parallel func mt spectrum remove n jobs dcnl dcsp dcsp data new parallel p fun x sfreq line freqs notch widths window fun threshold for xi x in enumerate x if xi in picks dcnl dcsp dcsp freq list d1 for d in data new dcnl dcsp dcsp data new np array d0 for d in data new dcnl dcsp dcsp xpicks data new dcnl dcsp for rm freqs in freq list dcnl dcsp dcsp if line freqs is none dcnl dcsp dcsp dcsp if len rm freqs 0 dcnl dcsp dcsp dcsp dcsp logger info detected dcsp notch dcsp frequencies n s dcsp join str rm f for rm f in rm freqs dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp logger info detected dcsp notch dcsp frequecies nnone dcnl dcsp x shape orig shape dcnl dcsp return x
def mt spectrum remove x sfreq line freqs notch widths window fun threshold dcsp n tapers len window fun dcnl dcsp tapers odd np arange 0 n tapers 2 dcnl dcsp tapers even np arange 1 n tapers 2 dcnl dcsp tapers use window funtapers odd dcnl dcsp h0 np sum tapers use axis 1 dcnl dcsp h0 sq sum squared h0 dcnl dcsp rads 2 np pi np arange x size float sfreq dcnl dcsp x p freqs mt spectra xnp newaxis window fun sfreq dcnl dcsp x p h0 np sum x p tapers odd h0np newaxis np newaxis axis 1 dcnl dcsp a x p h0 h0 sq dcnl dcsp if line freqs is none dcnl dcsp dcsp x hat a h0 np newaxis dcnl dcsp dcsp num n tapers 1 a a conj real h0 sq dcnl dcsp dcsp den np sum np abs x p tapers odd x hat 2 1 + np sum np abs x p tapers even 2 1 dcnl dcsp dcsp den den 0 np inf dcnl dcsp dcsp f stat num den dcnl dcsp dcsp indices np where f stat threshold 1 dcnl dcsp dcsp rm freqs freqsindices dcnl dcsp else dcnl dcsp dcsp indices 1 np unique np argmin np abs freqs lf for lf in line freqs dcnl dcsp dcsp notch widths 2 0 dcnl dcsp dcsp indices 2 np logical and freqs lf nw freqs < lf + nw for lf nw in zip line freqs notch widths dcnl dcsp dcsp indices 2 np where np any np array indices 2 axis 0 0 dcnl dcsp dcsp indices np unique np r indices 1 indices 2 dcnl dcsp dcsp rm freqs freqsindices dcnl dcsp fits list dcnl dcsp for ind in indices dcnl dcsp dcsp c 2 a 0 ind dcnl dcsp dcsp fit np abs c np cos freqsind rads + np angle c dcnl dcsp dcsp fits append fit dcnl dcsp if len fits 0 dcnl dcsp dcsp datafit 0 0 dcnl dcsp else dcnl dcsp dcsp datafit np sum np atleast 2d fits axis 0 dcnl dcsp return x datafit rm freqs
verbose dcnl def resample x up 1 0 down 1 0 npad 100 axis 1 window boxcar n jobs 1 verbose none dcsp from scipy signal import get window dcnl dcsp if not isinstance axis int dcnl dcsp dcsp err the dcsp axis dcsp parameter dcsp needs dcsp to dcsp be dcsp an dcsp integer dcsp got dcsp s dcsp the dcsp axis dcsp parameter dcsp was dcsp missing dcsp from dcsp this dcsp function dcsp for dcsp a dcsp period dcsp of dcsp time dcsp you dcsp might dcsp be dcsp intending dcsp to dcsp specify dcsp the dcsp subsequent dcsp window dcsp parameter repr axis dcnl dcsp dcsp raise typeerror err dcnl dcsp x np asanyarray x dcnl dcsp ratio float up down dcnl dcsp if axis < 0 dcnl dcsp dcsp axis x ndim + axis dcnl dcsp orig last axis x ndim 1 dcnl dcsp if axis orig last axis dcnl dcsp dcsp x x swapaxes axis orig last axis dcnl dcsp orig shape x shape dcnl dcsp x len orig shape 1 dcnl dcsp if x len 0 dcnl dcsp dcsp warn x dcsp has dcsp zero dcsp length dcsp along dcsp last dcsp axis dcsp returning dcsp a dcsp copy dcsp of dcsp x dcnl dcsp dcsp return x copy dcnl dcsp bad msg npad dcsp must dcsp be dcsp auto dcsp or dcsp an dcsp integer dcnl dcsp if isinstance npad string types dcnl dcsp dcsp if npad auto dcnl dcsp dcsp dcsp raise valueerror bad msg dcnl dcsp dcsp min add min x len 8 100 2 dcnl dcsp dcsp npad 2 int np ceil np log2 x len + min add x len dcnl dcsp dcsp npad extra divmod npad 2 dcnl dcsp dcsp npads np array npad npad + extra int dcnl dcsp else dcnl dcsp dcsp if npad int npad dcnl dcsp dcsp dcsp raise valueerror bad msg dcnl dcsp dcsp npads np array npad npad int dcnl dcsp del npad dcnl dcsp x flat x reshape 1 x len dcnl dcsp orig len x len + npads sum dcnl dcsp new len int round ratio orig len dcnl dcsp final len int round ratio x len dcnl dcsp to removes int round ratio npads0 dcnl dcsp to removes append new len final len to removes0 dcnl dcsp to removes np array to removes dcnl dcsp if window is not none dcnl dcsp dcsp if callable window dcnl dcsp dcsp dcsp w window fftfreq orig len dcnl dcsp dcsp elif isinstance window np ndarray and window shape orig len dcnl dcsp dcsp dcsp w window dcnl dcsp dcsp else dcnl dcsp dcsp dcsp w ifftshift get window window orig len dcnl dcsp else dcnl dcsp dcsp w np ones orig len dcnl dcsp w float new len float orig len dcnl dcsp w w astype np complex128 dcnl dcsp n jobs cuda dict w setup cuda fft resample n jobs w new len dcnl dcsp if n jobs 1 dcnl dcsp dcsp y np zeros len x flat new len to removes sum dtype x dtype dcnl dcsp dcsp for xi x in enumerate x flat dcnl dcsp dcsp dcsp yxi fft resample x w new len npads to removes cuda dict dcnl dcsp else dcnl dcsp dcsp parallel p fun parallel func fft resample n jobs dcnl dcsp dcsp y parallel p fun x w new len npads to removes cuda dict for x in x flat dcnl dcsp dcsp y np array y dcnl dcsp y shape orig shape 1 + y shape1 dcnl dcsp if axis orig last axis dcnl dcsp dcsp y y swapaxes axis orig last axis dcnl dcsp return y
def resample stim channels stim data up down dcsp stim data np atleast 2d stim data dcnl dcsp n stim channels n samples stim data shape dcnl dcsp ratio float up down dcnl dcsp resampled n samples int round n samples ratio dcnl dcsp stim resampled np zeros n stim channels resampled n samples dcnl dcsp sample picks np minimum np arange resampled n samples ratio astype int n samples 1 dcnl dcsp windows zip sample picks np r sample picks1 n samples dcnl dcsp for window i window in enumerate windows dcnl dcsp dcsp for stim num stim in enumerate stim data dcnl dcsp dcsp dcsp nonzero stimwindow0 window1 nonzero 0 dcnl dcsp dcsp dcsp if len nonzero 0 dcnl dcsp dcsp dcsp dcsp val stim window0 + nonzero0 dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp val stimwindow0 dcnl dcsp dcsp dcsp stim resampled stim num window i val dcnl dcsp return stim resampled
def detrend x order 1 axis 1 dcsp from scipy signal import detrend dcnl dcsp if axis len x shape dcnl dcsp dcsp raise valueerror x dcsp does dcsp not dcsp have dcsp d dcsp axes axis dcnl dcsp if order 0 dcnl dcsp dcsp fit constant dcnl dcsp elif order 1 dcnl dcsp dcsp fit linear dcnl dcsp else dcnl dcsp dcsp raise valueerror order dcsp must dcsp be dcsp 0 dcsp or dcsp 1 dcnl dcsp y detrend x axis axis type fit dcnl dcsp return y
def triage filter params x sfreq l freq h freq l trans bandwidth h trans bandwidth filter length method phase fir window fir design bands scalar reverse false dcsp if not isinstance phase string types or phase not in linear zero zerodouble minimum dcnl dcsp dcsp raise valueerror phase dcsp must dcsp be dcsp linear dcsp zero dcsp zerodouble dcsp or dcsp minimum dcsp got dcsp s phase dcnl dcsp if not isinstance fir window string types or fir window not in hann hamming blackman dcnl dcsp dcsp raise valueerror fir window dcsp must dcsp be dcsp hamming dcsp hann dcsp or dcsp blackman got dcsp s fir window dcnl dcsp if fir design is none dcnl dcsp dcsp fir design firwin2 dcnl dcsp dcsp if method iir dcnl dcsp dcsp dcsp warn fir design dcsp defaults dcsp to dcsp firwin2 dcsp in dcsp 0 15 dcsp but dcsp will dcsp change dcsp to dcsp firwin dcsp in dcsp 0 16 dcsp set dcsp it dcsp explicitly dcsp to dcsp avoid dcsp this dcsp warning deprecationwarning dcnl dcsp if not isinstance fir design string types or fir design not in firwin firwin2 dcnl dcsp dcsp raise valueerror fir design dcsp must dcsp be dcsp firwin dcsp or dcsp firwin2 dcsp got dcsp s fir design dcnl dcsp def float array c dcnl dcsp dcsp return np array c float ravel dcnl dcsp if bands arr dcnl dcsp dcsp cast float array dcnl dcsp else dcnl dcsp dcsp cast float dcnl dcsp x np asanyarray x dcnl dcsp len x x shape 1 dcnl dcsp sfreq float sfreq dcnl dcsp if l freq is not none dcnl dcsp dcsp l freq cast l freq dcnl dcsp dcsp if np any l freq < 0 dcnl dcsp dcsp dcsp raise valueerror highpass dcsp frequency dcsp s dcsp must dcsp be dcsp greater dcsp than dcsp zero l freq dcnl dcsp if h freq is not none dcnl dcsp dcsp h freq cast h freq dcnl dcsp dcsp if np any h freq sfreq 2 0 dcnl dcsp dcsp dcsp raise valueerror lowpass dcsp frequency dcsp s dcsp must dcsp be dcsp less dcsp than dcsp nyquist dcsp s h freq sfreq 2 0 dcnl dcsp if method iir dcnl dcsp dcsp l stop h stop l freq h freq dcnl dcsp else dcnl dcsp dcsp l stop h stop none dcnl dcsp dcsp if l freq is not none dcnl dcsp dcsp dcsp if isinstance l trans bandwidth string types dcnl dcsp dcsp dcsp dcsp if l trans bandwidth auto dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror l trans bandwidth dcsp must dcsp be dcsp auto dcsp if dcsp string dcsp got dcsp s l trans bandwidth dcnl dcsp dcsp dcsp dcsp l trans bandwidth np minimum np maximum 0 25 l freq 2 0 l freq dcnl dcsp dcsp dcsp dcsp logger info l trans bandwidth dcsp chosen dcsp to dcsp be dcsp 0 1f dcsp hz l trans bandwidth dcnl dcsp dcsp dcsp l trans bandwidth cast l trans bandwidth dcnl dcsp dcsp dcsp if np any l trans bandwidth < 0 dcnl dcsp dcsp dcsp dcsp raise valueerror l trans bandwidth dcsp must dcsp be dcsp positive dcsp got dcsp s l trans bandwidth dcnl dcsp dcsp dcsp l stop l freq l trans bandwidth dcnl dcsp dcsp dcsp if reverse dcnl dcsp dcsp dcsp dcsp l stop + l trans bandwidth dcnl dcsp dcsp dcsp dcsp l freq + l trans bandwidth dcnl dcsp dcsp dcsp if np any l stop < 0 dcnl dcsp dcsp dcsp dcsp raise valueerror filter dcsp specification dcsp invalid dcsp lower dcsp stop dcsp frequency dcsp negative dcsp 0 1fhz dcsp increase dcsp pass dcsp frequency dcsp or dcsp reduce dcsp the dcsp transition dcsp bandwidth dcsp l trans bandwidth l stop dcnl dcsp dcsp if h freq is not none dcnl dcsp dcsp dcsp if isinstance h trans bandwidth string types dcnl dcsp dcsp dcsp dcsp if h trans bandwidth auto dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror h trans bandwidth dcsp must dcsp be dcsp auto dcsp if dcsp string dcsp got dcsp s h trans bandwidth dcnl dcsp dcsp dcsp dcsp h trans bandwidth np minimum np maximum 0 25 h freq 2 0 sfreq 2 0 h freq dcnl dcsp dcsp dcsp dcsp logger info h trans bandwidth dcsp chosen dcsp to dcsp be dcsp 0 1f dcsp hz h trans bandwidth dcnl dcsp dcsp dcsp h trans bandwidth cast h trans bandwidth dcnl dcsp dcsp dcsp if np any h trans bandwidth < 0 dcnl dcsp dcsp dcsp dcsp raise valueerror h trans bandwidth dcsp must dcsp be dcsp positive dcsp got dcsp s h trans bandwidth dcnl dcsp dcsp dcsp h stop h freq + h trans bandwidth dcnl dcsp dcsp dcsp if reverse dcnl dcsp dcsp dcsp dcsp h stop h trans bandwidth dcnl dcsp dcsp dcsp dcsp h freq h trans bandwidth dcnl dcsp dcsp dcsp if np any h stop sfreq 2 dcnl dcsp dcsp dcsp dcsp raise valueerror effective dcsp bandstop dcsp frequency dcsp s dcsp is dcsp too dcsp high dcsp maximum dcsp based dcsp on dcsp nyquist dcsp is dcsp s h stop sfreq 2 0 dcnl dcsp dcsp if isinstance filter length string types dcnl dcsp dcsp dcsp filter length filter length lower dcnl dcsp dcsp dcsp if filter length auto dcnl dcsp dcsp dcsp dcsp h check h trans bandwidth if h freq is not none else np inf dcnl dcsp dcsp dcsp dcsp l check l trans bandwidth if l freq is not none else np inf dcnl dcsp dcsp dcsp dcsp mult fact 2 0 if fir design firwin2 else 1 0 dcnl dcsp dcsp dcsp dcsp filter length max int round length factorsfir window sfreq mult fact float min h check l check 1 dcnl dcsp dcsp dcsp dcsp logger info filter dcsp length dcsp of dcsp s dcsp samples dcsp 0 3f dcsp sec dcsp selected filter length filter length sfreq dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp err msg filter length dcsp if dcsp a dcsp string dcsp must dcsp be dcsp a dcsp humanreadable dcsp time dcsp e g dcsp 10s dcsp or dcsp auto dcsp not dcsp s filter length dcnl dcsp dcsp dcsp dcsp if filter length lower endswith ms dcnl dcsp dcsp dcsp dcsp dcsp mult fact 0 001 dcnl dcsp dcsp dcsp dcsp dcsp filter length filter length 2 dcnl dcsp dcsp dcsp dcsp elif filter length 1 lower s dcnl dcsp dcsp dcsp dcsp dcsp mult fact 1 dcnl dcsp dcsp dcsp dcsp dcsp filter length filter length 1 dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror err msg dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp filter length float filter length dcnl dcsp dcsp dcsp dcsp except valueerror dcnl dcsp dcsp dcsp dcsp dcsp raise valueerror err msg dcnl dcsp dcsp dcsp dcsp if phase zerodouble dcnl dcsp dcsp dcsp dcsp dcsp filter length 2 int np ceil np log2 filter length mult fact sfreq dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp filter length max int np ceil filter length mult fact sfreq 1 dcnl dcsp dcsp elif not isinstance filter length integer types dcnl dcsp dcsp dcsp raise valueerror filter length dcsp must dcsp be dcsp a dcsp str dcsp int dcsp or dcsp none dcsp got dcsp s type filter length dcnl dcsp if method fir dcnl dcsp dcsp filter length len x dcnl dcsp if phase zero and method fir dcnl dcsp dcsp filter length + filter length 2 0 dcnl dcsp if filter length < 0 dcnl dcsp dcsp raise valueerror filter length dcsp must dcsp be dcsp positive dcsp got dcsp s filter length dcnl dcsp if filter length len x dcnl dcsp dcsp warn filter length dcsp s dcsp is dcsp longer dcsp than dcsp the dcsp signal dcsp s dcsp distortion dcsp is dcsp likely dcsp reduce dcsp filter dcsp length dcsp or dcsp filter dcsp a dcsp longer dcsp signal filter length len x dcnl dcsp logger debug using dcsp filter dcsp length dcsp s filter length dcnl dcsp return x sfreq l freq h freq l stop h stop filter length phase fir window fir design
verbose dcnl def design mne c filter sfreq l freq none h freq 40 0 l trans bandwidth none h trans bandwidth 5 0 verbose none dcsp n freqs 4096 + 2 2048 2 + 1 dcnl dcsp freq resp np ones n freqs dcnl dcsp l freq 0 if l freq is none else float l freq dcnl dcsp if l trans bandwidth is none dcnl dcsp dcsp l width 3 dcnl dcsp else dcnl dcsp dcsp l width int n freqs 1 l trans bandwidth 0 5 sfreq + 1 2 dcnl dcsp l start int n freqs 1 l freq 0 5 sfreq dcnl dcsp h freq sfreq 2 0 if h freq is none else float h freq dcnl dcsp h width int n freqs 1 h trans bandwidth 0 5 sfreq + 1 2 dcnl dcsp h start int n freqs 1 h freq 0 5 sfreq dcnl dcsp logger info filter dcsp dcsp 7 3f dcsp dcsp 6 1f dcsp hz dcsp dcsp dcsp bins dcsp dcsp d dcsp dcsp d dcsp of dcsp d dcsp hpw dcsp dcsp d dcsp lpw dcsp dcsp d l freq h freq l start h start n freqs l width h width dcnl dcsp if l freq 0 dcnl dcsp dcsp start l start l width + 1 dcnl dcsp dcsp stop start + 2 l width 1 dcnl dcsp dcsp if start < 0 or stop n freqs dcnl dcsp dcsp dcsp raise runtimeerror l freq dcsp too dcsp low dcsp or dcsp l trans bandwidth dcsp too dcsp large dcnl dcsp dcsp freq resp start 0 0 dcnl dcsp dcsp k np arange l width + 1 l width float l width + 3 0 dcnl dcsp dcsp freq respstart stop np cos np pi 4 0 k 2 dcnl dcsp if h freq < sfreq 2 0 dcnl dcsp dcsp start h start h width + 1 dcnl dcsp dcsp stop start + 2 h width 1 dcnl dcsp dcsp if start < 0 or stop n freqs dcnl dcsp dcsp dcsp raise runtimeerror h freq dcsp too dcsp high dcsp or dcsp h trans bandwidth dcsp too dcsp large dcnl dcsp dcsp k np arange h width + 1 h width float h width + 1 0 dcnl dcsp dcsp freq respstart stop np cos np pi 4 0 k 2 dcnl dcsp dcsp freq respstop 0 0 dcnl dcsp h ifft np concatenate freq resp freq resp 1 1 real dcnl dcsp h np roll h n freqs 1 dcnl dcsp return h
def log rescale baseline mode mean dcsp if baseline is not none dcnl dcsp dcsp valid modes logratio ratio zscore mean percent zlogratio dcnl dcsp dcsp if mode not in valid modes dcnl dcsp dcsp dcsp raise exception mode dcsp should dcsp be dcsp any dcsp of dcsp dcsp s valid modes dcnl dcsp dcsp msg applying dcsp baseline dcsp correction dcsp mode dcsp s mode dcnl dcsp else dcnl dcsp dcsp msg no dcsp baseline dcsp correction dcsp applied dcnl dcsp return msg
verbose dcnl def rescale data times baseline mode mean copy true verbose none dcsp data data copy if copy else data dcnl dcsp msg log rescale baseline mode dcnl dcsp logger info msg dcnl dcsp if baseline is none dcnl dcsp dcsp return data dcnl dcsp bmin bmax baseline dcnl dcsp if bmin is none dcnl dcsp dcsp imin 0 dcnl dcsp else dcnl dcsp dcsp imin np where times bmin 0 dcnl dcsp dcsp if len imin 0 dcnl dcsp dcsp dcsp raise valueerror bmin dcsp is dcsp too dcsp large dcsp s dcsp it dcsp exceeds dcsp the dcsp largest dcsp time dcsp value bmin dcnl dcsp dcsp imin int imin0 dcnl dcsp if bmax is none dcnl dcsp dcsp imax len times dcnl dcsp else dcnl dcsp dcsp imax np where times < bmax 0 dcnl dcsp dcsp if len imax 0 dcnl dcsp dcsp dcsp raise valueerror bmax dcsp is dcsp too dcsp small dcsp s dcsp it dcsp is dcsp smaller dcsp than dcsp the dcsp smallest dcsp time dcsp value bmax dcnl dcsp dcsp imax int imax 1 + 1 dcnl dcsp if imin imax dcnl dcsp dcsp raise valueerror bad dcsp rescaling dcsp slice dcsp s s dcsp from dcsp time dcsp values dcsp s dcsp s imin imax bmin bmax dcnl dcsp if data shape 1 0 dcnl dcsp dcsp mean np mean data imin imax axis 1 none dcnl dcsp else dcnl dcsp dcsp mean 0 dcnl dcsp if mode mean dcnl dcsp dcsp data mean dcnl dcsp elif mode logratio dcnl dcsp dcsp data mean dcnl dcsp dcsp data np log10 data dcnl dcsp elif mode ratio dcnl dcsp dcsp data mean dcnl dcsp elif mode zscore dcnl dcsp dcsp std np std data imin imax axis 1 none dcnl dcsp dcsp data mean dcnl dcsp dcsp data std dcnl dcsp elif mode percent dcnl dcsp dcsp data mean dcnl dcsp dcsp data mean dcnl dcsp elif mode zlogratio dcnl dcsp dcsp data mean dcnl dcsp dcsp data np log10 data dcnl dcsp dcsp std np std data imin imax axis 1 none dcnl dcsp dcsp data std dcnl dcsp return data
register dcnl def validate fun facts dcsp for fact in funfact objects published dcnl dcsp dcsp try dcnl dcsp dcsp dcsp validate query fact number dcnl dcsp dcsp dcsp if fact divisor dcnl dcsp dcsp dcsp dcsp validate query fact divisor dcnl dcsp dcsp except validationerror dcnl dcsp dcsp dcsp logger error unpublishing dcsp fact dcsp s fact name dcnl dcsp dcsp dcsp fact published false dcnl dcsp dcsp dcsp fact save
library global function dcnl def random funfact dcsp if funfact objects published count dcnl dcsp dcsp return funfact objects random dcnl dcsp return none
def calculate photo filename instance filename dcsp return os path join settings mozspace photo dir str uuid uuid4 + jpg
shared task bind true base debugbaskettask default retry delay basket task retry delay max retries basket task max retries dcnl def lookup user task self email dcsp result dcnl dcsp try dcnl dcsp dcsp result basket lookup user email email dcnl dcsp except maxretriesexceedederror as exc dcnl dcsp dcsp raise exc dcnl dcsp except basket basketexception as exc dcnl dcsp dcsp if not exc0 u user dcsp not dcsp found dcnl dcsp dcsp dcsp raise self retry exc exc dcnl dcsp dcsp result exc result dcnl dcsp return result
shared task bind true base debugbaskettask default retry delay basket task retry delay max retries basket task max retries dcnl def subscribe user task self result email newsletters sync n optin y dcsp if not result and not email dcnl dcsp dcsp return none dcnl dcsp newsletters to subscribe dcnl dcsp if result get status ok dcnl dcsp dcsp if not email dcnl dcsp dcsp dcsp email result get email dcnl dcsp dcsp if newsletters dcnl dcsp dcsp dcsp newsletters to subscribe list set newsletters set result newsletters dcnl dcsp dcsp else dcnl dcsp dcsp dcsp newsletters to subscribe list set mozillians newsletters intersection result newsletters dcnl dcsp if result get status error and result get desc u user dcsp not dcsp found and newsletters dcnl dcsp dcsp newsletters to subscribe newsletters dcnl dcsp if newsletters to subscribe dcnl dcsp dcsp try dcnl dcsp dcsp dcsp subscribe result basket subscribe email newsletters to subscribe sync sync source url mozillians url optin optin api key basket api key dcnl dcsp dcsp except maxretriesexceedederror as exc dcnl dcsp dcsp dcsp raise exc dcnl dcsp dcsp except basket basketexception as exc dcnl dcsp dcsp dcsp raise self retry exc exc dcnl dcsp dcsp return subscribe result dcnl dcsp return none
shared task bind true base debugbaskettask default retry delay basket task retry delay max retries basket task max retries dcnl def unsubscribe user task self result newsletters optout false dcsp if not result dcnl dcsp dcsp return none dcnl dcsp newsletters to unsubscribe dcnl dcsp if result get status ok dcnl dcsp dcsp email result get email dcnl dcsp dcsp token result get token dcnl dcsp dcsp if newsletters dcnl dcsp dcsp dcsp newsletters to unsubscribe list set newsletters intersection result newsletters dcnl dcsp dcsp else dcnl dcsp dcsp dcsp newsletters to unsubscribe list set mozillians newsletters intersection result newsletters dcnl dcsp if newsletters to unsubscribe dcnl dcsp dcsp try dcnl dcsp dcsp dcsp unsubscribe result basket unsubscribe token token email email newsletters newsletters to unsubscribe optout optout dcnl dcsp dcsp except maxretriesexceedederror as exc dcnl dcsp dcsp dcsp raise exc dcnl dcsp dcsp except basket basketexception as exc dcnl dcsp dcsp dcsp raise self retry exc exc dcnl dcsp dcsp return unsubscribe result dcnl dcsp return none
shared task dcnl def subscribe user to basket instance id newsletters dcsp from mozillians users models import userprofile dcnl dcsp try dcnl dcsp dcsp instance userprofile objects get pk instance id dcnl dcsp except userprofile doesnotexist dcnl dcsp dcsp instance none dcnl dcsp if not basket enabled or not instance or not newsletters or not waffle switch is active basket switch enabled dcnl dcsp dcsp return dcnl dcsp lookup subtask lookup user task subtask instance user email dcnl dcsp subscribe subtask subscribe user task subtask instance user email newsletters dcnl dcsp chain lookup subtask | subscribe subtask
shared task dcnl def update email in basket old email new email dcsp if not basket enabled or not waffle switch is active basket switch enabled dcnl dcsp dcsp return dcnl dcsp chain lookup user task subtask old email | group subscribe user task subtask new email unsubscribe user task subtask delay
shared task dcnl def unsubscribe from basket task email newsletters dcsp if not basket enabled or not waffle switch is active basket switch enabled dcnl dcsp dcsp return dcnl dcsp chain lookup user task subtask email | unsubscribe user task subtask newsletters delay
task dcnl def remove incomplete accounts days incomplete acc max days dcsp from mozillians users models import userprofile dcnl dcsp now datetime now timedelta days days dcnl dcsp userprofile objects filter full name filter user date joined lt now delete
task ignore result false dcnl def check celery dcsp pass
task dcnl def check spam account instance id kwargs dcsp from mozillians users models import abusereport userprofile dcnl dcsp spam akismet spam check kwargs dcnl dcsp profile get object or none userprofile id instance id dcnl dcsp if spam and profile dcnl dcsp dcsp kwargs type abusereport type spam profile profile reporter none is akismet true dcnl dcsp dcsp abusereport objects get or create kwargs
periodic task run every timedelta hours 24 dcnl def delete reported spam accounts dcsp from mozillians users models import abusereport dcnl dcsp reports abusereport objects filter profile is vouched false reporter isnull false dcnl dcsp for report in reports dcnl dcsp dcsp report profile delete dcnl dcsp reports delete
shared task time limit settings es reindex timeout dcnl def index all profiles dcsp es conn default default dcnl dcsp es conn tmp tmp dcnl dcsp es conn curr current dcnl dcsp es index default connectionses conn default options index name dcnl dcsp es index tmp connectionses conn tmp options index name dcnl dcsp es index curr connectionses conn curr options index name dcnl dcsp rebuild options using es conn tmp workers settings es reindex workers num batchsize settings es reindex batchsize interactive false dcnl dcsp call command rebuild index rebuild options dcnl dcsp es conn connectionses conn default get backend conn dcnl dcsp update aliases query actions remove index es index curr alias es index default add index es index tmp alias es index default dcnl dcsp es conn indices update aliases update aliases query dcnl dcsp rebuild options using es conn curr dcnl dcsp call command rebuild index rebuild options dcnl dcsp update aliases query actions add index es index curr alias es index default remove index es index tmp alias es index default dcnl dcsp es conn indices update aliases update aliases query dcnl dcsp options using es conn tmp interactive false dcnl dcsp call command clear index options
def get languages for locale locale dcsp locale locale replace dcnl dcsp if locale not in available languages dcnl dcsp dcsp try dcnl dcsp dcsp dcsp local lang babel locale parse locale languages dcnl dcsp dcsp except babel unknownlocaleerror dcnl dcsp dcsp dcsp return available languages en dcnl dcsp dcsp diff lc for lc in reference language keys if lc not in local lang keys dcnl dcsp dcsp for lc in diff dcnl dcsp dcsp dcsp local langlc reference languagelc dcnl dcsp dcsp for lang in remove langs dcnl dcsp dcsp dcsp if lang in local lang dcnl dcsp dcsp dcsp dcsp local lang pop lang dcnl dcsp dcsp local lang sorted key value capitalize for key value in local lang items key lambda language language1 dcnl dcsp dcsp available languageslocale local lang dcnl dcsp return available languageslocale
def autovouch getpocket apps schema editor dcsp userprofile apps get model u users u userprofile dcnl dcsp externalaccount apps get model u users u externalaccount dcnl dcsp primary qs list userprofile objects filter user email endswith u getpocket com values list u id flat true dcnl dcsp alternate qs list externalaccount objects filter type u email identifier endswith u getpocket com values list u user id flat true dcnl dcsp unique ids set list primary qs list + list alternate qs list dcnl dcsp userprofile qs userprofile objects filter pk in unique ids dcnl dcsp q args u autovouch true u description settings auto vouch reason dcnl dcsp for user in userprofile qs dcnl dcsp dcsp already autovouched user vouches received filter q args exists dcnl dcsp dcsp reached max vouches user vouches received all count settings vouch count limit dcnl dcsp dcsp if not already autovouched and not reached max vouches dcnl dcsp dcsp dcsp user vouches received create voucher none date datetime now description settings auto vouch reason autovouch true dcnl dcsp dcsp dcsp vouches user vouches received all count dcnl dcsp dcsp dcsp user is vouched vouches 0 dcnl dcsp dcsp dcsp user can vouch vouches settings can vouch threshold dcnl dcsp dcsp dcsp user save
def vouch mozilla alternate emails apps schema editor dcsp externalaccount apps get model u users u externalaccount dcnl dcsp userprofile apps get model u users u userprofile dcnl dcsp email query reduce operator or models q identifier icontains item for item in settings auto vouch domains dcnl dcsp user ids externalaccount objects filter type u email filter email query values list u user id flat true distinct dcnl dcsp users userprofile objects filter id in user ids dcnl dcsp q args u autovouch true u description settings auto vouch reason dcnl dcsp for user in users dcnl dcsp dcsp if not user vouches received filter q args exists dcnl dcsp dcsp dcsp if not user vouches received all count settings vouch count limit dcnl dcsp dcsp dcsp dcsp user vouches received create voucher none date datetime now description settings auto vouch reason autovouch true dcnl dcsp dcsp dcsp dcsp vouches user vouches received all count dcnl dcsp dcsp dcsp dcsp user is vouched vouches 0 dcnl dcsp dcsp dcsp dcsp user can vouch vouches settings can vouch threshold dcnl dcsp dcsp dcsp dcsp user save
def unvouch mozilla alternate emails apps schema editor dcsp pass
def calculate photo filename instance filename dcsp return os path join settings user avatar dir str uuid uuid4 + jpg
def subscribe to basket action newsletter dcsp def subscribe to basket modeladmin request queryset dcnl dcsp dcsp subscribe dcsp to dcsp basket dcsp or dcsp update dcsp details dcsp of dcsp already dcsp subscribed dcnl dcsp dcsp ts subscribe user to basket subtask args userprofile id newsletter for userprofile in queryset dcnl dcsp dcsp taskset ts apply async dcnl dcsp dcsp messages success request basket dcsp update dcsp started dcnl dcsp subscribe to basket short description subscribe dcsp to dcsp or dcsp update dcsp 0 format newsletter dcnl dcsp subscribe to basket name subscribe to basket 0 format newsletter replace dcnl dcsp return subscribe to basket
def unsubscribe from basket action newsletter dcsp def unsubscribe from basket modeladmin request queryset dcnl dcsp dcsp unsubscribe dcsp from dcsp basket dcnl dcsp dcsp ts unsubscribe from basket task subtask args userprofile user email newsletter for userprofile in queryset dcnl dcsp dcsp taskset ts apply async dcnl dcsp dcsp messages success request basket dcsp update dcsp started dcnl dcsp unsubscribe from basket short description unsubscribe dcsp from dcsp 0 format newsletter dcnl dcsp func name unsubscribe from basket 0 format newsletter replace dcnl dcsp unsubscribe from basket name func name dcnl dcsp return unsubscribe from basket
def update vouch flags action dcsp def update vouch flags modeladmin request queryset dcnl dcsp dcsp for profile in queryset dcnl dcsp dcsp dcsp vouches received profile vouches received count dcnl dcsp dcsp dcsp profile can vouch vouches received settings can vouch threshold dcnl dcsp dcsp dcsp profile is vouched vouches received 0 dcnl dcsp dcsp dcsp profile save dcnl dcsp update vouch flags short description update dcsp vouch dcsp flags dcnl dcsp return update vouch flags
def get autocomplete location query qs q dcsp startswith qs qs filter name istartswith q dcnl dcsp if startswith qs exists dcnl dcsp dcsp return startswith qs dcnl dcsp return qs filter name icontains q
receiver signals post save sender externalaccount dispatch uid add employee vouch sig dcnl def add employee vouch sender instance kwargs dcsp if kwargs get raw or not instance type externalaccount type email dcnl dcsp dcsp return dcnl dcsp instance user auto vouch
periodic task run every timedelta hours 1 dcnl def celery healthcheck dcsp response requests get settings healthchecks io url dcnl dcsp return response status code requests codes ok
task soft time limit admin export timeout dcnl def async data export file format values list qs model filename dcsp from django contrib import admin dcnl dcsp admin obj admin site registryqs model dcnl dcsp queryset qs model objects filter id in values list dcnl dcsp resource class admin obj get export resource class dcnl dcsp data resource class export queryset dcnl dcsp export data file format export data data dcnl dcsp kwargs aws access key id settings aws access key id aws secret access key settings aws secret access key calling format ordinarycallingformat dcnl dcsp conn boto connect s3 kwargs dcnl dcsp bucket conn get bucket settings mozillians admin bucket dcnl dcsp key bucket new key filename dcnl dcsp key set contents from string export data
def absolutify url dcsp site url getattr settings site url false dcnl dcsp if not site url dcnl dcsp dcsp protocol settings protocol dcnl dcsp dcsp hostname settings domain dcnl dcsp dcsp port settings port dcnl dcsp dcsp if protocol port in https 443 http 80 dcnl dcsp dcsp dcsp site url join map str protocol hostname dcnl dcsp dcsp else dcnl dcsp dcsp dcsp site url join map str protocol hostname port dcnl dcsp return site url + url
def akismet spam check user ip user agent optional dcsp akismet api key getattr settings akismet api key dcnl dcsp akismet check enabled waffle switch is active akismet check enabled dcnl dcsp if not akismet api key or not akismet check enabled dcnl dcsp dcsp return none dcnl dcsp akismet url https 0 rest akismet com 1 1 commentcheck format akismet api key dcnl dcsp parameters blog settings site url user ip user ip user agent user agent dcnl dcsp parameters update optional dcnl dcsp response requests post akismet url data parameters dcnl dcsp response raise for status dcnl dcsp try dcnl dcsp dcsp return true true false false response text dcnl dcsp except keyerror dcnl dcsp dcsp error response headers get xakismetdebughelp dcnl dcsp dcsp raise exception akismet dcsp raised dcsp an dcsp error dcsp 0 format error
def urlencode items dcsp try dcnl dcsp dcsp return urllib urlencode items dcnl dcsp except unicodeencodeerror dcnl dcsp dcsp return urllib urlencode k smart str v for k v in items
library filter dcnl def urlparams url hash none query dcsp url urlparse urlparse url dcnl dcsp fragment hash if hash is not none else url fragment dcnl dcsp q url query dcnl dcsp query dict dict urlparse parse qsl smart str q if q else dcnl dcsp query dict update k v for k v in query items dcnl dcsp query string urlencode k v for k v in query dict items if v is not none dcnl dcsp new urlparse parseresult url scheme url netloc url path url params query string fragment dcnl dcsp return new geturl
def gravatar email default avatar url settings default avatar url size 175 rating pg dcsp url gravatar url format emaildigest md5 email hexdigest dcnl dcsp url urlparams url d default avatar url s size r rating dcnl dcsp return url
library global function dcnl def field with attrs bfield kwargs dcsp if kwargs get label none dcnl dcsp dcsp bfield label kwargs label dcnl dcsp bfield field widget attrs update kwargs dcnl dcsp return bfield
library global function dcnl def mozillians field element required false dcsp template get template includes field html dcnl dcsp context field element flag required required dcnl dcsp return mark safe template render context
library global function dcnl def mozillians form element dcsp template get template includes form html dcnl dcsp context form element dcnl dcsp return mark safe template render context
library global function dcnl def thumbnail img geometry kwargs dcsp return get thumbnail img geometry kwargs
def redirect to args kwargs dcsp url reverse to args args kwargs kwargs dcnl dcsp return httpresponseredirect url
library global function dcnl contextfunction dcnl def display context context include callables false dcsp if not settings debug dcnl dcsp dcsp return dcnl dcsp keys sorted context keys dcnl dcsp parts <dt key < dt <dd value < dd format key key value repr contextkey for key in keys if include callables or not callable contextkey dcnl dcsp html <dl dcsp class jinjacontext parts < dl format parts join parts dcnl dcsp return markup html
library global function dcnl contextfunction dcnl def get context context dcsp if not settings debug dcnl dcsp dcsp return dcnl dcsp return context
library global function dcnl def is callable thing dcsp return callable thing
def aware utcnow dcsp return datetime utcnow replace tzinfo utc
library global function dcnl def now in timezone timezone name dcsp zone timezone timezone name dcnl dcsp return zone normalize aware utcnow astimezone zone
def offset of timezone timezone name dcsp now now in timezone timezone name dcnl dcsp offset now tzinfo utcoffset now dcnl dcsp minutes offset seconds 60 + offset days 24 60 dcnl dcsp return minutes
def get datetime days 0 weeks 0 dcsp return datetime today + timedelta days days weeks weeks
def get object or none model class kwargs dcsp try dcnl dcsp dcsp return model class objects get kwargs dcnl dcsp except model class doesnotexist dcnl dcsp dcsp return none
library global function dcnl def url viewname args kwargs dcsp return reverse viewname args args kwargs kwargs
library global function dcnl def nonprefixed url viewname args kwargs dcsp return django reverse viewname args kwargs
library global function dcnl def get privacy level request dcsp try dcnl dcsp dcsp profile request user userprofile dcnl dcsp except attributeerror dcnl dcsp dcsp privacy level public dcnl dcsp else dcnl dcsp dcsp privacy level profile privacy level dcnl dcsp return privacy level
library global function dcnl def get privacy aware photo url profile privacy level geometry kwargs dcsp if profile privacy photo privacy level dcnl dcsp dcsp if not profile photo dcnl dcsp dcsp dcsp return gravatar profile user email size geometry dcnl dcsp dcsp return profile get photo thumbnail geometry kwargs url dcnl dcsp profile photo dcnl dcsp return profile get photo thumbnail geometry kwargs url
library filter dcnl def ifeq a b text dcsp return markup text if a b else
library filter dcnl def f s args kwargs dcsp s six text type s dcnl dcsp return s format args kwargs
def canonical path request dcsp lang getattr request locale settings language code dcnl dcsp url getattr request path dcnl dcsp return canonical path re sub ^ + lang url
def set url prefix prefix dcsp local prefix prefix
def get url prefix dcsp return getattr local prefix none
def reverse viewname urlconf none args none kwargs none prefix none dcsp prefixer get url prefix dcnl dcsp if prefixer dcnl dcsp dcsp prefix prefix or dcnl dcsp url django reverse viewname urlconf args kwargs prefix dcnl dcsp if prefixer dcnl dcsp dcsp url prefixer fix url dcnl dcsp return iri to uri url
def split path path dcsp path path lstrip dcnl dcsp first rest path partition dcnl dcsp lang first lower dcnl dcsp if lang in settings language url map dcnl dcsp dcsp return settings language url maplang rest dcnl dcsp else dcnl dcsp dcsp supported find supported first dcnl dcsp dcsp if len supported dcnl dcsp dcsp dcsp return supported0 rest dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return path
def set attribute func function attribute value dcsp orig func function dcnl dcsp while isinstance orig func partial dcnl dcsp dcsp orig func orig func func dcnl dcsp setattr orig func attribute value
def allow public function dcsp set attribute func function allow public true dcnl dcsp return function
def allow unvouched function dcsp set attribute func function allow unvouched true dcnl dcsp return function
def calculate username email dcsp email email split 0 dcnl dcsp username re sub ^ w + email dcnl dcsp username username settings username max length dcnl dcsp suggested username username dcnl dcsp count 0 dcnl dcsp while user objects filter username suggested username exists dcnl dcsp dcsp count + 1 dcnl dcsp dcsp suggested username s d username count dcnl dcsp dcsp if len suggested username settings username max length dcnl dcsp dcsp dcsp return base64 urlsafe b64encode hashlib sha1 email digest rstrip dcnl dcsp return suggested username
contextmanager dcnl def safe query string request dcsp qs request meta query string dcnl dcsp try dcnl dcsp dcsp request meta query string iri to uri qs dcnl dcsp dcsp yield dcnl dcsp finally dcnl dcsp dcsp request meta query string qs
allow public dcnl def contribute view request dcsp return serve request contribute json document root settings root
def error page request template status none dcsp return render request d html template status status or template
library global function dcnl def langcode to name code locale none dcsp if not locale dcnl dcsp dcsp locale get language dcnl dcsp translated languages get languages for locale locale dcnl dcsp try dcnl dcsp dcsp lang dict translated languages code dcnl dcsp except keyerror dcnl dcsp dcsp return code dcnl dcsp return lang
library filter dcnl def simple urlize value dcsp validate url urlvalidator dcnl dcsp try dcnl dcsp dcsp validate url value dcnl dcsp except validationerror dcnl dcsp dcsp return value dcnl dcsp return jinja2 markup <a dcsp href s s< a value value
library global function dcnl def get search models models dcsp params dcnl dcsp for model in models dcnl dcsp dcsp params + models format model dcnl dcsp return params
def get privacy fields privacy level dcsp data dcnl dcsp for field in userprofileprivacymodel meta fields dcnl dcsp dcsp datafield name privacy level dcnl dcsp data privacy tshirt privileged dcnl dcsp return data
waffle flag testingautovouchviews dcnl allow unvouched dcnl never cache dcnl def vouch request username dcsp profile get object or 404 userprofile user username username dcnl dcsp now timezone now dcnl dcsp description automatically dcsp vouched dcsp for dcsp testing dcsp purposes dcsp on dcsp 0 format now dcnl dcsp vouch profile vouch none description description autovouch true dcnl dcsp if vouch dcnl dcsp dcsp messages success request successfully dcsp vouched dcsp user dcnl dcsp else dcnl dcsp dcsp msg user dcsp not dcsp vouched dcsp maybe dcsp there dcsp are dcsp 0 dcsp vouches dcsp already dcnl dcsp dcsp msg msg format settings vouch count limit dcnl dcsp dcsp messages error request msg dcnl dcsp return redirect phonebook profile view profile user username
waffle flag testingautovouchviews dcnl allow unvouched dcnl never cache dcnl def unvouch request username dcsp profile get object or 404 userprofile user username username dcnl dcsp profile vouches received all delete dcnl dcsp messages success request successfully dcsp unvouched dcsp user dcnl dcsp return redirect phonebook profile view profile user username
allow public dcnl never cache dcnl def view profile request username dcsp data dcnl dcsp privacy mappings anonymous public mozillian mozillians employee employees privileged privileged myself none dcnl dcsp privacy level none dcnl dcsp abuse form none dcnl dcsp if request user is authenticated and request user username username dcnl dcsp dcsp view as request get get view as myself dcnl dcsp dcsp privacy level privacy mappings get view as none dcnl dcsp dcsp profile userprofile objects privacy level privacy level get user username username dcnl dcsp dcsp data privacy mode view as dcnl dcsp else dcnl dcsp dcsp userprofile query userprofile objects filter user username username dcnl dcsp dcsp public profile exists userprofile query public exists dcnl dcsp dcsp profile exists userprofile query exists dcnl dcsp dcsp profile complete userprofile query exclude full name exists dcnl dcsp dcsp if not public profile exists dcnl dcsp dcsp dcsp if not request user is authenticated dcnl dcsp dcsp dcsp dcsp messages warning request login message dcnl dcsp dcsp dcsp dcsp return login required view profile login url reverse phonebook home request username dcnl dcsp dcsp dcsp if not request user userprofile is vouched dcnl dcsp dcsp dcsp dcsp messages error request get vouched message dcnl dcsp dcsp dcsp dcsp return redirect phonebook home dcnl dcsp dcsp if not profile exists or not profile complete dcnl dcsp dcsp dcsp raise http404 dcnl dcsp dcsp profile userprofile objects get user username username dcnl dcsp dcsp profile set instance privacy level public dcnl dcsp dcsp if request user is authenticated dcnl dcsp dcsp dcsp profile set instance privacy level request user userprofile privacy level dcnl dcsp dcsp if request user is authenticated and request user userprofile is vouched and not profile can vouch dcnl dcsp dcsp dcsp abuse report get object or none abusereport reporter request user userprofile profile profile dcnl dcsp dcsp dcsp if not abuse report dcnl dcsp dcsp dcsp dcsp abuse report abusereport reporter request user userprofile profile profile dcnl dcsp dcsp dcsp abuse form forms abusereportform request post or none instance abuse report dcnl dcsp dcsp dcsp if abuse form is valid dcnl dcsp dcsp dcsp dcsp abuse form save dcnl dcsp dcsp dcsp dcsp msg u thanks dcsp for dcsp helping dcsp us dcsp improve dcsp mozillians org dcnl dcsp dcsp dcsp dcsp messages info request msg dcnl dcsp dcsp dcsp dcsp return redirect phonebook profile view profile user username dcnl dcsp dcsp if request user is authenticated and profile is vouchable request user userprofile dcnl dcsp dcsp dcsp vouch form forms vouchform request post or none dcnl dcsp dcsp dcsp data vouch form vouch form dcnl dcsp dcsp dcsp if vouch form is valid dcnl dcsp dcsp dcsp dcsp profile userprofile objects get user username username dcnl dcsp dcsp dcsp dcsp profile vouch request user userprofile vouch form cleaned data description dcnl dcsp dcsp dcsp dcsp msg u thanks dcsp for dcsp vouching dcsp for dcsp a dcsp fellow dcsp mozillian dcsp this dcsp user dcsp is dcsp now dcsp vouched dcnl dcsp dcsp dcsp dcsp messages info request msg dcnl dcsp dcsp dcsp dcsp return redirect phonebook profile view profile user username dcnl dcsp data shown user profile user dcnl dcsp data profile profile dcnl dcsp data groups profile get annotated groups dcnl dcsp data abuse form abuse form dcnl dcsp if not request user is authenticated and request user username username or request user is superuser dcnl dcsp dcsp data groups grp for grp in data groups if not grp pending or grp pending terms dcnl dcsp return render request phonebook profile html data
allow unvouched dcnl never cache dcnl def edit profile request dcsp user user objects get pk request user id dcnl dcsp profile user userprofile dcnl dcsp user groups profile groups all order by name dcnl dcsp emails externalaccount objects filter type externalaccount type email dcnl dcsp accounts qs externalaccount objects exclude type externalaccount type email dcnl dcsp sections registration section user form registration form basic section user form basic information form groups section groups privacy form skills section skills form email section email privacy form alternate email formset languages section language privacy form language formset accounts section accounts formset location section location form irc section irc form contribution section contribution form tshirt section tshirt form dcnl dcsp curr sect next s for s in sections keys if s in request post none dcnl dcsp def get request data form dcnl dcsp dcsp if curr sect and form in sectionscurr sect dcnl dcsp dcsp dcsp return request post dcnl dcsp dcsp return none dcnl dcsp ctx dcnl dcsp ctx user form forms userform get request data user form instance user dcnl dcsp ctx registration form forms registerform get request data registration form request files or none instance profile dcnl dcsp basic information data get request data basic information form dcnl dcsp ctx basic information form forms basicinformationform basic information data request files or none instance profile dcnl dcsp ctx accounts formset forms accountsformset get request data accounts formset instance profile queryset accounts qs dcnl dcsp ctx location form forms locationform get request data location form instance profile dcnl dcsp ctx language formset forms languagesformset get request data language formset instance profile locale request locale dcnl dcsp language privacy data get request data language privacy form dcnl dcsp ctx language privacy form forms languagesprivacyform language privacy data instance profile dcnl dcsp ctx skills form forms skillsform get request data skills form instance profile dcnl dcsp ctx contribution form forms contributionform get request data contribution form instance profile dcnl dcsp ctx tshirt form forms tshirtform get request data tshirt form instance profile dcnl dcsp ctx groups privacy form forms groupsprivacyform get request data groups privacy form instance profile dcnl dcsp ctx irc form forms ircform get request data irc form instance profile dcnl dcsp ctx email privacy form forms emailprivacyform get request data email privacy form instance profile dcnl dcsp alternate email formset data get request data alternate email formset dcnl dcsp ctx alternate email formset forms alternateemailformset alternate email formset data instance profile queryset emails dcnl dcsp ctx autocomplete form media ctx registration form media + ctx skills form media dcnl dcsp forms valid true dcnl dcsp if request post dcnl dcsp dcsp if not curr sect dcnl dcsp dcsp dcsp raise http404 dcnl dcsp dcsp curr forms map lambda x ctxx sectionscurr sect dcnl dcsp dcsp forms valid all map lambda x x is valid curr forms dcnl dcsp dcsp if forms valid dcnl dcsp dcsp dcsp old username request user username dcnl dcsp dcsp dcsp for f in curr forms dcnl dcsp dcsp dcsp dcsp f save dcnl dcsp dcsp dcsp if not profile can vouch dcnl dcsp dcsp dcsp dcsp params instance id profile id user ip request meta get remote addr user agent request meta get http user agent referrer request meta get http referer comment author profile full name comment author email profile email comment content profile bio dcnl dcsp dcsp dcsp dcsp check spam account delay params dcnl dcsp dcsp dcsp next section request get get next dcnl dcsp dcsp dcsp next url urlparams reverse phonebook profile edit next section dcnl dcsp dcsp dcsp if curr sect registration section dcnl dcsp dcsp dcsp dcsp settings url reverse phonebook profile edit dcnl dcsp dcsp dcsp dcsp settings link <a dcsp href 0 settings< a format settings url dcnl dcsp dcsp dcsp dcsp msg u your dcsp registration dcsp is dcsp complete dcsp feel dcsp free dcsp to dcsp visit dcsp the dcsp 0 dcsp page dcsp to dcsp add dcsp additional dcsp information dcsp to dcsp your dcsp profile format settings link dcnl dcsp dcsp dcsp dcsp messages info request mark safe msg dcnl dcsp dcsp dcsp dcsp redeem invite profile request session get invitecode dcnl dcsp dcsp dcsp dcsp next url reverse phonebook profile view args user username dcnl dcsp dcsp dcsp elif user username old username dcnl dcsp dcsp dcsp dcsp msg u you dcsp changed dcsp your dcsp username dcsp please dcsp note dcsp your dcsp profile dcsp url dcsp has dcsp also dcsp changed dcnl dcsp dcsp dcsp dcsp messages info request msg dcnl dcsp dcsp dcsp return httpresponseredirect next url dcnl dcsp ctx update user groups user groups profile request user userprofile vouch threshold settings can vouch threshold appsv2 profile apps filter enabled true forms valid forms valid dcnl dcsp return render request phonebook edit profile html ctx
allow unvouched dcnl never cache dcnl def delete email request email pk dcsp user user objects get pk request user id dcnl dcsp profile user userprofile dcnl dcsp if not externalaccount objects filter user profile pk email pk exists dcnl dcsp dcsp raise http404 dcnl dcsp externalaccount objects get pk email pk delete dcnl dcsp return redirect phonebook profile edit
allow unvouched dcnl never cache dcnl def change primary email request email pk dcsp user user objects get pk request user id dcnl dcsp profile user userprofile dcnl dcsp alternate emails externalaccount objects filter user profile type externalaccount type email dcnl dcsp if not alternate emails filter pk email pk exists dcnl dcsp dcsp raise http404 dcnl dcsp alternate email alternate emails get pk email pk dcnl dcsp primary email user email dcnl dcsp user email alternate email identifier dcnl dcsp alternate email identifier primary email dcnl dcsp with transaction atomic dcnl dcsp dcsp user save dcnl dcsp dcsp alternate email save dcnl dcsp update email in basket delay primary email user email dcnl dcsp return redirect phonebook profile edit
allow unvouched dcnl never cache dcnl def confirm delete request dcsp return render request phonebook confirm delete html
allow public dcnl cache control public true must revalidate true max age 3600 24 7 dcnl def search plugin request dcsp return render request phonebook search opensearch xml content type application opensearchdescription+xml
allow unvouched dcnl def logout request dcsp auth logout request dcnl dcsp return redirect phonebook home
allow public dcnl def register request dcsp if code in request get dcnl dcsp dcsp request session invitecode request get code dcnl dcsp dcsp if request user is authenticated dcnl dcsp dcsp dcsp if not request user userprofile is vouched dcnl dcsp dcsp dcsp dcsp redeem invite request user userprofile request session invitecode dcnl dcsp dcsp else dcnl dcsp dcsp dcsp messages info request you ve dcsp been dcsp invited dcsp to dcsp join dcsp mozillians org dcsp sign dcsp in dcsp and dcsp then dcsp you dcsp can dcsp create dcsp a dcsp profile dcnl dcsp return redirect phonebook home
def validate twitter username dcsp if username dcnl dcsp dcsp username re sub https www twitter com | username dcnl dcsp dcsp if len username 15 dcnl dcsp dcsp dcsp raise validationerror twitter dcsp usernames dcsp cannot dcsp be dcsp longer dcsp than dcsp 15 dcsp characters dcnl dcsp dcsp if not re match ^ w+ username dcnl dcsp dcsp dcsp raise validationerror twitter dcsp usernames dcsp must dcsp contain dcsp only dcsp alphanumeric dcsp characters dcsp and dcsp the dcsp underscore dcnl dcsp return username
def validate linkedin url dcsp if view id not in url dcnl dcsp dcsp nick url rsplit 1 1 dcnl dcsp dcsp return nick dcnl dcsp return url
def validate username username dcsp username username lower dcnl dcsp usernameblacklist get model users usernameblacklist dcnl dcsp if usernameblacklist objects filter value username is regex false exists dcnl dcsp dcsp return false dcnl dcsp for regex value in usernameblacklist objects filter is regex true dcnl dcsp dcsp if re match regex value value username dcnl dcsp dcsp dcsp return false dcnl dcsp return true
def validate website url dcsp validate url urlvalidator dcnl dcsp if url and not in url dcnl dcsp dcsp url u http s url dcnl dcsp try dcnl dcsp dcsp validate url url dcnl dcsp except validationerror dcnl dcsp dcsp raise validationerror enter dcsp a dcsp valid dcsp url dcnl dcsp return url
def validate username not url username dcsp if username startswith http or username startswith https dcnl dcsp dcsp raise validationerror this dcsp field dcsp requires dcsp an dcsp identifier dcsp not dcsp a dcsp url dcnl dcsp return username
def validate email value dcsp validate email emailvalidator dcnl dcsp try dcnl dcsp dcsp validate email value dcnl dcsp except validationerror dcnl dcsp dcsp raise validationerror enter dcsp a dcsp valid dcsp email dcsp address dcnl dcsp return value
def validate phone number value dcsp value value replace dcsp dcnl dcsp value re sub ^00 + value dcnl dcsp pattern re compile ^ + d 5 15 dcnl dcsp if not pattern match value dcnl dcsp dcsp raise validationerror please dcsp enter dcsp a dcsp valid dcsp phone dcsp number dcsp in dcsp international dcsp format dcsp e g dcsp +1 dcsp 555 dcsp 555 dcsp 5555 dcnl dcsp return value
library global function dcnl def latest announcement dcsp if announcement objects published count dcnl dcsp dcsp return announcement objects published latest dcnl dcsp return none
def calculate image filename instance filename dcsp return os path join settings announcements photo dir str uuid uuid4 + jpg
task ignore result true dcnl def remove empty groups dcsp from mozillians groups models import group skill dcnl dcsp for model in group skill dcnl dcsp dcsp model objects annotate mcount count members filter mcount 0 delete
task ignore result true dcnl def send pending membership emails dcsp from mozillians groups models import group groupmembership dcnl dcsp groups group objects exclude curators isnull true exclude accepting new members group closed dcnl dcsp groups groups filter groupmembership status groupmembership pending distinct dcnl dcsp for group in groups dcnl dcsp dcsp pending memberships group groupmembership set filter status groupmembership pending dcnl dcsp dcsp max pk pending memberships aggregate max pk max pk max pk dcnl dcsp dcsp curators group curators all dcnl dcsp dcsp if max pk group max reminder and curators dcnl dcsp dcsp dcsp activate enus dcnl dcsp dcsp dcsp count pending memberships count dcnl dcsp dcsp dcsp subject ungettext count d dcsp outstanding dcsp request dcsp to dcsp join dcsp mozillians dcsp group dcsp name s count d dcsp outstanding dcsp requests dcsp to dcsp join dcsp mozillians dcsp group dcsp name s count count count name group name dcnl dcsp dcsp dcsp body render to string groups email memberships pending txt group group count count dcnl dcsp dcsp dcsp send mail subject body settings from noreply profile user email for profile in curators fail silently false dcnl dcsp dcsp dcsp group max reminder max pk dcnl dcsp dcsp dcsp group save
task ignore result true dcnl def email membership change group pk user pk old status new status dcsp from mozillians groups models import group groupmembership dcnl dcsp group group objects get pk group pk dcnl dcsp user user objects get pk user pk dcnl dcsp activate enus dcnl dcsp if old status in groupmembership pending groupmembership pending terms dcnl dcsp dcsp if new status groupmembership member dcnl dcsp dcsp dcsp subject accepted dcsp to dcsp mozillians dcsp group dcsp s group name dcnl dcsp dcsp dcsp template name groups email accepted txt dcnl dcsp dcsp elif new status is none dcnl dcsp dcsp dcsp subject not dcsp accepted dcsp to dcsp mozillians dcsp group dcsp s group name dcnl dcsp dcsp dcsp template name groups email rejected txt dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise valueerror bad dcsp args dcsp to dcsp email membership change dcnl dcsp elif new status in groupmembership pending terms groupmembership pending dcnl dcsp dcsp subject status dcsp changed dcsp for dcsp mozillians dcsp group dcsp s group name dcnl dcsp dcsp template name groups email membership status changed txt dcnl dcsp else dcnl dcsp dcsp subject removed dcsp from dcsp mozillians dcsp group dcsp s group name dcnl dcsp dcsp template name groups email member removed txt dcnl dcsp context group group user user dcnl dcsp template get template template name dcnl dcsp body template render context dcnl dcsp send mail subject body settings from noreply user email fail silently false
periodic task run every timedelta hours 24 dcnl def invalidate group membership dcsp from mozillians groups models import group groupmembership dcnl dcsp groups group objects filter invalidation days isnull false dcnl dcsp for group in groups dcnl dcsp dcsp curator ids group curators all values list id flat true dcnl dcsp dcsp last update now timedelta days group invalidation days dcnl dcsp dcsp memberships group groupmembership set filter updated on lte last update exclude userprofile id in curator ids dcnl dcsp dcsp for member in memberships dcnl dcsp dcsp dcsp status none dcnl dcsp dcsp dcsp if group accepting new members group open dcnl dcsp dcsp dcsp dcsp status groupmembership pending dcnl dcsp dcsp dcsp group remove member member userprofile status status
periodic task run every timedelta hours 24 dcnl def notify membership renewal dcsp from mozillians groups models import group groupmembership invite dcnl dcsp groups group objects filter invalidation days isnull false invalidation days gte days before invalidation exclude accepting new members group open distinct dcnl dcsp for group in groups dcnl dcsp dcsp curator ids group curators all values list id flat true dcnl dcsp dcsp memberships group groupmembership set filter status groupmembership member exclude userprofile id in curator ids dcnl dcsp dcsp if not switch is active test membership renewal notification dcnl dcsp dcsp dcsp last update days group invalidation days days before invalidation dcnl dcsp dcsp dcsp last update now timedelta days last update days dcnl dcsp dcsp dcsp query start datetime combine last update date datetime min time dcnl dcsp dcsp dcsp query end datetime combine last update date datetime max time dcnl dcsp dcsp dcsp query updated on range query start query end needs renewal false dcnl dcsp dcsp dcsp memberships memberships filter query dcnl dcsp dcsp member template get template groups email notify member renewal txt dcnl dcsp dcsp curator template get template groups email notify curator renewal txt dcnl dcsp dcsp for membership in memberships dcnl dcsp dcsp dcsp ctx member full name membership userprofile full name group name membership group name group url membership group get absolute url member profile url membership userprofile get absolute url inviter none dcnl dcsp dcsp dcsp invite get object or none invite group group redeemer membership userprofile dcnl dcsp dcsp dcsp if invite dcnl dcsp dcsp dcsp dcsp ctx inviter invite inviter dcnl dcsp dcsp dcsp subject msg unicode mozillians dcsp your dcsp membership dcsp to dcsp mozilla dcsp group dcsp 0 dcsp is dcsp about dcsp to dcsp expire dcnl dcsp dcsp dcsp subject subject msg format membership group name dcnl dcsp dcsp dcsp message member template render ctx dcnl dcsp dcsp dcsp send mail subject message settings from noreply membership userprofile email dcnl dcsp dcsp dcsp subject msg unicode mozillians 0 dcsp membership dcsp of dcsp 1 dcsp is dcsp about dcsp to dcsp expire dcnl dcsp dcsp dcsp format args membership group name membership userprofile full name dcnl dcsp dcsp dcsp subject subject msg format format args dcnl dcsp dcsp dcsp curators group curators all dcnl dcsp dcsp dcsp inviter ctx inviter dcnl dcsp dcsp dcsp if inviter and curators filter pk inviter id exists dcnl dcsp dcsp dcsp dcsp curators inviter dcnl dcsp dcsp dcsp for curator in curators dcnl dcsp dcsp dcsp dcsp ctx curator full name curator full name dcnl dcsp dcsp dcsp dcsp message curator template render ctx dcnl dcsp dcsp dcsp dcsp send mail subject message settings from noreply curator email dcnl dcsp dcsp memberships update needs renewal true
library global function dcnl def stringify groups groups dcsp return u join group name for group in groups
def slugify s dcsp if isinstance s str dcnl dcsp dcsp s unicode s dcnl dcsp return django slugify unidecode s
library global function dcnl def user is curator group userprofile dcsp return group curators filter id userprofile id exists
library global function dcnl def is group instance obj dcsp from mozillians groups models import group dcnl dcsp return isinstance obj group
def forward migrate group curators apps schema editor dcsp group apps get model u groups u group dcnl dcsp for group in group objects all dcnl dcsp dcsp if group curator dcnl dcsp dcsp dcsp group curators add group curator dcnl dcsp dcsp dcsp group save
def backward migrate group curators apps schema editor dcsp pass
def list groups request template query context dcsp sort form forms sortform request get dcnl dcsp show pagination false dcnl dcsp if sort form is valid dcnl dcsp dcsp query query order by sort form cleaned data sort name dcnl dcsp else dcnl dcsp dcsp query query order by name dcnl dcsp paginator paginator query settings items per page dcnl dcsp page request get get page 1 dcnl dcsp try dcnl dcsp dcsp groups paginator page page dcnl dcsp except pagenotaninteger dcnl dcsp dcsp groups paginator page 1 dcnl dcsp except emptypage dcnl dcsp dcsp groups paginator page paginator num pages dcnl dcsp if paginator count settings items per page dcnl dcsp dcsp show pagination true dcnl dcsp data groups groups page page sort form sort form show pagination show pagination dcnl dcsp data update context dcnl dcsp return render request template data
def index groups request dcsp group form forms groupcreateform request post or none dcnl dcsp if group form is valid dcnl dcsp dcsp group group form save dcnl dcsp dcsp group curators add request user userprofile dcnl dcsp dcsp group add member request user userprofile groupmembership member dcnl dcsp dcsp return redirect reverse groups group edit args group url dcnl dcsp query group get non functional areas dcnl dcsp template groups index groups html dcnl dcsp context group form group form dcnl dcsp return list groups request template query context
def index skills request dcsp query skill objects filter members is vouched true dcnl dcsp template groups index skills html dcnl dcsp return list groups request template query
def index functional areas request dcsp query group get functional areas dcnl dcsp template groups index areas html dcnl dcsp return list groups request template query
allow unvouched dcnl cache control must revalidate true max age 3600 dcnl def search request searched object group dcsp term request get get term none dcnl dcsp if request is ajax and term dcnl dcsp dcsp groups searched object search term values list name flat true dcnl dcsp dcsp return http httpresponse json dumps list groups content type application json dcnl dcsp return http httpresponsebadrequest
never cache dcnl def show request url alias model template dcsp group alias get object or 404 alias model url url dcnl dcsp if group alias alias url url dcnl dcsp dcsp return redirect groups show group url group alias alias url dcnl dcsp is curator false dcnl dcsp is manager request user userprofile is manager dcnl dcsp is pending false dcnl dcsp show delete group button false dcnl dcsp membership filter form forms membershipfilterform request get dcnl dcsp group group alias alias dcnl dcsp profile request user userprofile dcnl dcsp in group group has member profile dcnl dcsp memberships group members all dcnl dcsp data dcnl dcsp if isinstance group group dcnl dcsp dcsp if group terms dcnl dcsp dcsp dcsp membership get object or none groupmembership group group userprofile profile status groupmembership pending terms dcnl dcsp dcsp dcsp if membership dcnl dcsp dcsp dcsp dcsp return redirect reverse groups review terms args group url dcnl dcsp dcsp is pending group has pending member profile dcnl dcsp dcsp is curator is manager or request user userprofile in group curators all dcnl dcsp dcsp if is curator and group accepting new members group reviewed or group accepting new members group closed dcnl dcsp dcsp dcsp membership filter form forms membershipfilterform request get dcnl dcsp dcsp else dcnl dcsp dcsp dcsp membership filter form none dcnl dcsp dcsp if is curator dcnl dcsp dcsp dcsp statuses groupmembership member groupmembership pending groupmembership pending terms dcnl dcsp dcsp dcsp q args status in statuses dcnl dcsp dcsp dcsp if membership filter form and membership filter form is valid dcnl dcsp dcsp dcsp dcsp filtr membership filter form cleaned data filtr dcnl dcsp dcsp dcsp dcsp if filtr members dcnl dcsp dcsp dcsp dcsp dcsp statuses groupmembership member dcnl dcsp dcsp dcsp dcsp elif filtr pending members dcnl dcsp dcsp dcsp dcsp dcsp statuses groupmembership pending dcnl dcsp dcsp dcsp dcsp elif filtr pending terms dcnl dcsp dcsp dcsp dcsp dcsp statuses groupmembership pending terms dcnl dcsp dcsp dcsp dcsp q args update status in statuses dcnl dcsp dcsp dcsp dcsp if filtr needs renewal dcnl dcsp dcsp dcsp dcsp dcsp q args needs renewal true dcnl dcsp dcsp dcsp memberships group groupmembership set filter q args dcnl dcsp dcsp dcsp show delete group button is curator and group members all count 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp memberships group groupmembership set filter q status groupmembership member | q userprofile profile dcnl dcsp dcsp invitation get object or none invite redeemer profile group group accepted false dcnl dcsp dcsp data update invitation invitation dcnl dcsp dcsp memberships memberships order by userprofile dcnl dcsp dcsp shared skill ids group members filter groupmembership status groupmembership member values list skills flat true dcnl dcsp dcsp count skills defaultdict int dcnl dcsp dcsp for skill id in shared skill ids dcnl dcsp dcsp dcsp count skillsskill id + 1 dcnl dcsp dcsp common skills ids k for k in sorted count skills items key lambda x x1 reverse true if count skillsk 1 dcnl dcsp dcsp skills skill objects get id skill id for skill id in common skills ids if skill id dcnl dcsp dcsp data update skills skills membership filter form membership filter form dcnl dcsp page request get get page 1 dcnl dcsp paginator paginator memberships settings items per page dcnl dcsp try dcnl dcsp dcsp people paginator page page dcnl dcsp except pagenotaninteger dcnl dcsp dcsp people paginator page 1 dcnl dcsp except emptypage dcnl dcsp dcsp people paginator page paginator num pages dcnl dcsp show pagination paginator count settings items per page dcnl dcsp extra data dict people people group group in group in group is curator is curator is pending is pending show pagination show pagination show delete group button show delete group button show join button group user can join request user userprofile show leave button group user can leave request user userprofile members group member count dcnl dcsp data update extra data dcnl dcsp return render request template data
require post dcnl def confirm member request url user pk dcsp group get object or 404 group url url dcnl dcsp profile get object or 404 userprofile pk user pk dcnl dcsp is curator request user userprofile in group curators all dcnl dcsp is manager request user userprofile is manager dcnl dcsp group url reverse groups show group args group url dcnl dcsp next url request request get next url group url dcnl dcsp if not is curator or is manager dcnl dcsp dcsp raise http http404 dcnl dcsp try dcnl dcsp dcsp membership groupmembership objects get group group userprofile profile dcnl dcsp except groupmembership doesnotexist dcnl dcsp dcsp messages error request this dcsp user dcsp has dcsp not dcsp requested dcsp membership dcsp in dcsp this dcsp group dcnl dcsp else dcnl dcsp dcsp if membership status groupmembership member and not membership needs renewal dcnl dcsp dcsp dcsp messages error request this dcsp user dcsp is dcsp already dcsp a dcsp member dcsp of dcsp this dcsp group dcnl dcsp dcsp else dcnl dcsp dcsp dcsp status groupmembership member dcnl dcsp dcsp dcsp if group terms dcnl dcsp dcsp dcsp dcsp status groupmembership pending terms dcnl dcsp dcsp dcsp group add member profile status status dcnl dcsp dcsp dcsp if membership needs renewal dcnl dcsp dcsp dcsp dcsp messages info request the dcsp membership dcsp of dcsp the dcsp user dcsp has dcsp been dcsp renewed dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp messages info request this dcsp user dcsp has dcsp been dcsp added dcsp as dcsp a dcsp member dcsp of dcsp this dcsp group dcnl dcsp return redirect next url
def review terms request url dcsp group get object or 404 group url url dcnl dcsp if not group terms dcnl dcsp dcsp return redirect reverse groups show group args group url dcnl dcsp membership get object or 404 groupmembership group group userprofile request user userprofile status groupmembership pending terms dcnl dcsp membership form forms termsreviewform request post or none dcnl dcsp if membership form is valid dcnl dcsp dcsp if membership form cleaned data terms accepted true dcnl dcsp dcsp dcsp group add member request user userprofile groupmembership member dcnl dcsp dcsp else dcnl dcsp dcsp dcsp membership delete dcnl dcsp dcsp return redirect reverse groups show group args group url dcnl dcsp ctx group group membership form membership form dcnl dcsp return render request groups terms html ctx
require post dcnl def join group request url dcsp group get object or 404 group url url dcnl dcsp profile to add request user userprofile dcnl dcsp if group has member profile to add dcnl dcsp dcsp messages error request you dcsp are dcsp already dcsp in dcsp this dcsp group dcnl dcsp elif group has pending member profile to add dcnl dcsp dcsp messages error request your dcsp request dcsp to dcsp join dcsp this dcsp group dcsp is dcsp still dcsp pending dcnl dcsp elif group accepting new members group closed dcnl dcsp dcsp messages error request this dcsp group dcsp is dcsp not dcsp accepting dcsp requests dcsp to dcsp join dcnl dcsp else dcnl dcsp dcsp if group accepting new members group open dcnl dcsp dcsp dcsp status groupmembership member dcnl dcsp dcsp dcsp messages info request you dcsp have dcsp been dcsp added dcsp to dcsp this dcsp group dcnl dcsp dcsp dcsp if group terms dcnl dcsp dcsp dcsp dcsp status groupmembership pending terms dcnl dcsp dcsp elif group accepting new members group reviewed dcnl dcsp dcsp dcsp status groupmembership pending dcnl dcsp dcsp dcsp messages info request your dcsp membership dcsp request dcsp has dcsp been dcsp sent dcsp to dcsp the dcsp group dcsp curator s dcnl dcsp dcsp group add member profile to add status status dcnl dcsp return redirect reverse groups show group args group url
require post dcnl def toggle skill subscription request url dcsp skill get object or 404 skill url url dcnl dcsp profile request user userprofile dcnl dcsp if profile skills filter id skill id exists dcnl dcsp dcsp profile skills remove skill dcnl dcsp else dcnl dcsp dcsp profile skills add skill dcnl dcsp return redirect reverse groups show skill args skill url
never cache dcnl def group edit request url none dcsp profile request user userprofile dcnl dcsp is manager request user userprofile is manager dcnl dcsp invites none dcnl dcsp forms valid true dcnl dcsp group forms dcnl dcsp form key none dcnl dcsp show delete group button false dcnl dcsp if not url dcnl dcsp dcsp return redirect reverse groups index groups dcnl dcsp group get object or 404 group url url dcnl dcsp is curator profile in group curators all dcnl dcsp is manager request user userprofile is manager dcnl dcsp if not is curator or is manager dcnl dcsp dcsp messages error request you dcsp must dcsp be dcsp a dcsp curator dcsp or dcsp an dcsp admin dcsp to dcsp edit dcsp a dcsp group dcnl dcsp dcsp return redirect reverse groups show group args group url dcnl dcsp invites group invites filter groups invited accepted false dcnl dcsp show delete group button is curator and group members all count 1 dcnl dcsp group forms basic form forms groupbasicform dcnl dcsp group forms curator form forms groupcuratorsform dcnl dcsp group forms terms expiration form forms grouptermsexpirationform dcnl dcsp group forms invite form forms groupinviteform dcnl dcsp group forms admin form forms groupadminform dcnl dcsp group forms criteria form forms groupcriteriaform dcnl dcsp group forms email form forms groupcustomemailform dcnl dcsp def init group forms request group forms dcnl dcsp dcsp form args data none instance group request request dcnl dcsp dcsp key none dcnl dcsp dcsp if request post dcnl dcsp dcsp dcsp form args data request post dcnl dcsp dcsp dcsp key form next k v form args for k v in group forms items if k in request post none none dcnl dcsp dcsp dcsp if key and form dcnl dcsp dcsp dcsp dcsp group formskey form dcnl dcsp dcsp form args data none dcnl dcsp dcsp for k in group forms keys dcnl dcsp dcsp dcsp if k key dcnl dcsp dcsp dcsp dcsp group formsk group formsk form args dcnl dcsp dcsp return key dcnl dcsp form key init group forms request group forms dcnl dcsp form group formsform key if form key else none dcnl dcsp if form and form is bound and form is valid dcnl dcsp dcsp form save dcnl dcsp dcsp next section request get get next dcnl dcsp dcsp next url urlparams reverse groups group edit args group url next section dcnl dcsp dcsp return http httpresponseredirect next url dcnl dcsp elif request post dcnl dcsp dcsp forms valid false dcnl dcsp context group group if url else none invites invites if group else none forms valid forms valid user is curator is curator user is manager is manager show delete group button show delete group button dcnl dcsp context update group forms dcnl dcsp return render request groups edit group html context
def delete invite request invite pk dcsp invite get object or 404 invite pk invite pk dcnl dcsp group invite group dcnl dcsp if group curators filter id request user userprofile id exists or request user userprofile is manager dcnl dcsp dcsp redeemer invite redeemer dcnl dcsp dcsp invite delete dcnl dcsp dcsp notify redeemer invitation invalid delay redeemer pk group pk dcnl dcsp dcsp msg u the dcsp invitation dcsp to dcsp 0 dcsp has dcsp been dcsp successfully dcsp revoked format redeemer dcnl dcsp dcsp messages success request msg dcnl dcsp dcsp next section request get get next dcnl dcsp dcsp next url urlparams reverse groups group edit args group url next section dcnl dcsp dcsp return http httpresponseredirect next url dcnl dcsp raise http http404
never cache dcnl def accept reject invitation request invite pk action dcsp redeemer request user userprofile dcnl dcsp invite get object or 404 invite pk invite pk redeemer redeemer dcnl dcsp if action accept dcnl dcsp dcsp if invite group terms dcnl dcsp dcsp dcsp invite group add member redeemer groupmembership pending terms dcnl dcsp dcsp else dcnl dcsp dcsp dcsp invite group add member redeemer groupmembership member dcnl dcsp dcsp invite accepted true dcnl dcsp dcsp invite save dcnl dcsp dcsp notify curators invitation accepted delay invite pk dcnl dcsp else dcnl dcsp dcsp notify curators invitation rejected delay redeemer pk invite inviter pk invite group pk dcnl dcsp dcsp invite delete dcnl dcsp return redirect reverse groups show group args invite group url
never cache dcnl def send invitation email request invite pk dcsp invite get object or 404 invite pk invite pk dcnl dcsp is curator invite group curators filter pk request user userprofile pk exists dcnl dcsp is manager request user userprofile is manager dcnl dcsp if not is curator or is manager dcnl dcsp dcsp raise http http404 dcnl dcsp notify redeemer invitation delay invite pk invite group invite email text dcnl dcsp msg u invitation dcsp to dcsp 0 dcsp has dcsp been dcsp sent dcsp successfully format invite redeemer dcnl dcsp messages success request msg dcnl dcsp next section request get get next dcnl dcsp next url urlparams reverse groups group edit args invite group url next section dcnl dcsp return http httpresponseredirect next url
never cache dcnl waffle flag force group invalidation 404 dcnl def force group invalidation request url alias model template dcsp group alias get object or 404 alias model url url dcnl dcsp group group alias alias dcnl dcsp is curator group curators filter id request user userprofile pk exists dcnl dcsp if group invalidation days and is curator dcnl dcsp dcsp curator ids group curators all values list id flat true dcnl dcsp dcsp memberships group groupmembership set exclude userprofile id in curator ids dcnl dcsp dcsp for member in memberships dcnl dcsp dcsp dcsp status none dcnl dcsp dcsp dcsp if group accepting new members group open dcnl dcsp dcsp dcsp dcsp status groupmembership pending dcnl dcsp dcsp dcsp group remove member member userprofile status status dcnl dcsp else dcnl dcsp dcsp raise http http404 dcnl dcsp return redirect reverse groups show group args group url
never cache dcnl waffle switch test membership renewal notification dcnl def membership renewal notification request dcsp notify membership renewal apply async dcnl dcsp return redirect reverse groups index groups
def hashed download url temp digest dcsp def opener dcnl dcsp dcsp opener build opener httpshandler dcnl dcsp dcsp for handler in opener handlers dcnl dcsp dcsp dcsp if isinstance handler httphandler dcnl dcsp dcsp dcsp dcsp opener handlers remove handler dcnl dcsp dcsp return opener dcnl dcsp def read chunks response chunk size dcnl dcsp dcsp while true dcnl dcsp dcsp dcsp chunk response read chunk size dcnl dcsp dcsp dcsp if not chunk dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp dcsp yield chunk dcnl dcsp response opener open url dcnl dcsp path join temp urlparse url path split 1 dcnl dcsp actual hash sha256 dcnl dcsp with open path wb as file dcnl dcsp dcsp for chunk in read chunks response 4096 dcnl dcsp dcsp dcsp file write chunk dcnl dcsp dcsp dcsp actual hash update chunk dcnl dcsp actual digest actual hash hexdigest dcnl dcsp if actual digest digest dcnl dcsp dcsp raise hasherror url path actual digest digest dcnl dcsp return path
task dcnl def update mozillians ctx tag dcsp pre update tag dcnl dcsp update
def extract bugs changelog dcsp bug regexp re compile bbug dcsp d+ b re i dcnl dcsp bugs set dcnl dcsp for line in changelog dcnl dcsp dcsp for bug in bug regexp findall line dcnl dcsp dcsp dcsp bugs add bug dcnl dcsp return sorted list bugs
def generate desc from commit to commit changelog dcsp if from commit startswith to commit dcnl dcsp dcsp desc pushing dcsp 0 dcsp again format to commit dcnl dcsp else dcnl dcsp dcsp bugs extract bugs changelog split n dcnl dcsp dcsp if bugs dcnl dcsp dcsp dcsp bugs bug dcsp 0 format bug for bug in bugs dcnl dcsp dcsp dcsp desc fixing dcsp 0 format dcsp join bugs dcnl dcsp dcsp else dcnl dcsp dcsp dcsp desc get random desc dcnl dcsp return desc
def django to jinja template name context kw dcsp context instance kw pop context instance dcnl dcsp source loader render to string template name context context instance dcnl dcsp request context instance request dcnl dcsp return jingo render request jingo env from string source
def jinja for django template name context none kw dcsp if context is none dcnl dcsp dcsp context dcnl dcsp context instance kw pop context instance dcnl dcsp request context instance request dcnl dcsp for d in context instance dicts dcnl dcsp dcsp context update d dcnl dcsp return jingo render request template name context kw
cronjobs register dcnl def remove expired registration profiles dcsp registrationprofile objects delete expired users dcnl dcsp generate tasks
cronjobs register dcnl def reindex users that contributed yesterday dcsp if settings stage dcnl dcsp dcsp return dcnl dcsp today datetime now dcnl dcsp yesterday today timedelta days 1 dcnl dcsp user ids list answer objects filter created gte yesterday created lt today values list creator id flat true dcnl dcsp user ids + list revision objects filter created gte yesterday created lt today values list creator id flat true dcnl dcsp user ids + list revision objects filter reviewed gte yesterday reviewed lt today values list reviewer id flat true dcnl dcsp index task delay usermappingtype list set user ids
def patch user admin dcsp if not getattr useradmin monkeyed false dcnl dcsp dcsp useradmin monkeyed true dcnl dcsp dcsp useradmin actions activate users deactivate users
def patch user model dcsp def get absolute url self dcnl dcsp dcsp return reverse users profile args self pk dcnl dcsp user get absolute url get absolute url
def handle register request text template none html template none subject none email data none args kwargs dcsp if request method post dcnl dcsp dcsp form registerform request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp form try send email with form registrationprofile objects create inactive user form email form cleaned data username form cleaned data password form cleaned data email locale request language code text template text template html template html template subject subject email data email data volunteer interest form cleaned data interested args kwargs dcnl dcsp dcsp dcsp if not form is valid dcnl dcsp dcsp dcsp dcsp user objects filter email form instance email delete dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp statsd incr user register dcnl dcsp dcsp return form dcnl dcsp return registerform
def try send email with form func form field name args kwargs dcsp try dcnl dcsp dcsp func args kwargs dcnl dcsp except smtpexception as e dcnl dcsp dcsp log warning u failed dcsp to dcsp send dcsp email dcsp s e dcnl dcsp dcsp if email not in form errors dcnl dcsp dcsp dcsp form errorsfield name dcnl dcsp dcsp form errorsfield name append unicode error send email dcnl dcsp return form
library global function dcnl def profile url user edit false dcsp if edit dcnl dcsp dcsp return reverse users edit profile args user username dcnl dcsp return reverse users profile args user username
library global function dcnl def profile avatar user size 48 dcsp try dcnl dcsp dcsp profile profile objects get user id user id dcnl dcsp except profile doesnotexist attributeerror dcnl dcsp dcsp avatar settings static url + settings default avatar dcnl dcsp else dcnl dcsp dcsp avatar profile avatar url if profile and profile avatar else settings static url + settings default avatar dcnl dcsp if avatar startswith dcnl dcsp dcsp avatar https s avatar dcnl dcsp if user and hasattr user email dcnl dcsp dcsp email hash hashlib md5 force str user email lower hexdigest dcnl dcsp else dcnl dcsp dcsp email hash 00000000000000000000000000000000 dcnl dcsp url https secure gravatar com avatar s s s email hash size dcnl dcsp if avatar startswith http dcnl dcsp dcsp url url + d s urllib quote avatar dcnl dcsp return url
library global function dcnl def display name user dcsp try dcnl dcsp dcsp profile profile objects get user id user id dcnl dcsp except profile doesnotexist attributeerror dcnl dcsp dcsp return user username dcnl dcsp return profile display name if profile else user username
library filter dcnl def public email email dcsp return markup <span dcsp class email s< span unicode to html email
def unicode to html text dcsp return join u s ord i for i in text
library global function dcnl def user list users dcsp link u <a dcsp class user dcsp href s s< a dcnl dcsp list u dcsp join link escape profile url u escape u username for u in users dcnl dcsp return markup list
library global function dcnl def private message user dcsp url urlparams reverse messages new to user username dcnl dcsp msg private dcsp message dcnl dcsp return markup u <p dcsp class pm <a dcsp href url msg < a < p format url url msg msg
library global function dcnl def is contributor user dcsp return user is authenticated and user groups filter name registered dcsp as dcsp contributor count 0
def add permission user model permission codename dcsp content type contenttype objects get for model model dcnl dcsp permission created permission objects get or create codename permission codename content type content type defaults name permission codename dcnl dcsp user user permissions add permission
def get auth str user dcsp token default token generator make token user dcnl dcsp auth 0 1 format user username token dcnl dcsp return base64 b64encode auth
login required dcnl require get dcnl json view dcnl def usernames request dcsp term request get get term dcnl dcsp query request get get query dcnl dcsp pre term or query dcnl dcsp if not pre dcnl dcsp dcsp return dcnl dcsp if not request user is authenticated dcnl dcsp dcsp return dcnl dcsp with statsd timer users api usernames search dcnl dcsp dcsp profiles profile objects filter q name istartswith pre values list user id flat true dcnl dcsp dcsp users user objects filter q username istartswith pre | q id in profiles extra select length length username order by length select related profile dcnl dcsp dcsp if not waffle switch is active usersdontlimitbylogin dcnl dcsp dcsp dcsp last login datetime now timedelta weeks 12 dcnl dcsp dcsp dcsp users users filter last login gte last login dcnl dcsp dcsp return username u username display name display name or none u avatar profile avatar u 24 for u in users 10
ssl required dcnl anonymous csrf dcnl logout required dcnl require http methods get post dcnl def user auth request contributor false register form none login form none dcsp next url get next url request or reverse home dcnl dcsp if login form is none dcnl dcsp dcsp login form authenticationform dcnl dcsp if register form is none dcnl dcsp dcsp register form registerform dcnl dcsp return render request users auth html login form login form register form register form contributor contributor next url next url
ssl required dcnl anonymous csrf dcnl mobile template users mobile login html dcnl def login request template dcsp if request method get and not request mobile dcnl dcsp dcsp url reverse users auth + + request get urlencode dcnl dcsp dcsp return httpresponsepermanentredirect url dcnl dcsp next url get next url request or reverse home dcnl dcsp only active request post get inactive 0 1 dcnl dcsp form handle login request only active only active dcnl dcsp if request user is authenticated dcnl dcsp dcsp next url urlparams next url fpa 1 dcnl dcsp dcsp res httpresponseredirect next url dcnl dcsp dcsp max age none if settings session expire at browser close else settings session cookie age dcnl dcsp dcsp res set cookie settings session exists cookie 1 secure false max age max age dcnl dcsp dcsp return res dcnl dcsp if request mobile dcnl dcsp dcsp return render request template form form next url next url dcnl dcsp return user auth request login form form
ssl required dcnl require post dcnl def logout request dcsp auth logout request dcnl dcsp statsd incr user logout dcnl dcsp res httpresponseredirect get next url request or reverse home dcnl dcsp res delete cookie settings session exists cookie dcnl dcsp return res
ssl required dcnl logout required dcnl require http methods get post dcnl anonymous csrf dcnl mobile template users mobile dcnl def register request template contributor false dcsp if request method get and not request mobile dcnl dcsp dcsp url reverse users auth + + request get urlencode dcnl dcsp dcsp return httpresponsepermanentredirect url dcnl dcsp form handle register request dcnl dcsp if form is valid dcnl dcsp dcsp return render request template + register done html dcnl dcsp if request mobile dcnl dcsp dcsp return render request template + register html form form dcnl dcsp return user auth request register form form contributor contributor
def register contributor request dcsp return register request contributor true
anonymous csrf dcnl mobile template users mobile activate html dcnl def activate request template activation key user id none dcsp activation key activation key lower dcnl dcsp if user id dcnl dcsp dcsp user get object or 404 user id user id dcnl dcsp else dcnl dcsp dcsp user registrationprofile objects get user activation key dcnl dcsp if user and user is active dcnl dcsp dcsp messages add message request messages info u your dcsp account dcsp is dcsp already dcsp activated dcsp log dcsp in dcsp below dcnl dcsp dcsp return httpresponseredirect reverse users login dcnl dcsp account registrationprofile objects activate user activation key request dcnl dcsp my questions none dcnl dcsp form authenticationform dcnl dcsp if account dcnl dcsp dcsp statsd incr user activate dcnl dcsp dcsp claim watches delay account dcnl dcsp dcsp my questions question objects filter creator account dcnl dcsp dcsp for q in my questions dcnl dcsp dcsp dcsp q created datetime now dcnl dcsp dcsp dcsp q save update true dcnl dcsp return render request template account account questions my questions form form
anonymous csrf dcnl mobile template users mobile dcnl def resend confirmation request template dcsp if request method post dcnl dcsp dcsp form emailconfirmationform request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp email form cleaned data email dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp reg prof registrationprofile objects get user email email dcnl dcsp dcsp dcsp dcsp if not reg prof user is active dcnl dcsp dcsp dcsp dcsp dcsp form try send email with form registrationprofile objects send confirmation email form email reg prof dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp form try send email with form registrationprofile objects send confirmation email form email reg prof text template users email already activated ltxt html template users email already activated html subject account dcsp already dcsp activated dcnl dcsp dcsp dcsp except registrationprofile doesnotexist dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp user user objects get email email is active true dcnl dcsp dcsp dcsp dcsp dcsp current site site objects get current dcnl dcsp dcsp dcsp dcsp dcsp email kwargs domain current site domain login url reverse users login dcnl dcsp dcsp dcsp dcsp dcsp subject account dcsp already dcsp activated dcnl dcsp dcsp dcsp dcsp dcsp email utils safe translation dcnl dcsp dcsp dcsp dcsp dcsp def make mail locale dcnl dcsp dcsp dcsp dcsp dcsp dcsp mail email utils make mail subject subject text template users email already activated ltxt html template users email already activated html context vars email kwargs from email settings default from email to email user email dcnl dcsp dcsp dcsp dcsp dcsp dcsp return mail dcnl dcsp dcsp dcsp dcsp dcsp email utils send messages make mail request language code dcnl dcsp dcsp dcsp dcsp except user doesnotexist dcnl dcsp dcsp dcsp dcsp dcsp pass dcnl dcsp dcsp dcsp if form is valid dcnl dcsp dcsp dcsp dcsp return render request template + resend confirmation done html email email dcnl dcsp else dcnl dcsp dcsp form emailconfirmationform dcnl dcsp return render request template + resend confirmation html form form
login required dcnl require http methods get post dcnl mobile template users mobile dcnl def change email request template dcsp if request method post dcnl dcsp dcsp form emailchangeform request user request post dcnl dcsp dcsp u request user dcnl dcsp dcsp if form is valid and u email form cleaned data email dcnl dcsp dcsp dcsp emailchange objects filter user request user delete dcnl dcsp dcsp dcsp email change emailchange objects create profile user request user email form cleaned data email dcnl dcsp dcsp dcsp emailchange objects send confirmation email email change form cleaned data email dcnl dcsp dcsp dcsp return render request template + change email done html email form cleaned data email dcnl dcsp else dcnl dcsp dcsp form emailchangeform request user initial email request user email dcnl dcsp return render request template + change email html form form
require get dcnl def confirm change email request activation key dcsp activation key activation key lower dcnl dcsp email change get object or 404 emailchange activation key activation key dcnl dcsp u email change user dcnl dcsp old email u email dcnl dcsp new email email change email dcnl dcsp duplicate user objects filter email new email exists dcnl dcsp if not duplicate dcnl dcsp dcsp u email new email dcnl dcsp dcsp u save dcnl dcsp email change delete dcnl dcsp return render request users change email complete html old email old email new email new email username u username duplicate duplicate
login required dcnl require http methods get post dcnl mobile template users mobile edit settings html dcnl def edit settings request template dcsp if request method post dcnl dcsp dcsp form settingsform request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp form save for user request user dcnl dcsp dcsp dcsp messages add message request messages info u your dcsp settings dcsp have dcsp been dcsp saved dcnl dcsp dcsp dcsp return httpresponseredirect reverse users edit settings dcnl dcsp dcsp return render request template form form dcnl dcsp values request user settings values dcnl dcsp initial dict dcnl dcsp for v in values dcnl dcsp dcsp try dcnl dcsp dcsp dcsp initialv name literal eval v value dcnl dcsp dcsp except syntaxerror valueerror dcnl dcsp dcsp dcsp initialv name v value dcnl dcsp form settingsform initial initial dcnl dcsp return render request template form form
login required dcnl require http methods get post dcnl def edit watch list request dcsp watches watch objects filter user request user order by content type dcnl dcsp watch list dcnl dcsp for w in watches dcnl dcsp dcsp if w content object is not none dcnl dcsp dcsp dcsp if w content type name question dcnl dcsp dcsp dcsp dcsp if not w content object is archived dcnl dcsp dcsp dcsp dcsp dcsp watch list append w dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp watch list append w dcnl dcsp if request method post dcnl dcsp dcsp for w in watch list dcnl dcsp dcsp dcsp w is active watch s w id in request post dcnl dcsp dcsp dcsp w save dcnl dcsp return render request users edit watches html watch list watch list
login required dcnl require http methods get post dcnl mobile template users mobile edit profile html dcnl def edit profile request username none template none dcsp if username is not none and username request user username dcnl dcsp dcsp try dcnl dcsp dcsp dcsp user user objects get username username dcnl dcsp dcsp except user doesnotexist dcnl dcsp dcsp dcsp raise http404 dcnl dcsp dcsp if not request user has perm users change profile dcnl dcsp dcsp dcsp return httpresponseforbidden dcnl dcsp else dcnl dcsp dcsp user request user dcnl dcsp try dcnl dcsp dcsp user profile profile objects get user user dcnl dcsp except profile doesnotexist dcnl dcsp dcsp user profile profile objects create user user dcnl dcsp if request method post dcnl dcsp dcsp form profileform request post request files instance user profile dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp user profile form save dcnl dcsp dcsp dcsp new timezone user profile timezone dcnl dcsp dcsp dcsp tz changed request session get timezone none new timezone dcnl dcsp dcsp dcsp if tz changed and user request user dcnl dcsp dcsp dcsp dcsp request session timezone new timezone dcnl dcsp dcsp dcsp return httpresponseredirect reverse users profile args user username dcnl dcsp else dcnl dcsp dcsp form profileform instance user profile dcnl dcsp return render request template form form profile user profile
login required dcnl require http methods post dcnl def make contributor request dcsp group group objects get name contributor group dcnl dcsp request user groups add group dcnl dcsp email utils safe translation dcnl dcsp def make mail locale dcnl dcsp dcsp mail email utils make mail subject welcome dcsp to dcsp sumo text template users email contributor ltxt html template users email contributor html context vars contributor request user from email settings default from email to email request user email dcnl dcsp dcsp return mail dcnl dcsp email utils send messages make mail request language code dcnl dcsp if return to in request post dcnl dcsp dcsp return httpresponseredirect request post return to dcnl dcsp else dcnl dcsp dcsp return httpresponseredirect reverse landings get involved
login required dcnl require http methods get post dcnl def edit avatar request dcsp try dcnl dcsp dcsp user profile profile objects get user request user dcnl dcsp except profile doesnotexist dcnl dcsp dcsp user profile profile objects create user request user dcnl dcsp if request method post dcnl dcsp dcsp old avatar path none dcnl dcsp dcsp if user profile avatar and os path isfile user profile avatar path dcnl dcsp dcsp dcsp old avatar path user profile avatar path dcnl dcsp dcsp form avatarform request post request files instance user profile dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp if old avatar path dcnl dcsp dcsp dcsp dcsp os unlink old avatar path dcnl dcsp dcsp dcsp user profile form save dcnl dcsp dcsp dcsp content create image thumbnail user profile avatar path settings avatar size pad true dcnl dcsp dcsp dcsp name user profile avatar name + png dcnl dcsp dcsp dcsp user profile avatar delete dcnl dcsp dcsp dcsp user profile avatar save name content save true dcnl dcsp dcsp dcsp return httpresponseredirect reverse users edit my profile dcnl dcsp else dcnl dcsp dcsp form avatarform instance user profile dcnl dcsp return render request users edit avatar html form form profile user profile
login required dcnl require http methods get post dcnl def delete avatar request dcsp try dcnl dcsp dcsp user profile profile objects get user request user dcnl dcsp except profile doesnotexist dcnl dcsp dcsp user profile profile objects create user request user dcnl dcsp if request method post dcnl dcsp dcsp if user profile avatar dcnl dcsp dcsp dcsp user profile avatar delete dcnl dcsp dcsp return httpresponseredirect reverse users edit my profile dcnl dcsp return render request users confirm avatar delete html profile user profile
anonymous csrf dcnl mobile template users mobile pw reset form html dcnl def password reset request template dcsp if request method post dcnl dcsp dcsp form passwordresetform request post dcnl dcsp dcsp was valid form is valid dcnl dcsp dcsp if was valid dcnl dcsp dcsp dcsp try send email with form form save form email use https request is secure token generator default token generator text template users email pw reset ltxt html template users email pw reset html subject template name users email pw reset subject ltxt dcnl dcsp dcsp if form is valid or not was valid dcnl dcsp dcsp dcsp return httpresponseredirect reverse users pw reset sent dcnl dcsp else dcnl dcsp dcsp form passwordresetform dcnl dcsp return render request template form form
mobile template users mobile pw reset sent html dcnl def password reset sent request template dcsp return render request template
ssl required dcnl anonymous csrf dcnl mobile template users mobile pw reset confirm html dcnl def password reset confirm request template uidb36 none token none dcsp try dcnl dcsp dcsp uid int base36 to int uidb36 dcnl dcsp except valueerror dcnl dcsp dcsp raise http404 dcnl dcsp user get object or 404 user id uid int dcnl dcsp context dcnl dcsp if default token generator check token user token dcnl dcsp dcsp context validlink true dcnl dcsp dcsp if request method post dcnl dcsp dcsp dcsp form setpasswordform user request post dcnl dcsp dcsp dcsp if form is valid dcnl dcsp dcsp dcsp dcsp form save dcnl dcsp dcsp dcsp dcsp return httpresponseredirect reverse users pw reset complete dcnl dcsp dcsp else dcnl dcsp dcsp dcsp form setpasswordform none dcnl dcsp else dcnl dcsp dcsp context validlink false dcnl dcsp dcsp form none dcnl dcsp context form form dcnl dcsp return render request template context
mobile template users mobile pw reset complete html dcnl def password reset complete request template dcsp form authenticationform dcnl dcsp return render request template form form
login required dcnl mobile template users mobile pw change html dcnl def password change request template dcsp if request method post dcnl dcsp dcsp form passwordchangeform user request user data request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp form save dcnl dcsp dcsp dcsp return httpresponseredirect reverse users pw change complete dcnl dcsp else dcnl dcsp dcsp form passwordchangeform user request user dcnl dcsp return render request template form form
login required dcnl mobile template users mobile pw change complete html dcnl def password change complete request template dcsp return render request template
anonymous csrf dcnl mobile template users mobile forgot username html dcnl def forgot username request template dcsp if request method post dcnl dcsp dcsp form forgotusernameform request post dcnl dcsp dcsp was valid form is valid dcnl dcsp dcsp if was valid dcnl dcsp dcsp dcsp try send email with form form save form email use https request is secure dcnl dcsp dcsp if form is valid or not was valid dcnl dcsp dcsp dcsp messages add message request messages info u we ve dcsp sent dcsp an dcsp email dcsp with dcsp the dcsp username dcsp to dcsp any dcsp account dcsp using dcsp email format email form data email dcnl dcsp dcsp dcsp return httpresponseredirect reverse users login dcnl dcsp else dcnl dcsp dcsp form forgotusernameform dcnl dcsp return render request template form form
task rate limit 15 m dcnl timeit dcnl def generate thumbnail for obj from field to field max size settings thumbnail size dcsp from getattr for obj from field dcnl dcsp to getattr for obj to field dcnl dcsp if not from and os path isfile from path dcnl dcsp dcsp log msg no dcsp file dcsp to dcsp generate dcsp from dcsp model dcsp id dcsp from f dcsp dcsp to f dcnl dcsp dcsp log info log msg format model for obj class name id for obj id from f from field to f to field dcnl dcsp dcsp return dcnl dcsp log msg generating dcsp thumbnail dcsp for dcsp model dcsp id dcsp from f dcsp dcsp to f dcnl dcsp log info log msg format model for obj class name id for obj id from f from field to f to field dcnl dcsp thumb content create image thumbnail from path longest side max size dcnl dcsp file path from path dcnl dcsp if to dcnl dcsp dcsp to delete save false dcnl dcsp to save file path thumb content save false dcnl dcsp for obj update to field to name
def create image thumbnail file path longest side settings thumbnail size pad false dcsp original image image open file path dcnl dcsp original image original image convert rgba dcnl dcsp file width file height original image size dcnl dcsp width height scale dimensions file width file height longest side dcnl dcsp resized image original image resize width height image antialias dcnl dcsp io stringio stringio dcnl dcsp if pad dcnl dcsp dcsp padded image make image square resized image longest side dcnl dcsp dcsp padded image save io png dcnl dcsp else dcnl dcsp dcsp resized image save io png dcnl dcsp return contentfile io getvalue
def make image square source image side settings thumbnail size dcsp square image image new rgba side side 255 255 255 0 dcnl dcsp width side source image size0 2 dcnl dcsp height side source image size1 2 dcnl dcsp square image paste source image width height dcnl dcsp return square image
def scale dimensions width height longest side settings thumbnail size dcsp if width < longest side and height < longest side dcnl dcsp dcsp return width height dcnl dcsp if width height dcnl dcsp dcsp new width longest side dcnl dcsp dcsp new height new width height width dcnl dcsp dcsp return new width new height dcnl dcsp new height longest side dcnl dcsp new width new height width height dcnl dcsp return new width new height
task rate limit 15 m dcnl timeit dcnl def compress image for obj for field dcsp for getattr for obj for field dcnl dcsp if not for and os path isfile for path dcnl dcsp dcsp log msg no dcsp file dcsp to dcsp compress dcsp for dcsp model dcsp id dcsp for f dcnl dcsp dcsp log info log msg format model for obj class name id for obj id for f for field dcnl dcsp dcsp return dcnl dcsp if not os path splitext for path 1 lower png dcnl dcsp dcsp log msg file dcsp is dcsp not dcsp png dcsp for dcsp model dcsp id dcsp for f dcnl dcsp dcsp log info log msg format model for obj class name id for obj id for f for field dcnl dcsp dcsp return dcnl dcsp log msg compressing dcsp model dcsp id dcsp for f dcnl dcsp log info log msg format model for obj class name id for obj id for f for field dcnl dcsp file path for path dcnl dcsp if settings optipng path is not none dcnl dcsp dcsp subprocess call settings optipng path quiet preserve file path
def check file size f max allowed size dcsp if f size max allowed size dcnl dcsp dcsp message lazy u s dcsp is dcsp too dcsp large dcsp skb dcsp the dcsp limit dcsp is dcsp skb f name f size 10 max allowed size 10 dcnl dcsp dcsp raise filetoolargeerror message
def create imageattachment files user obj dcsp up file files values 0 dcnl dcsp check file size up file settings image max filesize dcnl dcsp up file is animated image to png up file dcnl dcsp image imageattachment content object obj creator user dcnl dcsp image file save up file name file up file save true dcnl dcsp generate thumbnail delay image file thumbnail dcnl dcsp if not is animated dcnl dcsp dcsp compress image delay image file dcnl dcsp width height scale dimensions image file width image file height dcnl dcsp name bleach clean up file name dcnl dcsp return name name url image file url thumbnail url image thumbnail if set url width width height height delete url image get delete url
def upload imageattachment request obj dcsp return upload media request imageattachmentuploadform create imageattachment obj obj
def upload media request form cls up file callback instance none kwargs dcsp form form cls request post request files dcnl dcsp if request method post and form is valid dcnl dcsp dcsp return up file callback request files request user kwargs dcnl dcsp elif not form is valid dcnl dcsp dcsp return form errors dcnl dcsp return none
def clean image extension form field dcsp if form field dcnl dcsp dcsp if not in form field name dcnl dcsp dcsp dcsp raise validationerror msg image extension dcnl dcsp dcsp ext form field name rsplit 1 dcnl dcsp dcsp if ext lower not in allowed image extensions dcnl dcsp dcsp dcsp raise validationerror msg image extension
login required dcnl require post dcnl xframe options sameorigin dcnl def up image async request model name object pk dcsp if model name not in allowed models dcnl dcsp dcsp message model dcsp not dcsp allowed dcnl dcsp dcsp return httpresponsebadrequest json dumps status error message message dcnl dcsp m get model model name split dcnl dcsp try dcnl dcsp dcsp obj m objects get pk object pk dcnl dcsp except objectdoesnotexist dcnl dcsp dcsp message object dcsp does dcsp not dcsp exist dcnl dcsp dcsp return httpresponsenotfound json dumps status error message message dcnl dcsp try dcnl dcsp dcsp file info upload imageattachment request obj dcnl dcsp except filetoolargeerror as e dcnl dcsp dcsp return httpresponsebadrequest json dumps status error message e args0 dcnl dcsp if isinstance file info dict and thumbnail url in file info dcnl dcsp dcsp return httpresponse json dumps status success file file info dcnl dcsp message invalid dcsp or dcsp no dcsp image dcsp received dcnl dcsp return httpresponsebadrequest json dumps status error message message errors file info
require post dcnl xframe options sameorigin dcnl def del image async request image id dcsp user request user dcnl dcsp if not user is authenticated dcnl dcsp dcsp message you dcsp are dcsp not dcsp logged dcsp in dcnl dcsp dcsp return httpresponseforbidden json dumps status error message message dcnl dcsp try dcnl dcsp dcsp image imageattachment objects get pk image id dcnl dcsp except imageattachment doesnotexist dcnl dcsp dcsp message the dcsp requested dcsp image dcsp could dcsp not dcsp be dcsp found dcnl dcsp dcsp return httpresponsenotfound json dumps status error message message dcnl dcsp if not user image creator or user has perm upload delete imageattachment dcnl dcsp dcsp message you dcsp do dcsp not dcsp have dcsp permission dcsp to dcsp do dcsp that dcnl dcsp dcsp return httpresponseforbidden json dumps status error message message dcnl dcsp image file delete dcnl dcsp if image thumbnail dcnl dcsp dcsp image thumbnail delete dcnl dcsp image delete dcnl dcsp return httpresponse json dumps status success
task dcnl timeit dcnl def send reviewed notification revision document message dcsp if revision reviewer revision creator dcnl dcsp dcsp log debug revision dcsp id s dcsp reviewed dcsp by dcsp creator dcsp skipping dcsp email revision id dcnl dcsp dcsp return dcnl dcsp log debug sending dcsp reviewed dcsp email dcsp for dcsp revision dcsp id s revision id dcnl dcsp url reverse wiki document revisions locale document locale args document slug dcnl dcsp c document title document title approved revision is approved reviewer revision reviewer message message revisions url url host site objects get current domain dcnl dcsp msgs dcnl dcsp email utils safe translation dcnl dcsp def make mail locale user dcnl dcsp dcsp if revision is approved dcnl dcsp dcsp dcsp subject u your dcsp revision dcsp has dcsp been dcsp approved dcsp title dcnl dcsp dcsp else dcnl dcsp dcsp dcsp subject u your dcsp revision dcsp has dcsp been dcsp reviewed dcsp title dcnl dcsp dcsp subject subject format title document title dcnl dcsp dcsp mail email utils make mail subject subject text template wiki email reviewed ltxt html template wiki email reviewed html context vars c from email settings tidings from address to email user email dcnl dcsp dcsp msgs append mail dcnl dcsp for user in revision creator revision reviewer dcnl dcsp dcsp if hasattr user profile dcnl dcsp dcsp dcsp locale user profile locale dcnl dcsp dcsp else dcnl dcsp dcsp dcsp locale settings wiki default language dcnl dcsp dcsp make mail locale user dcnl dcsp email utils send messages msgs
task dcnl timeit dcnl def send contributor notification based on revision document message dcsp text template wiki email reviewed contributors ltxt dcnl dcsp html template wiki email reviewed contributors html dcnl dcsp url reverse wiki document revisions locale document locale args document slug dcnl dcsp c document title document title approved revision is approved reviewer revision reviewer message message revisions url url host site objects get current domain dcnl dcsp msgs dcnl dcsp email utils safe translation dcnl dcsp def make mail locale user dcnl dcsp dcsp if revision is approved dcnl dcsp dcsp dcsp subject u a dcsp revision dcsp you dcsp contributed dcsp to dcsp has dcsp been dcsp approved dcsp title dcnl dcsp dcsp else dcnl dcsp dcsp dcsp subject u a dcsp revision dcsp you dcsp contributed dcsp to dcsp has dcsp been dcsp reviewed dcsp title dcnl dcsp dcsp subject subject format title document title dcnl dcsp dcsp mail email utils make mail subject subject text template text template html template html template context vars c from email settings tidings from address to email user email dcnl dcsp dcsp msgs append mail dcnl dcsp for r in based on dcnl dcsp dcsp if r creator in revision creator revision reviewer dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp user r creator dcnl dcsp dcsp if hasattr user profile dcnl dcsp dcsp dcsp locale user profile locale dcnl dcsp dcsp else dcnl dcsp dcsp dcsp locale settings wiki default language dcnl dcsp dcsp make mail locale user dcnl dcsp email utils send messages msgs
def schedule rebuild kb dcsp if not waffle switch is active wikirebuildondemand or settings celery always eager dcnl dcsp dcsp return dcnl dcsp if cache get settings wiki rebuild token dcnl dcsp dcsp log debug rebuild dcsp task dcsp already dcsp scheduled dcnl dcsp dcsp return dcnl dcsp cache set settings wiki rebuild token true dcnl dcsp rebuild kb delay
task dcnl timeit dcnl def add short links doc ids dcsp base url https 0 s format site objects get current domain dcnl dcsp docs document objects filter id in doc ids dcnl dcsp try dcnl dcsp dcsp pin this thread dcnl dcsp dcsp for doc in docs dcnl dcsp dcsp dcsp endpoint django reverse wiki document args doc slug dcnl dcsp dcsp dcsp doc update share link generate short url base url endpoint dcnl dcsp dcsp dcsp statsd incr wiki add short links success dcnl dcsp except bitlyratelimitexception dcnl dcsp dcsp statsd incr wiki add short links rate limited dcnl dcsp dcsp pass dcnl dcsp finally dcnl dcsp dcsp unpin this thread
task rate limit 3 h dcnl timeit dcnl def rebuild kb dcsp cache delete settings wiki rebuild token dcnl dcsp d document objects using default filter current revision isnull false values list id flat true dcnl dcsp for chunk in chunked d 50 dcnl dcsp dcsp rebuild kb chunk apply async args chunk
task rate limit 5 m dcnl timeit dcnl def rebuild kb chunk data dcsp log info rebuilding dcsp s dcsp documents len data dcnl dcsp pin this thread dcnl dcsp messages dcnl dcsp start time time dcnl dcsp for pk in data dcnl dcsp dcsp message none dcnl dcsp dcsp try dcnl dcsp dcsp dcsp document document objects get pk pk dcnl dcsp dcsp dcsp url document redirect url dcnl dcsp dcsp dcsp if url and points to document view url and not document redirect document dcnl dcsp dcsp dcsp dcsp log warn invalid dcsp redirect dcsp document dcsp d pk dcnl dcsp dcsp dcsp html document parse and calculate links dcnl dcsp dcsp dcsp if document html html dcnl dcsp dcsp dcsp dcsp document objects filter pk pk update html html dcnl dcsp dcsp dcsp dcsp statsd incr wiki rebuild chunk change dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp statsd incr wiki rebuild chunk nochange dcnl dcsp dcsp except document doesnotexist dcnl dcsp dcsp dcsp message missing dcsp document dcsp d pk dcnl dcsp dcsp except revision doesnotexist dcnl dcsp dcsp dcsp message missing dcsp revision dcsp for dcsp document dcsp d pk dcnl dcsp dcsp except validationerror as e dcnl dcsp dcsp dcsp message validationerror dcsp for dcsp d dcsp s pk e messages0 dcnl dcsp dcsp except slugcollision dcnl dcsp dcsp dcsp message slugcollision dcsp d pk dcnl dcsp dcsp except titlecollision dcnl dcsp dcsp dcsp message titlecollision dcsp d pk dcnl dcsp dcsp if message dcnl dcsp dcsp dcsp log debug message dcnl dcsp dcsp dcsp messages append message dcnl dcsp d time time start dcnl dcsp statsd timing wiki rebuild chunk int round d 1000 dcnl dcsp if messages dcnl dcsp dcsp subject s dcsp exceptions dcsp raised dcsp in dcsp rebuild kb chunk settings platform name dcnl dcsp dcsp mail admins subject subject message n join messages dcnl dcsp if not transaction get connection in atomic block dcnl dcsp dcsp transaction commit dcnl dcsp unpin this thread
task dcnl timeit dcnl def maybe award badge badge template year user dcsp badge get or create badge badge template year dcnl dcsp if badge is awarded to user dcnl dcsp dcsp return dcnl dcsp qs revision objects filter creator user is approved true created gte date year 1 1 created lt date year + 1 1 1 dcnl dcsp if badge template slug wiki badges kbbadge slug dcnl dcsp dcsp qs qs filter document locale settings wiki default language dcnl dcsp else dcnl dcsp dcsp qs qs exclude document locale settings wiki default language dcnl dcsp if qs count 10 dcnl dcsp dcsp badge award to user dcnl dcsp dcsp return true
task dcnl timeit dcnl def render document cascade base dcsp try dcnl dcsp dcsp pin this thread dcnl dcsp dcsp todo set base dcnl dcsp dcsp done set dcnl dcsp dcsp while todo dcnl dcsp dcsp dcsp d todo pop dcnl dcsp dcsp dcsp if d in done dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp d html d parse and calculate links dcnl dcsp dcsp dcsp d save dcnl dcsp dcsp dcsp done add d dcnl dcsp dcsp dcsp todo update l linked from for l in d links to filter kind in template include dcnl dcsp finally dcnl dcsp dcsp unpin this thread
def context dict revision ready for l10n false revision approved false dcsp diff dcnl dcsp l10n revision document revisions filter is ready for localization true dcnl dcsp approved revision document revisions filter is approved true dcnl dcsp if ready for l10n and l10n count 1 dcnl dcsp dcsp old rev l10n order by created 1 dcnl dcsp dcsp diff get diff for revision document old rev revision dcnl dcsp elif revision approved and approved count 1 dcnl dcsp dcsp old rev approved order by created 1 dcnl dcsp dcsp diff get diff for revision document old rev revision dcnl dcsp elif revision document current revision is not none dcnl dcsp dcsp old rev revision document current revision dcnl dcsp dcsp diff get diff for revision document old rev revision dcnl dcsp return document title revision document title creator revision creator host site objects get current domain diff diff summary clean revision summary allowed tags allowed attributes fulltext clean revision content allowed tags allowed attributes
cronjobs register dcnl def generate missing share links dcsp document ids document objects select related revision filter parent none share link is template false is archived false category in settings ia default categories exclude slug current revision none html startswith redirect html values list id flat true dcnl dcsp tasks add short links delay list document ids
cronjobs register dcnl def reindex kb dcsp index task delay documentmappingtype documentmappingtype get indexable
cronjobs register dcnl def send weekly ready for review digest dcsp if settings stage dcnl dcsp dcsp return dcnl dcsp email utils safe translation dcnl dcsp def send mail locale user context dcnl dcsp dcsp subject reviews dcsp pending dcsp s dcsp sumo dcsp needs dcsp your dcsp help locale dcnl dcsp dcsp mail email utils make mail subject subject text template wiki email ready for review weekly digest ltxt html template wiki email ready for review weekly digest html context vars context from email settings tidings from address to email user email dcnl dcsp dcsp email utils send messages mail dcnl dcsp categories how to category troubleshooting category templates category dcnl dcsp revs revision objects filter reviewed none document is archived false document category in categories dcnl dcsp revs revs filter q document current revision id lt f id | q document current revision id none dcnl dcsp locales revs values list document locale flat true distinct dcnl dcsp products product objects all dcnl dcsp for l in locales dcnl dcsp dcsp docs revs filter document locale l values list document flat true distinct dcnl dcsp dcsp docs document objects filter id in docs dcnl dcsp dcsp try dcnl dcsp dcsp dcsp leaders locale objects get locale l leaders all dcnl dcsp dcsp dcsp reviewers locale objects get locale l reviewers all dcnl dcsp dcsp dcsp users list set chain leaders reviewers dcnl dcsp dcsp except objectdoesnotexist dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp for u in users dcnl dcsp dcsp dcsp docs list dcnl dcsp dcsp dcsp for p in products dcnl dcsp dcsp dcsp dcsp product docs docs filter q parent none products in p | q parent products in p dcnl dcsp dcsp dcsp dcsp if product docs dcnl dcsp dcsp dcsp dcsp dcsp docs list append dict product pgettext db dcsp products product title p title docs product docs dcnl dcsp dcsp dcsp product docs docs filter q parent none products none | q parent products none dcnl dcsp dcsp dcsp if product docs dcnl dcsp dcsp dcsp dcsp docs list append dict product other dcsp products docs product docs dcnl dcsp dcsp dcsp send mail l u host site objects get current domain locale l recipient u docs list docs list products products dcnl dcsp dcsp dcsp statsd incr wiki cron weeklydigestmail
cronjobs register dcnl def fix current revisions dcsp try dcnl dcsp dcsp pin this thread dcnl dcsp dcsp docs document objects all dcnl dcsp dcsp for d in docs dcnl dcsp dcsp dcsp revs revision objects filter document d is approved true dcnl dcsp dcsp dcsp revs list revs order by reviewed 1 dcnl dcsp dcsp dcsp if len revs dcnl dcsp dcsp dcsp dcsp rev revs0 dcnl dcsp dcsp dcsp dcsp if d current revision rev dcnl dcsp dcsp dcsp dcsp dcsp d current revision rev dcnl dcsp dcsp dcsp dcsp dcsp d save dcnl dcsp dcsp dcsp dcsp dcsp print d get absolute url dcnl dcsp dcsp dcsp dcsp dcsp statsd incr wiki cron fixcurrentrevision dcnl dcsp finally dcnl dcsp dcsp unpin this thread
def active contributors from date to date none locale none product none dcsp return user objects filter id in active contributors id from date to date locale product order by username
def generate short url long url dcsp if settings bitly login is none or settings bitly api key is none dcnl dcsp dcsp return dcnl dcsp keys format json longurl long url login settings bitly login apikey settings bitly api key dcnl dcsp params urlencode keys dcnl dcsp resp requests post settings bitly api url params json dcnl dcsp if resp status code 200 dcnl dcsp dcsp short url resp get data get url dcnl dcsp dcsp return short url dcnl dcsp elif resp status code 401 dcnl dcsp dcsp raise bitlyunauthorizedexception unauthorized dcsp access dcsp to dcsp bitly s dcsp api dcnl dcsp elif resp status code 403 dcnl dcsp dcsp raise bitlyratelimitexception rate dcsp limit dcsp exceeded dcsp while dcsp using dcsp bitly s dcsp api dcnl dcsp else dcnl dcsp dcsp raise bitlyexception error dcsp code dcsp 0 dcsp recieved dcsp from dcsp bitly s dcsp api format resp status code
def num active contributors from date to date none locale none product none dcsp return len active contributors id from date to date locale product
def active contributors id from date to date locale product dcsp editors revision objects filter created gte from date values list creator flat true distinct dcnl dcsp reviewers revision objects filter reviewed gte from date values list reviewer flat true distinct dcnl dcsp if to date dcnl dcsp dcsp editors editors filter created lt to date dcnl dcsp dcsp reviewers reviewers filter reviewed lt to date dcnl dcsp if locale dcnl dcsp dcsp editors editors filter document locale locale dcnl dcsp dcsp reviewers reviewers filter document locale locale dcnl dcsp if product dcnl dcsp dcsp editors editors filter q document products product | q document parent products product dcnl dcsp dcsp reviewers reviewers filter q document products product | q document parent products product dcnl dcsp return set list editors + list reviewers
library global function dcnl def diff table content from content to dcsp html diff betterhtmldiff dcnl dcsp diff html diff make table content from splitlines content to splitlines context true dcnl dcsp return jinja2 markup diff
def doc parse markup content markup dcsp p doc rev parser content template title prefix + test category templates category dcnl dcsp doc pq p parse markup dcnl dcsp return doc p
def balanced eq want to balance dcsp expander forparser to balance dcnl dcsp eq want expander to unicode
def expanded eq want to expand dcsp expander forparser to expand dcnl dcsp expander expand fors dcnl dcsp eq want expander to unicode
def test form maintains based on rev client doc view post data locale none dcsp response client get reverse view locale locale args doc slug dcnl dcsp orig rev doc current revision dcnl dcsp eq orig rev id int pq response content inputname based on attr value dcnl dcsp approvedrevisionfactory document doc dcnl dcsp post data copy based on orig rev id dcnl dcsp post data copy update post data dcnl dcsp response client post reverse view locale locale args doc slug data post data copy dcnl dcsp eq 302 response status code dcnl dcsp fred rev revision objects all order by id 0 dcnl dcsp eq orig rev fred rev based on
def objects eq manager list dcsp eq set manager all set list
def set up ready watcher dcsp ready watcher userfactory email ready example com dcnl dcsp readyrevisionevent notify ready watcher dcnl dcsp return ready watcher
def doc components from url url required locale none check host true dcsp parsed urlparse url dcnl dcsp if check host and parsed netloc dcnl dcsp dcsp return false dcnl dcsp locale path split path parsed path dcnl dcsp if required locale and locale required locale dcnl dcsp dcsp return false dcnl dcsp path + path dcnl dcsp try dcnl dcsp dcsp view view args view kwargs resolve path dcnl dcsp except http404 dcnl dcsp dcsp return false dcnl dcsp import kitsune wiki views dcnl dcsp if view kitsune wiki views document dcnl dcsp dcsp raise notdocumentview dcnl dcsp return locale path view kwargs document slug
def points to document view url required locale none dcsp try dcnl dcsp dcsp return not not doc components from url url required locale required locale dcnl dcsp except notdocumentview dcnl dcsp dcsp return false
def user num documents user dcsp return document objects filter revisions creator user exclude html startswith <p redirect dcsp <a distinct count
def user documents user dcsp return document objects filter revisions creator user exclude html startswith <p redirect dcsp <a distinct
def user redirects user dcsp return document objects filter revisions creator user filter html startswith <p redirect dcsp <a distinct
def doc html cache key locale slug mobile minimal dcsp cache key doc html cache key format locale locale slug slug mobile str mobile minimal str minimal dcnl dcsp return hashlib sha1 smart str cache key hexdigest
def wiki to html wiki markup locale settings wiki default language doc id none parser cls none dcsp if parser cls is none dcnl dcsp dcsp parser cls wikiparser dcnl dcsp with statsd timer wiki render dcnl dcsp dcsp with uselocale locale dcnl dcsp dcsp dcsp content parser cls doc id doc id parse wiki markup show toc false locale locale toc string table dcsp of dcsp contents dcnl dcsp return content
def format template content content params dcsp def arg replace matchobj dcnl dcsp dcsp takes dcsp a dcsp regex dcsp matching dcsp name dcsp and dcsp returns dcsp params name dcnl dcsp dcsp param name matchobj group 1 dcnl dcsp dcsp if param name in params dcnl dcsp dcsp dcsp return paramsparam name dcnl dcsp return template arg regex sub arg replace content
def build template params params str dcsp i 0 dcnl dcsp params dcnl dcsp for item in params str dcnl dcsp dcsp param value item partition dcnl dcsp dcsp if value dcnl dcsp dcsp dcsp paramsparam value dcnl dcsp dcsp else dcnl dcsp dcsp dcsp i i + 1 dcnl dcsp dcsp dcsp paramsstr i param dcnl dcsp return params
def key split matchobj dcsp keys k strip for k in matchobj group 1 split + dcnl dcsp return dcsp + dcsp join <span dcsp class key s< span key for key in keys
def is leader locale user dcsp from kitsune wiki models import locale dcnl dcsp try dcnl dcsp dcsp locale team locale objects get locale locale dcnl dcsp except locale doesnotexist dcnl dcsp dcsp log warning locale dcsp not dcsp created dcsp for dcsp s locale dcnl dcsp dcsp return false dcnl dcsp return user in locale team leaders all
def is reviewer locale user dcsp from kitsune wiki models import locale dcnl dcsp try dcnl dcsp dcsp locale team locale objects get locale locale dcnl dcsp except locale doesnotexist dcnl dcsp dcsp log warning locale dcsp not dcsp created dcsp for dcsp s locale dcnl dcsp dcsp return false dcnl dcsp return user in locale team reviewers all
def check simple wiki locale view func dcsp wraps view func dcnl dcsp def check simple wiki locale request args kwargs dcnl dcsp dcsp if request language code in settings simple wiki languages dcnl dcsp dcsp dcsp statsd incr wiki redirect to faq dcnl dcsp dcsp dcsp url reverse wiki document args simple wiki landing page slug dcnl dcsp dcsp dcsp return http httpresponseredirect url dcnl dcsp dcsp return view func request args kwargs dcnl dcsp return check simple wiki locale
def locale list request dcsp locales locale objects all dcnl dcsp return render request wiki locale list html locales locales
def locale details request locale code leader form none reviewer form none editor form none dcsp locale get object or 404 locale locale locale code dcnl dcsp leaders locale leaders all select related profile dcnl dcsp reviewers locale reviewers all select related profile dcnl dcsp editors locale editors all select related profile dcnl dcsp active active contributors from date date today timedelta days 90 locale locale code dcnl dcsp user can edit user can edit request user locale dcnl dcsp return render request wiki locale details html locale locale leaders leaders reviewers reviewers editors editors active active user can edit user can edit leader form leader form or adduserform reviewer form reviewer form or adduserform editor form editor form or adduserform
login required dcnl require post dcnl def add to locale request locale code role dcsp locale get object or 404 locale locale locale code dcnl dcsp if not user can edit request user locale dcnl dcsp dcsp raise permissiondenied dcnl dcsp form adduserform request post dcnl dcsp if form is valid dcnl dcsp dcsp for user in form cleaned data users dcnl dcsp dcsp dcsp getattr locale role attrsrole add user dcnl dcsp dcsp msg users dcsp added dcsp successfully format users request post get users dcnl dcsp dcsp messages add message request messages success msg dcnl dcsp dcsp return httpresponseredirect locale get absolute url dcnl dcsp msg there dcsp were dcsp errors dcsp adding dcsp users dcsp see dcsp below dcnl dcsp messages add message request messages error msg dcnl dcsp return locale details request locale code role + form form
login required dcnl require http methods get post dcnl def remove from locale request locale code user id role dcsp locale get object or 404 locale locale locale code dcnl dcsp user get object or 404 user id user id dcnl dcsp if not user can edit request user locale dcnl dcsp dcsp raise permissiondenied dcnl dcsp if request method post dcnl dcsp dcsp getattr locale role attrsrole remove user dcnl dcsp dcsp msg user dcsp removed dcsp from dcsp successfully format user user username dcnl dcsp dcsp messages add message request messages success msg dcnl dcsp dcsp return httpresponseredirect locale get absolute url dcnl dcsp return render request wiki confirm remove from locale html locale locale leader user role role
def user can edit user locale dcsp return user has perm wiki change locale or user in locale leaders all
def topics for product parent false dcsp statsd incr wiki facets topics for db dcnl dcsp docs document objects filter locale settings wiki default language is archived false current revision isnull false products product category in settings ia default categories dcnl dcsp qs topic objects filter product product dcnl dcsp qs qs filter visible true document in docs annotate num docs count document distinct dcnl dcsp if parent or parent is none dcnl dcsp dcsp qs qs filter parent parent dcnl dcsp return qs
def documents for locale topics none products none dcsp documents documents for locale topics products dcnl dcsp if locale settings wiki default language dcnl dcsp dcsp l10n document ids d document parent id for d in documents if document parent id in d dcnl dcsp dcsp en documents documents for locale settings wiki default language products products topics topics dcnl dcsp dcsp fallback documents d for d in en documents if d id not in l10n document ids dcnl dcsp else dcnl dcsp dcsp fallback documents none dcnl dcsp return documents fallback documents
def documents for locale topics none products none dcsp documents cache get documents for cache key locale topics products dcnl dcsp if documents dcnl dcsp dcsp statsd incr wiki facets documents for cache dcnl dcsp dcsp return documents dcnl dcsp try dcnl dcsp dcsp documents es documents for locale topics products dcnl dcsp dcsp cache add documents for cache key locale topics products documents dcnl dcsp dcsp statsd incr wiki facets documents for es dcnl dcsp except transporterror dcnl dcsp dcsp documents db documents for locale topics products dcnl dcsp dcsp statsd incr wiki facets documents for db dcnl dcsp return documents
def es documents for locale topics none products none dcsp s documentmappingtype search values dict id document title url document parent id document summary filter document locale locale document is archived false document category in settings ia default categories dcnl dcsp for topic in topics or dcnl dcsp dcsp s s filter topic topic slug dcnl dcsp for product in products or dcnl dcsp dcsp s s filter product product slug dcnl dcsp results s order by document display order document recent helpful votes 100 dcnl dcsp results documentmappingtype reshape results dcnl dcsp return results
def db documents for locale topics none products none dcsp qs document objects filter locale locale is archived false current revision isnull false category in settings ia default categories dcnl dcsp for topic in topics or dcnl dcsp dcsp qs qs filter topics topic dcnl dcsp for product in products or dcnl dcsp dcsp qs qs filter products product dcnl dcsp doc dicts dcnl dcsp for d in qs distinct dcnl dcsp dcsp doc dicts append dict id d id document title d title url d get absolute url document parent id d parent id document summary d current revision summary dcnl dcsp return doc dicts
def doc page cache view dcsp wraps view dcnl dcsp def doc page cache view request document slug args kwargs dcnl dcsp dcsp if request user is authenticated or request get get redirect no dcnl dcsp dcsp dcsp statsd incr wiki document view cache skip dcnl dcsp dcsp dcsp return view request document slug args kwargs dcnl dcsp dcsp cache key doc html cache key mobile request mobile locale request language code slug document slug minimal request get get minimal 0 dcnl dcsp dcsp html headers cache get cache key none none dcnl dcsp dcsp if html is not none dcnl dcsp dcsp dcsp statsd incr wiki document view cache hit dcnl dcsp dcsp dcsp res httpresponse html dcnl dcsp dcsp dcsp for key val in headers items dcnl dcsp dcsp dcsp dcsp reskey val dcnl dcsp dcsp dcsp return res dcnl dcsp dcsp statsd incr wiki document view cache miss dcnl dcsp dcsp response view request document slug args kwargs dcnl dcsp dcsp if response status code 200 dcnl dcsp dcsp dcsp cache set cache key response content dict response headers values dcnl dcsp dcsp return response dcnl dcsp return doc page cache view
require get dcnl doc page cache dcnl mobile template wiki mobile dcnl def document request document slug template none document none dcsp fallback reason none dcnl dcsp full locale name none dcnl dcsp try dcnl dcsp dcsp doc document objects get locale request language code slug document slug dcnl dcsp dcsp if not doc current revision and doc parent and doc parent current revision dcnl dcsp dcsp dcsp fallback reason translation not approved dcnl dcsp dcsp elif not doc current revision dcnl dcsp dcsp dcsp fallback reason no content dcnl dcsp except document doesnotexist dcnl dcsp dcsp doc get object or 404 document locale settings wiki default language slug document slug dcnl dcsp dcsp translation doc translated to request language code dcnl dcsp dcsp if translation dcnl dcsp dcsp dcsp url translation get absolute url dcnl dcsp dcsp dcsp url urlparams url query dict request get dcnl dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp dcsp elif doc current revision dcnl dcsp dcsp dcsp fallback reason no translation dcnl dcsp if fallback reason no translation dcnl dcsp dcsp fallback locale get fallback locale doc request dcnl dcsp dcsp if fallback locale is not none dcnl dcsp dcsp dcsp translation doc translated to fallback locale dcnl dcsp dcsp dcsp doc translation dcnl dcsp dcsp dcsp fallback reason fallback locale dcnl dcsp dcsp dcsp full locale name request language code localesrequest language code native fallback locale localesfallback locale native dcnl dcsp dcsp else dcnl dcsp dcsp dcsp doc get object or 404 document locale settings wiki default language slug document slug dcnl dcsp any localizable revision doc revisions filter is approved true is ready for localization true exists dcnl dcsp redirect url none if request get get redirect no else doc redirect url request language code dcnl dcsp if redirect url dcnl dcsp dcsp url urlparams redirect url query dict request get redirectslug doc slug redirectlocale doc locale dcnl dcsp dcsp return httpresponseredirect url dcnl dcsp redirect slug request get get redirectslug dcnl dcsp redirect locale request get get redirectlocale dcnl dcsp redirected from none dcnl dcsp if redirect slug and redirect locale dcnl dcsp dcsp try dcnl dcsp dcsp dcsp redirected from document objects get locale redirect locale slug redirect slug dcnl dcsp dcsp except document doesnotexist dcnl dcsp dcsp dcsp pass dcnl dcsp contributors doc contributors all dcnl dcsp products doc get products dcnl dcsp if len products < 1 dcnl dcsp dcsp product product objects filter visible true 0 dcnl dcsp else dcnl dcsp dcsp product products0 dcnl dcsp product topics topic objects filter product product visible true parent none dcnl dcsp ga push dcnl dcsp if fallback reason is not none dcnl dcsp dcsp if fallback reason fallback locale dcnl dcsp dcsp dcsp ga push append trackevent incomplete dcsp l10n fallback dcsp locale s s s doc parent slug request language code doc locale dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ga push append trackevent incomplete dcsp l10n not dcsp localized s s doc slug request language code dcnl dcsp elif doc is outdated dcnl dcsp dcsp ga push append trackevent incomplete dcsp l10n not dcsp updated s s doc parent slug request language code dcnl dcsp if document slug in collapsible documents get request language code dcnl dcsp dcsp document css class collapsible dcnl dcsp else dcnl dcsp dcsp document css class dcnl dcsp if request mobile and minimal in request get dcnl dcsp dcsp template sdocumentminimal html template dcnl dcsp dcsp minimal true dcnl dcsp else dcnl dcsp dcsp template sdocument html template dcnl dcsp dcsp minimal false dcnl dcsp trimmed title doc title split dcsp dcsp 0 strip dcnl dcsp breadcrumbs none trimmed title dcnl dcsp document topics doc topics order by display order dcnl dcsp if len document topics 0 dcnl dcsp dcsp topic document topics0 dcnl dcsp dcsp first topic topic dcnl dcsp dcsp while topic is not none dcnl dcsp dcsp dcsp breadcrumbs append topic get absolute url topic title dcnl dcsp dcsp dcsp topic topic parent dcnl dcsp dcsp breadcrumbs append first topic product get absolute url first topic product title dcnl dcsp else dcnl dcsp dcsp breadcrumbs append product get absolute url product title dcnl dcsp breadcrumbs reverse dcnl dcsp user agent request meta get http user agent dcnl dcsp browser get browser user agent dcnl dcsp show fx download product slug thunderbird and browser firefox dcnl dcsp data document doc redirected from redirected from contributors contributors fallback reason fallback reason is aoa referral request get get ref aoa product topics product topics product product products products related products doc related products exclude pk product pk ga push ga push breadcrumb items breadcrumbs document css class document css class any localizable revision any localizable revision show fx download show fx download full locale name full locale name dcnl dcsp response render request template data dcnl dcsp if minimal dcnl dcsp dcsp response xframeoptions allow dcnl dcsp return response
def revision request document slug revision id dcsp rev get object or 404 revision pk revision id document slug document slug dcnl dcsp data document rev document revision rev dcnl dcsp return render request wiki revision html data
require get dcnl def list documents request category none dcsp docs document objects filter locale request language code order by title dcnl dcsp if category dcnl dcsp dcsp docs docs filter category category dcnl dcsp dcsp try dcnl dcsp dcsp dcsp category id int category dcnl dcsp dcsp except valueerror dcnl dcsp dcsp dcsp raise http404 dcnl dcsp dcsp try dcnl dcsp dcsp dcsp category unicode dict categories category id dcnl dcsp dcsp except keyerror dcnl dcsp dcsp dcsp raise http404 dcnl dcsp docs paginate request docs per page documents per page dcnl dcsp return render request wiki list documents html documents docs category category
login required dcnl def new document request dcsp if request method get dcnl dcsp dcsp doc form documentform initial title request get get title dcnl dcsp dcsp rev form revisionform dcnl dcsp dcsp return render request wiki new document html document form doc form revision form rev form products product objects filter visible true dcnl dcsp post data request post copy dcnl dcsp post data update locale request language code dcnl dcsp doc form documentform post data dcnl dcsp rev form revisionform post data dcnl dcsp if doc form is valid and rev form is valid dcnl dcsp dcsp doc doc form save none dcnl dcsp dcsp save rev and notify rev form request user doc dcnl dcsp dcsp return httpresponseredirect reverse wiki document revisions args doc slug dcnl dcsp return render request wiki new document html document form doc form revision form rev form products product objects filter visible true
def document lock check document id dcsp try dcnl dcsp dcsp redis redis client name default dcnl dcsp dcsp key document lock key format id document id dcnl dcsp dcsp return redis get key dcnl dcsp except rediserror as e dcnl dcsp dcsp statsd incr redis errror dcnl dcsp dcsp log error redis dcsp error dcsp s e dcnl dcsp dcsp return none
def document lock steal document id user name expire time 60 15 dcsp try dcnl dcsp dcsp redis redis client name default dcnl dcsp dcsp key document lock key format id document id dcnl dcsp dcsp it worked redis set key user name dcnl dcsp dcsp redis expire key expire time dcnl dcsp dcsp return it worked dcnl dcsp except rediserror as e dcnl dcsp dcsp statsd incr redis errror dcnl dcsp dcsp log error redis dcsp error dcsp s e dcnl dcsp dcsp return false
def document lock clear document id user name dcsp try dcnl dcsp dcsp redis redis client name default dcnl dcsp dcsp key document lock key format id document id dcnl dcsp dcsp locked by redis get key dcnl dcsp dcsp if locked by user name dcnl dcsp dcsp dcsp return redis delete key dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return false dcnl dcsp except rediserror as e dcnl dcsp dcsp statsd incr redis errror dcnl dcsp dcsp log error redis dcsp error dcsp s e dcnl dcsp dcsp return false
def document lock doc id username dcsp locked by document lock check doc id dcnl dcsp if locked by username dcnl dcsp dcsp locked false dcnl dcsp if locked by dcnl dcsp dcsp try dcnl dcsp dcsp dcsp locked not locked by username dcnl dcsp dcsp dcsp locked by user objects get username locked by dcnl dcsp dcsp except user doesnotexist dcnl dcsp dcsp dcsp locked false dcnl dcsp dcsp dcsp locked by none dcnl dcsp else dcnl dcsp dcsp locked by username dcnl dcsp dcsp locked false dcnl dcsp dcsp document lock steal doc id username dcnl dcsp return locked locked by
require http methods get post dcnl login required dcnl def edit document request document slug revision id none dcsp try dcnl dcsp dcsp doc document objects get locale request language code slug document slug dcnl dcsp except document doesnotexist dcnl dcsp dcsp parent doc get object or 404 document locale settings wiki default language slug document slug dcnl dcsp dcsp translation parent doc translated to request language code dcnl dcsp dcsp if translation dcnl dcsp dcsp dcsp doc translation dcnl dcsp dcsp else dcnl dcsp dcsp dcsp url reverse wiki translate locale request language code args document slug dcnl dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp user request user dcnl dcsp can edit needs change doc allows user edit needs change dcnl dcsp can archive doc allows user archive dcnl dcsp if doc parent dcnl dcsp dcsp return translate request doc parent slug revision id dcnl dcsp if revision id dcnl dcsp dcsp rev get object or 404 revision pk revision id document doc dcnl dcsp else dcnl dcsp dcsp rev doc current revision or doc revisions order by created id 0 dcnl dcsp disclose description bool request get get opendescription dcnl dcsp doc form rev form none dcnl dcsp if doc allows user create revision dcnl dcsp dcsp rev form revisionform instance rev initial based on rev id comment dcnl dcsp if doc allows user edit dcnl dcsp dcsp doc form documentform initial document form initial doc can archive can archive can edit needs change can edit needs change dcnl dcsp if request method get dcnl dcsp dcsp if not rev form or doc form dcnl dcsp dcsp dcsp raise permissiondenied dcnl dcsp else dcnl dcsp dcsp which form request post get form dcnl dcsp dcsp document lock clear doc id user username dcnl dcsp dcsp if which form doc dcnl dcsp dcsp dcsp if doc allows user edit dcnl dcsp dcsp dcsp dcsp post data request post copy dcnl dcsp dcsp dcsp dcsp post data update locale request language code dcnl dcsp dcsp dcsp dcsp topics dcnl dcsp dcsp dcsp dcsp for t in post data getlist topics dcnl dcsp dcsp dcsp dcsp dcsp topics append long t dcnl dcsp dcsp dcsp dcsp post data setlist topics topics dcnl dcsp dcsp dcsp dcsp doc form documentform post data instance doc can archive can archive can edit needs change can edit needs change dcnl dcsp dcsp dcsp dcsp if doc form is valid dcnl dcsp dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp dcsp doc doc form save none dcnl dcsp dcsp dcsp dcsp dcsp except titlecollision slugcollision as e dcnl dcsp dcsp dcsp dcsp dcsp dcsp errors doc form errors setdefault title errorlist dcnl dcsp dcsp dcsp dcsp dcsp dcsp message the dcsp type dcsp you dcsp selected dcsp is dcsp already dcsp in dcsp use dcnl dcsp dcsp dcsp dcsp dcsp dcsp message message format type title if isinstance e titlecollision else slug dcnl dcsp dcsp dcsp dcsp dcsp dcsp errors append message dcnl dcsp dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp dcsp maybe schedule rebuild doc form dcnl dcsp dcsp dcsp dcsp dcsp dcsp return httpresponseredirect urlparams reverse wiki edit document args doc slug opendescription 1 dcnl dcsp dcsp dcsp dcsp disclose description true dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise permissiondenied dcnl dcsp dcsp elif which form rev dcnl dcsp dcsp dcsp if doc allows user create revision dcnl dcsp dcsp dcsp dcsp rev form revisionform request post dcnl dcsp dcsp dcsp dcsp rev form instance document doc dcnl dcsp dcsp dcsp dcsp if rev form is valid dcnl dcsp dcsp dcsp dcsp dcsp save rev and notify rev form user doc base rev rev dcnl dcsp dcsp dcsp dcsp dcsp if notifyfuturechanges in request post dcnl dcsp dcsp dcsp dcsp dcsp dcsp editdocumentevent notify request user doc dcnl dcsp dcsp dcsp dcsp dcsp return httpresponseredirect reverse wiki document revisions args document slug dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise permissiondenied dcnl dcsp show revision warning show revision warning doc rev dcnl dcsp locked locked by document lock doc id user username dcnl dcsp return render request wiki edit html revision form rev form document form doc form disclose description disclose description document doc show revision warning show revision warning locked locked locked by locked by
csrf exempt dcnl login required dcnl require post dcnl def draft revision request dcsp draft form draftrevisionform request post dcnl dcsp if draft form is valid dcnl dcsp dcsp draft form save request request dcnl dcsp dcsp return httpresponse status 201 dcnl dcsp return httpresponsebadrequest
login required dcnl require post dcnl def preview revision request dcsp wiki content request post get content dcnl dcsp slug request post get slug dcnl dcsp locale request post get locale dcnl dcsp statsd incr wiki preview dcnl dcsp if slug and locale dcnl dcsp dcsp doc get object or 404 document slug slug locale locale dcnl dcsp dcsp products doc get products dcnl dcsp else dcnl dcsp dcsp products product objects all dcnl dcsp data content wiki to html wiki content request language code products products dcnl dcsp return render request wiki preview html data
require get dcnl def document revisions request document slug contributor form none dcsp locale request get get locale request language code dcnl dcsp try dcnl dcsp dcsp doc document objects get locale locale slug document slug dcnl dcsp except document doesnotexist dcnl dcsp dcsp parent doc get object or 404 document locale settings wiki default language slug document slug dcnl dcsp dcsp translation parent doc translated to locale dcnl dcsp dcsp if translation dcnl dcsp dcsp dcsp url reverse wiki document revisions args translation slug locale locale dcnl dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise http404 dcnl dcsp revs revision objects filter document doc order by created id dcnl dcsp if request is ajax dcnl dcsp dcsp template wiki includes revision list html dcnl dcsp else dcnl dcsp dcsp template wiki history html dcnl dcsp form contributor form or addcontributorform dcnl dcsp return render request template revisions revs document doc contributor form form
login required dcnl def review revision request document slug revision id dcsp rev get object or 404 revision pk revision id document slug document slug dcnl dcsp doc rev document dcnl dcsp if not doc allows request user review revision dcnl dcsp dcsp raise permissiondenied dcnl dcsp form reviewform initial needs change doc needs change needs change comment doc needs change comment dcnl dcsp should ask significance not doc parent and doc current revision dcnl dcsp based on revs doc revisions all dcnl dcsp last approved date getattr doc current revision created datetime fromordinal 1 dcnl dcsp based on revs based on revs filter created gt last approved date dcnl dcsp revision contributors list set based on revs values list creator username flat true dcnl dcsp unreviewed revisions revision objects filter document doc is approved false reviewed none order by id dcnl dcsp try dcnl dcsp dcsp latest unapproved revision unreviewed revisions0 dcnl dcsp dcsp latest unapproved revision id latest unapproved revision id dcnl dcsp except indexerror dcnl dcsp dcsp latest unapproved revision id none dcnl dcsp if doc current revision is not none dcnl dcsp dcsp current revision id doc current revision id dcnl dcsp dcsp unreviewed revisions unreviewed revisions exclude id lt current revision id dcnl dcsp else dcnl dcsp dcsp current revision id none dcnl dcsp unreviewed revisions unreviewed revisions exclude id rev id 5 dcnl dcsp if request user username in revision contributors dcnl dcsp dcsp revision contributors remove request user username dcnl dcsp if request method post dcnl dcsp dcsp form reviewform request post dcnl dcsp dcsp if form is valid and not rev reviewed dcnl dcsp dcsp dcsp rev is approved approve in request post dcnl dcsp dcsp dcsp rev reviewer request user dcnl dcsp dcsp dcsp rev reviewed datetime now dcnl dcsp dcsp dcsp if should ask significance and form cleaned data significance dcnl dcsp dcsp dcsp dcsp rev significance form cleaned data significance dcnl dcsp dcsp dcsp elif not should ask significance and not doc parent dcnl dcsp dcsp dcsp dcsp rev significance major significance dcnl dcsp dcsp dcsp if doc allows request user mark ready for l10n and rev is approved and rev can be readied for localization dcnl dcsp dcsp dcsp dcsp rev is ready for localization form cleaned data is ready for localization dcnl dcsp dcsp dcsp dcsp if rev is ready for localization dcnl dcsp dcsp dcsp dcsp dcsp rev readied for localization rev reviewed dcnl dcsp dcsp dcsp dcsp dcsp rev readied for localization by rev reviewer dcnl dcsp dcsp dcsp rev save dcnl dcsp dcsp dcsp if doc locale settings wiki default language and doc allows request user edit needs change and rev is approved dcnl dcsp dcsp dcsp dcsp doc needs change form cleaned data needs change dcnl dcsp dcsp dcsp dcsp if doc needs change dcnl dcsp dcsp dcsp dcsp dcsp doc needs change comment form cleaned data needs change comment dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp doc needs change comment dcnl dcsp dcsp dcsp dcsp doc save dcnl dcsp dcsp dcsp if rev is ready for localization or rev is approved dcnl dcsp dcsp dcsp dcsp events approverevisioninlocaleevent rev dcnl dcsp dcsp dcsp dcsp if rev is ready for localization dcnl dcsp dcsp dcsp dcsp dcsp events append readyrevisionevent rev dcnl dcsp dcsp dcsp dcsp approvedorreadyunion events fire exclude rev creator request user dcnl dcsp dcsp dcsp msg form cleaned data comment dcnl dcsp dcsp dcsp send reviewed notification delay rev doc msg dcnl dcsp dcsp dcsp send contributor notification based on revs rev doc msg dcnl dcsp dcsp dcsp statsd incr wiki review dcnl dcsp dcsp dcsp render document cascade delay doc dcnl dcsp dcsp dcsp return httpresponseredirect reverse wiki document revisions args document slug dcnl dcsp if doc parent dcnl dcsp dcsp parent revision rev based on or doc parent localizable or latest revision dcnl dcsp dcsp template wiki review translation html dcnl dcsp else dcnl dcsp dcsp parent revision none dcnl dcsp dcsp template wiki review revision html dcnl dcsp data revision rev document doc form form parent revision parent revision revision contributors list revision contributors should ask significance should ask significance latest unapproved revision id latest unapproved revision id current revision id current revision id unreviewed revisions unreviewed revisions dcnl dcsp return render request template data
require get dcnl def compare revisions request document slug dcsp locale request get get locale request language code dcnl dcsp doc get object or 404 document locale locale slug document slug dcnl dcsp if from not in request get or to not in request get dcnl dcsp dcsp raise http404 dcnl dcsp from id smart int request get get from dcnl dcsp to id smart int request get get to dcnl dcsp revision from get object or 404 revision document doc id from id dcnl dcsp revision to get object or 404 revision document doc id to id dcnl dcsp if request is ajax dcnl dcsp dcsp template wiki includes revision diff html dcnl dcsp else dcnl dcsp dcsp template wiki compare revisions html dcnl dcsp return render request template document doc revision from revision from revision to revision to
login required dcnl def select locale request document slug dcsp doc get object or 404 document locale settings wiki default language slug document slug dcnl dcsp translated locales code dcnl dcsp translated locales dcnl dcsp untranslated locales dcnl dcsp translated locales code append doc locale dcnl dcsp translated locales code extend doc translations all values list locale flat true dcnl dcsp for locale in settings language choices dcnl dcsp dcsp if locale0 in translated locales code dcnl dcsp dcsp dcsp translated locales append locale dcnl dcsp dcsp else dcnl dcsp dcsp dcsp untranslated locales append locale dcnl dcsp return render request wiki select locale html document doc translated locales translated locales untranslated locales untranslated locales
require http methods get post dcnl login required dcnl def translate request document slug revision id none dcsp parent doc get object or 404 document locale settings wiki default language slug document slug dcnl dcsp user request user dcnl dcsp if settings wiki default language request language code dcnl dcsp dcsp return httpresponseredirect reverse wiki edit document locale settings wiki default language args parent doc slug dcnl dcsp if not parent doc is localizable dcnl dcsp dcsp message lazy u you dcsp cannot dcsp translate dcsp this dcsp document dcnl dcsp dcsp return render request handlers 400 html message message status 400 dcnl dcsp based on rev parent doc localizable or latest revision include rejected true dcnl dcsp disclose description bool request get get opendescription dcnl dcsp try dcnl dcsp dcsp doc parent doc translations get locale request language code dcnl dcsp except document doesnotexist dcnl dcsp dcsp doc none dcnl dcsp dcsp disclose description true dcnl dcsp user has doc perm not doc or doc allows user edit dcnl dcsp user has rev perm not doc or doc allows user create revision dcnl dcsp if not user has doc perm and not user has rev perm dcnl dcsp dcsp raise permissiondenied dcnl dcsp draft draftrevision objects filter creator user document parent doc locale request language code dcnl dcsp doc form rev form none dcnl dcsp base rev none dcnl dcsp restore draft none dcnl dcsp draft request request get get restore or request get get discard dcnl dcsp draft revision none dcnl dcsp if draft request and draft exists dcnl dcsp dcsp restore draft request get get restore dcnl dcsp dcsp discard draft request get get discard dcnl dcsp dcsp if discard draft and not restore draft dcnl dcsp dcsp dcsp draft0 delete dcnl dcsp elif draft exists dcnl dcsp dcsp draft revision draft0 dcnl dcsp if user has doc perm dcnl dcsp dcsp if restore draft dcnl dcsp dcsp dcsp doc initial draft initial doc draft revision draft0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp doc initial document form initial doc if doc else none dcnl dcsp dcsp doc form documentform initial doc initial dcnl dcsp if user has rev perm dcnl dcsp dcsp if restore draft dcnl dcsp dcsp dcsp initial draft initial rev draft revision draft0 dcnl dcsp dcsp dcsp based on rev draft0 based on dcnl dcsp dcsp else dcnl dcsp dcsp dcsp initial based on based on rev id comment dcnl dcsp dcsp dcsp if revision id dcnl dcsp dcsp dcsp dcsp base rev revision objects get pk revision id dcnl dcsp dcsp dcsp dcsp initial update content base rev content summary base rev summary keywords base rev keywords dcnl dcsp dcsp dcsp elif not doc dcnl dcsp dcsp dcsp dcsp initial update content based on rev content summary based on rev summary keywords based on rev keywords dcnl dcsp dcsp instance doc and doc localizable or latest revision dcnl dcsp dcsp rev form revisionform instance instance initial initial dcnl dcsp dcsp base rev base rev or instance dcnl dcsp if request method post dcnl dcsp dcsp which form request post get form both dcnl dcsp dcsp doc form invalid false dcnl dcsp dcsp if doc is not none dcnl dcsp dcsp dcsp document lock clear doc id user username dcnl dcsp dcsp if user has doc perm and which form in doc both dcnl dcsp dcsp dcsp disclose description true dcnl dcsp dcsp dcsp post data request post copy dcnl dcsp dcsp dcsp post data update locale request language code dcnl dcsp dcsp dcsp doc form documentform post data instance doc dcnl dcsp dcsp dcsp doc form instance locale request language code dcnl dcsp dcsp dcsp doc form instance parent parent doc dcnl dcsp dcsp dcsp if which form both dcnl dcsp dcsp dcsp dcsp rev form revisionform request post dcnl dcsp dcsp dcsp if doc form is valid and which form doc or rev form is valid dcnl dcsp dcsp dcsp dcsp doc doc form save parent doc dcnl dcsp dcsp dcsp dcsp maybe schedule rebuild doc form dcnl dcsp dcsp dcsp dcsp if which form doc dcnl dcsp dcsp dcsp dcsp dcsp url urlparams reverse wiki edit document args doc slug opendescription 1 dcnl dcsp dcsp dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp dcsp dcsp dcsp doc slug doc form cleaned data slug dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp doc form invalid true dcnl dcsp dcsp else dcnl dcsp dcsp dcsp doc slug doc slug dcnl dcsp dcsp if doc and user has rev perm and which form in rev both dcnl dcsp dcsp dcsp rev form revisionform request post dcnl dcsp dcsp dcsp rev form instance document doc dcnl dcsp dcsp dcsp if rev form is valid and not doc form invalid dcnl dcsp dcsp dcsp dcsp if noupdate in request post dcnl dcsp dcsp dcsp dcsp dcsp based on id base rev based on id dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp based on id none dcnl dcsp dcsp dcsp dcsp if draft revision dcnl dcsp dcsp dcsp dcsp dcsp draft revision delete dcnl dcsp dcsp dcsp dcsp save rev and notify rev form request user doc based on id base rev base rev dcnl dcsp dcsp dcsp dcsp if notifyfuturechanges in request post dcnl dcsp dcsp dcsp dcsp dcsp editdocumentevent notify request user doc dcnl dcsp dcsp dcsp dcsp url reverse wiki document revisions args doc slug dcnl dcsp dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp show revision warning show revision warning doc base rev dcnl dcsp recent approved revs parent doc revisions filter is approved true id lte based on rev id dcnl dcsp if doc and doc current revision and doc current revision based on id dcnl dcsp dcsp recent approved revs recent approved revs filter id gt doc current revision based on id dcnl dcsp if doc dcnl dcsp dcsp locked locked by document lock doc id user username dcnl dcsp dcsp more updated rev doc revisions filter based on id gt based on rev id order by based on id last dcnl dcsp else dcnl dcsp dcsp locked locked by false none dcnl dcsp dcsp more updated rev none dcnl dcsp product slugs p slug for p in doc or parent doc products all dcnl dcsp fxos l10n warning firefoxos in product slugs and request language code not in settings fxos languages dcnl dcsp return render request wiki translate html parent parent doc document doc document form doc form revision form rev form locale request language code based on based on rev disclose description disclose description show revision warning show revision warning recent approved revs recent approved revs locked locked locked by locked by fxos l10n warning fxos l10n warning draft revision draft revision more updated rev more updated rev
require post dcnl login required dcnl def watch document request document slug dcsp document get object or 404 document locale request language code slug document slug dcnl dcsp editdocumentevent notify request user document dcnl dcsp statsd incr wiki watches document dcnl dcsp return httpresponseredirect document get absolute url
require post dcnl login required dcnl def unwatch document request document slug dcsp document get object or 404 document locale request language code slug document slug dcnl dcsp editdocumentevent stop notifying request user document dcnl dcsp return httpresponseredirect document get absolute url
require post dcnl login required dcnl def watch locale request product none dcsp kwargs locale request language code dcnl dcsp if product is not none dcnl dcsp dcsp kwargs product product dcnl dcsp reviewablerevisioninlocaleevent notify request user kwargs dcnl dcsp statsd incr wiki watches locale dcnl dcsp return httpresponse
require post dcnl login required dcnl def unwatch locale request product none dcsp kwargs locale request language code dcnl dcsp if product is not none dcnl dcsp dcsp kwargs product product dcnl dcsp reviewablerevisioninlocaleevent stop notifying request user kwargs dcnl dcsp return httpresponse
require post dcnl login required dcnl def watch approved request product none dcsp if request language code not in settings sumo languages dcnl dcsp dcsp raise http404 dcnl dcsp kwargs locale request language code dcnl dcsp if product is not none dcnl dcsp dcsp kwargs product product dcnl dcsp approverevisioninlocaleevent notify request user kwargs dcnl dcsp statsd incr wiki watches approved dcnl dcsp return httpresponse
require post dcnl login required dcnl def unwatch approved request product none dcsp if request language code not in settings sumo languages dcnl dcsp dcsp raise http404 dcnl dcsp kwargs locale request language code dcnl dcsp if product is not none dcnl dcsp dcsp kwargs product product dcnl dcsp approverevisioninlocaleevent stop notifying request user kwargs dcnl dcsp return httpresponse
require post dcnl login required dcnl def watch ready request product none dcsp if request language code settings wiki default language dcnl dcsp dcsp raise http404 dcnl dcsp kwargs dcnl dcsp if product is not none dcnl dcsp dcsp kwargs product product dcnl dcsp readyrevisionevent notify request user kwargs dcnl dcsp statsd incr wiki watches ready dcnl dcsp return httpresponse
require post dcnl login required dcnl def unwatch ready request product none dcsp if request language code settings wiki default language dcnl dcsp dcsp raise http404 dcnl dcsp kwargs dcnl dcsp if product is not none dcnl dcsp dcsp kwargs product product dcnl dcsp readyrevisionevent stop notifying request user kwargs dcnl dcsp return httpresponse
require get dcnl def json view request dcsp kwargs locale request language code current revision isnull false dcnl dcsp if title in request get dcnl dcsp dcsp kwargs title request get title dcnl dcsp elif slug in request get dcnl dcsp dcsp kwargs slug request get slug dcnl dcsp else dcnl dcsp dcsp return httpresponsebadrequest dcnl dcsp document get object or 404 document kwargs dcnl dcsp data json dumps id document id locale document locale slug document slug title document title summary document current revision summary url document get absolute url dcnl dcsp return httpresponse data content type application json
require post dcnl csrf exempt dcnl ratelimit documentvote 10 d dcnl def helpful vote request document slug dcsp if revision id not in request post dcnl dcsp dcsp return httpresponsebadrequest dcnl dcsp revision get object or 404 revision id smart int request post revision id dcnl dcsp survey none dcnl dcsp if revision document category templates category dcnl dcsp dcsp return httpresponsebadrequest dcnl dcsp if not revision has voted request dcnl dcsp dcsp ua request meta get http user agent 1000 dcnl dcsp dcsp vote helpfulvote revision revision user agent ua dcnl dcsp dcsp if helpful in request post dcnl dcsp dcsp dcsp vote helpful true dcnl dcsp dcsp dcsp message glad dcsp to dcsp hear dcsp it dcsp mdash dcsp thanks dcsp for dcsp the dcsp feedback dcnl dcsp dcsp else dcnl dcsp dcsp dcsp message sorry dcsp to dcsp hear dcsp that dcnl dcsp dcsp if not request limited dcnl dcsp dcsp dcsp if request user is authenticated dcnl dcsp dcsp dcsp dcsp vote creator request user dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp vote anonymous id request anonymous anonymous id dcnl dcsp dcsp dcsp vote save dcnl dcsp dcsp dcsp statsd incr wiki vote dcnl dcsp dcsp dcsp if helpful not in request post dcnl dcsp dcsp dcsp dcsp survey render to string wiki includes unhelpful survey html vote id vote id dcnl dcsp dcsp dcsp for name in referrer query source dcnl dcsp dcsp dcsp dcsp val request post get name dcnl dcsp dcsp dcsp dcsp if val dcnl dcsp dcsp dcsp dcsp dcsp vote add metadata name val dcnl dcsp else dcnl dcsp dcsp message you dcsp already dcsp voted dcsp on dcsp this dcsp article dcnl dcsp if request is ajax dcnl dcsp dcsp r message message dcnl dcsp dcsp if survey dcnl dcsp dcsp dcsp r update survey survey dcnl dcsp dcsp return httpresponse json dumps r dcnl dcsp return httpresponseredirect revision document get absolute url
require post dcnl csrf exempt dcnl def unhelpful survey request dcsp vote get object or 404 helpfulvote id smart int request post get vote id dcnl dcsp if not vote helpful and not vote metadata filter key survey exists dcnl dcsp dcsp survey request post copy dcnl dcsp dcsp survey pop vote id dcnl dcsp dcsp survey pop button dcnl dcsp dcsp vote add metadata survey truncated json dumps survey 1000 comment dcnl dcsp return httpresponse json dumps message thanks dcsp for dcsp making dcsp us dcsp better
login required dcnl def delete revision request document slug revision id dcsp revision get object or 404 revision pk revision id document slug document slug dcnl dcsp document revision document dcnl dcsp if not document allows request user delete revision dcnl dcsp dcsp raise permissiondenied dcnl dcsp only revision document revisions count 1 dcnl dcsp helpful votes helpfulvote objects filter revision revision id dcnl dcsp has votes helpful votes exists dcnl dcsp if request method get dcnl dcsp dcsp return render request wiki confirm revision delete html revision revision document document only revision only revision has votes has votes dcnl dcsp if only revision dcnl dcsp dcsp return httpresponsebadrequest dcnl dcsp log warning user dcsp s dcsp is dcsp deleting dcsp revision dcsp with dcsp id s request user revision id dcnl dcsp revision delete dcnl dcsp return httpresponseredirect reverse wiki document revisions args document slug
login required dcnl require post dcnl def mark ready for l10n revision request document slug revision id dcsp revision get object or 404 revision pk revision id document slug document slug dcnl dcsp if not revision document allows request user mark ready for l10n dcnl dcsp dcsp raise permissiondenied dcnl dcsp if revision can be readied for localization dcnl dcsp dcsp revision is ready for localization true dcnl dcsp dcsp revision readied for localization datetime now dcnl dcsp dcsp revision readied for localization by request user dcnl dcsp dcsp revision save dcnl dcsp dcsp readyrevisionevent revision fire exclude request user dcnl dcsp dcsp return httpresponse json dumps message revision id dcnl dcsp return httpresponsebadrequest
login required dcnl def delete document request document slug dcsp document get object or 404 document locale request language code slug document slug dcnl dcsp if not document allows request user delete dcnl dcsp dcsp raise permissiondenied dcnl dcsp if request method get dcnl dcsp dcsp return render request wiki confirm document delete html document document dcnl dcsp log warning user dcsp s dcsp is dcsp deleting dcsp document dcsp s dcsp id s request user document title document id dcnl dcsp document delete dcnl dcsp return render request wiki confirm document delete html document document delete confirmed true
login required dcnl require post dcnl def add contributor request document slug dcsp document get object or 404 document locale request language code slug document slug dcnl dcsp if not document allows request user edit dcnl dcsp dcsp raise permissiondenied dcnl dcsp form addcontributorform request post dcnl dcsp if form is valid dcnl dcsp dcsp for user in form cleaned data users dcnl dcsp dcsp dcsp document contributors add user dcnl dcsp dcsp msg users dcsp added dcsp to dcsp the dcsp contributors dcsp successfully format users request post get users dcnl dcsp dcsp messages add message request messages success msg dcnl dcsp dcsp return httpresponseredirect reverse wiki document revisions args document slug dcnl dcsp msg there dcsp were dcsp errors dcsp adding dcsp new dcsp contributors dcsp see dcsp below dcnl dcsp messages add message request messages error msg dcnl dcsp return document revisions request document slug contributor form form
login required dcnl require http methods get post dcnl def remove contributor request document slug user id dcsp document get object or 404 document locale request language code slug document slug dcnl dcsp if not document allows request user edit dcnl dcsp dcsp raise permissiondenied dcnl dcsp user get object or 404 user id user id dcnl dcsp if request method post dcnl dcsp dcsp document contributors remove user dcnl dcsp dcsp msg user dcsp removed dcsp from dcsp the dcsp contributors dcsp successfully format user user username dcnl dcsp dcsp messages add message request messages success msg dcnl dcsp dcsp return httpresponseredirect reverse wiki document revisions args document slug dcnl dcsp return render request wiki confirm remove contributor html document document contributor user
def document form initial document dcsp return title document title slug document slug category document category is localizable document is localizable is archived document is archived topics topic objects filter document document values list id flat true products product objects filter document document values list id flat true related documents document objects filter related documents document values list id flat true allow discussion document allow discussion needs change document needs change needs change comment document needs change comment
def save rev and notify rev form creator document based on id none base rev none dcsp new rev rev form save creator document based on id base rev dcnl dcsp statsd incr wiki revision dcnl dcsp reviewablerevisioninlocaleevent new rev fire exclude new rev creator dcnl dcsp editdocumentevent new rev fire exclude new rev creator
def maybe schedule rebuild form dcsp if title in form changed data or slug in form changed data dcnl dcsp dcsp schedule rebuild kb
require get dcnl def what links here request document slug dcsp locale request get get locale request language code dcnl dcsp doc get object or 404 document locale locale slug document slug dcnl dcsp links dcnl dcsp for l in doc links to dcnl dcsp dcsp if doc locale l linked from locale dcnl dcsp dcsp dcsp if l kind not in links dcnl dcsp dcsp dcsp dcsp linksl kind dcnl dcsp dcsp dcsp linksl kind append l linked from dcnl dcsp c document doc relations links dcnl dcsp return render request wiki what links here html c
def get fallback locale doc request dcsp translated locales doc translations values list locale flat true exclude current revision none dcnl dcsp accept header request meta get http accept language or dcnl dcsp header locales parse accept lang header accept header dcnl dcsp all accepted locales dcnl dcsp all accepted locales append request language code dcnl dcsp all accepted locales extend header locales dcnl dcsp for locale in all accepted locales dcnl dcsp dcsp if locale settings wiki default language dcnl dcsp dcsp dcsp return none dcnl dcsp dcsp elif locale in translated locales dcnl dcsp dcsp dcsp return locale dcnl dcsp dcsp elif settings non supported locales get locale in translated locales dcnl dcsp dcsp dcsp return settings non supported localeslocale dcnl dcsp dcsp for fallback in fallback locales get locale dcnl dcsp dcsp dcsp if fallback in translated locales dcnl dcsp dcsp dcsp dcsp return fallback dcnl dcsp return none
def parse accept lang header lang string dcsp accept language re re compile n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp azaz 1 8 azaz09 1 8 | dcsp dcsp dcsp dcsp dcsp dcsp dcsp en dcsp enau dcsp xyz dcsp es419 dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s s q 0 d 3 |1 0 3 dcsp dcsp dcsp dcsp optional dcsp q 1 00 dcsp q 0 8 n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s s | dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp multiple dcsp accepts dcsp per dcsp header n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp re verbose dcnl dcsp result dcnl dcsp pieces accept language re split lang string dcnl dcsp if pieces 1 dcnl dcsp dcsp return dcnl dcsp for i in range 0 len pieces 1 3 dcnl dcsp dcsp first lang priority piecesi i + 3 dcnl dcsp dcsp if first dcnl dcsp dcsp dcsp return dcnl dcsp dcsp if priority dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp priority float priority dcnl dcsp dcsp dcsp except valueerror dcnl dcsp dcsp dcsp dcsp return dcnl dcsp dcsp if not priority dcnl dcsp dcsp dcsp priority 1 0 dcnl dcsp dcsp result append lang priority dcnl dcsp result sort key lambda k k1 reverse true dcnl dcsp result k for k v in result dcnl dcsp return result
def on revision save sender instance kwargs dcsp rev instance dcnl dcsp year rev created year dcnl dcsp creator rev creator dcnl dcsp if not rev is approved dcnl dcsp dcsp return dcnl dcsp if rev document locale settings wiki default language dcnl dcsp dcsp badge template wiki badges kbbadge dcnl dcsp else dcnl dcsp dcsp badge template wiki badges l10nbadge dcnl dcsp from kitsune wiki tasks import maybe award badge dcnl dcsp maybe award badge delay badge template year creator
cronjobs register dcnl def update top contributors dcsp top25 ids x user id for x in top contributors questions count 25 0 dcnl dcsp title objects set top10 contributors top25 ids 10 dcnl dcsp title objects set top25 contributors top25 ids10 25
library global function dcnl def karma titles user dcsp return title objects filter q users user | q groups in user groups all distinct
task rate limit 4 s dcnl timeit dcnl def update question vote chunk data dcsp log info calculating dcsp past dcsp week dcsp votes dcsp for dcsp s dcsp questions len data dcnl dcsp ids join map str data dcnl dcsp sql n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp update dcsp questions question dcsp q n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp set dcsp num votes past week dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp select dcsp count created n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp from dcsp questions questionvote dcsp qv n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp qv question id dcsp dcsp q id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp and dcsp qv created dcsp dcsp date subdate now dcsp 7 n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp q id dcsp in dcsp s n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp ids dcnl dcsp cursor connection cursor dcnl dcsp cursor execute sql dcnl dcsp if not transaction get connection in atomic block dcnl dcsp dcsp transaction commit dcnl dcsp if data and settings es live indexing dcnl dcsp dcsp sql n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp select dcsp id dcsp num votes past week n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp from dcsp questions question n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp id dcsp in dcsp s n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp ids dcnl dcsp dcsp cursor connection cursor dcnl dcsp dcsp cursor execute sql dcnl dcsp dcsp id to num dict cursor fetchall dcnl dcsp dcsp try dcnl dcsp dcsp dcsp from kitsune questions models import questionmappingtype dcnl dcsp dcsp dcsp from kitsune search import es utils dcnl dcsp dcsp dcsp es docs es utils get documents questionmappingtype data dcnl dcsp dcsp dcsp for doc in es docs dcnl dcsp dcsp dcsp dcsp num id to numint docu id dcnl dcsp dcsp dcsp dcsp docu question num votes past week num dcnl dcsp dcsp dcsp dcsp questionmappingtype index doc id doc id dcnl dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp index task delay questionmappingtype id to num keys
task dcnl timeit dcnl def maybe award badge badge template year user dcsp badge get or create badge badge template year dcnl dcsp if badge is awarded to user dcnl dcsp dcsp return dcnl dcsp from kitsune questions models import answer dcnl dcsp qs answer objects filter creator user created gte date year 1 1 created lt date year + 1 1 1 dcnl dcsp if qs count 30 dcnl dcsp dcsp badge award to user dcnl dcsp dcsp return true
task dcnl timeit dcnl def escalate question question id dcsp from kitsune questions models import question dcnl dcsp question question objects get id question id dcnl dcsp url https domain url format domain site objects get current domain url question get absolute url dcnl dcsp try dcnl dcsp dcsp submit ticket email support mozilla com category escalated subject u escalated dcsp title format title question title body u url n n content format url url content question content tags t slug for t in question tags all dcnl dcsp except zendeskerror dcnl dcsp dcsp raise pickleablezendeskerror
cronjobs register dcnl def update weekly votes dcsp recent datetime now timedelta days 7 dcnl dcsp q questionvote objects filter created gte recent dcnl dcsp q q values list question id flat true order by question dcnl dcsp q q distinct dcnl dcsp q with recent votes list q dcnl dcsp q question objects filter num votes past week gt 0 dcnl dcsp q q values list id flat true dcnl dcsp q with nonzero votes list q dcnl dcsp qs to update list set q with recent votes + q with nonzero votes dcnl dcsp for chunk in chunked qs to update 50 dcnl dcsp dcsp update question vote chunk apply async args chunk
cronjobs register dcnl def auto archive old questions dcsp logging basicconfig level logging error dcnl dcsp days 180 datetime now timedelta days 180 dcnl dcsp q ids list question objects filter is archived false filter created lte days 180 values list id flat true dcnl dcsp if q ids dcnl dcsp dcsp log info updating dcsp d dcsp questions len q ids dcnl dcsp dcsp sql n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp update dcsp questions question n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp set dcsp is archived dcsp dcsp 1 n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp id dcsp in dcsp s n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp join map str q ids dcnl dcsp dcsp cursor connection cursor dcnl dcsp dcsp cursor execute sql dcnl dcsp dcsp if not transaction get connection in atomic block dcnl dcsp dcsp dcsp transaction commit dcnl dcsp dcsp if settings es live indexing dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp from kitsune search utils import chunked dcnl dcsp dcsp dcsp dcsp for chunk in chunked q ids 100 dcnl dcsp dcsp dcsp dcsp dcsp es docs get documents questionmappingtype chunk dcnl dcsp dcsp dcsp dcsp dcsp log info updating dcsp d dcsp index dcsp documents len es docs dcnl dcsp dcsp dcsp dcsp dcsp documents dcnl dcsp dcsp dcsp dcsp dcsp for doc in es docs dcnl dcsp dcsp dcsp dcsp dcsp dcsp docu question is archived true dcnl dcsp dcsp dcsp dcsp dcsp dcsp docu indexed on int time time dcnl dcsp dcsp dcsp dcsp dcsp dcsp documents append doc dcnl dcsp dcsp dcsp dcsp dcsp questionmappingtype bulk index documents dcnl dcsp dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp dcsp index task delay questionmappingtype q ids
cronjobs register dcnl def reload question traffic stats dcsp if settings stage dcnl dcsp dcsp return dcnl dcsp questionvisits reload from analytics verbose settings debug
cronjobs register dcnl def escalate questions dcsp if settings stage dcnl dcsp dcsp return dcnl dcsp qs question objects needs attention exclude tags slug in config escalate tag name dcnl dcsp qs qs filter locale settings wiki default language dcnl dcsp qs qs exclude product slug in config escalate exclude products dcnl dcsp qs qs exclude creator is active false dcnl dcsp start datetime now timedelta hours 24 dcnl dcsp end datetime now timedelta hours 25 dcnl dcsp qs no replies yet qs filter last answer isnull true created lt start created gt end dcnl dcsp for question in qs no replies yet dcnl dcsp dcsp escalate question delay question id dcnl dcsp return len qs no replies yet
cronjobs register dcnl def report employee answers dcsp tracked group group objects get name support dcsp forum dcsp tracked dcnl dcsp report group group objects get name support dcsp forum dcsp metrics dcnl dcsp tracked users tracked group user set all dcnl dcsp report recipients report group user set all dcnl dcsp if len tracked users 0 or len report recipients 0 dcnl dcsp dcsp return dcnl dcsp yesterday date today timedelta days 1 dcnl dcsp day before yesterday yesterday timedelta days 1 dcnl dcsp questions question objects filter creator is active true created gte day before yesterday created lt yesterday dcnl dcsp num questions questions count dcnl dcsp num answered questions filter num answers gt 0 count dcnl dcsp num answered by tracked dcnl dcsp for user in tracked users dcnl dcsp dcsp num answered by trackeduser username answer objects filter question in questions creator user values list question id distinct count dcnl dcsp email subject support dcsp forum dcsp answered dcsp report dcsp for dcsp date format date day before yesterday dcnl dcsp email body tmpl textwrap dedent dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp date dcsp date n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp number dcsp of dcsp questions dcsp asked dcsp num questions n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp number dcsp of dcsp questions dcsp answered dcsp num answered n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp email body email body tmpl format date day before yesterday num questions num questions num answered num answered dcnl dcsp for username count in num answered by tracked items dcnl dcsp dcsp email body + number dcsp of dcsp questions dcsp answered dcsp by dcsp username dcsp count n format username username count count dcnl dcsp email addresses u email for u in report recipients dcnl dcsp send mail email subject email body settings tidings from address email addresses fail silently false
def add backtrack keys products dcsp for p k p v in products iteritems dcnl dcsp dcsp p v key p k dcnl dcsp dcsp for c k c v in p v categories iteritems dcnl dcsp dcsp dcsp c v key c k
def num questions user dcsp return question objects filter creator user count
def num answers user dcsp return answer objects filter creator user count
def num solutions user dcsp return question objects filter solution creator user count
def mark content as spam user by user dcsp for question in question objects filter creator user dcnl dcsp dcsp question mark as spam by user dcnl dcsp for answer in answer objects filter creator user dcnl dcsp dcsp answer mark as spam by user
def add tag url question id dcsp return reverse questions add tag kwargs question id question id
def add async tag url question id dcsp return reverse questions add tag async kwargs question id question id
def remove tag url question id dcsp return reverse questions remove tag kwargs question id question id
def remove async tag url question id dcsp return reverse questions remove tag async kwargs question id question id
def tags eq tagged object tag names dcsp eq sorted t name for t in tagged object tags all sorted tag names
def tag added sender question id tag name kwargs dcsp if tag name config escalate tag name dcnl dcsp dcsp escalate question delay question id
def reindex questions answers sender instance kw dcsp if instance id dcnl dcsp dcsp answer ids instance answers all values list id flat true dcnl dcsp dcsp index task delay answermetricsmappingtype list answer ids
def user pre save sender instance kw dcsp if instance id dcnl dcsp dcsp user user objects get id instance id dcnl dcsp dcsp if user username instance username dcnl dcsp dcsp dcsp questions question objects filter q creator instance | q answers creator instance only id distinct dcnl dcsp dcsp dcsp for q in questions dcnl dcsp dcsp dcsp dcsp q index later
def tenths version full version dcsp match tenths version pattern match full version dcnl dcsp if match dcnl dcsp dcsp return match group 1 dcnl dcsp return
def has beta version dev releases dcsp return version in re search d+ + d+ s group 0 for s in dev releases keys
mobile template questions mobile product list html dcnl def product list request template dcsp return render request template products product objects filter questions locales locale request language code
mobile template questions mobile question list html dcnl def question list request template product slug dcsp filter request get get filter dcnl dcsp owner request get get owner request session get questions owner all dcnl dcsp show request get get show dcnl dcsp if show not in filter groups dcnl dcsp dcsp show needsattention dcnl dcsp escalated request get get escalated dcnl dcsp tagged request get get tagged dcnl dcsp tags none dcnl dcsp topic slug request get get topic dcnl dcsp order request get get order updated dcnl dcsp if order not in order by dcnl dcsp dcsp order updated dcnl dcsp sort request get get sort desc dcnl dcsp product slugs product slug split dcnl dcsp products dcnl dcsp if len product slugs 1 or product slugs0 all dcnl dcsp dcsp for slug in product slugs dcnl dcsp dcsp dcsp products append get object or 404 product slug slug dcnl dcsp dcsp multiple len products 1 dcnl dcsp else dcnl dcsp dcsp products none dcnl dcsp dcsp multiple true dcnl dcsp if topic slug and not multiple dcnl dcsp dcsp try dcnl dcsp dcsp dcsp topic topic objects get slug topic slug product products0 dcnl dcsp dcsp except topic doesnotexist dcnl dcsp dcsp dcsp topic none dcnl dcsp else dcnl dcsp dcsp topic none dcnl dcsp question qs question objects dcnl dcsp if filter not in filter groupsshow dcnl dcsp dcsp filter none dcnl dcsp if escalated dcnl dcsp dcsp filter none dcnl dcsp if filter new dcnl dcsp dcsp question qs question qs new dcnl dcsp elif filter unhelpfulanswers dcnl dcsp dcsp question qs question qs unhelpful answers dcnl dcsp elif filter needsinfo dcnl dcsp dcsp question qs question qs needs info dcnl dcsp elif filter solutionprovided dcnl dcsp dcsp question qs question qs solution provided dcnl dcsp elif filter solved dcnl dcsp dcsp question qs question qs solved dcnl dcsp elif filter locked dcnl dcsp dcsp question qs question qs locked dcnl dcsp elif filter recentlyunanswered dcnl dcsp dcsp question qs question qs recently unanswered dcnl dcsp else dcnl dcsp dcsp if show needsattention dcnl dcsp dcsp dcsp question qs question qs needs attention dcnl dcsp dcsp if show responded dcnl dcsp dcsp dcsp question qs question qs responded dcnl dcsp dcsp if show done dcnl dcsp dcsp dcsp question qs question qs done dcnl dcsp if escalated dcnl dcsp dcsp question qs question qs filter tags name in config escalate tag name dcnl dcsp question qs question qs select related creator last answer last answer creator dcnl dcsp question qs question qs prefetch related topic topic product dcnl dcsp question qs question qs filter creator is active 1 dcnl dcsp if not request user has perm flagit can moderate dcnl dcsp dcsp question qs question qs filter is spam false dcnl dcsp if owner mine and request user is authenticated dcnl dcsp dcsp criteria q answers creator request user | q creator request user dcnl dcsp dcsp question qs question qs filter criteria distinct dcnl dcsp else dcnl dcsp dcsp owner none dcnl dcsp feed urls urlparams reverse questions feed product product slug topic topic slug questionsfeed title dcnl dcsp if tagged dcnl dcsp dcsp tag slugs tagged split dcnl dcsp dcsp tags tag objects filter slug in tag slugs dcnl dcsp dcsp if tags dcnl dcsp dcsp dcsp for t in tags dcnl dcsp dcsp dcsp dcsp question qs question qs filter tags name in t name dcnl dcsp dcsp dcsp if len tags 1 dcnl dcsp dcsp dcsp dcsp feed urls + reverse questions tagged feed args tags0 slug taggedquestionsfeed title tags0 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp question qs question objects none dcnl dcsp oldest date date today timedelta days 90 dcnl dcsp question qs question qs exclude created lt oldest date num answers 0 dcnl dcsp if products dcnl dcsp dcsp question qs question qs filter product in products distinct dcnl dcsp if topic dcnl dcsp dcsp question qs question qs filter topic id topic id dcnl dcsp if request language code in questionlocale objects locales list dcnl dcsp dcsp forum locale request language code dcnl dcsp dcsp locale query q locale request language code dcnl dcsp else dcnl dcsp dcsp forum locale settings wiki default language dcnl dcsp dcsp locale query q locale request language code dcnl dcsp dcsp locale query | q locale settings wiki default language dcnl dcsp question qs question qs filter locale query dcnl dcsp order by order byorder0 dcnl dcsp question qs question qs order by order by if sort asc else s order by dcnl dcsp try dcnl dcsp dcsp with statsd timer questions view paginate s filter dcnl dcsp dcsp dcsp questions page simple paginate request question qs per page config questions per page dcnl dcsp except pagenotaninteger emptypage dcnl dcsp dcsp if request get get page 1 1 dcnl dcsp dcsp dcsp url build paged url request dcnl dcsp dcsp dcsp return httpresponseredirect urlparams url page 1 dcnl dcsp extra filters locale query dcnl dcsp if products dcnl dcsp dcsp extra filters q product in products dcnl dcsp recent asked count question recent asked count extra filters dcnl dcsp recent unanswered count question recent unanswered count extra filters dcnl dcsp if recent asked count dcnl dcsp dcsp recent answered percent int float recent asked count recent unanswered count recent asked count 100 dcnl dcsp else dcnl dcsp dcsp recent answered percent 0 dcnl dcsp product list product objects filter visible true dcnl dcsp if products and not multiple dcnl dcsp dcsp topic list topic objects filter visible true product products0 10 dcnl dcsp else dcnl dcsp dcsp topic list dcnl dcsp if request user is authenticated dcnl dcsp dcsp request session questions owner owner dcnl dcsp if products and len products 1 dcnl dcsp dcsp product products0 dcnl dcsp else dcnl dcsp dcsp product none dcnl dcsp try dcnl dcsp dcsp top contributors top contributors questions locale forum locale product product dcnl dcsp except es exceptions dcnl dcsp dcsp top contributors dcnl dcsp dcsp statsd incr questions topcontributors eserror dcnl dcsp dcsp log exception support dcsp forum dcsp top dcsp contributors dcsp query dcsp failed dcnl dcsp data questions questions page feeds feed urls filter filter owner owner show show filters filter groupsshow order order orders order by sort sort escalated escalated tags tags tagged tagged recent asked count recent asked count recent unanswered count recent unanswered count recent answered percent recent answered percent product list product list products products product slug product slug multiple products multiple all products product slug all top contributors top contributors topic list topic list topic topic dcnl dcsp with statsd timer questions view render dcnl dcsp dcsp return render request template data
def parse troubleshooting troubleshooting json dcsp if not troubleshooting json dcnl dcsp dcsp return none dcnl dcsp try dcnl dcsp dcsp parsed json loads troubleshooting json dcnl dcsp except valueerror dcnl dcsp dcsp return none dcnl dcsp spec dict accessibility dict accessibility isactive bool application dict application name basestring application supporturl basestring application useragent basestring application version basestring extensions list graphics dict javascript dict modifiedpreferences dict userjs dict userjs exists bool dcnl dcsp for path type in spec dcnl dcsp dcsp item parsed dcnl dcsp dcsp for piece in path dcnl dcsp dcsp dcsp item item get piece dcnl dcsp dcsp dcsp if item is none dcnl dcsp dcsp dcsp dcsp return none dcnl dcsp dcsp if not isinstance item type dcnl dcsp dcsp dcsp return none dcnl dcsp parsed modifiedpreferences dict key val for key val in parsed modifiedpreferences items if not key startswith print dcnl dcsp return parsed
mobile template questions mobile question details html dcnl anonymous csrf dcnl def question details request template question id form none watch form none answer preview none extra kwargs dcsp ans answers data request question id form watch form answer preview dcnl dcsp question ans question dcnl dcsp if question is spam and not request user has perm flagit can moderate dcnl dcsp dcsp raise http404 no dcsp question dcsp matches dcsp the dcsp given dcsp query dcnl dcsp troubleshooting json question metadata get troubleshooting dcnl dcsp question metadata troubleshooting parsed parse troubleshooting troubleshooting json dcnl dcsp if request user is authenticated dcnl dcsp dcsp ct contenttype objects get for model request user dcnl dcsp dcsp ans images imageattachment objects filter creator request user content type ct dcnl dcsp extra kwargs update ans dcnl dcsp products product objects filter visible true dcnl dcsp topics topics for product question product dcnl dcsp related documents question related documents dcnl dcsp related questions question related questions dcnl dcsp extra kwargs update all products products all topics topics product question product topic question topic related documents related documents related questions related questions dcnl dcsp if not request mobile dcnl dcsp dcsp if not question solution id dcnl dcsp dcsp dcsp extra kwargs update robots noindex true dcnl dcsp return render request template extra kwargs
ssl required dcnl mobile template questions mobile new question html dcnl anonymous csrf dcnl def aaq request product key none category key none showform false template none step 0 dcsp if waffle flag is active request new aaq dcnl dcsp dcsp return aaq react request dcnl dcsp request session inaaq true dcnl dcsp if request language code not in questionlocale objects locales list and request language code settings wiki default language dcnl dcsp dcsp locale path split path request path dcnl dcsp dcsp path + settings wiki default language + + path dcnl dcsp dcsp old lang settings languages dictrequest language code lower dcnl dcsp dcsp new lang settings languages dictsettings wiki default language lower dcnl dcsp dcsp msg u the dcsp questions dcsp forum dcsp isn t dcsp available dcsp in dcsp old lang dcsp we dcsp have dcsp redirected dcsp you dcsp to dcsp the dcsp new lang dcsp questions dcsp forum format old lang old lang new lang new lang dcnl dcsp dcsp messages add message request messages warning msg dcnl dcsp dcsp return httpresponseredirect path dcnl dcsp if product key is none dcnl dcsp dcsp product key request get get product dcnl dcsp dcsp if request mobile and product key is none dcnl dcsp dcsp dcsp ua request meta get http user agent lower dcnl dcsp dcsp dcsp if firefox in ua and android not in ua dcnl dcsp dcsp dcsp dcsp product key firefoxos dcnl dcsp dcsp dcsp elif fxios in ua dcnl dcsp dcsp dcsp dcsp product key ios dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp product key mobile dcnl dcsp product config config products get product key dcnl dcsp if product key and not product config dcnl dcsp dcsp raise http404 dcnl dcsp if product config and product in product config dcnl dcsp dcsp try dcnl dcsp dcsp dcsp product product objects get slug product config product dcnl dcsp dcsp except product doesnotexist dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp else dcnl dcsp dcsp dcsp if not product questions locales filter locale request language code count dcnl dcsp dcsp dcsp dcsp locale path split path request path dcnl dcsp dcsp dcsp dcsp path + settings wiki default language + + path dcnl dcsp dcsp dcsp dcsp old lang settings languages dictrequest language code lower dcnl dcsp dcsp dcsp dcsp new lang settings languages dictsettings wiki default language lower dcnl dcsp dcsp dcsp dcsp msg u the dcsp questions dcsp forum dcsp isn t dcsp available dcsp for dcsp product dcsp in dcsp old lang dcsp we dcsp have dcsp redirected dcsp you dcsp to dcsp the dcsp new lang dcsp questions dcsp forum format product product title old lang old lang new lang new lang dcnl dcsp dcsp dcsp dcsp messages add message request messages warning msg dcnl dcsp dcsp dcsp dcsp return httpresponseredirect path dcnl dcsp if category key is none dcnl dcsp dcsp category key request get get category dcnl dcsp if product config and category key dcnl dcsp dcsp product obj product objects get slug product config get product dcnl dcsp dcsp category config product config categories get category key dcnl dcsp dcsp if not category config dcnl dcsp dcsp dcsp return httpresponseredirect reverse questions aaq step2 args product key dcnl dcsp dcsp deadend category config get deadend false dcnl dcsp dcsp topic category config get topic dcnl dcsp dcsp if topic dcnl dcsp dcsp dcsp html none dcnl dcsp dcsp dcsp articles fallback documents for locale request language code products product obj topics topic objects get slug topic product product obj dcnl dcsp dcsp else dcnl dcsp dcsp dcsp html category config get html dcnl dcsp dcsp dcsp articles category config get articles dcnl dcsp else dcnl dcsp dcsp category config none dcnl dcsp dcsp deadend product config get deadend false if product config else false dcnl dcsp dcsp html product config get html if product config else none dcnl dcsp dcsp articles none dcnl dcsp dcsp if product config dcnl dcsp dcsp dcsp statsd incr questions aaq selectcategory dcnl dcsp dcsp else dcnl dcsp dcsp dcsp statsd incr questions aaq selectproduct dcnl dcsp if request mobile dcnl dcsp dcsp login t questions mobile new question login html dcnl dcsp else dcnl dcsp dcsp login t questions new question login html dcnl dcsp if request method get dcnl dcsp dcsp search request get get search dcnl dcsp dcsp if search dcnl dcsp dcsp dcsp results search suggestions request search locale or default request language code product config get product dcnl dcsp dcsp dcsp tried search true dcnl dcsp dcsp else dcnl dcsp dcsp dcsp results dcnl dcsp dcsp dcsp tried search false dcnl dcsp dcsp dcsp if category config dcnl dcsp dcsp dcsp dcsp statsd incr questions aaq searchform dcnl dcsp dcsp if showform or request get get showform dcnl dcsp dcsp dcsp if not request user is authenticated dcnl dcsp dcsp dcsp dcsp statsd incr questions aaq loginorregister dcnl dcsp dcsp dcsp dcsp login form authenticationform dcnl dcsp dcsp dcsp dcsp register form registerform dcnl dcsp dcsp dcsp dcsp return render request login t product product config category category config title search register form register form login form login form dcnl dcsp dcsp dcsp form newquestionform product product config category category config initial title search dcnl dcsp dcsp dcsp statsd incr questions aaq detailsform dcnl dcsp dcsp else dcnl dcsp dcsp dcsp form none dcnl dcsp dcsp dcsp if search dcnl dcsp dcsp dcsp dcsp statsd incr questions aaq suggestions dcnl dcsp dcsp return render request template form form results results tried search tried search products config products current product product config current category category config current html html current articles articles current step step deadend deadend host site objects get current domain dcnl dcsp if not request user is authenticated dcnl dcsp dcsp if request post get login dcnl dcsp dcsp dcsp login form handle login request only active false dcnl dcsp dcsp dcsp statsd incr questions user login dcnl dcsp dcsp dcsp register form registerform dcnl dcsp dcsp dcsp if login form is valid dcnl dcsp dcsp dcsp dcsp statsd incr questions user login success dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp statsd incr questions user login fail dcnl dcsp dcsp elif request post get register dcnl dcsp dcsp dcsp login form authenticationform dcnl dcsp dcsp dcsp register form handle register request request text template users email activate ltxt html template users email activate html subject please dcsp confirm dcsp your dcsp firefox dcsp help dcsp question email data request get get search reg aaq dcnl dcsp dcsp dcsp if register form is valid dcnl dcsp dcsp dcsp dcsp user auth authenticate username request post get username password request post get password dcnl dcsp dcsp dcsp dcsp auth login request user dcnl dcsp dcsp dcsp dcsp statsd incr questions user register dcnl dcsp dcsp else dcnl dcsp dcsp dcsp message lazy request dcsp type dcsp not dcsp recognized dcnl dcsp dcsp dcsp return render request handlers 400 html message message status 400 dcnl dcsp dcsp if request user is authenticated dcnl dcsp dcsp dcsp url urlparams request get full path step aaqquestion dcnl dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return render request login t product product config category category config title request post get title register form register form login form login form dcnl dcsp form newquestionform product product config category category config data request post dcnl dcsp if upload image in request post dcnl dcsp dcsp upload imageattachment request request user dcnl dcsp user ct contenttype objects get for model request user dcnl dcsp if form is valid and not is ratelimited request aaqday 5 d dcnl dcsp dcsp question question creator request user title form cleaned data title content form cleaned data content locale request language code dcnl dcsp dcsp if product obj dcnl dcsp dcsp dcsp question product product obj dcnl dcsp dcsp if category config dcnl dcsp dcsp dcsp t category config get topic dcnl dcsp dcsp dcsp if t dcnl dcsp dcsp dcsp dcsp question topic topic objects get slug t product product obj dcnl dcsp dcsp question save dcnl dcsp dcsp qst ct contenttype objects get for model question dcnl dcsp dcsp up images imageattachment objects filter creator request user content type user ct dcnl dcsp dcsp up images update content type qst ct object id question id dcnl dcsp dcsp statsd incr questions new dcnl dcsp dcsp question add metadata form cleaned metadata dcnl dcsp dcsp if product config dcnl dcsp dcsp dcsp question add metadata product product config key dcnl dcsp dcsp if category config dcnl dcsp dcsp dcsp question add metadata category category config key dcnl dcsp dcsp question auto tag dcnl dcsp dcsp question vote request question id dcnl dcsp dcsp if request user is active dcnl dcsp dcsp dcsp messages add message request messages success done dcsp your dcsp question dcsp is dcsp now dcsp posted dcsp on dcsp the dcsp mozilla dcsp community dcsp support dcsp forum dcnl dcsp dcsp dcsp request session inaaq false dcnl dcsp dcsp dcsp url reverse questions details kwargs question id question id dcnl dcsp dcsp dcsp return httpresponseredirect url dcnl dcsp dcsp return httpresponseredirect reverse questions aaq confirm dcnl dcsp if getattr request limited false dcnl dcsp dcsp raise permissiondenied dcnl dcsp images imageattachment objects filter creator request user content type user ct dcnl dcsp statsd incr questions aaq detailsformerror dcnl dcsp return render request template form form images images products config products current product product config current category category config current articles articles
ssl required dcnl def aaq step2 request product key dcsp return aaq request product key product key step 1
ssl required dcnl def aaq step3 request product key category key dcsp return aaq request product key product key category key category key step 1
ssl required dcnl def aaq step4 request product key category key dcsp return aaq request product key product key category key category key step 1
ssl required dcnl def aaq step5 request product key category key dcsp return aaq request product key product key category key category key showform true step 3
def aaq confirm request dcsp if request user is authenticated dcnl dcsp dcsp email request user email dcnl dcsp dcsp auth logout request dcnl dcsp dcsp statsd incr questions user logout dcnl dcsp else dcnl dcsp dcsp email none dcnl dcsp request session inaaq false dcnl dcsp confirm t questions mobile confirm email html if request mobile else questions confirm email html dcnl dcsp return render request confirm t email email
require http methods get post dcnl login required dcnl def edit question request question id dcsp question get object or 404 question pk question id dcnl dcsp user request user dcnl dcsp if not question allows edit user dcnl dcsp dcsp raise permissiondenied dcnl dcsp ct contenttype objects get for model question dcnl dcsp images imageattachment objects filter content type ct object id question pk dcnl dcsp if request method get dcnl dcsp dcsp initial question metadata copy dcnl dcsp dcsp initial update title question title content question content dcnl dcsp dcsp form editquestionform product question product config category question category config initial initial dcnl dcsp else dcnl dcsp dcsp form editquestionform data request post product question product config category question category config dcnl dcsp dcsp upload imageattachment request question dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp question title form cleaned data title dcnl dcsp dcsp dcsp question content form cleaned data content dcnl dcsp dcsp dcsp question updated by user dcnl dcsp dcsp dcsp question save dcnl dcsp dcsp dcsp question clear mutable metadata dcnl dcsp dcsp dcsp question add metadata form cleaned metadata dcnl dcsp dcsp dcsp return httpresponseredirect reverse questions details kwargs question id question id dcnl dcsp return render request questions edit question html question question form form images images current product question product config current category question category config
def skip answer ratelimit request dcsp return delete images in request post or upload image in request post
require post dcnl login required dcnl ratelimit answermin 4 m skip if skip answer ratelimit dcnl ratelimit answerday 100 d skip if skip answer ratelimit dcnl def reply request question id dcsp question get object or 404 question pk question id is spam false dcnl dcsp answer preview none dcnl dcsp if not question allows new answer request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp form answerform request post dcnl dcsp if delete images in request post dcnl dcsp dcsp for image id in request post getlist delete image dcnl dcsp dcsp dcsp imageattachment objects get pk image id delete dcnl dcsp dcsp return question details request question id question id form form dcnl dcsp if upload image in request post dcnl dcsp dcsp upload imageattachment request request user dcnl dcsp dcsp return question details request question id question id form form dcnl dcsp if form is valid and not request limited dcnl dcsp dcsp answer answer question question creator request user content form cleaned data content dcnl dcsp dcsp if preview in request post dcnl dcsp dcsp dcsp answer preview answer dcnl dcsp dcsp else dcnl dcsp dcsp dcsp answer save dcnl dcsp dcsp dcsp ans ct contenttype objects get for model answer dcnl dcsp dcsp dcsp user ct contenttype objects get for model request user dcnl dcsp dcsp dcsp up images imageattachment objects filter creator request user content type user ct dcnl dcsp dcsp dcsp up images update content type ans ct object id answer id dcnl dcsp dcsp dcsp statsd incr questions answer dcnl dcsp dcsp dcsp if needsinfo in request post dcnl dcsp dcsp dcsp dcsp question set needs info dcnl dcsp dcsp dcsp elif clear needsinfo in request post dcnl dcsp dcsp dcsp dcsp question unset needs info dcnl dcsp dcsp dcsp if setting get for user request user questions watch after reply dcnl dcsp dcsp dcsp dcsp questionreplyevent notify request user question dcnl dcsp dcsp dcsp return httpresponseredirect answer get absolute url dcnl dcsp return question details request question id question id form form answer preview answer preview
def solve request question id answer id dcsp question get object or 404 question pk question id is spam false dcnl dcsp if not request user is authenticated dcnl dcsp dcsp watch secret request get get watch none dcnl dcsp dcsp try dcnl dcsp dcsp dcsp watch watch objects get secret watch secret event type question dcsp reply user question creator dcnl dcsp dcsp dcsp distinguishable letters abcdefghjkmnpqrstuvwxyzabcdefghjklmnpqrtuvwxyz dcnl dcsp dcsp dcsp new secret join random choice distinguishable letters for x in xrange 10 dcnl dcsp dcsp dcsp watch update secret new secret dcnl dcsp dcsp dcsp request user question creator dcnl dcsp dcsp except watch doesnotexist dcnl dcsp dcsp dcsp return httpresponseforbidden dcnl dcsp answer get object or 404 answer pk answer id is spam false dcnl dcsp if not question allows solve request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp if question creator request user and not request user has perm questions change solution dcnl dcsp dcsp return httpresponseforbidden dcnl dcsp if not question solution dcnl dcsp dcsp question set solution answer request user dcnl dcsp dcsp messages add message request messages success thank dcsp you dcsp for dcsp choosing dcsp a dcsp solution dcnl dcsp else dcnl dcsp dcsp messages add message request messages error this dcsp question dcsp already dcsp has dcsp a dcsp solution dcnl dcsp return httpresponseredirect question get absolute url
require post dcnl login required dcnl def unsolve request question id answer id dcsp question get object or 404 question pk question id dcnl dcsp get object or 404 answer pk answer id dcnl dcsp if not question allows unsolve request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp if question creator request user and not request user has perm questions change solution dcnl dcsp dcsp return httpresponseforbidden dcnl dcsp question solution none dcnl dcsp question save dcnl dcsp question remove metadata solver id dcnl dcsp statsd incr questions unsolve dcnl dcsp messages add message request messages success the dcsp solution dcsp was dcsp undone dcsp successfully dcnl dcsp return httpresponseredirect question get absolute url
require post dcnl csrf exempt dcnl ratelimit questionvote 10 d dcnl def question vote request question id dcsp question get object or 404 question pk question id is spam false dcnl dcsp if not question editable dcnl dcsp dcsp raise permissiondenied dcnl dcsp if not question has voted request dcnl dcsp dcsp vote questionvote question question dcnl dcsp dcsp if request user is authenticated dcnl dcsp dcsp dcsp vote creator request user dcnl dcsp dcsp else dcnl dcsp dcsp dcsp vote anonymous id request anonymous anonymous id dcnl dcsp dcsp if not request limited dcnl dcsp dcsp dcsp vote save dcnl dcsp dcsp dcsp if referrer in request request dcnl dcsp dcsp dcsp dcsp referrer request request get referrer dcnl dcsp dcsp dcsp dcsp vote add metadata referrer referrer dcnl dcsp dcsp dcsp dcsp if referrer search and query in request request dcnl dcsp dcsp dcsp dcsp dcsp vote add metadata query request request get query dcnl dcsp dcsp dcsp ua request meta get http user agent dcnl dcsp dcsp dcsp if ua dcnl dcsp dcsp dcsp dcsp vote add metadata ua ua dcnl dcsp dcsp dcsp statsd incr questions votes question dcnl dcsp dcsp if request is ajax dcnl dcsp dcsp dcsp tmpl questions includes question vote thanks html dcnl dcsp dcsp dcsp form init watch form request dcnl dcsp dcsp dcsp html render to string tmpl question question user request user watch form form dcnl dcsp dcsp dcsp return httpresponse json dumps html html ignored request limited dcnl dcsp return httpresponseredirect question get absolute url
csrf exempt dcnl ratelimit answervote 10 d dcnl def answer vote request question id answer id dcsp answer get object or 404 answer pk answer id question question id is spam false question is spam false dcnl dcsp if not answer question editable dcnl dcsp dcsp raise permissiondenied dcnl dcsp if request limited dcnl dcsp dcsp if request is ajax dcnl dcsp dcsp dcsp return httpresponse json dumps ignored true dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return httpresponseredirect answer get absolute url dcnl dcsp if not answer has voted request dcnl dcsp dcsp vote answervote answer answer dcnl dcsp dcsp if helpful in request request dcnl dcsp dcsp dcsp vote helpful true dcnl dcsp dcsp dcsp message glad dcsp to dcsp hear dcsp it dcnl dcsp dcsp else dcnl dcsp dcsp dcsp message sorry dcsp to dcsp hear dcsp that dcnl dcsp dcsp if request user is authenticated dcnl dcsp dcsp dcsp vote creator request user dcnl dcsp dcsp else dcnl dcsp dcsp dcsp vote anonymous id request anonymous anonymous id dcnl dcsp dcsp vote save dcnl dcsp dcsp if referrer in request request dcnl dcsp dcsp dcsp referrer request request get referrer dcnl dcsp dcsp dcsp vote add metadata referrer referrer dcnl dcsp dcsp dcsp if referrer search and query in request request dcnl dcsp dcsp dcsp dcsp vote add metadata query request request get query dcnl dcsp dcsp ua request meta get http user agent dcnl dcsp dcsp if ua dcnl dcsp dcsp dcsp vote add metadata ua ua dcnl dcsp dcsp statsd incr questions votes answer dcnl dcsp else dcnl dcsp dcsp message you dcsp already dcsp voted dcsp on dcsp this dcsp reply dcnl dcsp if request is ajax dcnl dcsp dcsp return httpresponse json dumps message message dcnl dcsp return httpresponseredirect answer get absolute url
permission required questions tag question dcnl def add tag request question id dcsp if request method get dcnl dcsp dcsp return httpresponseredirect reverse questions details args question id dcnl dcsp try dcnl dcsp dcsp question canonical name add tag request question id dcnl dcsp except tag doesnotexist dcnl dcsp dcsp template data answers data request question id dcnl dcsp dcsp template data tag adding error unapproved tag dcnl dcsp dcsp template data tag adding value request post get tagname dcnl dcsp dcsp return render request questions question details html template data dcnl dcsp if canonical name dcnl dcsp dcsp question clear cached tags dcnl dcsp dcsp return httpresponseredirect reverse questions details args question id dcnl dcsp template data answers data request question id dcnl dcsp template data tag adding error no tag dcnl dcsp return render request questions question details html template data
permission required questions tag question dcnl require post dcnl def add tag async request question id dcsp try dcnl dcsp dcsp question canonical name add tag request question id dcnl dcsp except tag doesnotexist dcnl dcsp dcsp return httpresponse json dumps error unicode unapproved tag content type application json status 400 dcnl dcsp if canonical name dcnl dcsp dcsp question clear cached tags dcnl dcsp dcsp tag tag objects get name canonical name dcnl dcsp dcsp tag url urlparams reverse questions list args question product slug tagged tag slug dcnl dcsp dcsp data canonicalname canonical name tagurl tag url dcnl dcsp dcsp return httpresponse json dumps data content type application json dcnl dcsp return httpresponse json dumps error unicode no tag content type application json status 400
permission required questions tag question dcnl require post dcnl def remove tag request question id dcsp prefix removetag dcnl dcsp names k for k in request post if k startswith prefix dcnl dcsp if names dcnl dcsp dcsp name names0len prefix dcnl dcsp dcsp question get object or 404 question pk question id dcnl dcsp dcsp question tags remove name dcnl dcsp dcsp question clear cached tags dcnl dcsp return httpresponseredirect reverse questions details args question id
permission required questions tag question dcnl require post dcnl def remove tag async request question id dcsp name request post get name dcnl dcsp if name dcnl dcsp dcsp question get object or 404 question pk question id dcnl dcsp dcsp question tags remove name dcnl dcsp dcsp question clear cached tags dcnl dcsp dcsp return httpresponse content type application json dcnl dcsp return httpresponsebadrequest json dumps error unicode no tag content type application json
permission required flagit can moderate dcnl require post dcnl def mark spam request dcsp if request post get question id dcnl dcsp dcsp question id request post get question id dcnl dcsp dcsp obj get object or 404 question pk question id dcnl dcsp else dcnl dcsp dcsp answer id request post get answer id dcnl dcsp dcsp obj get object or 404 answer pk answer id dcnl dcsp dcsp question id obj question id dcnl dcsp obj mark as spam request user dcnl dcsp return httpresponseredirect reverse questions details kwargs question id question id
permission required flagit can moderate dcnl require post dcnl def unmark spam request dcsp if request post get question id dcnl dcsp dcsp question id request post get question id dcnl dcsp dcsp obj get object or 404 question pk question id dcnl dcsp else dcnl dcsp dcsp answer id request post get answer id dcnl dcsp dcsp obj get object or 404 answer pk answer id dcnl dcsp dcsp question id obj question id dcnl dcsp obj is spam false dcnl dcsp obj marked as spam none dcnl dcsp obj marked as spam by none dcnl dcsp obj save dcnl dcsp return httpresponseredirect reverse questions details kwargs question id question id
login required dcnl def delete question request question id dcsp question get object or 404 question pk question id dcnl dcsp if not question allows delete request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp if request method get dcnl dcsp dcsp return render request questions confirm question delete html question question dcnl dcsp product question product slug dcnl dcsp log warning user dcsp s dcsp is dcsp deleting dcsp question dcsp with dcsp id s request user question id dcnl dcsp question delete dcnl dcsp statsd incr questions delete dcnl dcsp return httpresponseredirect reverse questions list args product
login required dcnl def delete answer request question id answer id dcsp answer get object or 404 answer pk answer id question question id dcnl dcsp if not answer allows delete request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp if request method get dcnl dcsp dcsp return render request questions confirm answer delete html answer answer dcnl dcsp log warning user dcsp s dcsp is dcsp deleting dcsp answer dcsp with dcsp id s request user answer id dcnl dcsp answer delete dcnl dcsp statsd incr questions delete answer dcnl dcsp return httpresponseredirect reverse questions details args question id
require post dcnl login required dcnl def lock question request question id dcsp question get object or 404 question pk question id dcnl dcsp if not question allows lock request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp question is locked not question is locked dcnl dcsp log info user dcsp s dcsp set dcsp is locked s dcsp on dcsp question dcsp with dcsp id s dcsp request user question is locked question id dcnl dcsp question save dcnl dcsp if question is locked dcnl dcsp dcsp statsd incr questions lock dcnl dcsp else dcnl dcsp dcsp statsd incr questions unlock dcnl dcsp return httpresponseredirect question get absolute url
require post dcnl login required dcnl def archive question request question id dcsp question get object or 404 question pk question id dcnl dcsp if not question allows archive request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp question is archived not question is archived dcnl dcsp log info user dcsp s dcsp set dcsp is archived s dcsp on dcsp question dcsp with dcsp id s dcsp request user question is archived question id dcnl dcsp question save dcnl dcsp return httpresponseredirect question get absolute url
login required dcnl def edit answer request question id answer id dcsp answer get object or 404 answer pk answer id question question id dcnl dcsp answer preview none dcnl dcsp if not answer allows edit request user dcnl dcsp dcsp raise permissiondenied dcnl dcsp upload imageattachment request answer dcnl dcsp if request method get dcnl dcsp dcsp form answerform content answer content dcnl dcsp dcsp return render request questions edit answer html form form answer answer dcnl dcsp form answerform request post dcnl dcsp if form is valid dcnl dcsp dcsp answer content form cleaned data content dcnl dcsp dcsp answer updated by request user dcnl dcsp dcsp if preview in request post dcnl dcsp dcsp dcsp answer updated datetime now dcnl dcsp dcsp dcsp answer preview answer dcnl dcsp dcsp else dcnl dcsp dcsp dcsp log warning user dcsp s dcsp is dcsp editing dcsp answer dcsp with dcsp id s request user answer id dcnl dcsp dcsp dcsp answer save dcnl dcsp dcsp dcsp return httpresponseredirect answer get absolute url dcnl dcsp return render request questions edit answer html form form answer answer answer preview answer preview
require post dcnl anonymous csrf dcnl def watch question request question id dcsp question get object or 404 question pk question id is spam false dcnl dcsp form watchquestionform request user request post dcnl dcsp msg none dcnl dcsp if form is valid dcnl dcsp dcsp user or email request user if request user is authenticated else form cleaned data email dcnl dcsp dcsp try dcnl dcsp dcsp dcsp if form cleaned data event type reply dcnl dcsp dcsp dcsp dcsp questionreplyevent notify user or email question dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp questionsolvedevent notify user or email question dcnl dcsp dcsp dcsp statsd incr questions watches new dcnl dcsp dcsp except activationrequestfailed dcnl dcsp dcsp dcsp msg could dcsp not dcsp send dcsp a dcsp message dcsp to dcsp that dcsp email dcsp address dcnl dcsp if request is ajax dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp msg msg or you dcsp will dcsp be dcsp notified dcsp of dcsp updates dcsp by dcsp email if request user is authenticated else you dcsp should dcsp receive dcsp an dcsp email dcsp shortly dcsp to dcsp confirm dcsp your dcsp subscription dcnl dcsp dcsp dcsp return httpresponse json dumps message msg dcnl dcsp dcsp if request post get from vote dcnl dcsp dcsp dcsp tmpl questions includes question vote thanks html dcnl dcsp dcsp else dcnl dcsp dcsp dcsp tmpl questions includes email subscribe html dcnl dcsp dcsp html render to string tmpl context question question watch form form request request dcnl dcsp dcsp return httpresponse json dumps html html dcnl dcsp if msg dcnl dcsp dcsp messages add message request messages error msg dcnl dcsp return httpresponseredirect question get absolute url
require post dcnl login required dcnl def unwatch question request question id dcsp question get object or 404 question pk question id dcnl dcsp questionreplyevent stop notifying request user question dcnl dcsp questionsolvedevent stop notifying request user question dcnl dcsp return httpresponseredirect question get absolute url
require get dcnl def unsubscribe watch request watch id secret dcsp watch get object or 404 watch pk watch id dcnl dcsp question watch content object dcnl dcsp success false dcnl dcsp if watch secret secret and isinstance question question dcnl dcsp dcsp user or email watch user or watch email dcnl dcsp dcsp questionreplyevent stop notifying user or email question dcnl dcsp dcsp questionsolvedevent stop notifying user or email question dcnl dcsp dcsp success true dcnl dcsp return render request questions unsubscribe watch html question question success success
require get dcnl def activate watch request watch id secret dcsp watch get object or 404 watch pk watch id dcnl dcsp question watch content object dcnl dcsp if watch secret secret and isinstance question question dcnl dcsp dcsp watch activate save dcnl dcsp dcsp statsd incr questions watches activate dcnl dcsp return render request questions activate watch html question question unsubscribe url reverse questions unsubscribe args watch id secret is active watch is active
login required dcnl require post dcnl def answer preview async request dcsp statsd incr questions preview dcnl dcsp answer answer creator request user content request post get content dcnl dcsp template questions includes answer preview html dcnl dcsp return render request template answer preview answer
mobile template questions mobile marketplace html dcnl def marketplace request template none dcsp return render request template categories marketplace categories
anonymous csrf dcnl mobile template questions mobile marketplace category html dcnl def marketplace category request category slug template none dcsp try dcnl dcsp dcsp category name marketplace categoriescategory slug dcnl dcsp except keyerror dcnl dcsp dcsp raise http404 dcnl dcsp error message none dcnl dcsp if request method get dcnl dcsp dcsp form marketplaceaaqform request user dcnl dcsp else dcnl dcsp dcsp form marketplaceaaqform request user request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp form submit ticket dcnl dcsp dcsp dcsp dcsp return httpresponseredirect reverse questions marketplace aaq success dcnl dcsp dcsp dcsp except zendeskerror dcnl dcsp dcsp dcsp dcsp error message zendesk error message dcnl dcsp return render request template category category name category slug category slug categories marketplace categories form form error message error message
anonymous csrf dcnl mobile template questions mobile marketplace refund html dcnl def marketplace refund request template dcsp error message none dcnl dcsp if request method get dcnl dcsp dcsp form marketplacerefundform request user dcnl dcsp else dcnl dcsp dcsp form marketplacerefundform request user request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp form submit ticket dcnl dcsp dcsp dcsp dcsp return httpresponseredirect reverse questions marketplace aaq success dcnl dcsp dcsp dcsp except zendeskerror dcnl dcsp dcsp dcsp dcsp error message zendesk error message dcnl dcsp return render request template form form error message error message
anonymous csrf dcnl mobile template questions mobile marketplace developer request html dcnl def marketplace developer request request template dcsp error message none dcnl dcsp if request method get dcnl dcsp dcsp form marketplacedeveloperrequestform request user dcnl dcsp else dcnl dcsp dcsp form marketplacedeveloperrequestform request user request post dcnl dcsp dcsp if form is valid dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp form submit ticket dcnl dcsp dcsp dcsp dcsp return httpresponseredirect reverse questions marketplace aaq success dcnl dcsp dcsp dcsp except zendeskerror dcnl dcsp dcsp dcsp dcsp error message zendesk error message dcnl dcsp return render request template form form error message error message
mobile template questions mobile marketplace success html dcnl def marketplace success request template none dcsp return render request template
def stats topic data bucket days start end locale none product none dcsp search sphilastic questionmappingtype dcnl dcsp bucket 24 60 60 bucket days dcnl dcsp if isinstance start date dcnl dcsp dcsp start int time mktime start timetuple dcnl dcsp if isinstance end date dcnl dcsp dcsp end int time mktime end timetuple dcnl dcsp f f model questions question dcnl dcsp f f created gt start dcnl dcsp f f created lt end dcnl dcsp if locale dcnl dcsp dcsp f f question locale locale dcnl dcsp if product dcnl dcsp dcsp f f product product slug dcnl dcsp topics topic objects values slug title dcnl dcsp facets dcnl dcsp for topic in topics dcnl dcsp dcsp filters search process filters f f topic topic slug dcnl dcsp dcsp facetstopic title histogram interval bucket field created facet filter filters dcnl dcsp search search facet raw facets values dict dcnl dcsp try dcnl dcsp dcsp histograms data search facet counts dcnl dcsp except es exceptions dcnl dcsp dcsp return dcnl dcsp for series in histograms data itervalues dcnl dcsp dcsp if series entries dcnl dcsp dcsp dcsp earliest point series entries 0 key dcnl dcsp dcsp dcsp break dcnl dcsp else dcnl dcsp dcsp return dcnl dcsp latest point earliest point dcnl dcsp interim data dcnl dcsp for key data in histograms data iteritems dcnl dcsp dcsp if not data dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp for point in data dcnl dcsp dcsp dcsp timestamp point key dcnl dcsp dcsp dcsp value point count dcnl dcsp dcsp dcsp earliest point min earliest point timestamp dcnl dcsp dcsp dcsp latest point max latest point timestamp dcnl dcsp dcsp dcsp datum interim data get timestamp date timestamp dcnl dcsp dcsp dcsp datumkey value dcnl dcsp dcsp dcsp interim datatimestamp datum dcnl dcsp timestamp earliest point dcnl dcsp while timestamp < latest point dcnl dcsp dcsp datum interim data get timestamp date timestamp dcnl dcsp dcsp for key in histograms data iterkeys dcnl dcsp dcsp dcsp if key not in datum dcnl dcsp dcsp dcsp dcsp datumkey 0 dcnl dcsp dcsp timestamp + bucket dcnl dcsp return interim data values
def metrics request locale code none dcsp template questions metrics html dcnl dcsp product request get get product dcnl dcsp if product dcnl dcsp dcsp product get object or 404 product slug product dcnl dcsp form statsform request get dcnl dcsp if form is valid dcnl dcsp dcsp bucket days form cleaned data bucket dcnl dcsp dcsp start form cleaned data start dcnl dcsp dcsp end form cleaned data end dcnl dcsp else dcnl dcsp dcsp bucket days 1 dcnl dcsp dcsp start date today timedelta days 30 dcnl dcsp dcsp end date today dcnl dcsp graph data stats topic data bucket days start end locale code product dcnl dcsp for group in graph data dcnl dcsp dcsp for name count in group items dcnl dcsp dcsp dcsp if count 0 dcnl dcsp dcsp dcsp dcsp del groupname dcnl dcsp data graph graph data form form current locale locale code product product products product objects filter visible true dcnl dcsp return render request template data
def search suggestions request text locale product slugs dcsp question s questionmappingtype search dcnl dcsp wiki s documentmappingtype search dcnl dcsp wiki results questions results 3 dcnl dcsp default categories settings search default categories dcnl dcsp if product slugs dcnl dcsp dcsp wiki s wiki s filter product in product slugs dcnl dcsp dcsp question s question s filter product in product slugs dcnl dcsp results dcnl dcsp try dcnl dcsp dcsp query dict s match field text for field in documentmappingtype get query fields dcnl dcsp dcsp query update dict s match phrase field text for field in documentmappingtype get query fields dcnl dcsp dcsp query es query with analyzer query locale dcnl dcsp dcsp filter f dcnl dcsp dcsp filter | f document locale locale dcnl dcsp dcsp filter | f document locale settings wiki default language dcnl dcsp dcsp filter f document category in default categories dcnl dcsp dcsp filter f document is archived false dcnl dcsp dcsp raw results wiki s filter filter query or query values list id wiki results dcnl dcsp dcsp raw results result00 for result in raw results dcnl dcsp dcsp for id in raw results dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp doc document objects select related current revision get pk id dcnl dcsp dcsp dcsp dcsp results append search summary clean excerpt doc current revision summary url doc get absolute url title doc title type document object doc dcnl dcsp dcsp dcsp except document doesnotexist dcnl dcsp dcsp dcsp dcsp pass dcnl dcsp dcsp query dict s match field text for field in questionmappingtype get query fields dcnl dcsp dcsp query update dict s match phrase field text for field in questionmappingtype get query fields dcnl dcsp dcsp question filter f question locale locale dcnl dcsp dcsp question filter | f question locale settings wiki default language dcnl dcsp dcsp question filter f question is archived false dcnl dcsp dcsp raw results question s query or query filter question filter values list id questions results dcnl dcsp dcsp raw results result00 for result in raw results dcnl dcsp dcsp for id in raw results dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp q question objects get pk id dcnl dcsp dcsp dcsp dcsp results append search summary clean excerpt q content0 500 url q get absolute url title q title type question object q last updated q updated is solved q is solved num answers q num answers num votes q num votes num votes past week q num votes past week dcnl dcsp dcsp dcsp except question doesnotexist dcnl dcsp dcsp dcsp dcsp pass dcnl dcsp except es exceptions as exc dcnl dcsp dcsp statsd incr questions suggestions eserror dcnl dcsp dcsp log debug exc dcnl dcsp return results
def answers data request question id form none watch form none answer preview none dcsp question get object or 404 question pk question id dcnl dcsp answers question answers all dcnl dcsp if not request user has perm flagit can moderate dcnl dcsp dcsp answers answers filter is spam false dcnl dcsp if not request mobile dcnl dcsp dcsp answers paginate request answers per page config answers per page dcnl dcsp feed urls reverse questions answers feed kwargs question id question id answersfeed title question dcnl dcsp frequencies dict frequency choices dcnl dcsp is watching question request user is authenticated and questionreplyevent is notifying request user question or questionsolvedevent is notifying request user question dcnl dcsp return question question answers answers form form or answerform answer preview answer preview watch form watch form or init watch form request reply feeds feed urls frequencies frequencies is watching question is watching question can tag request user has perm questions tag question can create tags request user has perm taggit add tag
def add tag request question id dcsp tag name request post get tagname strip dcnl dcsp if tag name dcnl dcsp dcsp question get object or 404 question pk question id dcnl dcsp dcsp try dcnl dcsp dcsp dcsp canonical name add existing tag tag name question tags dcnl dcsp dcsp except tag doesnotexist dcnl dcsp dcsp dcsp if request user has perm taggit add tag dcnl dcsp dcsp dcsp dcsp question tags add tag name dcnl dcsp dcsp dcsp dcsp canonical name tag name dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise dcnl dcsp dcsp tag added send sender question question id question id tag name canonical name dcnl dcsp dcsp return question canonical name dcnl dcsp return none none
def on reply save sender instance created kwargs dcsp answer instance dcnl dcsp year answer created year dcnl dcsp creator answer creator dcnl dcsp if created dcnl dcsp dcsp from kitsune questions tasks import maybe award badge dcnl dcsp dcsp maybe award badge delay questions badges answerbadge year creator
def get zendesk dcsp zendesk url settings zendesk url dcnl dcsp zendesk email settings zendesk user email dcnl dcsp zendesk password settings zendesk user password dcnl dcsp if not zendesk url or not zendesk email or not zendesk password dcnl dcsp dcsp log error zendesk dcsp settings dcsp error dcsp please dcsp set dcsp zendesk url dcsp zendesk user email dcsp and dcsp zendesk user password dcnl dcsp dcsp statsd incr questions zendesk settingserror dcnl dcsp dcsp raise zendesksettingserror missing dcsp zendesk dcsp settings dcnl dcsp return zendesk zendesk url zendesk email zendesk password api version 2
def submit ticket email category subject body tags dcsp zendesk get zendesk dcnl dcsp new ticket ticket requester email email subject settings zendesk subject prefix + subject description body set tags category tags tags dcnl dcsp try dcnl dcsp dcsp ticket url zendesk create ticket data new ticket dcnl dcsp dcsp statsd incr questions zendesk success dcnl dcsp except zendeskerror as e dcnl dcsp dcsp log error zendesk dcsp error dcsp s e msg dcnl dcsp dcsp statsd incr questions zendesk error dcnl dcsp dcsp raise dcnl dcsp return ticket url
def cursor dcsp return connectionsrouter db for read document cursor
def format row with out of dateness readout locale eng slug eng title slug title visits significance needs review dcsp if slug dcnl dcsp dcsp locale readout locale dcnl dcsp dcsp if needs review dcnl dcsp dcsp dcsp status view name status class review statusesneeds review dcnl dcsp dcsp else dcnl dcsp dcsp dcsp status view name status class significance statuses get significance review statusesneeds review dcnl dcsp dcsp status url reverse view name args slug locale locale if view name else dcnl dcsp else dcnl dcsp dcsp slug eng slug dcnl dcsp dcsp title eng title dcnl dcsp dcsp locale settings wiki default language dcnl dcsp dcsp status u translation dcsp needed dcnl dcsp dcsp status url reverse wiki translate args slug locale readout locale dcnl dcsp dcsp status class untranslated dcnl dcsp return dict title title url reverse wiki document args slug locale locale visits visits status status status class status class status url status url
def kb overview rows mode none max none locale none product none category none dcsp if mode is none dcnl dcsp dcsp mode last 30 days dcnl dcsp docs document objects filter locale settings wiki default language is archived false is template false dcnl dcsp docs docs exclude html startswith redirect html dcnl dcsp select ordereddict num visits select dcsp wdv visits dcsp from dcsp dashboards wikidocumentvisits dcsp as dcsp wdv dcsp where dcsp wdv period s dcsp and dcsp wdv document id wiki document id dcnl dcsp docs docs extra select select select params mode dcnl dcsp if product dcnl dcsp dcsp docs docs filter products in product dcnl dcsp if category dcnl dcsp dcsp docs docs filter category in category dcnl dcsp docs docs order by num visits title dcnl dcsp if max dcnl dcsp dcsp docs docs max dcnl dcsp rows dcnl dcsp if docs count dcnl dcsp dcsp max visits docs0 num visits dcnl dcsp for d in docs dcnl dcsp dcsp data url reverse wiki document args d slug locale settings wiki default language trans url reverse wiki show translations args d slug locale settings wiki default language title d title num visits d num visits ready for l10n d revisions filter is approved true is ready for localization true exists dcnl dcsp dcsp if d current revision dcnl dcsp dcsp dcsp data expiry date d current revision expires dcnl dcsp dcsp if d num visits dcnl dcsp dcsp dcsp data visits ratio float d num visits max visits dcnl dcsp dcsp if expiry date in data and data expiry date dcnl dcsp dcsp dcsp data stale data expiry date < datetime now dcnl dcsp dcsp if d current revision dcnl dcsp dcsp dcsp unapproved revs d revisions filter reviewed none id gt d current revision id 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp unapproved revs d revisions all dcnl dcsp dcsp if unapproved revs count dcnl dcsp dcsp dcsp data revision comment unapproved revs0 comment dcnl dcsp dcsp else dcnl dcsp dcsp dcsp data latest revision true dcnl dcsp dcsp if locale settings wiki default language dcnl dcsp dcsp dcsp transdoc d translations filter locale locale is archived false first dcnl dcsp dcsp dcsp if transdoc dcnl dcsp dcsp dcsp dcsp data needs update transdoc is outdated dcnl dcsp dcsp else dcnl dcsp dcsp dcsp data needs update d needs change dcnl dcsp dcsp dcsp data needs update comment d needs change comment dcnl dcsp dcsp rows append data dcnl dcsp return rows
def l10n overview rows locale product none dcsp def percent or 100 num denom dcnl dcsp dcsp return int round num float denom 100 if denom else 100 dcnl dcsp def single result sql params dcnl dcsp dcsp return dcsp the dcsp first dcsp column dcsp of dcsp the dcsp first dcsp row dcsp returned dcsp by dcsp a dcsp query dcnl dcsp dcsp cursor cursor dcnl dcsp dcsp cursor execute sql params dcnl dcsp dcsp return cursor fetchone 0 dcnl dcsp total document objects filter locale settings wiki default language is archived false current revision isnull false is localizable true latest localizable revision isnull false dcnl dcsp total total exclude html startswith redirect html dcnl dcsp if product dcnl dcsp dcsp total total filter products product dcnl dcsp dcsp has forum product questions locales filter locale locale exists dcnl dcsp ignore categories str administration category str navigation category str how to contribute category dcnl dcsp if product and not has forum dcnl dcsp dcsp ignore categories append str canned responses category dcnl dcsp total total exclude category in ignore categories dcnl dcsp total docs total filter is template false count dcnl dcsp total templates total filter is template true count dcnl dcsp if product dcnl dcsp dcsp extra joins product filter dcnl dcsp dcsp prod param product id dcnl dcsp else dcnl dcsp dcsp extra joins dcnl dcsp dcsp prod param tuple dcnl dcsp up to date translation count select dcsp count dcsp from dcsp wiki document dcsp transdoc dcsp inner dcsp join dcsp wiki document dcsp engdoc dcsp on dcsp transdoc parent id engdoc id dcsp inner dcsp join dcsp wiki revision dcsp curtransrev dcsp dcsp dcsp dcsp dcsp on dcsp transdoc current revision id curtransrev id dcsp + extra joins + where dcsp transdoc locale s dcsp dcsp dcsp dcsp dcsp and dcsp engdoc category dcsp not dcsp in dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp + join ignore categories + dcsp dcsp dcsp dcsp and dcsp transdoc is template s dcsp dcsp dcsp dcsp dcsp and dcsp not dcsp transdoc is archived dcsp dcsp dcsp dcsp dcsp and dcsp not dcsp engdoc is archived dcsp dcsp dcsp dcsp dcsp and dcsp engdoc latest localizable revision id dcsp is dcsp not dcsp null dcsp dcsp dcsp dcsp dcsp and dcsp engdoc is localizable dcsp dcsp dcsp dcsp dcsp and dcsp engdoc html dcsp not dcsp like dcsp <p redirect dcsp <a dcsp dcsp dcsp dcsp dcsp and dcsp not dcsp exists dcsp + any significant updates dcnl dcsp translated docs single result up to date translation count prod param + locale false medium significance dcnl dcsp translated templates single result up to date translation count prod param + locale true medium significance dcnl dcsp top n query select dcsp sum istranslated dcsp from dcsp dcsp dcsp dcsp dcsp select dcsp transdoc current revision id dcsp is dcsp not dcsp null dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp and dcsp not dcsp exists dcsp + any significant updates + dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp as dcsp istranslated dcsp + most visited translation from extra joins left dcsp join dcsp wiki revision dcsp curtransrev dcsp on dcsp transdoc current revision id curtransrev id dcsp + extra joins extra where and dcsp engdoc category dcsp not dcsp in dcsp + join ignore categories + dcsp + and dcsp not dcsp engdoc is template dcsp + and dcsp engdoc html dcsp not dcsp like dcsp <p redirect dcsp <a dcsp + limit dcsp s dcsp t1 dcsp dcnl dcsp top 20 translated int single result top n query medium significance locale last 30 days + prod param + settings wiki default language 20 or 0 dcnl dcsp top 50 translated int single result top n query medium significance locale last 30 days + prod param + settings wiki default language 50 or 0 dcnl dcsp top 100 translated int single result top n query medium significance locale last 30 days + prod param + settings wiki default language 100 or 0 dcnl dcsp return top20 title top dcsp 20 dcsp articles numerator top 20 translated denominator 20 if total docs 20 else total docs percent percent or 100 top 20 translated 20 if total docs 20 else total docs description these dcsp are dcsp the dcsp top dcsp 20 dcsp most dcsp visited dcsp articles dcsp in dcsp the dcsp last dcsp 30 dcsp days dcsp which dcsp account dcsp for dcsp over dcsp 50 dcsp of dcsp the dcsp traffic dcsp to dcsp the dcsp knowledge dcsp base top50 title top dcsp 50 dcsp articles numerator top 50 translated denominator 50 if total docs 50 else total docs percent percent or 100 top 50 translated 50 if total docs 50 else total docs description these dcsp are dcsp the dcsp top dcsp 50 dcsp most dcsp visited dcsp articles dcsp in dcsp the dcsp last dcsp 30 dcsp days top100 title top dcsp 100 dcsp articles numerator top 100 translated denominator 100 if total docs 100 else total docs percent percent or 100 top 100 translated 100 if total docs 100 else total docs description these dcsp are dcsp the dcsp top dcsp 100 dcsp most dcsp visited dcsp articles dcsp in dcsp the dcsp last dcsp 30 dcsp days dcsp which dcsp account dcsp for dcsp over dcsp 99 dcsp of dcsp the dcsp traffic dcsp to dcsp the dcsp knowledge dcsp base templates title templates url + templatetranslationsreadout slug numerator translated templates denominator total templates percent percent or 100 translated templates total templates description templates dcsp are dcsp a dcsp way dcsp of dcsp reusing dcsp pieces dcsp of dcsp content dcsp across dcsp kb dcsp articles dcsp you dcsp can dcsp create dcsp and dcsp update dcsp a dcsp set dcsp of dcsp instructions dcsp in dcsp one dcsp place dcsp and dcsp then dcsp refer dcsp to dcsp it dcsp in dcsp other dcsp pages all title all dcsp knowledge dcsp base dcsp articles numerator translated docs denominator total docs percent percent or 100 translated docs total docs description this dcsp is dcsp the dcsp number dcsp of dcsp all dcsp knowledge dcsp base dcsp articles dcsp that dcsp are dcsp ready dcsp to dcsp be dcsp localized
cronjobs register dcnl def update l10n coverage metrics dcsp today date today dcnl dcsp for locale in settings sumo languages dcnl dcsp dcsp if locale settings wiki default language dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp for product in none + list product objects filter visible true dcnl dcsp dcsp dcsp rows l10n overview rows locale locale product product dcnl dcsp dcsp dcsp top20 rows top20 dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp percent 100 0 float top20 numerator top20 denominator dcnl dcsp dcsp dcsp except zerodivisionerror dcnl dcsp dcsp dcsp dcsp percent 0 0 dcnl dcsp dcsp dcsp wikimetric objects create code l10n top20 code locale locale product product date today value percent dcnl dcsp dcsp dcsp top100 rows top100 dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp percent 100 0 float top100 numerator top100 denominator dcnl dcsp dcsp dcsp except zerodivisionerror dcnl dcsp dcsp dcsp dcsp percent 0 0 dcnl dcsp dcsp dcsp wikimetric objects create code l10n top100 code locale locale product product date today value percent dcnl dcsp dcsp dcsp all rows all dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp percent 100 float all numerator all denominator dcnl dcsp dcsp dcsp except zerodivisionerror dcnl dcsp dcsp dcsp dcsp percent 0 0 dcnl dcsp dcsp dcsp wikimetric objects create code l10n all code locale locale product product date today value percent
cronjobs register dcnl def update l10n contributor metrics day none dcsp if day is none dcnl dcsp dcsp day date today dcnl dcsp first of month date day year day month 1 dcnl dcsp if day month 1 dcnl dcsp dcsp previous first of month date day year 1 12 1 dcnl dcsp else dcnl dcsp dcsp previous first of month date day year day month 1 1 dcnl dcsp for locale in settings sumo languages dcnl dcsp dcsp for product in none + list product objects filter visible true dcnl dcsp dcsp dcsp num num active contributors from date previous first of month to date first of month locale locale product product dcnl dcsp dcsp dcsp wikimetric objects create code l10n active contributors code locale locale product product date previous first of month value num
def get old unhelpful dcsp old formatted dcnl dcsp cursor connection cursor dcnl dcsp cursor execute select dcsp doc id dcsp yes dcsp no n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp from n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp select dcsp wiki revision document id dcsp as dcsp doc id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp sum limitedvotes helpful dcsp as dcsp yes n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp sum not limitedvotes helpful dcsp as dcsp no n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp from n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp select dcsp dcsp from dcsp wiki helpfulvote n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp created dcsp < dcsp date sub curdate dcsp interval dcsp 1 dcsp week n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp and dcsp created dcsp dcsp date sub date sub curdate n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp interval dcsp 1 dcsp week dcsp interval dcsp 1 dcsp week n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp as dcsp limitedvotes n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp inner dcsp join dcsp wiki revision dcsp on n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp limitedvotes revision id wiki revision id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp inner dcsp join dcsp wiki document dcsp on n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp wiki document id wiki revision document id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp wiki document locale enus n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp group dcsp by dcsp doc id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp having dcsp no dcsp dcsp yes n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp as dcsp calculated dcnl dcsp old data cursor fetchall dcnl dcsp for data in old data dcnl dcsp dcsp doc id data0 dcnl dcsp dcsp yes float data1 dcnl dcsp dcsp no float data2 dcnl dcsp dcsp total yes + no dcnl dcsp dcsp if total 0 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp old formatteddoc id total total percentage yes total dcnl dcsp return old formatted
def get current unhelpful old formatted dcsp final dcnl dcsp cursor connection cursor dcnl dcsp cursor execute select dcsp doc id dcsp yes dcsp no n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp from n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp select dcsp wiki revision document id dcsp as dcsp doc id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp sum limitedvotes helpful dcsp as dcsp yes n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp sum not limitedvotes helpful dcsp as dcsp no n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp from n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp select dcsp dcsp from dcsp wiki helpfulvote n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp created dcsp dcsp date sub curdate dcsp interval dcsp 1 dcsp week n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp as dcsp limitedvotes n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp inner dcsp join dcsp wiki revision dcsp on n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp limitedvotes revision id wiki revision id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp inner dcsp join dcsp wiki document dcsp on n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp wiki document id wiki revision document id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp where dcsp wiki document locale enus n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp group dcsp by dcsp doc id n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp having dcsp no dcsp dcsp yes n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp as dcsp calculated dcnl dcsp current data cursor fetchall dcnl dcsp for data in current data dcnl dcsp dcsp doc id data0 dcnl dcsp dcsp yes float data1 dcnl dcsp dcsp no float data2 dcnl dcsp dcsp total yes + no dcnl dcsp dcsp if total 0 dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp percentage yes total dcnl dcsp dcsp if doc id in old formatted dcnl dcsp dcsp dcsp finaldoc id total total currperc percentage diffperc percentage old formatteddoc id percentage dcnl dcsp dcsp else dcnl dcsp dcsp dcsp finaldoc id total total currperc percentage diffperc 0 0 dcnl dcsp return final
cronjobs register dcnl def cache most unhelpful kb articles dcsp redis key settings helpfulvotes unhelpful key dcnl dcsp old formatted get old unhelpful dcnl dcsp final get current unhelpful old formatted dcnl dcsp if final dcnl dcsp dcsp return dcnl dcsp def mean vals dcnl dcsp dcsp argument dcsp list dcsp of dcsp floats dcnl dcsp dcsp if len vals 0 dcnl dcsp dcsp dcsp return none dcnl dcsp dcsp return sum vals len vals dcnl dcsp def bayes avg c m r v dcnl dcsp dcsp return c m + r v m + v dcnl dcsp mean perc mean float finalkey currperc for key in final keys dcnl dcsp mean total mean float finalkey total for key in final keys dcnl dcsp sorted final key finalkey total finalkey currperc finalkey diffperc bayes avg mean perc mean total finalkey currperc finalkey total for key in final keys dcnl dcsp sorted final sort key lambda entry entry4 dcnl dcsp redis redis client helpfulvotes dcnl dcsp redis delete redis key dcnl dcsp max total max b1 for b in sorted final dcnl dcsp for entry in sorted final dcnl dcsp dcsp doc document objects get pk entry0 dcnl dcsp dcsp redis rpush redis key u s s s s s s s entry0 entry1 entry2 entry3 1 entry1 max total doc slug doc title
def render readouts request readouts template locale none extra data none product none dcsp current locale locale or request language code dcnl dcsp on default locale request language code settings wiki default language dcnl dcsp default kwargs locale settings wiki default language dcnl dcsp locale kwargs locale request language code dcnl dcsp ready kwargs dcnl dcsp if product is not none dcnl dcsp dcsp default kwargs product product slug dcnl dcsp dcsp locale kwargs product product slug dcnl dcsp dcsp ready kwargs product product slug dcnl dcsp data readouts sorteddict slug class request locale locale product product for slug class in readouts iteritems if class should show to request default locale settings wiki default language default locale name localessettings wiki default language native current locale current locale current locale name localescurrent locale native request locale name localesrequest language code native is watching default approved approverevisioninlocaleevent is notifying request user default kwargs is watching other approved none if on default locale else approverevisioninlocaleevent is notifying request user locale kwargs is watching default locale reviewablerevisioninlocaleevent is notifying request user default kwargs is watching other locale none if on default locale else reviewablerevisioninlocaleevent is notifying request user locale kwargs is watching default ready readyrevisionevent is notifying request user ready kwargs on default locale on default locale announce form announcementform announcements announcement get for locale name current locale product product products product objects filter visible true dcnl dcsp if extra data dcnl dcsp dcsp data update extra data dcnl dcsp return render request dashboards + template data
def get locales by visit start date end date dcsp cache key locales sorted by visits start end format start start date end end date dcnl dcsp sorted locales cache get cache key dcnl dcsp if sorted locales is none dcnl dcsp dcsp try dcnl dcsp dcsp dcsp results visitors by locale start date end date dcnl dcsp dcsp dcsp locales and visits results items dcnl dcsp dcsp dcsp sorted locales list reversed sorted locales and visits key lambda x x1 dcnl dcsp dcsp dcsp cache add cache key sorted locales cache timeout dcnl dcsp dcsp except googleapierror oauth2error opensslerror dcnl dcsp dcsp dcsp log exception something dcsp went dcsp wrong dcsp getting dcsp visitors dcsp by dcsp locale dcsp from dcsp google dcsp analytics dcsp nobody dcsp got dcsp a dcsp 500 dcsp though dcnl dcsp dcsp dcsp sorted locales l 0 for l in settings sumo languages dcnl dcsp return sorted locales
def period dates period dcsp end date today timedelta days 1 dcnl dcsp if period last 7 days dcnl dcsp dcsp start end timedelta days 7 dcnl dcsp elif period last 30 days dcnl dcsp dcsp start end timedelta days 30 dcnl dcsp elif period last 90 days dcnl dcsp dcsp start end timedelta days 90 dcnl dcsp elif all time dcnl dcsp dcsp start settings ga start date dcnl dcsp return start end
def kb readout request readout slug readouts locale none mode none product none dcsp if readout slug not in readouts dcnl dcsp dcsp raise http404 dcnl dcsp return readoutsreadout slug request locale locale mode mode product product
def kb detail request readout slug readouts main view name main dash title locale none product none dcsp return render request dashboards kb detail html readout kb readout request readout slug readouts locale product product locale locale main dash view main view name main dash title main dash title product product products product objects filter visible true
require get dcnl def contributors detail request readout slug dcsp product get product request dcnl dcsp return kb detail request readout slug contributor readouts dashboards contributors knowledge dcsp base dcsp dashboard locale settings wiki default language product product
require get dcnl def localization detail request readout slug dcsp product get product request dcnl dcsp return kb detail request readout slug l10n readouts dashboards localization localization dcsp dashboard product product
require get dcnl def localization request dcsp if request language code settings wiki default language dcnl dcsp dcsp return httpresponseredirect reverse dashboards contributors dcnl dcsp locales locale objects filter locale request language code dcnl dcsp if locales dcnl dcsp dcsp permission user can announce request user locales0 dcnl dcsp else dcnl dcsp dcsp permission false dcnl dcsp product get product request dcnl dcsp data overview rows l10n overview rows request language code product product user can announce permission dcnl dcsp return render readouts request l10n readouts localization html extra data data product product
require get dcnl def contributors request dcsp product get product request dcnl dcsp category get category request dcnl dcsp return render readouts request contributor readouts contributors html locale settings wiki default language product product extra data overview rows kb overview rows locale request language code product product mode smart int request get get mode none max smart int request get get max 10 category category overview modes periods category category categories categories
require get dcnl def contributors old request dcsp product get product request dcnl dcsp return render readouts request contributor readouts contributors old html locale settings wiki default language product product
require get dcnl def wiki rows request readout slug dcsp product get product request dcnl dcsp readout kb readout request readout slug readouts locale request get get locale mode smart int request get get mode none product product dcnl dcsp max rows smart int request get get max fallback none dcnl dcsp return httpresponse readout render max rows max rows
require get dcnl def locale metrics request locale code dcsp if locale code not in settings sumo languages dcnl dcsp dcsp raise http404 dcnl dcsp product get product request dcnl dcsp return render request dashboards locale metrics html current locale locale code product product products product objects filter visible true
require get dcnl def aggregated metrics request dcsp today date today dcnl dcsp locales get locales by visit today timedelta days 30 today dcnl dcsp product get product request dcnl dcsp return render request dashboards aggregated metrics html locales json json dumps settings sumo languages locales locales product product products product objects filter visible true
task dcnl timeit dcnl def measure queue lag queued time dcsp lag datetime now queued time dcnl dcsp lag lag days 3600 24 + lag seconds dcnl dcsp statsd gauge rabbitmq lag max lag 0
def send messages messages dcsp if not messages dcnl dcsp dcsp return dcnl dcsp conn mail get connection fail silently true dcnl dcsp conn open dcnl dcsp for msg in messages dcnl dcsp dcsp conn send messages msg
def safe translation f dcsp wraps f dcnl dcsp def wrapper locale args kwargs dcnl dcsp dcsp try dcnl dcsp dcsp dcsp with uselocale locale dcnl dcsp dcsp dcsp dcsp return f locale args kwargs dcnl dcsp dcsp except typeerror keyerror valueerror indexerror dcnl dcsp dcsp dcsp log exception bad dcsp translation dcsp in dcsp locale dcsp s locale dcnl dcsp dcsp dcsp with uselocale settings wiki default language dcnl dcsp dcsp dcsp dcsp return f settings wiki default language args kwargs dcnl dcsp return wrapper
def render email template context dcsp safe translation dcnl dcsp def render locale dcnl dcsp dcsp render dcsp an dcsp email dcsp in dcsp the dcsp given dcsp locale n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp because dcsp of dcsp safe translation dcsp decorator dcsp if dcsp this dcsp fails n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp the dcsp function dcsp will dcsp be dcsp run dcsp again dcsp in dcsp english n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp req requestfactory dcnl dcsp dcsp req meta dcnl dcsp dcsp req locale locale dcnl dcsp dcsp return render to string template context dcnl dcsp return render translation get language
def make mail subject text template html template context vars from email to email headers none extra kwargs dcsp default headers replyto settings default reply to email dcnl dcsp if headers is not none dcnl dcsp dcsp default headers update headers dcnl dcsp headers default headers dcnl dcsp mail emailmultialternatives subject render email text template context vars from email to email headers headers extra kwargs dcnl dcsp if html template dcnl dcsp dcsp html transform render email html template context vars https + site objects get current domain dcnl dcsp dcsp mail attach alternative html text html dcnl dcsp return mail
def emails with users and watches subject text template html template context vars users and watches from email settings tidings from address default locale settings wiki default language extra kwargs dcsp safe translation dcnl dcsp def make mail locale user watch dcnl dcsp dcsp context vars user user dcnl dcsp dcsp context vars watch watch0 dcnl dcsp dcsp context vars watches watch dcnl dcsp dcsp mail make mail subject format context vars text template html template context vars from email user email extra kwargs dcnl dcsp dcsp return mail dcnl dcsp for u w in users and watches dcnl dcsp dcsp if hasattr u profile dcnl dcsp dcsp dcsp locale u profile locale dcnl dcsp dcsp else dcnl dcsp dcsp dcsp locale default locale dcnl dcsp dcsp yield make mail locale u w
cronjobs register dcnl def enqueue lag monitor task dcsp measure queue lag delay datetime now
cronjobs register dcnl def send postatus errors dcsp if settings stage dcnl dcsp dcsp return dcnl dcsp def new section line dcnl dcsp dcsp return line startswith dennis dcsp or line startswith totals or line startswith busted or line startswith compiled dcnl dcsp postatus requests get https support mozilla org media postatus txt dcnl dcsp lines postatus content splitlines dcnl dcsp datestamp lines pop 0 dcnl dcsp errordata dcnl dcsp while lines dcnl dcsp dcsp line lines pop 0 dcnl dcsp dcsp if line startswith dcsp dcnl dcsp dcsp dcsp while lines and not new section line dcnl dcsp dcsp dcsp dcsp errordata append line dcnl dcsp dcsp dcsp dcsp line lines pop 0 dcnl dcsp if errordata dcnl dcsp dcsp mail admins subject sumo dcsp postatus dcsp errors dcsp s datestamp message these dcsp are dcsp the dcsp errors dcsp in dcsp the dcsp sumo dcsp postatus dcsp file n + see dcsp http postatus paas allizom org p sumo dcsp for dcsp details n + and dcsp bug dcsp generation dcsp links n n + n join errordata
def monkeypatch render dcsp import django shortcuts dcnl dcsp def more info fun dcnl dcsp dcsp django s dcsp render dcsp shortcut dcsp but dcsp captures dcsp information dcsp for dcsp testing n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp when dcsp using dcsp django s dcsp render dcsp shortcut dcsp with dcsp jinja2 dcsp templates dcsp none dcsp of n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp the dcsp information dcsp is dcsp captured dcsp and dcsp thus dcsp you dcsp can t dcsp use dcsp it dcsp for dcsp testing n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp this dcsp alleviates dcsp that dcsp somewhat dcsp by dcsp capturing dcsp some dcsp of dcsp the dcsp information n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp allowing dcsp you dcsp to dcsp test dcsp it n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp caveats n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp it dcsp does dcsp not dcsp capture dcsp all dcsp the dcsp jinja2 dcsp templates dcsp used dcsp to dcsp render n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp only dcsp the dcsp topmost dcsp one dcsp requested dcsp by dcsp the dcsp render dcsp function n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp wraps fun dcnl dcsp dcsp def more info request template name args kwargs dcnl dcsp dcsp dcsp resp fun request template name args kwargs dcnl dcsp dcsp dcsp resp jinja templates template name dcnl dcsp dcsp dcsp if args dcnl dcsp dcsp dcsp dcsp resp jinja context args0 dcnl dcsp dcsp dcsp elif context in kwargs dcnl dcsp dcsp dcsp dcsp resp jinja context kwargs context dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp resp jinja context dcnl dcsp dcsp dcsp return resp dcnl dcsp dcsp return more info dcnl dcsp django shortcuts render more info django shortcuts render
def permissionmod field permissions dcsp class modded field dcnl dcsp dcsp classmethod dcnl dcsp dcsp def many init cls args kwargs dcnl dcsp dcsp dcsp kwargs child field dcnl dcsp dcsp dcsp return permissionmod serializers listserializer permissions args kwargs dcnl dcsp dcsp def get attribute self instance dcnl dcsp dcsp dcsp if self check permissions instance dcnl dcsp dcsp dcsp dcsp return super modded self get attribute instance dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp raise fields skipfield dcnl dcsp dcsp def check permissions self obj dcnl dcsp dcsp dcsp request self context get request dcnl dcsp dcsp dcsp for perm in permissions dcnl dcsp dcsp dcsp dcsp perm perm dcnl dcsp dcsp dcsp dcsp if not perm has permission request self dcnl dcsp dcsp dcsp dcsp dcsp return false dcnl dcsp dcsp dcsp dcsp if not perm has object permission request self obj dcnl dcsp dcsp dcsp dcsp dcsp return false dcnl dcsp dcsp dcsp return true dcnl dcsp return modded
def paginate request queryset per page 20 count none dcsp p paginator paginator queryset per page count count dcnl dcsp try dcnl dcsp dcsp page int request get get page 1 dcnl dcsp except valueerror dcnl dcsp dcsp page 1 dcnl dcsp try dcnl dcsp dcsp paginated p page page dcnl dcsp except paginator emptypage paginator invalidpage dcnl dcsp dcsp paginated p page 1 dcnl dcsp paginated url build paged url request dcnl dcsp return paginated
def simple paginate request queryset per page 20 dcsp p paginator simplepaginator queryset per page dcnl dcsp page p page request get get page 1 dcnl dcsp page url build paged url request dcnl dcsp return page
def build paged url request dcsp base request build absolute uri request path dcnl dcsp items k v for k in request get if k page for v in request get getlist k if v dcnl dcsp qsa urlencode items dcnl dcsp return u s s base qsa
def chunked seq n length none dcsp if not length dcnl dcsp dcsp length len seq dcnl dcsp for i in xrange 0 length n dcnl dcsp dcsp yield seqi i + n
def smart int string fallback 0 dcsp try dcnl dcsp dcsp return int float string dcnl dcsp except valueerror typeerror overflowerror dcnl dcsp dcsp return fallback
def delete files for obj sender kwargs dcsp obj kwargs pop instance dcnl dcsp for field name in sender meta get all field names dcnl dcsp dcsp if not hasattr obj field name dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp try dcnl dcsp dcsp dcsp field class sender meta get field field name dcnl dcsp dcsp except models fielddoesnotexist dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp field value getattr obj field name dcnl dcsp dcsp if isinstance field class models filefield and field value dcnl dcsp dcsp dcsp field value delete
def auto delete files cls dcsp pre delete connect delete files for obj sender cls dcnl dcsp return cls
def get next url request dcsp if next in request post dcnl dcsp dcsp url request post get next dcnl dcsp elif next in request get dcnl dcsp dcsp url request get get next dcnl dcsp else dcnl dcsp dcsp url request meta get http referer dcnl dcsp if not settings debug and not is safe url url site objects get current domain dcnl dcsp dcsp return none dcnl dcsp return url
def truncated json dumps obj max length key ensure ascii false dcsp orig json dumps obj ensure ascii ensure ascii dcnl dcsp diff len orig max length dcnl dcsp if diff < 0 dcnl dcsp dcsp return orig dcnl dcsp dupe json loads orig dcnl dcsp if len dupekey < diff dcnl dcsp dcsp raise truncationexception can t dcsp truncate dcsp enough dcsp to dcsp satisfy dcsp max length dcnl dcsp dupekey dupekey diff dcnl dcsp return json dumps dupe ensure ascii ensure ascii
def user or ip key prefix dcsp def user or ip request dcnl dcsp dcsp if hasattr request user and request user is authenticated dcnl dcsp dcsp dcsp key str request user pk dcnl dcsp dcsp else dcnl dcsp dcsp dcsp key request meta get http x cluster client ip request meta remote addr dcnl dcsp dcsp return uip s s key prefix key dcnl dcsp return user or ip
contextmanager dcnl def uselocale locale dcsp currlocale translation get language dcnl dcsp translation activate locale dcnl dcsp yield dcnl dcsp translation activate currlocale
def rabbitmq queue size dcsp from celery import current app dcnl dcsp app current app get current object dcnl dcsp conn app connection dcnl dcsp chan conn default channel dcnl dcsp queue chan queue declare celery passive true dcnl dcsp return queue message count
def is ratelimited request name rate method post skip if lambda r false dcsp if skip if request or request user has perm sumo bypass ratelimit dcnl dcsp dcsp request limited false dcnl dcsp else dcnl dcsp dcsp ratelimit helpers is ratelimited request increment true ip false rate rate keys user or ip name dcnl dcsp dcsp if request limited dcnl dcsp dcsp dcsp if hasattr request user and request user is authenticated dcnl dcsp dcsp dcsp dcsp key user dcsp format request user username dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp ip request meta get http x cluster client ip request meta remote addr dcnl dcsp dcsp dcsp dcsp key anonymous dcsp user dcsp format ip dcnl dcsp dcsp dcsp record objects info sumo ratelimit key dcsp hit dcsp the dcsp rate dcsp limit dcsp for dcsp name key key name name dcnl dcsp return request limited
def get browser user agent dcsp match re search i firefox|msie|chrome|safari|trident user agent re ignorecase dcnl dcsp if match dcnl dcsp dcsp browser match group 1 dcnl dcsp else dcnl dcsp dcsp browser none dcnl dcsp return browser
def redis client name dcsp if name not in settings redis backends dcnl dcsp dcsp raise rediserror k dcsp is dcsp not dcsp defined dcsp in dcsp settings redis backends format k name dcnl dcsp uri settings redis backendsname dcnl dcsp server params parse backend uri uri dcnl dcsp db params pop db 1 dcnl dcsp try dcnl dcsp dcsp db int db dcnl dcsp except valueerror typeerror dcnl dcsp dcsp db 1 dcnl dcsp try dcnl dcsp dcsp socket timeout float params pop socket timeout dcnl dcsp except keyerror valueerror dcnl dcsp dcsp socket timeout none dcnl dcsp password params pop password none dcnl dcsp if in server dcnl dcsp dcsp host port server split dcnl dcsp dcsp try dcnl dcsp dcsp dcsp port int port dcnl dcsp dcsp except valueerror typeerror dcnl dcsp dcsp dcsp port 6379 dcnl dcsp else dcnl dcsp dcsp host server dcnl dcsp dcsp port 6379 dcnl dcsp redis redis host host port port db db password password socket timeout socket timeout dcnl dcsp try dcnl dcsp dcsp redis exists dummykey dcnl dcsp except connectionerror dcnl dcsp dcsp raise rediserror unable dcsp to dcsp connect dcsp to dcsp redis dcsp backend dcsp k format k name dcnl dcsp return redis
def parse backend uri backend uri dcsp if backend uri find 1 dcnl dcsp dcsp raise invalidcachebackenderror backend dcsp uri dcsp must dcsp start dcsp with dcsp scheme dcnl dcsp scheme rest backend uri split 1 dcnl dcsp if not rest startswith dcnl dcsp dcsp raise invalidcachebackenderror backend dcsp uri dcsp must dcsp start dcsp with dcsp scheme dcnl dcsp host rest2 dcnl dcsp qpos rest find dcnl dcsp if qpos 1 dcnl dcsp dcsp params dict parse qsl rest qpos + 1 dcnl dcsp dcsp host rest2 qpos dcnl dcsp else dcnl dcsp dcsp params dcnl dcsp if host endswith dcnl dcsp dcsp host host 1 dcnl dcsp return scheme host params
library filter dcnl def paginator pager dcsp return paginator pager render
library global function dcnl def url viewname args kwargs dcsp locale kwargs pop locale none dcnl dcsp return reverse viewname locale locale args args kwargs kwargs
library global function dcnl def unlocalized url viewname args kwargs dcsp return django reverse viewname args args kwargs kwargs
library filter dcnl def urlparams url hash none query dict none query dcsp url urlparse urlparse url dcnl dcsp fragment hash if hash is not none else url fragment dcnl dcsp q url query dcnl dcsp new query dict querydict smart str q mutable true if q else querydict mutable true dcnl dcsp if query dict dcnl dcsp dcsp for k l in query dict lists dcnl dcsp dcsp dcsp new query dictk none dcnl dcsp dcsp dcsp for v in l dcnl dcsp dcsp dcsp dcsp new query dict appendlist k v dcnl dcsp for k v in query items dcnl dcsp dcsp new query dictk v dcnl dcsp query string urlencode k v for k l in new query dict lists for v in l if v is not none dcnl dcsp new urlparse parseresult url scheme url netloc url path url params query string fragment dcnl dcsp return new geturl
library filter dcnl def wiki to html wiki markup locale settings wiki default language nofollow true dcsp return jinja2 markup parser wiki to html wiki markup locale locale nofollow nofollow
jinja2 contextfunction dcnl library global function dcnl def breadcrumbs context items list add default true id none dcsp if add default dcnl dcsp dcsp first crumb u home dcnl dcsp dcsp crumbs reverse home lazy first crumb dcnl dcsp else dcnl dcsp dcsp crumbs dcnl dcsp if items dcnl dcsp dcsp try dcnl dcsp dcsp dcsp crumbs + items dcnl dcsp dcsp except typeerror dcnl dcsp dcsp dcsp crumbs append items dcnl dcsp c breadcrumbs crumbs id id dcnl dcsp return jinja2 markup render to string layout breadcrumbs html c
def babel locale locale dcsp return locale replace
def contextual locale context dcsp request context get request dcnl dcsp locale request language code dcnl dcsp if not localedata exists locale dcnl dcsp dcsp locale settings language code dcnl dcsp return locale
jinja2 contextfunction dcnl library global function dcnl def datetimeformat context value format shortdatetime dcsp if not isinstance value datetime datetime dcnl dcsp dcsp raise valueerror unexpected dcsp value dcsp value dcsp passed dcsp to dcsp datetimeformat format value value dcnl dcsp request context get request dcnl dcsp default tzinfo convert tzinfo timezone settings time zone dcnl dcsp if value tzinfo is none dcnl dcsp dcsp value default tzinfo localize value dcnl dcsp dcsp new value value astimezone default tzinfo dcnl dcsp else dcnl dcsp dcsp new value value dcnl dcsp if hasattr request session dcnl dcsp dcsp if timezone not in request session dcnl dcsp dcsp dcsp if hasattr request user and request user is authenticated dcnl dcsp dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp dcsp convert tzinfo profile objects get user request user timezone or default tzinfo dcnl dcsp dcsp dcsp dcsp except profile doesnotexist attributeerror dcnl dcsp dcsp dcsp dcsp dcsp pass dcnl dcsp dcsp dcsp request session timezone convert tzinfo dcnl dcsp dcsp else dcnl dcsp dcsp dcsp convert tzinfo request session timezone dcnl dcsp convert value new value astimezone convert tzinfo dcnl dcsp locale babel locale contextual locale context dcnl dcsp if format shortdatetime dcnl dcsp dcsp today datetime datetime now tz convert tzinfo toordinal dcnl dcsp dcsp if convert value toordinal today dcnl dcsp dcsp dcsp formatted lazy u today dcsp at dcsp s format time convert value format short tzinfo convert tzinfo locale locale dcnl dcsp dcsp else dcnl dcsp dcsp dcsp formatted format datetime convert value format short tzinfo convert tzinfo locale locale dcnl dcsp elif format longdatetime dcnl dcsp dcsp formatted format datetime convert value format long tzinfo convert tzinfo locale locale dcnl dcsp elif format date dcnl dcsp dcsp formatted format date convert value locale locale dcnl dcsp elif format time dcnl dcsp dcsp formatted format time convert value tzinfo convert tzinfo locale locale dcnl dcsp elif format datetime dcnl dcsp dcsp formatted format datetime convert value tzinfo convert tzinfo locale locale dcnl dcsp elif format year dcnl dcsp dcsp formatted format datetime convert value format yyyy tzinfo convert tzinfo locale locale dcnl dcsp else dcnl dcsp dcsp raise datetimeformaterror dcnl dcsp return jinja2 markup <time dcsp datetime s s< time convert value isoformat formatted
library filter dcnl def collapse linebreaks text dcsp return whitespace then break sub r n text
jinja2 contextfunction dcnl library global function dcnl def number context n dcsp if n is none dcnl dcsp dcsp return dcnl dcsp return format decimal n locale babel locale contextual locale context
library filter dcnl def timesince d now none dcsp if d is none dcnl dcsp dcsp return u dcnl dcsp chunks 60 60 24 365 lambda n ungettext number d dcsp year dcsp ago number d dcsp years dcsp ago n 60 60 24 30 lambda n ungettext number d dcsp month dcsp ago number d dcsp months dcsp ago n 60 60 24 7 lambda n ungettext number d dcsp week dcsp ago number d dcsp weeks dcsp ago n 60 60 24 lambda n ungettext number d dcsp day dcsp ago number d dcsp days dcsp ago n 60 60 lambda n ungettext number d dcsp hour dcsp ago number d dcsp hours dcsp ago n 60 lambda n ungettext number d dcsp minute dcsp ago number d dcsp minutes dcsp ago n 1 lambda n ungettext number d dcsp second dcsp ago number d dcsp seconds dcsp ago n dcnl dcsp if not now dcnl dcsp dcsp if d tzinfo dcnl dcsp dcsp dcsp now datetime datetime now localtimezone d dcnl dcsp dcsp else dcnl dcsp dcsp dcsp now datetime datetime now dcnl dcsp delta now d datetime timedelta 0 0 d microsecond dcnl dcsp since delta days 24 60 60 + delta seconds dcnl dcsp if since < 0 dcnl dcsp dcsp return u dcnl dcsp for i seconds name in enumerate chunks dcnl dcsp dcsp count since seconds dcnl dcsp dcsp if count 0 dcnl dcsp dcsp dcsp break dcnl dcsp return name count number count
library filter dcnl def label with help f dcsp label u <label dcsp for s dcsp title s s< label dcnl dcsp return jinja2 markup label f auto id f help text f label
library filter dcnl def remove list item dcsp return i for i in list if i item
jinja2 contextfunction dcnl library global function dcnl def ga push attribute context dcsp request context get request dcnl dcsp ga push context get ga push dcnl dcsp if request get get fpa 1 and request user is authenticated dcnl dcsp dcsp user request user dcnl dcsp dcsp group names user groups values list name flat true dcnl dcsp dcsp if administrators in group names dcnl dcsp dcsp dcsp ga push append setcustomvar 1 user dcsp type contributor dcsp dcsp admin 1 dcnl dcsp dcsp elif contributors in group names dcnl dcsp dcsp dcsp ga push append setcustomvar 1 user dcsp type contributor 1 dcnl dcsp dcsp else dcnl dcsp dcsp dcsp ga push append setcustomvar 1 user dcsp type registered 1 dcnl dcsp return jsonlib dumps ga push
library global function dcnl def add utm url campaign source notification medium email dcsp return urlparams url utm campaign campaign utm source source utm medium medium
library global function dcnl def static path dcsp try dcnl dcsp dcsp return django static path dcnl dcsp except valueerror as err dcnl dcsp dcsp log error static dcsp helper dcsp error dcsp s err dcnl dcsp dcsp return
library filter dcnl def class selected a b dcsp if a b dcnl dcsp dcsp return jinja2 markup class selected dcnl dcsp else dcnl dcsp dcsp return
library filter dcnl def f format string args kwargs dcsp if isinstance format string str dcnl dcsp dcsp format string unicode format string dcnl dcsp return format string format args kwargs
library filter dcnl def fe format string args kwargs dcsp args jinja2 escape smart text v for v in args dcnl dcsp for k in kwargs dcnl dcsp dcsp kwargsk jinja2 escape smart text kwargsk dcnl dcsp if isinstance format string str dcnl dcsp dcsp format string unicode format string dcnl dcsp return jinja2 markup format string format args kwargs
def test paginated url dcsp url s s reverse search q bookmarks page 2 dcnl dcsp request requestfactory get url dcnl dcsp queryset dcnl dcsp paginated paginate request queryset dcnl dcsp eq paginated url request build absolute uri request path + q bookmarks
def test breadcrumb dcsp c localizingclient dcnl dcsp response c get reverse search dcnl dcsp doc pq response content dcnl dcsp href doc breadcrumbs dcsp a 0 dcnl dcsp eq href attrib href 0
def attrs eq received expected dcsp for k v in expected iteritems dcnl dcsp dcsp eq v getattr received k
def starts with text substring dcsp assert text startswith substring r dcsp doesn t dcsp start dcsp with dcsp r text substring
def send mail raise smtp messages dcsp raise smtprecipientsrefused recipients messages0 recipients
def eq msg a b msg none dcsp assert a b str msg or + dcsp r dcsp dcsp r a b
def template used response template name dcsp templates dcnl dcsp templates + t name for t in getattr response templates dcnl dcsp templates + getattr response jinja templates dcnl dcsp return template name in templates
def global settings request dcsp return settings settings
def aaq languages request dcsp return aaq languages questionlocale objects locales list
def wiki to html wiki markup locale settings wiki default language nofollow true dcsp return wikiparser parse wiki markup show toc false locale locale nofollow nofollow
def get object fallback cls title locale default none kwargs dcsp try dcnl dcsp dcsp return cls objects get title title locale locale kwargs dcnl dcsp except cls doesnotexist ioerror dcnl dcsp dcsp pass dcnl dcsp try dcnl dcsp dcsp default lang doc cls objects get title title locale settings wiki default language kwargs dcnl dcsp dcsp if hasattr default lang doc translated to dcnl dcsp dcsp dcsp trans default lang doc translated to locale dcnl dcsp dcsp dcsp if trans and trans current revision dcnl dcsp dcsp dcsp dcsp return trans dcnl dcsp dcsp if hasattr default lang doc redirect document dcnl dcsp dcsp dcsp target default lang doc redirect document dcnl dcsp dcsp dcsp if target dcnl dcsp dcsp dcsp dcsp trans target translated to locale dcnl dcsp dcsp dcsp dcsp if trans and trans current revision dcnl dcsp dcsp dcsp dcsp dcsp return trans dcnl dcsp dcsp return default lang doc dcnl dcsp except cls doesnotexist ioerror dcnl dcsp dcsp return default
def get wiki link title locale dcsp from kitsune wiki models import document dcnl dcsp d get object fallback document locale locale title title is template false dcnl dcsp if d dcnl dcsp dcsp while d redirect document dcnl dcsp dcsp dcsp d d redirect document dcnl dcsp dcsp url reverse wiki document locale locale args d slug dcnl dcsp dcsp return found true url url text d title dcnl dcsp from kitsune sumo templatetags jinja helpers import urlparams dcnl dcsp return found false text title url urlparams reverse wiki new document locale locale title title
def build hook params string locale allowed params allowed param values dcsp if | not in string dcnl dcsp dcsp string string strip dcnl dcsp dcsp return string alt string dcnl dcsp items i strip for i in string split | dcnl dcsp title items pop 0 dcnl dcsp params dcnl dcsp last item dcnl dcsp for item in items dcnl dcsp dcsp if in item dcnl dcsp dcsp dcsp param value item split 1 dcnl dcsp dcsp dcsp paramsparam value dcnl dcsp dcsp else dcnl dcsp dcsp dcsp paramsitem true dcnl dcsp dcsp dcsp last item item dcnl dcsp if caption in allowed params dcnl dcsp dcsp params caption title dcnl dcsp dcsp if last item and last item not in allowed params dcnl dcsp dcsp dcsp params caption items pop dcnl dcsp dcsp dcsp del paramslast item dcnl dcsp dcsp elif last item caption dcnl dcsp dcsp dcsp params caption last item dcnl dcsp for p in params keys dcnl dcsp dcsp if p not in allowed params dcnl dcsp dcsp dcsp del paramsp dcnl dcsp for p in allowed param values dcnl dcsp dcsp if p in params and paramsp not in allowed param valuesp dcnl dcsp dcsp dcsp del paramsp dcnl dcsp if page in params and params page is not true dcnl dcsp dcsp link get wiki link params page locale dcnl dcsp dcsp params link link url dcnl dcsp dcsp params found link found dcnl dcsp return title params
def generate video v params dcsp sources dcnl dcsp if v webm dcnl dcsp dcsp sources append src get video url v webm type webm dcnl dcsp if v ogv dcnl dcsp dcsp sources append src get video url v ogv type ogg dcnl dcsp data fallback dcnl dcsp if v flv dcnl dcsp dcsp data fallback get video url v flv dcnl dcsp return render to string wikiparser hook video html fallback data fallback sources sources params params video v height settings wiki video height width settings wiki video width
def generate youtube embed video id dcsp return render to string wikiparser hook youtube embed html video id video id
def is youtube url url dcsp parsed url urlparse url dcnl dcsp netloc parsed url netloc dcnl dcsp return netloc in youtu be youtube com www youtube com
def set url prefixer prefixer dcsp locals prefixer prefixer
def get url prefixer dcsp return getattr locals prefixer none
def reverse viewname urlconf none args none kwargs none prefix none force locale false locale none dcsp if locale dcnl dcsp dcsp prefixer prefixer locale locale dcnl dcsp else dcnl dcsp dcsp prefixer get url prefixer dcnl dcsp dcsp if not prefixer and force locale dcnl dcsp dcsp dcsp prefixer prefixer dcnl dcsp if prefixer dcnl dcsp dcsp prefix prefix or dcnl dcsp url django reverse viewname urlconf args kwargs prefix dcnl dcsp if prefixer dcnl dcsp dcsp return prefixer fix url dcnl dcsp else dcnl dcsp dcsp return url
def get non supported lang dcsp lang lang lower dcnl dcsp langs dict k lower v for k v in settings non supported locales items dcnl dcsp if lang in langs dcnl dcsp dcsp if langslang is none dcnl dcsp dcsp dcsp return settings language code dcnl dcsp dcsp return langslang dcnl dcsp return none
def get best language accept lang dcsp lum settings language url map dcnl dcsp nsl settings non supported locales dcnl dcsp lc settings language code dcnl dcsp langs dict lum dcnl dcsp langs update k lower v if v else lc for k v in nsl items if k lower not in langs dcnl dcsp langs update k split 0 v for k v in lum items if k split 0 not in langs dcnl dcsp ranked parse accept lang header accept lang dcnl dcsp for lang in ranked dcnl dcsp dcsp lang lang lower dcnl dcsp dcsp if lang in langs dcnl dcsp dcsp dcsp return langslang dcnl dcsp dcsp pre lang split 0 dcnl dcsp dcsp if pre in langs dcnl dcsp dcsp dcsp return langspre dcnl dcsp return false
def split path path dcsp path path lstrip dcnl dcsp first rest path partition dcnl dcsp lang first lower dcnl dcsp if lang in settings language url map dcnl dcsp dcsp return settings language url maplang rest dcnl dcsp elif get non supported lang is not none dcnl dcsp dcsp return get non supported lang rest dcnl dcsp else dcnl dcsp dcsp supported find supported first dcnl dcsp dcsp if supported dcnl dcsp dcsp dcsp return supported0 rest dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return path
def retry 503 f dcsp wraps f dcnl dcsp def wrapper args kwargs dcnl dcsp dcsp try dcnl dcsp dcsp dcsp return f args kwargs dcnl dcsp dcsp except httperror as e dcnl dcsp dcsp dcsp log error http dcsp error dcsp calling dcsp google dcsp analytics dcsp s e dcnl dcsp dcsp dcsp if e resp status 503 dcnl dcsp dcsp dcsp dcsp return f args kwargs dcnl dcsp return wrapper
def visitors start date end date dcsp visitors dcnl dcsp request build request dcnl dcsp date start date dcnl dcsp while date < end date dcnl dcsp dcsp date str str date dcnl dcsp dcsp visitorsstr date int request get ids ga + profile id start date date str end date date str metrics ga visitors execute rows 00 dcnl dcsp dcsp date + timedelta days 1 dcnl dcsp return visitors
def visitors by locale start date end date dcsp visits by locale dcnl dcsp request build request dcnl dcsp retry 503 dcnl dcsp def make request dcnl dcsp dcsp return request get ids ga + profile id start date str start date end date str end date metrics ga visitors dimensions ga pagepathlevel1 execute dcnl dcsp results make request dcnl dcsp for result in results rows dcnl dcsp dcsp path result01 1 dcnl dcsp dcsp visitors int result1 dcnl dcsp dcsp if path in settings sumo languages dcnl dcsp dcsp dcsp visits by localepath visitors dcnl dcsp return visits by locale
def pageviews by document start date end date verbose false dcsp counts dcnl dcsp request build request dcnl dcsp max results 10000 dcnl dcsp end date step end date dcnl dcsp while true dcnl dcsp dcsp start date step end date step timedelta 90 dcnl dcsp dcsp if start date step < start date dcnl dcsp dcsp dcsp start date step start date dcnl dcsp dcsp if verbose dcnl dcsp dcsp dcsp print fetching dcsp data dcsp for dcsp s dcsp to dcsp s start date step end date step dcnl dcsp dcsp start index 1 dcnl dcsp dcsp while true dcnl dcsp dcsp dcsp retry 503 dcnl dcsp dcsp dcsp def make request dcnl dcsp dcsp dcsp dcsp return request get ids ga + profile id start date str start date step end date str end date step metrics ga pageviews dimensions ga pagepath filters ga pagepathlevel2 kb ga pagepathlevel1 enus max results max results start index start index execute dcnl dcsp dcsp dcsp results make request dcnl dcsp dcsp dcsp if verbose dcnl dcsp dcsp dcsp dcsp d max results 1 if start index + max results 1 < results totalresults else results totalresults start index dcnl dcsp dcsp dcsp dcsp print dcsp got dcsp s dcsp of dcsp s dcsp results start index + d results totalresults dcnl dcsp dcsp dcsp for result in results get rows dcnl dcsp dcsp dcsp dcsp path result0 dcnl dcsp dcsp dcsp dcsp pageviews int result1 dcnl dcsp dcsp dcsp dcsp doc document from url path id only true check host false dcnl dcsp dcsp dcsp dcsp if not doc dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp countsdoc pk counts get doc pk 0 + pageviews dcnl dcsp dcsp dcsp start index + max results dcnl dcsp dcsp dcsp if start index results get totalresults 0 dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp end date step start date step timedelta 1 dcnl dcsp dcsp if start date step start date or end date step < start date dcnl dcsp dcsp dcsp break dcnl dcsp return counts
def pageviews by question start date end date verbose false dcsp counts dcnl dcsp request build request dcnl dcsp max results 10000 dcnl dcsp end date step end date dcnl dcsp while true dcnl dcsp dcsp start date step end date step timedelta 90 dcnl dcsp dcsp if start date step < start date dcnl dcsp dcsp dcsp start date step start date dcnl dcsp dcsp if verbose dcnl dcsp dcsp dcsp print fetching dcsp data dcsp for dcsp s dcsp to dcsp s start date step end date step dcnl dcsp dcsp start index 1 dcnl dcsp dcsp while true dcnl dcsp dcsp dcsp retry 503 dcnl dcsp dcsp dcsp def make request dcnl dcsp dcsp dcsp dcsp return request get ids ga + profile id start date str start date step end date str end date step metrics ga pageviews dimensions ga pagepath filters ga pagepathlevel2 questions max results max results start index start index execute dcnl dcsp dcsp dcsp results make request dcnl dcsp dcsp dcsp if verbose dcnl dcsp dcsp dcsp dcsp d max results 1 if start index + max results 1 < results totalresults else results totalresults start index dcnl dcsp dcsp dcsp dcsp print dcsp got dcsp s dcsp of dcsp s dcsp results start index + d results totalresults dcnl dcsp dcsp dcsp for result in results rows dcnl dcsp dcsp dcsp dcsp path result0 dcnl dcsp dcsp dcsp dcsp pageviews int result1 dcnl dcsp dcsp dcsp dcsp question id question from url path id only true dcnl dcsp dcsp dcsp dcsp if not question id dcnl dcsp dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp dcsp countsquestion id counts get question id 0 + pageviews dcnl dcsp dcsp dcsp start index + max results dcnl dcsp dcsp dcsp if start index results totalresults dcnl dcsp dcsp dcsp dcsp break dcnl dcsp dcsp end date step start date step timedelta 1 dcnl dcsp dcsp if start date step start date or end date step < start date dcnl dcsp dcsp dcsp break dcnl dcsp return counts
def search ctr start date end date dcsp ctr dcnl dcsp request build request dcnl dcsp date start date dcnl dcsp while date < end date dcnl dcsp dcsp date str str date dcnl dcsp dcsp metric name ga goal11conversionrate dcnl dcsp dcsp ctr str request get ids ga + profile id start date date str end date date str metrics metric name execute rows 00 dcnl dcsp dcsp ctrdate str float ctr str dcnl dcsp dcsp date + timedelta days 1 dcnl dcsp return ctr
def jsonp is valid funcname dcsp func regex re compile n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp ^azaz n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp azaz09 n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp azaz09 n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp azaz09 + n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp azaz09 n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp n dcsp dcsp dcsp dcsp re verbose dcnl dcsp return bool func regex match funcname
def markup json view fun dcsp def markup json request args kwargs dcnl dcsp dcsp request is json request get get format json dcnl dcsp dcsp if request is json dcnl dcsp dcsp dcsp request json callback request get get callback strip dcnl dcsp dcsp else dcnl dcsp dcsp dcsp request json callback dcnl dcsp dcsp if request is json dcnl dcsp dcsp dcsp request content type application xjavascript if request json callback else application json dcnl dcsp dcsp else dcnl dcsp dcsp dcsp request content type text html dcnl dcsp dcsp if request json callback and not jsonp is valid request json callback dcnl dcsp dcsp dcsp return httpresponse json dumps error invalid dcsp callback dcsp function content type request content type status 400 dcnl dcsp dcsp return view fun request args kwargs dcnl dcsp return markup json
def ssl required view func dcsp wraps view func dcnl dcsp def checkssl request args kwargs dcnl dcsp dcsp if settings session cookie secure and not request is secure dcnl dcsp dcsp dcsp url str request build absolute uri dcnl dcsp dcsp dcsp url str url str replace http https dcnl dcsp dcsp dcsp return http httpresponseredirect url str dcnl dcsp dcsp return view func request args kwargs dcnl dcsp return checkssl
def json view f dcsp wraps f dcnl dcsp def wrapped req a kw dcnl dcsp dcsp try dcnl dcsp dcsp dcsp ret f req a kw dcnl dcsp dcsp dcsp blob json dumps ret dcnl dcsp dcsp dcsp return http httpresponse blob content type json dcnl dcsp dcsp except http http404 as e dcnl dcsp dcsp dcsp blob json dumps success false error 404 message str e dcnl dcsp dcsp dcsp return http httpresponsenotfound blob content type json dcnl dcsp dcsp except permissiondenied as e dcnl dcsp dcsp dcsp blob json dumps success false error 403 message str e dcnl dcsp dcsp dcsp return http httpresponseforbidden blob content type json dcnl dcsp dcsp except exception as e dcnl dcsp dcsp dcsp blob json dumps success false error 500 message str e dcnl dcsp dcsp dcsp return http httpresponseservererror blob content type json dcnl dcsp return wrapped
def cors enabled origin methods get dcsp def decorator f dcnl dcsp dcsp wraps f dcnl dcsp dcsp def decorated func request args kwargs dcnl dcsp dcsp dcsp if request method options dcnl dcsp dcsp dcsp dcsp if http access control request method in request meta and http access control request headers in request meta dcnl dcsp dcsp dcsp dcsp dcsp response http httpresponse dcnl dcsp dcsp dcsp dcsp dcsp response accesscontrolallowmethods dcsp join methods dcnl dcsp dcsp dcsp dcsp dcsp response accesscontrolallowheaders request meta http access control request headers dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp return http httpresponsebadrequest dcnl dcsp dcsp dcsp elif request method in methods dcnl dcsp dcsp dcsp dcsp response f request args kwargs dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp return http httpresponsebadrequest dcnl dcsp dcsp dcsp response accesscontrolalloworigin origin dcnl dcsp dcsp dcsp return response dcnl dcsp dcsp return decorated func dcnl dcsp return decorator
def timeit f dcsp wraps f dcnl dcsp def timeit args kwargs dcnl dcsp dcsp with statsd timer m n format m f module n f name dcnl dcsp dcsp dcsp result f args kwargs dcnl dcsp dcsp return result dcnl dcsp return timeit
def ratelimit name rate method post skip if lambda r false dcsp def decorator fn dcnl dcsp dcsp wraps fn dcnl dcsp dcsp def wrapped request args kwargs dcnl dcsp dcsp dcsp is ratelimited request name rate method skip if dcnl dcsp dcsp dcsp return fn request args kwargs dcnl dcsp dcsp return wrapped dcnl dcsp return decorator
api view get dcnl def locales api view request dcsp locales dcnl dcsp for lang in settings sumo languages dcnl dcsp dcsp if lang xx dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp locale name localeslang english localized name localeslang native aaq enabled questionlocale objects filter locale lang exists dcnl dcsp dcsp localeslang locale dcnl dcsp return response locales
never cache dcnl mobile template sumo mobile locales html dcnl def locales request template dcsp return render request template dict next url get next url request or reverse home
def geoip suggestion request dcsp locales request get getlist locales dcnl dcsp response locales dcnl dcsp for locale in locales dcnl dcsp dcsp response locales locale localeslocale dcnl dcsp dcsp with uselocale locale dcnl dcsp dcsp dcsp responselocale suggestion would dcsp you dcsp like dcsp to dcsp view dcsp this dcsp page dcsp in dcsp language s dcsp instead confirm yes cancel no dcnl dcsp return httpresponse json dumps response content type application json
anonymous csrf dcnl def handle403 request dcsp no cookies false dcnl dcsp referer request meta get http referer dcnl dcsp if referer dcnl dcsp dcsp no cookies referer endswith reverse users login or referer endswith reverse users register dcnl dcsp return render request handlers 403 html form authenticationform no cookies no cookies status 403
def handle404 request dcsp return render request handlers 404 html status 404
def handle500 request dcsp return render request handlers 500 html status 500
def redirect to request url permanent true kwargs dcsp dest reverse url kwargs kwargs dcnl dcsp if permanent dcnl dcsp dcsp return httpresponsepermanentredirect dest dcnl dcsp return httpresponseredirect dest
def deprecated redirect request url kwargs dcsp dest reverse url kwargs kwargs dcnl dcsp proto https if request is secure else http dcnl dcsp host site objects get current domain dcnl dcsp return render request sumo deprecated html dest dest proto proto host host
def robots request dcsp if not settings engage robots dcnl dcsp dcsp template useragent dcsp ndisallow dcsp dcnl dcsp else dcnl dcsp dcsp template render request sumo robots html dcnl dcsp return httpresponse template content type text plain
def test memcached host port dcsp try dcnl dcsp dcsp s socket socket dcnl dcsp dcsp s connect host port dcnl dcsp dcsp return true dcnl dcsp except exception as exc dcnl dcsp dcsp log critical failed dcsp to dcsp connect dcsp to dcsp memcached dcsp r dcsp s host port exc dcnl dcsp dcsp return false dcnl dcsp finally dcnl dcsp dcsp s close
never cache dcnl def monitor request dcsp status dcnl dcsp memcache results dcnl dcsp try dcnl dcsp dcsp for cache name cache props in settings caches items dcnl dcsp dcsp dcsp result true dcnl dcsp dcsp dcsp backend cache props backend dcnl dcsp dcsp dcsp location cache props location dcnl dcsp dcsp dcsp if isinstance location basestring dcnl dcsp dcsp dcsp dcsp location location split dcnl dcsp dcsp dcsp if memcache in backend dcnl dcsp dcsp dcsp dcsp for loc in location dcnl dcsp dcsp dcsp dcsp dcsp ip port loc split dcnl dcsp dcsp dcsp dcsp dcsp result test memcached ip int port dcnl dcsp dcsp dcsp dcsp dcsp memcache results append info s s dcsp s ip port result dcnl dcsp dcsp if not memcache results dcnl dcsp dcsp dcsp memcache results append error memcache dcsp is dcsp not dcsp configured dcnl dcsp dcsp elif len memcache results < 2 dcnl dcsp dcsp dcsp memcache results append error you dcsp should dcsp have dcsp at dcsp least dcsp 2 dcsp memcache dcsp servers dcsp you dcsp have dcsp s len memcache results dcnl dcsp dcsp else dcnl dcsp dcsp dcsp memcache results append info memcached dcsp servers dcsp look dcsp good dcnl dcsp except exception as exc dcnl dcsp dcsp memcache results append error exception dcsp while dcsp looking dcsp at dcsp memcached dcsp s str exc dcnl dcsp status memcached memcache results dcnl dcsp libraries results dcnl dcsp try dcnl dcsp dcsp image new rgb 16 16 save stringio stringio jpeg dcnl dcsp dcsp libraries results append info pil+jpeg dcsp got dcsp it dcnl dcsp except exception as exc dcnl dcsp dcsp libraries results append error pil+jpeg dcsp probably dcsp missing dcsp failed dcsp to dcsp create dcsp a dcsp jpeg dcsp image dcsp s exc dcnl dcsp status libraries libraries results dcnl dcsp msg we dcsp want dcsp read dcsp + dcsp write dcnl dcsp filepaths settings user avatar path os r ok | os w ok msg settings image upload path os r ok | os w ok msg settings thumbnail upload path os r ok | os w ok msg settings gallery image path os r ok | os w ok msg settings gallery image thumbnail path os r ok | os w ok msg settings gallery video path os r ok | os w ok msg settings gallery video thumbnail path os r ok | os w ok msg settings group avatar path os r ok | os w ok msg dcnl dcsp filepath results dcnl dcsp for path perms notes in filepaths dcnl dcsp dcsp path os path join settings media root path dcnl dcsp dcsp path exists os path isdir path dcnl dcsp dcsp path perms os access path perms dcnl dcsp dcsp if path exists and path perms dcnl dcsp dcsp dcsp filepath results append info s dcsp s dcsp s dcsp s path path exists path perms notes dcnl dcsp status filepaths filepath results dcnl dcsp rabbitmq results dcnl dcsp try dcnl dcsp dcsp rabbit conn establish connection connect timeout 5 dcnl dcsp dcsp rabbit conn connect dcnl dcsp dcsp rabbitmq results append info successfully dcsp connected dcsp to dcsp rabbitmq dcnl dcsp except socket error ioerror as exc dcnl dcsp dcsp rabbitmq results append error error dcsp connecting dcsp to dcsp rabbitmq dcsp s str exc dcnl dcsp except exception as exc dcnl dcsp dcsp rabbitmq results append error exception dcsp while dcsp looking dcsp at dcsp rabbitmq dcsp s str exc dcnl dcsp status rabbitmq rabbitmq results dcnl dcsp es results dcnl dcsp try dcnl dcsp dcsp es utils get doctype stats es utils all read indexes 0 dcnl dcsp dcsp es results append info successfully dcsp connected dcsp to dcsp elasticsearch dcsp and dcsp index dcsp exists dcnl dcsp except es utils es exceptions as exc dcnl dcsp dcsp es results append error elasticsearch dcsp problem dcsp s str exc dcnl dcsp except exception as exc dcnl dcsp dcsp es results append error exception dcsp while dcsp looking dcsp at dcsp elasticsearch dcsp s str exc dcnl dcsp status elasticsearch es results dcnl dcsp redis results dcnl dcsp if hasattr settings redis backends dcnl dcsp dcsp for backend in settings redis backends dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp redis client backend dcnl dcsp dcsp dcsp dcsp redis results append info s dcsp pass backend dcnl dcsp dcsp dcsp except rediserror dcnl dcsp dcsp dcsp dcsp redis results append error s dcsp fail backend dcnl dcsp status redis redis results dcnl dcsp status code 200 dcnl dcsp status summary dcnl dcsp for component output in status items dcnl dcsp dcsp if error in item0 for item in output dcnl dcsp dcsp dcsp status code 500 dcnl dcsp dcsp dcsp status summarycomponent false dcnl dcsp dcsp else dcnl dcsp dcsp dcsp status summarycomponent true dcnl dcsp return render request services monitor html component status status status summary status summary status status code
cors enabled dcnl def serve cors args kwargs dcsp if not settings debug dcnl dcsp dcsp raise runtimeerror don t dcsp use dcsp kitsune sumo views serve cors dcsp in dcsp production dcnl dcsp from django views static import serve dcnl dcsp return serve args kwargs
def format decimal num format none dcsp lang translation get language dcnl dcsp if not localedata exists lang dcnl dcsp dcsp lang settings language code dcnl dcsp locale locale translation to locale lang dcnl dcsp return format locale decimal num format
contextlib contextmanager dcnl def safe query string request dcsp qs request meta query string dcnl dcsp try dcnl dcsp dcsp request meta query string iri to uri qs dcnl dcsp dcsp yield dcnl dcsp finally dcnl dcsp dcsp request meta query string qs
check simple wiki locale dcnl def home request dcsp if request mobile dcnl dcsp dcsp return redirect to request products permanent false dcnl dcsp return render request landings home html products product objects filter visible true
def auth wanted view func dcsp def wrapper request args kwargs dcnl dcsp dcsp is secure settings twitter cookie secure dcnl dcsp dcsp if request cookies get redirect name and is secure and not request is secure dcnl dcsp dcsp dcsp ssl url url request scheme https if is secure else http dcnl dcsp dcsp dcsp return http httpresponseredirect ssl url dcnl dcsp dcsp return view func request args kwargs dcnl dcsp return wrapper
def auth required view func dcsp def wrapper request args kwargs dcnl dcsp dcsp if not request twitter authed dcnl dcsp dcsp dcsp return http httpresponsebadrequest dcnl dcsp dcsp return view func request args kwargs dcnl dcsp return wrapper
def add existing tag tag name tag manager dcsp tag tag objects get name iexact tag name dcnl dcsp tag manager add tag dcnl dcsp return tag name
library global function dcnl def tags to text tags dcsp return join t slug for t in tags
library global function dcnl def tag vocab dcsp return json dumps dict t0 t1 for t in tag objects values list name slug
def unsubscribe request watch id dcsp try dcnl dcsp dcsp watch watch objects get pk watch id dcnl dcsp dcsp secret request get get s dcnl dcsp dcsp if secret watch secret dcnl dcsp dcsp dcsp raise watch doesnotexist dcnl dcsp except watch doesnotexist dcnl dcsp dcsp return render request motidings unsubscribe error html dcnl dcsp if request method post dcnl dcsp dcsp watch delete dcnl dcsp dcsp return render request motidings unsubscribe success html dcnl dcsp return render request motidings unsub html watch watch
def settings request dcsp settings debug get safe settings dcnl dcsp sorted settings key key value settingskey for key in sorted settings keys dcnl dcsp return render to response kadmin settings html pythonpath sys path settings sorted settings title settings requestcontext request
def celery settings request dcsp capital re compile ^az dcnl dcsp settings key for key in dir current app conf if capital match key dcnl dcsp sorted settings key key value if password in key lower else getattr current app conf key for key in sorted settings dcnl dcsp return render to response kadmin settings html settings sorted settings title celery dcsp settings requestcontext request
def env request dcsp return render to response kadmin env view html request request pythonver sys version djangover version
def schema version request dcsp cursor connection cursor dcnl dcsp cursor execute select dcsp version dcsp from dcsp schema version dcnl dcsp version x for x in cursor00 dcnl dcsp return render to response kadmin schema html schema version version title schema dcsp version requestcontext request
def redis info request dcsp redis info dcnl dcsp for key in django settings redis backends keys dcnl dcsp dcsp redis infokey dcnl dcsp dcsp client redis client key dcnl dcsp dcsp redis infokey connection django settings redis backendskey dcnl dcsp dcsp try dcnl dcsp dcsp dcsp cfg client config get dcnl dcsp dcsp dcsp redis infokey config key k value cfgk for k in sorted cfg dcnl dcsp dcsp dcsp info client info dcnl dcsp dcsp dcsp redis infokey info key k value infok for k in sorted info dcnl dcsp dcsp except connectionerror dcnl dcsp dcsp dcsp redis infokey down true dcnl dcsp return render to response kadmin redis html redis info redis info title redis dcsp information requestcontext request
cache page 24 60 60 dcnl def redirect request product version platform locale topic none dcsp redirects redirect objects all dcnl dcsp parts locale product version platform topic dcnl dcsp t topic if topic else dcnl dcsp def f redirect dcnl dcsp dcsp matches redirect product lower in product lower redirect version lower in version lower redirect platform lower in platform lower redirect locale lower in locale lower redirect topic lower t lower dcnl dcsp dcsp return all matches dcnl dcsp redirects filter f redirects dcnl dcsp def ordinal redirect dcnl dcsp dcsp score 0 dcnl dcsp dcsp for i part in enumerate parts dcnl dcsp dcsp dcsp if getattr redirect part dcnl dcsp dcsp dcsp dcsp score + 1 << i dcnl dcsp dcsp return score redirect dcnl dcsp ordered map ordinal redirects dcnl dcsp ordered sort key lambda x x0 reverse true dcnl dcsp def matches redirect kw dcnl dcsp dcsp for part in parts dcnl dcsp dcsp dcsp attr getattr redirect part dcnl dcsp dcsp dcsp if attr dcnl dcsp dcsp dcsp dcsp v kwpart if kwpart else dcnl dcsp dcsp dcsp dcsp if attr lower v lower dcnl dcsp dcsp dcsp dcsp dcsp return false dcnl dcsp dcsp return true dcnl dcsp destination none dcnl dcsp for score redirect in ordered dcnl dcsp dcsp if matches redirect product product version version platform platform locale locale topic topic dcnl dcsp dcsp dcsp destination redirect dcnl dcsp dcsp dcsp break dcnl dcsp if not destination dcnl dcsp dcsp raise http404 dcnl dcsp if destination target startswith http dcnl dcsp dcsp target destination target dcnl dcsp else dcnl dcsp dcsp params as u utm source inproduct dcnl dcsp dcsp if hasattr request eu build dcnl dcsp dcsp dcsp params eu 1 dcnl dcsp dcsp target u s s locale destination target lstrip dcnl dcsp dcsp target urlparams target params dcnl dcsp dcsp if not settings debug and waffle sample is active inproducthttps dcnl dcsp dcsp dcsp domain site objects get current domain dcnl dcsp dcsp dcsp target https s s domain target dcnl dcsp return httpresponseredirect target
def read index group dcsp return u s s settings es index prefix settings es indexesgroup
def write index group dcsp return u s s settings es index prefix settings es write indexesgroup
def get indexes all indexes false dcsp es get es dcnl dcsp status es indices status dcnl dcsp indexes status indices dcnl dcsp if not all indexes dcnl dcsp dcsp indexes dict k v for k v in indexes items if k startswith settings es index prefix dcnl dcsp return name value docs num docs for name value in indexes items
def get doctype stats index dcsp stats dcnl dcsp from kitsune search models import get mapping types dcnl dcsp for cls in get mapping types dcnl dcsp dcsp if cls get index index dcnl dcsp dcsp dcsp s s cls indexes index dcnl dcsp dcsp dcsp statscls get mapping type name s count dcnl dcsp return stats
def format time time to go dcsp if time to go < 60 dcnl dcsp dcsp return ds time to go dcnl dcsp return dm dcsp ds time to go 60 time to go 60
def get documents cls ids dcsp fields cls get mapping properties keys dcnl dcsp ret cls search filter id in ids values dict fields len ids dcnl dcsp return cls reshape ret
def get analysis dcsp analyzers dcnl dcsp filters dcnl dcsp snowball langs eu basque ca catalan da danish nl dutch enus english fi finnish fr french de german hu hungarian it italian no norwegian ptbr portuguese ro romanian ru russian es spanish sv swedish tr turkish dcnl dcsp for locale language in snowball langs items dcnl dcsp dcsp analyzer name es analyzer for locale locale synonyms false dcnl dcsp dcsp analyzersanalyzer name type snowball language language dcnl dcsp dcsp if locale in config es synonym locales dcnl dcsp dcsp dcsp analyzer name es analyzer for locale locale synonyms true dcnl dcsp dcsp dcsp analyzersanalyzer name type custom tokenizer standard filter standard lowercase synonyms + locale stop snowball + locale dcnl dcsp for locale in config es synonym locales dcnl dcsp dcsp filter name filter body es get synonym filter locale dcnl dcsp dcsp filtersfilter name filter body dcnl dcsp dcsp filters snowball + locale type snowball language snowball langslocale dcnl dcsp return analyzer analyzers filter filters
def recreate indexes es none indexes none dcsp if es is none dcnl dcsp dcsp es get es dcnl dcsp if indexes is none dcnl dcsp dcsp indexes all write indexes dcnl dcsp for index in indexes dcnl dcsp dcsp delete index index dcnl dcsp dcsp es indices create index index body mappings get mappings index settings analysis get analysis dcnl dcsp es cluster health wait for status yellow
def get index settings index dcsp return get es indices get settings index index get index get settings
def get indexable percent 100 mapping types none dcsp from kitsune search models import get mapping types dcnl dcsp mapping types get mapping types mapping types dcnl dcsp to index dcnl dcsp percent float percent 100 dcnl dcsp for cls in mapping types dcnl dcsp dcsp indexable cls get indexable dcnl dcsp dcsp if percent < 1 dcnl dcsp dcsp dcsp indexable indexable int indexable count percent dcnl dcsp dcsp to index append cls indexable dcnl dcsp return to index
def index chunk cls id list reraise false dcsp for ids in chunked id list 80 dcnl dcsp dcsp documents dcnl dcsp dcsp for id in ids dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp documents append cls extract document id dcnl dcsp dcsp dcsp except unindexmebro dcnl dcsp dcsp dcsp dcsp cls unindex id dcnl dcsp dcsp dcsp except exception dcnl dcsp dcsp dcsp dcsp log exception unable dcsp to dcsp extract index dcsp document dcsp id dcsp d id dcnl dcsp dcsp dcsp dcsp if reraise dcnl dcsp dcsp dcsp dcsp dcsp raise dcnl dcsp dcsp if documents dcnl dcsp dcsp dcsp cls bulk index documents id field id dcnl dcsp dcsp if settings debug dcnl dcsp dcsp dcsp reset queries
def es reindex cmd percent 100 delete false mapping types none criticalmass false log log dcsp es get es dcnl dcsp if mapping types is none dcnl dcsp dcsp indexes all write indexes dcnl dcsp else dcnl dcsp dcsp indexes indexes for doctypes mapping types dcnl dcsp need delete false dcnl dcsp for index in indexes dcnl dcsp dcsp try dcnl dcsp dcsp dcsp get doctype stats index dcnl dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp if not delete dcnl dcsp dcsp dcsp dcsp log error the dcsp index dcsp s dcsp does dcsp not dcsp exist dcsp you dcsp must dcsp specify dcsp delete index dcnl dcsp dcsp dcsp dcsp need delete true dcnl dcsp if need delete dcnl dcsp dcsp return dcnl dcsp if delete dcnl dcsp dcsp log info wiping dcsp and dcsp recreating dcsp s dcsp join indexes dcnl dcsp dcsp recreate indexes es indexes dcnl dcsp if criticalmass dcnl dcsp dcsp all indexable get indexable mapping types questions question wiki document dcnl dcsp dcsp all indexable0 all indexable00 list reversed all indexable01 15000 dcnl dcsp elif mapping types dcnl dcsp dcsp all indexable get indexable percent mapping types dcnl dcsp else dcnl dcsp dcsp all indexable get indexable percent dcnl dcsp try dcnl dcsp dcsp old refreshes dcnl dcsp dcsp for index in indexes dcnl dcsp dcsp dcsp old refreshesindex get index settings index get index refresh interval 1s dcnl dcsp dcsp dcsp es indices put settings index index body index refresh interval 1 dcnl dcsp dcsp start time time time dcnl dcsp dcsp for cls indexable in all indexable dcnl dcsp dcsp dcsp cls start time time time dcnl dcsp dcsp dcsp total len indexable dcnl dcsp dcsp dcsp if total 0 dcnl dcsp dcsp dcsp dcsp continue dcnl dcsp dcsp dcsp chunk start time time time dcnl dcsp dcsp dcsp log info reindexing dcsp s dcsp s dcsp to dcsp index cls get mapping type name total dcnl dcsp dcsp dcsp i 0 dcnl dcsp dcsp dcsp for chunk in chunked indexable 1000 dcnl dcsp dcsp dcsp dcsp chunk start time time time dcnl dcsp dcsp dcsp dcsp index chunk cls chunk dcnl dcsp dcsp dcsp dcsp i + len chunk dcnl dcsp dcsp dcsp dcsp time to go total i time time cls start time i dcnl dcsp dcsp dcsp dcsp per 1000 time time cls start time i 1000 0 dcnl dcsp dcsp dcsp dcsp this 1000 time time chunk start time dcnl dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp s s dcsp s dcsp s 1000 dcsp avg dcsp s dcsp eta i total format time this 1000 format time per 1000 format time time to go dcnl dcsp dcsp dcsp delta time time time cls start time dcnl dcsp dcsp dcsp log info dcsp dcsp dcsp done dcsp s dcsp total dcsp s 1000 dcsp avg format time delta time format time delta time total 1000 0 dcnl dcsp dcsp delta time time time start time dcnl dcsp dcsp log info done dcsp s dcsp total format time delta time dcnl dcsp finally dcnl dcsp dcsp for index old refresh in old refreshes items dcnl dcsp dcsp dcsp es indices put settings index index body index refresh interval old refresh
def es delete cmd index noinput false log log dcsp try dcnl dcsp dcsp indexes name for name count in get indexes dcnl dcsp except es exceptions dcnl dcsp dcsp log error your dcsp elasticsearch dcsp process dcsp is dcsp not dcsp running dcsp or dcsp es urls dcsp is dcsp set dcsp wrong dcsp in dcsp your dcsp settings local py dcsp file dcnl dcsp dcsp return dcnl dcsp if index not in indexes dcnl dcsp dcsp log error index dcsp s dcsp is dcsp not dcsp a dcsp valid dcsp index index dcnl dcsp dcsp return dcnl dcsp if index in all read indexes and not noinput dcnl dcsp dcsp ret raw input s dcsp is dcsp a dcsp read dcsp index dcsp are dcsp you dcsp sure dcsp you dcsp want dcsp to dcsp delete dcsp it dcsp yes no dcsp index dcnl dcsp dcsp if ret yes dcnl dcsp dcsp dcsp log info not dcsp deleting dcsp the dcsp index dcnl dcsp dcsp dcsp return dcnl dcsp log info deleting dcsp index dcsp s index dcnl dcsp delete index index dcnl dcsp log info done
def es status cmd checkindex false log log dcsp try dcnl dcsp dcsp es deets requests get settings es urls0 json dcnl dcsp except requests exceptions requestexception dcnl dcsp dcsp pass dcnl dcsp read doctype stats dcnl dcsp for index in all read indexes dcnl dcsp dcsp try dcnl dcsp dcsp dcsp read doctype statsindex get doctype stats index dcnl dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp read doctype statsindex none dcnl dcsp if set all read indexes set all write indexes dcnl dcsp dcsp write doctype stats read doctype stats dcnl dcsp else dcnl dcsp dcsp write doctype stats dcnl dcsp dcsp for index in all write indexes dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp write doctype statsindex get doctype stats index dcnl dcsp dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp dcsp write doctype statsindex none dcnl dcsp try dcnl dcsp dcsp indexes get indexes all indexes true dcnl dcsp except es exceptions dcnl dcsp dcsp log error your dcsp elasticsearch dcsp process dcsp is dcsp not dcsp running dcsp or dcsp es urls dcsp is dcsp set dcsp wrong dcsp in dcsp your dcsp settings local py dcsp file dcnl dcsp dcsp return dcnl dcsp log info elasticsearch dcnl dcsp log info dcsp dcsp version dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s es deets version number dcnl dcsp log info settings dcnl dcsp log info dcsp dcsp es urls dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s settings es urls dcnl dcsp log info dcsp dcsp es index prefix dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s settings es index prefix dcnl dcsp log info dcsp dcsp es live indexing dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s settings es live indexing dcnl dcsp log info dcsp dcsp es indexes dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s settings es indexes dcnl dcsp log info dcsp dcsp es write indexes dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp s settings es write indexes dcnl dcsp log info index dcsp stats dcnl dcsp if indexes dcnl dcsp dcsp log info dcsp dcsp list dcsp of dcsp indexes dcnl dcsp dcsp for name count in sorted indexes dcnl dcsp dcsp dcsp read write dcnl dcsp dcsp dcsp if name in all read indexes dcnl dcsp dcsp dcsp dcsp read write append read dcnl dcsp dcsp dcsp if name in all write indexes dcnl dcsp dcsp dcsp dcsp read write append write dcnl dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp 22s dcsp s dcsp s name count join read write dcnl dcsp else dcnl dcsp dcsp log info dcsp dcsp there dcsp are dcsp no dcsp s dcsp indexes settings es index prefix dcnl dcsp if not read doctype stats dcnl dcsp dcsp read index names dcsp join all read indexes dcnl dcsp dcsp log info dcsp dcsp no dcsp read dcsp indexes dcsp exist dcsp s read index names dcnl dcsp else dcnl dcsp dcsp log info dcsp dcsp read dcsp indexes dcnl dcsp dcsp for index stats in read doctype stats items dcnl dcsp dcsp dcsp if stats is none dcnl dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp s dcsp does dcsp not dcsp exist index dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp s index dcnl dcsp dcsp dcsp dcsp for name count in sorted stats items dcnl dcsp dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp dcsp dcsp 22s dcsp d name count dcnl dcsp if set all read indexes set all write indexes dcnl dcsp dcsp log info dcsp dcsp write dcsp indexes dcsp are dcsp the dcsp same dcsp as dcsp the dcsp read dcsp indexes dcnl dcsp elif not write doctype stats dcnl dcsp dcsp write index names dcsp join all write indexes dcnl dcsp dcsp log info dcsp dcsp no dcsp write dcsp indexes dcsp exist dcsp s write index names dcnl dcsp else dcnl dcsp dcsp log info dcsp dcsp write dcsp indexes dcnl dcsp dcsp for index stats in write doctype stats items dcnl dcsp dcsp dcsp if stats is none dcnl dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp s dcsp does dcsp not dcsp exist index dcnl dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp s index dcnl dcsp dcsp dcsp dcsp for name count in sorted stats items dcnl dcsp dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp dcsp dcsp dcsp 22s dcsp d name count dcnl dcsp if checkindex dcnl dcsp dcsp log info checking dcsp index dcsp contents dcnl dcsp dcsp missing docs 0 dcnl dcsp dcsp for cls id list in get indexable dcnl dcsp dcsp dcsp for id group in chunked id list 100 dcnl dcsp dcsp dcsp dcsp doc list get documents cls id group dcnl dcsp dcsp dcsp dcsp if len id group len doc list dcnl dcsp dcsp dcsp dcsp dcsp doc list ids doc id for doc in doc list dcnl dcsp dcsp dcsp dcsp dcsp for id in id group dcnl dcsp dcsp dcsp dcsp dcsp dcsp if id not in doc list ids dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp log info dcsp dcsp dcsp missing dcsp s dcsp s cls get model name id dcnl dcsp dcsp dcsp dcsp dcsp dcsp dcsp missing docs + 1 dcnl dcsp dcsp if missing docs dcnl dcsp dcsp dcsp print there dcsp were dcsp d dcsp missing docs missing docs
def es search cmd query pages 1 log log dcsp from kitsune sumo tests import localizingclient dcnl dcsp from kitsune sumo urlresolvers import reverse dcnl dcsp client localizingclient dcnl dcsp output dcnl dcsp output append search dcsp for dcsp s query dcnl dcsp output append dcnl dcsp data q query format json dcnl dcsp url reverse search dcnl dcsp for pageno in range pages dcnl dcsp dcsp pageno pageno + 1 dcnl dcsp dcsp data page pageno dcnl dcsp dcsp resp client get url data dcnl dcsp dcsp if resp status code 200 dcnl dcsp dcsp dcsp output append error dcsp s resp content dcnl dcsp dcsp dcsp break dcnl dcsp dcsp else dcnl dcsp dcsp dcsp content json loads resp content dcnl dcsp dcsp dcsp results contentu results dcnl dcsp dcsp dcsp for mem in results dcnl dcsp dcsp dcsp dcsp output append u 4d dcsp dcsp 5 2f dcsp dcsp 10s dcsp dcsp 20s mem rank mem score mem type mem title dcnl dcsp dcsp dcsp output append dcnl dcsp for line in output dcnl dcsp dcsp log info line encode ascii ignore
def es analyzer for locale locale synonyms false fallback standard dcsp if locale in settings es locale analyzers dcnl dcsp dcsp analyzer settings es locale analyzerslocale dcnl dcsp dcsp if synonyms and locale in config es synonym locales dcnl dcsp dcsp dcsp analyzer + synonyms dcnl dcsp else dcnl dcsp dcsp analyzer fallback dcnl dcsp if not settings es use plugins and analyzer in settings es plugin analyzers dcnl dcsp dcsp analyzer fallback dcnl dcsp return analyzer
def es query with analyzer query locale dcsp analyzer es analyzer for locale locale synonyms true dcnl dcsp new query dcnl dcsp from kitsune search models import get mapping types dcnl dcsp localized fields dcnl dcsp for mt in get mapping types dcnl dcsp dcsp localized fields extend mt get localized fields dcnl dcsp for k v in query items dcnl dcsp dcsp field action k split dcnl dcsp dcsp if field in localized fields dcnl dcsp dcsp dcsp new query k + analyzer v analyzer dcnl dcsp dcsp else dcnl dcsp dcsp dcsp new queryk v dcnl dcsp return new query
def handle es errors template status code 503 dcsp def handler fun dcnl dcsp dcsp wraps fun dcnl dcsp dcsp def handler request args kwargs dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp return fun request args kwargs dcnl dcsp dcsp dcsp except es exceptions as exc dcnl dcsp dcsp dcsp dcsp is json request get get format json dcnl dcsp dcsp dcsp dcsp callback request get get callback strip dcnl dcsp dcsp dcsp dcsp content type application xjavascript if callback else application json dcnl dcsp dcsp dcsp dcsp if is json dcnl dcsp dcsp dcsp dcsp dcsp return httpresponse json dumps error search dcsp unavailable content type content type status status code dcnl dcsp dcsp dcsp dcsp if callable template dcnl dcsp dcsp dcsp dcsp dcsp actual template template request args kwargs dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp actual template template dcnl dcsp dcsp dcsp dcsp log exception exc dcnl dcsp dcsp dcsp dcsp return render request actual template status 503 dcnl dcsp dcsp return handler dcnl dcsp return handler
task dcnl timeit dcnl def index chunk task write index batch id rec id chunk dcsp cls path id list chunk dcnl dcsp cls from class path cls path dcnl dcsp rec none dcnl dcsp from kitsune search models import record dcnl dcsp try dcnl dcsp dcsp pin this thread dcnl dcsp dcsp rec record objects get pk rec id dcnl dcsp dcsp rec start time datetime datetime now dcnl dcsp dcsp rec message u reindexing dcsp into dcsp s write index dcnl dcsp dcsp rec status record status in progress dcnl dcsp dcsp rec save dcnl dcsp dcsp index chunk cls id list reraise true dcnl dcsp dcsp rec mark success dcnl dcsp except exception dcnl dcsp dcsp if rec is not none dcnl dcsp dcsp dcsp rec mark fail u errored dcsp out dcsp s dcsp s sys exc type sys exc value dcnl dcsp dcsp log exception error dcsp while dcsp indexing dcsp a dcsp chunk dcnl dcsp dcsp raise indexingtaskerror dcnl dcsp finally dcnl dcsp dcsp unpin this thread
task dcnl timeit dcnl def index task cls id list kw dcsp statsd incr search tasks index task s cls get mapping type name dcnl dcsp try dcnl dcsp dcsp pin this thread dcnl dcsp dcsp qs cls get model objects filter pk in id list values list pk flat true dcnl dcsp dcsp for id in qs dcnl dcsp dcsp dcsp try dcnl dcsp dcsp dcsp dcsp cls index cls extract document id id id dcnl dcsp dcsp dcsp except unindexmebro dcnl dcsp dcsp dcsp dcsp cls unindex id dcnl dcsp except exception as exc dcnl dcsp dcsp retries index task request retries dcnl dcsp dcsp if retries max retries dcnl dcsp dcsp dcsp raise indexingtaskerror dcnl dcsp dcsp statsd incr search tasks index task retry 1 dcnl dcsp dcsp statsd incr search tasks index task retry d retry timesretries 1 dcnl dcsp dcsp index task retry exc exc max retries max retries countdown retry timesretries dcnl dcsp finally dcnl dcsp dcsp unpin this thread
task dcnl timeit dcnl def unindex task cls id list kw dcsp statsd incr search tasks unindex task s cls get mapping type name dcnl dcsp try dcnl dcsp dcsp pin this thread dcnl dcsp dcsp for id in id list dcnl dcsp dcsp dcsp cls unindex id dcnl dcsp except exception as exc dcnl dcsp dcsp retries unindex task request retries dcnl dcsp dcsp if retries max retries dcnl dcsp dcsp dcsp raise indexingtaskerror dcnl dcsp dcsp statsd incr search tasks unindex task retry 1 dcnl dcsp dcsp statsd incr search tasks unindex task retry d retry timesretries 1 dcnl dcsp dcsp unindex task retry exc exc max retries max retries countdown retry timesretries dcnl dcsp finally dcnl dcsp dcsp unpin this thread
def parse synonyms text dcsp errors dcnl dcsp synonyms set dcnl dcsp for i line in enumerate text split n 1 dcnl dcsp dcsp line line strip dcnl dcsp dcsp if not line dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp count line count dcnl dcsp dcsp if count < 1 dcnl dcsp dcsp dcsp errors append syntax dcsp error dcsp on dcsp line dcsp d dcsp no dcsp dcsp found i dcnl dcsp dcsp elif count 1 dcnl dcsp dcsp dcsp errors append syntax dcsp error dcsp on dcsp line dcsp d dcsp too dcsp many dcsp dcsp found i dcnl dcsp dcsp else dcnl dcsp dcsp dcsp from words to words s strip for s in line split dcnl dcsp dcsp dcsp synonyms add from words to words dcnl dcsp if errors dcnl dcsp dcsp raise synonymparseerror errors dcnl dcsp else dcnl dcsp dcsp return synonyms
def count out of date dcsp es es utils get es dcnl dcsp index name es utils write index default dcnl dcsp settings es indices get settings index name get index name get settings dcnl dcsp synonym key re re compile index analysis filter synonyms synonyms d+ dcnl dcsp synonyms in es set dcnl dcsp for key val in settings items dcnl dcsp dcsp if synonym key re match key dcnl dcsp dcsp dcsp synonyms in es add val dcnl dcsp synonyms in db set unicode s for s in synonym objects all dcnl dcsp synonyms to add synonyms in db synonyms in es dcnl dcsp synonyms to remove synonyms in es synonyms in db dcnl dcsp if synonyms to remove set firefox dcsp dcsp firefox dcnl dcsp dcsp synonyms to remove set dcnl dcsp return len synonyms to add len synonyms to remove
def locale or default locale dcsp if locale not in locales dcnl dcsp dcsp locale settings language code dcnl dcsp return locale
def chunked iterable n dcsp iterable iter iterable dcnl dcsp while 1 dcnl dcsp dcsp t tuple islice iterable n dcnl dcsp dcsp if t dcnl dcsp dcsp dcsp yield t dcnl dcsp dcsp else dcnl dcsp dcsp dcsp return
def to class path cls dcsp return join cls module cls name
def from class path cls path dcsp module path cls name cls path split dcnl dcsp module import module path fromlist cls name dcnl dcsp return getattr module cls name
def apply boosts searcher dcsp return searcher boost question title 4 0 question content 3 0 question answer content 3 0 post title 2 0 post content 1 0 document title 6 0 document content 1 0 document keywords 8 0 document summary 2 0 document title match phrase 10 0 document content match phrase 8 0
def generate simple search search form language with highlights false dcsp searcher es utils analyzers es urls settings es urls indexes es utils read index default dcnl dcsp cleaned search form cleaned data dcnl dcsp doctypes dcnl dcsp final filter es utils f dcnl dcsp cleaned q cleaned q dcnl dcsp products cleaned product dcnl dcsp if cleaned w constants where wiki dcnl dcsp dcsp wiki f es utils f model wiki document document category in settings search default categories document locale language document is archived false dcnl dcsp dcsp for p in products dcnl dcsp dcsp dcsp wiki f es utils f product p dcnl dcsp dcsp doctypes append documentmappingtype get mapping type name dcnl dcsp dcsp final filter | wiki f dcnl dcsp if cleaned w constants where support dcnl dcsp dcsp question f es utils f model questions question question is archived false question has helpful true dcnl dcsp dcsp for p in products dcnl dcsp dcsp dcsp question f es utils f product p dcnl dcsp dcsp doctypes append questionmappingtype get mapping type name dcnl dcsp dcsp final filter | question f dcnl dcsp searcher searcher doctypes doctypes dcnl dcsp searcher searcher filter final filter dcnl dcsp if cleaned explain dcnl dcsp dcsp searcher searcher explain dcnl dcsp if with highlights dcnl dcsp dcsp searcher searcher highlight question content document summary pre tags <b post tags < b number of fragments 0 dcnl dcsp searcher apply boosts searcher dcnl dcsp query fields chain cls get query fields for cls in documentmappingtype questionmappingtype dcnl dcsp query dcnl dcsp for field in query fields dcnl dcsp dcsp for query type in match match phrase dcnl dcsp dcsp dcsp query s s field query type cleaned q dcnl dcsp query es utils es query with analyzer query language dcnl dcsp searcher searcher query should true query dcnl dcsp return searcher
def get mapping types mapping types none dcsp if mapping types is none dcnl dcsp dcsp values search mapping types values dcnl dcsp else dcnl dcsp dcsp values search mapping typesname for name in mapping types dcnl dcsp values sort key lambda cls cls get mapping type name dcnl dcsp return values
def local tasks dcsp if getattr local tasks none is none dcnl dcsp dcsp local tasks set dcnl dcsp return local tasks
def register for indexing app sender class instance to indexee identity m2m false dcsp def maybe call method instance is raw method name dcnl dcsp dcsp call dcsp an dcsp un indexing dcsp method dcsp on dcsp instance dcsp if dcsp appropriate dcnl dcsp dcsp obj instance to indexee instance dcnl dcsp dcsp if obj is not none and not is raw dcnl dcsp dcsp dcsp getattr obj method name dcnl dcsp def update sender instance kw dcnl dcsp dcsp file dcsp an dcsp addtoindex dcsp task dcsp for dcsp the dcsp indicated dcsp object dcnl dcsp dcsp maybe call method instance kw get raw index later dcnl dcsp def delete sender instance kw dcnl dcsp dcsp file dcsp a dcsp removefromindex dcsp task dcsp for dcsp the dcsp indicated dcsp object dcnl dcsp dcsp maybe call method instance kw get raw unindex later dcnl dcsp def indexing receiver signal signal name dcnl dcsp dcsp return dcsp a dcsp routine dcsp that dcsp registers dcsp signal dcsp handlers dcsp for dcsp indexers n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp the dcsp returned dcsp registration dcsp routine dcsp uses dcsp strong dcsp refs dcsp makes dcsp up dcsp a n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dispatch uid dcsp and dcsp uses dcsp sender class dcsp as dcsp the dcsp sender n n dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcsp dcnl dcsp dcsp return receiver signal sender sender class dispatch uid s s elastic s app sender class name signal name weak false dcnl dcsp if m2m dcnl dcsp dcsp indexing receiver m2m changed m2m changed update dcnl dcsp else dcnl dcsp dcsp indexing receiver post save post save update dcnl dcsp dcsp indexing receiver pre delete pre delete delete if instance to indexee is identity else update
def register mapping type cls dcsp search mapping typescls get mapping type name cls dcnl dcsp return cls
def generate tasks kwargs dcsp tasks local tasks dcnl dcsp for fun args in tasks dcnl dcsp dcsp fun args dcnl dcsp tasks clear
def handle reset request dcsp for rec in record objects outstanding dcnl dcsp dcsp rec mark fail cancelled dcnl dcsp return httpresponseredirect request path
def create batch id dcsp return str int time time 6
def handle delete request dcsp index to delete request post get delete index dcnl dcsp es indexes name for name count in get indexes dcnl dcsp if not index to delete startswith settings es index prefix dcnl dcsp dcsp raise deleteerror s dcsp is dcsp not dcsp a dcsp valid dcsp index dcsp name index to delete dcnl dcsp if index to delete not in es indexes dcnl dcsp dcsp raise deleteerror s dcsp does dcsp not dcsp exist index to delete dcnl dcsp if index to delete read index default dcnl dcsp dcsp raise deleteerror s dcsp is dcsp the dcsp default dcsp read dcsp index index to delete dcnl dcsp delete index index to delete dcnl dcsp return httpresponseredirect request path
def reindex mapping type names dcsp outstanding record objects outstanding count dcnl dcsp if outstanding 0 dcnl dcsp dcsp raise reindexerror there dcsp are dcsp s dcsp outstanding dcsp chunks outstanding dcnl dcsp batch id create batch id dcnl dcsp chunks dcnl dcsp for cls indexable in get indexable mapping types mapping type names dcnl dcsp dcsp chunks extend cls chunk for chunk in chunked indexable chunk size dcnl dcsp for cls id list in chunks dcnl dcsp dcsp index cls get index dcnl dcsp dcsp chunk name indexing dcsp s dcsp d dcsp dcsp d cls get mapping type name id list0 id list 1 dcnl dcsp dcsp rec record objects create batch id batch id name chunk name dcnl dcsp dcsp index chunk task delay index batch id rec id to class path cls id list
def handle recreate index request dcsp groups name replace check for name in request post keys if name startswith check dcnl dcsp indexes write index group for group in groups dcnl dcsp recreate indexes indexes indexes dcnl dcsp mapping types names mt get mapping type name for mt in get mapping types if mt get index group in groups dcnl dcsp reindex mapping types names dcnl dcsp return httpresponseredirect request path
def handle reindex request dcsp mapping type names name replace check for name in request post keys if name startswith check dcnl dcsp reindex mapping type names dcnl dcsp return httpresponseredirect request path
def search request dcsp if not request user has perm search reindex dcnl dcsp dcsp raise permissiondenied dcnl dcsp error messages dcnl dcsp stats dcnl dcsp if reset in request post dcnl dcsp dcsp try dcnl dcsp dcsp dcsp return handle reset request dcnl dcsp dcsp except reindexerror as e dcnl dcsp dcsp dcsp error messages append u error dcsp s e message dcnl dcsp if reindex in request post dcnl dcsp dcsp try dcnl dcsp dcsp dcsp return handle reindex request dcnl dcsp dcsp except reindexerror as e dcnl dcsp dcsp dcsp error messages append u error dcsp s e message dcnl dcsp if recreate index in request post dcnl dcsp dcsp try dcnl dcsp dcsp dcsp return handle recreate index request dcnl dcsp dcsp except reindexerror as e dcnl dcsp dcsp dcsp error messages append u error dcsp s e message dcnl dcsp if delete index in request post dcnl dcsp dcsp try dcnl dcsp dcsp dcsp return handle delete request dcnl dcsp dcsp except deleteerror as e dcnl dcsp dcsp dcsp error messages append u error dcsp s e message dcnl dcsp dcsp except es exceptions as e dcnl dcsp dcsp dcsp error messages append error dcsp 0 format repr e dcnl dcsp stats none dcnl dcsp write stats none dcnl dcsp es deets none dcnl dcsp indexes dcnl dcsp try dcnl dcsp dcsp es deets requests get settings es urls0 json dcnl dcsp except requests exceptions requestexception dcnl dcsp dcsp pass dcnl dcsp stats dcnl dcsp for index in all read indexes dcnl dcsp dcsp try dcnl dcsp dcsp dcsp statsindex get doctype stats index dcnl dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp statsindex none dcnl dcsp write stats dcnl dcsp for index in all write indexes dcnl dcsp dcsp try dcnl dcsp dcsp dcsp write statsindex get doctype stats index dcnl dcsp dcsp except es exceptions dcnl dcsp dcsp dcsp write statsindex none dcnl dcsp try dcnl dcsp dcsp indexes get indexes dcnl dcsp dcsp indexes sort key lambda m m0 dcnl dcsp except es exceptions as e dcnl dcsp dcsp error messages append error dcsp 0 format repr e dcnl dcsp recent records record objects all 100 dcnl dcsp outstanding records record objects outstanding dcnl dcsp index groups set settings es indexes keys dcnl dcsp index groups | set settings es write indexes keys dcnl dcsp index group data group read index group write index group for group in index groups dcnl dcsp return render request admin search maintenance html title search es deets es deets doctype stats stats doctype write stats write stats indexes indexes index groups index groups index group data index group data read indexes all read indexes write indexes all write indexes error messages error messages recent records recent records outstanding records outstanding records now datetime now read index read index write index write index
def fix results results dcsp results obj results dict for obj in results dcnl dcsp for obj in results dcnl dcsp dcsp for key in indexed on created updated dcnl dcsp dcsp dcsp if key in obj and not isinstance objkey datetime dcnl dcsp dcsp dcsp dcsp objkey datetime fromtimestamp int objkey dcnl dcsp return results
def cache control resp cache period dcsp resp cachecontrol maxage s cache period 60 dcnl dcsp resp expires datetime utcnow + timedelta minutes cache period strftime a dcsp d dcsp b dcsp y dcsp h m s dcsp gmt dcnl dcsp return resp
def es down template request args kwargs dcsp return search mobile down html if request mobile else search down html
def build results list pages is json dcsp results dcnl dcsp for rank doc in enumerate pages pages start index dcnl dcsp dcsp if doc model wiki document dcnl dcsp dcsp dcsp summary build es excerpt doc dcnl dcsp dcsp dcsp if not summary dcnl dcsp dcsp dcsp dcsp summary doc document summary dcnl dcsp dcsp dcsp result title doc document title type document dcnl dcsp dcsp elif doc model questions question dcnl dcsp dcsp dcsp summary build es excerpt doc dcnl dcsp dcsp dcsp if not summary dcnl dcsp dcsp dcsp dcsp summary bleach clean doc question content strip true 500 dcnl dcsp dcsp dcsp result title doc question title type question last updated datetime fromtimestamp doc updated is solved doc question is solved num answers doc question num answers num votes doc question num votes num votes past week doc question num votes past week dcnl dcsp dcsp elif doc model forums thread dcnl dcsp dcsp dcsp summary build es excerpt doc first only true dcnl dcsp dcsp dcsp result title doc post title type thread dcnl dcsp dcsp else dcnl dcsp dcsp dcsp raise unknowndoctype s dcsp is dcsp an dcsp unknown dcsp doctype doc model dcnl dcsp dcsp result url doc url dcnl dcsp dcsp if not is json dcnl dcsp dcsp dcsp result object doc dcnl dcsp dcsp result search summary summary dcnl dcsp dcsp result rank rank dcnl dcsp dcsp result score doc es meta score dcnl dcsp dcsp result explanation escape format explanation doc es meta explanation dcnl dcsp dcsp result id doc id dcnl dcsp dcsp results append result dcnl dcsp return results
markup json dcnl handle es errors es down template dcnl mobile template search mobile results html dcnl def simple search request template none dcsp to json jsonrenderer render dcnl dcsp if request get get a in 1 2 dcnl dcsp dcsp new url reverse search advanced + + request get urlencode dcnl dcsp dcsp return httpresponseredirect new url dcnl dcsp search form simplesearchform request get auto id false dcnl dcsp if not search form is valid dcnl dcsp dcsp if request is json dcnl dcsp dcsp dcsp return httpresponse json dumps error invalid dcsp search dcsp data content type request content type status 400 dcnl dcsp dcsp t template if request mobile else search form html dcnl dcsp dcsp return cache control render request t advanced false request request search form search form settings search cache period dcnl dcsp cleaned search form cleaned data dcnl dcsp if request mobile and cleaned w constants where basic dcnl dcsp dcsp cleaned w constants where wiki dcnl dcsp language locale or default cleaned language or request language code dcnl dcsp lang name settings languages dict get language lower or dcnl dcsp searcher generate simple search search form language with highlights true dcnl dcsp searcher searcher settings search max results dcnl dcsp pages paginate request searcher settings search results per page dcnl dcsp if pages paginator count 0 dcnl dcsp dcsp fallback results fallback results language cleaned product dcnl dcsp dcsp results dcnl dcsp else dcnl dcsp dcsp fallback results none dcnl dcsp dcsp results build results list pages request is json dcnl dcsp product product objects filter slug in cleaned product dcnl dcsp if product dcnl dcsp dcsp product titles pgettext db dcsp products product title p title for p in product dcnl dcsp else dcnl dcsp dcsp product titles all dcsp products dcnl dcsp product titles dcsp join product titles dcnl dcsp data num results pages paginator count results results fallback results fallback results product titles product titles q cleaned q w cleaned w lang name lang name products product objects filter visible true dcnl dcsp if request is json dcnl dcsp dcsp data total len data results dcnl dcsp dcsp data products slug p slug title p title for p in data products dcnl dcsp dcsp if product dcnl dcsp dcsp dcsp data product product0 slug dcnl dcsp dcsp pages paginator pages dcnl dcsp dcsp data pagination dict number pages pager number num pages pages pager paginator num pages has next pages pager has next has previous pages pager has previous max pages max span pages span dotted upper pages pager dotted upper dotted lower pages pager dotted lower page range pages pager page range url pages pager url dcnl dcsp dcsp if not results dcnl dcsp dcsp dcsp data message no dcsp pages dcsp matched dcsp the dcsp search dcsp criteria dcnl dcsp dcsp json data to json data dcnl dcsp dcsp if request json callback dcnl dcsp dcsp dcsp json data request json callback + + json data + dcnl dcsp dcsp return httpresponse json data content type request content type dcnl dcsp data update product product pages pages search form search form advanced false dcnl dcsp resp cache control render request template data settings search cache period dcnl dcsp resp set cookie settings last search cookie urlquote cleaned q max age 3600 secure false httponly false dcnl dcsp return resp
markup json dcnl handle es errors es down template dcnl mobile template search mobile results html dcnl def advanced search request template none dcsp to json jsonrenderer render dcnl dcsp r request get copy dcnl dcsp a request get get a 2 dcnl dcsp r a 1 dcnl dcsp language locale or default request get get language request language code dcnl dcsp r language language dcnl dcsp lang language lower dcnl dcsp lang name settings languages dict get lang or dcnl dcsp search form advancedsearchform r auto id false dcnl dcsp search form set allowed forums request user dcnl dcsp if a 2 or not search form is valid dcnl dcsp dcsp if request is json dcnl dcsp dcsp dcsp return httpresponse json dumps error invalid dcsp search dcsp data content type request content type status 400 dcnl dcsp dcsp t template if request mobile else search form html dcnl dcsp dcsp data advanced true request request search form search form dcnl dcsp dcsp last search request cookies get settings last search cookie dcnl dcsp dcsp if last search and q not in r dcnl dcsp dcsp dcsp cached field urlquote last search dcnl dcsp dcsp dcsp data update cached field cached field dcnl dcsp dcsp return cache control render request t data settings search cache period dcnl dcsp cleaned search form cleaned data dcnl dcsp if request mobile and cleaned w constants where basic dcnl dcsp dcsp cleaned w constants where wiki dcnl dcsp searcher analyzers es urls settings es urls indexes es utils read index default dcnl dcsp doctypes dcnl dcsp final filter f dcnl dcsp unix now int time time dcnl dcsp interval filters created cleaned created cleaned created date updated cleaned updated cleaned updated date dcnl dcsp if cleaned w constants where wiki dcnl dcsp dcsp wiki f f model wiki document dcnl dcsp dcsp if cleaned category dcnl dcsp dcsp dcsp wiki f f document category in cleaned category dcnl dcsp dcsp wiki f f document locale language dcnl dcsp dcsp products cleaned product dcnl dcsp dcsp for p in products dcnl dcsp dcsp dcsp wiki f f product p dcnl dcsp dcsp topics cleaned topics dcnl dcsp dcsp for t in topics dcnl dcsp dcsp dcsp wiki f f topic t dcnl dcsp dcsp if not cleaned include archived dcnl dcsp dcsp dcsp wiki f f document is archived false dcnl dcsp dcsp sortby cleaned sortby documents dcnl dcsp dcsp try dcnl dcsp dcsp dcsp searcher searcher order by constants sort documentssortby dcnl dcsp dcsp except indexerror dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp doctypes append documentmappingtype get mapping type name dcnl dcsp dcsp final filter | wiki f dcnl dcsp if cleaned w constants where support dcnl dcsp dcsp question f f model questions question dcnl dcsp dcsp ternary filters is locked is solved has answers has helpful is archived dcnl dcsp dcsp d dict question s filter name ternary filter cleanedfilter name for filter name in ternary filters if cleanedfilter name dcnl dcsp dcsp if d dcnl dcsp dcsp dcsp question f f d dcnl dcsp dcsp if cleaned asked by dcnl dcsp dcsp dcsp question f f question creator cleaned asked by dcnl dcsp dcsp if cleaned answered by dcnl dcsp dcsp dcsp question f f question answer creator cleaned answered by dcnl dcsp dcsp q tags t strip for t in cleaned q tags split dcnl dcsp dcsp for t in q tags dcnl dcsp dcsp dcsp if t dcnl dcsp dcsp dcsp dcsp question f f question tag t dcnl dcsp dcsp products cleaned product dcnl dcsp dcsp for p in products dcnl dcsp dcsp dcsp question f f product p dcnl dcsp dcsp topics cleaned topics dcnl dcsp dcsp for t in topics dcnl dcsp dcsp dcsp question f f topic t dcnl dcsp dcsp if cleaned num voted constants interval before dcnl dcsp dcsp dcsp question f f question num votes lte max cleaned num votes 0 dcnl dcsp dcsp elif cleaned num voted constants interval after dcnl dcsp dcsp dcsp question f f question num votes gte cleaned num votes dcnl dcsp dcsp sortby cleaned sortby dcnl dcsp dcsp try dcnl dcsp dcsp dcsp searcher searcher order by constants sort questionssortby dcnl dcsp dcsp except indexerror dcnl dcsp dcsp dcsp pass dcnl dcsp dcsp for filter name filter option filter date in interval filters dcnl dcsp dcsp dcsp if filter option constants interval before dcnl dcsp dcsp dcsp dcsp before filter name + gte 0 filter name + lte max filter date 0 dcnl dcsp dcsp dcsp dcsp question f f before dcnl dcsp dcsp dcsp elif filter option constants interval after dcnl dcsp dcsp dcsp dcsp after filter name + gte min filter date unix now filter name + lte unix now dcnl dcsp dcsp dcsp dcsp question f f after dcnl dcsp dcsp doctypes append questionmappingtype get mapping type name dcnl dcsp dcsp final filter | question f dcnl dcsp if cleaned w constants where discussion dcnl dcsp dcsp discussion f f model forums thread dcnl dcsp dcsp if cleaned author dcnl dcsp dcsp dcsp discussion f f post author ord cleaned author dcnl dcsp dcsp if cleaned thread type dcnl dcsp dcsp dcsp if constants discussion sticky in cleaned thread type dcnl dcsp dcsp dcsp dcsp discussion f f post is sticky 1 dcnl dcsp dcsp dcsp if constants discussion locked in cleaned thread type dcnl dcsp dcsp dcsp dcsp discussion f f post is locked 1 dcnl dcsp dcsp valid forum ids f id for f in forum authorized forums for user request user dcnl dcsp dcsp forum ids none dcnl dcsp dcsp if cleaned forum dcnl dcsp dcsp dcsp forum ids f for f in cleaned forum if f in valid forum ids dcnl dcsp dcsp if not forum ids dcnl dcsp dcsp dcsp forum ids valid forum ids dcnl dcsp dcsp discussion f f post forum id in forum ids dcnl dcsp dcsp for filter name filter option filter date in interval filters dcnl dcsp dcsp dcsp if filter option constants interval before dcnl dcsp dcsp dcsp dcsp before filter name + gte 0 filter name + lte max filter date 0 dcnl dcsp dcsp dcsp dcsp discussion f f before dcnl dcsp dcsp dcsp elif filter option constants interval after dcnl dcsp dcsp dcsp dcsp after filter name + gte min filter date unix now filter name + lte unix now dcnl dcsp dcsp dcsp dcsp discussion f f after dcnl dcsp dcsp doctypes append threadmappingtype get mapping type name dcnl dcsp dcsp final filter | discussion f dcnl dcsp searcher searcher doctypes doctypes dcnl dcsp searcher searcher filter final filter dcnl dcsp if explain in request get and request get explain 1 dcnl dcsp dcsp searcher searcher explain dcnl dcsp cleaned q cleaned q dcnl dcsp searcher searcher highlight question content document summary post content pre tags <b post tags < b number of fragments 0 dcnl dcsp searcher apply boosts searcher dcnl dcsp if cleaned q dcnl dcsp dcsp query fields chain cls get query fields for cls in documentmappingtype threadmappingtype questionmappingtype dcnl dcsp dcsp query dcnl dcsp dcsp for field in query fields dcnl dcsp dcsp dcsp query s sqs field cleaned q dcnl dcsp dcsp query es utils es query with analyzer query language dcnl dcsp dcsp searcher searcher query should true query dcnl dcsp searcher searcher settings search max results dcnl dcsp pages paginate request searcher settings search results per page dcnl dcsp if pages paginator count 0 dcnl dcsp dcsp fallback results fallback results language cleaned product dcnl dcsp dcsp results dcnl dcsp else dcnl dcsp dcsp fallback results none dcnl dcsp dcsp results build results list pages request is json dcnl dcsp items k v for k in search form fields for v in r getlist k if v and k a dcnl dcsp items append a 2 dcnl dcsp product product objects filter slug in cleaned product dcnl dcsp if product dcnl dcsp dcsp product titles pgettext db dcsp products product title p title for p in product dcnl dcsp else dcnl dcsp dcsp product titles all dcsp products dcnl dcsp product titles dcsp join product titles dcnl dcsp data num results pages paginator count results results fallback results fallback results product titles product titles q cleaned q w cleaned w lang name lang name advanced true products product objects filter visible true dcnl dcsp if request is json dcnl dcsp dcsp data total len data results dcnl dcsp dcsp data products slug p slug title p title for p in data products dcnl dcsp dcsp if product dcnl dcsp dcsp dcsp data product product0 slug dcnl dcsp dcsp pages paginator pages dcnl dcsp dcsp data pagination dict number pages pager number num pages pages pager paginator num pages has next pages pager has next has previous pages pager has previous max pages max span pages span dotted upper pages pager dotted upper dotted lower pages pager dotted lower page range pages pager page range url pages pager url dcnl dcsp dcsp if not results dcnl dcsp dcsp dcsp data message no dcsp pages dcsp matched dcsp the dcsp search dcsp criteria dcnl dcsp dcsp json data to json data dcnl dcsp dcsp if request json callback dcnl dcsp dcsp dcsp json data request json callback + + json data + dcnl dcsp dcsp return httpresponse json data content type request content type dcnl dcsp data update product product pages pages search form search form dcnl dcsp resp cache control render request template data settings search cache period dcnl dcsp resp set cookie settings last search cookie urlquote cleaned q max age 3600 secure false httponly false dcnl dcsp return resp
cache page 60 15 dcnl def opensearch suggestions request dcsp content type application xsuggestions+json dcnl dcsp search form simplesearchform request get auto id false dcnl dcsp if not search form is valid dcnl dcsp dcsp return httpresponsebadrequest content type content type dcnl dcsp cleaned search form cleaned data dcnl dcsp language locale or default cleaned language or request language code dcnl dcsp searcher generate simple search search form language with highlights false dcnl dcsp searcher searcher values dict document title question title url dcnl dcsp results searcher 10 dcnl dcsp def urlize r dcnl dcsp dcsp return u s s s https if request is secure else http request get host r url 0 dcnl dcsp def titleize r dcnl dcsp dcsp return r get document title r get question title no dcsp title 0 dcnl dcsp try dcnl dcsp dcsp data cleaned q titleize r for r in results urlize r for r in results dcnl dcsp except es exceptions dcnl dcsp dcsp data dcnl dcsp return httpresponse json dumps data content type content type
cache page 60 60 168 dcnl def opensearch plugin request dcsp host u s s https if request is secure else http request get host dcnl dcsp return render to response search plugin html host host locale request language code content type application opensearchdescription+xml
def ternary filter ternary value dcsp return ternary value constants ternary yes
def build es excerpt result first only false dcsp bits m strip for m in chain result es meta highlight values dcnl dcsp if first only and bits dcnl dcsp dcsp excerpt bits0 dcnl dcsp else dcnl dcsp dcsp excerpt excerpt joiner join bits dcnl dcsp return jinja2 markup clean excerpt excerpt
def fallback results locale product slugs dcsp products dcnl dcsp for slug in product slugs dcnl dcsp dcsp try dcnl dcsp dcsp dcsp p product objects get slug slug dcnl dcsp dcsp dcsp products append p dcnl dcsp dcsp except product doesnotexist dcnl dcsp dcsp dcsp pass dcnl dcsp docs fallback documents for locale products products dcnl dcsp docs docs + fallback or dcnl dcsp return docs 20
task dcnl timeit dcnl def maybe award badge badge template year user dcsp badge get or create badge badge template year dcnl dcsp if badge is awarded to user dcnl dcsp dcsp return dcnl dcsp qs reply objects filter user user created gte date year 1 1 created lt date year + 1 1 1 dcnl dcsp if qs count 50 dcnl dcsp dcsp badge award to user dcnl dcsp dcsp return true
def get word blacklist regex dcsp return re compile b + | join map re escape settings cc word blacklist + b
cronjobs register dcnl def purge tweets dcsp pin this thread dcnl dcsp for locale in settings sumo languages dcnl dcsp dcsp locale settings localeslocale iso639 1 dcnl dcsp dcsp if not locale dcnl dcsp dcsp dcsp continue dcnl dcsp dcsp oldest get oldest tweet locale settings cc max tweets dcnl dcsp dcsp if oldest dcnl dcsp dcsp dcsp log debug truncating dcsp tweet dcsp list dcsp removing dcsp tweets dcsp older dcsp than dcsp s dcsp for dcsp s oldest created locale dcnl dcsp dcsp dcsp tweet objects filter locale locale created lte oldest created delete
def get oldest tweet locale n 0 dcsp try dcnl dcsp dcsp return tweet objects filter locale locale order by created n dcnl dcsp except indexerror dcnl dcsp dcsp return none
def filter tweet item allow links false dcsp text item text lower dcnl dcsp allowed user ids u id for u in allowed users dcnl dcsp to user id item get to user id dcnl dcsp if to user id and to user id not in allowed user ids dcnl dcsp dcsp statsd incr customercare tweet rejected reply or mention dcnl dcsp dcsp return none dcnl dcsp for user in item entities user mentions dcnl dcsp dcsp if user id not in allowed user ids dcnl dcsp dcsp dcsp statsd incr customercare tweet rejected reply or mention dcnl dcsp dcsp dcsp return none dcnl dcsp if rt regex search text or text find via dcsp 1 dcnl dcsp dcsp statsd incr customercare tweet rejected retweet dcnl dcsp dcsp return none dcnl dcsp if not allow links and link regex search text dcnl dcsp dcsp statsd incr customercare tweet rejected link dcnl dcsp dcsp return none dcnl dcsp screen name item user screen name dcnl dcsp ignored users set twitteraccount objects filter ignored true values list username flat true dcnl dcsp if screen name in ignored users dcnl dcsp dcsp statsd incr customercare tweet rejected user dcnl dcsp dcsp return none dcnl dcsp if firefox in screen name lower dcnl dcsp dcsp statsd incr customercare tweet rejected firefox in handle dcnl dcsp dcsp return none dcnl dcsp match get word blacklist regex search text dcnl dcsp if match dcnl dcsp dcsp bad word match group 1 dcnl dcsp dcsp statsd incr customercare tweet rejected blacklist word + bad word dcnl dcsp dcsp return none dcnl dcsp return item
cronjobs register dcnl def get customercare stats dcsp if settings stage dcnl dcsp dcsp return dcnl dcsp contributor stats dcnl dcsp now datetime now dcnl dcsp one month ago now timedelta days 30 dcnl dcsp one week ago now timedelta days 7 dcnl dcsp yesterday now timedelta days 1 dcnl dcsp for chunk in chunked reply objects all 2500 reply objects count dcnl dcsp dcsp for reply in chunk dcnl dcsp dcsp dcsp user reply twitter username dcnl dcsp dcsp dcsp if user not in contributor stats dcnl dcsp dcsp dcsp dcsp raw json loads reply raw json dcnl dcsp dcsp dcsp dcsp if from user in raw dcnl dcsp dcsp dcsp dcsp dcsp user data raw dcnl dcsp dcsp dcsp dcsp else dcnl dcsp dcsp dcsp dcsp dcsp user data raw user dcnl dcsp dcsp dcsp dcsp contributor statsuser twitter username user avatar user data profile image url avatar https user data profile image url https all 0 1m 0 1w 0 1d 0 dcnl dcsp dcsp dcsp contributor contributor statsreply twitter username dcnl dcsp dcsp dcsp contributor all + 1 dcnl dcsp dcsp dcsp if reply created one month ago dcnl dcsp dcsp dcsp dcsp contributor 1m + 1 dcnl dcsp dcsp dcsp dcsp if reply created one week ago dcnl dcsp dcsp dcsp dcsp dcsp contributor 1w + 1 dcnl dcsp dcsp dcsp dcsp dcsp if reply created yesterday dcnl dcsp dcsp dcsp dcsp dcsp dcsp contributor 1d + 1 dcnl dcsp sort key settings cc top contrib sort dcnl dcsp limit settings cc top contrib limit dcnl dcsp contributor stats sorted contributor stats values key lambda c csort key c all reverse true limit dcnl dcsp try dcnl dcsp dcsp redis redis client name default dcnl dcsp dcsp key settings cc top contrib cache key dcnl dcsp dcsp redis set key json dumps contributor stats dcnl dcsp except rediserror as e dcnl dcsp dcsp statsd incr redis error dcnl dcsp dcsp log error redis dcsp error dcsp s e dcnl dcsp return contributor stats
library filter dcnl def isotime t dcsp if not hasattr t tzinfo dcnl dcsp dcsp return dcnl dcsp return append tz t astimezone pytz utc strftime y m dt h m sz
library filter dcnl def round percent num dcsp return round num 1 if num < 10 else int round num 0
def test isotime dcsp time datetime 2009 12 25 10 11 12 dcnl dcsp eq isotime time 20091225t18 11 12z dcnl dcsp assert isotime none is none
def get common replies locale settings wiki default language dcsp replies dcnl dcsp try dcnl dcsp dcsp default doc document objects get slug replies document slug locale settings wiki default language dcnl dcsp except document doesnotexist dcnl dcsp dcsp return replies dcnl dcsp if locale default doc locale dcnl dcsp dcsp translated doc default doc translated to locale dcnl dcsp dcsp if translated doc and translated doc current revision dcnl dcsp dcsp dcsp doc translated doc dcnl dcsp dcsp else dcnl dcsp dcsp dcsp doc default doc dcnl dcsp else dcnl dcsp dcsp doc default doc dcnl dcsp pq pyquery doc html dcnl dcsp try dcnl dcsp dcsp current node pq h1 0 dcnl dcsp except indexerror dcnl dcsp dcsp return replies dcnl dcsp current category none dcnl dcsp current response none dcnl dcsp while current node is not none dcnl dcsp dcsp if current node tag h1 dcnl dcsp dcsp dcsp current category title current node text responses dcnl dcsp dcsp dcsp replies append current category dcnl dcsp dcsp elif current node tag h2 dcnl dcsp dcsp dcsp current response title current node text response dcnl dcsp dcsp dcsp current category responses append current response dcnl dcsp dcsp elif current node tag p dcnl dcsp dcsp dcsp text current node text content strip dcnl dcsp dcsp dcsp if text and current response dcnl dcsp dcsp dcsp dcsp current response response text dcnl dcsp dcsp current node current node getnext dcnl dcsp return replies
decorators api view post dcnl decorators permission classes twitteraccountbanpermission dcnl def ban request dcsp username json loads request body get username dcnl dcsp if not username dcnl dcsp dcsp raise genericapiexception status http 400 bad request username dcsp not dcsp provided dcnl dcsp username username1 if username startswith else username dcnl dcsp account created twitteraccount objects get or create username username defaults banned true dcnl dcsp if not created and account banned dcnl dcsp dcsp raise genericapiexception status http 409 conflict this dcsp account dcsp is dcsp already dcsp banned dcnl dcsp else dcnl dcsp dcsp account banned true dcnl dcsp dcsp account save dcnl dcsp return response success account dcsp banned dcsp successfully
decorators api view post dcnl decorators permission classes twitteraccountbanpermission dcnl def unban request dcsp usernames json loads request body get usernames dcnl dcsp if not usernames dcnl dcsp dcsp raise genericapiexception status http 400 bad request usernames dcsp not dcsp provided dcnl dcsp accounts twitteraccount objects filter username in usernames dcnl dcsp for account in accounts dcnl dcsp dcsp if account and account banned dcnl dcsp dcsp dcsp account banned false dcnl dcsp dcsp dcsp account save dcnl dcsp message success 0 dcsp users dcsp unbanned dcsp successfully format len accounts dcnl dcsp return response message
